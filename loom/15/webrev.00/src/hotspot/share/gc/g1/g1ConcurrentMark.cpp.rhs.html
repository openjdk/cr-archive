<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/g1/g1ConcurrentMark.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;code/codeCache.hpp&quot;
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  30 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  31 #include &quot;gc/g1/g1ConcurrentMark.inline.hpp&quot;
  32 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  33 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  34 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  35 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  36 #include &quot;gc/g1/g1Policy.hpp&quot;
  37 #include &quot;gc/g1/g1RegionMarkStatsCache.inline.hpp&quot;
  38 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  39 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  40 #include &quot;gc/g1/g1Trace.hpp&quot;
  41 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  42 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  43 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  44 #include &quot;gc/shared/gcId.hpp&quot;
  45 #include &quot;gc/shared/gcTimer.hpp&quot;
  46 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  47 #include &quot;gc/shared/gcVMOperations.hpp&quot;
  48 #include &quot;gc/shared/genOopClosures.inline.hpp&quot;
  49 #include &quot;gc/shared/referencePolicy.hpp&quot;
  50 #include &quot;gc/shared/strongRootsScope.hpp&quot;
  51 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  52 #include &quot;gc/shared/taskTerminator.hpp&quot;
  53 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  54 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  55 #include &quot;gc/shared/workerPolicy.hpp&quot;
  56 #include &quot;include/jvm.h&quot;
  57 #include &quot;logging/log.hpp&quot;
  58 #include &quot;memory/allocation.hpp&quot;
  59 #include &quot;memory/iterator.hpp&quot;
  60 #include &quot;memory/resourceArea.hpp&quot;
  61 #include &quot;memory/universe.hpp&quot;
  62 #include &quot;oops/access.inline.hpp&quot;
  63 #include &quot;oops/oop.inline.hpp&quot;
  64 #include &quot;runtime/atomic.hpp&quot;
  65 #include &quot;runtime/handles.inline.hpp&quot;
  66 #include &quot;runtime/java.hpp&quot;
  67 #include &quot;runtime/orderAccess.hpp&quot;
  68 #include &quot;runtime/prefetch.inline.hpp&quot;
  69 #include &quot;services/memTracker.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/growableArray.hpp&quot;
  72 
  73 bool G1CMBitMapClosure::do_addr(HeapWord* const addr) {
  74   assert(addr &lt; _cm-&gt;finger(), &quot;invariant&quot;);
  75   assert(addr &gt;= _task-&gt;finger(), &quot;invariant&quot;);
  76 
  77   // We move that task&#39;s local finger along.
  78   _task-&gt;move_finger_to(addr);
  79 
  80   _task-&gt;scan_task_entry(G1TaskQueueEntry::from_oop(oop(addr)));
  81   // we only partially drain the local queue and global stack
  82   _task-&gt;drain_local_queue(true);
  83   _task-&gt;drain_global_stack(true);
  84 
  85   // if the has_aborted flag has been raised, we need to bail out of
  86   // the iteration
  87   return !_task-&gt;has_aborted();
  88 }
  89 
  90 G1CMMarkStack::G1CMMarkStack() :
  91   _max_chunk_capacity(0),
  92   _base(NULL),
  93   _chunk_capacity(0) {
  94   set_empty();
  95 }
  96 
  97 bool G1CMMarkStack::resize(size_t new_capacity) {
  98   assert(is_empty(), &quot;Only resize when stack is empty.&quot;);
  99   assert(new_capacity &lt;= _max_chunk_capacity,
 100          &quot;Trying to resize stack to &quot; SIZE_FORMAT &quot; chunks when the maximum is &quot; SIZE_FORMAT, new_capacity, _max_chunk_capacity);
 101 
 102   TaskQueueEntryChunk* new_base = MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::allocate_or_null(new_capacity, mtGC);
 103 
 104   if (new_base == NULL) {
 105     log_warning(gc)(&quot;Failed to reserve memory for new overflow mark stack with &quot; SIZE_FORMAT &quot; chunks and size &quot; SIZE_FORMAT &quot;B.&quot;, new_capacity, new_capacity * sizeof(TaskQueueEntryChunk));
 106     return false;
 107   }
 108   // Release old mapping.
 109   if (_base != NULL) {
 110     MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::free(_base, _chunk_capacity);
 111   }
 112 
 113   _base = new_base;
 114   _chunk_capacity = new_capacity;
 115   set_empty();
 116 
 117   return true;
 118 }
 119 
 120 size_t G1CMMarkStack::capacity_alignment() {
 121   return (size_t)lcm(os::vm_allocation_granularity(), sizeof(TaskQueueEntryChunk)) / sizeof(G1TaskQueueEntry);
 122 }
 123 
 124 bool G1CMMarkStack::initialize(size_t initial_capacity, size_t max_capacity) {
 125   guarantee(_max_chunk_capacity == 0, &quot;G1CMMarkStack already initialized.&quot;);
 126 
 127   size_t const TaskEntryChunkSizeInVoidStar = sizeof(TaskQueueEntryChunk) / sizeof(G1TaskQueueEntry);
 128 
 129   _max_chunk_capacity = align_up(max_capacity, capacity_alignment()) / TaskEntryChunkSizeInVoidStar;
 130   size_t initial_chunk_capacity = align_up(initial_capacity, capacity_alignment()) / TaskEntryChunkSizeInVoidStar;
 131 
 132   guarantee(initial_chunk_capacity &lt;= _max_chunk_capacity,
 133             &quot;Maximum chunk capacity &quot; SIZE_FORMAT &quot; smaller than initial capacity &quot; SIZE_FORMAT,
 134             _max_chunk_capacity,
 135             initial_chunk_capacity);
 136 
 137   log_debug(gc)(&quot;Initialize mark stack with &quot; SIZE_FORMAT &quot; chunks, maximum &quot; SIZE_FORMAT,
 138                 initial_chunk_capacity, _max_chunk_capacity);
 139 
 140   return resize(initial_chunk_capacity);
 141 }
 142 
 143 void G1CMMarkStack::expand() {
 144   if (_chunk_capacity == _max_chunk_capacity) {
 145     log_debug(gc)(&quot;Can not expand overflow mark stack further, already at maximum capacity of &quot; SIZE_FORMAT &quot; chunks.&quot;, _chunk_capacity);
 146     return;
 147   }
 148   size_t old_capacity = _chunk_capacity;
 149   // Double capacity if possible
 150   size_t new_capacity = MIN2(old_capacity * 2, _max_chunk_capacity);
 151 
 152   if (resize(new_capacity)) {
 153     log_debug(gc)(&quot;Expanded mark stack capacity from &quot; SIZE_FORMAT &quot; to &quot; SIZE_FORMAT &quot; chunks&quot;,
 154                   old_capacity, new_capacity);
 155   } else {
 156     log_warning(gc)(&quot;Failed to expand mark stack capacity from &quot; SIZE_FORMAT &quot; to &quot; SIZE_FORMAT &quot; chunks&quot;,
 157                     old_capacity, new_capacity);
 158   }
 159 }
 160 
 161 G1CMMarkStack::~G1CMMarkStack() {
 162   if (_base != NULL) {
 163     MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::free(_base, _chunk_capacity);
 164   }
 165 }
 166 
 167 void G1CMMarkStack::add_chunk_to_list(TaskQueueEntryChunk* volatile* list, TaskQueueEntryChunk* elem) {
 168   elem-&gt;next = *list;
 169   *list = elem;
 170 }
 171 
 172 void G1CMMarkStack::add_chunk_to_chunk_list(TaskQueueEntryChunk* elem) {
 173   MutexLocker x(MarkStackChunkList_lock, Mutex::_no_safepoint_check_flag);
 174   add_chunk_to_list(&amp;_chunk_list, elem);
 175   _chunks_in_chunk_list++;
 176 }
 177 
 178 void G1CMMarkStack::add_chunk_to_free_list(TaskQueueEntryChunk* elem) {
 179   MutexLocker x(MarkStackFreeList_lock, Mutex::_no_safepoint_check_flag);
 180   add_chunk_to_list(&amp;_free_list, elem);
 181 }
 182 
 183 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_list(TaskQueueEntryChunk* volatile* list) {
 184   TaskQueueEntryChunk* result = *list;
 185   if (result != NULL) {
 186     *list = (*list)-&gt;next;
 187   }
 188   return result;
 189 }
 190 
 191 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_chunk_list() {
 192   MutexLocker x(MarkStackChunkList_lock, Mutex::_no_safepoint_check_flag);
 193   TaskQueueEntryChunk* result = remove_chunk_from_list(&amp;_chunk_list);
 194   if (result != NULL) {
 195     _chunks_in_chunk_list--;
 196   }
 197   return result;
 198 }
 199 
 200 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_free_list() {
 201   MutexLocker x(MarkStackFreeList_lock, Mutex::_no_safepoint_check_flag);
 202   return remove_chunk_from_list(&amp;_free_list);
 203 }
 204 
 205 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::allocate_new_chunk() {
 206   // This dirty read of _hwm is okay because we only ever increase the _hwm in parallel code.
 207   // Further this limits _hwm to a value of _chunk_capacity + #threads, avoiding
 208   // wraparound of _hwm.
 209   if (_hwm &gt;= _chunk_capacity) {
 210     return NULL;
 211   }
 212 
 213   size_t cur_idx = Atomic::fetch_and_add(&amp;_hwm, 1u);
 214   if (cur_idx &gt;= _chunk_capacity) {
 215     return NULL;
 216   }
 217 
 218   TaskQueueEntryChunk* result = ::new (&amp;_base[cur_idx]) TaskQueueEntryChunk;
 219   result-&gt;next = NULL;
 220   return result;
 221 }
 222 
 223 bool G1CMMarkStack::par_push_chunk(G1TaskQueueEntry* ptr_arr) {
 224   // Get a new chunk.
 225   TaskQueueEntryChunk* new_chunk = remove_chunk_from_free_list();
 226 
 227   if (new_chunk == NULL) {
 228     // Did not get a chunk from the free list. Allocate from backing memory.
 229     new_chunk = allocate_new_chunk();
 230 
 231     if (new_chunk == NULL) {
 232       return false;
 233     }
 234   }
 235 
 236   Copy::conjoint_memory_atomic(ptr_arr, new_chunk-&gt;data, EntriesPerChunk * sizeof(G1TaskQueueEntry));
 237 
 238   add_chunk_to_chunk_list(new_chunk);
 239 
 240   return true;
 241 }
 242 
 243 bool G1CMMarkStack::par_pop_chunk(G1TaskQueueEntry* ptr_arr) {
 244   TaskQueueEntryChunk* cur = remove_chunk_from_chunk_list();
 245 
 246   if (cur == NULL) {
 247     return false;
 248   }
 249 
 250   Copy::conjoint_memory_atomic(cur-&gt;data, ptr_arr, EntriesPerChunk * sizeof(G1TaskQueueEntry));
 251 
 252   add_chunk_to_free_list(cur);
 253   return true;
 254 }
 255 
 256 void G1CMMarkStack::set_empty() {
 257   _chunks_in_chunk_list = 0;
 258   _hwm = 0;
 259   _chunk_list = NULL;
 260   _free_list = NULL;
 261 }
 262 
 263 G1CMRootMemRegions::G1CMRootMemRegions(uint const max_regions) :
 264     _root_regions(MemRegion::create_array(max_regions, mtGC)),
 265     _max_regions(max_regions),
 266     _num_root_regions(0),
 267     _claimed_root_regions(0),
 268     _scan_in_progress(false),
 269     _should_abort(false) { }
 270 
 271 G1CMRootMemRegions::~G1CMRootMemRegions() {
 272   MemRegion::destroy_array(_root_regions, _max_regions);
 273 }
 274 
 275 void G1CMRootMemRegions::reset() {
 276   _num_root_regions = 0;
 277 }
 278 
 279 void G1CMRootMemRegions::add(HeapWord* start, HeapWord* end) {
 280   assert_at_safepoint();
 281   size_t idx = Atomic::fetch_and_add(&amp;_num_root_regions, 1u);
 282   assert(idx &lt; _max_regions, &quot;Trying to add more root MemRegions than there is space &quot; SIZE_FORMAT, _max_regions);
 283   assert(start != NULL &amp;&amp; end != NULL &amp;&amp; start &lt;= end, &quot;Start (&quot; PTR_FORMAT &quot;) should be less or equal to &quot;
 284          &quot;end (&quot; PTR_FORMAT &quot;)&quot;, p2i(start), p2i(end));
 285   _root_regions[idx].set_start(start);
 286   _root_regions[idx].set_end(end);
 287 }
 288 
 289 void G1CMRootMemRegions::prepare_for_scan() {
 290   assert(!scan_in_progress(), &quot;pre-condition&quot;);
 291 
 292   _scan_in_progress = _num_root_regions &gt; 0;
 293 
 294   _claimed_root_regions = 0;
 295   _should_abort = false;
 296 }
 297 
 298 const MemRegion* G1CMRootMemRegions::claim_next() {
 299   if (_should_abort) {
 300     // If someone has set the should_abort flag, we return NULL to
 301     // force the caller to bail out of their loop.
 302     return NULL;
 303   }
 304 
 305   if (_claimed_root_regions &gt;= _num_root_regions) {
 306     return NULL;
 307   }
 308 
 309   size_t claimed_index = Atomic::fetch_and_add(&amp;_claimed_root_regions, 1u);
 310   if (claimed_index &lt; _num_root_regions) {
 311     return &amp;_root_regions[claimed_index];
 312   }
 313   return NULL;
 314 }
 315 
 316 uint G1CMRootMemRegions::num_root_regions() const {
 317   return (uint)_num_root_regions;
 318 }
 319 
 320 void G1CMRootMemRegions::notify_scan_done() {
 321   MutexLocker x(RootRegionScan_lock, Mutex::_no_safepoint_check_flag);
 322   _scan_in_progress = false;
 323   RootRegionScan_lock-&gt;notify_all();
 324 }
 325 
 326 void G1CMRootMemRegions::cancel_scan() {
 327   notify_scan_done();
 328 }
 329 
 330 void G1CMRootMemRegions::scan_finished() {
 331   assert(scan_in_progress(), &quot;pre-condition&quot;);
 332 
 333   if (!_should_abort) {
 334     assert(_claimed_root_regions &gt;= num_root_regions(),
 335            &quot;we should have claimed all root regions, claimed &quot; SIZE_FORMAT &quot;, length = %u&quot;,
 336            _claimed_root_regions, num_root_regions());
 337   }
 338 
 339   notify_scan_done();
 340 }
 341 
 342 bool G1CMRootMemRegions::wait_until_scan_finished() {
 343   if (!scan_in_progress()) {
 344     return false;
 345   }
 346 
 347   {
 348     MonitorLocker ml(RootRegionScan_lock, Mutex::_no_safepoint_check_flag);
 349     while (scan_in_progress()) {
 350       ml.wait();
 351     }
 352   }
 353   return true;
 354 }
 355 
 356 G1ConcurrentMark::G1ConcurrentMark(G1CollectedHeap* g1h,
 357                                    G1RegionToSpaceMapper* prev_bitmap_storage,
 358                                    G1RegionToSpaceMapper* next_bitmap_storage) :
 359   // _cm_thread set inside the constructor
 360   _g1h(g1h),
 361 
 362   _mark_bitmap_1(),
 363   _mark_bitmap_2(),
 364   _prev_mark_bitmap(&amp;_mark_bitmap_1),
 365   _next_mark_bitmap(&amp;_mark_bitmap_2),
 366 
 367   _heap(_g1h-&gt;reserved_region()),
 368 
 369   _root_regions(_g1h-&gt;max_regions()),
 370 
 371   _global_mark_stack(),
 372 
 373   // _finger set in set_non_marking_state
 374 
 375   _worker_id_offset(G1DirtyCardQueueSet::num_par_ids() + G1ConcRefinementThreads),
 376   _max_num_tasks(ParallelGCThreads),
 377   // _num_active_tasks set in set_non_marking_state()
 378   // _tasks set inside the constructor
 379 
 380   _task_queues(new G1CMTaskQueueSet((int) _max_num_tasks)),
 381   _terminator((int) _max_num_tasks, _task_queues),
 382 
 383   _first_overflow_barrier_sync(),
 384   _second_overflow_barrier_sync(),
 385 
 386   _has_overflown(false),
 387   _concurrent(false),
 388   _has_aborted(false),
 389   _restart_for_overflow(false),
 390   _gc_timer_cm(new (ResourceObj::C_HEAP, mtGC) ConcurrentGCTimer()),
 391   _gc_tracer_cm(new (ResourceObj::C_HEAP, mtGC) G1OldTracer()),
 392 
 393   // _verbose_level set below
 394 
 395   _init_times(),
 396   _remark_times(),
 397   _remark_mark_times(),
 398   _remark_weak_ref_times(),
 399   _cleanup_times(),
 400   _total_cleanup_time(0.0),
 401 
 402   _accum_task_vtime(NULL),
 403 
 404   _concurrent_workers(NULL),
 405   _num_concurrent_workers(0),
 406   _max_concurrent_workers(0),
 407 
 408   _region_mark_stats(NEW_C_HEAP_ARRAY(G1RegionMarkStats, _g1h-&gt;max_regions(), mtGC)),
 409   _top_at_rebuild_starts(NEW_C_HEAP_ARRAY(HeapWord*, _g1h-&gt;max_regions(), mtGC))
 410 {
 411   assert(CGC_lock != NULL, &quot;CGC_lock must be initialized&quot;);
 412 
 413   _mark_bitmap_1.initialize(g1h-&gt;reserved_region(), prev_bitmap_storage);
 414   _mark_bitmap_2.initialize(g1h-&gt;reserved_region(), next_bitmap_storage);
 415 
 416   // Create &amp; start ConcurrentMark thread.
 417   _cm_thread = new G1ConcurrentMarkThread(this);
 418   if (_cm_thread-&gt;osthread() == NULL) {
 419     vm_shutdown_during_initialization(&quot;Could not create ConcurrentMarkThread&quot;);
 420   }
 421 
 422   log_debug(gc)(&quot;ConcGCThreads: %u offset %u&quot;, ConcGCThreads, _worker_id_offset);
 423   log_debug(gc)(&quot;ParallelGCThreads: %u&quot;, ParallelGCThreads);
 424 
 425   _num_concurrent_workers = ConcGCThreads;
 426   _max_concurrent_workers = _num_concurrent_workers;
 427 
 428   _concurrent_workers = new WorkGang(&quot;G1 Conc&quot;, _max_concurrent_workers, false, true);
 429   _concurrent_workers-&gt;initialize_workers();
 430 
 431   if (!_global_mark_stack.initialize(MarkStackSize, MarkStackSizeMax)) {
 432     vm_exit_during_initialization(&quot;Failed to allocate initial concurrent mark overflow mark stack.&quot;);
 433   }
 434 
 435   _tasks = NEW_C_HEAP_ARRAY(G1CMTask*, _max_num_tasks, mtGC);
 436   _accum_task_vtime = NEW_C_HEAP_ARRAY(double, _max_num_tasks, mtGC);
 437 
 438   // so that the assertion in MarkingTaskQueue::task_queue doesn&#39;t fail
 439   _num_active_tasks = _max_num_tasks;
 440 
 441   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 442     G1CMTaskQueue* task_queue = new G1CMTaskQueue();
 443     task_queue-&gt;initialize();
 444     _task_queues-&gt;register_queue(i, task_queue);
 445 
 446     _tasks[i] = new G1CMTask(i, this, task_queue, _region_mark_stats, _g1h-&gt;max_regions());
 447 
 448     _accum_task_vtime[i] = 0.0;
 449   }
 450 
 451   reset_at_marking_complete();
 452 }
 453 
 454 void G1ConcurrentMark::reset() {
 455   _has_aborted = false;
 456 
 457   reset_marking_for_restart();
 458 
 459   // Reset all tasks, since different phases will use different number of active
 460   // threads. So, it&#39;s easiest to have all of them ready.
 461   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 462     _tasks[i]-&gt;reset(_next_mark_bitmap);
 463   }
 464 
 465   uint max_regions = _g1h-&gt;max_regions();
 466   for (uint i = 0; i &lt; max_regions; i++) {
 467     _top_at_rebuild_starts[i] = NULL;
 468     _region_mark_stats[i].clear();
 469   }
 470 }
 471 
 472 void G1ConcurrentMark::clear_statistics_in_region(uint region_idx) {
 473   for (uint j = 0; j &lt; _max_num_tasks; ++j) {
 474     _tasks[j]-&gt;clear_mark_stats_cache(region_idx);
 475   }
 476   _top_at_rebuild_starts[region_idx] = NULL;
 477   _region_mark_stats[region_idx].clear();
 478 }
 479 
 480 void G1ConcurrentMark::clear_statistics(HeapRegion* r) {
 481   uint const region_idx = r-&gt;hrm_index();
 482   if (r-&gt;is_humongous()) {
 483     assert(r-&gt;is_starts_humongous(), &quot;Got humongous continues region here&quot;);
 484     uint const size_in_regions = (uint)_g1h-&gt;humongous_obj_size_in_regions(oop(r-&gt;humongous_start_region()-&gt;bottom())-&gt;size());
 485     for (uint j = region_idx; j &lt; (region_idx + size_in_regions); j++) {
 486       clear_statistics_in_region(j);
 487     }
 488   } else {
 489     clear_statistics_in_region(region_idx);
 490   }
 491 }
 492 
 493 static void clear_mark_if_set(G1CMBitMap* bitmap, HeapWord* addr) {
 494   if (bitmap-&gt;is_marked(addr)) {
 495     bitmap-&gt;clear(addr);
 496   }
 497 }
 498 
 499 void G1ConcurrentMark::humongous_object_eagerly_reclaimed(HeapRegion* r) {
 500   assert_at_safepoint_on_vm_thread();
 501 
 502   // Need to clear all mark bits of the humongous object.
 503   clear_mark_if_set(_prev_mark_bitmap, r-&gt;bottom());
 504   clear_mark_if_set(_next_mark_bitmap, r-&gt;bottom());
 505 
 506   if (!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress()) {
 507     return;
 508   }
 509 
 510   // Clear any statistics about the region gathered so far.
 511   clear_statistics(r);
 512 }
 513 
 514 void G1ConcurrentMark::reset_marking_for_restart() {
 515   _global_mark_stack.set_empty();
 516 
 517   // Expand the marking stack, if we have to and if we can.
 518   if (has_overflown()) {
 519     _global_mark_stack.expand();
 520 
 521     uint max_regions = _g1h-&gt;max_regions();
 522     for (uint i = 0; i &lt; max_regions; i++) {
 523       _region_mark_stats[i].clear_during_overflow();
 524     }
 525   }
 526 
 527   clear_has_overflown();
 528   _finger = _heap.start();
 529 
 530   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 531     G1CMTaskQueue* queue = _task_queues-&gt;queue(i);
 532     queue-&gt;set_empty();
 533   }
 534 }
 535 
 536 void G1ConcurrentMark::set_concurrency(uint active_tasks) {
 537   assert(active_tasks &lt;= _max_num_tasks, &quot;we should not have more&quot;);
 538 
 539   _num_active_tasks = active_tasks;
 540   // Need to update the three data structures below according to the
 541   // number of active threads for this phase.
 542   _terminator.reset_for_reuse(active_tasks);
 543   _first_overflow_barrier_sync.set_n_workers((int) active_tasks);
 544   _second_overflow_barrier_sync.set_n_workers((int) active_tasks);
 545 }
 546 
 547 void G1ConcurrentMark::set_concurrency_and_phase(uint active_tasks, bool concurrent) {
 548   set_concurrency(active_tasks);
 549 
 550   _concurrent = concurrent;
 551 
 552   if (!concurrent) {
 553     // At this point we should be in a STW phase, and completed marking.
 554     assert_at_safepoint_on_vm_thread();
 555     assert(out_of_regions(),
 556            &quot;only way to get here: _finger: &quot; PTR_FORMAT &quot;, _heap_end: &quot; PTR_FORMAT,
 557            p2i(_finger), p2i(_heap.end()));
 558   }
 559 }
 560 
 561 void G1ConcurrentMark::reset_at_marking_complete() {
 562   // We set the global marking state to some default values when we&#39;re
 563   // not doing marking.
 564   reset_marking_for_restart();
 565   _num_active_tasks = 0;
 566 }
 567 
 568 G1ConcurrentMark::~G1ConcurrentMark() {
 569   FREE_C_HEAP_ARRAY(HeapWord*, _top_at_rebuild_starts);
 570   FREE_C_HEAP_ARRAY(G1RegionMarkStats, _region_mark_stats);
 571   // The G1ConcurrentMark instance is never freed.
 572   ShouldNotReachHere();
 573 }
 574 
 575 class G1ClearBitMapTask : public AbstractGangTask {
 576 public:
 577   static size_t chunk_size() { return M; }
 578 
 579 private:
 580   // Heap region closure used for clearing the given mark bitmap.
 581   class G1ClearBitmapHRClosure : public HeapRegionClosure {
 582   private:
 583     G1CMBitMap* _bitmap;
 584     G1ConcurrentMark* _cm;
 585   public:
 586     G1ClearBitmapHRClosure(G1CMBitMap* bitmap, G1ConcurrentMark* cm) : HeapRegionClosure(), _bitmap(bitmap), _cm(cm) {
 587     }
 588 
 589     virtual bool do_heap_region(HeapRegion* r) {
 590       size_t const chunk_size_in_words = G1ClearBitMapTask::chunk_size() / HeapWordSize;
 591 
 592       HeapWord* cur = r-&gt;bottom();
 593       HeapWord* const end = r-&gt;end();
 594 
 595       while (cur &lt; end) {
 596         MemRegion mr(cur, MIN2(cur + chunk_size_in_words, end));
 597         _bitmap-&gt;clear_range(mr);
 598 
 599         cur += chunk_size_in_words;
 600 
 601         // Abort iteration if after yielding the marking has been aborted.
 602         if (_cm != NULL &amp;&amp; _cm-&gt;do_yield_check() &amp;&amp; _cm-&gt;has_aborted()) {
 603           return true;
 604         }
 605         // Repeat the asserts from before the start of the closure. We will do them
 606         // as asserts here to minimize their overhead on the product. However, we
 607         // will have them as guarantees at the beginning / end of the bitmap
 608         // clearing to get some checking in the product.
 609         assert(_cm == NULL || _cm-&gt;cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 610         assert(_cm == NULL || !G1CollectedHeap::heap()-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 611       }
 612       assert(cur == end, &quot;Must have completed iteration over the bitmap for region %u.&quot;, r-&gt;hrm_index());
 613 
 614       return false;
 615     }
 616   };
 617 
 618   G1ClearBitmapHRClosure _cl;
 619   HeapRegionClaimer _hr_claimer;
 620   bool _suspendible; // If the task is suspendible, workers must join the STS.
 621 
 622 public:
 623   G1ClearBitMapTask(G1CMBitMap* bitmap, G1ConcurrentMark* cm, uint n_workers, bool suspendible) :
 624     AbstractGangTask(&quot;G1 Clear Bitmap&quot;),
 625     _cl(bitmap, suspendible ? cm : NULL),
 626     _hr_claimer(n_workers),
 627     _suspendible(suspendible)
 628   { }
 629 
 630   void work(uint worker_id) {
 631     SuspendibleThreadSetJoiner sts_join(_suspendible);
 632     G1CollectedHeap::heap()-&gt;heap_region_par_iterate_from_worker_offset(&amp;_cl, &amp;_hr_claimer, worker_id);
 633   }
 634 
 635   bool is_complete() {
 636     return _cl.is_complete();
 637   }
 638 };
 639 
 640 void G1ConcurrentMark::clear_bitmap(G1CMBitMap* bitmap, WorkGang* workers, bool may_yield) {
 641   assert(may_yield || SafepointSynchronize::is_at_safepoint(), &quot;Non-yielding bitmap clear only allowed at safepoint.&quot;);
 642 
 643   size_t const num_bytes_to_clear = (HeapRegion::GrainBytes * _g1h-&gt;num_regions()) / G1CMBitMap::heap_map_factor();
 644   size_t const num_chunks = align_up(num_bytes_to_clear, G1ClearBitMapTask::chunk_size()) / G1ClearBitMapTask::chunk_size();
 645 
 646   uint const num_workers = (uint)MIN2(num_chunks, (size_t)workers-&gt;active_workers());
 647 
 648   G1ClearBitMapTask cl(bitmap, this, num_workers, may_yield);
 649 
 650   log_debug(gc, ergo)(&quot;Running %s with %u workers for &quot; SIZE_FORMAT &quot; work units.&quot;, cl.name(), num_workers, num_chunks);
 651   workers-&gt;run_task(&amp;cl, num_workers);
 652   guarantee(!may_yield || cl.is_complete(), &quot;Must have completed iteration when not yielding.&quot;);
 653 }
 654 
 655 void G1ConcurrentMark::cleanup_for_next_mark() {
 656   // Make sure that the concurrent mark thread looks to still be in
 657   // the current cycle.
 658   guarantee(cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 659 
 660   // We are finishing up the current cycle by clearing the next
 661   // marking bitmap and getting it ready for the next cycle. During
 662   // this time no other cycle can start. So, let&#39;s make sure that this
 663   // is the case.
 664   guarantee(!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 665 
 666   clear_bitmap(_next_mark_bitmap, _concurrent_workers, true);
 667 
 668   // Repeat the asserts from above.
 669   guarantee(cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 670   guarantee(!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 671 }
 672 
 673 void G1ConcurrentMark::clear_prev_bitmap(WorkGang* workers) {
 674   assert_at_safepoint_on_vm_thread();
 675   clear_bitmap(_prev_mark_bitmap, workers, false);
 676 }
 677 
 678 class NoteStartOfMarkHRClosure : public HeapRegionClosure {
 679 public:
 680   bool do_heap_region(HeapRegion* r) {
 681     r-&gt;note_start_of_marking();
 682     return false;
 683   }
 684 };
 685 
 686 void G1ConcurrentMark::pre_concurrent_start() {
 687   assert_at_safepoint_on_vm_thread();
 688 
 689   CodeCache::increment_marking_cycle();
 690 
 691   // Reset marking state.
 692   reset();
 693 
 694   // For each region note start of marking.
 695   NoteStartOfMarkHRClosure startcl;
 696   _g1h-&gt;heap_region_iterate(&amp;startcl);
 697 
 698   _root_regions.reset();
 699 }
 700 
 701 
 702 void G1ConcurrentMark::post_concurrent_start() {
 703   // Start Concurrent Marking weak-reference discovery.
 704   ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
 705   // enable (&quot;weak&quot;) refs discovery
 706   rp-&gt;enable_discovery();
 707   rp-&gt;setup_policy(false); // snapshot the soft ref policy to be used in this cycle
 708 
 709   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
 710   // This is the start of  the marking cycle, we&#39;re expected all
 711   // threads to have SATB queues with active set to false.
 712   satb_mq_set.set_active_all_threads(true, /* new active value */
 713                                      false /* expected_active */);
 714 
 715   _root_regions.prepare_for_scan();
 716 
 717   // update_g1_committed() will be called at the end of an evac pause
 718   // when marking is on. So, it&#39;s also called at the end of the
 719   // concurrent start pause to update the heap end, if the heap expands
 720   // during it. No need to call it here.
 721 }
 722 
 723 /*
 724  * Notice that in the next two methods, we actually leave the STS
 725  * during the barrier sync and join it immediately afterwards. If we
 726  * do not do this, the following deadlock can occur: one thread could
 727  * be in the barrier sync code, waiting for the other thread to also
 728  * sync up, whereas another one could be trying to yield, while also
 729  * waiting for the other threads to sync up too.
 730  *
 731  * Note, however, that this code is also used during remark and in
 732  * this case we should not attempt to leave / enter the STS, otherwise
 733  * we&#39;ll either hit an assert (debug / fastdebug) or deadlock
 734  * (product). So we should only leave / enter the STS if we are
 735  * operating concurrently.
 736  *
 737  * Because the thread that does the sync barrier has left the STS, it
 738  * is possible to be suspended for a Full GC or an evacuation pause
 739  * could occur. This is actually safe, since the entering the sync
 740  * barrier is one of the last things do_marking_step() does, and it
 741  * doesn&#39;t manipulate any data structures afterwards.
 742  */
 743 
 744 void G1ConcurrentMark::enter_first_sync_barrier(uint worker_id) {
 745   bool barrier_aborted;
 746   {
 747     SuspendibleThreadSetLeaver sts_leave(concurrent());
 748     barrier_aborted = !_first_overflow_barrier_sync.enter();
 749   }
 750 
 751   // at this point everyone should have synced up and not be doing any
 752   // more work
 753 
 754   if (barrier_aborted) {
 755     // If the barrier aborted we ignore the overflow condition and
 756     // just abort the whole marking phase as quickly as possible.
 757     return;
 758   }
 759 }
 760 
 761 void G1ConcurrentMark::enter_second_sync_barrier(uint worker_id) {
 762   SuspendibleThreadSetLeaver sts_leave(concurrent());
 763   _second_overflow_barrier_sync.enter();
 764 
 765   // at this point everything should be re-initialized and ready to go
 766 }
 767 
 768 class G1CMConcurrentMarkingTask : public AbstractGangTask {
 769   G1ConcurrentMark*     _cm;
 770 
 771 public:
 772   void work(uint worker_id) {
 773     assert(Thread::current()-&gt;is_ConcurrentGC_thread(), &quot;Not a concurrent GC thread&quot;);
 774     ResourceMark rm;
 775 
 776     double start_vtime = os::elapsedVTime();
 777 
 778     {
 779       SuspendibleThreadSetJoiner sts_join;
 780 
 781       assert(worker_id &lt; _cm-&gt;active_tasks(), &quot;invariant&quot;);
 782 
 783       G1CMTask* task = _cm-&gt;task(worker_id);
 784       task-&gt;record_start_time();
 785       if (!_cm-&gt;has_aborted()) {
 786         do {
 787           task-&gt;do_marking_step(G1ConcMarkStepDurationMillis,
 788                                 true  /* do_termination */,
 789                                 false /* is_serial*/);
 790 
 791           _cm-&gt;do_yield_check();
 792         } while (!_cm-&gt;has_aborted() &amp;&amp; task-&gt;has_aborted());
 793       }
 794       task-&gt;record_end_time();
 795       guarantee(!task-&gt;has_aborted() || _cm-&gt;has_aborted(), &quot;invariant&quot;);
 796     }
 797 
 798     double end_vtime = os::elapsedVTime();
 799     _cm-&gt;update_accum_task_vtime(worker_id, end_vtime - start_vtime);
 800   }
 801 
 802   G1CMConcurrentMarkingTask(G1ConcurrentMark* cm) :
 803       AbstractGangTask(&quot;Concurrent Mark&quot;), _cm(cm) { }
 804 
 805   ~G1CMConcurrentMarkingTask() { }
 806 };
 807 
 808 uint G1ConcurrentMark::calc_active_marking_workers() {
 809   uint result = 0;
 810   if (!UseDynamicNumberOfGCThreads || !FLAG_IS_DEFAULT(ConcGCThreads)) {
 811     result = _max_concurrent_workers;
 812   } else {
 813     result =
 814       WorkerPolicy::calc_default_active_workers(_max_concurrent_workers,
 815                                                 1, /* Minimum workers */
 816                                                 _num_concurrent_workers,
 817                                                 Threads::number_of_non_daemon_threads());
 818     // Don&#39;t scale the result down by scale_concurrent_workers() because
 819     // that scaling has already gone into &quot;_max_concurrent_workers&quot;.
 820   }
 821   assert(result &gt; 0 &amp;&amp; result &lt;= _max_concurrent_workers,
 822          &quot;Calculated number of marking workers must be larger than zero and at most the maximum %u, but is %u&quot;,
 823          _max_concurrent_workers, result);
 824   return result;
 825 }
 826 
 827 void G1ConcurrentMark::scan_root_region(const MemRegion* region, uint worker_id) {
 828 #ifdef ASSERT
 829   HeapWord* last = region-&gt;last();
 830   HeapRegion* hr = _g1h-&gt;heap_region_containing(last);
 831   assert(hr-&gt;is_old() || hr-&gt;next_top_at_mark_start() == hr-&gt;bottom(),
 832          &quot;Root regions must be old or survivor/eden but region %u is %s&quot;, hr-&gt;hrm_index(), hr-&gt;get_type_str());
 833   assert(hr-&gt;next_top_at_mark_start() == region-&gt;start(),
 834          &quot;MemRegion start should be equal to nTAMS&quot;);
 835 #endif
 836 
 837   G1RootRegionScanClosure cl(_g1h, this, worker_id);
 838 
 839   const uintx interval = PrefetchScanIntervalInBytes;
 840   HeapWord* curr = region-&gt;start();
 841   const HeapWord* end = region-&gt;end();
 842   while (curr &lt; end) {
 843     Prefetch::read(curr, interval);
 844     oop obj = oop(curr);
 845     int size = obj-&gt;oop_iterate_size(&amp;cl);
 846     assert(size == obj-&gt;size(), &quot;sanity&quot;);
 847     curr += size;
 848   }
 849 }
 850 
 851 class G1CMRootRegionScanTask : public AbstractGangTask {
 852   G1ConcurrentMark* _cm;
 853 public:
 854   G1CMRootRegionScanTask(G1ConcurrentMark* cm) :
 855     AbstractGangTask(&quot;G1 Root Region Scan&quot;), _cm(cm) { }
 856 
 857   void work(uint worker_id) {
 858     assert(Thread::current()-&gt;is_ConcurrentGC_thread(),
 859            &quot;this should only be done by a conc GC thread&quot;);
 860 
 861     G1CMRootMemRegions* root_regions = _cm-&gt;root_regions();
 862     const MemRegion* region = root_regions-&gt;claim_next();
 863     while (region != NULL) {
 864       _cm-&gt;scan_root_region(region, worker_id);
 865       region = root_regions-&gt;claim_next();
 866     }
 867   }
 868 };
 869 
 870 void G1ConcurrentMark::scan_root_regions() {
 871   // scan_in_progress() will have been set to true only if there was
 872   // at least one root region to scan. So, if it&#39;s false, we
 873   // should not attempt to do any further work.
 874   if (root_regions()-&gt;scan_in_progress()) {
 875     assert(!has_aborted(), &quot;Aborting before root region scanning is finished not supported.&quot;);
 876 
 877     _num_concurrent_workers = MIN2(calc_active_marking_workers(),
 878                                    // We distribute work on a per-region basis, so starting
 879                                    // more threads than that is useless.
 880                                    root_regions()-&gt;num_root_regions());
 881     assert(_num_concurrent_workers &lt;= _max_concurrent_workers,
 882            &quot;Maximum number of marking threads exceeded&quot;);
 883 
 884     G1CMRootRegionScanTask task(this);
 885     log_debug(gc, ergo)(&quot;Running %s using %u workers for %u work units.&quot;,
 886                         task.name(), _num_concurrent_workers, root_regions()-&gt;num_root_regions());
 887     _concurrent_workers-&gt;run_task(&amp;task, _num_concurrent_workers);
 888 
 889     // It&#39;s possible that has_aborted() is true here without actually
 890     // aborting the survivor scan earlier. This is OK as it&#39;s
 891     // mainly used for sanity checking.
 892     root_regions()-&gt;scan_finished();
 893   }
 894 }
 895 
 896 void G1ConcurrentMark::concurrent_cycle_start() {
 897   _gc_timer_cm-&gt;register_gc_start();
 898 
 899   _gc_tracer_cm-&gt;report_gc_start(GCCause::_no_gc /* first parameter is not used */, _gc_timer_cm-&gt;gc_start());
 900 
 901   _g1h-&gt;trace_heap_before_gc(_gc_tracer_cm);
 902 }
 903 
 904 void G1ConcurrentMark::concurrent_cycle_end() {
 905   _g1h-&gt;collector_state()-&gt;set_clearing_next_bitmap(false);
 906 
 907   _g1h-&gt;trace_heap_after_gc(_gc_tracer_cm);
 908 
 909   if (has_aborted()) {
 910     log_info(gc, marking)(&quot;Concurrent Mark Abort&quot;);
 911     _gc_tracer_cm-&gt;report_concurrent_mode_failure();
 912   }
 913 
 914   _gc_timer_cm-&gt;register_gc_end();
 915 
 916   _gc_tracer_cm-&gt;report_gc_end(_gc_timer_cm-&gt;gc_end(), _gc_timer_cm-&gt;time_partitions());
 917 }
 918 
 919 void G1ConcurrentMark::mark_from_roots() {
 920   _restart_for_overflow = false;
 921 
 922   _num_concurrent_workers = calc_active_marking_workers();
 923 
 924   uint active_workers = MAX2(1U, _num_concurrent_workers);
 925 
 926   // Setting active workers is not guaranteed since fewer
 927   // worker threads may currently exist and more may not be
 928   // available.
 929   active_workers = _concurrent_workers-&gt;update_active_workers(active_workers);
 930   log_info(gc, task)(&quot;Using %u workers of %u for marking&quot;, active_workers, _concurrent_workers-&gt;total_workers());
 931 
 932   // Parallel task terminator is set in &quot;set_concurrency_and_phase()&quot;
 933   set_concurrency_and_phase(active_workers, true /* concurrent */);
 934 
 935   G1CMConcurrentMarkingTask marking_task(this);
 936   _concurrent_workers-&gt;run_task(&amp;marking_task);
 937   print_stats();
 938 }
 939 
 940 void G1ConcurrentMark::verify_during_pause(G1HeapVerifier::G1VerifyType type, VerifyOption vo, const char* caller) {
 941   G1HeapVerifier* verifier = _g1h-&gt;verifier();
 942 
 943   verifier-&gt;verify_region_sets_optional();
 944 
 945   if (VerifyDuringGC) {
 946     GCTraceTime(Debug, gc, phases) debug(caller, _gc_timer_cm);
 947 
 948     size_t const BufLen = 512;
 949     char buffer[BufLen];
 950 
 951     jio_snprintf(buffer, BufLen, &quot;During GC (%s)&quot;, caller);
 952     verifier-&gt;verify(type, vo, buffer);
 953   }
 954 
 955   verifier-&gt;check_bitmaps(caller);
 956 }
 957 
 958 class G1UpdateRemSetTrackingBeforeRebuildTask : public AbstractGangTask {
 959   G1CollectedHeap* _g1h;
 960   G1ConcurrentMark* _cm;
 961   HeapRegionClaimer _hrclaimer;
 962   uint volatile _total_selected_for_rebuild;
 963 
 964   G1PrintRegionLivenessInfoClosure _cl;
 965 
 966   class G1UpdateRemSetTrackingBeforeRebuild : public HeapRegionClosure {
 967     G1CollectedHeap* _g1h;
 968     G1ConcurrentMark* _cm;
 969 
 970     G1PrintRegionLivenessInfoClosure* _cl;
 971 
 972     uint _num_regions_selected_for_rebuild;  // The number of regions actually selected for rebuild.
 973 
 974     void update_remset_before_rebuild(HeapRegion* hr) {
 975       G1RemSetTrackingPolicy* tracking_policy = _g1h-&gt;policy()-&gt;remset_tracker();
 976 
 977       bool selected_for_rebuild;
 978       if (hr-&gt;is_humongous()) {
 979         bool const is_live = _cm-&gt;liveness(hr-&gt;humongous_start_region()-&gt;hrm_index()) &gt; 0;
 980         selected_for_rebuild = tracking_policy-&gt;update_humongous_before_rebuild(hr, is_live);
 981       } else {
 982         size_t const live_bytes = _cm-&gt;liveness(hr-&gt;hrm_index());
 983         selected_for_rebuild = tracking_policy-&gt;update_before_rebuild(hr, live_bytes);
 984       }
 985       if (selected_for_rebuild) {
 986         _num_regions_selected_for_rebuild++;
 987       }
 988       _cm-&gt;update_top_at_rebuild_start(hr);
 989     }
 990 
 991     // Distribute the given words across the humongous object starting with hr and
 992     // note end of marking.
 993     void distribute_marked_bytes(HeapRegion* hr, size_t marked_words) {
 994       uint const region_idx = hr-&gt;hrm_index();
 995       size_t const obj_size_in_words = (size_t)oop(hr-&gt;bottom())-&gt;size();
 996       uint const num_regions_in_humongous = (uint)G1CollectedHeap::humongous_obj_size_in_regions(obj_size_in_words);
 997 
 998       // &quot;Distributing&quot; zero words means that we only note end of marking for these
 999       // regions.
1000       assert(marked_words == 0 || obj_size_in_words == marked_words,
1001              &quot;Marked words should either be 0 or the same as humongous object (&quot; SIZE_FORMAT &quot;) but is &quot; SIZE_FORMAT,
1002              obj_size_in_words, marked_words);
1003 
1004       for (uint i = region_idx; i &lt; (region_idx + num_regions_in_humongous); i++) {
1005         HeapRegion* const r = _g1h-&gt;region_at(i);
1006         size_t const words_to_add = MIN2(HeapRegion::GrainWords, marked_words);
1007 
1008         log_trace(gc, marking)(&quot;Adding &quot; SIZE_FORMAT &quot; words to humongous region %u (%s)&quot;,
1009                                words_to_add, i, r-&gt;get_type_str());
1010         add_marked_bytes_and_note_end(r, words_to_add * HeapWordSize);
1011         marked_words -= words_to_add;
1012       }
1013       assert(marked_words == 0,
1014              SIZE_FORMAT &quot; words left after distributing space across %u regions&quot;,
1015              marked_words, num_regions_in_humongous);
1016     }
1017 
1018     void update_marked_bytes(HeapRegion* hr) {
1019       uint const region_idx = hr-&gt;hrm_index();
1020       size_t const marked_words = _cm-&gt;liveness(region_idx);
1021       // The marking attributes the object&#39;s size completely to the humongous starts
1022       // region. We need to distribute this value across the entire set of regions a
1023       // humongous object spans.
1024       if (hr-&gt;is_humongous()) {
1025         assert(hr-&gt;is_starts_humongous() || marked_words == 0,
1026                &quot;Should not have marked words &quot; SIZE_FORMAT &quot; in non-starts humongous region %u (%s)&quot;,
1027                marked_words, region_idx, hr-&gt;get_type_str());
1028         if (hr-&gt;is_starts_humongous()) {
1029           distribute_marked_bytes(hr, marked_words);
1030         }
1031       } else {
1032         log_trace(gc, marking)(&quot;Adding &quot; SIZE_FORMAT &quot; words to region %u (%s)&quot;, marked_words, region_idx, hr-&gt;get_type_str());
1033         add_marked_bytes_and_note_end(hr, marked_words * HeapWordSize);
1034       }
1035     }
1036 
1037     void add_marked_bytes_and_note_end(HeapRegion* hr, size_t marked_bytes) {
1038       hr-&gt;add_to_marked_bytes(marked_bytes);
1039       _cl-&gt;do_heap_region(hr);
1040       hr-&gt;note_end_of_marking();
1041     }
1042 
1043   public:
1044     G1UpdateRemSetTrackingBeforeRebuild(G1CollectedHeap* g1h, G1ConcurrentMark* cm, G1PrintRegionLivenessInfoClosure* cl) :
1045       _g1h(g1h), _cm(cm), _cl(cl), _num_regions_selected_for_rebuild(0) { }
1046 
1047     virtual bool do_heap_region(HeapRegion* r) {
1048       update_remset_before_rebuild(r);
1049       update_marked_bytes(r);
1050 
1051       return false;
1052     }
1053 
1054     uint num_selected_for_rebuild() const { return _num_regions_selected_for_rebuild; }
1055   };
1056 
1057 public:
1058   G1UpdateRemSetTrackingBeforeRebuildTask(G1CollectedHeap* g1h, G1ConcurrentMark* cm, uint num_workers) :
1059     AbstractGangTask(&quot;G1 Update RemSet Tracking Before Rebuild&quot;),
1060     _g1h(g1h), _cm(cm), _hrclaimer(num_workers), _total_selected_for_rebuild(0), _cl(&quot;Post-Marking&quot;) { }
1061 
1062   virtual void work(uint worker_id) {
1063     G1UpdateRemSetTrackingBeforeRebuild update_cl(_g1h, _cm, &amp;_cl);
1064     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;update_cl, &amp;_hrclaimer, worker_id);
1065     Atomic::add(&amp;_total_selected_for_rebuild, update_cl.num_selected_for_rebuild());
1066   }
1067 
1068   uint total_selected_for_rebuild() const { return _total_selected_for_rebuild; }
1069 
1070   // Number of regions for which roughly one thread should be spawned for this work.
1071   static const uint RegionsPerThread = 384;
1072 };
1073 
1074 class G1UpdateRemSetTrackingAfterRebuild : public HeapRegionClosure {
1075   G1CollectedHeap* _g1h;
1076 public:
1077   G1UpdateRemSetTrackingAfterRebuild(G1CollectedHeap* g1h) : _g1h(g1h) { }
1078 
1079   virtual bool do_heap_region(HeapRegion* r) {
1080     _g1h-&gt;policy()-&gt;remset_tracker()-&gt;update_after_rebuild(r);
1081     return false;
1082   }
1083 };
1084 
1085 void G1ConcurrentMark::remark() {
1086   assert_at_safepoint_on_vm_thread();
1087 
1088   // If a full collection has happened, we should not continue. However we might
1089   // have ended up here as the Remark VM operation has been scheduled already.
1090   if (has_aborted()) {
1091     return;
1092   }
1093 
1094   G1Policy* policy = _g1h-&gt;policy();
1095   policy-&gt;record_concurrent_mark_remark_start();
1096 
1097   double start = os::elapsedTime();
1098 
1099   verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark before&quot;);
1100 
1101   {
1102     GCTraceTime(Debug, gc, phases) debug(&quot;Finalize Marking&quot;, _gc_timer_cm);
1103     finalize_marking();
1104   }
1105 
1106   double mark_work_end = os::elapsedTime();
1107 
1108   bool const mark_finished = !has_overflown();
1109   if (mark_finished) {
1110     weak_refs_work(false /* clear_all_soft_refs */);
1111 
1112     SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1113     // We&#39;re done with marking.
1114     // This is the end of the marking cycle, we&#39;re expected all
1115     // threads to have SATB queues with active set to true.
1116     satb_mq_set.set_active_all_threads(false, /* new active value */
1117                                        true /* expected_active */);
1118 
1119     {
1120       GCTraceTime(Debug, gc, phases) debug(&quot;Flush Task Caches&quot;, _gc_timer_cm);
1121       flush_all_task_caches();
1122     }
1123 
1124     // Install newly created mark bitmap as &quot;prev&quot;.
1125     swap_mark_bitmaps();
1126     {
1127       GCTraceTime(Debug, gc, phases) debug(&quot;Update Remembered Set Tracking Before Rebuild&quot;, _gc_timer_cm);
1128 
1129       uint const workers_by_capacity = (_g1h-&gt;num_regions() + G1UpdateRemSetTrackingBeforeRebuildTask::RegionsPerThread - 1) /
1130                                        G1UpdateRemSetTrackingBeforeRebuildTask::RegionsPerThread;
1131       uint const num_workers = MIN2(_g1h-&gt;workers()-&gt;active_workers(), workers_by_capacity);
1132 
1133       G1UpdateRemSetTrackingBeforeRebuildTask cl(_g1h, this, num_workers);
1134       log_debug(gc,ergo)(&quot;Running %s using %u workers for %u regions in heap&quot;, cl.name(), num_workers, _g1h-&gt;num_regions());
1135       _g1h-&gt;workers()-&gt;run_task(&amp;cl, num_workers);
1136 
1137       log_debug(gc, remset, tracking)(&quot;Remembered Set Tracking update regions total %u, selected %u&quot;,
1138                                       _g1h-&gt;num_regions(), cl.total_selected_for_rebuild());
1139     }
1140     {
1141       GCTraceTime(Debug, gc, phases) debug(&quot;Reclaim Empty Regions&quot;, _gc_timer_cm);
1142       reclaim_empty_regions();
1143     }
1144 
1145     // Clean out dead classes
1146     if (ClassUnloadingWithConcurrentMark) {
1147       GCTraceTime(Debug, gc, phases) debug(&quot;Purge Metaspace&quot;, _gc_timer_cm);
1148       ClassLoaderDataGraph::purge();
1149     }
1150 
1151     _g1h-&gt;resize_heap_if_necessary();
1152 
1153     compute_new_sizes();
1154 
1155     verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark after&quot;);
1156 
1157     assert(!restart_for_overflow(), &quot;sanity&quot;);
1158     // Completely reset the marking state since marking completed
1159     reset_at_marking_complete();
1160   } else {
1161     // We overflowed.  Restart concurrent marking.
1162     _restart_for_overflow = true;
1163 
1164     verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark overflow&quot;);
1165 
1166     // Clear the marking state because we will be restarting
1167     // marking due to overflowing the global mark stack.
1168     reset_marking_for_restart();
1169   }
1170 
1171   {
1172     GCTraceTime(Debug, gc, phases) debug(&quot;Report Object Count&quot;, _gc_timer_cm);
1173     report_object_count(mark_finished);
1174   }
1175 
1176   // Statistics
1177   double now = os::elapsedTime();
1178   _remark_mark_times.add((mark_work_end - start) * 1000.0);
1179   _remark_weak_ref_times.add((now - mark_work_end) * 1000.0);
1180   _remark_times.add((now - start) * 1000.0);
1181 
1182   policy-&gt;record_concurrent_mark_remark_end();
1183   CodeCache::increment_marking_cycle();
1184 }
1185 
1186 class G1ReclaimEmptyRegionsTask : public AbstractGangTask {
1187   // Per-region work during the Cleanup pause.
1188   class G1ReclaimEmptyRegionsClosure : public HeapRegionClosure {
1189     G1CollectedHeap* _g1h;
1190     size_t _freed_bytes;
1191     FreeRegionList* _local_cleanup_list;
1192     uint _old_regions_removed;
1193     uint _humongous_regions_removed;
1194 
1195   public:
1196     G1ReclaimEmptyRegionsClosure(G1CollectedHeap* g1h,
1197                                  FreeRegionList* local_cleanup_list) :
1198       _g1h(g1h),
1199       _freed_bytes(0),
1200       _local_cleanup_list(local_cleanup_list),
1201       _old_regions_removed(0),
1202       _humongous_regions_removed(0) { }
1203 
1204     size_t freed_bytes() { return _freed_bytes; }
1205     const uint old_regions_removed() { return _old_regions_removed; }
1206     const uint humongous_regions_removed() { return _humongous_regions_removed; }
1207 
1208     bool do_heap_region(HeapRegion *hr) {
1209       if (hr-&gt;used() &gt; 0 &amp;&amp; hr-&gt;max_live_bytes() == 0 &amp;&amp; !hr-&gt;is_young() &amp;&amp; !hr-&gt;is_archive()) {
1210         _freed_bytes += hr-&gt;used();
1211         hr-&gt;set_containing_set(NULL);
1212         if (hr-&gt;is_humongous()) {
1213           _humongous_regions_removed++;
1214           _g1h-&gt;free_humongous_region(hr, _local_cleanup_list);
1215         } else {
1216           _old_regions_removed++;
1217           _g1h-&gt;free_region(hr, _local_cleanup_list);
1218         }
1219         hr-&gt;clear_cardtable();
1220         _g1h-&gt;concurrent_mark()-&gt;clear_statistics_in_region(hr-&gt;hrm_index());
1221         log_trace(gc)(&quot;Reclaimed empty region %u (%s) bot &quot; PTR_FORMAT, hr-&gt;hrm_index(), hr-&gt;get_short_type_str(), p2i(hr-&gt;bottom()));
1222       }
1223 
1224       return false;
1225     }
1226   };
1227 
1228   G1CollectedHeap* _g1h;
1229   FreeRegionList* _cleanup_list;
1230   HeapRegionClaimer _hrclaimer;
1231 
1232 public:
1233   G1ReclaimEmptyRegionsTask(G1CollectedHeap* g1h, FreeRegionList* cleanup_list, uint n_workers) :
1234     AbstractGangTask(&quot;G1 Cleanup&quot;),
1235     _g1h(g1h),
1236     _cleanup_list(cleanup_list),
1237     _hrclaimer(n_workers) {
1238   }
1239 
1240   void work(uint worker_id) {
1241     FreeRegionList local_cleanup_list(&quot;Local Cleanup List&quot;);
1242     G1ReclaimEmptyRegionsClosure cl(_g1h, &amp;local_cleanup_list);
1243     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;cl, &amp;_hrclaimer, worker_id);
1244     assert(cl.is_complete(), &quot;Shouldn&#39;t have aborted!&quot;);
1245 
1246     // Now update the old/humongous region sets
1247     _g1h-&gt;remove_from_old_sets(cl.old_regions_removed(), cl.humongous_regions_removed());
1248     {
1249       MutexLocker x(ParGCRareEvent_lock, Mutex::_no_safepoint_check_flag);
1250       _g1h-&gt;decrement_summary_bytes(cl.freed_bytes());
1251 
1252       _cleanup_list-&gt;add_ordered(&amp;local_cleanup_list);
1253       assert(local_cleanup_list.is_empty(), &quot;post-condition&quot;);
1254     }
1255   }
1256 };
1257 
1258 void G1ConcurrentMark::reclaim_empty_regions() {
1259   WorkGang* workers = _g1h-&gt;workers();
1260   FreeRegionList empty_regions_list(&quot;Empty Regions After Mark List&quot;);
1261 
1262   G1ReclaimEmptyRegionsTask cl(_g1h, &amp;empty_regions_list, workers-&gt;active_workers());
1263   workers-&gt;run_task(&amp;cl);
1264 
1265   if (!empty_regions_list.is_empty()) {
1266     log_debug(gc)(&quot;Reclaimed %u empty regions&quot;, empty_regions_list.length());
1267     // Now print the empty regions list.
1268     G1HRPrinter* hrp = _g1h-&gt;hr_printer();
1269     if (hrp-&gt;is_active()) {
1270       FreeRegionListIterator iter(&amp;empty_regions_list);
1271       while (iter.more_available()) {
1272         HeapRegion* hr = iter.get_next();
1273         hrp-&gt;cleanup(hr);
1274       }
1275     }
1276     // And actually make them available.
1277     _g1h-&gt;prepend_to_freelist(&amp;empty_regions_list);
1278   }
1279 }
1280 
1281 void G1ConcurrentMark::compute_new_sizes() {
1282   MetaspaceGC::compute_new_size();
1283 
1284   // Cleanup will have freed any regions completely full of garbage.
1285   // Update the soft reference policy with the new heap occupancy.
1286   Universe::update_heap_info_at_gc();
1287 
1288   // We reclaimed old regions so we should calculate the sizes to make
1289   // sure we update the old gen/space data.
1290   _g1h-&gt;g1mm()-&gt;update_sizes();
1291 }
1292 
1293 void G1ConcurrentMark::cleanup() {
1294   assert_at_safepoint_on_vm_thread();
1295 
1296   // If a full collection has happened, we shouldn&#39;t do this.
1297   if (has_aborted()) {
1298     return;
1299   }
1300 
1301   G1Policy* policy = _g1h-&gt;policy();
1302   policy-&gt;record_concurrent_mark_cleanup_start();
1303 
1304   double start = os::elapsedTime();
1305 
1306   verify_during_pause(G1HeapVerifier::G1VerifyCleanup, VerifyOption_G1UsePrevMarking, &quot;Cleanup before&quot;);
1307 
1308   {
1309     GCTraceTime(Debug, gc, phases) debug(&quot;Update Remembered Set Tracking After Rebuild&quot;, _gc_timer_cm);
1310     G1UpdateRemSetTrackingAfterRebuild cl(_g1h);
1311     _g1h-&gt;heap_region_iterate(&amp;cl);
1312   }
1313 
1314   if (log_is_enabled(Trace, gc, liveness)) {
1315     G1PrintRegionLivenessInfoClosure cl(&quot;Post-Cleanup&quot;);
1316     _g1h-&gt;heap_region_iterate(&amp;cl);
1317   }
1318 
1319   verify_during_pause(G1HeapVerifier::G1VerifyCleanup, VerifyOption_G1UsePrevMarking, &quot;Cleanup after&quot;);
1320 
1321   // We need to make this be a &quot;collection&quot; so any collection pause that
1322   // races with it goes around and waits for Cleanup to finish.
1323   _g1h-&gt;increment_total_collections();
1324 
1325   // Local statistics
1326   double recent_cleanup_time = (os::elapsedTime() - start);
1327   _total_cleanup_time += recent_cleanup_time;
1328   _cleanup_times.add(recent_cleanup_time);
1329 
1330   {
1331     GCTraceTime(Debug, gc, phases) debug(&quot;Finalize Concurrent Mark Cleanup&quot;, _gc_timer_cm);
1332     policy-&gt;record_concurrent_mark_cleanup_end();
1333   }
1334 }
1335 
1336 // &#39;Keep Alive&#39; oop closure used by both serial parallel reference processing.
1337 // Uses the G1CMTask associated with a worker thread (for serial reference
1338 // processing the G1CMTask for worker 0 is used) to preserve (mark) and
1339 // trace referent objects.
1340 //
1341 // Using the G1CMTask and embedded local queues avoids having the worker
1342 // threads operating on the global mark stack. This reduces the risk
1343 // of overflowing the stack - which we would rather avoid at this late
1344 // state. Also using the tasks&#39; local queues removes the potential
1345 // of the workers interfering with each other that could occur if
1346 // operating on the global stack.
1347 
1348 class G1CMKeepAliveAndDrainClosure : public OopClosure {
1349   G1ConcurrentMark* _cm;
1350   G1CMTask*         _task;
1351   uint              _ref_counter_limit;
1352   uint              _ref_counter;
1353   bool              _is_serial;
1354 public:
1355   G1CMKeepAliveAndDrainClosure(G1ConcurrentMark* cm, G1CMTask* task, bool is_serial) :
1356     _cm(cm), _task(task), _ref_counter_limit(G1RefProcDrainInterval),
1357     _ref_counter(_ref_counter_limit), _is_serial(is_serial) {
1358     assert(!_is_serial || _task-&gt;worker_id() == 0, &quot;only task 0 for serial code&quot;);
1359   }
1360 
1361   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
1362   virtual void do_oop(      oop* p) { do_oop_work(p); }
1363 
1364   template &lt;class T&gt; void do_oop_work(T* p) {
1365     if (_cm-&gt;has_overflown()) {
1366       return;
1367     }
1368     if (!_task-&gt;deal_with_reference(p)) {
1369       // We did not add anything to the mark bitmap (or mark stack), so there is
1370       // no point trying to drain it.
1371       return;
1372     }
1373     _ref_counter--;
1374 
1375     if (_ref_counter == 0) {
1376       // We have dealt with _ref_counter_limit references, pushing them
1377       // and objects reachable from them on to the local stack (and
1378       // possibly the global stack). Call G1CMTask::do_marking_step() to
1379       // process these entries.
1380       //
1381       // We call G1CMTask::do_marking_step() in a loop, which we&#39;ll exit if
1382       // there&#39;s nothing more to do (i.e. we&#39;re done with the entries that
1383       // were pushed as a result of the G1CMTask::deal_with_reference() calls
1384       // above) or we overflow.
1385       //
1386       // Note: G1CMTask::do_marking_step() can set the G1CMTask::has_aborted()
1387       // flag while there may still be some work to do. (See the comment at
1388       // the beginning of G1CMTask::do_marking_step() for those conditions -
1389       // one of which is reaching the specified time target.) It is only
1390       // when G1CMTask::do_marking_step() returns without setting the
1391       // has_aborted() flag that the marking step has completed.
1392       do {
1393         double mark_step_duration_ms = G1ConcMarkStepDurationMillis;
1394         _task-&gt;do_marking_step(mark_step_duration_ms,
1395                                false      /* do_termination */,
1396                                _is_serial);
1397       } while (_task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1398       _ref_counter = _ref_counter_limit;
1399     }
1400   }
1401 };
1402 
1403 // &#39;Drain&#39; oop closure used by both serial and parallel reference processing.
1404 // Uses the G1CMTask associated with a given worker thread (for serial
1405 // reference processing the G1CMtask for worker 0 is used). Calls the
1406 // do_marking_step routine, with an unbelievably large timeout value,
1407 // to drain the marking data structures of the remaining entries
1408 // added by the &#39;keep alive&#39; oop closure above.
1409 
1410 class G1CMDrainMarkingStackClosure : public VoidClosure {
1411   G1ConcurrentMark* _cm;
1412   G1CMTask*         _task;
1413   bool              _is_serial;
1414  public:
1415   G1CMDrainMarkingStackClosure(G1ConcurrentMark* cm, G1CMTask* task, bool is_serial) :
1416     _cm(cm), _task(task), _is_serial(is_serial) {
1417     assert(!_is_serial || _task-&gt;worker_id() == 0, &quot;only task 0 for serial code&quot;);
1418   }
1419 
1420   void do_void() {
1421     do {
1422       // We call G1CMTask::do_marking_step() to completely drain the local
1423       // and global marking stacks of entries pushed by the &#39;keep alive&#39;
1424       // oop closure (an instance of G1CMKeepAliveAndDrainClosure above).
1425       //
1426       // G1CMTask::do_marking_step() is called in a loop, which we&#39;ll exit
1427       // if there&#39;s nothing more to do (i.e. we&#39;ve completely drained the
1428       // entries that were pushed as a a result of applying the &#39;keep alive&#39;
1429       // closure to the entries on the discovered ref lists) or we overflow
1430       // the global marking stack.
1431       //
1432       // Note: G1CMTask::do_marking_step() can set the G1CMTask::has_aborted()
1433       // flag while there may still be some work to do. (See the comment at
1434       // the beginning of G1CMTask::do_marking_step() for those conditions -
1435       // one of which is reaching the specified time target.) It is only
1436       // when G1CMTask::do_marking_step() returns without setting the
1437       // has_aborted() flag that the marking step has completed.
1438 
1439       _task-&gt;do_marking_step(1000000000.0 /* something very large */,
1440                              true         /* do_termination */,
1441                              _is_serial);
1442     } while (_task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1443   }
1444 };
1445 
1446 // Implementation of AbstractRefProcTaskExecutor for parallel
1447 // reference processing at the end of G1 concurrent marking
1448 
1449 class G1CMRefProcTaskExecutor : public AbstractRefProcTaskExecutor {
1450 private:
1451   G1CollectedHeap*  _g1h;
1452   G1ConcurrentMark* _cm;
1453   WorkGang*         _workers;
1454   uint              _active_workers;
1455 
1456 public:
1457   G1CMRefProcTaskExecutor(G1CollectedHeap* g1h,
1458                           G1ConcurrentMark* cm,
1459                           WorkGang* workers,
1460                           uint n_workers) :
1461     _g1h(g1h), _cm(cm),
1462     _workers(workers), _active_workers(n_workers) { }
1463 
1464   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
1465 };
1466 
1467 class G1CMRefProcTaskProxy : public AbstractGangTask {
1468   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
1469   ProcessTask&amp;      _proc_task;
1470   G1CollectedHeap*  _g1h;
1471   G1ConcurrentMark* _cm;
1472 
1473 public:
1474   G1CMRefProcTaskProxy(ProcessTask&amp; proc_task,
1475                        G1CollectedHeap* g1h,
1476                        G1ConcurrentMark* cm) :
1477     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
1478     _proc_task(proc_task), _g1h(g1h), _cm(cm) {
1479     ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1480     assert(rp-&gt;processing_is_mt(), &quot;shouldn&#39;t be here otherwise&quot;);
1481   }
1482 
1483   virtual void work(uint worker_id) {
1484     ResourceMark rm;
1485     HandleMark hm;
1486     G1CMTask* task = _cm-&gt;task(worker_id);
1487     G1CMIsAliveClosure g1_is_alive(_g1h);
1488     G1CMKeepAliveAndDrainClosure g1_par_keep_alive(_cm, task, false /* is_serial */);
1489     G1CMDrainMarkingStackClosure g1_par_drain(_cm, task, false /* is_serial */);
1490 
1491     _proc_task.work(worker_id, g1_is_alive, g1_par_keep_alive, g1_par_drain);
1492   }
1493 };
1494 
1495 void G1CMRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
1496   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
1497   assert(_g1h-&gt;ref_processor_cm()-&gt;processing_is_mt(), &quot;processing is not MT&quot;);
1498   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
1499          &quot;Ergonomically chosen workers(%u) should be less than or equal to active workers(%u)&quot;,
1500          ergo_workers, _workers-&gt;active_workers());
1501 
1502   G1CMRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _cm);
1503 
1504   // We need to reset the concurrency level before each
1505   // proxy task execution, so that the termination protocol
1506   // and overflow handling in G1CMTask::do_marking_step() knows
1507   // how many workers to wait for.
1508   _cm-&gt;set_concurrency(ergo_workers);
1509   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
1510 }
1511 
1512 void G1ConcurrentMark::weak_refs_work(bool clear_all_soft_refs) {
1513   ResourceMark rm;
1514   HandleMark   hm;
1515 
1516   // Is alive closure.
1517   G1CMIsAliveClosure g1_is_alive(_g1h);
1518 
1519   // Inner scope to exclude the cleaning of the string table
1520   // from the displayed time.
1521   {
1522     GCTraceTime(Debug, gc, phases) debug(&quot;Reference Processing&quot;, _gc_timer_cm);
1523 
1524     ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1525 
1526     // See the comment in G1CollectedHeap::ref_processing_init()
1527     // about how reference processing currently works in G1.
1528 
1529     // Set the soft reference policy
1530     rp-&gt;setup_policy(clear_all_soft_refs);
1531     assert(_global_mark_stack.is_empty(), &quot;mark stack should be empty&quot;);
1532 
1533     // Instances of the &#39;Keep Alive&#39; and &#39;Complete GC&#39; closures used
1534     // in serial reference processing. Note these closures are also
1535     // used for serially processing (by the the current thread) the
1536     // JNI references during parallel reference processing.
1537     //
1538     // These closures do not need to synchronize with the worker
1539     // threads involved in parallel reference processing as these
1540     // instances are executed serially by the current thread (e.g.
1541     // reference processing is not multi-threaded and is thus
1542     // performed by the current thread instead of a gang worker).
1543     //
1544     // The gang tasks involved in parallel reference processing create
1545     // their own instances of these closures, which do their own
1546     // synchronization among themselves.
1547     G1CMKeepAliveAndDrainClosure g1_keep_alive(this, task(0), true /* is_serial */);
1548     G1CMDrainMarkingStackClosure g1_drain_mark_stack(this, task(0), true /* is_serial */);
1549 
1550     // We need at least one active thread. If reference processing
1551     // is not multi-threaded we use the current (VMThread) thread,
1552     // otherwise we use the work gang from the G1CollectedHeap and
1553     // we utilize all the worker threads we can.
1554     bool processing_is_mt = rp-&gt;processing_is_mt();
1555     uint active_workers = (processing_is_mt ? _g1h-&gt;workers()-&gt;active_workers() : 1U);
1556     active_workers = clamp(active_workers, 1u, _max_num_tasks);
1557 
1558     // Parallel processing task executor.
1559     G1CMRefProcTaskExecutor par_task_executor(_g1h, this,
1560                                               _g1h-&gt;workers(), active_workers);
1561     AbstractRefProcTaskExecutor* executor = (processing_is_mt ? &amp;par_task_executor : NULL);
1562 
1563     // Set the concurrency level. The phase was already set prior to
1564     // executing the remark task.
1565     set_concurrency(active_workers);
1566 
1567     // Set the degree of MT processing here.  If the discovery was done MT,
1568     // the number of threads involved during discovery could differ from
1569     // the number of active workers.  This is OK as long as the discovered
1570     // Reference lists are balanced (see balance_all_queues() and balance_queues()).
1571     rp-&gt;set_active_mt_degree(active_workers);
1572 
1573     ReferenceProcessorPhaseTimes pt(_gc_timer_cm, rp-&gt;max_num_queues());
1574 
1575     // Process the weak references.
1576     const ReferenceProcessorStats&amp; stats =
1577         rp-&gt;process_discovered_references(&amp;g1_is_alive,
1578                                           &amp;g1_keep_alive,
1579                                           &amp;g1_drain_mark_stack,
1580                                           executor,
1581                                           &amp;pt);
1582     _gc_tracer_cm-&gt;report_gc_reference_stats(stats);
1583     pt.print_all_references();
1584 
1585     // The do_oop work routines of the keep_alive and drain_marking_stack
1586     // oop closures will set the has_overflown flag if we overflow the
1587     // global marking stack.
1588 
1589     assert(has_overflown() || _global_mark_stack.is_empty(),
1590            &quot;Mark stack should be empty (unless it has overflown)&quot;);
1591 
1592     assert(rp-&gt;num_queues() == active_workers, &quot;why not&quot;);
1593 
1594     rp-&gt;verify_no_references_recorded();
1595     assert(!rp-&gt;discovery_enabled(), &quot;Post condition&quot;);
1596   }
1597 
1598   if (has_overflown()) {
1599     // We can not trust g1_is_alive and the contents of the heap if the marking stack
1600     // overflowed while processing references. Exit the VM.
1601     fatal(&quot;Overflow during reference processing, can not continue. Please &quot;
1602           &quot;increase MarkStackSizeMax (current value: &quot; SIZE_FORMAT &quot;) and &quot;
1603           &quot;restart.&quot;, MarkStackSizeMax);
1604     return;
1605   }
1606 
1607   assert(_global_mark_stack.is_empty(), &quot;Marking should have completed&quot;);
1608 
1609   {
1610     GCTraceTime(Debug, gc, phases) debug(&quot;Weak Processing&quot;, _gc_timer_cm);
1611     WeakProcessor::weak_oops_do(_g1h-&gt;workers(), &amp;g1_is_alive, &amp;do_nothing_cl, 1);
1612   }
1613 
1614   // Unload Klasses, String, Code Cache, etc.
1615   if (ClassUnloadingWithConcurrentMark) {
1616     GCTraceTime(Debug, gc, phases) debug(&quot;Class Unloading&quot;, _gc_timer_cm);
1617     bool purged_classes = SystemDictionary::do_unloading(_gc_timer_cm);
1618     _g1h-&gt;complete_cleaning(&amp;g1_is_alive, purged_classes);
1619   } else if (StringDedup::is_enabled()) {
1620     GCTraceTime(Debug, gc, phases) debug(&quot;String Deduplication&quot;, _gc_timer_cm);
1621     _g1h-&gt;string_dedup_cleaning(&amp;g1_is_alive, NULL);
1622   }
1623 }
1624 
1625 class G1PrecleanYieldClosure : public YieldClosure {
1626   G1ConcurrentMark* _cm;
1627 
1628 public:
1629   G1PrecleanYieldClosure(G1ConcurrentMark* cm) : _cm(cm) { }
1630 
1631   virtual bool should_return() {
1632     return _cm-&gt;has_aborted();
1633   }
1634 
1635   virtual bool should_return_fine_grain() {
1636     _cm-&gt;do_yield_check();
1637     return _cm-&gt;has_aborted();
1638   }
1639 };
1640 
1641 void G1ConcurrentMark::preclean() {
1642   assert(G1UseReferencePrecleaning, &quot;Precleaning must be enabled.&quot;);
1643 
1644   SuspendibleThreadSetJoiner joiner;
1645 
1646   G1CMKeepAliveAndDrainClosure keep_alive(this, task(0), true /* is_serial */);
1647   G1CMDrainMarkingStackClosure drain_mark_stack(this, task(0), true /* is_serial */);
1648 
1649   set_concurrency_and_phase(1, true);
1650 
1651   G1PrecleanYieldClosure yield_cl(this);
1652 
1653   ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1654   // Precleaning is single threaded. Temporarily disable MT discovery.
1655   ReferenceProcessorMTDiscoveryMutator rp_mut_discovery(rp, false);
1656   rp-&gt;preclean_discovered_references(rp-&gt;is_alive_non_header(),
1657                                      &amp;keep_alive,
1658                                      &amp;drain_mark_stack,
1659                                      &amp;yield_cl,
1660                                      _gc_timer_cm);
1661 }
1662 
1663 // When sampling object counts, we already swapped the mark bitmaps, so we need to use
1664 // the prev bitmap determining liveness.
1665 class G1ObjectCountIsAliveClosure: public BoolObjectClosure {
1666   G1CollectedHeap* _g1h;
1667 public:
1668   G1ObjectCountIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) { }
1669 
1670   bool do_object_b(oop obj) {
1671     return obj != NULL &amp;&amp;
1672            (!_g1h-&gt;is_in_g1_reserved(obj) || !_g1h-&gt;is_obj_dead(obj));
1673   }
1674 };
1675 
1676 void G1ConcurrentMark::report_object_count(bool mark_completed) {
1677   // Depending on the completion of the marking liveness needs to be determined
1678   // using either the next or prev bitmap.
1679   if (mark_completed) {
1680     G1ObjectCountIsAliveClosure is_alive(_g1h);
1681     _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;is_alive);
1682   } else {
1683     G1CMIsAliveClosure is_alive(_g1h);
1684     _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;is_alive);
1685   }
1686 }
1687 
1688 
1689 void G1ConcurrentMark::swap_mark_bitmaps() {
1690   G1CMBitMap* temp = _prev_mark_bitmap;
1691   _prev_mark_bitmap = _next_mark_bitmap;
1692   _next_mark_bitmap = temp;
1693   _g1h-&gt;collector_state()-&gt;set_clearing_next_bitmap(true);
1694 }
1695 
1696 // Closure for marking entries in SATB buffers.
1697 class G1CMSATBBufferClosure : public SATBBufferClosure {
1698 private:
1699   G1CMTask* _task;
1700   G1CollectedHeap* _g1h;
1701 
1702   // This is very similar to G1CMTask::deal_with_reference, but with
1703   // more relaxed requirements for the argument, so this must be more
1704   // circumspect about treating the argument as an object.
1705   void do_entry(void* entry) const {
1706     _task-&gt;increment_refs_reached();
1707     oop const obj = static_cast&lt;oop&gt;(entry);
1708     _task-&gt;make_reference_grey(obj);
1709   }
1710 
1711 public:
1712   G1CMSATBBufferClosure(G1CMTask* task, G1CollectedHeap* g1h)
1713     : _task(task), _g1h(g1h) { }
1714 
1715   virtual void do_buffer(void** buffer, size_t size) {
1716     for (size_t i = 0; i &lt; size; ++i) {
1717       do_entry(buffer[i]);
1718     }
1719   }
1720 };
1721 
1722 class G1RemarkThreadsClosure : public ThreadClosure {
1723   G1CMSATBBufferClosure _cm_satb_cl;
1724   G1CMOopClosure _cm_cl;
1725   MarkingCodeBlobClosure _code_cl;
1726   uintx _claim_token;
1727 
1728  public:
1729   G1RemarkThreadsClosure(G1CollectedHeap* g1h, G1CMTask* task) :
1730     _cm_satb_cl(task, g1h),
1731     _cm_cl(g1h, task),
<a name="1" id="anc1"></a><span class="line-modified">1732     _code_cl(&amp;_cm_cl, !CodeBlobToOopClosure::FixRelocations, true /* keepalive nmethods */),</span>
1733     _claim_token(Threads::thread_claim_token()) {}
1734 
1735   void do_thread(Thread* thread) {
1736     if (thread-&gt;claim_threads_do(true, _claim_token)) {
1737       SATBMarkQueue&amp; queue = G1ThreadLocalData::satb_mark_queue(thread);
1738       queue.apply_closure_and_empty(&amp;_cm_satb_cl);
1739       if (thread-&gt;is_Java_thread()) {
1740         // In theory it should not be neccessary to explicitly walk the nmethods to find roots for concurrent marking
1741         // however the liveness of oops reachable from nmethods have very complex lifecycles:
1742         // * Alive if on the stack of an executing method
1743         // * Weakly reachable otherwise
1744         // Some objects reachable from nmethods, such as the class loader (or klass_holder) of the receiver should be
1745         // live by the SATB invariant but other oops recorded in nmethods may behave differently.
1746         JavaThread* jt = (JavaThread*)thread;
1747         jt-&gt;nmethods_do(&amp;_code_cl);
1748       }
1749     }
1750   }
1751 };
1752 
1753 class G1CMRemarkTask : public AbstractGangTask {
1754   G1ConcurrentMark* _cm;
1755 public:
1756   void work(uint worker_id) {
1757     G1CMTask* task = _cm-&gt;task(worker_id);
1758     task-&gt;record_start_time();
1759     {
1760       ResourceMark rm;
1761       HandleMark hm;
1762 
1763       G1RemarkThreadsClosure threads_f(G1CollectedHeap::heap(), task);
1764       Threads::threads_do(&amp;threads_f);
1765     }
1766 
1767     do {
1768       task-&gt;do_marking_step(1000000000.0 /* something very large */,
1769                             true         /* do_termination       */,
1770                             false        /* is_serial            */);
1771     } while (task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1772     // If we overflow, then we do not want to restart. We instead
1773     // want to abort remark and do concurrent marking again.
1774     task-&gt;record_end_time();
1775   }
1776 
1777   G1CMRemarkTask(G1ConcurrentMark* cm, uint active_workers) :
1778     AbstractGangTask(&quot;Par Remark&quot;), _cm(cm) {
1779     _cm-&gt;terminator()-&gt;reset_for_reuse(active_workers);
1780   }
1781 };
1782 
1783 void G1ConcurrentMark::finalize_marking() {
1784   ResourceMark rm;
1785   HandleMark   hm;
1786 
1787   _g1h-&gt;ensure_parsability(false);
1788 
1789   // this is remark, so we&#39;ll use up all active threads
1790   uint active_workers = _g1h-&gt;workers()-&gt;active_workers();
1791   set_concurrency_and_phase(active_workers, false /* concurrent */);
1792   // Leave _parallel_marking_threads at it&#39;s
1793   // value originally calculated in the G1ConcurrentMark
1794   // constructor and pass values of the active workers
1795   // through the gang in the task.
1796 
1797   {
1798     StrongRootsScope srs(active_workers);
1799 
1800     G1CMRemarkTask remarkTask(this, active_workers);
1801     // We will start all available threads, even if we decide that the
1802     // active_workers will be fewer. The extra ones will just bail out
1803     // immediately.
1804     _g1h-&gt;workers()-&gt;run_task(&amp;remarkTask);
1805   }
1806 
1807   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1808   guarantee(has_overflown() ||
1809             satb_mq_set.completed_buffers_num() == 0,
1810             &quot;Invariant: has_overflown = %s, num buffers = &quot; SIZE_FORMAT,
1811             BOOL_TO_STR(has_overflown()),
1812             satb_mq_set.completed_buffers_num());
1813 
1814   print_stats();
1815 }
1816 
1817 void G1ConcurrentMark::flush_all_task_caches() {
1818   size_t hits = 0;
1819   size_t misses = 0;
1820   for (uint i = 0; i &lt; _max_num_tasks; i++) {
1821     Pair&lt;size_t, size_t&gt; stats = _tasks[i]-&gt;flush_mark_stats_cache();
1822     hits += stats.first;
1823     misses += stats.second;
1824   }
1825   size_t sum = hits + misses;
1826   log_debug(gc, stats)(&quot;Mark stats cache hits &quot; SIZE_FORMAT &quot; misses &quot; SIZE_FORMAT &quot; ratio %1.3lf&quot;,
1827                        hits, misses, percent_of(hits, sum));
1828 }
1829 
1830 void G1ConcurrentMark::clear_range_in_prev_bitmap(MemRegion mr) {
1831   _prev_mark_bitmap-&gt;clear_range(mr);
1832 }
1833 
1834 HeapRegion*
1835 G1ConcurrentMark::claim_region(uint worker_id) {
1836   // &quot;checkpoint&quot; the finger
1837   HeapWord* finger = _finger;
1838 
1839   while (finger &lt; _heap.end()) {
1840     assert(_g1h-&gt;is_in_g1_reserved(finger), &quot;invariant&quot;);
1841 
1842     HeapRegion* curr_region = _g1h-&gt;heap_region_containing(finger);
1843     // Make sure that the reads below do not float before loading curr_region.
1844     OrderAccess::loadload();
1845     // Above heap_region_containing may return NULL as we always scan claim
1846     // until the end of the heap. In this case, just jump to the next region.
1847     HeapWord* end = curr_region != NULL ? curr_region-&gt;end() : finger + HeapRegion::GrainWords;
1848 
1849     // Is the gap between reading the finger and doing the CAS too long?
1850     HeapWord* res = Atomic::cmpxchg(&amp;_finger, finger, end);
1851     if (res == finger &amp;&amp; curr_region != NULL) {
1852       // we succeeded
1853       HeapWord*   bottom        = curr_region-&gt;bottom();
1854       HeapWord*   limit         = curr_region-&gt;next_top_at_mark_start();
1855 
1856       // notice that _finger == end cannot be guaranteed here since,
1857       // someone else might have moved the finger even further
1858       assert(_finger &gt;= end, &quot;the finger should have moved forward&quot;);
1859 
1860       if (limit &gt; bottom) {
1861         return curr_region;
1862       } else {
1863         assert(limit == bottom,
1864                &quot;the region limit should be at bottom&quot;);
1865         // we return NULL and the caller should try calling
1866         // claim_region() again.
1867         return NULL;
1868       }
1869     } else {
1870       assert(_finger &gt; finger, &quot;the finger should have moved forward&quot;);
1871       // read it again
1872       finger = _finger;
1873     }
1874   }
1875 
1876   return NULL;
1877 }
1878 
1879 #ifndef PRODUCT
1880 class VerifyNoCSetOops {
1881   G1CollectedHeap* _g1h;
1882   const char* _phase;
1883   int _info;
1884 
1885 public:
1886   VerifyNoCSetOops(const char* phase, int info = -1) :
1887     _g1h(G1CollectedHeap::heap()),
1888     _phase(phase),
1889     _info(info)
1890   { }
1891 
1892   void operator()(G1TaskQueueEntry task_entry) const {
1893     if (task_entry.is_array_slice()) {
1894       guarantee(_g1h-&gt;is_in_reserved(task_entry.slice()), &quot;Slice &quot; PTR_FORMAT &quot; must be in heap.&quot;, p2i(task_entry.slice()));
1895       return;
1896     }
1897     guarantee(oopDesc::is_oop(task_entry.obj()),
1898               &quot;Non-oop &quot; PTR_FORMAT &quot;, phase: %s, info: %d&quot;,
1899               p2i(task_entry.obj()), _phase, _info);
1900     HeapRegion* r = _g1h-&gt;heap_region_containing(task_entry.obj());
1901     guarantee(!(r-&gt;in_collection_set() || r-&gt;has_index_in_opt_cset()),
1902               &quot;obj &quot; PTR_FORMAT &quot; from %s (%d) in region %u in (optional) collection set&quot;,
1903               p2i(task_entry.obj()), _phase, _info, r-&gt;hrm_index());
1904   }
1905 };
1906 
1907 void G1ConcurrentMark::verify_no_collection_set_oops() {
1908   assert(SafepointSynchronize::is_at_safepoint(), &quot;should be at a safepoint&quot;);
1909   if (!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress()) {
1910     return;
1911   }
1912 
1913   // Verify entries on the global mark stack
1914   _global_mark_stack.iterate(VerifyNoCSetOops(&quot;Stack&quot;));
1915 
1916   // Verify entries on the task queues
1917   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
1918     G1CMTaskQueue* queue = _task_queues-&gt;queue(i);
1919     queue-&gt;iterate(VerifyNoCSetOops(&quot;Queue&quot;, i));
1920   }
1921 
1922   // Verify the global finger
1923   HeapWord* global_finger = finger();
1924   if (global_finger != NULL &amp;&amp; global_finger &lt; _heap.end()) {
1925     // Since we always iterate over all regions, we might get a NULL HeapRegion
1926     // here.
1927     HeapRegion* global_hr = _g1h-&gt;heap_region_containing(global_finger);
1928     guarantee(global_hr == NULL || global_finger == global_hr-&gt;bottom(),
1929               &quot;global finger: &quot; PTR_FORMAT &quot; region: &quot; HR_FORMAT,
1930               p2i(global_finger), HR_FORMAT_PARAMS(global_hr));
1931   }
1932 
1933   // Verify the task fingers
1934   assert(_num_concurrent_workers &lt;= _max_num_tasks, &quot;sanity&quot;);
1935   for (uint i = 0; i &lt; _num_concurrent_workers; ++i) {
1936     G1CMTask* task = _tasks[i];
1937     HeapWord* task_finger = task-&gt;finger();
1938     if (task_finger != NULL &amp;&amp; task_finger &lt; _heap.end()) {
1939       // See above note on the global finger verification.
1940       HeapRegion* r = _g1h-&gt;heap_region_containing(task_finger);
1941       guarantee(r == NULL || task_finger == r-&gt;bottom() ||
1942                 !r-&gt;in_collection_set() || !r-&gt;has_index_in_opt_cset(),
1943                 &quot;task finger: &quot; PTR_FORMAT &quot; region: &quot; HR_FORMAT,
1944                 p2i(task_finger), HR_FORMAT_PARAMS(r));
1945     }
1946   }
1947 }
1948 #endif // PRODUCT
1949 
1950 void G1ConcurrentMark::rebuild_rem_set_concurrently() {
1951   _g1h-&gt;rem_set()-&gt;rebuild_rem_set(this, _concurrent_workers, _worker_id_offset);
1952 }
1953 
1954 void G1ConcurrentMark::print_stats() {
1955   if (!log_is_enabled(Debug, gc, stats)) {
1956     return;
1957   }
1958   log_debug(gc, stats)(&quot;---------------------------------------------------------------------&quot;);
1959   for (size_t i = 0; i &lt; _num_active_tasks; ++i) {
1960     _tasks[i]-&gt;print_stats();
1961     log_debug(gc, stats)(&quot;---------------------------------------------------------------------&quot;);
1962   }
1963 }
1964 
1965 void G1ConcurrentMark::concurrent_cycle_abort() {
1966   if (!cm_thread()-&gt;during_cycle() || _has_aborted) {
1967     // We haven&#39;t started a concurrent cycle or we have already aborted it. No need to do anything.
1968     return;
1969   }
1970 
1971   // Clear all marks in the next bitmap for the next marking cycle. This will allow us to skip the next
1972   // concurrent bitmap clearing.
1973   {
1974     GCTraceTime(Debug, gc) debug(&quot;Clear Next Bitmap&quot;);
1975     clear_bitmap(_next_mark_bitmap, _g1h-&gt;workers(), false);
1976   }
1977   // Note we cannot clear the previous marking bitmap here
1978   // since VerifyDuringGC verifies the objects marked during
1979   // a full GC against the previous bitmap.
1980 
1981   // Empty mark stack
1982   reset_marking_for_restart();
1983   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
1984     _tasks[i]-&gt;clear_region_fields();
1985   }
1986   _first_overflow_barrier_sync.abort();
1987   _second_overflow_barrier_sync.abort();
1988   _has_aborted = true;
1989 
1990   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1991   satb_mq_set.abandon_partial_marking();
1992   // This can be called either during or outside marking, we&#39;ll read
1993   // the expected_active value from the SATB queue set.
1994   satb_mq_set.set_active_all_threads(
1995                                  false, /* new active value */
1996                                  satb_mq_set.is_active() /* expected_active */);
1997 }
1998 
1999 static void print_ms_time_info(const char* prefix, const char* name,
2000                                NumberSeq&amp; ns) {
2001   log_trace(gc, marking)(&quot;%s%5d %12s: total time = %8.2f s (avg = %8.2f ms).&quot;,
2002                          prefix, ns.num(), name, ns.sum()/1000.0, ns.avg());
2003   if (ns.num() &gt; 0) {
2004     log_trace(gc, marking)(&quot;%s         [std. dev = %8.2f ms, max = %8.2f ms]&quot;,
2005                            prefix, ns.sd(), ns.maximum());
2006   }
2007 }
2008 
2009 void G1ConcurrentMark::print_summary_info() {
2010   Log(gc, marking) log;
2011   if (!log.is_trace()) {
2012     return;
2013   }
2014 
2015   log.trace(&quot; Concurrent marking:&quot;);
2016   print_ms_time_info(&quot;  &quot;, &quot;init marks&quot;, _init_times);
2017   print_ms_time_info(&quot;  &quot;, &quot;remarks&quot;, _remark_times);
2018   {
2019     print_ms_time_info(&quot;     &quot;, &quot;final marks&quot;, _remark_mark_times);
2020     print_ms_time_info(&quot;     &quot;, &quot;weak refs&quot;, _remark_weak_ref_times);
2021 
2022   }
2023   print_ms_time_info(&quot;  &quot;, &quot;cleanups&quot;, _cleanup_times);
2024   log.trace(&quot;    Finalize live data total time = %8.2f s (avg = %8.2f ms).&quot;,
2025             _total_cleanup_time, (_cleanup_times.num() &gt; 0 ? _total_cleanup_time * 1000.0 / (double)_cleanup_times.num() : 0.0));
2026   log.trace(&quot;  Total stop_world time = %8.2f s.&quot;,
2027             (_init_times.sum() + _remark_times.sum() + _cleanup_times.sum())/1000.0);
2028   log.trace(&quot;  Total concurrent time = %8.2f s (%8.2f s marking).&quot;,
2029             cm_thread()-&gt;vtime_accum(), cm_thread()-&gt;vtime_mark_accum());
2030 }
2031 
2032 void G1ConcurrentMark::threads_do(ThreadClosure* tc) const {
2033   _concurrent_workers-&gt;threads_do(tc);
2034 }
2035 
2036 void G1ConcurrentMark::print_on_error(outputStream* st) const {
2037   st-&gt;print_cr(&quot;Marking Bits (Prev, Next): (CMBitMap*) &quot; PTR_FORMAT &quot;, (CMBitMap*) &quot; PTR_FORMAT,
2038                p2i(_prev_mark_bitmap), p2i(_next_mark_bitmap));
2039   _prev_mark_bitmap-&gt;print_on_error(st, &quot; Prev Bits: &quot;);
2040   _next_mark_bitmap-&gt;print_on_error(st, &quot; Next Bits: &quot;);
2041 }
2042 
2043 static ReferenceProcessor* get_cm_oop_closure_ref_processor(G1CollectedHeap* g1h) {
2044   ReferenceProcessor* result = g1h-&gt;ref_processor_cm();
2045   assert(result != NULL, &quot;CM reference processor should not be NULL&quot;);
2046   return result;
2047 }
2048 
2049 G1CMOopClosure::G1CMOopClosure(G1CollectedHeap* g1h,
2050                                G1CMTask* task)
2051   : MetadataVisitingOopIterateClosure(get_cm_oop_closure_ref_processor(g1h)),
2052     _g1h(g1h), _task(task)
2053 { }
2054 
2055 void G1CMTask::setup_for_region(HeapRegion* hr) {
2056   assert(hr != NULL,
2057         &quot;claim_region() should have filtered out NULL regions&quot;);
2058   _curr_region  = hr;
2059   _finger       = hr-&gt;bottom();
2060   update_region_limit();
2061 }
2062 
2063 void G1CMTask::update_region_limit() {
2064   HeapRegion* hr            = _curr_region;
2065   HeapWord* bottom          = hr-&gt;bottom();
2066   HeapWord* limit           = hr-&gt;next_top_at_mark_start();
2067 
2068   if (limit == bottom) {
2069     // The region was collected underneath our feet.
2070     // We set the finger to bottom to ensure that the bitmap
2071     // iteration that will follow this will not do anything.
2072     // (this is not a condition that holds when we set the region up,
2073     // as the region is not supposed to be empty in the first place)
2074     _finger = bottom;
2075   } else if (limit &gt;= _region_limit) {
2076     assert(limit &gt;= _finger, &quot;peace of mind&quot;);
2077   } else {
2078     assert(limit &lt; _region_limit, &quot;only way to get here&quot;);
2079     // This can happen under some pretty unusual circumstances.  An
2080     // evacuation pause empties the region underneath our feet (NTAMS
2081     // at bottom). We then do some allocation in the region (NTAMS
2082     // stays at bottom), followed by the region being used as a GC
2083     // alloc region (NTAMS will move to top() and the objects
2084     // originally below it will be grayed). All objects now marked in
2085     // the region are explicitly grayed, if below the global finger,
2086     // and we do not need in fact to scan anything else. So, we simply
2087     // set _finger to be limit to ensure that the bitmap iteration
2088     // doesn&#39;t do anything.
2089     _finger = limit;
2090   }
2091 
2092   _region_limit = limit;
2093 }
2094 
2095 void G1CMTask::giveup_current_region() {
2096   assert(_curr_region != NULL, &quot;invariant&quot;);
2097   clear_region_fields();
2098 }
2099 
2100 void G1CMTask::clear_region_fields() {
2101   // Values for these three fields that indicate that we&#39;re not
2102   // holding on to a region.
2103   _curr_region   = NULL;
2104   _finger        = NULL;
2105   _region_limit  = NULL;
2106 }
2107 
2108 void G1CMTask::set_cm_oop_closure(G1CMOopClosure* cm_oop_closure) {
2109   if (cm_oop_closure == NULL) {
2110     assert(_cm_oop_closure != NULL, &quot;invariant&quot;);
2111   } else {
2112     assert(_cm_oop_closure == NULL, &quot;invariant&quot;);
2113   }
2114   _cm_oop_closure = cm_oop_closure;
2115 }
2116 
2117 void G1CMTask::reset(G1CMBitMap* next_mark_bitmap) {
2118   guarantee(next_mark_bitmap != NULL, &quot;invariant&quot;);
2119   _next_mark_bitmap              = next_mark_bitmap;
2120   clear_region_fields();
2121 
2122   _calls                         = 0;
2123   _elapsed_time_ms               = 0.0;
2124   _termination_time_ms           = 0.0;
2125   _termination_start_time_ms     = 0.0;
2126 
2127   _mark_stats_cache.reset();
2128 }
2129 
2130 bool G1CMTask::should_exit_termination() {
2131   if (!regular_clock_call()) {
2132     return true;
2133   }
2134 
2135   // This is called when we are in the termination protocol. We should
2136   // quit if, for some reason, this task wants to abort or the global
2137   // stack is not empty (this means that we can get work from it).
2138   return !_cm-&gt;mark_stack_empty() || has_aborted();
2139 }
2140 
2141 void G1CMTask::reached_limit() {
2142   assert(_words_scanned &gt;= _words_scanned_limit ||
2143          _refs_reached &gt;= _refs_reached_limit ,
2144          &quot;shouldn&#39;t have been called otherwise&quot;);
2145   abort_marking_if_regular_check_fail();
2146 }
2147 
2148 bool G1CMTask::regular_clock_call() {
2149   if (has_aborted()) {
2150     return false;
2151   }
2152 
2153   // First, we need to recalculate the words scanned and refs reached
2154   // limits for the next clock call.
2155   recalculate_limits();
2156 
2157   // During the regular clock call we do the following
2158 
2159   // (1) If an overflow has been flagged, then we abort.
2160   if (_cm-&gt;has_overflown()) {
2161     return false;
2162   }
2163 
2164   // If we are not concurrent (i.e. we&#39;re doing remark) we don&#39;t need
2165   // to check anything else. The other steps are only needed during
2166   // the concurrent marking phase.
2167   if (!_cm-&gt;concurrent()) {
2168     return true;
2169   }
2170 
2171   // (2) If marking has been aborted for Full GC, then we also abort.
2172   if (_cm-&gt;has_aborted()) {
2173     return false;
2174   }
2175 
2176   double curr_time_ms = os::elapsedVTime() * 1000.0;
2177 
2178   // (4) We check whether we should yield. If we have to, then we abort.
2179   if (SuspendibleThreadSet::should_yield()) {
2180     // We should yield. To do this we abort the task. The caller is
2181     // responsible for yielding.
2182     return false;
2183   }
2184 
2185   // (5) We check whether we&#39;ve reached our time quota. If we have,
2186   // then we abort.
2187   double elapsed_time_ms = curr_time_ms - _start_time_ms;
2188   if (elapsed_time_ms &gt; _time_target_ms) {
2189     _has_timed_out = true;
2190     return false;
2191   }
2192 
2193   // (6) Finally, we check whether there are enough completed STAB
2194   // buffers available for processing. If there are, we abort.
2195   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2196   if (!_draining_satb_buffers &amp;&amp; satb_mq_set.process_completed_buffers()) {
2197     // we do need to process SATB buffers, we&#39;ll abort and restart
2198     // the marking task to do so
2199     return false;
2200   }
2201   return true;
2202 }
2203 
2204 void G1CMTask::recalculate_limits() {
2205   _real_words_scanned_limit = _words_scanned + words_scanned_period;
2206   _words_scanned_limit      = _real_words_scanned_limit;
2207 
2208   _real_refs_reached_limit  = _refs_reached  + refs_reached_period;
2209   _refs_reached_limit       = _real_refs_reached_limit;
2210 }
2211 
2212 void G1CMTask::decrease_limits() {
2213   // This is called when we believe that we&#39;re going to do an infrequent
2214   // operation which will increase the per byte scanned cost (i.e. move
2215   // entries to/from the global stack). It basically tries to decrease the
2216   // scanning limit so that the clock is called earlier.
2217 
2218   _words_scanned_limit = _real_words_scanned_limit - 3 * words_scanned_period / 4;
2219   _refs_reached_limit  = _real_refs_reached_limit - 3 * refs_reached_period / 4;
2220 }
2221 
2222 void G1CMTask::move_entries_to_global_stack() {
2223   // Local array where we&#39;ll store the entries that will be popped
2224   // from the local queue.
2225   G1TaskQueueEntry buffer[G1CMMarkStack::EntriesPerChunk];
2226 
2227   size_t n = 0;
2228   G1TaskQueueEntry task_entry;
2229   while (n &lt; G1CMMarkStack::EntriesPerChunk &amp;&amp; _task_queue-&gt;pop_local(task_entry)) {
2230     buffer[n] = task_entry;
2231     ++n;
2232   }
2233   if (n &lt; G1CMMarkStack::EntriesPerChunk) {
2234     buffer[n] = G1TaskQueueEntry();
2235   }
2236 
2237   if (n &gt; 0) {
2238     if (!_cm-&gt;mark_stack_push(buffer)) {
2239       set_has_aborted();
2240     }
2241   }
2242 
2243   // This operation was quite expensive, so decrease the limits.
2244   decrease_limits();
2245 }
2246 
2247 bool G1CMTask::get_entries_from_global_stack() {
2248   // Local array where we&#39;ll store the entries that will be popped
2249   // from the global stack.
2250   G1TaskQueueEntry buffer[G1CMMarkStack::EntriesPerChunk];
2251 
2252   if (!_cm-&gt;mark_stack_pop(buffer)) {
2253     return false;
2254   }
2255 
2256   // We did actually pop at least one entry.
2257   for (size_t i = 0; i &lt; G1CMMarkStack::EntriesPerChunk; ++i) {
2258     G1TaskQueueEntry task_entry = buffer[i];
2259     if (task_entry.is_null()) {
2260       break;
2261     }
2262     assert(task_entry.is_array_slice() || oopDesc::is_oop(task_entry.obj()), &quot;Element &quot; PTR_FORMAT &quot; must be an array slice or oop&quot;, p2i(task_entry.obj()));
2263     bool success = _task_queue-&gt;push(task_entry);
2264     // We only call this when the local queue is empty or under a
2265     // given target limit. So, we do not expect this push to fail.
2266     assert(success, &quot;invariant&quot;);
2267   }
2268 
2269   // This operation was quite expensive, so decrease the limits
2270   decrease_limits();
2271   return true;
2272 }
2273 
2274 void G1CMTask::drain_local_queue(bool partially) {
2275   if (has_aborted()) {
2276     return;
2277   }
2278 
2279   // Decide what the target size is, depending whether we&#39;re going to
2280   // drain it partially (so that other tasks can steal if they run out
2281   // of things to do) or totally (at the very end).
2282   size_t target_size;
2283   if (partially) {
2284     target_size = MIN2((size_t)_task_queue-&gt;max_elems()/3, (size_t)GCDrainStackTargetSize);
2285   } else {
2286     target_size = 0;
2287   }
2288 
2289   if (_task_queue-&gt;size() &gt; target_size) {
2290     G1TaskQueueEntry entry;
2291     bool ret = _task_queue-&gt;pop_local(entry);
2292     while (ret) {
2293       scan_task_entry(entry);
2294       if (_task_queue-&gt;size() &lt;= target_size || has_aborted()) {
2295         ret = false;
2296       } else {
2297         ret = _task_queue-&gt;pop_local(entry);
2298       }
2299     }
2300   }
2301 }
2302 
2303 void G1CMTask::drain_global_stack(bool partially) {
2304   if (has_aborted()) {
2305     return;
2306   }
2307 
2308   // We have a policy to drain the local queue before we attempt to
2309   // drain the global stack.
2310   assert(partially || _task_queue-&gt;size() == 0, &quot;invariant&quot;);
2311 
2312   // Decide what the target size is, depending whether we&#39;re going to
2313   // drain it partially (so that other tasks can steal if they run out
2314   // of things to do) or totally (at the very end).
2315   // Notice that when draining the global mark stack partially, due to the racyness
2316   // of the mark stack size update we might in fact drop below the target. But,
2317   // this is not a problem.
2318   // In case of total draining, we simply process until the global mark stack is
2319   // totally empty, disregarding the size counter.
2320   if (partially) {
2321     size_t const target_size = _cm-&gt;partial_mark_stack_size_target();
2322     while (!has_aborted() &amp;&amp; _cm-&gt;mark_stack_size() &gt; target_size) {
2323       if (get_entries_from_global_stack()) {
2324         drain_local_queue(partially);
2325       }
2326     }
2327   } else {
2328     while (!has_aborted() &amp;&amp; get_entries_from_global_stack()) {
2329       drain_local_queue(partially);
2330     }
2331   }
2332 }
2333 
2334 // SATB Queue has several assumptions on whether to call the par or
2335 // non-par versions of the methods. this is why some of the code is
2336 // replicated. We should really get rid of the single-threaded version
2337 // of the code to simplify things.
2338 void G1CMTask::drain_satb_buffers() {
2339   if (has_aborted()) {
2340     return;
2341   }
2342 
2343   // We set this so that the regular clock knows that we&#39;re in the
2344   // middle of draining buffers and doesn&#39;t set the abort flag when it
2345   // notices that SATB buffers are available for draining. It&#39;d be
2346   // very counter productive if it did that. :-)
2347   _draining_satb_buffers = true;
2348 
2349   G1CMSATBBufferClosure satb_cl(this, _g1h);
2350   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2351 
2352   // This keeps claiming and applying the closure to completed buffers
2353   // until we run out of buffers or we need to abort.
2354   while (!has_aborted() &amp;&amp;
2355          satb_mq_set.apply_closure_to_completed_buffer(&amp;satb_cl)) {
2356     abort_marking_if_regular_check_fail();
2357   }
2358 
2359   // Can&#39;t assert qset is empty here, even if not aborted.  If concurrent,
2360   // some other thread might be adding to the queue.  If not concurrent,
2361   // some other thread might have won the race for the last buffer, but
2362   // has not yet decremented the count.
2363 
2364   _draining_satb_buffers = false;
2365 
2366   // again, this was a potentially expensive operation, decrease the
2367   // limits to get the regular clock call early
2368   decrease_limits();
2369 }
2370 
2371 void G1CMTask::clear_mark_stats_cache(uint region_idx) {
2372   _mark_stats_cache.reset(region_idx);
2373 }
2374 
2375 Pair&lt;size_t, size_t&gt; G1CMTask::flush_mark_stats_cache() {
2376   return _mark_stats_cache.evict_all();
2377 }
2378 
2379 void G1CMTask::print_stats() {
2380   log_debug(gc, stats)(&quot;Marking Stats, task = %u, calls = %u&quot;, _worker_id, _calls);
2381   log_debug(gc, stats)(&quot;  Elapsed time = %1.2lfms, Termination time = %1.2lfms&quot;,
2382                        _elapsed_time_ms, _termination_time_ms);
2383   log_debug(gc, stats)(&quot;  Step Times (cum): num = %d, avg = %1.2lfms, sd = %1.2lfms max = %1.2lfms, total = %1.2lfms&quot;,
2384                        _step_times_ms.num(),
2385                        _step_times_ms.avg(),
2386                        _step_times_ms.sd(),
2387                        _step_times_ms.maximum(),
2388                        _step_times_ms.sum());
2389   size_t const hits = _mark_stats_cache.hits();
2390   size_t const misses = _mark_stats_cache.misses();
2391   log_debug(gc, stats)(&quot;  Mark Stats Cache: hits &quot; SIZE_FORMAT &quot; misses &quot; SIZE_FORMAT &quot; ratio %.3f&quot;,
2392                        hits, misses, percent_of(hits, hits + misses));
2393 }
2394 
2395 bool G1ConcurrentMark::try_stealing(uint worker_id, G1TaskQueueEntry&amp; task_entry) {
2396   return _task_queues-&gt;steal(worker_id, task_entry);
2397 }
2398 
2399 /*****************************************************************************
2400 
2401     The do_marking_step(time_target_ms, ...) method is the building
2402     block of the parallel marking framework. It can be called in parallel
2403     with other invocations of do_marking_step() on different tasks
2404     (but only one per task, obviously) and concurrently with the
2405     mutator threads, or during remark, hence it eliminates the need
2406     for two versions of the code. When called during remark, it will
2407     pick up from where the task left off during the concurrent marking
2408     phase. Interestingly, tasks are also claimable during evacuation
2409     pauses too, since do_marking_step() ensures that it aborts before
2410     it needs to yield.
2411 
2412     The data structures that it uses to do marking work are the
2413     following:
2414 
2415       (1) Marking Bitmap. If there are gray objects that appear only
2416       on the bitmap (this happens either when dealing with an overflow
2417       or when the concurrent start pause has simply marked the roots
2418       and didn&#39;t push them on the stack), then tasks claim heap
2419       regions whose bitmap they then scan to find gray objects. A
2420       global finger indicates where the end of the last claimed region
2421       is. A local finger indicates how far into the region a task has
2422       scanned. The two fingers are used to determine how to gray an
2423       object (i.e. whether simply marking it is OK, as it will be
2424       visited by a task in the future, or whether it needs to be also
2425       pushed on a stack).
2426 
2427       (2) Local Queue. The local queue of the task which is accessed
2428       reasonably efficiently by the task. Other tasks can steal from
2429       it when they run out of work. Throughout the marking phase, a
2430       task attempts to keep its local queue short but not totally
2431       empty, so that entries are available for stealing by other
2432       tasks. Only when there is no more work, a task will totally
2433       drain its local queue.
2434 
2435       (3) Global Mark Stack. This handles local queue overflow. During
2436       marking only sets of entries are moved between it and the local
2437       queues, as access to it requires a mutex and more fine-grain
2438       interaction with it which might cause contention. If it
2439       overflows, then the marking phase should restart and iterate
2440       over the bitmap to identify gray objects. Throughout the marking
2441       phase, tasks attempt to keep the global mark stack at a small
2442       length but not totally empty, so that entries are available for
2443       popping by other tasks. Only when there is no more work, tasks
2444       will totally drain the global mark stack.
2445 
2446       (4) SATB Buffer Queue. This is where completed SATB buffers are
2447       made available. Buffers are regularly removed from this queue
2448       and scanned for roots, so that the queue doesn&#39;t get too
2449       long. During remark, all completed buffers are processed, as
2450       well as the filled in parts of any uncompleted buffers.
2451 
2452     The do_marking_step() method tries to abort when the time target
2453     has been reached. There are a few other cases when the
2454     do_marking_step() method also aborts:
2455 
2456       (1) When the marking phase has been aborted (after a Full GC).
2457 
2458       (2) When a global overflow (on the global stack) has been
2459       triggered. Before the task aborts, it will actually sync up with
2460       the other tasks to ensure that all the marking data structures
2461       (local queues, stacks, fingers etc.)  are re-initialized so that
2462       when do_marking_step() completes, the marking phase can
2463       immediately restart.
2464 
2465       (3) When enough completed SATB buffers are available. The
2466       do_marking_step() method only tries to drain SATB buffers right
2467       at the beginning. So, if enough buffers are available, the
2468       marking step aborts and the SATB buffers are processed at
2469       the beginning of the next invocation.
2470 
2471       (4) To yield. when we have to yield then we abort and yield
2472       right at the end of do_marking_step(). This saves us from a lot
2473       of hassle as, by yielding we might allow a Full GC. If this
2474       happens then objects will be compacted underneath our feet, the
2475       heap might shrink, etc. We save checking for this by just
2476       aborting and doing the yield right at the end.
2477 
2478     From the above it follows that the do_marking_step() method should
2479     be called in a loop (or, otherwise, regularly) until it completes.
2480 
2481     If a marking step completes without its has_aborted() flag being
2482     true, it means it has completed the current marking phase (and
2483     also all other marking tasks have done so and have all synced up).
2484 
2485     A method called regular_clock_call() is invoked &quot;regularly&quot; (in
2486     sub ms intervals) throughout marking. It is this clock method that
2487     checks all the abort conditions which were mentioned above and
2488     decides when the task should abort. A work-based scheme is used to
2489     trigger this clock method: when the number of object words the
2490     marking phase has scanned or the number of references the marking
2491     phase has visited reach a given limit. Additional invocations to
2492     the method clock have been planted in a few other strategic places
2493     too. The initial reason for the clock method was to avoid calling
2494     vtime too regularly, as it is quite expensive. So, once it was in
2495     place, it was natural to piggy-back all the other conditions on it
2496     too and not constantly check them throughout the code.
2497 
2498     If do_termination is true then do_marking_step will enter its
2499     termination protocol.
2500 
2501     The value of is_serial must be true when do_marking_step is being
2502     called serially (i.e. by the VMThread) and do_marking_step should
2503     skip any synchronization in the termination and overflow code.
2504     Examples include the serial remark code and the serial reference
2505     processing closures.
2506 
2507     The value of is_serial must be false when do_marking_step is
2508     being called by any of the worker threads in a work gang.
2509     Examples include the concurrent marking code (CMMarkingTask),
2510     the MT remark code, and the MT reference processing closures.
2511 
2512  *****************************************************************************/
2513 
2514 void G1CMTask::do_marking_step(double time_target_ms,
2515                                bool do_termination,
2516                                bool is_serial) {
2517   assert(time_target_ms &gt;= 1.0, &quot;minimum granularity is 1ms&quot;);
2518 
2519   _start_time_ms = os::elapsedVTime() * 1000.0;
2520 
2521   // If do_stealing is true then do_marking_step will attempt to
2522   // steal work from the other G1CMTasks. It only makes sense to
2523   // enable stealing when the termination protocol is enabled
2524   // and do_marking_step() is not being called serially.
2525   bool do_stealing = do_termination &amp;&amp; !is_serial;
2526 
2527   G1Predictions const&amp; predictor = _g1h-&gt;policy()-&gt;predictor();
2528   double diff_prediction_ms = predictor.predict_zero_bounded(&amp;_marking_step_diff_ms);
2529   _time_target_ms = time_target_ms - diff_prediction_ms;
2530 
2531   // set up the variables that are used in the work-based scheme to
2532   // call the regular clock method
2533   _words_scanned = 0;
2534   _refs_reached  = 0;
2535   recalculate_limits();
2536 
2537   // clear all flags
2538   clear_has_aborted();
2539   _has_timed_out = false;
2540   _draining_satb_buffers = false;
2541 
2542   ++_calls;
2543 
2544   // Set up the bitmap and oop closures. Anything that uses them is
2545   // eventually called from this method, so it is OK to allocate these
2546   // statically.
2547   G1CMBitMapClosure bitmap_closure(this, _cm);
2548   G1CMOopClosure cm_oop_closure(_g1h, this);
2549   set_cm_oop_closure(&amp;cm_oop_closure);
2550 
2551   if (_cm-&gt;has_overflown()) {
2552     // This can happen if the mark stack overflows during a GC pause
2553     // and this task, after a yield point, restarts. We have to abort
2554     // as we need to get into the overflow protocol which happens
2555     // right at the end of this task.
2556     set_has_aborted();
2557   }
2558 
2559   // First drain any available SATB buffers. After this, we will not
2560   // look at SATB buffers before the next invocation of this method.
2561   // If enough completed SATB buffers are queued up, the regular clock
2562   // will abort this task so that it restarts.
2563   drain_satb_buffers();
2564   // ...then partially drain the local queue and the global stack
2565   drain_local_queue(true);
2566   drain_global_stack(true);
2567 
2568   do {
2569     if (!has_aborted() &amp;&amp; _curr_region != NULL) {
2570       // This means that we&#39;re already holding on to a region.
2571       assert(_finger != NULL, &quot;if region is not NULL, then the finger &quot;
2572              &quot;should not be NULL either&quot;);
2573 
2574       // We might have restarted this task after an evacuation pause
2575       // which might have evacuated the region we&#39;re holding on to
2576       // underneath our feet. Let&#39;s read its limit again to make sure
2577       // that we do not iterate over a region of the heap that
2578       // contains garbage (update_region_limit() will also move
2579       // _finger to the start of the region if it is found empty).
2580       update_region_limit();
2581       // We will start from _finger not from the start of the region,
2582       // as we might be restarting this task after aborting half-way
2583       // through scanning this region. In this case, _finger points to
2584       // the address where we last found a marked object. If this is a
2585       // fresh region, _finger points to start().
2586       MemRegion mr = MemRegion(_finger, _region_limit);
2587 
2588       assert(!_curr_region-&gt;is_humongous() || mr.start() == _curr_region-&gt;bottom(),
2589              &quot;humongous regions should go around loop once only&quot;);
2590 
2591       // Some special cases:
2592       // If the memory region is empty, we can just give up the region.
2593       // If the current region is humongous then we only need to check
2594       // the bitmap for the bit associated with the start of the object,
2595       // scan the object if it&#39;s live, and give up the region.
2596       // Otherwise, let&#39;s iterate over the bitmap of the part of the region
2597       // that is left.
2598       // If the iteration is successful, give up the region.
2599       if (mr.is_empty()) {
2600         giveup_current_region();
2601         abort_marking_if_regular_check_fail();
2602       } else if (_curr_region-&gt;is_humongous() &amp;&amp; mr.start() == _curr_region-&gt;bottom()) {
2603         if (_next_mark_bitmap-&gt;is_marked(mr.start())) {
2604           // The object is marked - apply the closure
2605           bitmap_closure.do_addr(mr.start());
2606         }
2607         // Even if this task aborted while scanning the humongous object
2608         // we can (and should) give up the current region.
2609         giveup_current_region();
2610         abort_marking_if_regular_check_fail();
2611       } else if (_next_mark_bitmap-&gt;iterate(&amp;bitmap_closure, mr)) {
2612         giveup_current_region();
2613         abort_marking_if_regular_check_fail();
2614       } else {
2615         assert(has_aborted(), &quot;currently the only way to do so&quot;);
2616         // The only way to abort the bitmap iteration is to return
2617         // false from the do_bit() method. However, inside the
2618         // do_bit() method we move the _finger to point to the
2619         // object currently being looked at. So, if we bail out, we
2620         // have definitely set _finger to something non-null.
2621         assert(_finger != NULL, &quot;invariant&quot;);
2622 
2623         // Region iteration was actually aborted. So now _finger
2624         // points to the address of the object we last scanned. If we
2625         // leave it there, when we restart this task, we will rescan
2626         // the object. It is easy to avoid this. We move the finger by
2627         // enough to point to the next possible object header.
2628         assert(_finger &lt; _region_limit, &quot;invariant&quot;);
2629         HeapWord* const new_finger = _finger + ((oop)_finger)-&gt;size();
2630         // Check if bitmap iteration was aborted while scanning the last object
2631         if (new_finger &gt;= _region_limit) {
2632           giveup_current_region();
2633         } else {
2634           move_finger_to(new_finger);
2635         }
2636       }
2637     }
2638     // At this point we have either completed iterating over the
2639     // region we were holding on to, or we have aborted.
2640 
2641     // We then partially drain the local queue and the global stack.
2642     // (Do we really need this?)
2643     drain_local_queue(true);
2644     drain_global_stack(true);
2645 
2646     // Read the note on the claim_region() method on why it might
2647     // return NULL with potentially more regions available for
2648     // claiming and why we have to check out_of_regions() to determine
2649     // whether we&#39;re done or not.
2650     while (!has_aborted() &amp;&amp; _curr_region == NULL &amp;&amp; !_cm-&gt;out_of_regions()) {
2651       // We are going to try to claim a new region. We should have
2652       // given up on the previous one.
2653       // Separated the asserts so that we know which one fires.
2654       assert(_curr_region  == NULL, &quot;invariant&quot;);
2655       assert(_finger       == NULL, &quot;invariant&quot;);
2656       assert(_region_limit == NULL, &quot;invariant&quot;);
2657       HeapRegion* claimed_region = _cm-&gt;claim_region(_worker_id);
2658       if (claimed_region != NULL) {
2659         // Yes, we managed to claim one
2660         setup_for_region(claimed_region);
2661         assert(_curr_region == claimed_region, &quot;invariant&quot;);
2662       }
2663       // It is important to call the regular clock here. It might take
2664       // a while to claim a region if, for example, we hit a large
2665       // block of empty regions. So we need to call the regular clock
2666       // method once round the loop to make sure it&#39;s called
2667       // frequently enough.
2668       abort_marking_if_regular_check_fail();
2669     }
2670 
2671     if (!has_aborted() &amp;&amp; _curr_region == NULL) {
2672       assert(_cm-&gt;out_of_regions(),
2673              &quot;at this point we should be out of regions&quot;);
2674     }
2675   } while ( _curr_region != NULL &amp;&amp; !has_aborted());
2676 
2677   if (!has_aborted()) {
2678     // We cannot check whether the global stack is empty, since other
2679     // tasks might be pushing objects to it concurrently.
2680     assert(_cm-&gt;out_of_regions(),
2681            &quot;at this point we should be out of regions&quot;);
2682     // Try to reduce the number of available SATB buffers so that
2683     // remark has less work to do.
2684     drain_satb_buffers();
2685   }
2686 
2687   // Since we&#39;ve done everything else, we can now totally drain the
2688   // local queue and global stack.
2689   drain_local_queue(false);
2690   drain_global_stack(false);
2691 
2692   // Attempt at work stealing from other task&#39;s queues.
2693   if (do_stealing &amp;&amp; !has_aborted()) {
2694     // We have not aborted. This means that we have finished all that
2695     // we could. Let&#39;s try to do some stealing...
2696 
2697     // We cannot check whether the global stack is empty, since other
2698     // tasks might be pushing objects to it concurrently.
2699     assert(_cm-&gt;out_of_regions() &amp;&amp; _task_queue-&gt;size() == 0,
2700            &quot;only way to reach here&quot;);
2701     while (!has_aborted()) {
2702       G1TaskQueueEntry entry;
2703       if (_cm-&gt;try_stealing(_worker_id, entry)) {
2704         scan_task_entry(entry);
2705 
2706         // And since we&#39;re towards the end, let&#39;s totally drain the
2707         // local queue and global stack.
2708         drain_local_queue(false);
2709         drain_global_stack(false);
2710       } else {
2711         break;
2712       }
2713     }
2714   }
2715 
2716   // We still haven&#39;t aborted. Now, let&#39;s try to get into the
2717   // termination protocol.
2718   if (do_termination &amp;&amp; !has_aborted()) {
2719     // We cannot check whether the global stack is empty, since other
2720     // tasks might be concurrently pushing objects on it.
2721     // Separated the asserts so that we know which one fires.
2722     assert(_cm-&gt;out_of_regions(), &quot;only way to reach here&quot;);
2723     assert(_task_queue-&gt;size() == 0, &quot;only way to reach here&quot;);
2724     _termination_start_time_ms = os::elapsedVTime() * 1000.0;
2725 
2726     // The G1CMTask class also extends the TerminatorTerminator class,
2727     // hence its should_exit_termination() method will also decide
2728     // whether to exit the termination protocol or not.
2729     bool finished = (is_serial ||
2730                      _cm-&gt;terminator()-&gt;offer_termination(this));
2731     double termination_end_time_ms = os::elapsedVTime() * 1000.0;
2732     _termination_time_ms +=
2733       termination_end_time_ms - _termination_start_time_ms;
2734 
2735     if (finished) {
2736       // We&#39;re all done.
2737 
2738       // We can now guarantee that the global stack is empty, since
2739       // all other tasks have finished. We separated the guarantees so
2740       // that, if a condition is false, we can immediately find out
2741       // which one.
2742       guarantee(_cm-&gt;out_of_regions(), &quot;only way to reach here&quot;);
2743       guarantee(_cm-&gt;mark_stack_empty(), &quot;only way to reach here&quot;);
2744       guarantee(_task_queue-&gt;size() == 0, &quot;only way to reach here&quot;);
2745       guarantee(!_cm-&gt;has_overflown(), &quot;only way to reach here&quot;);
2746       guarantee(!has_aborted(), &quot;should never happen if termination has completed&quot;);
2747     } else {
2748       // Apparently there&#39;s more work to do. Let&#39;s abort this task. It
2749       // will restart it and we can hopefully find more things to do.
2750       set_has_aborted();
2751     }
2752   }
2753 
2754   // Mainly for debugging purposes to make sure that a pointer to the
2755   // closure which was statically allocated in this frame doesn&#39;t
2756   // escape it by accident.
2757   set_cm_oop_closure(NULL);
2758   double end_time_ms = os::elapsedVTime() * 1000.0;
2759   double elapsed_time_ms = end_time_ms - _start_time_ms;
2760   // Update the step history.
2761   _step_times_ms.add(elapsed_time_ms);
2762 
2763   if (has_aborted()) {
2764     // The task was aborted for some reason.
2765     if (_has_timed_out) {
2766       double diff_ms = elapsed_time_ms - _time_target_ms;
2767       // Keep statistics of how well we did with respect to hitting
2768       // our target only if we actually timed out (if we aborted for
2769       // other reasons, then the results might get skewed).
2770       _marking_step_diff_ms.add(diff_ms);
2771     }
2772 
2773     if (_cm-&gt;has_overflown()) {
2774       // This is the interesting one. We aborted because a global
2775       // overflow was raised. This means we have to restart the
2776       // marking phase and start iterating over regions. However, in
2777       // order to do this we have to make sure that all tasks stop
2778       // what they are doing and re-initialize in a safe manner. We
2779       // will achieve this with the use of two barrier sync points.
2780 
2781       if (!is_serial) {
2782         // We only need to enter the sync barrier if being called
2783         // from a parallel context
2784         _cm-&gt;enter_first_sync_barrier(_worker_id);
2785 
2786         // When we exit this sync barrier we know that all tasks have
2787         // stopped doing marking work. So, it&#39;s now safe to
2788         // re-initialize our data structures.
2789       }
2790 
2791       clear_region_fields();
2792       flush_mark_stats_cache();
2793 
2794       if (!is_serial) {
2795         // If we&#39;re executing the concurrent phase of marking, reset the marking
2796         // state; otherwise the marking state is reset after reference processing,
2797         // during the remark pause.
2798         // If we reset here as a result of an overflow during the remark we will
2799         // see assertion failures from any subsequent set_concurrency_and_phase()
2800         // calls.
2801         if (_cm-&gt;concurrent() &amp;&amp; _worker_id == 0) {
2802           // Worker 0 is responsible for clearing the global data structures because
2803           // of an overflow. During STW we should not clear the overflow flag (in
2804           // G1ConcurrentMark::reset_marking_state()) since we rely on it being true when we exit
2805           // method to abort the pause and restart concurrent marking.
2806           _cm-&gt;reset_marking_for_restart();
2807 
2808           log_info(gc, marking)(&quot;Concurrent Mark reset for overflow&quot;);
2809         }
2810 
2811         // ...and enter the second barrier.
2812         _cm-&gt;enter_second_sync_barrier(_worker_id);
2813       }
2814       // At this point, if we&#39;re during the concurrent phase of
2815       // marking, everything has been re-initialized and we&#39;re
2816       // ready to restart.
2817     }
2818   }
2819 }
2820 
2821 G1CMTask::G1CMTask(uint worker_id,
2822                    G1ConcurrentMark* cm,
2823                    G1CMTaskQueue* task_queue,
2824                    G1RegionMarkStats* mark_stats,
2825                    uint max_regions) :
2826   _objArray_processor(this),
2827   _worker_id(worker_id),
2828   _g1h(G1CollectedHeap::heap()),
2829   _cm(cm),
2830   _next_mark_bitmap(NULL),
2831   _task_queue(task_queue),
2832   _mark_stats_cache(mark_stats, max_regions, RegionMarkStatsCacheSize),
2833   _calls(0),
2834   _time_target_ms(0.0),
2835   _start_time_ms(0.0),
2836   _cm_oop_closure(NULL),
2837   _curr_region(NULL),
2838   _finger(NULL),
2839   _region_limit(NULL),
2840   _words_scanned(0),
2841   _words_scanned_limit(0),
2842   _real_words_scanned_limit(0),
2843   _refs_reached(0),
2844   _refs_reached_limit(0),
2845   _real_refs_reached_limit(0),
2846   _has_aborted(false),
2847   _has_timed_out(false),
2848   _draining_satb_buffers(false),
2849   _step_times_ms(),
2850   _elapsed_time_ms(0.0),
2851   _termination_time_ms(0.0),
2852   _termination_start_time_ms(0.0),
2853   _marking_step_diff_ms()
2854 {
2855   guarantee(task_queue != NULL, &quot;invariant&quot;);
2856 
2857   _marking_step_diff_ms.add(0.5);
2858 }
2859 
2860 // These are formatting macros that are used below to ensure
2861 // consistent formatting. The *_H_* versions are used to format the
2862 // header for a particular value and they should be kept consistent
2863 // with the corresponding macro. Also note that most of the macros add
2864 // the necessary white space (as a prefix) which makes them a bit
2865 // easier to compose.
2866 
2867 // All the output lines are prefixed with this string to be able to
2868 // identify them easily in a large log file.
2869 #define G1PPRL_LINE_PREFIX            &quot;###&quot;
2870 
2871 #define G1PPRL_ADDR_BASE_FORMAT    &quot; &quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT
2872 #ifdef _LP64
2873 #define G1PPRL_ADDR_BASE_H_FORMAT  &quot; %37s&quot;
2874 #else // _LP64
2875 #define G1PPRL_ADDR_BASE_H_FORMAT  &quot; %21s&quot;
2876 #endif // _LP64
2877 
2878 // For per-region info
2879 #define G1PPRL_TYPE_FORMAT            &quot;   %-4s&quot;
2880 #define G1PPRL_TYPE_H_FORMAT          &quot;   %4s&quot;
2881 #define G1PPRL_STATE_FORMAT           &quot;   %-5s&quot;
2882 #define G1PPRL_STATE_H_FORMAT         &quot;   %5s&quot;
2883 #define G1PPRL_BYTE_FORMAT            &quot;  &quot; SIZE_FORMAT_W(9)
2884 #define G1PPRL_BYTE_H_FORMAT          &quot;  %9s&quot;
2885 #define G1PPRL_DOUBLE_FORMAT          &quot;  %14.1f&quot;
2886 #define G1PPRL_DOUBLE_H_FORMAT        &quot;  %14s&quot;
2887 
2888 // For summary info
2889 #define G1PPRL_SUM_ADDR_FORMAT(tag)    &quot;  &quot; tag &quot;:&quot; G1PPRL_ADDR_BASE_FORMAT
2890 #define G1PPRL_SUM_BYTE_FORMAT(tag)    &quot;  &quot; tag &quot;: &quot; SIZE_FORMAT
2891 #define G1PPRL_SUM_MB_FORMAT(tag)      &quot;  &quot; tag &quot;: %1.2f MB&quot;
2892 #define G1PPRL_SUM_MB_PERC_FORMAT(tag) G1PPRL_SUM_MB_FORMAT(tag) &quot; / %1.2f %%&quot;
2893 
2894 G1PrintRegionLivenessInfoClosure::G1PrintRegionLivenessInfoClosure(const char* phase_name) :
2895   _total_used_bytes(0), _total_capacity_bytes(0),
2896   _total_prev_live_bytes(0), _total_next_live_bytes(0),
2897   _total_remset_bytes(0), _total_strong_code_roots_bytes(0)
2898 {
2899   if (!log_is_enabled(Trace, gc, liveness)) {
2900     return;
2901   }
2902 
2903   G1CollectedHeap* g1h = G1CollectedHeap::heap();
2904   MemRegion g1_reserved = g1h-&gt;g1_reserved();
2905   double now = os::elapsedTime();
2906 
2907   // Print the header of the output.
2908   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX&quot; PHASE %s @ %1.3f&quot;, phase_name, now);
2909   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX&quot; HEAP&quot;
2910                           G1PPRL_SUM_ADDR_FORMAT(&quot;reserved&quot;)
2911                           G1PPRL_SUM_BYTE_FORMAT(&quot;region-size&quot;),
2912                           p2i(g1_reserved.start()), p2i(g1_reserved.end()),
2913                           HeapRegion::GrainBytes);
2914   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX);
2915   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2916                           G1PPRL_TYPE_H_FORMAT
2917                           G1PPRL_ADDR_BASE_H_FORMAT
2918                           G1PPRL_BYTE_H_FORMAT
2919                           G1PPRL_BYTE_H_FORMAT
2920                           G1PPRL_BYTE_H_FORMAT
2921                           G1PPRL_DOUBLE_H_FORMAT
2922                           G1PPRL_BYTE_H_FORMAT
2923                           G1PPRL_STATE_H_FORMAT
2924                           G1PPRL_BYTE_H_FORMAT,
2925                           &quot;type&quot;, &quot;address-range&quot;,
2926                           &quot;used&quot;, &quot;prev-live&quot;, &quot;next-live&quot;, &quot;gc-eff&quot;,
2927                           &quot;remset&quot;, &quot;state&quot;, &quot;code-roots&quot;);
2928   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2929                           G1PPRL_TYPE_H_FORMAT
2930                           G1PPRL_ADDR_BASE_H_FORMAT
2931                           G1PPRL_BYTE_H_FORMAT
2932                           G1PPRL_BYTE_H_FORMAT
2933                           G1PPRL_BYTE_H_FORMAT
2934                           G1PPRL_DOUBLE_H_FORMAT
2935                           G1PPRL_BYTE_H_FORMAT
2936                           G1PPRL_STATE_H_FORMAT
2937                           G1PPRL_BYTE_H_FORMAT,
2938                           &quot;&quot;, &quot;&quot;,
2939                           &quot;(bytes)&quot;, &quot;(bytes)&quot;, &quot;(bytes)&quot;, &quot;(bytes/ms)&quot;,
2940                           &quot;(bytes)&quot;, &quot;&quot;, &quot;(bytes)&quot;);
2941 }
2942 
2943 bool G1PrintRegionLivenessInfoClosure::do_heap_region(HeapRegion* r) {
2944   if (!log_is_enabled(Trace, gc, liveness)) {
2945     return false;
2946   }
2947 
2948   const char* type       = r-&gt;get_type_str();
2949   HeapWord* bottom       = r-&gt;bottom();
2950   HeapWord* end          = r-&gt;end();
2951   size_t capacity_bytes  = r-&gt;capacity();
2952   size_t used_bytes      = r-&gt;used();
2953   size_t prev_live_bytes = r-&gt;live_bytes();
2954   size_t next_live_bytes = r-&gt;next_live_bytes();
2955   double gc_eff          = r-&gt;gc_efficiency();
2956   size_t remset_bytes    = r-&gt;rem_set()-&gt;mem_size();
2957   size_t strong_code_roots_bytes = r-&gt;rem_set()-&gt;strong_code_roots_mem_size();
2958   const char* remset_type = r-&gt;rem_set()-&gt;get_short_state_str();
2959 
2960   _total_used_bytes      += used_bytes;
2961   _total_capacity_bytes  += capacity_bytes;
2962   _total_prev_live_bytes += prev_live_bytes;
2963   _total_next_live_bytes += next_live_bytes;
2964   _total_remset_bytes    += remset_bytes;
2965   _total_strong_code_roots_bytes += strong_code_roots_bytes;
2966 
2967   // Print a line for this particular region.
2968   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2969                           G1PPRL_TYPE_FORMAT
2970                           G1PPRL_ADDR_BASE_FORMAT
2971                           G1PPRL_BYTE_FORMAT
2972                           G1PPRL_BYTE_FORMAT
2973                           G1PPRL_BYTE_FORMAT
2974                           G1PPRL_DOUBLE_FORMAT
2975                           G1PPRL_BYTE_FORMAT
2976                           G1PPRL_STATE_FORMAT
2977                           G1PPRL_BYTE_FORMAT,
2978                           type, p2i(bottom), p2i(end),
2979                           used_bytes, prev_live_bytes, next_live_bytes, gc_eff,
2980                           remset_bytes, remset_type, strong_code_roots_bytes);
2981 
2982   return false;
2983 }
2984 
2985 G1PrintRegionLivenessInfoClosure::~G1PrintRegionLivenessInfoClosure() {
2986   if (!log_is_enabled(Trace, gc, liveness)) {
2987     return;
2988   }
2989 
2990   // add static memory usages to remembered set sizes
2991   _total_remset_bytes += HeapRegionRemSet::fl_mem_size() + HeapRegionRemSet::static_mem_size();
2992   // Print the footer of the output.
2993   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX);
2994   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2995                          &quot; SUMMARY&quot;
2996                          G1PPRL_SUM_MB_FORMAT(&quot;capacity&quot;)
2997                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;used&quot;)
2998                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;prev-live&quot;)
2999                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;next-live&quot;)
3000                          G1PPRL_SUM_MB_FORMAT(&quot;remset&quot;)
3001                          G1PPRL_SUM_MB_FORMAT(&quot;code-roots&quot;),
3002                          bytes_to_mb(_total_capacity_bytes),
3003                          bytes_to_mb(_total_used_bytes),
3004                          percent_of(_total_used_bytes, _total_capacity_bytes),
3005                          bytes_to_mb(_total_prev_live_bytes),
3006                          percent_of(_total_prev_live_bytes, _total_capacity_bytes),
3007                          bytes_to_mb(_total_next_live_bytes),
3008                          percent_of(_total_next_live_bytes, _total_capacity_bytes),
3009                          bytes_to_mb(_total_remset_bytes),
3010                          bytes_to_mb(_total_strong_code_roots_bytes));
3011 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>