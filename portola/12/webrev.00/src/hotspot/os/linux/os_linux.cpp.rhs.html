<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os/linux/os_linux.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;oops/oop.inline.hpp&quot;
  40 #include &quot;os_linux.inline.hpp&quot;
  41 #include &quot;os_posix.inline.hpp&quot;
  42 #include &quot;os_share_linux.hpp&quot;
  43 #include &quot;osContainer_linux.hpp&quot;
  44 #include &quot;prims/jniFastGetField.hpp&quot;
  45 #include &quot;prims/jvm_misc.hpp&quot;
  46 #include &quot;runtime/arguments.hpp&quot;
  47 #include &quot;runtime/atomic.hpp&quot;
  48 #include &quot;runtime/globals.hpp&quot;
  49 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  50 #include &quot;runtime/init.hpp&quot;
  51 #include &quot;runtime/java.hpp&quot;
  52 #include &quot;runtime/javaCalls.hpp&quot;
  53 #include &quot;runtime/mutexLocker.hpp&quot;
  54 #include &quot;runtime/objectMonitor.hpp&quot;
  55 #include &quot;runtime/osThread.hpp&quot;
  56 #include &quot;runtime/perfMemory.hpp&quot;
  57 #include &quot;runtime/sharedRuntime.hpp&quot;
  58 #include &quot;runtime/statSampler.hpp&quot;
  59 #include &quot;runtime/stubRoutines.hpp&quot;
  60 #include &quot;runtime/thread.inline.hpp&quot;
  61 #include &quot;runtime/threadCritical.hpp&quot;
  62 #include &quot;runtime/threadSMR.hpp&quot;
  63 #include &quot;runtime/timer.hpp&quot;
  64 #include &quot;runtime/vm_version.hpp&quot;
  65 #include &quot;semaphore_posix.hpp&quot;
  66 #include &quot;services/attachListener.hpp&quot;
  67 #include &quot;services/memTracker.hpp&quot;
  68 #include &quot;services/runtimeService.hpp&quot;
  69 #include &quot;utilities/align.hpp&quot;
  70 #include &quot;utilities/decoder.hpp&quot;
  71 #include &quot;utilities/defaultStream.hpp&quot;
  72 #include &quot;utilities/events.hpp&quot;
  73 #include &quot;utilities/elfFile.hpp&quot;
  74 #include &quot;utilities/growableArray.hpp&quot;
  75 #include &quot;utilities/macros.hpp&quot;
  76 #include &quot;utilities/powerOfTwo.hpp&quot;
  77 #include &quot;utilities/vmError.hpp&quot;
  78 
  79 // put OS-includes here
  80 # include &lt;sys/types.h&gt;
  81 # include &lt;sys/mman.h&gt;
  82 # include &lt;sys/stat.h&gt;
  83 # include &lt;sys/select.h&gt;
  84 # include &lt;pthread.h&gt;
  85 # include &lt;signal.h&gt;
  86 # include &lt;endian.h&gt;
  87 # include &lt;errno.h&gt;
  88 # include &lt;dlfcn.h&gt;
  89 # include &lt;stdio.h&gt;
  90 # include &lt;unistd.h&gt;
  91 # include &lt;sys/resource.h&gt;
  92 # include &lt;pthread.h&gt;
  93 # include &lt;sys/stat.h&gt;
  94 # include &lt;sys/time.h&gt;
  95 # include &lt;sys/times.h&gt;
  96 # include &lt;sys/utsname.h&gt;
  97 # include &lt;sys/socket.h&gt;
  98 # include &lt;sys/wait.h&gt;
  99 # include &lt;pwd.h&gt;
 100 # include &lt;poll.h&gt;
 101 # include &lt;fcntl.h&gt;
 102 # include &lt;string.h&gt;
 103 # include &lt;syscall.h&gt;
 104 # include &lt;sys/sysinfo.h&gt;
 105 # include &lt;sys/ipc.h&gt;
 106 # include &lt;sys/shm.h&gt;
 107 # include &lt;link.h&gt;
 108 # include &lt;stdint.h&gt;
 109 # include &lt;inttypes.h&gt;
 110 # include &lt;sys/ioctl.h&gt;
 111 # include &lt;linux/elf-em.h&gt;
 112 #ifdef __GLIBC__
 113 # include &lt;malloc.h&gt;
 114 #endif
 115 
 116 #ifndef _GNU_SOURCE
 117   #define _GNU_SOURCE
 118   #include &lt;sched.h&gt;
 119   #undef _GNU_SOURCE
 120 #else
 121   #include &lt;sched.h&gt;
 122 #endif
 123 
 124 // if RUSAGE_THREAD for getrusage() has not been defined, do it here. The code calling
 125 // getrusage() is prepared to handle the associated failure.
 126 #ifndef RUSAGE_THREAD
 127   #define RUSAGE_THREAD   (1)               /* only the calling thread */
 128 #endif
 129 
 130 #define MAX_PATH    (2 * K)
 131 
 132 #define MAX_SECS 100000000
 133 
 134 // for timer info max values which include all bits
 135 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 136 
<a name="1" id="anc1"></a><span class="line-added"> 137 #ifdef MUSL_LIBC</span>
<span class="line-added"> 138 // dlvsym is not a part of POSIX</span>
<span class="line-added"> 139 // and musl libc doesn&#39;t implement it.</span>
<span class="line-added"> 140 static void *dlvsym(void *handle,</span>
<span class="line-added"> 141                     const char *symbol,</span>
<span class="line-added"> 142                     const char *version) {</span>
<span class="line-added"> 143    // load the latest version of symbol</span>
<span class="line-added"> 144    return dlsym(handle, symbol);</span>
<span class="line-added"> 145 }</span>
<span class="line-added"> 146 #endif</span>
<span class="line-added"> 147 </span>
 148 enum CoredumpFilterBit {
 149   FILE_BACKED_PVT_BIT = 1 &lt;&lt; 2,
 150   FILE_BACKED_SHARED_BIT = 1 &lt;&lt; 3,
 151   LARGEPAGES_BIT = 1 &lt;&lt; 6,
 152   DAX_SHARED_BIT = 1 &lt;&lt; 8
 153 };
 154 
 155 ////////////////////////////////////////////////////////////////////////////////
 156 // global variables
 157 julong os::Linux::_physical_memory = 0;
 158 
 159 address   os::Linux::_initial_thread_stack_bottom = NULL;
 160 uintptr_t os::Linux::_initial_thread_stack_size   = 0;
 161 
 162 int (*os::Linux::_pthread_getcpuclockid)(pthread_t, clockid_t *) = NULL;
 163 int (*os::Linux::_pthread_setname_np)(pthread_t, const char*) = NULL;
 164 pthread_t os::Linux::_main_thread;
 165 int os::Linux::_page_size = -1;
 166 bool os::Linux::_supports_fast_thread_cpu_time = false;
<a name="2" id="anc2"></a><span class="line-modified"> 167 const char * os::Linux::_libc_version = NULL;</span>
<span class="line-modified"> 168 const char * os::Linux::_libpthread_version = NULL;</span>
 169 size_t os::Linux::_default_large_page_size = 0;
 170 
 171 static jlong initial_time_count=0;
 172 
 173 static int clock_tics_per_sec = 100;
 174 
 175 // If the VM might have been created on the primordial thread, we need to resolve the
 176 // primordial thread stack bounds and check if the current thread might be the
 177 // primordial thread in places. If we know that the primordial thread is never used,
 178 // such as when the VM was created by one of the standard java launchers, we can
 179 // avoid this
 180 static bool suppress_primordial_thread_resolution = false;
 181 
 182 // For diagnostics to print a message once. see run_periodic_checks
 183 static sigset_t check_signal_done;
 184 static bool check_signals = true;
 185 
 186 // Signal number used to suspend/resume a thread
 187 
 188 // do not use any signal number less than SIGSEGV, see 4355769
 189 static int SR_signum = SIGUSR2;
 190 sigset_t SR_sigset;
 191 
 192 // utility functions
 193 
 194 static int SR_initialize();
 195 
 196 julong os::available_memory() {
 197   return Linux::available_memory();
 198 }
 199 
 200 julong os::Linux::available_memory() {
 201   // values in struct sysinfo are &quot;unsigned long&quot;
 202   struct sysinfo si;
 203   julong avail_mem;
 204 
 205   if (OSContainer::is_containerized()) {
 206     jlong mem_limit, mem_usage;
 207     if ((mem_limit = OSContainer::memory_limit_in_bytes()) &lt; 1) {
 208       log_debug(os, container)(&quot;container memory limit %s: &quot; JLONG_FORMAT &quot;, using host value&quot;,
 209                              mem_limit == OSCONTAINER_ERROR ? &quot;failed&quot; : &quot;unlimited&quot;, mem_limit);
 210     }
 211     if (mem_limit &gt; 0 &amp;&amp; (mem_usage = OSContainer::memory_usage_in_bytes()) &lt; 1) {
 212       log_debug(os, container)(&quot;container memory usage failed: &quot; JLONG_FORMAT &quot;, using host value&quot;, mem_usage);
 213     }
 214     if (mem_limit &gt; 0 &amp;&amp; mem_usage &gt; 0 ) {
 215       avail_mem = mem_limit &gt; mem_usage ? (julong)mem_limit - (julong)mem_usage : 0;
 216       log_trace(os)(&quot;available container memory: &quot; JULONG_FORMAT, avail_mem);
 217       return avail_mem;
 218     }
 219   }
 220 
 221   sysinfo(&amp;si);
 222   avail_mem = (julong)si.freeram * si.mem_unit;
 223   log_trace(os)(&quot;available memory: &quot; JULONG_FORMAT, avail_mem);
 224   return avail_mem;
 225 }
 226 
 227 julong os::physical_memory() {
 228   jlong phys_mem = 0;
 229   if (OSContainer::is_containerized()) {
 230     jlong mem_limit;
 231     if ((mem_limit = OSContainer::memory_limit_in_bytes()) &gt; 0) {
 232       log_trace(os)(&quot;total container memory: &quot; JLONG_FORMAT, mem_limit);
 233       return mem_limit;
 234     }
 235     log_debug(os, container)(&quot;container memory limit %s: &quot; JLONG_FORMAT &quot;, using host value&quot;,
 236                             mem_limit == OSCONTAINER_ERROR ? &quot;failed&quot; : &quot;unlimited&quot;, mem_limit);
 237   }
 238 
 239   phys_mem = Linux::physical_memory();
 240   log_trace(os)(&quot;total system memory: &quot; JLONG_FORMAT, phys_mem);
 241   return phys_mem;
 242 }
 243 
 244 static uint64_t initial_total_ticks = 0;
 245 static uint64_t initial_steal_ticks = 0;
 246 static bool     has_initial_tick_info = false;
 247 
 248 static void next_line(FILE *f) {
 249   int c;
 250   do {
 251     c = fgetc(f);
 252   } while (c != &#39;\n&#39; &amp;&amp; c != EOF);
 253 }
 254 
 255 bool os::Linux::get_tick_information(CPUPerfTicks* pticks, int which_logical_cpu) {
 256   FILE*         fh;
 257   uint64_t      userTicks, niceTicks, systemTicks, idleTicks;
 258   // since at least kernel 2.6 : iowait: time waiting for I/O to complete
 259   // irq: time  servicing interrupts; softirq: time servicing softirqs
 260   uint64_t      iowTicks = 0, irqTicks = 0, sirqTicks= 0;
 261   // steal (since kernel 2.6.11): time spent in other OS when running in a virtualized environment
 262   uint64_t      stealTicks = 0;
 263   // guest (since kernel 2.6.24): time spent running a virtual CPU for guest OS under the
 264   // control of the Linux kernel
 265   uint64_t      guestNiceTicks = 0;
 266   int           logical_cpu = -1;
 267   const int     required_tickinfo_count = (which_logical_cpu == -1) ? 4 : 5;
 268   int           n;
 269 
 270   memset(pticks, 0, sizeof(CPUPerfTicks));
 271 
 272   if ((fh = fopen(&quot;/proc/stat&quot;, &quot;r&quot;)) == NULL) {
 273     return false;
 274   }
 275 
 276   if (which_logical_cpu == -1) {
 277     n = fscanf(fh, &quot;cpu &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 278             UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 279             UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;,
 280             &amp;userTicks, &amp;niceTicks, &amp;systemTicks, &amp;idleTicks,
 281             &amp;iowTicks, &amp;irqTicks, &amp;sirqTicks,
 282             &amp;stealTicks, &amp;guestNiceTicks);
 283   } else {
 284     // Move to next line
 285     next_line(fh);
 286 
 287     // find the line for requested cpu faster to just iterate linefeeds?
 288     for (int i = 0; i &lt; which_logical_cpu; i++) {
 289       next_line(fh);
 290     }
 291 
 292     n = fscanf(fh, &quot;cpu%u &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 293                UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;
 294                UINT64_FORMAT &quot; &quot; UINT64_FORMAT &quot; &quot;,
 295                &amp;logical_cpu, &amp;userTicks, &amp;niceTicks,
 296                &amp;systemTicks, &amp;idleTicks, &amp;iowTicks, &amp;irqTicks, &amp;sirqTicks,
 297                &amp;stealTicks, &amp;guestNiceTicks);
 298   }
 299 
 300   fclose(fh);
 301   if (n &lt; required_tickinfo_count || logical_cpu != which_logical_cpu) {
 302     return false;
 303   }
 304   pticks-&gt;used       = userTicks + niceTicks;
 305   pticks-&gt;usedKernel = systemTicks + irqTicks + sirqTicks;
 306   pticks-&gt;total      = userTicks + niceTicks + systemTicks + idleTicks +
 307                        iowTicks + irqTicks + sirqTicks + stealTicks + guestNiceTicks;
 308 
 309   if (n &gt; required_tickinfo_count + 3) {
 310     pticks-&gt;steal = stealTicks;
 311     pticks-&gt;has_steal_ticks = true;
 312   } else {
 313     pticks-&gt;steal = 0;
 314     pticks-&gt;has_steal_ticks = false;
 315   }
 316 
 317   return true;
 318 }
 319 
 320 // Return true if user is running as root.
 321 
 322 bool os::have_special_privileges() {
 323   static bool init = false;
 324   static bool privileges = false;
 325   if (!init) {
 326     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 327     init = true;
 328   }
 329   return privileges;
 330 }
 331 
 332 
 333 #ifndef SYS_gettid
 334 // i386: 224, ia64: 1105, amd64: 186, sparc 143
 335   #ifdef __ia64__
 336     #define SYS_gettid 1105
 337   #else
 338     #ifdef __i386__
 339       #define SYS_gettid 224
 340     #else
 341       #ifdef __amd64__
 342         #define SYS_gettid 186
 343       #else
 344         #ifdef __sparc__
 345           #define SYS_gettid 143
 346         #else
 347           #error define gettid for the arch
 348         #endif
 349       #endif
 350     #endif
 351   #endif
 352 #endif
 353 
 354 
 355 // pid_t gettid()
 356 //
 357 // Returns the kernel thread id of the currently running thread. Kernel
 358 // thread id is used to access /proc.
 359 pid_t os::Linux::gettid() {
 360   int rslt = syscall(SYS_gettid);
 361   assert(rslt != -1, &quot;must be.&quot;); // old linuxthreads implementation?
 362   return (pid_t)rslt;
 363 }
 364 
 365 // Most versions of linux have a bug where the number of processors are
 366 // determined by looking at the /proc file system.  In a chroot environment,
 367 // the system call returns 1.
 368 static bool unsafe_chroot_detected = false;
 369 static const char *unstable_chroot_error = &quot;/proc file system not found.\n&quot;
 370                      &quot;Java may be unstable running multithreaded in a chroot &quot;
 371                      &quot;environment on Linux when /proc filesystem is not mounted.&quot;;
 372 
 373 void os::Linux::initialize_system_info() {
 374   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 375   if (processor_count() == 1) {
 376     pid_t pid = os::Linux::gettid();
 377     char fname[32];
 378     jio_snprintf(fname, sizeof(fname), &quot;/proc/%d&quot;, pid);
 379     FILE *fp = fopen(fname, &quot;r&quot;);
 380     if (fp == NULL) {
 381       unsafe_chroot_detected = true;
 382     } else {
 383       fclose(fp);
 384     }
 385   }
 386   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) * (julong)sysconf(_SC_PAGESIZE);
 387   assert(processor_count() &gt; 0, &quot;linux error&quot;);
 388 }
 389 
 390 void os::init_system_properties_values() {
 391   // The next steps are taken in the product version:
 392   //
 393   // Obtain the JAVA_HOME value from the location of libjvm.so.
 394   // This library should be located at:
 395   // &lt;JAVA_HOME&gt;/lib/{client|server}/libjvm.so.
 396   //
 397   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 398   // assume libjvm.so is installed in a JDK and we use this path.
 399   //
 400   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 401   //
 402   // The following extra steps are taken in the debugging version:
 403   //
 404   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 405   // instead of exit check for $JAVA_HOME environment variable.
 406   //
 407   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 408   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 409   // it looks like libjvm.so is installed there
 410   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 411   //
 412   // Otherwise exit.
 413   //
 414   // Important note: if the location of libjvm.so changes this
 415   // code needs to be changed accordingly.
 416 
 417   // See ld(1):
 418   //      The linker uses the following search paths to locate required
 419   //      shared libraries:
 420   //        1: ...
 421   //        ...
 422   //        7: The default directories, normally /lib and /usr/lib.
 423 #ifndef OVERRIDE_LIBPATH
 424   #if defined(AMD64) || (defined(_LP64) &amp;&amp; defined(SPARC)) || defined(PPC64) || defined(S390)
 425     #define DEFAULT_LIBPATH &quot;/usr/lib64:/lib64:/lib:/usr/lib&quot;
 426   #else
 427     #define DEFAULT_LIBPATH &quot;/lib:/usr/lib&quot;
 428   #endif
 429 #else
 430   #define DEFAULT_LIBPATH OVERRIDE_LIBPATH
 431 #endif
 432 
 433 // Base path of extensions installed on the system.
 434 #define SYS_EXT_DIR     &quot;/usr/java/packages&quot;
 435 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 436 
 437   // Buffer that fits several sprintfs.
 438   // Note that the space for the colon and the trailing null are provided
 439   // by the nulls included by the sizeof operator.
 440   const size_t bufsize =
 441     MAX2((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 442          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 443   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 444 
 445   // sysclasspath, java_home, dll_dir
 446   {
 447     char *pslash;
 448     os::jvm_path(buf, bufsize);
 449 
 450     // Found the full path to libjvm.so.
 451     // Now cut the path to &lt;java_home&gt;/jre if we can.
 452     pslash = strrchr(buf, &#39;/&#39;);
 453     if (pslash != NULL) {
 454       *pslash = &#39;\0&#39;;            // Get rid of /libjvm.so.
 455     }
 456     pslash = strrchr(buf, &#39;/&#39;);
 457     if (pslash != NULL) {
 458       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 459     }
 460     Arguments::set_dll_dir(buf);
 461 
 462     if (pslash != NULL) {
 463       pslash = strrchr(buf, &#39;/&#39;);
 464       if (pslash != NULL) {
 465         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 466       }
 467     }
 468     Arguments::set_java_home(buf);
 469     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 470       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 471     }
 472   }
 473 
 474   // Where to look for native libraries.
 475   //
 476   // Note: Due to a legacy implementation, most of the library path
 477   // is set in the launcher. This was to accomodate linking restrictions
 478   // on legacy Linux implementations (which are no longer supported).
 479   // Eventually, all the library path setting will be done here.
 480   //
 481   // However, to prevent the proliferation of improperly built native
 482   // libraries, the new path component /usr/java/packages is added here.
 483   // Eventually, all the library path setting will be done here.
 484   {
 485     // Get the user setting of LD_LIBRARY_PATH, and prepended it. It
 486     // should always exist (until the legacy problem cited above is
 487     // addressed).
 488     const char *v = ::getenv(&quot;LD_LIBRARY_PATH&quot;);
 489     const char *v_colon = &quot;:&quot;;
 490     if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 491     // That&#39;s +1 for the colon and +1 for the trailing &#39;\0&#39;.
 492     char *ld_library_path = NEW_C_HEAP_ARRAY(char,
 493                                              strlen(v) + 1 +
 494                                              sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;) + sizeof(DEFAULT_LIBPATH) + 1,
 495                                              mtInternal);
 496     sprintf(ld_library_path, &quot;%s%s&quot; SYS_EXT_DIR &quot;/lib:&quot; DEFAULT_LIBPATH, v, v_colon);
 497     Arguments::set_library_path(ld_library_path);
 498     FREE_C_HEAP_ARRAY(char, ld_library_path);
 499   }
 500 
 501   // Extensions directories.
 502   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 503   Arguments::set_ext_dirs(buf);
 504 
 505   FREE_C_HEAP_ARRAY(char, buf);
 506 
 507 #undef DEFAULT_LIBPATH
 508 #undef SYS_EXT_DIR
 509 #undef EXTENSIONS_DIR
 510 }
 511 
 512 ////////////////////////////////////////////////////////////////////////////////
 513 // breakpoint support
 514 
 515 void os::breakpoint() {
 516   BREAKPOINT;
 517 }
 518 
 519 extern &quot;C&quot; void breakpoint() {
 520   // use debugger to set breakpoint here
 521 }
 522 
 523 ////////////////////////////////////////////////////////////////////////////////
 524 // signal support
 525 
 526 debug_only(static bool signal_sets_initialized = false);
 527 static sigset_t unblocked_sigs, vm_sigs;
 528 
 529 void os::Linux::signal_sets_init() {
 530   // Should also have an assertion stating we are still single-threaded.
 531   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 532   // Fill in signals that are necessarily unblocked for all threads in
 533   // the VM. Currently, we unblock the following signals:
 534   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 535   //                         by -Xrs (=ReduceSignalUsage));
 536   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 537   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 538   // the dispositions or masks wrt these signals.
 539   // Programs embedding the VM that want to use the above signals for their
 540   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 541   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 542   // (See bug 4345157, and other related bugs).
 543   // In reality, though, unblocking these signals is really a nop, since
 544   // these signals are not blocked by default.
 545   sigemptyset(&amp;unblocked_sigs);
 546   sigaddset(&amp;unblocked_sigs, SIGILL);
 547   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 548   sigaddset(&amp;unblocked_sigs, SIGBUS);
 549   sigaddset(&amp;unblocked_sigs, SIGFPE);
 550 #if defined(PPC64)
 551   sigaddset(&amp;unblocked_sigs, SIGTRAP);
 552 #endif
 553   sigaddset(&amp;unblocked_sigs, SR_signum);
 554 
 555   if (!ReduceSignalUsage) {
 556     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 557       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 558     }
 559     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 560       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 561     }
 562     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 563       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 564     }
 565   }
 566   // Fill in signals that are blocked by all but the VM thread.
 567   sigemptyset(&amp;vm_sigs);
 568   if (!ReduceSignalUsage) {
 569     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 570   }
 571   debug_only(signal_sets_initialized = true);
 572 
 573 }
 574 
 575 // These are signals that are unblocked while a thread is running Java.
 576 // (For some reason, they get blocked by default.)
 577 sigset_t* os::Linux::unblocked_signals() {
 578   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 579   return &amp;unblocked_sigs;
 580 }
 581 
 582 // These are the signals that are blocked while a (non-VM) thread is
 583 // running Java. Only the VM thread handles these signals.
 584 sigset_t* os::Linux::vm_signals() {
 585   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 586   return &amp;vm_sigs;
 587 }
 588 
 589 void os::Linux::hotspot_sigmask(Thread* thread) {
 590 
 591   //Save caller&#39;s signal mask before setting VM signal mask
 592   sigset_t caller_sigmask;
 593   pthread_sigmask(SIG_BLOCK, NULL, &amp;caller_sigmask);
 594 
 595   OSThread* osthread = thread-&gt;osthread();
 596   osthread-&gt;set_caller_sigmask(caller_sigmask);
 597 
 598   pthread_sigmask(SIG_UNBLOCK, os::Linux::unblocked_signals(), NULL);
 599 
 600   if (!ReduceSignalUsage) {
 601     if (thread-&gt;is_VM_thread()) {
 602       // Only the VM thread handles BREAK_SIGNAL ...
 603       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 604     } else {
 605       // ... all other threads block BREAK_SIGNAL
 606       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 607     }
 608   }
 609 }
 610 
 611 //////////////////////////////////////////////////////////////////////////////
 612 // detecting pthread library
 613 
 614 void os::Linux::libpthread_init() {
 615   // Save glibc and pthread version strings.
 616 #if !defined(_CS_GNU_LIBC_VERSION) || \
 617     !defined(_CS_GNU_LIBPTHREAD_VERSION)
 618   #error &quot;glibc too old (&lt; 2.3.2)&quot;
 619 #endif
 620 
<a name="3" id="anc3"></a><span class="line-modified"> 621 #ifdef MUSL_LIBC</span>
<span class="line-modified"> 622   // confstr() from musl libc returns EINVAL for</span>
<span class="line-modified"> 623   // _CS_GNU_LIBC_VERSION and _CS_GNU_LIBPTHREAD_VERSION</span>
<span class="line-modified"> 624   os::Linux::set_libc_version(&quot;unknown&quot;);</span>
<span class="line-modified"> 625   os::Linux::set_libpthread_version(&quot;unknown&quot;);</span>
<span class="line-modified"> 626 #else</span>
<span class="line-modified"> 627   size_t n = confstr(_CS_GNU_LIBC_VERSION, NULL, 0);</span>
<span class="line-modified"> 628   assert(n &gt; 0, &quot;cannot retrieve glibc version&quot;);</span>
<span class="line-added"> 629   char *str = (char *)malloc(n, mtInternal);</span>
<span class="line-added"> 630   confstr(_CS_GNU_LIBC_VERSION, str, n);</span>
<span class="line-added"> 631   os::Linux::set_libc_version(str);</span>
 632 
 633   n = confstr(_CS_GNU_LIBPTHREAD_VERSION, NULL, 0);
<a name="4" id="anc4"></a><span class="line-modified"> 634   assert(n &gt; 0, &quot;cannot retrieve pthread version&quot;);</span>
<span class="line-modified"> 635   str = (char *)malloc(n, mtInternal);</span>
<span class="line-modified"> 636   confstr(_CS_GNU_LIBPTHREAD_VERSION, str, n);</span>
<span class="line-modified"> 637   os::Linux::set_libpthread_version(str);</span>
<span class="line-modified"> 638 #endif</span>
 639 }
 640 
 641 /////////////////////////////////////////////////////////////////////////////
 642 // thread stack expansion
 643 
 644 // os::Linux::manually_expand_stack() takes care of expanding the thread
 645 // stack. Note that this is normally not needed: pthread stacks allocate
 646 // thread stack using mmap() without MAP_NORESERVE, so the stack is already
 647 // committed. Therefore it is not necessary to expand the stack manually.
 648 //
 649 // Manually expanding the stack was historically needed on LinuxThreads
 650 // thread stacks, which were allocated with mmap(MAP_GROWSDOWN). Nowadays
 651 // it is kept to deal with very rare corner cases:
 652 //
 653 // For one, user may run the VM on an own implementation of threads
 654 // whose stacks are - like the old LinuxThreads - implemented using
 655 // mmap(MAP_GROWSDOWN).
 656 //
 657 // Also, this coding may be needed if the VM is running on the primordial
 658 // thread. Normally we avoid running on the primordial thread; however,
 659 // user may still invoke the VM on the primordial thread.
 660 //
 661 // The following historical comment describes the details about running
 662 // on a thread stack allocated with mmap(MAP_GROWSDOWN):
 663 
 664 
 665 // Force Linux kernel to expand current thread stack. If &quot;bottom&quot; is close
 666 // to the stack guard, caller should block all signals.
 667 //
 668 // MAP_GROWSDOWN:
 669 //   A special mmap() flag that is used to implement thread stacks. It tells
 670 //   kernel that the memory region should extend downwards when needed. This
 671 //   allows early versions of LinuxThreads to only mmap the first few pages
 672 //   when creating a new thread. Linux kernel will automatically expand thread
 673 //   stack as needed (on page faults).
 674 //
 675 //   However, because the memory region of a MAP_GROWSDOWN stack can grow on
 676 //   demand, if a page fault happens outside an already mapped MAP_GROWSDOWN
 677 //   region, it&#39;s hard to tell if the fault is due to a legitimate stack
 678 //   access or because of reading/writing non-exist memory (e.g. buffer
 679 //   overrun). As a rule, if the fault happens below current stack pointer,
 680 //   Linux kernel does not expand stack, instead a SIGSEGV is sent to the
 681 //   application (see Linux kernel fault.c).
 682 //
 683 //   This Linux feature can cause SIGSEGV when VM bangs thread stack for
 684 //   stack overflow detection.
 685 //
 686 //   Newer version of LinuxThreads (since glibc-2.2, or, RH-7.x) and NPTL do
 687 //   not use MAP_GROWSDOWN.
 688 //
 689 // To get around the problem and allow stack banging on Linux, we need to
 690 // manually expand thread stack after receiving the SIGSEGV.
 691 //
 692 // There are two ways to expand thread stack to address &quot;bottom&quot;, we used
 693 // both of them in JVM before 1.5:
 694 //   1. adjust stack pointer first so that it is below &quot;bottom&quot;, and then
 695 //      touch &quot;bottom&quot;
 696 //   2. mmap() the page in question
 697 //
 698 // Now alternate signal stack is gone, it&#39;s harder to use 2. For instance,
 699 // if current sp is already near the lower end of page 101, and we need to
 700 // call mmap() to map page 100, it is possible that part of the mmap() frame
 701 // will be placed in page 100. When page 100 is mapped, it is zero-filled.
 702 // That will destroy the mmap() frame and cause VM to crash.
 703 //
 704 // The following code works by adjusting sp first, then accessing the &quot;bottom&quot;
 705 // page to force a page fault. Linux kernel will then automatically expand the
 706 // stack mapping.
 707 //
 708 // _expand_stack_to() assumes its frame size is less than page size, which
 709 // should always be true if the function is not inlined.
 710 
 711 static void NOINLINE _expand_stack_to(address bottom) {
 712   address sp;
 713   size_t size;
 714   volatile char *p;
 715 
 716   // Adjust bottom to point to the largest address within the same page, it
 717   // gives us a one-page buffer if alloca() allocates slightly more memory.
 718   bottom = (address)align_down((uintptr_t)bottom, os::Linux::page_size());
 719   bottom += os::Linux::page_size() - 1;
 720 
 721   // sp might be slightly above current stack pointer; if that&#39;s the case, we
 722   // will alloca() a little more space than necessary, which is OK. Don&#39;t use
 723   // os::current_stack_pointer(), as its result can be slightly below current
 724   // stack pointer, causing us to not alloca enough to reach &quot;bottom&quot;.
 725   sp = (address)&amp;sp;
 726 
 727   if (sp &gt; bottom) {
 728     size = sp - bottom;
 729     p = (volatile char *)alloca(size);
 730     assert(p != NULL &amp;&amp; p &lt;= (volatile char *)bottom, &quot;alloca problem?&quot;);
 731     p[0] = &#39;\0&#39;;
 732   }
 733 }
 734 
 735 void os::Linux::expand_stack_to(address bottom) {
 736   _expand_stack_to(bottom);
 737 }
 738 
 739 bool os::Linux::manually_expand_stack(JavaThread * t, address addr) {
 740   assert(t!=NULL, &quot;just checking&quot;);
 741   assert(t-&gt;osthread()-&gt;expanding_stack(), &quot;expand should be set&quot;);
 742 
 743   if (t-&gt;is_in_usable_stack(addr)) {
 744     sigset_t mask_all, old_sigset;
 745     sigfillset(&amp;mask_all);
 746     pthread_sigmask(SIG_SETMASK, &amp;mask_all, &amp;old_sigset);
 747     _expand_stack_to(addr);
 748     pthread_sigmask(SIG_SETMASK, &amp;old_sigset, NULL);
 749     return true;
 750   }
 751   return false;
 752 }
 753 
 754 //////////////////////////////////////////////////////////////////////////////
 755 // create new thread
 756 
 757 // Thread start routine for all newly created threads
 758 static void *thread_native_entry(Thread *thread) {
 759 
 760   thread-&gt;record_stack_base_and_size();
 761 
 762   // Try to randomize the cache line index of hot stack frames.
 763   // This helps when threads of the same stack traces evict each other&#39;s
 764   // cache lines. The threads can be either from the same JVM instance, or
 765   // from different JVM instances. The benefit is especially true for
 766   // processors with hyperthreading technology.
 767   static int counter = 0;
 768   int pid = os::current_process_id();
 769   alloca(((pid ^ counter++) &amp; 7) * 128);
 770 
 771   thread-&gt;initialize_thread_current();
 772 
 773   OSThread* osthread = thread-&gt;osthread();
 774   Monitor* sync = osthread-&gt;startThread_lock();
 775 
 776   osthread-&gt;set_thread_id(os::current_thread_id());
 777 
 778   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 779     os::current_thread_id(), (uintx) pthread_self());
 780 
 781   if (UseNUMA) {
 782     int lgrp_id = os::numa_get_group_id();
 783     if (lgrp_id != -1) {
 784       thread-&gt;set_lgrp_id(lgrp_id);
 785     }
 786   }
 787   // initialize signal mask for this thread
 788   os::Linux::hotspot_sigmask(thread);
 789 
 790   // initialize floating point control register
 791   os::Linux::init_thread_fpu_state();
 792 
 793   // handshaking with parent thread
 794   {
 795     MutexLocker ml(sync, Mutex::_no_safepoint_check_flag);
 796 
 797     // notify parent thread
 798     osthread-&gt;set_state(INITIALIZED);
 799     sync-&gt;notify_all();
 800 
 801     // wait until os::start_thread()
 802     while (osthread-&gt;get_state() == INITIALIZED) {
 803       sync-&gt;wait_without_safepoint_check();
 804     }
 805   }
 806 
 807   assert(osthread-&gt;pthread_id() != 0, &quot;pthread_id was not set as expected&quot;);
 808 
 809   // call one more level start routine
 810   thread-&gt;call_run();
 811 
 812   // Note: at this point the thread object may already have deleted itself.
 813   // Prevent dereferencing it from here on out.
 814   thread = NULL;
 815 
 816   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 817     os::current_thread_id(), (uintx) pthread_self());
 818 
 819   return 0;
 820 }
 821 
 822 // On Linux, glibc places static TLS blocks (for __thread variables) on
 823 // the thread stack. This decreases the stack size actually available
 824 // to threads.
 825 //
 826 // For large static TLS sizes, this may cause threads to malfunction due
 827 // to insufficient stack space. This is a well-known issue in glibc:
 828 // http://sourceware.org/bugzilla/show_bug.cgi?id=11787.
 829 //
 830 // As a workaround, we call a private but assumed-stable glibc function,
 831 // __pthread_get_minstack() to obtain the minstack size and derive the
 832 // static TLS size from it. We then increase the user requested stack
 833 // size by this TLS size.
 834 //
 835 // Due to compatibility concerns, this size adjustment is opt-in and
 836 // controlled via AdjustStackSizeForTLS.
 837 typedef size_t (*GetMinStack)(const pthread_attr_t *attr);
 838 
 839 GetMinStack _get_minstack_func = NULL;
 840 
 841 static void get_minstack_init() {
 842   _get_minstack_func =
 843         (GetMinStack)dlsym(RTLD_DEFAULT, &quot;__pthread_get_minstack&quot;);
 844   log_info(os, thread)(&quot;Lookup of __pthread_get_minstack %s&quot;,
 845                        _get_minstack_func == NULL ? &quot;failed&quot; : &quot;succeeded&quot;);
 846 }
 847 
 848 // Returns the size of the static TLS area glibc puts on thread stacks.
 849 // The value is cached on first use, which occurs when the first thread
 850 // is created during VM initialization.
 851 static size_t get_static_tls_area_size(const pthread_attr_t *attr) {
 852   size_t tls_size = 0;
 853   if (_get_minstack_func != NULL) {
 854     // Obtain the pthread minstack size by calling __pthread_get_minstack.
 855     size_t minstack_size = _get_minstack_func(attr);
 856 
 857     // Remove non-TLS area size included in minstack size returned
 858     // by __pthread_get_minstack() to get the static TLS size.
 859     // In glibc before 2.27, minstack size includes guard_size.
 860     // In glibc 2.27 and later, guard_size is automatically added
 861     // to the stack size by pthread_create and is no longer included
 862     // in minstack size. In both cases, the guard_size is taken into
 863     // account, so there is no need to adjust the result for that.
 864     //
 865     // Although __pthread_get_minstack() is a private glibc function,
 866     // it is expected to have a stable behavior across future glibc
 867     // versions while glibc still allocates the static TLS blocks off
 868     // the stack. Following is glibc 2.28 __pthread_get_minstack():
 869     //
 870     // size_t
 871     // __pthread_get_minstack (const pthread_attr_t *attr)
 872     // {
 873     //   return GLRO(dl_pagesize) + __static_tls_size + PTHREAD_STACK_MIN;
 874     // }
 875     //
 876     //
 877     // The following &#39;minstack_size &gt; os::vm_page_size() + PTHREAD_STACK_MIN&#39;
 878     // if check is done for precaution.
 879     if (minstack_size &gt; (size_t)os::vm_page_size() + PTHREAD_STACK_MIN) {
 880       tls_size = minstack_size - os::vm_page_size() - PTHREAD_STACK_MIN;
 881     }
 882   }
 883 
 884   log_info(os, thread)(&quot;Stack size adjustment for TLS is &quot; SIZE_FORMAT,
 885                        tls_size);
 886   return tls_size;
 887 }
 888 
 889 bool os::create_thread(Thread* thread, ThreadType thr_type,
 890                        size_t req_stack_size) {
 891   assert(thread-&gt;osthread() == NULL, &quot;caller responsible&quot;);
 892 
 893   // Allocate the OSThread object
 894   OSThread* osthread = new OSThread(NULL, NULL);
 895   if (osthread == NULL) {
 896     return false;
 897   }
 898 
 899   // set the correct thread state
 900   osthread-&gt;set_thread_type(thr_type);
 901 
 902   // Initial state is ALLOCATED but not INITIALIZED
 903   osthread-&gt;set_state(ALLOCATED);
 904 
 905   thread-&gt;set_osthread(osthread);
 906 
 907   // init thread attributes
 908   pthread_attr_t attr;
 909   pthread_attr_init(&amp;attr);
 910   pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
 911 
 912   // Calculate stack size if it&#39;s not specified by caller.
 913   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 914   // In glibc versions prior to 2.7 the guard size mechanism
 915   // is not implemented properly. The posix standard requires adding
 916   // the size of the guard pages to the stack size, instead Linux
 917   // takes the space out of &#39;stacksize&#39;. Thus we adapt the requested
 918   // stack_size by the size of the guard pages to mimick proper
 919   // behaviour. However, be careful not to end up with a size
 920   // of zero due to overflow. Don&#39;t add the guard page in that case.
 921   size_t guard_size = os::Linux::default_guard_size(thr_type);
 922   // Configure glibc guard page. Must happen before calling
 923   // get_static_tls_area_size(), which uses the guard_size.
 924   pthread_attr_setguardsize(&amp;attr, guard_size);
 925 
 926   size_t stack_adjust_size = 0;
 927   if (AdjustStackSizeForTLS) {
 928     // Adjust the stack_size for on-stack TLS - see get_static_tls_area_size().
 929     stack_adjust_size += get_static_tls_area_size(&amp;attr);
 930   } else {
 931     stack_adjust_size += guard_size;
 932   }
 933 
 934   stack_adjust_size = align_up(stack_adjust_size, os::vm_page_size());
 935   if (stack_size &lt;= SIZE_MAX - stack_adjust_size) {
 936     stack_size += stack_adjust_size;
 937   }
 938   assert(is_aligned(stack_size, os::vm_page_size()), &quot;stack_size not aligned&quot;);
 939 
 940   int status = pthread_attr_setstacksize(&amp;attr, stack_size);
 941   if (status != 0) {
 942     // pthread_attr_setstacksize() function can fail
 943     // if the stack size exceeds a system-imposed limit.
 944     assert_status(status == EINVAL, status, &quot;pthread_attr_setstacksize&quot;);
 945     log_warning(os, thread)(&quot;The %sthread stack size specified is invalid: &quot; SIZE_FORMAT &quot;k&quot;,
 946                             (thr_type == compiler_thread) ? &quot;compiler &quot; : ((thr_type == java_thread) ? &quot;&quot; : &quot;VM &quot;),
 947                             stack_size / K);
 948     thread-&gt;set_osthread(NULL);
 949     delete osthread;
 950     return false;
 951   }
 952 
 953   ThreadState state;
 954 
 955   {
 956     pthread_t tid;
 957     int ret = pthread_create(&amp;tid, &amp;attr, (void* (*)(void*)) thread_native_entry, thread);
 958 
 959     char buf[64];
 960     if (ret == 0) {
 961       log_info(os, thread)(&quot;Thread started (pthread id: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 962         (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 963     } else {
 964       log_warning(os, thread)(&quot;Failed to start thread - pthread_create failed (%s) for attributes: %s.&quot;,
 965         os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 966       // Log some OS information which might explain why creating the thread failed.
 967       log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 968       LogStream st(Log(os, thread)::info());
 969       os::Posix::print_rlimit_info(&amp;st);
 970       os::print_memory_info(&amp;st);
 971       os::Linux::print_proc_sys_info(&amp;st);
 972       os::Linux::print_container_info(&amp;st);
 973     }
 974 
 975     pthread_attr_destroy(&amp;attr);
 976 
 977     if (ret != 0) {
 978       // Need to clean up stuff we&#39;ve allocated so far
 979       thread-&gt;set_osthread(NULL);
 980       delete osthread;
 981       return false;
 982     }
 983 
 984     // Store pthread info into the OSThread
 985     osthread-&gt;set_pthread_id(tid);
 986 
 987     // Wait until child thread is either initialized or aborted
 988     {
 989       Monitor* sync_with_child = osthread-&gt;startThread_lock();
 990       MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
 991       while ((state = osthread-&gt;get_state()) == ALLOCATED) {
 992         sync_with_child-&gt;wait_without_safepoint_check();
 993       }
 994     }
 995   }
 996 
 997   // Aborted due to thread limit being reached
 998   if (state == ZOMBIE) {
 999     thread-&gt;set_osthread(NULL);
1000     delete osthread;
1001     return false;
1002   }
1003 
1004   // The thread is returned suspended (in state INITIALIZED),
1005   // and is started higher up in the call chain
1006   assert(state == INITIALIZED, &quot;race condition&quot;);
1007   return true;
1008 }
1009 
1010 /////////////////////////////////////////////////////////////////////////////
1011 // attach existing thread
1012 
1013 // bootstrap the main thread
1014 bool os::create_main_thread(JavaThread* thread) {
1015   assert(os::Linux::_main_thread == pthread_self(), &quot;should be called inside main thread&quot;);
1016   return create_attached_thread(thread);
1017 }
1018 
1019 bool os::create_attached_thread(JavaThread* thread) {
1020 #ifdef ASSERT
1021   thread-&gt;verify_not_published();
1022 #endif
1023 
1024   // Allocate the OSThread object
1025   OSThread* osthread = new OSThread(NULL, NULL);
1026 
1027   if (osthread == NULL) {
1028     return false;
1029   }
1030 
1031   // Store pthread info into the OSThread
1032   osthread-&gt;set_thread_id(os::Linux::gettid());
1033   osthread-&gt;set_pthread_id(::pthread_self());
1034 
1035   // initialize floating point control register
1036   os::Linux::init_thread_fpu_state();
1037 
1038   // Initial thread state is RUNNABLE
1039   osthread-&gt;set_state(RUNNABLE);
1040 
1041   thread-&gt;set_osthread(osthread);
1042 
1043   if (UseNUMA) {
1044     int lgrp_id = os::numa_get_group_id();
1045     if (lgrp_id != -1) {
1046       thread-&gt;set_lgrp_id(lgrp_id);
1047     }
1048   }
1049 
1050   if (os::is_primordial_thread()) {
1051     // If current thread is primordial thread, its stack is mapped on demand,
1052     // see notes about MAP_GROWSDOWN. Here we try to force kernel to map
1053     // the entire stack region to avoid SEGV in stack banging.
1054     // It is also useful to get around the heap-stack-gap problem on SuSE
1055     // kernel (see 4821821 for details). We first expand stack to the top
1056     // of yellow zone, then enable stack yellow zone (order is significant,
1057     // enabling yellow zone first will crash JVM on SuSE Linux), so there
1058     // is no gap between the last two virtual memory regions.
1059 
1060     JavaThread *jt = (JavaThread *)thread;
1061     address addr = jt-&gt;stack_reserved_zone_base();
1062     assert(addr != NULL, &quot;initialization problem?&quot;);
1063     assert(jt-&gt;stack_available(addr) &gt; 0, &quot;stack guard should not be enabled&quot;);
1064 
1065     osthread-&gt;set_expanding_stack();
1066     os::Linux::manually_expand_stack(jt, addr);
1067     osthread-&gt;clear_expanding_stack();
1068   }
1069 
1070   // initialize signal mask for this thread
1071   // and save the caller&#39;s signal mask
1072   os::Linux::hotspot_sigmask(thread);
1073 
1074   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
1075     os::current_thread_id(), (uintx) pthread_self());
1076 
1077   return true;
1078 }
1079 
1080 void os::pd_start_thread(Thread* thread) {
1081   OSThread * osthread = thread-&gt;osthread();
1082   assert(osthread-&gt;get_state() != INITIALIZED, &quot;just checking&quot;);
1083   Monitor* sync_with_child = osthread-&gt;startThread_lock();
1084   MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
1085   sync_with_child-&gt;notify();
1086 }
1087 
1088 // Free Linux resources related to the OSThread
1089 void os::free_thread(OSThread* osthread) {
1090   assert(osthread != NULL, &quot;osthread not set&quot;);
1091 
1092   // We are told to free resources of the argument thread,
1093   // but we can only really operate on the current thread.
1094   assert(Thread::current()-&gt;osthread() == osthread,
1095          &quot;os::free_thread but not current thread&quot;);
1096 
1097 #ifdef ASSERT
1098   sigset_t current;
1099   sigemptyset(&amp;current);
1100   pthread_sigmask(SIG_SETMASK, NULL, &amp;current);
1101   assert(!sigismember(&amp;current, SR_signum), &quot;SR signal should not be blocked!&quot;);
1102 #endif
1103 
1104   // Restore caller&#39;s signal mask
1105   sigset_t sigmask = osthread-&gt;caller_sigmask();
1106   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
1107 
1108   delete osthread;
1109 }
1110 
1111 //////////////////////////////////////////////////////////////////////////////
1112 // primordial thread
1113 
1114 // Check if current thread is the primordial thread, similar to Solaris thr_main.
1115 bool os::is_primordial_thread(void) {
1116   if (suppress_primordial_thread_resolution) {
1117     return false;
1118   }
1119   char dummy;
1120   // If called before init complete, thread stack bottom will be null.
1121   // Can be called if fatal error occurs before initialization.
1122   if (os::Linux::initial_thread_stack_bottom() == NULL) return false;
1123   assert(os::Linux::initial_thread_stack_bottom() != NULL &amp;&amp;
1124          os::Linux::initial_thread_stack_size()   != 0,
1125          &quot;os::init did not locate primordial thread&#39;s stack region&quot;);
1126   if ((address)&amp;dummy &gt;= os::Linux::initial_thread_stack_bottom() &amp;&amp;
1127       (address)&amp;dummy &lt; os::Linux::initial_thread_stack_bottom() +
1128                         os::Linux::initial_thread_stack_size()) {
1129     return true;
1130   } else {
1131     return false;
1132   }
1133 }
1134 
1135 // Find the virtual memory area that contains addr
1136 static bool find_vma(address addr, address* vma_low, address* vma_high) {
1137   FILE *fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);
1138   if (fp) {
1139     address low, high;
1140     while (!feof(fp)) {
1141       if (fscanf(fp, &quot;%p-%p&quot;, &amp;low, &amp;high) == 2) {
1142         if (low &lt;= addr &amp;&amp; addr &lt; high) {
1143           if (vma_low)  *vma_low  = low;
1144           if (vma_high) *vma_high = high;
1145           fclose(fp);
1146           return true;
1147         }
1148       }
1149       for (;;) {
1150         int ch = fgetc(fp);
1151         if (ch == EOF || ch == (int)&#39;\n&#39;) break;
1152       }
1153     }
1154     fclose(fp);
1155   }
1156   return false;
1157 }
1158 
1159 // Locate primordial thread stack. This special handling of primordial thread stack
1160 // is needed because pthread_getattr_np() on most (all?) Linux distros returns
1161 // bogus value for the primordial process thread. While the launcher has created
1162 // the VM in a new thread since JDK 6, we still have to allow for the use of the
1163 // JNI invocation API from a primordial thread.
1164 void os::Linux::capture_initial_stack(size_t max_size) {
1165 
1166   // max_size is either 0 (which means accept OS default for thread stacks) or
1167   // a user-specified value known to be at least the minimum needed. If we
1168   // are actually on the primordial thread we can make it appear that we have a
1169   // smaller max_size stack by inserting the guard pages at that location. But we
1170   // cannot do anything to emulate a larger stack than what has been provided by
1171   // the OS or threading library. In fact if we try to use a stack greater than
1172   // what is set by rlimit then we will crash the hosting process.
1173 
1174   // Maximum stack size is the easy part, get it from RLIMIT_STACK.
1175   // If this is &quot;unlimited&quot; then it will be a huge value.
1176   struct rlimit rlim;
1177   getrlimit(RLIMIT_STACK, &amp;rlim);
1178   size_t stack_size = rlim.rlim_cur;
1179 
1180   // 6308388: a bug in ld.so will relocate its own .data section to the
1181   //   lower end of primordial stack; reduce ulimit -s value a little bit
1182   //   so we won&#39;t install guard page on ld.so&#39;s data section.
1183   //   But ensure we don&#39;t underflow the stack size - allow 1 page spare
1184   if (stack_size &gt;= (size_t)(3 * page_size())) {
1185     stack_size -= 2 * page_size();
1186   }
1187 
1188   // Try to figure out where the stack base (top) is. This is harder.
1189   //
1190   // When an application is started, glibc saves the initial stack pointer in
1191   // a global variable &quot;__libc_stack_end&quot;, which is then used by system
1192   // libraries. __libc_stack_end should be pretty close to stack top. The
1193   // variable is available since the very early days. However, because it is
1194   // a private interface, it could disappear in the future.
1195   //
1196   // Linux kernel saves start_stack information in /proc/&lt;pid&gt;/stat. Similar
1197   // to __libc_stack_end, it is very close to stack top, but isn&#39;t the real
1198   // stack top. Note that /proc may not exist if VM is running as a chroot
1199   // program, so reading /proc/&lt;pid&gt;/stat could fail. Also the contents of
1200   // /proc/&lt;pid&gt;/stat could change in the future (though unlikely).
1201   //
1202   // We try __libc_stack_end first. If that doesn&#39;t work, look for
1203   // /proc/&lt;pid&gt;/stat. If neither of them works, we use current stack pointer
1204   // as a hint, which should work well in most cases.
1205 
1206   uintptr_t stack_start;
1207 
1208   // try __libc_stack_end first
1209   uintptr_t *p = (uintptr_t *)dlsym(RTLD_DEFAULT, &quot;__libc_stack_end&quot;);
1210   if (p &amp;&amp; *p) {
1211     stack_start = *p;
1212   } else {
1213     // see if we can get the start_stack field from /proc/self/stat
1214     FILE *fp;
1215     int pid;
1216     char state;
1217     int ppid;
1218     int pgrp;
1219     int session;
1220     int nr;
1221     int tpgrp;
1222     unsigned long flags;
1223     unsigned long minflt;
1224     unsigned long cminflt;
1225     unsigned long majflt;
1226     unsigned long cmajflt;
1227     unsigned long utime;
1228     unsigned long stime;
1229     long cutime;
1230     long cstime;
1231     long prio;
1232     long nice;
1233     long junk;
1234     long it_real;
1235     uintptr_t start;
1236     uintptr_t vsize;
1237     intptr_t rss;
1238     uintptr_t rsslim;
1239     uintptr_t scodes;
1240     uintptr_t ecode;
1241     int i;
1242 
1243     // Figure what the primordial thread stack base is. Code is inspired
1244     // by email from Hans Boehm. /proc/self/stat begins with current pid,
1245     // followed by command name surrounded by parentheses, state, etc.
1246     char stat[2048];
1247     int statlen;
1248 
1249     fp = fopen(&quot;/proc/self/stat&quot;, &quot;r&quot;);
1250     if (fp) {
1251       statlen = fread(stat, 1, 2047, fp);
1252       stat[statlen] = &#39;\0&#39;;
1253       fclose(fp);
1254 
1255       // Skip pid and the command string. Note that we could be dealing with
1256       // weird command names, e.g. user could decide to rename java launcher
1257       // to &quot;java 1.4.2 :)&quot;, then the stat file would look like
1258       //                1234 (java 1.4.2 :)) R ... ...
1259       // We don&#39;t really need to know the command string, just find the last
1260       // occurrence of &quot;)&quot; and then start parsing from there. See bug 4726580.
1261       char * s = strrchr(stat, &#39;)&#39;);
1262 
1263       i = 0;
1264       if (s) {
1265         // Skip blank chars
1266         do { s++; } while (s &amp;&amp; isspace(*s));
1267 
1268 #define _UFM UINTX_FORMAT
1269 #define _DFM INTX_FORMAT
1270 
1271         //                                     1   1   1   1   1   1   1   1   1   1   2   2    2    2    2    2    2    2    2
1272         //              3  4  5  6  7  8   9   0   1   2   3   4   5   6   7   8   9   0   1    2    3    4    5    6    7    8
1273         i = sscanf(s, &quot;%c %d %d %d %d %d %lu %lu %lu %lu %lu %lu %lu %ld %ld %ld %ld %ld %ld &quot; _UFM _UFM _DFM _UFM _UFM _UFM _UFM,
1274                    &amp;state,          // 3  %c
1275                    &amp;ppid,           // 4  %d
1276                    &amp;pgrp,           // 5  %d
1277                    &amp;session,        // 6  %d
1278                    &amp;nr,             // 7  %d
1279                    &amp;tpgrp,          // 8  %d
1280                    &amp;flags,          // 9  %lu
1281                    &amp;minflt,         // 10 %lu
1282                    &amp;cminflt,        // 11 %lu
1283                    &amp;majflt,         // 12 %lu
1284                    &amp;cmajflt,        // 13 %lu
1285                    &amp;utime,          // 14 %lu
1286                    &amp;stime,          // 15 %lu
1287                    &amp;cutime,         // 16 %ld
1288                    &amp;cstime,         // 17 %ld
1289                    &amp;prio,           // 18 %ld
1290                    &amp;nice,           // 19 %ld
1291                    &amp;junk,           // 20 %ld
1292                    &amp;it_real,        // 21 %ld
1293                    &amp;start,          // 22 UINTX_FORMAT
1294                    &amp;vsize,          // 23 UINTX_FORMAT
1295                    &amp;rss,            // 24 INTX_FORMAT
1296                    &amp;rsslim,         // 25 UINTX_FORMAT
1297                    &amp;scodes,         // 26 UINTX_FORMAT
1298                    &amp;ecode,          // 27 UINTX_FORMAT
1299                    &amp;stack_start);   // 28 UINTX_FORMAT
1300       }
1301 
1302 #undef _UFM
1303 #undef _DFM
1304 
1305       if (i != 28 - 2) {
1306         assert(false, &quot;Bad conversion from /proc/self/stat&quot;);
1307         // product mode - assume we are the primordial thread, good luck in the
1308         // embedded case.
1309         warning(&quot;Can&#39;t detect primordial thread stack location - bad conversion&quot;);
1310         stack_start = (uintptr_t) &amp;rlim;
1311       }
1312     } else {
1313       // For some reason we can&#39;t open /proc/self/stat (for example, running on
1314       // FreeBSD with a Linux emulator, or inside chroot), this should work for
1315       // most cases, so don&#39;t abort:
1316       warning(&quot;Can&#39;t detect primordial thread stack location - no /proc/self/stat&quot;);
1317       stack_start = (uintptr_t) &amp;rlim;
1318     }
1319   }
1320 
1321   // Now we have a pointer (stack_start) very close to the stack top, the
1322   // next thing to do is to figure out the exact location of stack top. We
1323   // can find out the virtual memory area that contains stack_start by
1324   // reading /proc/self/maps, it should be the last vma in /proc/self/maps,
1325   // and its upper limit is the real stack top. (again, this would fail if
1326   // running inside chroot, because /proc may not exist.)
1327 
1328   uintptr_t stack_top;
1329   address low, high;
1330   if (find_vma((address)stack_start, &amp;low, &amp;high)) {
1331     // success, &quot;high&quot; is the true stack top. (ignore &quot;low&quot;, because initial
1332     // thread stack grows on demand, its real bottom is high - RLIMIT_STACK.)
1333     stack_top = (uintptr_t)high;
1334   } else {
1335     // failed, likely because /proc/self/maps does not exist
1336     warning(&quot;Can&#39;t detect primordial thread stack location - find_vma failed&quot;);
1337     // best effort: stack_start is normally within a few pages below the real
1338     // stack top, use it as stack top, and reduce stack size so we won&#39;t put
1339     // guard page outside stack.
1340     stack_top = stack_start;
1341     stack_size -= 16 * page_size();
1342   }
1343 
1344   // stack_top could be partially down the page so align it
1345   stack_top = align_up(stack_top, page_size());
1346 
1347   // Allowed stack value is minimum of max_size and what we derived from rlimit
1348   if (max_size &gt; 0) {
1349     _initial_thread_stack_size = MIN2(max_size, stack_size);
1350   } else {
1351     // Accept the rlimit max, but if stack is unlimited then it will be huge, so
1352     // clamp it at 8MB as we do on Solaris
1353     _initial_thread_stack_size = MIN2(stack_size, 8*M);
1354   }
1355   _initial_thread_stack_size = align_down(_initial_thread_stack_size, page_size());
1356   _initial_thread_stack_bottom = (address)stack_top - _initial_thread_stack_size;
1357 
1358   assert(_initial_thread_stack_bottom &lt; (address)stack_top, &quot;overflow!&quot;);
1359 
1360   if (log_is_enabled(Info, os, thread)) {
1361     // See if we seem to be on primordial process thread
1362     bool primordial = uintptr_t(&amp;rlim) &gt; uintptr_t(_initial_thread_stack_bottom) &amp;&amp;
1363                       uintptr_t(&amp;rlim) &lt; stack_top;
1364 
1365     log_info(os, thread)(&quot;Capturing initial stack in %s thread: req. size: &quot; SIZE_FORMAT &quot;K, actual size: &quot;
1366                          SIZE_FORMAT &quot;K, top=&quot; INTPTR_FORMAT &quot;, bottom=&quot; INTPTR_FORMAT,
1367                          primordial ? &quot;primordial&quot; : &quot;user&quot;, max_size / K,  _initial_thread_stack_size / K,
1368                          stack_top, intptr_t(_initial_thread_stack_bottom));
1369   }
1370 }
1371 
1372 ////////////////////////////////////////////////////////////////////////////////
1373 // time support
1374 
1375 #ifndef SUPPORTS_CLOCK_MONOTONIC
1376 #error &quot;Build platform doesn&#39;t support clock_gettime and related functionality&quot;
1377 #endif
1378 
1379 // Time since start-up in seconds to a fine granularity.
1380 // Used by VMSelfDestructTimer and the MemProfiler.
1381 double os::elapsedTime() {
1382 
1383   return ((double)os::elapsed_counter()) / os::elapsed_frequency(); // nanosecond resolution
1384 }
1385 
1386 jlong os::elapsed_counter() {
1387   return javaTimeNanos() - initial_time_count;
1388 }
1389 
1390 jlong os::elapsed_frequency() {
1391   return NANOSECS_PER_SEC; // nanosecond resolution
1392 }
1393 
1394 bool os::supports_vtime() { return true; }
1395 
1396 double os::elapsedVTime() {
1397   struct rusage usage;
1398   int retval = getrusage(RUSAGE_THREAD, &amp;usage);
1399   if (retval == 0) {
1400     return (double) (usage.ru_utime.tv_sec + usage.ru_stime.tv_sec) + (double) (usage.ru_utime.tv_usec + usage.ru_stime.tv_usec) / (1000 * 1000);
1401   } else {
1402     // better than nothing, but not much
1403     return elapsedTime();
1404   }
1405 }
1406 
1407 jlong os::javaTimeMillis() {
1408   if (os::Posix::supports_clock_gettime()) {
1409     struct timespec ts;
1410     int status = os::Posix::clock_gettime(CLOCK_REALTIME, &amp;ts);
1411     assert_status(status == 0, status, &quot;gettime error&quot;);
1412     return jlong(ts.tv_sec) * MILLIUNITS +
1413            jlong(ts.tv_nsec) / NANOUNITS_PER_MILLIUNIT;
1414   } else {
1415     timeval time;
1416     int status = gettimeofday(&amp;time, NULL);
1417     assert(status != -1, &quot;linux error&quot;);
1418     return jlong(time.tv_sec) * MILLIUNITS  +
1419            jlong(time.tv_usec) / (MICROUNITS / MILLIUNITS);
1420   }
1421 }
1422 
1423 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1424   if (os::Posix::supports_clock_gettime()) {
1425     struct timespec ts;
1426     int status = os::Posix::clock_gettime(CLOCK_REALTIME, &amp;ts);
1427     assert_status(status == 0, status, &quot;gettime error&quot;);
1428     seconds = jlong(ts.tv_sec);
1429     nanos = jlong(ts.tv_nsec);
1430   } else {
1431     timeval time;
1432     int status = gettimeofday(&amp;time, NULL);
1433     assert(status != -1, &quot;linux error&quot;);
1434     seconds = jlong(time.tv_sec);
1435     nanos = jlong(time.tv_usec) * (NANOUNITS / MICROUNITS);
1436   }
1437 }
1438 
1439 void os::Linux::fast_thread_clock_init() {
1440   if (!UseLinuxPosixThreadCPUClocks) {
1441     return;
1442   }
1443   clockid_t clockid;
1444   struct timespec tp;
1445   int (*pthread_getcpuclockid_func)(pthread_t, clockid_t *) =
1446       (int(*)(pthread_t, clockid_t *)) dlsym(RTLD_DEFAULT, &quot;pthread_getcpuclockid&quot;);
1447 
1448   // Switch to using fast clocks for thread cpu time if
1449   // the clock_getres() returns 0 error code.
1450   // Note, that some kernels may support the current thread
1451   // clock (CLOCK_THREAD_CPUTIME_ID) but not the clocks
1452   // returned by the pthread_getcpuclockid().
1453   // If the fast Posix clocks are supported then the clock_getres()
1454   // must return at least tp.tv_sec == 0 which means a resolution
1455   // better than 1 sec. This is extra check for reliability.
1456 
1457   if (pthread_getcpuclockid_func &amp;&amp;
1458       pthread_getcpuclockid_func(_main_thread, &amp;clockid) == 0 &amp;&amp;
1459       os::Posix::clock_getres(clockid, &amp;tp) == 0 &amp;&amp; tp.tv_sec == 0) {
1460     _supports_fast_thread_cpu_time = true;
1461     _pthread_getcpuclockid = pthread_getcpuclockid_func;
1462   }
1463 }
1464 
1465 jlong os::javaTimeNanos() {
1466   if (os::supports_monotonic_clock()) {
1467     struct timespec tp;
1468     int status = os::Posix::clock_gettime(CLOCK_MONOTONIC, &amp;tp);
1469     assert(status == 0, &quot;gettime error&quot;);
1470     jlong result = jlong(tp.tv_sec) * (1000 * 1000 * 1000) + jlong(tp.tv_nsec);
1471     return result;
1472   } else {
1473     timeval time;
1474     int status = gettimeofday(&amp;time, NULL);
1475     assert(status != -1, &quot;linux error&quot;);
1476     jlong usecs = jlong(time.tv_sec) * (1000 * 1000) + jlong(time.tv_usec);
1477     return 1000 * usecs;
1478   }
1479 }
1480 
1481 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1482   if (os::supports_monotonic_clock()) {
1483     info_ptr-&gt;max_value = ALL_64_BITS;
1484 
1485     // CLOCK_MONOTONIC - amount of time since some arbitrary point in the past
1486     info_ptr-&gt;may_skip_backward = false;      // not subject to resetting or drifting
1487     info_ptr-&gt;may_skip_forward = false;       // not subject to resetting or drifting
1488   } else {
1489     // gettimeofday - based on time in seconds since the Epoch thus does not wrap
1490     info_ptr-&gt;max_value = ALL_64_BITS;
1491 
1492     // gettimeofday is a real time clock so it skips
1493     info_ptr-&gt;may_skip_backward = true;
1494     info_ptr-&gt;may_skip_forward = true;
1495   }
1496 
1497   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;                // elapsed not CPU time
1498 }
1499 
1500 // Return the real, user, and system times in seconds from an
1501 // arbitrary fixed point in the past.
1502 bool os::getTimesSecs(double* process_real_time,
1503                       double* process_user_time,
1504                       double* process_system_time) {
1505   struct tms ticks;
1506   clock_t real_ticks = times(&amp;ticks);
1507 
1508   if (real_ticks == (clock_t) (-1)) {
1509     return false;
1510   } else {
1511     double ticks_per_second = (double) clock_tics_per_sec;
1512     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1513     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1514     *process_real_time = ((double) real_ticks) / ticks_per_second;
1515 
1516     return true;
1517   }
1518 }
1519 
1520 
1521 char * os::local_time_string(char *buf, size_t buflen) {
1522   struct tm t;
1523   time_t long_time;
1524   time(&amp;long_time);
1525   localtime_r(&amp;long_time, &amp;t);
1526   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1527                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1528                t.tm_hour, t.tm_min, t.tm_sec);
1529   return buf;
1530 }
1531 
1532 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
1533   return localtime_r(clock, res);
1534 }
1535 
1536 ////////////////////////////////////////////////////////////////////////////////
1537 // runtime exit support
1538 
1539 // Note: os::shutdown() might be called very early during initialization, or
1540 // called from signal handler. Before adding something to os::shutdown(), make
1541 // sure it is async-safe and can handle partially initialized VM.
1542 void os::shutdown() {
1543 
1544   // allow PerfMemory to attempt cleanup of any persistent resources
1545   perfMemory_exit();
1546 
1547   // needs to remove object in file system
1548   AttachListener::abort();
1549 
1550   // flush buffered output, finish log files
1551   ostream_abort();
1552 
1553   // Check for abort hook
1554   abort_hook_t abort_hook = Arguments::abort_hook();
1555   if (abort_hook != NULL) {
1556     abort_hook();
1557   }
1558 
1559 }
1560 
1561 // Note: os::abort() might be called very early during initialization, or
1562 // called from signal handler. Before adding something to os::abort(), make
1563 // sure it is async-safe and can handle partially initialized VM.
1564 void os::abort(bool dump_core, void* siginfo, const void* context) {
1565   os::shutdown();
1566   if (dump_core) {
1567     if (DumpPrivateMappingsInCore) {
1568       ClassLoader::close_jrt_image();
1569     }
1570     ::abort(); // dump core
1571   }
1572 
1573   ::exit(1);
1574 }
1575 
1576 // Die immediately, no exit hook, no abort hook, no cleanup.
1577 // Dump a core file, if possible, for debugging.
1578 void os::die() {
1579   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1580     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1581     // and don&#39;t take the time to generate a core file.
1582     os::signal_raise(SIGKILL);
1583   } else {
1584     ::abort();
1585   }
1586 }
1587 
1588 // thread_id is kernel thread id (similar to Solaris LWP id)
1589 intx os::current_thread_id() { return os::Linux::gettid(); }
1590 int os::current_process_id() {
1591   return ::getpid();
1592 }
1593 
1594 // DLL functions
1595 
1596 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1597 
1598 // This must be hard coded because it&#39;s the system&#39;s temporary
1599 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1600 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1601 
1602 static bool file_exists(const char* filename) {
1603   struct stat statbuf;
1604   if (filename == NULL || strlen(filename) == 0) {
1605     return false;
1606   }
1607   return os::stat(filename, &amp;statbuf) == 0;
1608 }
1609 
1610 // check if addr is inside libjvm.so
1611 bool os::address_is_in_vm(address addr) {
1612   static address libjvm_base_addr;
1613   Dl_info dlinfo;
1614 
1615   if (libjvm_base_addr == NULL) {
1616     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1617       libjvm_base_addr = (address)dlinfo.dli_fbase;
1618     }
1619     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1620   }
1621 
1622   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1623     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1624   }
1625 
1626   return false;
1627 }
1628 
1629 bool os::dll_address_to_function_name(address addr, char *buf,
1630                                       int buflen, int *offset,
1631                                       bool demangle) {
1632   // buf is not optional, but offset is optional
1633   assert(buf != NULL, &quot;sanity check&quot;);
1634 
1635   Dl_info dlinfo;
1636 
1637   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1638     // see if we have a matching symbol
1639     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1640       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1641         jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1642       }
1643       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1644       return true;
1645     }
1646     // no matching symbol so try for just file info
1647     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1648       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1649                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1650         return true;
1651       }
1652     }
1653   }
1654 
1655   buf[0] = &#39;\0&#39;;
1656   if (offset != NULL) *offset = -1;
1657   return false;
1658 }
1659 
1660 struct _address_to_library_name {
1661   address addr;          // input : memory address
1662   size_t  buflen;        //         size of fname
1663   char*   fname;         // output: library name
1664   address base;          //         library base addr
1665 };
1666 
1667 static int address_to_library_name_callback(struct dl_phdr_info *info,
1668                                             size_t size, void *data) {
1669   int i;
1670   bool found = false;
1671   address libbase = NULL;
1672   struct _address_to_library_name * d = (struct _address_to_library_name *)data;
1673 
1674   // iterate through all loadable segments
1675   for (i = 0; i &lt; info-&gt;dlpi_phnum; i++) {
1676     address segbase = (address)(info-&gt;dlpi_addr + info-&gt;dlpi_phdr[i].p_vaddr);
1677     if (info-&gt;dlpi_phdr[i].p_type == PT_LOAD) {
1678       // base address of a library is the lowest address of its loaded
1679       // segments.
1680       if (libbase == NULL || libbase &gt; segbase) {
1681         libbase = segbase;
1682       }
1683       // see if &#39;addr&#39; is within current segment
1684       if (segbase &lt;= d-&gt;addr &amp;&amp;
1685           d-&gt;addr &lt; segbase + info-&gt;dlpi_phdr[i].p_memsz) {
1686         found = true;
1687       }
1688     }
1689   }
1690 
1691   // dlpi_name is NULL or empty if the ELF file is executable, return 0
1692   // so dll_address_to_library_name() can fall through to use dladdr() which
1693   // can figure out executable name from argv[0].
1694   if (found &amp;&amp; info-&gt;dlpi_name &amp;&amp; info-&gt;dlpi_name[0]) {
1695     d-&gt;base = libbase;
1696     if (d-&gt;fname) {
1697       jio_snprintf(d-&gt;fname, d-&gt;buflen, &quot;%s&quot;, info-&gt;dlpi_name);
1698     }
1699     return 1;
1700   }
1701   return 0;
1702 }
1703 
1704 bool os::dll_address_to_library_name(address addr, char* buf,
1705                                      int buflen, int* offset) {
1706   // buf is not optional, but offset is optional
1707   assert(buf != NULL, &quot;sanity check&quot;);
1708 
1709   Dl_info dlinfo;
1710   struct _address_to_library_name data;
1711 
1712   // There is a bug in old glibc dladdr() implementation that it could resolve
1713   // to wrong library name if the .so file has a base address != NULL. Here
1714   // we iterate through the program headers of all loaded libraries to find
1715   // out which library &#39;addr&#39; really belongs to. This workaround can be
1716   // removed once the minimum requirement for glibc is moved to 2.3.x.
1717   data.addr = addr;
1718   data.fname = buf;
1719   data.buflen = buflen;
1720   data.base = NULL;
1721   int rslt = dl_iterate_phdr(address_to_library_name_callback, (void *)&amp;data);
1722 
1723   if (rslt) {
1724     // buf already contains library name
1725     if (offset) *offset = addr - data.base;
1726     return true;
1727   }
1728   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1729     if (dlinfo.dli_fname != NULL) {
1730       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1731     }
1732     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1733       *offset = addr - (address)dlinfo.dli_fbase;
1734     }
1735     return true;
1736   }
1737 
1738   buf[0] = &#39;\0&#39;;
1739   if (offset) *offset = -1;
1740   return false;
1741 }
1742 
1743 // Loads .dll/.so and
1744 // in case of error it checks if .dll/.so was built for the
1745 // same architecture as Hotspot is running on
1746 
1747 
1748 // Remember the stack&#39;s state. The Linux dynamic linker will change
1749 // the stack to &#39;executable&#39; at most once, so we must safepoint only once.
1750 bool os::Linux::_stack_is_executable = false;
1751 
1752 // VM operation that loads a library.  This is necessary if stack protection
1753 // of the Java stacks can be lost during loading the library.  If we
1754 // do not stop the Java threads, they can stack overflow before the stacks
1755 // are protected again.
1756 class VM_LinuxDllLoad: public VM_Operation {
1757  private:
1758   const char *_filename;
1759   char *_ebuf;
1760   int _ebuflen;
1761   void *_lib;
1762  public:
1763   VM_LinuxDllLoad(const char *fn, char *ebuf, int ebuflen) :
1764     _filename(fn), _ebuf(ebuf), _ebuflen(ebuflen), _lib(NULL) {}
1765   VMOp_Type type() const { return VMOp_LinuxDllLoad; }
1766   void doit() {
1767     _lib = os::Linux::dll_load_in_vmthread(_filename, _ebuf, _ebuflen);
1768     os::Linux::_stack_is_executable = true;
1769   }
1770   void* loaded_library() { return _lib; }
1771 };
1772 
1773 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1774   void * result = NULL;
1775   bool load_attempted = false;
1776 
1777   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1778 
1779   // Check whether the library to load might change execution rights
1780   // of the stack. If they are changed, the protection of the stack
1781   // guard pages will be lost. We need a safepoint to fix this.
1782   //
1783   // See Linux man page execstack(8) for more info.
1784   if (os::uses_stack_guard_pages() &amp;&amp; !os::Linux::_stack_is_executable) {
1785     if (!ElfFile::specifies_noexecstack(filename)) {
1786       if (!is_init_completed()) {
1787         os::Linux::_stack_is_executable = true;
1788         // This is OK - No Java threads have been created yet, and hence no
1789         // stack guard pages to fix.
1790         //
1791         // Dynamic loader will make all stacks executable after
1792         // this function returns, and will not do that again.
1793         assert(Threads::number_of_threads() == 0, &quot;no Java threads should exist yet.&quot;);
1794       } else {
1795         warning(&quot;You have loaded library %s which might have disabled stack guard. &quot;
1796                 &quot;The VM will try to fix the stack guard now.\n&quot;
1797                 &quot;It&#39;s highly recommended that you fix the library with &quot;
1798                 &quot;&#39;execstack -c &lt;libfile&gt;&#39;, or link it with &#39;-z noexecstack&#39;.&quot;,
1799                 filename);
1800 
1801         assert(Thread::current()-&gt;is_Java_thread(), &quot;must be Java thread&quot;);
1802         JavaThread *jt = JavaThread::current();
1803         if (jt-&gt;thread_state() != _thread_in_native) {
1804           // This happens when a compiler thread tries to load a hsdis-&lt;arch&gt;.so file
1805           // that requires ExecStack. Cannot enter safe point. Let&#39;s give up.
1806           warning(&quot;Unable to fix stack guard. Giving up.&quot;);
1807         } else {
1808           if (!LoadExecStackDllInVMThread) {
1809             // This is for the case where the DLL has an static
1810             // constructor function that executes JNI code. We cannot
1811             // load such DLLs in the VMThread.
1812             result = os::Linux::dlopen_helper(filename, ebuf, ebuflen);
1813           }
1814 
1815           ThreadInVMfromNative tiv(jt);
1816           debug_only(VMNativeEntryWrapper vew;)
1817 
1818           VM_LinuxDllLoad op(filename, ebuf, ebuflen);
1819           VMThread::execute(&amp;op);
1820           if (LoadExecStackDllInVMThread) {
1821             result = op.loaded_library();
1822           }
1823           load_attempted = true;
1824         }
1825       }
1826     }
1827   }
1828 
1829   if (!load_attempted) {
1830     result = os::Linux::dlopen_helper(filename, ebuf, ebuflen);
1831   }
1832 
1833   if (result != NULL) {
1834     // Successful loading
1835     return result;
1836   }
1837 
1838   Elf32_Ehdr elf_head;
1839   int diag_msg_max_length=ebuflen-strlen(ebuf);
1840   char* diag_msg_buf=ebuf+strlen(ebuf);
1841 
1842   if (diag_msg_max_length==0) {
1843     // No more space in ebuf for additional diagnostics message
1844     return NULL;
1845   }
1846 
1847 
1848   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1849 
1850   if (file_descriptor &lt; 0) {
1851     // Can&#39;t open library, report dlerror() message
1852     return NULL;
1853   }
1854 
1855   bool failed_to_read_elf_head=
1856     (sizeof(elf_head)!=
1857      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1858 
1859   ::close(file_descriptor);
1860   if (failed_to_read_elf_head) {
1861     // file i/o error - report dlerror() msg
1862     return NULL;
1863   }
1864 
1865   if (elf_head.e_ident[EI_DATA] != LITTLE_ENDIAN_ONLY(ELFDATA2LSB) BIG_ENDIAN_ONLY(ELFDATA2MSB)) {
1866     // handle invalid/out of range endianness values
1867     if (elf_head.e_ident[EI_DATA] == 0 || elf_head.e_ident[EI_DATA] &gt; 2) {
1868       return NULL;
1869     }
1870 
1871 #if defined(VM_LITTLE_ENDIAN)
1872     // VM is LE, shared object BE
1873     elf_head.e_machine = be16toh(elf_head.e_machine);
1874 #else
1875     // VM is BE, shared object LE
1876     elf_head.e_machine = le16toh(elf_head.e_machine);
1877 #endif
1878   }
1879 
1880   typedef struct {
1881     Elf32_Half    code;         // Actual value as defined in elf.h
1882     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1883     unsigned char elf_class;    // 32 or 64 bit
1884     unsigned char endianness;   // MSB or LSB
1885     char*         name;         // String representation
1886   } arch_t;
1887 
1888 #ifndef EM_AARCH64
1889   #define EM_AARCH64    183               /* ARM AARCH64 */
1890 #endif
1891 #ifndef EM_RISCV
1892   #define EM_RISCV      243               /* RISC-V */
1893 #endif
1894 
1895   static const arch_t arch_array[]={
1896     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1897     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1898     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1899     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1900     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1901     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1902     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1903     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1904 #if defined(VM_LITTLE_ENDIAN)
1905     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Power PC 64 LE&quot;},
1906     {EM_SH,          EM_SH,      ELFCLASS32, ELFDATA2LSB, (char*)&quot;SuperH&quot;},
1907 #else
1908     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1909     {EM_SH,          EM_SH,      ELFCLASS32, ELFDATA2MSB, (char*)&quot;SuperH BE&quot;},
1910 #endif
1911     {EM_ARM,         EM_ARM,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;ARM&quot;},
1912     // we only support 64 bit z architecture
1913     {EM_S390,        EM_S390,    ELFCLASS64, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1914     {EM_ALPHA,       EM_ALPHA,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Alpha&quot;},
1915     {EM_MIPS_RS3_LE, EM_MIPS_RS3_LE, ELFCLASS32, ELFDATA2LSB, (char*)&quot;MIPSel&quot;},
1916     {EM_MIPS,        EM_MIPS,    ELFCLASS32, ELFDATA2MSB, (char*)&quot;MIPS&quot;},
1917     {EM_PARISC,      EM_PARISC,  ELFCLASS32, ELFDATA2MSB, (char*)&quot;PARISC&quot;},
1918     {EM_68K,         EM_68K,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;M68k&quot;},
1919     {EM_AARCH64,     EM_AARCH64, ELFCLASS64, ELFDATA2LSB, (char*)&quot;AARCH64&quot;},
1920     {EM_RISCV,       EM_RISCV,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;RISC-V&quot;},
1921   };
1922 
1923 #if  (defined IA32)
1924   static  Elf32_Half running_arch_code=EM_386;
1925 #elif   (defined AMD64) || (defined X32)
1926   static  Elf32_Half running_arch_code=EM_X86_64;
1927 #elif  (defined IA64)
1928   static  Elf32_Half running_arch_code=EM_IA_64;
1929 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1930   static  Elf32_Half running_arch_code=EM_SPARCV9;
1931 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1932   static  Elf32_Half running_arch_code=EM_SPARC;
1933 #elif  (defined __powerpc64__)
1934   static  Elf32_Half running_arch_code=EM_PPC64;
1935 #elif  (defined __powerpc__)
1936   static  Elf32_Half running_arch_code=EM_PPC;
1937 #elif  (defined AARCH64)
1938   static  Elf32_Half running_arch_code=EM_AARCH64;
1939 #elif  (defined ARM)
1940   static  Elf32_Half running_arch_code=EM_ARM;
1941 #elif  (defined S390)
1942   static  Elf32_Half running_arch_code=EM_S390;
1943 #elif  (defined ALPHA)
1944   static  Elf32_Half running_arch_code=EM_ALPHA;
1945 #elif  (defined MIPSEL)
1946   static  Elf32_Half running_arch_code=EM_MIPS_RS3_LE;
1947 #elif  (defined PARISC)
1948   static  Elf32_Half running_arch_code=EM_PARISC;
1949 #elif  (defined MIPS)
1950   static  Elf32_Half running_arch_code=EM_MIPS;
1951 #elif  (defined M68K)
1952   static  Elf32_Half running_arch_code=EM_68K;
1953 #elif  (defined SH)
1954   static  Elf32_Half running_arch_code=EM_SH;
1955 #elif  (defined RISCV)
1956   static  Elf32_Half running_arch_code=EM_RISCV;
1957 #else
1958     #error Method os::dll_load requires that one of following is defined:\
1959         AARCH64, ALPHA, ARM, AMD64, IA32, IA64, M68K, MIPS, MIPSEL, PARISC, __powerpc__, __powerpc64__, RISCV, S390, SH, __sparc
1960 #endif
1961 
1962   // Identify compatibility class for VM&#39;s architecture and library&#39;s architecture
1963   // Obtain string descriptions for architectures
1964 
1965   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1966   int running_arch_index=-1;
1967 
1968   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1969     if (running_arch_code == arch_array[i].code) {
1970       running_arch_index    = i;
1971     }
1972     if (lib_arch.code == arch_array[i].code) {
1973       lib_arch.compat_class = arch_array[i].compat_class;
1974       lib_arch.name         = arch_array[i].name;
1975     }
1976   }
1977 
1978   assert(running_arch_index != -1,
1979          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1980   if (running_arch_index == -1) {
1981     // Even though running architecture detection failed
1982     // we may still continue with reporting dlerror() message
1983     return NULL;
1984   }
1985 
1986   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1987     if (lib_arch.name != NULL) {
1988       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1989                  &quot; (Possible cause: can&#39;t load %s .so on a %s platform)&quot;,
1990                  lib_arch.name, arch_array[running_arch_index].name);
1991     } else {
1992       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1993                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s platform)&quot;,
1994                  lib_arch.code, arch_array[running_arch_index].name);
1995     }
1996     return NULL;
1997   }
1998 
1999   if (lib_arch.endianness != arch_array[running_arch_index].endianness) {
2000     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: endianness mismatch)&quot;);
2001     return NULL;
2002   }
2003 
2004   // ELF file class/capacity : 0 - invalid, 1 - 32bit, 2 - 64bit
2005   if (lib_arch.elf_class &gt; 2 || lib_arch.elf_class &lt; 1) {
2006     ::snprintf(diag_msg_buf, diag_msg_max_length-1, &quot; (Possible cause: invalid ELF file class)&quot;);
2007     return NULL;
2008   }
2009 
2010   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
2011     ::snprintf(diag_msg_buf, diag_msg_max_length-1,
2012                &quot; (Possible cause: architecture word width mismatch, can&#39;t load %d-bit .so on a %d-bit platform)&quot;,
2013                (int) lib_arch.elf_class * 32, arch_array[running_arch_index].elf_class * 32);
2014     return NULL;
2015   }
2016 
2017   return NULL;
2018 }
2019 
2020 void * os::Linux::dlopen_helper(const char *filename, char *ebuf,
2021                                 int ebuflen) {
2022   void * result = ::dlopen(filename, RTLD_LAZY);
2023   if (result == NULL) {
2024     const char* error_report = ::dlerror();
2025     if (error_report == NULL) {
2026       error_report = &quot;dlerror returned no error description&quot;;
2027     }
2028     if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
2029       ::strncpy(ebuf, error_report, ebuflen-1);
2030       ebuf[ebuflen-1]=&#39;\0&#39;;
2031     }
2032     Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
2033     log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
2034   } else {
2035     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
2036     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
2037   }
2038   return result;
2039 }
2040 
2041 void * os::Linux::dll_load_in_vmthread(const char *filename, char *ebuf,
2042                                        int ebuflen) {
2043   void * result = NULL;
2044   if (LoadExecStackDllInVMThread) {
2045     result = dlopen_helper(filename, ebuf, ebuflen);
2046   }
2047 
2048   // Since 7019808, libjvm.so is linked with -noexecstack. If the VM loads a
2049   // library that requires an executable stack, or which does not have this
2050   // stack attribute set, dlopen changes the stack attribute to executable. The
2051   // read protection of the guard pages gets lost.
2052   //
2053   // Need to check _stack_is_executable again as multiple VM_LinuxDllLoad
2054   // may have been queued at the same time.
2055 
2056   if (!_stack_is_executable) {
2057     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2058       if (!jt-&gt;stack_guard_zone_unused() &amp;&amp;     // Stack not yet fully initialized
2059           jt-&gt;stack_guards_enabled()) {         // No pending stack overflow exceptions
2060         if (!os::guard_memory((char *)jt-&gt;stack_end(), jt-&gt;stack_guard_zone_size())) {
2061           warning(&quot;Attempt to reguard stack yellow zone failed.&quot;);
2062         }
2063       }
2064     }
2065   }
2066 
2067   return result;
2068 }
2069 
2070 void* os::dll_lookup(void* handle, const char* name) {
2071   void* res = dlsym(handle, name);
2072   return res;
2073 }
2074 
2075 void* os::get_default_process_handle() {
2076   return (void*)::dlopen(NULL, RTLD_LAZY);
2077 }
2078 
2079 static bool _print_ascii_file(const char* filename, outputStream* st, const char* hdr = NULL) {
2080   int fd = ::open(filename, O_RDONLY);
2081   if (fd == -1) {
2082     return false;
2083   }
2084 
2085   if (hdr != NULL) {
2086     st-&gt;print_cr(&quot;%s&quot;, hdr);
2087   }
2088 
2089   char buf[33];
2090   int bytes;
2091   buf[32] = &#39;\0&#39;;
2092   while ((bytes = ::read(fd, buf, sizeof(buf)-1)) &gt; 0) {
2093     st-&gt;print_raw(buf, bytes);
2094   }
2095 
2096   ::close(fd);
2097 
2098   return true;
2099 }
2100 
2101 static void _print_ascii_file_h(const char* header, const char* filename, outputStream* st, bool same_line = true) {
2102   st-&gt;print(&quot;%s:%c&quot;, header, same_line ? &#39; &#39; : &#39;\n&#39;);
2103   if (!_print_ascii_file(filename, st)) {
2104     st-&gt;print_cr(&quot;&lt;Not Available&gt;&quot;);
2105   }
2106 }
2107 
2108 void os::print_dll_info(outputStream *st) {
2109   st-&gt;print_cr(&quot;Dynamic libraries:&quot;);
2110 
2111   char fname[32];
2112   pid_t pid = os::Linux::gettid();
2113 
2114   jio_snprintf(fname, sizeof(fname), &quot;/proc/%d/maps&quot;, pid);
2115 
2116   if (!_print_ascii_file(fname, st)) {
2117     st-&gt;print_cr(&quot;Can not get library information for pid = %d&quot;, pid);
2118   }
2119 }
2120 
2121 struct loaded_modules_info_param {
2122   os::LoadedModulesCallbackFunc callback;
2123   void *param;
2124 };
2125 
2126 static int dl_iterate_callback(struct dl_phdr_info *info, size_t size, void *data) {
2127   if ((info-&gt;dlpi_name == NULL) || (*info-&gt;dlpi_name == &#39;\0&#39;)) {
2128     return 0;
2129   }
2130 
2131   struct loaded_modules_info_param *callback_param = reinterpret_cast&lt;struct loaded_modules_info_param *&gt;(data);
2132   address base = NULL;
2133   address top = NULL;
2134   for (int idx = 0; idx &lt; info-&gt;dlpi_phnum; idx++) {
2135     const ElfW(Phdr) *phdr = info-&gt;dlpi_phdr + idx;
2136     if (phdr-&gt;p_type == PT_LOAD) {
2137       address raw_phdr_base = reinterpret_cast&lt;address&gt;(info-&gt;dlpi_addr + phdr-&gt;p_vaddr);
2138 
2139       address phdr_base = align_down(raw_phdr_base, phdr-&gt;p_align);
2140       if ((base == NULL) || (base &gt; phdr_base)) {
2141         base = phdr_base;
2142       }
2143 
2144       address phdr_top = align_up(raw_phdr_base + phdr-&gt;p_memsz, phdr-&gt;p_align);
2145       if ((top == NULL) || (top &lt; phdr_top)) {
2146         top = phdr_top;
2147       }
2148     }
2149   }
2150 
2151   return callback_param-&gt;callback(info-&gt;dlpi_name, base, top, callback_param-&gt;param);
2152 }
2153 
2154 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
2155   struct loaded_modules_info_param callback_param = {callback, param};
2156   return dl_iterate_phdr(&amp;dl_iterate_callback, &amp;callback_param);
2157 }
2158 
2159 void os::print_os_info_brief(outputStream* st) {
2160   os::Linux::print_distro_info(st);
2161 
2162   os::Posix::print_uname_info(st);
2163 
2164   os::Linux::print_libversion_info(st);
2165 
2166 }
2167 
2168 void os::print_os_info(outputStream* st) {
2169   st-&gt;print_cr(&quot;OS:&quot;);
2170 
2171   os::Linux::print_distro_info(st);
2172 
2173   os::Posix::print_uname_info(st);
2174 
2175   os::Linux::print_uptime_info(st);
2176 
2177   // Print warning if unsafe chroot environment detected
2178   if (unsafe_chroot_detected) {
2179     st-&gt;print_cr(&quot;WARNING!! %s&quot;, unstable_chroot_error);
2180   }
2181 
2182   os::Linux::print_libversion_info(st);
2183 
2184   os::Posix::print_rlimit_info(st);
2185 
2186   os::Posix::print_load_average(st);
2187   st-&gt;cr();
2188 
2189   os::Linux::print_system_memory_info(st);
2190   st-&gt;cr();
2191 
2192   os::Linux::print_process_memory_info(st);
2193   st-&gt;cr();
2194 
2195   os::Linux::print_proc_sys_info(st);
2196   st-&gt;cr();
2197 
2198   if (os::Linux::print_ld_preload_file(st)) {
2199     st-&gt;cr();
2200   }
2201 
2202   if (os::Linux::print_container_info(st)) {
2203     st-&gt;cr();
2204   }
2205 
2206   VM_Version::print_platform_virtualization_info(st);
2207 
2208   os::Linux::print_steal_info(st);
2209 }
2210 
2211 // Try to identify popular distros.
2212 // Most Linux distributions have a /etc/XXX-release file, which contains
2213 // the OS version string. Newer Linux distributions have a /etc/lsb-release
2214 // file that also contains the OS version string. Some have more than one
2215 // /etc/XXX-release file (e.g. Mandrake has both /etc/mandrake-release and
2216 // /etc/redhat-release.), so the order is important.
2217 // Any Linux that is based on Redhat (i.e. Oracle, Mandrake, Sun JDS...) have
2218 // their own specific XXX-release file as well as a redhat-release file.
2219 // Because of this the XXX-release file needs to be searched for before the
2220 // redhat-release file.
2221 // Since Red Hat and SuSE have an lsb-release file that is not very descriptive the
2222 // search for redhat-release / SuSE-release needs to be before lsb-release.
2223 // Since the lsb-release file is the new standard it needs to be searched
2224 // before the older style release files.
2225 // Searching system-release (Red Hat) and os-release (other Linuxes) are a
2226 // next to last resort.  The os-release file is a new standard that contains
2227 // distribution information and the system-release file seems to be an old
2228 // standard that has been replaced by the lsb-release and os-release files.
2229 // Searching for the debian_version file is the last resort.  It contains
2230 // an informative string like &quot;6.0.6&quot; or &quot;wheezy/sid&quot;. Because of this
2231 // &quot;Debian &quot; is printed before the contents of the debian_version file.
2232 
2233 const char* distro_files[] = {
2234   &quot;/etc/oracle-release&quot;,
2235   &quot;/etc/mandriva-release&quot;,
2236   &quot;/etc/mandrake-release&quot;,
2237   &quot;/etc/sun-release&quot;,
2238   &quot;/etc/redhat-release&quot;,
2239   &quot;/etc/SuSE-release&quot;,
2240   &quot;/etc/lsb-release&quot;,
2241   &quot;/etc/turbolinux-release&quot;,
2242   &quot;/etc/gentoo-release&quot;,
2243   &quot;/etc/ltib-release&quot;,
2244   &quot;/etc/angstrom-version&quot;,
2245   &quot;/etc/system-release&quot;,
2246   &quot;/etc/os-release&quot;,
2247   NULL };
2248 
2249 void os::Linux::print_distro_info(outputStream* st) {
2250   for (int i = 0;; i++) {
2251     const char* file = distro_files[i];
2252     if (file == NULL) {
2253       break;  // done
2254     }
2255     // If file prints, we found it.
2256     if (_print_ascii_file(file, st)) {
2257       return;
2258     }
2259   }
2260 
2261   if (file_exists(&quot;/etc/debian_version&quot;)) {
2262     st-&gt;print(&quot;Debian &quot;);
2263     _print_ascii_file(&quot;/etc/debian_version&quot;, st);
2264   } else {
2265     st-&gt;print_cr(&quot;Linux&quot;);
2266   }
2267 }
2268 
2269 static void parse_os_info_helper(FILE* fp, char* distro, size_t length, bool get_first_line) {
2270   char buf[256];
2271   while (fgets(buf, sizeof(buf), fp)) {
2272     // Edit out extra stuff in expected format
2273     if (strstr(buf, &quot;DISTRIB_DESCRIPTION=&quot;) != NULL || strstr(buf, &quot;PRETTY_NAME=&quot;) != NULL) {
2274       char* ptr = strstr(buf, &quot;\&quot;&quot;);  // the name is in quotes
2275       if (ptr != NULL) {
2276         ptr++; // go beyond first quote
2277         char* nl = strchr(ptr, &#39;\&quot;&#39;);
2278         if (nl != NULL) *nl = &#39;\0&#39;;
2279         strncpy(distro, ptr, length);
2280       } else {
2281         ptr = strstr(buf, &quot;=&quot;);
2282         ptr++; // go beyond equals then
2283         char* nl = strchr(ptr, &#39;\n&#39;);
2284         if (nl != NULL) *nl = &#39;\0&#39;;
2285         strncpy(distro, ptr, length);
2286       }
2287       return;
2288     } else if (get_first_line) {
2289       char* nl = strchr(buf, &#39;\n&#39;);
2290       if (nl != NULL) *nl = &#39;\0&#39;;
2291       strncpy(distro, buf, length);
2292       return;
2293     }
2294   }
2295   // print last line and close
2296   char* nl = strchr(buf, &#39;\n&#39;);
2297   if (nl != NULL) *nl = &#39;\0&#39;;
2298   strncpy(distro, buf, length);
2299 }
2300 
2301 static void parse_os_info(char* distro, size_t length, const char* file) {
2302   FILE* fp = fopen(file, &quot;r&quot;);
2303   if (fp != NULL) {
2304     // if suse format, print out first line
2305     bool get_first_line = (strcmp(file, &quot;/etc/SuSE-release&quot;) == 0);
2306     parse_os_info_helper(fp, distro, length, get_first_line);
2307     fclose(fp);
2308   }
2309 }
2310 
2311 void os::get_summary_os_info(char* buf, size_t buflen) {
2312   for (int i = 0;; i++) {
2313     const char* file = distro_files[i];
2314     if (file == NULL) {
2315       break; // ran out of distro_files
2316     }
2317     if (file_exists(file)) {
2318       parse_os_info(buf, buflen, file);
2319       return;
2320     }
2321   }
2322   // special case for debian
2323   if (file_exists(&quot;/etc/debian_version&quot;)) {
2324     strncpy(buf, &quot;Debian &quot;, buflen);
2325     if (buflen &gt; 7) {
2326       parse_os_info(&amp;buf[7], buflen-7, &quot;/etc/debian_version&quot;);
2327     }
2328   } else {
2329     strncpy(buf, &quot;Linux&quot;, buflen);
2330   }
2331 }
2332 
2333 void os::Linux::print_libversion_info(outputStream* st) {
2334   // libc, pthread
2335   st-&gt;print(&quot;libc: &quot;);
<a name="5" id="anc5"></a><span class="line-modified">2336   st-&gt;print(&quot;%s &quot;, os::Linux::libc_version());</span>
2337   st-&gt;print(&quot;%s &quot;, os::Linux::libpthread_version());
2338   st-&gt;cr();
2339 }
2340 
2341 void os::Linux::print_proc_sys_info(outputStream* st) {
2342   _print_ascii_file_h(&quot;/proc/sys/kernel/threads-max (system-wide limit on the number of threads)&quot;,
2343                       &quot;/proc/sys/kernel/threads-max&quot;, st);
2344   _print_ascii_file_h(&quot;/proc/sys/vm/max_map_count (maximum number of memory map areas a process may have)&quot;,
2345                       &quot;/proc/sys/vm/max_map_count&quot;, st);
2346   _print_ascii_file_h(&quot;/proc/sys/kernel/pid_max (system-wide limit on number of process identifiers)&quot;,
2347                       &quot;/proc/sys/kernel/pid_max&quot;, st);
2348 }
2349 
2350 void os::Linux::print_system_memory_info(outputStream* st) {
2351   _print_ascii_file_h(&quot;/proc/meminfo&quot;, &quot;/proc/meminfo&quot;, st, false);
2352   st-&gt;cr();
2353 
2354   // some information regarding THPs; for details see
2355   // https://www.kernel.org/doc/Documentation/vm/transhuge.txt
2356   _print_ascii_file_h(&quot;/sys/kernel/mm/transparent_hugepage/enabled&quot;,
2357                       &quot;/sys/kernel/mm/transparent_hugepage/enabled&quot;, st);
2358   _print_ascii_file_h(&quot;/sys/kernel/mm/transparent_hugepage/defrag (defrag/compaction efforts parameter)&quot;,
2359                       &quot;/sys/kernel/mm/transparent_hugepage/defrag&quot;, st);
2360 }
2361 
2362 void os::Linux::print_process_memory_info(outputStream* st) {
2363 
2364   st-&gt;print_cr(&quot;Process Memory:&quot;);
2365 
2366   // Print virtual and resident set size; peak values; swap; and for
2367   //  rss its components if the kernel is recent enough.
2368   ssize_t vmsize = -1, vmpeak = -1, vmswap = -1,
2369       vmrss = -1, vmhwm = -1, rssanon = -1, rssfile = -1, rssshmem = -1;
2370   const int num_values = 8;
2371   int num_found = 0;
2372   FILE* f = ::fopen(&quot;/proc/self/status&quot;, &quot;r&quot;);
2373   char buf[256];
2374   while (::fgets(buf, sizeof(buf), f) != NULL &amp;&amp; num_found &lt; num_values) {
2375     if ( (vmsize == -1    &amp;&amp; sscanf(buf, &quot;VmSize: &quot; SSIZE_FORMAT &quot; kB&quot;, &amp;vmsize) == 1) ||
2376          (vmpeak == -1    &amp;&amp; sscanf(buf, &quot;VmPeak: &quot; SSIZE_FORMAT &quot; kB&quot;, &amp;vmpeak) == 1) ||
2377          (vmswap == -1    &amp;&amp; sscanf(buf, &quot;VmSwap: &quot; SSIZE_FORMAT &quot; kB&quot;, &amp;vmswap) == 1) ||
2378          (vmhwm == -1     &amp;&amp; sscanf(buf, &quot;VmHWM: &quot; SSIZE_FORMAT &quot; kB&quot;, &amp;vmhwm) == 1) ||
2379          (vmrss == -1     &amp;&amp; sscanf(buf, &quot;VmRSS: &quot; SSIZE_FORMAT &quot; kB&quot;, &amp;vmrss) == 1) ||
2380          (rssanon == -1   &amp;&amp; sscanf(buf, &quot;RssAnon: &quot; SSIZE_FORMAT &quot; kB&quot;, &amp;rssanon) == 1) ||
2381          (rssfile == -1   &amp;&amp; sscanf(buf, &quot;RssFile: &quot; SSIZE_FORMAT &quot; kB&quot;, &amp;rssfile) == 1) ||
2382          (rssshmem == -1  &amp;&amp; sscanf(buf, &quot;RssShmem: &quot; SSIZE_FORMAT &quot; kB&quot;, &amp;rssshmem) == 1)
2383          )
2384     {
2385       num_found ++;
2386     }
2387   }
2388   st-&gt;print_cr(&quot;Virtual Size: &quot; SSIZE_FORMAT &quot;K (peak: &quot; SSIZE_FORMAT &quot;K)&quot;, vmsize, vmpeak);
2389   st-&gt;print(&quot;Resident Set Size: &quot; SSIZE_FORMAT &quot;K (peak: &quot; SSIZE_FORMAT &quot;K)&quot;, vmrss, vmhwm);
2390   if (rssanon != -1) { // requires kernel &gt;= 4.5
2391     st-&gt;print(&quot; (anon: &quot; SSIZE_FORMAT &quot;K, file: &quot; SSIZE_FORMAT &quot;K, shmem: &quot; SSIZE_FORMAT &quot;K)&quot;,
2392                 rssanon, rssfile, rssshmem);
2393   }
2394   st-&gt;cr();
2395   if (vmswap != -1) { // requires kernel &gt;= 2.6.34
2396     st-&gt;print_cr(&quot;Swapped out: &quot; SSIZE_FORMAT &quot;K&quot;, vmswap);
2397   }
2398 
2399   // Print glibc outstanding allocations.
2400   // (note: there is no implementation of mallinfo for muslc)
2401 #ifdef __GLIBC__
2402   struct mallinfo mi = ::mallinfo();
2403 
2404   // mallinfo is an old API. Member names mean next to nothing and, beyond that, are int.
2405   // So values may have wrapped around. Still useful enough to see how much glibc thinks
2406   // we allocated.
2407   const size_t total_allocated = (size_t)(unsigned)mi.uordblks;
2408   st-&gt;print(&quot;C-Heap outstanding allocations: &quot; SIZE_FORMAT &quot;K&quot;, total_allocated / K);
2409   // Since mallinfo members are int, glibc values may have wrapped. Warn about this.
2410   if ((vmrss * K) &gt; UINT_MAX &amp;&amp; (vmrss * K) &gt; (total_allocated + UINT_MAX)) {
2411     st-&gt;print(&quot; (may have wrapped)&quot;);
2412   }
2413   st-&gt;cr();
2414 
2415 #endif // __GLIBC__
2416 
2417 }
2418 
2419 bool os::Linux::print_ld_preload_file(outputStream* st) {
2420   return _print_ascii_file(&quot;/etc/ld.so.preload&quot;, st, &quot;/etc/ld.so.preload:&quot;);
2421 }
2422 
2423 void os::Linux::print_uptime_info(outputStream* st) {
2424   struct sysinfo sinfo;
2425   int ret = sysinfo(&amp;sinfo);
2426   if (ret == 0) {
2427     os::print_dhm(st, &quot;OS uptime:&quot;, (long) sinfo.uptime);
2428   }
2429 }
2430 
2431 bool os::Linux::print_container_info(outputStream* st) {
2432   if (!OSContainer::is_containerized()) {
2433     return false;
2434   }
2435 
2436   st-&gt;print_cr(&quot;container (cgroup) information:&quot;);
2437 
2438   const char *p_ct = OSContainer::container_type();
2439   st-&gt;print_cr(&quot;container_type: %s&quot;, p_ct != NULL ? p_ct : &quot;not supported&quot;);
2440 
2441   char *p = OSContainer::cpu_cpuset_cpus();
2442   st-&gt;print_cr(&quot;cpu_cpuset_cpus: %s&quot;, p != NULL ? p : &quot;not supported&quot;);
2443   free(p);
2444 
2445   p = OSContainer::cpu_cpuset_memory_nodes();
2446   st-&gt;print_cr(&quot;cpu_memory_nodes: %s&quot;, p != NULL ? p : &quot;not supported&quot;);
2447   free(p);
2448 
2449   int i = OSContainer::active_processor_count();
2450   st-&gt;print(&quot;active_processor_count: &quot;);
2451   if (i &gt; 0) {
2452     st-&gt;print_cr(&quot;%d&quot;, i);
2453   } else {
2454     st-&gt;print_cr(&quot;not supported&quot;);
2455   }
2456 
2457   i = OSContainer::cpu_quota();
2458   st-&gt;print(&quot;cpu_quota: &quot;);
2459   if (i &gt; 0) {
2460     st-&gt;print_cr(&quot;%d&quot;, i);
2461   } else {
2462     st-&gt;print_cr(&quot;%s&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no quota&quot;);
2463   }
2464 
2465   i = OSContainer::cpu_period();
2466   st-&gt;print(&quot;cpu_period: &quot;);
2467   if (i &gt; 0) {
2468     st-&gt;print_cr(&quot;%d&quot;, i);
2469   } else {
2470     st-&gt;print_cr(&quot;%s&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no period&quot;);
2471   }
2472 
2473   i = OSContainer::cpu_shares();
2474   st-&gt;print(&quot;cpu_shares: &quot;);
2475   if (i &gt; 0) {
2476     st-&gt;print_cr(&quot;%d&quot;, i);
2477   } else {
2478     st-&gt;print_cr(&quot;%s&quot;, i == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;no shares&quot;);
2479   }
2480 
2481   jlong j = OSContainer::memory_limit_in_bytes();
2482   st-&gt;print(&quot;memory_limit_in_bytes: &quot;);
2483   if (j &gt; 0) {
2484     st-&gt;print_cr(JLONG_FORMAT, j);
2485   } else {
2486     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2487   }
2488 
2489   j = OSContainer::memory_and_swap_limit_in_bytes();
2490   st-&gt;print(&quot;memory_and_swap_limit_in_bytes: &quot;);
2491   if (j &gt; 0) {
2492     st-&gt;print_cr(JLONG_FORMAT, j);
2493   } else {
2494     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2495   }
2496 
2497   j = OSContainer::memory_soft_limit_in_bytes();
2498   st-&gt;print(&quot;memory_soft_limit_in_bytes: &quot;);
2499   if (j &gt; 0) {
2500     st-&gt;print_cr(JLONG_FORMAT, j);
2501   } else {
2502     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2503   }
2504 
2505   j = OSContainer::OSContainer::memory_usage_in_bytes();
2506   st-&gt;print(&quot;memory_usage_in_bytes: &quot;);
2507   if (j &gt; 0) {
2508     st-&gt;print_cr(JLONG_FORMAT, j);
2509   } else {
2510     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2511   }
2512 
2513   j = OSContainer::OSContainer::memory_max_usage_in_bytes();
2514   st-&gt;print(&quot;memory_max_usage_in_bytes: &quot;);
2515   if (j &gt; 0) {
2516     st-&gt;print_cr(JLONG_FORMAT, j);
2517   } else {
2518     st-&gt;print_cr(&quot;%s&quot;, j == OSCONTAINER_ERROR ? &quot;not supported&quot; : &quot;unlimited&quot;);
2519   }
2520 
2521   return true;
2522 }
2523 
2524 void os::Linux::print_steal_info(outputStream* st) {
2525   if (has_initial_tick_info) {
2526     CPUPerfTicks pticks;
2527     bool res = os::Linux::get_tick_information(&amp;pticks, -1);
2528 
2529     if (res &amp;&amp; pticks.has_steal_ticks) {
2530       uint64_t steal_ticks_difference = pticks.steal - initial_steal_ticks;
2531       uint64_t total_ticks_difference = pticks.total - initial_total_ticks;
2532       double steal_ticks_perc = 0.0;
2533       if (total_ticks_difference != 0) {
2534         steal_ticks_perc = (double) steal_ticks_difference / total_ticks_difference;
2535       }
2536       st-&gt;print_cr(&quot;Steal ticks since vm start: &quot; UINT64_FORMAT, steal_ticks_difference);
2537       st-&gt;print_cr(&quot;Steal ticks percentage since vm start:%7.3f&quot;, steal_ticks_perc);
2538     }
2539   }
2540 }
2541 
2542 void os::print_memory_info(outputStream* st) {
2543 
2544   st-&gt;print(&quot;Memory:&quot;);
2545   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
2546 
2547   // values in struct sysinfo are &quot;unsigned long&quot;
2548   struct sysinfo si;
2549   sysinfo(&amp;si);
2550 
2551   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;,
2552             os::physical_memory() &gt;&gt; 10);
2553   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
2554             os::available_memory() &gt;&gt; 10);
2555   st-&gt;print(&quot;, swap &quot; UINT64_FORMAT &quot;k&quot;,
2556             ((jlong)si.totalswap * si.mem_unit) &gt;&gt; 10);
2557   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
2558             ((jlong)si.freeswap * si.mem_unit) &gt;&gt; 10);
2559   st-&gt;cr();
2560 }
2561 
2562 // Print the first &quot;model name&quot; line and the first &quot;flags&quot; line
2563 // that we find and nothing more. We assume &quot;model name&quot; comes
2564 // before &quot;flags&quot; so if we find a second &quot;model name&quot;, then the
2565 // &quot;flags&quot; field is considered missing.
2566 static bool print_model_name_and_flags(outputStream* st, char* buf, size_t buflen) {
2567 #if defined(IA32) || defined(AMD64)
2568   // Other platforms have less repetitive cpuinfo files
2569   FILE *fp = fopen(&quot;/proc/cpuinfo&quot;, &quot;r&quot;);
2570   if (fp) {
2571     while (!feof(fp)) {
2572       if (fgets(buf, buflen, fp)) {
2573         // Assume model name comes before flags
2574         bool model_name_printed = false;
2575         if (strstr(buf, &quot;model name&quot;) != NULL) {
2576           if (!model_name_printed) {
2577             st-&gt;print_raw(&quot;CPU Model and flags from /proc/cpuinfo:\n&quot;);
2578             st-&gt;print_raw(buf);
2579             model_name_printed = true;
2580           } else {
2581             // model name printed but not flags?  Odd, just return
2582             fclose(fp);
2583             return true;
2584           }
2585         }
2586         // print the flags line too
2587         if (strstr(buf, &quot;flags&quot;) != NULL) {
2588           st-&gt;print_raw(buf);
2589           fclose(fp);
2590           return true;
2591         }
2592       }
2593     }
2594     fclose(fp);
2595   }
2596 #endif // x86 platforms
2597   return false;
2598 }
2599 
2600 // additional information about CPU e.g. available frequency ranges
2601 static void print_sys_devices_cpu_info(outputStream* st, char* buf, size_t buflen) {
2602   _print_ascii_file_h(&quot;Online cpus&quot;, &quot;/sys/devices/system/cpu/online&quot;, st);
2603   _print_ascii_file_h(&quot;Offline cpus&quot;, &quot;/sys/devices/system/cpu/offline&quot;, st);
2604 
2605   if (ExtensiveErrorReports) {
2606     // cache related info (cpu 0, should be similar for other CPUs)
2607     for (unsigned int i=0; i &lt; 10; i++) { // handle max. 10 cache entries
2608       char hbuf_level[60];
2609       char hbuf_type[60];
2610       char hbuf_size[60];
2611       char hbuf_coherency_line_size[80];
2612       snprintf(hbuf_level, 60, &quot;/sys/devices/system/cpu/cpu0/cache/index%u/level&quot;, i);
2613       snprintf(hbuf_type, 60, &quot;/sys/devices/system/cpu/cpu0/cache/index%u/type&quot;, i);
2614       snprintf(hbuf_size, 60, &quot;/sys/devices/system/cpu/cpu0/cache/index%u/size&quot;, i);
2615       snprintf(hbuf_coherency_line_size, 80, &quot;/sys/devices/system/cpu/cpu0/cache/index%u/coherency_line_size&quot;, i);
2616       if (file_exists(hbuf_level)) {
2617         _print_ascii_file_h(&quot;cache level&quot;, hbuf_level, st);
2618         _print_ascii_file_h(&quot;cache type&quot;, hbuf_type, st);
2619         _print_ascii_file_h(&quot;cache size&quot;, hbuf_size, st);
2620         _print_ascii_file_h(&quot;cache coherency line size&quot;, hbuf_coherency_line_size, st);
2621       }
2622     }
2623   }
2624 
2625   // we miss the cpufreq entries on Power and s390x
2626 #if defined(IA32) || defined(AMD64)
2627   _print_ascii_file_h(&quot;BIOS frequency limitation&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/bios_limit&quot;, st);
2628   _print_ascii_file_h(&quot;Frequency switch latency (ns)&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_transition_latency&quot;, st);
2629   _print_ascii_file_h(&quot;Available cpu frequencies&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies&quot;, st);
2630   // min and max should be in the Available range but still print them (not all info might be available for all kernels)
2631   if (ExtensiveErrorReports) {
2632     _print_ascii_file_h(&quot;Maximum cpu frequency&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq&quot;, st);
2633     _print_ascii_file_h(&quot;Minimum cpu frequency&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_min_freq&quot;, st);
2634     _print_ascii_file_h(&quot;Current cpu frequency&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq&quot;, st);
2635   }
2636   // governors are power schemes, see https://wiki.archlinux.org/index.php/CPU_frequency_scaling
2637   if (ExtensiveErrorReports) {
2638     _print_ascii_file_h(&quot;Available governors&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors&quot;, st);
2639   }
2640   _print_ascii_file_h(&quot;Current governor&quot;, &quot;/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor&quot;, st);
2641   // Core performance boost, see https://www.kernel.org/doc/Documentation/cpu-freq/boost.txt
2642   // Raise operating frequency of some cores in a multi-core package if certain conditions apply, e.g.
2643   // whole chip is not fully utilized
2644   _print_ascii_file_h(&quot;Core performance/turbo boost&quot;, &quot;/sys/devices/system/cpu/cpufreq/boost&quot;, st);
2645 #endif
2646 }
2647 
2648 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
2649   // Only print the model name if the platform provides this as a summary
2650   if (!print_model_name_and_flags(st, buf, buflen)) {
2651     _print_ascii_file_h(&quot;/proc/cpuinfo&quot;, &quot;/proc/cpuinfo&quot;, st, false);
2652   }
2653   st-&gt;cr();
2654   print_sys_devices_cpu_info(st, buf, buflen);
2655 }
2656 
2657 #if defined(AMD64) || defined(IA32) || defined(X32)
2658 const char* search_string = &quot;model name&quot;;
2659 #elif defined(M68K)
2660 const char* search_string = &quot;CPU&quot;;
2661 #elif defined(PPC64)
2662 const char* search_string = &quot;cpu&quot;;
2663 #elif defined(S390)
2664 const char* search_string = &quot;machine =&quot;;
2665 #elif defined(SPARC)
2666 const char* search_string = &quot;cpu&quot;;
2667 #else
2668 const char* search_string = &quot;Processor&quot;;
2669 #endif
2670 
2671 // Parses the cpuinfo file for string representing the model name.
2672 void os::get_summary_cpu_info(char* cpuinfo, size_t length) {
2673   FILE* fp = fopen(&quot;/proc/cpuinfo&quot;, &quot;r&quot;);
2674   if (fp != NULL) {
2675     while (!feof(fp)) {
2676       char buf[256];
2677       if (fgets(buf, sizeof(buf), fp)) {
2678         char* start = strstr(buf, search_string);
2679         if (start != NULL) {
2680           char *ptr = start + strlen(search_string);
2681           char *end = buf + strlen(buf);
2682           while (ptr != end) {
2683              // skip whitespace and colon for the rest of the name.
2684              if (*ptr != &#39; &#39; &amp;&amp; *ptr != &#39;\t&#39; &amp;&amp; *ptr != &#39;:&#39;) {
2685                break;
2686              }
2687              ptr++;
2688           }
2689           if (ptr != end) {
2690             // reasonable string, get rid of newline and keep the rest
2691             char* nl = strchr(buf, &#39;\n&#39;);
2692             if (nl != NULL) *nl = &#39;\0&#39;;
2693             strncpy(cpuinfo, ptr, length);
2694             fclose(fp);
2695             return;
2696           }
2697         }
2698       }
2699     }
2700     fclose(fp);
2701   }
2702   // cpuinfo not found or parsing failed, just print generic string.  The entire
2703   // /proc/cpuinfo file will be printed later in the file (or enough of it for x86)
2704 #if   defined(AARCH64)
2705   strncpy(cpuinfo, &quot;AArch64&quot;, length);
2706 #elif defined(AMD64)
2707   strncpy(cpuinfo, &quot;x86_64&quot;, length);
2708 #elif defined(ARM)  // Order wrt. AARCH64 is relevant!
2709   strncpy(cpuinfo, &quot;ARM&quot;, length);
2710 #elif defined(IA32)
2711   strncpy(cpuinfo, &quot;x86_32&quot;, length);
2712 #elif defined(IA64)
2713   strncpy(cpuinfo, &quot;IA64&quot;, length);
2714 #elif defined(PPC)
2715   strncpy(cpuinfo, &quot;PPC64&quot;, length);
2716 #elif defined(S390)
2717   strncpy(cpuinfo, &quot;S390&quot;, length);
2718 #elif defined(SPARC)
2719   strncpy(cpuinfo, &quot;sparcv9&quot;, length);
2720 #elif defined(ZERO_LIBARCH)
2721   strncpy(cpuinfo, ZERO_LIBARCH, length);
2722 #else
2723   strncpy(cpuinfo, &quot;unknown&quot;, length);
2724 #endif
2725 }
2726 
2727 static void print_signal_handler(outputStream* st, int sig,
2728                                  char* buf, size_t buflen);
2729 
2730 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
2731   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
2732   print_signal_handler(st, SIGSEGV, buf, buflen);
2733   print_signal_handler(st, SIGBUS , buf, buflen);
2734   print_signal_handler(st, SIGFPE , buf, buflen);
2735   print_signal_handler(st, SIGPIPE, buf, buflen);
2736   print_signal_handler(st, SIGXFSZ, buf, buflen);
2737   print_signal_handler(st, SIGILL , buf, buflen);
2738   print_signal_handler(st, SR_signum, buf, buflen);
2739   print_signal_handler(st, SHUTDOWN1_SIGNAL, buf, buflen);
2740   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
2741   print_signal_handler(st, SHUTDOWN3_SIGNAL , buf, buflen);
2742   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
2743 #if defined(PPC64)
2744   print_signal_handler(st, SIGTRAP, buf, buflen);
2745 #endif
2746 }
2747 
2748 static char saved_jvm_path[MAXPATHLEN] = {0};
2749 
2750 // Find the full path to the current module, libjvm.so
2751 void os::jvm_path(char *buf, jint buflen) {
2752   // Error checking.
2753   if (buflen &lt; MAXPATHLEN) {
2754     assert(false, &quot;must use a large-enough buffer&quot;);
2755     buf[0] = &#39;\0&#39;;
2756     return;
2757   }
2758   // Lazy resolve the path to current module.
2759   if (saved_jvm_path[0] != 0) {
2760     strcpy(buf, saved_jvm_path);
2761     return;
2762   }
2763 
2764   char dli_fname[MAXPATHLEN];
2765   bool ret = dll_address_to_library_name(
2766                                          CAST_FROM_FN_PTR(address, os::jvm_path),
2767                                          dli_fname, sizeof(dli_fname), NULL);
2768   assert(ret, &quot;cannot locate libjvm&quot;);
2769   char *rp = NULL;
2770   if (ret &amp;&amp; dli_fname[0] != &#39;\0&#39;) {
2771     rp = os::Posix::realpath(dli_fname, buf, buflen);
2772   }
2773   if (rp == NULL) {
2774     return;
2775   }
2776 
2777   if (Arguments::sun_java_launcher_is_altjvm()) {
2778     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
2779     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;vmtype&gt;/libjvm.so&quot;.
2780     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
2781     // assume we are installed in a JDK and we&#39;re done. Otherwise, check
2782     // for a JAVA_HOME environment variable and fix up the path so it
2783     // looks like libjvm.so is installed there (append a fake suffix
2784     // hotspot/libjvm.so).
2785     const char *p = buf + strlen(buf) - 1;
2786     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
2787       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
2788         /* empty */ ;
2789     }
2790 
2791     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
2792       // Look for JAVA_HOME in the environment.
2793       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
2794       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
2795         char* jrelib_p;
2796         int len;
2797 
2798         // Check the current module name &quot;libjvm.so&quot;.
2799         p = strrchr(buf, &#39;/&#39;);
2800         if (p == NULL) {
2801           return;
2802         }
2803         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
2804 
2805         rp = os::Posix::realpath(java_home_var, buf, buflen);
2806         if (rp == NULL) {
2807           return;
2808         }
2809 
2810         // determine if this is a legacy image or modules image
2811         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
2812         len = strlen(buf);
2813         assert(len &lt; buflen, &quot;Ran out of buffer room&quot;);
2814         jrelib_p = buf + len;
2815         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
2816         if (0 != access(buf, F_OK)) {
2817           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
2818         }
2819 
2820         if (0 == access(buf, F_OK)) {
2821           // Use current module name &quot;libjvm.so&quot;
2822           len = strlen(buf);
2823           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
2824         } else {
2825           // Go back to path of .so
2826           rp = os::Posix::realpath(dli_fname, buf, buflen);
2827           if (rp == NULL) {
2828             return;
2829           }
2830         }
2831       }
2832     }
2833   }
2834 
2835   strncpy(saved_jvm_path, buf, MAXPATHLEN);
2836   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
2837 }
2838 
2839 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
2840   // no prefix required, not even &quot;_&quot;
2841 }
2842 
2843 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
2844   // no suffix required
2845 }
2846 
2847 ////////////////////////////////////////////////////////////////////////////////
2848 // sun.misc.Signal support
2849 
2850 static void UserHandler(int sig, void *siginfo, void *context) {
2851   // Ctrl-C is pressed during error reporting, likely because the error
2852   // handler fails to abort. Let VM die immediately.
2853   if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
2854     os::die();
2855   }
2856 
2857   os::signal_notify(sig);
2858 }
2859 
2860 void* os::user_handler() {
2861   return CAST_FROM_FN_PTR(void*, UserHandler);
2862 }
2863 
2864 extern &quot;C&quot; {
2865   typedef void (*sa_handler_t)(int);
2866   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
2867 }
2868 
2869 void* os::signal(int signal_number, void* handler) {
2870   struct sigaction sigAct, oldSigAct;
2871 
2872   sigfillset(&amp;(sigAct.sa_mask));
2873   sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;
2874   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
2875 
2876   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
2877     // -1 means registration failed
2878     return (void *)-1;
2879   }
2880 
2881   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
2882 }
2883 
2884 void os::signal_raise(int signal_number) {
2885   ::raise(signal_number);
2886 }
2887 
2888 // The following code is moved from os.cpp for making this
2889 // code platform specific, which it is by its very nature.
2890 
2891 // Will be modified when max signal is changed to be dynamic
2892 int os::sigexitnum_pd() {
2893   return NSIG;
2894 }
2895 
2896 // a counter for each possible signal value
2897 static volatile jint pending_signals[NSIG+1] = { 0 };
2898 
2899 // Linux(POSIX) specific hand shaking semaphore.
2900 static Semaphore* sig_sem = NULL;
2901 static PosixSemaphore sr_semaphore;
2902 
2903 static void jdk_misc_signal_init() {
2904   // Initialize signal structures
2905   ::memset((void*)pending_signals, 0, sizeof(pending_signals));
2906 
2907   // Initialize signal semaphore
2908   sig_sem = new Semaphore();
2909 }
2910 
2911 void os::signal_notify(int sig) {
2912   if (sig_sem != NULL) {
2913     Atomic::inc(&amp;pending_signals[sig]);
2914     sig_sem-&gt;signal();
2915   } else {
2916     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
2917     // initialization isn&#39;t called.
2918     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
2919   }
2920 }
2921 
2922 static int check_pending_signals() {
2923   for (;;) {
2924     for (int i = 0; i &lt; NSIG + 1; i++) {
2925       jint n = pending_signals[i];
2926       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
2927         return i;
2928       }
2929     }
2930     JavaThread *thread = JavaThread::current();
2931     ThreadBlockInVM tbivm(thread);
2932 
2933     bool threadIsSuspended;
2934     do {
2935       thread-&gt;set_suspend_equivalent();
2936       // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
2937       sig_sem-&gt;wait();
2938 
2939       // were we externally suspended while we were waiting?
2940       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
2941       if (threadIsSuspended) {
2942         // The semaphore has been incremented, but while we were waiting
2943         // another thread suspended us. We don&#39;t want to continue running
2944         // while suspended because that would surprise the thread that
2945         // suspended us.
2946         sig_sem-&gt;signal();
2947 
2948         thread-&gt;java_suspend_self();
2949       }
2950     } while (threadIsSuspended);
2951   }
2952 }
2953 
2954 int os::signal_wait() {
2955   return check_pending_signals();
2956 }
2957 
2958 ////////////////////////////////////////////////////////////////////////////////
2959 // Virtual Memory
2960 
2961 int os::vm_page_size() {
2962   // Seems redundant as all get out
2963   assert(os::Linux::page_size() != -1, &quot;must call os::init&quot;);
2964   return os::Linux::page_size();
2965 }
2966 
2967 // Solaris allocates memory by pages.
2968 int os::vm_allocation_granularity() {
2969   assert(os::Linux::page_size() != -1, &quot;must call os::init&quot;);
2970   return os::Linux::page_size();
2971 }
2972 
2973 // Rationale behind this function:
2974 //  current (Mon Apr 25 20:12:18 MSD 2005) oprofile drops samples without executable
2975 //  mapping for address (see lookup_dcookie() in the kernel module), thus we cannot get
2976 //  samples for JITted code. Here we create private executable mapping over the code cache
2977 //  and then we can use standard (well, almost, as mapping can change) way to provide
2978 //  info for the reporting script by storing timestamp and location of symbol
2979 void linux_wrap_code(char* base, size_t size) {
2980   static volatile jint cnt = 0;
2981 
2982   if (!UseOprofile) {
2983     return;
2984   }
2985 
2986   char buf[PATH_MAX+1];
2987   int num = Atomic::add(&amp;cnt, 1);
2988 
2989   snprintf(buf, sizeof(buf), &quot;%s/hs-vm-%d-%d&quot;,
2990            os::get_temp_directory(), os::current_process_id(), num);
2991   unlink(buf);
2992 
2993   int fd = ::open(buf, O_CREAT | O_RDWR, S_IRWXU);
2994 
2995   if (fd != -1) {
2996     off_t rv = ::lseek(fd, size-2, SEEK_SET);
2997     if (rv != (off_t)-1) {
2998       if (::write(fd, &quot;&quot;, 1) == 1) {
2999         mmap(base, size,
3000              PROT_READ|PROT_WRITE|PROT_EXEC,
3001              MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE, fd, 0);
3002       }
3003     }
3004     ::close(fd);
3005     unlink(buf);
3006   }
3007 }
3008 
3009 static bool recoverable_mmap_error(int err) {
3010   // See if the error is one we can let the caller handle. This
3011   // list of errno values comes from JBS-6843484. I can&#39;t find a
3012   // Linux man page that documents this specific set of errno
3013   // values so while this list currently matches Solaris, it may
3014   // change as we gain experience with this failure mode.
3015   switch (err) {
3016   case EBADF:
3017   case EINVAL:
3018   case ENOTSUP:
3019     // let the caller deal with these errors
3020     return true;
3021 
3022   default:
3023     // Any remaining errors on this OS can cause our reserved mapping
3024     // to be lost. That can cause confusion where different data
3025     // structures think they have the same memory mapped. The worst
3026     // scenario is if both the VM and a library think they have the
3027     // same memory mapped.
3028     return false;
3029   }
3030 }
3031 
3032 static void warn_fail_commit_memory(char* addr, size_t size, bool exec,
3033                                     int err) {
3034   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
3035           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, p2i(addr), size, exec,
3036           os::strerror(err), err);
3037 }
3038 
3039 static void warn_fail_commit_memory(char* addr, size_t size,
3040                                     size_t alignment_hint, bool exec,
3041                                     int err) {
3042   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
3043           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, p2i(addr), size,
3044           alignment_hint, exec, os::strerror(err), err);
3045 }
3046 
3047 // NOTE: Linux kernel does not really reserve the pages for us.
3048 //       All it does is to check if there are enough free pages
3049 //       left at the time of mmap(). This could be a potential
3050 //       problem.
3051 int os::Linux::commit_memory_impl(char* addr, size_t size, bool exec) {
3052   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
3053   uintptr_t res = (uintptr_t) ::mmap(addr, size, prot,
3054                                      MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0);
3055   if (res != (uintptr_t) MAP_FAILED) {
3056     if (UseNUMAInterleaving) {
3057       numa_make_global(addr, size);
3058     }
3059     return 0;
3060   }
3061 
3062   int err = errno;  // save errno from mmap() call above
3063 
3064   if (!recoverable_mmap_error(err)) {
3065     warn_fail_commit_memory(addr, size, exec, err);
3066     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
3067   }
3068 
3069   return err;
3070 }
3071 
3072 bool os::pd_commit_memory(char* addr, size_t size, bool exec) {
3073   return os::Linux::commit_memory_impl(addr, size, exec) == 0;
3074 }
3075 
3076 void os::pd_commit_memory_or_exit(char* addr, size_t size, bool exec,
3077                                   const char* mesg) {
3078   assert(mesg != NULL, &quot;mesg must be specified&quot;);
3079   int err = os::Linux::commit_memory_impl(addr, size, exec);
3080   if (err != 0) {
3081     // the caller wants all commit errors to exit with the specified mesg:
3082     warn_fail_commit_memory(addr, size, exec, err);
3083     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
3084   }
3085 }
3086 
3087 // Define MAP_HUGETLB here so we can build HotSpot on old systems.
3088 #ifndef MAP_HUGETLB
3089   #define MAP_HUGETLB 0x40000
3090 #endif
3091 
3092 // If mmap flags are set with MAP_HUGETLB and the system supports multiple
3093 // huge page sizes, flag bits [26:31] can be used to encode the log2 of the
3094 // desired huge page size. Otherwise, the system&#39;s default huge page size will be used.
3095 // See mmap(2) man page for more info (since Linux 3.8).
3096 // https://lwn.net/Articles/533499/
3097 #ifndef MAP_HUGE_SHIFT
3098   #define MAP_HUGE_SHIFT 26
3099 #endif
3100 
3101 // Define MADV_HUGEPAGE here so we can build HotSpot on old systems.
3102 #ifndef MADV_HUGEPAGE
3103   #define MADV_HUGEPAGE 14
3104 #endif
3105 
3106 int os::Linux::commit_memory_impl(char* addr, size_t size,
3107                                   size_t alignment_hint, bool exec) {
3108   int err = os::Linux::commit_memory_impl(addr, size, exec);
3109   if (err == 0) {
3110     realign_memory(addr, size, alignment_hint);
3111   }
3112   return err;
3113 }
3114 
3115 bool os::pd_commit_memory(char* addr, size_t size, size_t alignment_hint,
3116                           bool exec) {
3117   return os::Linux::commit_memory_impl(addr, size, alignment_hint, exec) == 0;
3118 }
3119 
3120 void os::pd_commit_memory_or_exit(char* addr, size_t size,
3121                                   size_t alignment_hint, bool exec,
3122                                   const char* mesg) {
3123   assert(mesg != NULL, &quot;mesg must be specified&quot;);
3124   int err = os::Linux::commit_memory_impl(addr, size, alignment_hint, exec);
3125   if (err != 0) {
3126     // the caller wants all commit errors to exit with the specified mesg:
3127     warn_fail_commit_memory(addr, size, alignment_hint, exec, err);
3128     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
3129   }
3130 }
3131 
3132 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
3133   if (UseTransparentHugePages &amp;&amp; alignment_hint &gt; (size_t)vm_page_size()) {
3134     // We don&#39;t check the return value: madvise(MADV_HUGEPAGE) may not
3135     // be supported or the memory may already be backed by huge pages.
3136     ::madvise(addr, bytes, MADV_HUGEPAGE);
3137   }
3138 }
3139 
3140 void os::pd_free_memory(char *addr, size_t bytes, size_t alignment_hint) {
3141   // This method works by doing an mmap over an existing mmaping and effectively discarding
3142   // the existing pages. However it won&#39;t work for SHM-based large pages that cannot be
3143   // uncommitted at all. We don&#39;t do anything in this case to avoid creating a segment with
3144   // small pages on top of the SHM segment. This method always works for small pages, so we
3145   // allow that in any case.
3146   if (alignment_hint &lt;= (size_t)os::vm_page_size() || can_commit_large_page_memory()) {
3147     commit_memory(addr, bytes, alignment_hint, !ExecMem);
3148   }
3149 }
3150 
3151 void os::numa_make_global(char *addr, size_t bytes) {
3152   Linux::numa_interleave_memory(addr, bytes);
3153 }
3154 
3155 // Define for numa_set_bind_policy(int). Setting the argument to 0 will set the
3156 // bind policy to MPOL_PREFERRED for the current thread.
3157 #define USE_MPOL_PREFERRED 0
3158 
3159 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
3160   // To make NUMA and large pages more robust when both enabled, we need to ease
3161   // the requirements on where the memory should be allocated. MPOL_BIND is the
3162   // default policy and it will force memory to be allocated on the specified
3163   // node. Changing this to MPOL_PREFERRED will prefer to allocate the memory on
3164   // the specified node, but will not force it. Using this policy will prevent
3165   // getting SIGBUS when trying to allocate large pages on NUMA nodes with no
3166   // free large pages.
3167   Linux::numa_set_bind_policy(USE_MPOL_PREFERRED);
3168   Linux::numa_tonode_memory(addr, bytes, lgrp_hint);
3169 }
3170 
3171 bool os::numa_topology_changed() { return false; }
3172 
3173 size_t os::numa_get_groups_num() {
3174   // Return just the number of nodes in which it&#39;s possible to allocate memory
3175   // (in numa terminology, configured nodes).
3176   return Linux::numa_num_configured_nodes();
3177 }
3178 
3179 int os::numa_get_group_id() {
3180   int cpu_id = Linux::sched_getcpu();
3181   if (cpu_id != -1) {
3182     int lgrp_id = Linux::get_node_by_cpu(cpu_id);
3183     if (lgrp_id != -1) {
3184       return lgrp_id;
3185     }
3186   }
3187   return 0;
3188 }
3189 
3190 int os::numa_get_group_id_for_address(const void* address) {
3191   void** pages = const_cast&lt;void**&gt;(&amp;address);
3192   int id = -1;
3193 
3194   if (os::Linux::numa_move_pages(0, 1, pages, NULL, &amp;id, 0) == -1) {
3195     return -1;
3196   }
3197   if (id &lt; 0) {
3198     return -1;
3199   }
3200   return id;
3201 }
3202 
3203 int os::Linux::get_existing_num_nodes() {
3204   int node;
3205   int highest_node_number = Linux::numa_max_node();
3206   int num_nodes = 0;
3207 
3208   // Get the total number of nodes in the system including nodes without memory.
3209   for (node = 0; node &lt;= highest_node_number; node++) {
3210     if (is_node_in_existing_nodes(node)) {
3211       num_nodes++;
3212     }
3213   }
3214   return num_nodes;
3215 }
3216 
3217 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
3218   int highest_node_number = Linux::numa_max_node();
3219   size_t i = 0;
3220 
3221   // Map all node ids in which it is possible to allocate memory. Also nodes are
3222   // not always consecutively available, i.e. available from 0 to the highest
3223   // node number. If the nodes have been bound explicitly using numactl membind,
3224   // then allocate memory from those nodes only.
3225   for (int node = 0; node &lt;= highest_node_number; node++) {
3226     if (Linux::is_node_in_bound_nodes((unsigned int)node)) {
3227       ids[i++] = node;
3228     }
3229   }
3230   return i;
3231 }
3232 
3233 bool os::get_page_info(char *start, page_info* info) {
3234   return false;
3235 }
3236 
3237 char *os::scan_pages(char *start, char* end, page_info* page_expected,
3238                      page_info* page_found) {
3239   return end;
3240 }
3241 
3242 
3243 int os::Linux::sched_getcpu_syscall(void) {
3244   unsigned int cpu = 0;
3245   int retval = -1;
3246 
3247 #if defined(IA32)
3248   #ifndef SYS_getcpu
3249     #define SYS_getcpu 318
3250   #endif
3251   retval = syscall(SYS_getcpu, &amp;cpu, NULL, NULL);
3252 #elif defined(AMD64)
3253 // Unfortunately we have to bring all these macros here from vsyscall.h
3254 // to be able to compile on old linuxes.
3255   #define __NR_vgetcpu 2
3256   #define VSYSCALL_START (-10UL &lt;&lt; 20)
3257   #define VSYSCALL_SIZE 1024
3258   #define VSYSCALL_ADDR(vsyscall_nr) (VSYSCALL_START+VSYSCALL_SIZE*(vsyscall_nr))
3259   typedef long (*vgetcpu_t)(unsigned int *cpu, unsigned int *node, unsigned long *tcache);
3260   vgetcpu_t vgetcpu = (vgetcpu_t)VSYSCALL_ADDR(__NR_vgetcpu);
3261   retval = vgetcpu(&amp;cpu, NULL, NULL);
3262 #endif
3263 
3264   return (retval == -1) ? retval : cpu;
3265 }
3266 
3267 void os::Linux::sched_getcpu_init() {
3268   // sched_getcpu() should be in libc.
3269   set_sched_getcpu(CAST_TO_FN_PTR(sched_getcpu_func_t,
3270                                   dlsym(RTLD_DEFAULT, &quot;sched_getcpu&quot;)));
3271 
3272   // If it&#39;s not, try a direct syscall.
3273   if (sched_getcpu() == -1) {
3274     set_sched_getcpu(CAST_TO_FN_PTR(sched_getcpu_func_t,
3275                                     (void*)&amp;sched_getcpu_syscall));
3276   }
3277 
3278   if (sched_getcpu() == -1) {
3279     vm_exit_during_initialization(&quot;getcpu(2) system call not supported by kernel&quot;);
3280   }
3281 }
3282 
3283 // Something to do with the numa-aware allocator needs these symbols
3284 extern &quot;C&quot; JNIEXPORT void numa_warn(int number, char *where, ...) { }
3285 extern &quot;C&quot; JNIEXPORT void numa_error(char *where) { }
3286 
<a name="6" id="anc6"></a>



















3287 // Handle request to load libnuma symbol version 1.1 (API v1). If it fails
3288 // load symbol from base version instead.
3289 void* os::Linux::libnuma_dlsym(void* handle, const char *name) {
<a name="7" id="anc7"></a><span class="line-modified">3290   void *f = dlvsym(handle, name, &quot;libnuma_1.1&quot;);</span>
<span class="line-added">3291   if (f == NULL) {</span>
<span class="line-added">3292     f = dlsym(handle, name);</span>
<span class="line-added">3293   }</span>
<span class="line-added">3294   return f;</span>
3295 }
3296 
3297 // Handle request to load libnuma symbol version 1.2 (API v2) only.
3298 // Return NULL if the symbol is not defined in this particular version.
3299 void* os::Linux::libnuma_v2_dlsym(void* handle, const char* name) {
<a name="8" id="anc8"></a><span class="line-modified">3300   return dlvsym(handle, name, &quot;libnuma_1.2&quot;);</span>
3301 }
3302 
3303 bool os::Linux::libnuma_init() {
3304   if (sched_getcpu() != -1) { // Requires sched_getcpu() support
3305     void *handle = dlopen(&quot;libnuma.so.1&quot;, RTLD_LAZY);
3306     if (handle != NULL) {
3307       set_numa_node_to_cpus(CAST_TO_FN_PTR(numa_node_to_cpus_func_t,
3308                                            libnuma_dlsym(handle, &quot;numa_node_to_cpus&quot;)));
<a name="9" id="anc9"></a><span class="line-added">3309       set_numa_node_to_cpus_v2(CAST_TO_FN_PTR(numa_node_to_cpus_v2_func_t,</span>
<span class="line-added">3310                                               libnuma_v2_dlsym(handle, &quot;numa_node_to_cpus&quot;)));</span>
3311       set_numa_max_node(CAST_TO_FN_PTR(numa_max_node_func_t,
3312                                        libnuma_dlsym(handle, &quot;numa_max_node&quot;)));
3313       set_numa_num_configured_nodes(CAST_TO_FN_PTR(numa_num_configured_nodes_func_t,
3314                                                    libnuma_dlsym(handle, &quot;numa_num_configured_nodes&quot;)));
3315       set_numa_available(CAST_TO_FN_PTR(numa_available_func_t,
3316                                         libnuma_dlsym(handle, &quot;numa_available&quot;)));
3317       set_numa_tonode_memory(CAST_TO_FN_PTR(numa_tonode_memory_func_t,
3318                                             libnuma_dlsym(handle, &quot;numa_tonode_memory&quot;)));
3319       set_numa_interleave_memory(CAST_TO_FN_PTR(numa_interleave_memory_func_t,
3320                                                 libnuma_dlsym(handle, &quot;numa_interleave_memory&quot;)));
3321       set_numa_interleave_memory_v2(CAST_TO_FN_PTR(numa_interleave_memory_v2_func_t,
3322                                                 libnuma_v2_dlsym(handle, &quot;numa_interleave_memory&quot;)));
3323       set_numa_set_bind_policy(CAST_TO_FN_PTR(numa_set_bind_policy_func_t,
3324                                               libnuma_dlsym(handle, &quot;numa_set_bind_policy&quot;)));
3325       set_numa_bitmask_isbitset(CAST_TO_FN_PTR(numa_bitmask_isbitset_func_t,
3326                                                libnuma_dlsym(handle, &quot;numa_bitmask_isbitset&quot;)));
3327       set_numa_distance(CAST_TO_FN_PTR(numa_distance_func_t,
3328                                        libnuma_dlsym(handle, &quot;numa_distance&quot;)));
3329       set_numa_get_membind(CAST_TO_FN_PTR(numa_get_membind_func_t,
3330                                           libnuma_v2_dlsym(handle, &quot;numa_get_membind&quot;)));
3331       set_numa_get_interleave_mask(CAST_TO_FN_PTR(numa_get_interleave_mask_func_t,
3332                                                   libnuma_v2_dlsym(handle, &quot;numa_get_interleave_mask&quot;)));
3333       set_numa_move_pages(CAST_TO_FN_PTR(numa_move_pages_func_t,
3334                                          libnuma_dlsym(handle, &quot;numa_move_pages&quot;)));
3335       set_numa_set_preferred(CAST_TO_FN_PTR(numa_set_preferred_func_t,
3336                                             libnuma_dlsym(handle, &quot;numa_set_preferred&quot;)));
3337 
3338       if (numa_available() != -1) {
3339         set_numa_all_nodes((unsigned long*)libnuma_dlsym(handle, &quot;numa_all_nodes&quot;));
3340         set_numa_all_nodes_ptr((struct bitmask **)libnuma_dlsym(handle, &quot;numa_all_nodes_ptr&quot;));
3341         set_numa_nodes_ptr((struct bitmask **)libnuma_dlsym(handle, &quot;numa_nodes_ptr&quot;));
3342         set_numa_interleave_bitmask(_numa_get_interleave_mask());
3343         set_numa_membind_bitmask(_numa_get_membind());
3344         // Create an index -&gt; node mapping, since nodes are not always consecutive
3345         _nindex_to_node = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;int&gt;(0, mtInternal);
3346         rebuild_nindex_to_node_map();
3347         // Create a cpu -&gt; node mapping
3348         _cpu_to_node = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;int&gt;(0, mtInternal);
3349         rebuild_cpu_to_node_map();
3350         return true;
3351       }
3352     }
3353   }
3354   return false;
3355 }
3356 
3357 size_t os::Linux::default_guard_size(os::ThreadType thr_type) {
3358   // Creating guard page is very expensive. Java thread has HotSpot
3359   // guard pages, only enable glibc guard page for non-Java threads.
3360   // (Remember: compiler thread is a Java thread, too!)
3361   return ((thr_type == java_thread || thr_type == compiler_thread) ? 0 : page_size());
3362 }
3363 
3364 void os::Linux::rebuild_nindex_to_node_map() {
3365   int highest_node_number = Linux::numa_max_node();
3366 
3367   nindex_to_node()-&gt;clear();
3368   for (int node = 0; node &lt;= highest_node_number; node++) {
3369     if (Linux::is_node_in_existing_nodes(node)) {
3370       nindex_to_node()-&gt;append(node);
3371     }
3372   }
3373 }
3374 
3375 // rebuild_cpu_to_node_map() constructs a table mapping cpud id to node id.
3376 // The table is later used in get_node_by_cpu().
3377 void os::Linux::rebuild_cpu_to_node_map() {
3378   const size_t NCPUS = 32768; // Since the buffer size computation is very obscure
3379                               // in libnuma (possible values are starting from 16,
3380                               // and continuing up with every other power of 2, but less
3381                               // than the maximum number of CPUs supported by kernel), and
3382                               // is a subject to change (in libnuma version 2 the requirements
3383                               // are more reasonable) we&#39;ll just hardcode the number they use
3384                               // in the library.
3385   const size_t BitsPerCLong = sizeof(long) * CHAR_BIT;
3386 
3387   size_t cpu_num = processor_count();
3388   size_t cpu_map_size = NCPUS / BitsPerCLong;
3389   size_t cpu_map_valid_size =
3390     MIN2((cpu_num + BitsPerCLong - 1) / BitsPerCLong, cpu_map_size);
3391 
3392   cpu_to_node()-&gt;clear();
3393   cpu_to_node()-&gt;at_grow(cpu_num - 1);
3394 
3395   size_t node_num = get_existing_num_nodes();
3396 
3397   int distance = 0;
3398   int closest_distance = INT_MAX;
3399   int closest_node = 0;
3400   unsigned long *cpu_map = NEW_C_HEAP_ARRAY(unsigned long, cpu_map_size, mtInternal);
3401   for (size_t i = 0; i &lt; node_num; i++) {
3402     // Check if node is configured (not a memory-less node). If it is not, find
3403     // the closest configured node. Check also if node is bound, i.e. it&#39;s allowed
3404     // to allocate memory from the node. If it&#39;s not allowed, map cpus in that node
3405     // to the closest node from which memory allocation is allowed.
3406     if (!is_node_in_configured_nodes(nindex_to_node()-&gt;at(i)) ||
3407         !is_node_in_bound_nodes(nindex_to_node()-&gt;at(i))) {
3408       closest_distance = INT_MAX;
3409       // Check distance from all remaining nodes in the system. Ignore distance
3410       // from itself, from another non-configured node, and from another non-bound
3411       // node.
3412       for (size_t m = 0; m &lt; node_num; m++) {
3413         if (m != i &amp;&amp;
3414             is_node_in_configured_nodes(nindex_to_node()-&gt;at(m)) &amp;&amp;
3415             is_node_in_bound_nodes(nindex_to_node()-&gt;at(m))) {
3416           distance = numa_distance(nindex_to_node()-&gt;at(i), nindex_to_node()-&gt;at(m));
3417           // If a closest node is found, update. There is always at least one
3418           // configured and bound node in the system so there is always at least
3419           // one node close.
3420           if (distance != 0 &amp;&amp; distance &lt; closest_distance) {
3421             closest_distance = distance;
3422             closest_node = nindex_to_node()-&gt;at(m);
3423           }
3424         }
3425       }
3426      } else {
3427        // Current node is already a configured node.
3428        closest_node = nindex_to_node()-&gt;at(i);
3429      }
3430 
3431     // Get cpus from the original node and map them to the closest node. If node
3432     // is a configured node (not a memory-less node), then original node and
3433     // closest node are the same.
3434     if (numa_node_to_cpus(nindex_to_node()-&gt;at(i), cpu_map, cpu_map_size * sizeof(unsigned long)) != -1) {
3435       for (size_t j = 0; j &lt; cpu_map_valid_size; j++) {
3436         if (cpu_map[j] != 0) {
3437           for (size_t k = 0; k &lt; BitsPerCLong; k++) {
3438             if (cpu_map[j] &amp; (1UL &lt;&lt; k)) {
3439               cpu_to_node()-&gt;at_put(j * BitsPerCLong + k, closest_node);
3440             }
3441           }
3442         }
3443       }
3444     }
3445   }
3446   FREE_C_HEAP_ARRAY(unsigned long, cpu_map);
3447 }
3448 
3449 int os::Linux::get_node_by_cpu(int cpu_id) {
3450   if (cpu_to_node() != NULL &amp;&amp; cpu_id &gt;= 0 &amp;&amp; cpu_id &lt; cpu_to_node()-&gt;length()) {
3451     return cpu_to_node()-&gt;at(cpu_id);
3452   }
3453   return -1;
3454 }
3455 
3456 GrowableArray&lt;int&gt;* os::Linux::_cpu_to_node;
3457 GrowableArray&lt;int&gt;* os::Linux::_nindex_to_node;
3458 os::Linux::sched_getcpu_func_t os::Linux::_sched_getcpu;
3459 os::Linux::numa_node_to_cpus_func_t os::Linux::_numa_node_to_cpus;
<a name="10" id="anc10"></a><span class="line-added">3460 os::Linux::numa_node_to_cpus_v2_func_t os::Linux::_numa_node_to_cpus_v2;</span>
3461 os::Linux::numa_max_node_func_t os::Linux::_numa_max_node;
3462 os::Linux::numa_num_configured_nodes_func_t os::Linux::_numa_num_configured_nodes;
3463 os::Linux::numa_available_func_t os::Linux::_numa_available;
3464 os::Linux::numa_tonode_memory_func_t os::Linux::_numa_tonode_memory;
3465 os::Linux::numa_interleave_memory_func_t os::Linux::_numa_interleave_memory;
3466 os::Linux::numa_interleave_memory_v2_func_t os::Linux::_numa_interleave_memory_v2;
3467 os::Linux::numa_set_bind_policy_func_t os::Linux::_numa_set_bind_policy;
3468 os::Linux::numa_bitmask_isbitset_func_t os::Linux::_numa_bitmask_isbitset;
3469 os::Linux::numa_distance_func_t os::Linux::_numa_distance;
3470 os::Linux::numa_get_membind_func_t os::Linux::_numa_get_membind;
3471 os::Linux::numa_get_interleave_mask_func_t os::Linux::_numa_get_interleave_mask;
3472 os::Linux::numa_move_pages_func_t os::Linux::_numa_move_pages;
3473 os::Linux::numa_set_preferred_func_t os::Linux::_numa_set_preferred;
3474 os::Linux::NumaAllocationPolicy os::Linux::_current_numa_policy;
3475 unsigned long* os::Linux::_numa_all_nodes;
3476 struct bitmask* os::Linux::_numa_all_nodes_ptr;
3477 struct bitmask* os::Linux::_numa_nodes_ptr;
3478 struct bitmask* os::Linux::_numa_interleave_bitmask;
3479 struct bitmask* os::Linux::_numa_membind_bitmask;
3480 
3481 bool os::pd_uncommit_memory(char* addr, size_t size) {
3482   uintptr_t res = (uintptr_t) ::mmap(addr, size, PROT_NONE,
3483                                      MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, -1, 0);
3484   return res  != (uintptr_t) MAP_FAILED;
3485 }
3486 
3487 static address get_stack_commited_bottom(address bottom, size_t size) {
3488   address nbot = bottom;
3489   address ntop = bottom + size;
3490 
3491   size_t page_sz = os::vm_page_size();
3492   unsigned pages = size / page_sz;
3493 
3494   unsigned char vec[1];
3495   unsigned imin = 1, imax = pages + 1, imid;
3496   int mincore_return_value = 0;
3497 
3498   assert(imin &lt;= imax, &quot;Unexpected page size&quot;);
3499 
3500   while (imin &lt; imax) {
3501     imid = (imax + imin) / 2;
3502     nbot = ntop - (imid * page_sz);
3503 
3504     // Use a trick with mincore to check whether the page is mapped or not.
3505     // mincore sets vec to 1 if page resides in memory and to 0 if page
3506     // is swapped output but if page we are asking for is unmapped
3507     // it returns -1,ENOMEM
3508     mincore_return_value = mincore(nbot, page_sz, vec);
3509 
3510     if (mincore_return_value == -1) {
3511       // Page is not mapped go up
3512       // to find first mapped page
3513       if (errno != EAGAIN) {
3514         assert(errno == ENOMEM, &quot;Unexpected mincore errno&quot;);
3515         imax = imid;
3516       }
3517     } else {
3518       // Page is mapped go down
3519       // to find first not mapped page
3520       imin = imid + 1;
3521     }
3522   }
3523 
3524   nbot = nbot + page_sz;
3525 
3526   // Adjust stack bottom one page up if last checked page is not mapped
3527   if (mincore_return_value == -1) {
3528     nbot = nbot + page_sz;
3529   }
3530 
3531   return nbot;
3532 }
3533 
3534 bool os::committed_in_range(address start, size_t size, address&amp; committed_start, size_t&amp; committed_size) {
3535   int mincore_return_value;
3536   const size_t stripe = 1024;  // query this many pages each time
3537   unsigned char vec[stripe + 1];
3538   // set a guard
3539   vec[stripe] = &#39;X&#39;;
3540 
3541   const size_t page_sz = os::vm_page_size();
3542   size_t pages = size / page_sz;
3543 
3544   assert(is_aligned(start, page_sz), &quot;Start address must be page aligned&quot;);
3545   assert(is_aligned(size, page_sz), &quot;Size must be page aligned&quot;);
3546 
3547   committed_start = NULL;
3548 
3549   int loops = (pages + stripe - 1) / stripe;
3550   int committed_pages = 0;
3551   address loop_base = start;
3552   bool found_range = false;
3553 
3554   for (int index = 0; index &lt; loops &amp;&amp; !found_range; index ++) {
3555     assert(pages &gt; 0, &quot;Nothing to do&quot;);
3556     int pages_to_query = (pages &gt;= stripe) ? stripe : pages;
3557     pages -= pages_to_query;
3558 
3559     // Get stable read
3560     while ((mincore_return_value = mincore(loop_base, pages_to_query * page_sz, vec)) == -1 &amp;&amp; errno == EAGAIN);
3561 
3562     // During shutdown, some memory goes away without properly notifying NMT,
3563     // E.g. ConcurrentGCThread/WatcherThread can exit without deleting thread object.
3564     // Bailout and return as not committed for now.
3565     if (mincore_return_value == -1 &amp;&amp; errno == ENOMEM) {
3566       return false;
3567     }
3568 
3569     assert(vec[stripe] == &#39;X&#39;, &quot;overflow guard&quot;);
3570     assert(mincore_return_value == 0, &quot;Range must be valid&quot;);
3571     // Process this stripe
3572     for (int vecIdx = 0; vecIdx &lt; pages_to_query; vecIdx ++) {
3573       if ((vec[vecIdx] &amp; 0x01) == 0) { // not committed
3574         // End of current contiguous region
3575         if (committed_start != NULL) {
3576           found_range = true;
3577           break;
3578         }
3579       } else { // committed
3580         // Start of region
3581         if (committed_start == NULL) {
3582           committed_start = loop_base + page_sz * vecIdx;
3583         }
3584         committed_pages ++;
3585       }
3586     }
3587 
3588     loop_base += pages_to_query * page_sz;
3589   }
3590 
3591   if (committed_start != NULL) {
3592     assert(committed_pages &gt; 0, &quot;Must have committed region&quot;);
3593     assert(committed_pages &lt;= int(size / page_sz), &quot;Can not commit more than it has&quot;);
3594     assert(committed_start &gt;= start &amp;&amp; committed_start &lt; start + size, &quot;Out of range&quot;);
3595     committed_size = page_sz * committed_pages;
3596     return true;
3597   } else {
3598     assert(committed_pages == 0, &quot;Should not have committed region&quot;);
3599     return false;
3600   }
3601 }
3602 
3603 
3604 // Linux uses a growable mapping for the stack, and if the mapping for
3605 // the stack guard pages is not removed when we detach a thread the
3606 // stack cannot grow beyond the pages where the stack guard was
3607 // mapped.  If at some point later in the process the stack expands to
3608 // that point, the Linux kernel cannot expand the stack any further
3609 // because the guard pages are in the way, and a segfault occurs.
3610 //
3611 // However, it&#39;s essential not to split the stack region by unmapping
3612 // a region (leaving a hole) that&#39;s already part of the stack mapping,
3613 // so if the stack mapping has already grown beyond the guard pages at
3614 // the time we create them, we have to truncate the stack mapping.
3615 // So, we need to know the extent of the stack mapping when
3616 // create_stack_guard_pages() is called.
3617 
3618 // We only need this for stacks that are growable: at the time of
3619 // writing thread stacks don&#39;t use growable mappings (i.e. those
3620 // creeated with MAP_GROWSDOWN), and aren&#39;t marked &quot;[stack]&quot;, so this
3621 // only applies to the main thread.
3622 
3623 // If the (growable) stack mapping already extends beyond the point
3624 // where we&#39;re going to put our guard pages, truncate the mapping at
3625 // that point by munmap()ping it.  This ensures that when we later
3626 // munmap() the guard pages we don&#39;t leave a hole in the stack
3627 // mapping. This only affects the main/primordial thread
3628 
3629 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
3630   if (os::is_primordial_thread()) {
3631     // As we manually grow stack up to bottom inside create_attached_thread(),
3632     // it&#39;s likely that os::Linux::initial_thread_stack_bottom is mapped and
3633     // we don&#39;t need to do anything special.
3634     // Check it first, before calling heavy function.
3635     uintptr_t stack_extent = (uintptr_t) os::Linux::initial_thread_stack_bottom();
3636     unsigned char vec[1];
3637 
3638     if (mincore((address)stack_extent, os::vm_page_size(), vec) == -1) {
3639       // Fallback to slow path on all errors, including EAGAIN
3640       stack_extent = (uintptr_t) get_stack_commited_bottom(
3641                                                            os::Linux::initial_thread_stack_bottom(),
3642                                                            (size_t)addr - stack_extent);
3643     }
3644 
3645     if (stack_extent &lt; (uintptr_t)addr) {
3646       ::munmap((void*)stack_extent, (uintptr_t)(addr - stack_extent));
3647     }
3648   }
3649 
3650   return os::commit_memory(addr, size, !ExecMem);
3651 }
3652 
3653 // If this is a growable mapping, remove the guard pages entirely by
3654 // munmap()ping them.  If not, just call uncommit_memory(). This only
3655 // affects the main/primordial thread, but guard against future OS changes.
3656 // It&#39;s safe to always unmap guard pages for primordial thread because we
3657 // always place it right after end of the mapped region.
3658 
3659 bool os::remove_stack_guard_pages(char* addr, size_t size) {
3660   uintptr_t stack_extent, stack_base;
3661 
3662   if (os::is_primordial_thread()) {
3663     return ::munmap(addr, size) == 0;
3664   }
3665 
3666   return os::uncommit_memory(addr, size);
3667 }
3668 
3669 // If &#39;fixed&#39; is true, anon_mmap() will attempt to reserve anonymous memory
3670 // at &#39;requested_addr&#39;. If there are existing memory mappings at the same
3671 // location, however, they will be overwritten. If &#39;fixed&#39; is false,
3672 // &#39;requested_addr&#39; is only treated as a hint, the return value may or
3673 // may not start from the requested address. Unlike Linux mmap(), this
3674 // function returns NULL to indicate failure.
3675 static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {
3676   char * addr;
3677   int flags;
3678 
3679   flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;
3680   if (fixed) {
3681     assert((uintptr_t)requested_addr % os::Linux::page_size() == 0, &quot;unaligned address&quot;);
3682     flags |= MAP_FIXED;
3683   }
3684 
3685   // Map reserved/uncommitted pages PROT_NONE so we fail early if we
3686   // touch an uncommitted page. Otherwise, the read/write might
3687   // succeed if we have enough swap space to back the physical page.
3688   addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,
3689                        flags, -1, 0);
3690 
3691   return addr == MAP_FAILED ? NULL : addr;
3692 }
3693 
3694 // Allocate (using mmap, NO_RESERVE, with small pages) at either a given request address
3695 //   (req_addr != NULL) or with a given alignment.
3696 //  - bytes shall be a multiple of alignment.
3697 //  - req_addr can be NULL. If not NULL, it must be a multiple of alignment.
3698 //  - alignment sets the alignment at which memory shall be allocated.
3699 //     It must be a multiple of allocation granularity.
3700 // Returns address of memory or NULL. If req_addr was not NULL, will only return
3701 //  req_addr or NULL.
3702 static char* anon_mmap_aligned(size_t bytes, size_t alignment, char* req_addr) {
3703 
3704   size_t extra_size = bytes;
3705   if (req_addr == NULL &amp;&amp; alignment &gt; 0) {
3706     extra_size += alignment;
3707   }
3708 
3709   char* start = (char*) ::mmap(req_addr, extra_size, PROT_NONE,
3710     MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
3711     -1, 0);
3712   if (start == MAP_FAILED) {
3713     start = NULL;
3714   } else {
3715     if (req_addr != NULL) {
3716       if (start != req_addr) {
3717         ::munmap(start, extra_size);
3718         start = NULL;
3719       }
3720     } else {
3721       char* const start_aligned = align_up(start, alignment);
3722       char* const end_aligned = start_aligned + bytes;
3723       char* const end = start + extra_size;
3724       if (start_aligned &gt; start) {
3725         ::munmap(start, start_aligned - start);
3726       }
3727       if (end_aligned &lt; end) {
3728         ::munmap(end_aligned, end - end_aligned);
3729       }
3730       start = start_aligned;
3731     }
3732   }
3733   return start;
3734 }
3735 
3736 static int anon_munmap(char * addr, size_t size) {
3737   return ::munmap(addr, size) == 0;
3738 }
3739 
3740 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
3741                             size_t alignment_hint) {
3742   return anon_mmap(requested_addr, bytes, (requested_addr != NULL));
3743 }
3744 
3745 bool os::pd_release_memory(char* addr, size_t size) {
3746   return anon_munmap(addr, size);
3747 }
3748 
3749 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3750 extern char* g_assert_poison; // assertion poison page address
3751 #endif
3752 
3753 static bool linux_mprotect(char* addr, size_t size, int prot) {
3754   // Linux wants the mprotect address argument to be page aligned.
3755   char* bottom = (char*)align_down((intptr_t)addr, os::Linux::page_size());
3756 
3757   // According to SUSv3, mprotect() should only be used with mappings
3758   // established by mmap(), and mmap() always maps whole pages. Unaligned
3759   // &#39;addr&#39; likely indicates problem in the VM (e.g. trying to change
3760   // protection of malloc&#39;ed or statically allocated memory). Check the
3761   // caller if you hit this assert.
3762   assert(addr == bottom, &quot;sanity check&quot;);
3763 
3764   size = align_up(pointer_delta(addr, bottom, 1) + size, os::Linux::page_size());
3765   // Don&#39;t log anything if we&#39;re executing in the poison page signal handling
3766   // context. It can lead to reentrant use of other parts of the VM code.
3767 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3768   if (addr != g_assert_poison)
3769 #endif
3770   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(bottom), p2i(bottom+size), prot);
3771   return ::mprotect(bottom, size, prot) == 0;
3772 }
3773 
3774 // Set protections specified
3775 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
3776                         bool is_committed) {
3777   unsigned int p = 0;
3778   switch (prot) {
3779   case MEM_PROT_NONE: p = PROT_NONE; break;
3780   case MEM_PROT_READ: p = PROT_READ; break;
3781   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
3782   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
3783   default:
3784     ShouldNotReachHere();
3785   }
3786   // is_committed is unused.
3787   return linux_mprotect(addr, bytes, p);
3788 }
3789 
3790 bool os::guard_memory(char* addr, size_t size) {
3791   return linux_mprotect(addr, size, PROT_NONE);
3792 }
3793 
3794 bool os::unguard_memory(char* addr, size_t size) {
3795   return linux_mprotect(addr, size, PROT_READ|PROT_WRITE);
3796 }
3797 
3798 bool os::Linux::transparent_huge_pages_sanity_check(bool warn,
3799                                                     size_t page_size) {
3800   bool result = false;
3801   void *p = mmap(NULL, page_size * 2, PROT_READ|PROT_WRITE,
3802                  MAP_ANONYMOUS|MAP_PRIVATE,
3803                  -1, 0);
3804   if (p != MAP_FAILED) {
3805     void *aligned_p = align_up(p, page_size);
3806 
3807     result = madvise(aligned_p, page_size, MADV_HUGEPAGE) == 0;
3808 
3809     munmap(p, page_size * 2);
3810   }
3811 
3812   if (warn &amp;&amp; !result) {
3813     warning(&quot;TransparentHugePages is not supported by the operating system.&quot;);
3814   }
3815 
3816   return result;
3817 }
3818 
3819 bool os::Linux::hugetlbfs_sanity_check(bool warn, size_t page_size) {
3820   bool result = false;
3821   void *p = mmap(NULL, page_size, PROT_READ|PROT_WRITE,
3822                  MAP_ANONYMOUS|MAP_PRIVATE|MAP_HUGETLB,
3823                  -1, 0);
3824 
3825   if (p != MAP_FAILED) {
3826     // We don&#39;t know if this really is a huge page or not.
3827     FILE *fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);
3828     if (fp) {
3829       while (!feof(fp)) {
3830         char chars[257];
3831         long x = 0;
3832         if (fgets(chars, sizeof(chars), fp)) {
3833           if (sscanf(chars, &quot;%lx-%*x&quot;, &amp;x) == 1
3834               &amp;&amp; x == (long)p) {
3835             if (strstr (chars, &quot;hugepage&quot;)) {
3836               result = true;
3837               break;
3838             }
3839           }
3840         }
3841       }
3842       fclose(fp);
3843     }
3844     munmap(p, page_size);
3845   }
3846 
3847   if (warn &amp;&amp; !result) {
3848     warning(&quot;HugeTLBFS is not supported by the operating system.&quot;);
3849   }
3850 
3851   return result;
3852 }
3853 
3854 // From the coredump_filter documentation:
3855 //
3856 // - (bit 0) anonymous private memory
3857 // - (bit 1) anonymous shared memory
3858 // - (bit 2) file-backed private memory
3859 // - (bit 3) file-backed shared memory
3860 // - (bit 4) ELF header pages in file-backed private memory areas (it is
3861 //           effective only if the bit 2 is cleared)
3862 // - (bit 5) hugetlb private memory
3863 // - (bit 6) hugetlb shared memory
3864 // - (bit 7) dax private memory
3865 // - (bit 8) dax shared memory
3866 //
3867 static void set_coredump_filter(CoredumpFilterBit bit) {
3868   FILE *f;
3869   long cdm;
3870 
3871   if ((f = fopen(&quot;/proc/self/coredump_filter&quot;, &quot;r+&quot;)) == NULL) {
3872     return;
3873   }
3874 
3875   if (fscanf(f, &quot;%lx&quot;, &amp;cdm) != 1) {
3876     fclose(f);
3877     return;
3878   }
3879 
3880   long saved_cdm = cdm;
3881   rewind(f);
3882   cdm |= bit;
3883 
3884   if (cdm != saved_cdm) {
3885     fprintf(f, &quot;%#lx&quot;, cdm);
3886   }
3887 
3888   fclose(f);
3889 }
3890 
3891 // Large page support
3892 
3893 static size_t _large_page_size = 0;
3894 
3895 size_t os::Linux::find_default_large_page_size() {
3896   if (_default_large_page_size != 0) {
3897     return _default_large_page_size;
3898   }
3899   size_t large_page_size = 0;
3900 
3901   // large_page_size on Linux is used to round up heap size. x86 uses either
3902   // 2M or 4M page, depending on whether PAE (Physical Address Extensions)
3903   // mode is enabled. AMD64/EM64T uses 2M page in 64bit mode. IA64 can use
3904   // page as large as 256M.
3905   //
3906   // Here we try to figure out page size by parsing /proc/meminfo and looking
3907   // for a line with the following format:
3908   //    Hugepagesize:     2048 kB
3909   //
3910   // If we can&#39;t determine the value (e.g. /proc is not mounted, or the text
3911   // format has been changed), we&#39;ll use the largest page size supported by
3912   // the processor.
3913 
3914 #ifndef ZERO
3915   large_page_size =
3916     AARCH64_ONLY(2 * M)
3917     AMD64_ONLY(2 * M)
3918     ARM32_ONLY(2 * M)
3919     IA32_ONLY(4 * M)
3920     IA64_ONLY(256 * M)
3921     PPC_ONLY(4 * M)
3922     S390_ONLY(1 * M);
3923 #endif // ZERO
3924 
3925   FILE *fp = fopen(&quot;/proc/meminfo&quot;, &quot;r&quot;);
3926   if (fp) {
3927     while (!feof(fp)) {
3928       int x = 0;
3929       char buf[16];
3930       if (fscanf(fp, &quot;Hugepagesize: %d&quot;, &amp;x) == 1) {
3931         if (x &amp;&amp; fgets(buf, sizeof(buf), fp) &amp;&amp; strcmp(buf, &quot; kB\n&quot;) == 0) {
3932           large_page_size = x * K;
3933           break;
3934         }
3935       } else {
3936         // skip to next line
3937         for (;;) {
3938           int ch = fgetc(fp);
3939           if (ch == EOF || ch == (int)&#39;\n&#39;) break;
3940         }
3941       }
3942     }
3943     fclose(fp);
3944   }
3945   return large_page_size;
3946 }
3947 
3948 size_t os::Linux::find_large_page_size(size_t large_page_size) {
3949   if (_default_large_page_size == 0) {
3950     _default_large_page_size = Linux::find_default_large_page_size();
3951   }
3952   // We need to scan /sys/kernel/mm/hugepages
3953   // to discover the available page sizes
3954   const char* sys_hugepages = &quot;/sys/kernel/mm/hugepages&quot;;
3955 
3956   DIR *dir = opendir(sys_hugepages);
3957   if (dir == NULL) {
3958     return _default_large_page_size;
3959   }
3960 
3961   struct dirent *entry;
3962   size_t page_size;
3963   while ((entry = readdir(dir)) != NULL) {
3964     if (entry-&gt;d_type == DT_DIR &amp;&amp;
3965         sscanf(entry-&gt;d_name, &quot;hugepages-%zukB&quot;, &amp;page_size) == 1) {
3966       // The kernel is using kB, hotspot uses bytes
3967       if (large_page_size == page_size * K) {
3968         closedir(dir);
3969         return large_page_size;
3970       }
3971     }
3972   }
3973   closedir(dir);
3974   return _default_large_page_size;
3975 }
3976 
3977 size_t os::Linux::setup_large_page_size() {
3978   _default_large_page_size = Linux::find_default_large_page_size();
3979 
3980   if (!FLAG_IS_DEFAULT(LargePageSizeInBytes) &amp;&amp; LargePageSizeInBytes != _default_large_page_size ) {
3981     _large_page_size = find_large_page_size(LargePageSizeInBytes);
3982     if (_large_page_size == _default_large_page_size) {
3983       warning(&quot;Setting LargePageSizeInBytes=&quot; SIZE_FORMAT &quot; has no effect on this OS. Using the default large page size &quot;
3984               SIZE_FORMAT &quot;%s.&quot;,
3985               LargePageSizeInBytes,
3986               byte_size_in_proper_unit(_large_page_size), proper_unit_for_byte_size(_large_page_size));
3987     }
3988   } else {
3989     _large_page_size = _default_large_page_size;
3990   }
3991 
3992   const size_t default_page_size = (size_t)Linux::page_size();
3993   if (_large_page_size &gt; default_page_size) {
3994     _page_sizes[0] = _large_page_size;
3995     _page_sizes[1] = default_page_size;
3996     _page_sizes[2] = 0;
3997   }
3998 
3999   return _large_page_size;
4000 }
4001 
4002 size_t os::Linux::default_large_page_size() {
4003   return _default_large_page_size;
4004 }
4005 
4006 bool os::Linux::setup_large_page_type(size_t page_size) {
4007   if (FLAG_IS_DEFAULT(UseHugeTLBFS) &amp;&amp;
4008       FLAG_IS_DEFAULT(UseSHM) &amp;&amp;
4009       FLAG_IS_DEFAULT(UseTransparentHugePages)) {
4010 
4011     // The type of large pages has not been specified by the user.
4012 
4013     // Try UseHugeTLBFS and then UseSHM.
4014     UseHugeTLBFS = UseSHM = true;
4015 
4016     // Don&#39;t try UseTransparentHugePages since there are known
4017     // performance issues with it turned on. This might change in the future.
4018     UseTransparentHugePages = false;
4019   }
4020 
4021   if (UseTransparentHugePages) {
4022     bool warn_on_failure = !FLAG_IS_DEFAULT(UseTransparentHugePages);
4023     if (transparent_huge_pages_sanity_check(warn_on_failure, page_size)) {
4024       UseHugeTLBFS = false;
4025       UseSHM = false;
4026       return true;
4027     }
4028     UseTransparentHugePages = false;
4029   }
4030 
4031   if (UseHugeTLBFS) {
4032     bool warn_on_failure = !FLAG_IS_DEFAULT(UseHugeTLBFS);
4033     if (hugetlbfs_sanity_check(warn_on_failure, page_size)) {
4034       UseSHM = false;
4035       return true;
4036     }
4037     UseHugeTLBFS = false;
4038   }
4039 
4040   return UseSHM;
4041 }
4042 
4043 void os::large_page_init() {
4044   if (!UseLargePages &amp;&amp;
4045       !UseTransparentHugePages &amp;&amp;
4046       !UseHugeTLBFS &amp;&amp;
4047       !UseSHM) {
4048     // Not using large pages.
4049     return;
4050   }
4051 
4052   if (!FLAG_IS_DEFAULT(UseLargePages) &amp;&amp; !UseLargePages) {
4053     // The user explicitly turned off large pages.
4054     // Ignore the rest of the large pages flags.
4055     UseTransparentHugePages = false;
4056     UseHugeTLBFS = false;
4057     UseSHM = false;
4058     return;
4059   }
4060 
4061   size_t large_page_size = Linux::setup_large_page_size();
4062   UseLargePages          = Linux::setup_large_page_type(large_page_size);
4063 
4064   set_coredump_filter(LARGEPAGES_BIT);
4065 }
4066 
4067 #ifndef SHM_HUGETLB
4068   #define SHM_HUGETLB 04000
4069 #endif
4070 
4071 #define shm_warning_format(format, ...)              \
4072   do {                                               \
4073     if (UseLargePages &amp;&amp;                             \
4074         (!FLAG_IS_DEFAULT(UseLargePages) ||          \
4075          !FLAG_IS_DEFAULT(UseSHM) ||                 \
4076          !FLAG_IS_DEFAULT(LargePageSizeInBytes))) {  \
4077       warning(format, __VA_ARGS__);                  \
4078     }                                                \
4079   } while (0)
4080 
4081 #define shm_warning(str) shm_warning_format(&quot;%s&quot;, str)
4082 
4083 #define shm_warning_with_errno(str)                \
4084   do {                                             \
4085     int err = errno;                               \
4086     shm_warning_format(str &quot; (error = %d)&quot;, err);  \
4087   } while (0)
4088 
4089 static char* shmat_with_alignment(int shmid, size_t bytes, size_t alignment) {
4090   assert(is_aligned(bytes, alignment), &quot;Must be divisible by the alignment&quot;);
4091 
4092   if (!is_aligned(alignment, SHMLBA)) {
4093     assert(false, &quot;Code below assumes that alignment is at least SHMLBA aligned&quot;);
4094     return NULL;
4095   }
4096 
4097   // To ensure that we get &#39;alignment&#39; aligned memory from shmat,
4098   // we pre-reserve aligned virtual memory and then attach to that.
4099 
4100   char* pre_reserved_addr = anon_mmap_aligned(bytes, alignment, NULL);
4101   if (pre_reserved_addr == NULL) {
4102     // Couldn&#39;t pre-reserve aligned memory.
4103     shm_warning(&quot;Failed to pre-reserve aligned memory for shmat.&quot;);
4104     return NULL;
4105   }
4106 
4107   // SHM_REMAP is needed to allow shmat to map over an existing mapping.
4108   char* addr = (char*)shmat(shmid, pre_reserved_addr, SHM_REMAP);
4109 
4110   if ((intptr_t)addr == -1) {
4111     int err = errno;
4112     shm_warning_with_errno(&quot;Failed to attach shared memory.&quot;);
4113 
4114     assert(err != EACCES, &quot;Unexpected error&quot;);
4115     assert(err != EIDRM,  &quot;Unexpected error&quot;);
4116     assert(err != EINVAL, &quot;Unexpected error&quot;);
4117 
4118     // Since we don&#39;t know if the kernel unmapped the pre-reserved memory area
4119     // we can&#39;t unmap it, since that would potentially unmap memory that was
4120     // mapped from other threads.
4121     return NULL;
4122   }
4123 
4124   return addr;
4125 }
4126 
4127 static char* shmat_at_address(int shmid, char* req_addr) {
4128   if (!is_aligned(req_addr, SHMLBA)) {
4129     assert(false, &quot;Requested address needs to be SHMLBA aligned&quot;);
4130     return NULL;
4131   }
4132 
4133   char* addr = (char*)shmat(shmid, req_addr, 0);
4134 
4135   if ((intptr_t)addr == -1) {
4136     shm_warning_with_errno(&quot;Failed to attach shared memory.&quot;);
4137     return NULL;
4138   }
4139 
4140   return addr;
4141 }
4142 
4143 static char* shmat_large_pages(int shmid, size_t bytes, size_t alignment, char* req_addr) {
4144   // If a req_addr has been provided, we assume that the caller has already aligned the address.
4145   if (req_addr != NULL) {
4146     assert(is_aligned(req_addr, os::large_page_size()), &quot;Must be divisible by the large page size&quot;);
4147     assert(is_aligned(req_addr, alignment), &quot;Must be divisible by given alignment&quot;);
4148     return shmat_at_address(shmid, req_addr);
4149   }
4150 
4151   // Since shmid has been setup with SHM_HUGETLB, shmat will automatically
4152   // return large page size aligned memory addresses when req_addr == NULL.
4153   // However, if the alignment is larger than the large page size, we have
4154   // to manually ensure that the memory returned is &#39;alignment&#39; aligned.
4155   if (alignment &gt; os::large_page_size()) {
4156     assert(is_aligned(alignment, os::large_page_size()), &quot;Must be divisible by the large page size&quot;);
4157     return shmat_with_alignment(shmid, bytes, alignment);
4158   } else {
4159     return shmat_at_address(shmid, NULL);
4160   }
4161 }
4162 
4163 char* os::Linux::reserve_memory_special_shm(size_t bytes, size_t alignment,
4164                                             char* req_addr, bool exec) {
4165   // &quot;exec&quot; is passed in but not used.  Creating the shared image for
4166   // the code cache doesn&#39;t have an SHM_X executable permission to check.
4167   assert(UseLargePages &amp;&amp; UseSHM, &quot;only for SHM large pages&quot;);
4168   assert(is_aligned(req_addr, os::large_page_size()), &quot;Unaligned address&quot;);
4169   assert(is_aligned(req_addr, alignment), &quot;Unaligned address&quot;);
4170 
4171   if (!is_aligned(bytes, os::large_page_size())) {
4172     return NULL; // Fallback to small pages.
4173   }
4174 
4175   // Create a large shared memory region to attach to based on size.
4176   // Currently, size is the total size of the heap.
4177   int shmid = shmget(IPC_PRIVATE, bytes, SHM_HUGETLB|IPC_CREAT|SHM_R|SHM_W);
4178   if (shmid == -1) {
4179     // Possible reasons for shmget failure:
4180     // 1. shmmax is too small for Java heap.
4181     //    &gt; check shmmax value: cat /proc/sys/kernel/shmmax
4182     //    &gt; increase shmmax value: echo &quot;0xffffffff&quot; &gt; /proc/sys/kernel/shmmax
4183     // 2. not enough large page memory.
4184     //    &gt; check available large pages: cat /proc/meminfo
4185     //    &gt; increase amount of large pages:
4186     //          echo new_value &gt; /proc/sys/vm/nr_hugepages
4187     //      Note 1: different Linux may use different name for this property,
4188     //            e.g. on Redhat AS-3 it is &quot;hugetlb_pool&quot;.
4189     //      Note 2: it&#39;s possible there&#39;s enough physical memory available but
4190     //            they are so fragmented after a long run that they can&#39;t
4191     //            coalesce into large pages. Try to reserve large pages when
4192     //            the system is still &quot;fresh&quot;.
4193     shm_warning_with_errno(&quot;Failed to reserve shared memory.&quot;);
4194     return NULL;
4195   }
4196 
4197   // Attach to the region.
4198   char* addr = shmat_large_pages(shmid, bytes, alignment, req_addr);
4199 
4200   // Remove shmid. If shmat() is successful, the actual shared memory segment
4201   // will be deleted when it&#39;s detached by shmdt() or when the process
4202   // terminates. If shmat() is not successful this will remove the shared
4203   // segment immediately.
4204   shmctl(shmid, IPC_RMID, NULL);
4205 
4206   return addr;
4207 }
4208 
4209 static void warn_on_large_pages_failure(char* req_addr, size_t bytes,
4210                                         int error) {
4211   assert(error == ENOMEM, &quot;Only expect to fail if no memory is available&quot;);
4212 
4213   bool warn_on_failure = UseLargePages &amp;&amp;
4214       (!FLAG_IS_DEFAULT(UseLargePages) ||
4215        !FLAG_IS_DEFAULT(UseHugeTLBFS) ||
4216        !FLAG_IS_DEFAULT(LargePageSizeInBytes));
4217 
4218   if (warn_on_failure) {
4219     char msg[128];
4220     jio_snprintf(msg, sizeof(msg), &quot;Failed to reserve large pages memory req_addr: &quot;
4221                  PTR_FORMAT &quot; bytes: &quot; SIZE_FORMAT &quot; (errno = %d).&quot;, req_addr, bytes, error);
4222     warning(&quot;%s&quot;, msg);
4223   }
4224 }
4225 
4226 char* os::Linux::reserve_memory_special_huge_tlbfs_only(size_t bytes,
4227                                                         char* req_addr,
4228                                                         bool exec) {
4229   assert(UseLargePages &amp;&amp; UseHugeTLBFS, &quot;only for Huge TLBFS large pages&quot;);
4230   assert(is_aligned(bytes, os::large_page_size()), &quot;Unaligned size&quot;);
4231   assert(is_aligned(req_addr, os::large_page_size()), &quot;Unaligned address&quot;);
4232 
4233   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
4234   int flags = MAP_PRIVATE|MAP_ANONYMOUS|MAP_HUGETLB;
4235 
4236   if (os::large_page_size() != default_large_page_size()) {
4237     flags |= (exact_log2(os::large_page_size()) &lt;&lt; MAP_HUGE_SHIFT);
4238   }
4239   char* addr = (char*)::mmap(req_addr, bytes, prot, flags, -1, 0);
4240 
4241   if (addr == MAP_FAILED) {
4242     warn_on_large_pages_failure(req_addr, bytes, errno);
4243     return NULL;
4244   }
4245 
4246   assert(is_aligned(addr, os::large_page_size()), &quot;Must be&quot;);
4247 
4248   return addr;
4249 }
4250 
4251 // Reserve memory using mmap(MAP_HUGETLB).
4252 //  - bytes shall be a multiple of alignment.
4253 //  - req_addr can be NULL. If not NULL, it must be a multiple of alignment.
4254 //  - alignment sets the alignment at which memory shall be allocated.
4255 //     It must be a multiple of allocation granularity.
4256 // Returns address of memory or NULL. If req_addr was not NULL, will only return
4257 //  req_addr or NULL.
4258 char* os::Linux::reserve_memory_special_huge_tlbfs_mixed(size_t bytes,
4259                                                          size_t alignment,
4260                                                          char* req_addr,
4261                                                          bool exec) {
4262   size_t large_page_size = os::large_page_size();
4263   assert(bytes &gt;= large_page_size, &quot;Shouldn&#39;t allocate large pages for small sizes&quot;);
4264 
4265   assert(is_aligned(req_addr, alignment), &quot;Must be&quot;);
4266   assert(is_aligned(bytes, alignment), &quot;Must be&quot;);
4267 
4268   // First reserve - but not commit - the address range in small pages.
4269   char* const start = anon_mmap_aligned(bytes, alignment, req_addr);
4270 
4271   if (start == NULL) {
4272     return NULL;
4273   }
4274 
4275   assert(is_aligned(start, alignment), &quot;Must be&quot;);
4276 
4277   char* end = start + bytes;
4278 
4279   // Find the regions of the allocated chunk that can be promoted to large pages.
4280   char* lp_start = align_up(start, large_page_size);
4281   char* lp_end   = align_down(end, large_page_size);
4282 
4283   size_t lp_bytes = lp_end - lp_start;
4284 
4285   assert(is_aligned(lp_bytes, large_page_size), &quot;Must be&quot;);
4286 
4287   if (lp_bytes == 0) {
4288     // The mapped region doesn&#39;t even span the start and the end of a large page.
4289     // Fall back to allocate a non-special area.
4290     ::munmap(start, end - start);
4291     return NULL;
4292   }
4293 
4294   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
4295   int flags = MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED;
4296   void* result;
4297 
4298   // Commit small-paged leading area.
4299   if (start != lp_start) {
4300     result = ::mmap(start, lp_start - start, prot, flags, -1, 0);
4301     if (result == MAP_FAILED) {
4302       ::munmap(lp_start, end - lp_start);
4303       return NULL;
4304     }
4305   }
4306 
4307   // Commit large-paged area.
4308   flags |= MAP_HUGETLB;
4309 
4310   if (os::large_page_size() != default_large_page_size()) {
4311     flags |= (exact_log2(os::large_page_size()) &lt;&lt; MAP_HUGE_SHIFT);
4312   }
4313 
4314   result = ::mmap(lp_start, lp_bytes, prot, flags, -1, 0);
4315   if (result == MAP_FAILED) {
4316     warn_on_large_pages_failure(lp_start, lp_bytes, errno);
4317     // If the mmap above fails, the large pages region will be unmapped and we
4318     // have regions before and after with small pages. Release these regions.
4319     //
4320     // |  mapped  |  unmapped  |  mapped  |
4321     // ^          ^            ^          ^
4322     // start      lp_start     lp_end     end
4323     //
4324     ::munmap(start, lp_start - start);
4325     ::munmap(lp_end, end - lp_end);
4326     return NULL;
4327   }
4328 
4329   // Commit small-paged trailing area.
4330   if (lp_end != end) {
4331     result = ::mmap(lp_end, end - lp_end, prot,
4332                     MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,
4333                     -1, 0);
4334     if (result == MAP_FAILED) {
4335       ::munmap(start, lp_end - start);
4336       return NULL;
4337     }
4338   }
4339 
4340   return start;
4341 }
4342 
4343 char* os::Linux::reserve_memory_special_huge_tlbfs(size_t bytes,
4344                                                    size_t alignment,
4345                                                    char* req_addr,
4346                                                    bool exec) {
4347   assert(UseLargePages &amp;&amp; UseHugeTLBFS, &quot;only for Huge TLBFS large pages&quot;);
4348   assert(is_aligned(req_addr, alignment), &quot;Must be&quot;);
4349   assert(is_aligned(alignment, os::vm_allocation_granularity()), &quot;Must be&quot;);
4350   assert(is_power_of_2(os::large_page_size()), &quot;Must be&quot;);
4351   assert(bytes &gt;= os::large_page_size(), &quot;Shouldn&#39;t allocate large pages for small sizes&quot;);
4352 
4353   if (is_aligned(bytes, os::large_page_size()) &amp;&amp; alignment &lt;= os::large_page_size()) {
4354     return reserve_memory_special_huge_tlbfs_only(bytes, req_addr, exec);
4355   } else {
4356     return reserve_memory_special_huge_tlbfs_mixed(bytes, alignment, req_addr, exec);
4357   }
4358 }
4359 
4360 char* os::pd_reserve_memory_special(size_t bytes, size_t alignment,
4361                                     char* req_addr, bool exec) {
4362   assert(UseLargePages, &quot;only for large pages&quot;);
4363 
4364   char* addr;
4365   if (UseSHM) {
4366     addr = os::Linux::reserve_memory_special_shm(bytes, alignment, req_addr, exec);
4367   } else {
4368     assert(UseHugeTLBFS, &quot;must be&quot;);
4369     addr = os::Linux::reserve_memory_special_huge_tlbfs(bytes, alignment, req_addr, exec);
4370   }
4371 
4372   if (addr != NULL) {
4373     if (UseNUMAInterleaving) {
4374       numa_make_global(addr, bytes);
4375     }
4376   }
4377 
4378   return addr;
4379 }
4380 
4381 bool os::Linux::release_memory_special_shm(char* base, size_t bytes) {
4382   // detaching the SHM segment will also delete it, see reserve_memory_special_shm()
4383   return shmdt(base) == 0;
4384 }
4385 
4386 bool os::Linux::release_memory_special_huge_tlbfs(char* base, size_t bytes) {
4387   return pd_release_memory(base, bytes);
4388 }
4389 
4390 bool os::pd_release_memory_special(char* base, size_t bytes) {
4391   assert(UseLargePages, &quot;only for large pages&quot;);
4392   bool res;
4393 
4394   if (UseSHM) {
4395     res = os::Linux::release_memory_special_shm(base, bytes);
4396   } else {
4397     assert(UseHugeTLBFS, &quot;must be&quot;);
4398     res = os::Linux::release_memory_special_huge_tlbfs(base, bytes);
4399   }
4400   return res;
4401 }
4402 
4403 size_t os::large_page_size() {
4404   return _large_page_size;
4405 }
4406 
4407 // With SysV SHM the entire memory region must be allocated as shared
4408 // memory.
4409 // HugeTLBFS allows application to commit large page memory on demand.
4410 // However, when committing memory with HugeTLBFS fails, the region
4411 // that was supposed to be committed will lose the old reservation
4412 // and allow other threads to steal that memory region. Because of this
4413 // behavior we can&#39;t commit HugeTLBFS memory.
4414 bool os::can_commit_large_page_memory() {
4415   return UseTransparentHugePages;
4416 }
4417 
4418 bool os::can_execute_large_page_memory() {
4419   return UseTransparentHugePages || UseHugeTLBFS;
4420 }
4421 
4422 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
4423   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
4424   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
4425   if (result != NULL) {
4426     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
4427       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
4428     }
4429   }
4430   return result;
4431 }
4432 
4433 // Reserve memory at an arbitrary address, only if that area is
4434 // available (and not reserved for something else).
4435 
4436 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
4437   // Assert only that the size is a multiple of the page size, since
4438   // that&#39;s all that mmap requires, and since that&#39;s all we really know
4439   // about at this low abstraction level.  If we need higher alignment,
4440   // we can either pass an alignment to this method or verify alignment
4441   // in one of the methods further up the call chain.  See bug 5044738.
4442   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
4443 
4444   // Repeatedly allocate blocks until the block is allocated at the
4445   // right spot.
4446 
4447   // Linux mmap allows caller to pass an address as hint; give it a try first,
4448   // if kernel honors the hint then we can return immediately.
4449   char * addr = anon_mmap(requested_addr, bytes, false);
4450   if (addr == requested_addr) {
4451     return requested_addr;
4452   }
4453 
4454   if (addr != NULL) {
4455     // mmap() is successful but it fails to reserve at the requested address
4456     anon_munmap(addr, bytes);
4457   }
4458 
4459   return NULL;
4460 }
4461 
4462 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
4463 void os::infinite_sleep() {
4464   while (true) {    // sleep forever ...
4465     ::sleep(100);   // ... 100 seconds at a time
4466   }
4467 }
4468 
4469 // Used to convert frequent JVM_Yield() to nops
4470 bool os::dont_yield() {
4471   return DontYieldALot;
4472 }
4473 
4474 // Linux CFS scheduler (since 2.6.23) does not guarantee sched_yield(2) will
4475 // actually give up the CPU. Since skip buddy (v2.6.28):
4476 //
4477 // * Sets the yielding task as skip buddy for current CPU&#39;s run queue.
4478 // * Picks next from run queue, if empty, picks a skip buddy (can be the yielding task).
4479 // * Clears skip buddies for this run queue (yielding task no longer a skip buddy).
4480 //
4481 // An alternative is calling os::naked_short_nanosleep with a small number to avoid
4482 // getting re-scheduled immediately.
4483 //
4484 void os::naked_yield() {
4485   sched_yield();
4486 }
4487 
4488 ////////////////////////////////////////////////////////////////////////////////
4489 // thread priority support
4490 
4491 // Note: Normal Linux applications are run with SCHED_OTHER policy. SCHED_OTHER
4492 // only supports dynamic priority, static priority must be zero. For real-time
4493 // applications, Linux supports SCHED_RR which allows static priority (1-99).
4494 // However, for large multi-threaded applications, SCHED_RR is not only slower
4495 // than SCHED_OTHER, but also very unstable (my volano tests hang hard 4 out
4496 // of 5 runs - Sep 2005).
4497 //
4498 // The following code actually changes the niceness of kernel-thread/LWP. It
4499 // has an assumption that setpriority() only modifies one kernel-thread/LWP,
4500 // not the entire user process, and user level threads are 1:1 mapped to kernel
4501 // threads. It has always been the case, but could change in the future. For
4502 // this reason, the code should not be used as default (ThreadPriorityPolicy=0).
4503 // It is only used when ThreadPriorityPolicy=1 and may require system level permission
4504 // (e.g., root privilege or CAP_SYS_NICE capability).
4505 
4506 int os::java_to_os_priority[CriticalPriority + 1] = {
4507   19,              // 0 Entry should never be used
4508 
4509    4,              // 1 MinPriority
4510    3,              // 2
4511    2,              // 3
4512 
4513    1,              // 4
4514    0,              // 5 NormPriority
4515   -1,              // 6
4516 
4517   -2,              // 7
4518   -3,              // 8
4519   -4,              // 9 NearMaxPriority
4520 
4521   -5,              // 10 MaxPriority
4522 
4523   -5               // 11 CriticalPriority
4524 };
4525 
4526 static int prio_init() {
4527   if (ThreadPriorityPolicy == 1) {
4528     if (geteuid() != 0) {
4529       if (!FLAG_IS_DEFAULT(ThreadPriorityPolicy) &amp;&amp; !FLAG_IS_JIMAGE_RESOURCE(ThreadPriorityPolicy)) {
4530         warning(&quot;-XX:ThreadPriorityPolicy=1 may require system level permission, &quot; \
4531                 &quot;e.g., being the root user. If the necessary permission is not &quot; \
4532                 &quot;possessed, changes to priority will be silently ignored.&quot;);
4533       }
4534     }
4535   }
4536   if (UseCriticalJavaThreadPriority) {
4537     os::java_to_os_priority[MaxPriority] = os::java_to_os_priority[CriticalPriority];
4538   }
4539   return 0;
4540 }
4541 
4542 OSReturn os::set_native_priority(Thread* thread, int newpri) {
4543   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) return OS_OK;
4544 
4545   int ret = setpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id(), newpri);
4546   return (ret == 0) ? OS_OK : OS_ERR;
4547 }
4548 
4549 OSReturn os::get_native_priority(const Thread* const thread,
4550                                  int *priority_ptr) {
4551   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) {
4552     *priority_ptr = java_to_os_priority[NormPriority];
4553     return OS_OK;
4554   }
4555 
4556   errno = 0;
4557   *priority_ptr = getpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id());
4558   return (*priority_ptr != -1 || errno == 0 ? OS_OK : OS_ERR);
4559 }
4560 
4561 ////////////////////////////////////////////////////////////////////////////////
4562 // suspend/resume support
4563 
4564 //  The low-level signal-based suspend/resume support is a remnant from the
4565 //  old VM-suspension that used to be for java-suspension, safepoints etc,
4566 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
4567 //
4568 //  The remaining code is greatly simplified from the more general suspension
4569 //  code that used to be used.
4570 //
4571 //  The protocol is quite simple:
4572 //  - suspend:
4573 //      - sends a signal to the target thread
4574 //      - polls the suspend state of the osthread using a yield loop
4575 //      - target thread signal handler (SR_handler) sets suspend state
4576 //        and blocks in sigsuspend until continued
4577 //  - resume:
4578 //      - sets target osthread state to continue
4579 //      - sends signal to end the sigsuspend loop in the SR_handler
4580 //
4581 //  Note that the SR_lock plays no role in this suspend/resume protocol,
4582 //  but is checked for NULL in SR_handler as a thread termination indicator.
4583 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
4584 //
4585 //  Note that resume_clear_context() and suspend_save_context() are needed
4586 //  by SR_handler(), so that fetch_frame_from_context() works,
4587 //  which in part is used by:
4588 //    - Forte Analyzer: AsyncGetCallTrace()
4589 //    - StackBanging: get_frame_at_stack_banging_point()
4590 
4591 static void resume_clear_context(OSThread *osthread) {
4592   osthread-&gt;set_ucontext(NULL);
4593   osthread-&gt;set_siginfo(NULL);
4594 }
4595 
4596 static void suspend_save_context(OSThread *osthread, siginfo_t* siginfo,
4597                                  ucontext_t* context) {
4598   osthread-&gt;set_ucontext(context);
4599   osthread-&gt;set_siginfo(siginfo);
4600 }
4601 
4602 // Handler function invoked when a thread&#39;s execution is suspended or
4603 // resumed. We have to be careful that only async-safe functions are
4604 // called here (Note: most pthread functions are not async safe and
4605 // should be avoided.)
4606 //
4607 // Note: sigwait() is a more natural fit than sigsuspend() from an
4608 // interface point of view, but sigwait() prevents the signal hander
4609 // from being run. libpthread would get very confused by not having
4610 // its signal handlers run and prevents sigwait()&#39;s use with the
4611 // mutex granting granting signal.
4612 //
4613 // Currently only ever called on the VMThread and JavaThreads (PC sampling)
4614 //
4615 static void SR_handler(int sig, siginfo_t* siginfo, ucontext_t* context) {
4616   // Save and restore errno to avoid confusing native code with EINTR
4617   // after sigsuspend.
4618   int old_errno = errno;
4619 
4620   Thread* thread = Thread::current_or_null_safe();
4621   assert(thread != NULL, &quot;Missing current thread in SR_handler&quot;);
4622 
4623   // On some systems we have seen signal delivery get &quot;stuck&quot; until the signal
4624   // mask is changed as part of thread termination. Check that the current thread
4625   // has not already terminated (via SR_lock()) - else the following assertion
4626   // will fail because the thread is no longer a JavaThread as the ~JavaThread
4627   // destructor has completed.
4628 
4629   if (thread-&gt;SR_lock() == NULL) {
4630     return;
4631   }
4632 
4633   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
4634 
4635   OSThread* osthread = thread-&gt;osthread();
4636 
4637   os::SuspendResume::State current = osthread-&gt;sr.state();
4638   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
4639     suspend_save_context(osthread, siginfo, context);
4640 
4641     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
4642     os::SuspendResume::State state = osthread-&gt;sr.suspended();
4643     if (state == os::SuspendResume::SR_SUSPENDED) {
4644       sigset_t suspend_set;  // signals for sigsuspend()
4645       sigemptyset(&amp;suspend_set);
4646       // get current set of blocked signals and unblock resume signal
4647       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
4648       sigdelset(&amp;suspend_set, SR_signum);
4649 
4650       sr_semaphore.signal();
4651       // wait here until we are resumed
4652       while (1) {
4653         sigsuspend(&amp;suspend_set);
4654 
4655         os::SuspendResume::State result = osthread-&gt;sr.running();
4656         if (result == os::SuspendResume::SR_RUNNING) {
4657           sr_semaphore.signal();
4658           break;
4659         }
4660       }
4661 
4662     } else if (state == os::SuspendResume::SR_RUNNING) {
4663       // request was cancelled, continue
4664     } else {
4665       ShouldNotReachHere();
4666     }
4667 
4668     resume_clear_context(osthread);
4669   } else if (current == os::SuspendResume::SR_RUNNING) {
4670     // request was cancelled, continue
4671   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
4672     // ignore
4673   } else {
4674     // ignore
4675   }
4676 
4677   errno = old_errno;
4678 }
4679 
4680 static int SR_initialize() {
4681   struct sigaction act;
4682   char *s;
4683 
4684   // Get signal number to use for suspend/resume
4685   if ((s = ::getenv(&quot;_JAVA_SR_SIGNUM&quot;)) != 0) {
4686     int sig = ::strtol(s, 0, 10);
4687     if (sig &gt; MAX2(SIGSEGV, SIGBUS) &amp;&amp;  // See 4355769.
4688         sig &lt; NSIG) {                   // Must be legal signal and fit into sigflags[].
4689       SR_signum = sig;
4690     } else {
4691       warning(&quot;You set _JAVA_SR_SIGNUM=%d. It must be in range [%d, %d]. Using %d instead.&quot;,
4692               sig, MAX2(SIGSEGV, SIGBUS)+1, NSIG-1, SR_signum);
4693     }
4694   }
4695 
4696   assert(SR_signum &gt; SIGSEGV &amp;&amp; SR_signum &gt; SIGBUS,
4697          &quot;SR_signum must be greater than max(SIGSEGV, SIGBUS), see 4355769&quot;);
4698 
4699   sigemptyset(&amp;SR_sigset);
4700   sigaddset(&amp;SR_sigset, SR_signum);
4701 
4702   // Set up signal handler for suspend/resume
4703   act.sa_flags = SA_RESTART|SA_SIGINFO;
4704   act.sa_handler = (void (*)(int)) SR_handler;
4705 
4706   // SR_signum is blocked by default.
4707   // 4528190 - We also need to block pthread restart signal (32 on all
4708   // supported Linux platforms). Note that LinuxThreads need to block
4709   // this signal for all threads to work properly. So we don&#39;t have
4710   // to use hard-coded signal number when setting up the mask.
4711   pthread_sigmask(SIG_BLOCK, NULL, &amp;act.sa_mask);
4712 
4713   if (sigaction(SR_signum, &amp;act, 0) == -1) {
4714     return -1;
4715   }
4716 
4717   // Save signal flag
4718   os::Linux::set_our_sigflags(SR_signum, act.sa_flags);
4719   return 0;
4720 }
4721 
4722 static int sr_notify(OSThread* osthread) {
4723   int status = pthread_kill(osthread-&gt;pthread_id(), SR_signum);
4724   assert_status(status == 0, status, &quot;pthread_kill&quot;);
4725   return status;
4726 }
4727 
4728 // &quot;Randomly&quot; selected value for how long we want to spin
4729 // before bailing out on suspending a thread, also how often
4730 // we send a signal to a thread we want to resume
4731 static const int RANDOMLY_LARGE_INTEGER = 1000000;
4732 static const int RANDOMLY_LARGE_INTEGER2 = 100;
4733 
4734 // returns true on success and false on error - really an error is fatal
4735 // but this seems the normal response to library errors
4736 static bool do_suspend(OSThread* osthread) {
4737   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
4738   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
4739 
4740   // mark as suspended and send signal
4741   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
4742     // failed to switch, state wasn&#39;t running?
4743     ShouldNotReachHere();
4744     return false;
4745   }
4746 
4747   if (sr_notify(osthread) != 0) {
4748     ShouldNotReachHere();
4749   }
4750 
4751   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
4752   while (true) {
4753     if (sr_semaphore.timedwait(2)) {
4754       break;
4755     } else {
4756       // timeout
4757       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
4758       if (cancelled == os::SuspendResume::SR_RUNNING) {
4759         return false;
4760       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
4761         // make sure that we consume the signal on the semaphore as well
4762         sr_semaphore.wait();
4763         break;
4764       } else {
4765         ShouldNotReachHere();
4766         return false;
4767       }
4768     }
4769   }
4770 
4771   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
4772   return true;
4773 }
4774 
4775 static void do_resume(OSThread* osthread) {
4776   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
4777   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
4778 
4779   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
4780     // failed to switch to WAKEUP_REQUEST
4781     ShouldNotReachHere();
4782     return;
4783   }
4784 
4785   while (true) {
4786     if (sr_notify(osthread) == 0) {
4787       if (sr_semaphore.timedwait(2)) {
4788         if (osthread-&gt;sr.is_running()) {
4789           return;
4790         }
4791       }
4792     } else {
4793       ShouldNotReachHere();
4794     }
4795   }
4796 
4797   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
4798 }
4799 
4800 ///////////////////////////////////////////////////////////////////////////////////
4801 // signal handling (except suspend/resume)
4802 
4803 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
4804 // The user-defined signal handler must pass unrecognized signals to this
4805 // routine, and if it returns true (non-zero), then the signal handler must
4806 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
4807 // routine will never retun false (zero), but instead will execute a VM panic
4808 // routine kill the process.
4809 //
4810 // If this routine returns false, it is OK to call it again.  This allows
4811 // the user-defined signal handler to perform checks either before or after
4812 // the VM performs its own checks.  Naturally, the user code would be making
4813 // a serious error if it tried to handle an exception (such as a null check
4814 // or breakpoint) that the VM was generating for its own correct operation.
4815 //
4816 // This routine may recognize any of the following kinds of signals:
4817 //    SIGBUS, SIGSEGV, SIGILL, SIGFPE, SIGQUIT, SIGPIPE, SIGXFSZ, SIGUSR1.
4818 // It should be consulted by handlers for any of those signals.
4819 //
4820 // The caller of this routine must pass in the three arguments supplied
4821 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
4822 // field of the structure passed to sigaction().  This routine assumes that
4823 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
4824 //
4825 // Note that the VM will print warnings if it detects conflicting signal
4826 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
4827 //
4828 extern &quot;C&quot; JNIEXPORT int JVM_handle_linux_signal(int signo,
4829                                                  siginfo_t* siginfo,
4830                                                  void* ucontext,
4831                                                  int abort_if_unrecognized);
4832 
4833 static void signalHandler(int sig, siginfo_t* info, void* uc) {
4834   assert(info != NULL &amp;&amp; uc != NULL, &quot;it must be old kernel&quot;);
4835   int orig_errno = errno;  // Preserve errno value over signal handler.
4836   JVM_handle_linux_signal(sig, info, uc, true);
4837   errno = orig_errno;
4838 }
4839 
4840 
4841 // This boolean allows users to forward their own non-matching signals
4842 // to JVM_handle_linux_signal, harmlessly.
4843 bool os::Linux::signal_handlers_are_installed = false;
4844 
4845 // For signal-chaining
4846 bool os::Linux::libjsig_is_loaded = false;
4847 typedef struct sigaction *(*get_signal_t)(int);
4848 get_signal_t os::Linux::get_signal_action = NULL;
4849 
4850 struct sigaction* os::Linux::get_chained_signal_action(int sig) {
4851   struct sigaction *actp = NULL;
4852 
4853   if (libjsig_is_loaded) {
4854     // Retrieve the old signal handler from libjsig
4855     actp = (*get_signal_action)(sig);
4856   }
4857   if (actp == NULL) {
4858     // Retrieve the preinstalled signal handler from jvm
4859     actp = os::Posix::get_preinstalled_handler(sig);
4860   }
4861 
4862   return actp;
4863 }
4864 
4865 static bool call_chained_handler(struct sigaction *actp, int sig,
4866                                  siginfo_t *siginfo, void *context) {
4867   // Call the old signal handler
4868   if (actp-&gt;sa_handler == SIG_DFL) {
4869     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
4870     // instead of taking the default action.
4871     return false;
4872   } else if (actp-&gt;sa_handler != SIG_IGN) {
4873     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
4874       // automaticlly block the signal
4875       sigaddset(&amp;(actp-&gt;sa_mask), sig);
4876     }
4877 
4878     sa_handler_t hand = NULL;
4879     sa_sigaction_t sa = NULL;
4880     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
4881     // retrieve the chained handler
4882     if (siginfo_flag_set) {
4883       sa = actp-&gt;sa_sigaction;
4884     } else {
4885       hand = actp-&gt;sa_handler;
4886     }
4887 
4888     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
4889       actp-&gt;sa_handler = SIG_DFL;
4890     }
4891 
4892     // try to honor the signal mask
4893     sigset_t oset;
4894     sigemptyset(&amp;oset);
4895     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
4896 
4897     // call into the chained handler
4898     if (siginfo_flag_set) {
4899       (*sa)(sig, siginfo, context);
4900     } else {
4901       (*hand)(sig);
4902     }
4903 
4904     // restore the signal mask
4905     pthread_sigmask(SIG_SETMASK, &amp;oset, NULL);
4906   }
4907   // Tell jvm&#39;s signal handler the signal is taken care of.
4908   return true;
4909 }
4910 
4911 bool os::Linux::chained_handler(int sig, siginfo_t* siginfo, void* context) {
4912   bool chained = false;
4913   // signal-chaining
4914   if (UseSignalChaining) {
4915     struct sigaction *actp = get_chained_signal_action(sig);
4916     if (actp != NULL) {
4917       chained = call_chained_handler(actp, sig, siginfo, context);
4918     }
4919   }
4920   return chained;
4921 }
4922 
4923 // for diagnostic
4924 int sigflags[NSIG];
4925 
4926 int os::Linux::get_our_sigflags(int sig) {
4927   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4928   return sigflags[sig];
4929 }
4930 
4931 void os::Linux::set_our_sigflags(int sig, int flags) {
4932   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4933   if (sig &gt; 0 &amp;&amp; sig &lt; NSIG) {
4934     sigflags[sig] = flags;
4935   }
4936 }
4937 
4938 void os::Linux::set_signal_handler(int sig, bool set_installed) {
4939   // Check for overwrite.
4940   struct sigaction oldAct;
4941   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
4942 
4943   void* oldhand = oldAct.sa_sigaction
4944                 ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
4945                 : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
4946   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
4947       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
4948       oldhand != CAST_FROM_FN_PTR(void*, (sa_sigaction_t)signalHandler)) {
4949     if (AllowUserSignalHandlers || !set_installed) {
4950       // Do not overwrite; user takes responsibility to forward to us.
4951       return;
4952     } else if (UseSignalChaining) {
4953       // save the old handler in jvm
4954       os::Posix::save_preinstalled_handler(sig, oldAct);
4955       // libjsig also interposes the sigaction() call below and saves the
4956       // old sigaction on it own.
4957     } else {
4958       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
4959             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
4960     }
4961   }
4962 
4963   struct sigaction sigAct;
4964   sigfillset(&amp;(sigAct.sa_mask));
4965   sigAct.sa_handler = SIG_DFL;
4966   if (!set_installed) {
4967     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
4968   } else {
4969     sigAct.sa_sigaction = signalHandler;
4970     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
4971   }
4972   // Save flags, which are set by ours
4973   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4974   sigflags[sig] = sigAct.sa_flags;
4975 
4976   int ret = sigaction(sig, &amp;sigAct, &amp;oldAct);
4977   assert(ret == 0, &quot;check&quot;);
4978 
4979   void* oldhand2  = oldAct.sa_sigaction
4980                   ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
4981                   : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
4982   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
4983 }
4984 
4985 // install signal handlers for signals that HotSpot needs to
4986 // handle in order to support Java-level exception handling.
4987 
4988 void os::Linux::install_signal_handlers() {
4989   if (!signal_handlers_are_installed) {
4990     signal_handlers_are_installed = true;
4991 
4992     // signal-chaining
4993     typedef void (*signal_setting_t)();
4994     signal_setting_t begin_signal_setting = NULL;
4995     signal_setting_t end_signal_setting = NULL;
4996     begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
4997                                           dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
4998     if (begin_signal_setting != NULL) {
4999       end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
5000                                           dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
5001       get_signal_action = CAST_TO_FN_PTR(get_signal_t,
5002                                          dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
5003       libjsig_is_loaded = true;
5004       assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
5005     }
5006     if (libjsig_is_loaded) {
5007       // Tell libjsig jvm is setting signal handlers
5008       (*begin_signal_setting)();
5009     }
5010 
5011     set_signal_handler(SIGSEGV, true);
5012     set_signal_handler(SIGPIPE, true);
5013     set_signal_handler(SIGBUS, true);
5014     set_signal_handler(SIGILL, true);
5015     set_signal_handler(SIGFPE, true);
5016 #if defined(PPC64)
5017     set_signal_handler(SIGTRAP, true);
5018 #endif
5019     set_signal_handler(SIGXFSZ, true);
5020 
5021     if (libjsig_is_loaded) {
5022       // Tell libjsig jvm finishes setting signal handlers
5023       (*end_signal_setting)();
5024     }
5025 
5026     // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
5027     // and if UserSignalHandler is installed all bets are off.
5028     // Log that signal checking is off only if -verbose:jni is specified.
5029     if (CheckJNICalls) {
5030       if (libjsig_is_loaded) {
5031         log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
5032         check_signals = false;
5033       }
5034       if (AllowUserSignalHandlers) {
5035         log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
5036         check_signals = false;
5037       }
5038     }
5039   }
5040 }
5041 
5042 // This is the fastest way to get thread cpu time on Linux.
5043 // Returns cpu time (user+sys) for any thread, not only for current.
5044 // POSIX compliant clocks are implemented in the kernels 2.6.16+.
5045 // It might work on 2.6.10+ with a special kernel/glibc patch.
5046 // For reference, please, see IEEE Std 1003.1-2004:
5047 //   http://www.unix.org/single_unix_specification
5048 
5049 jlong os::Linux::fast_thread_cpu_time(clockid_t clockid) {
5050   struct timespec tp;
5051   int rc = os::Posix::clock_gettime(clockid, &amp;tp);
5052   assert(rc == 0, &quot;clock_gettime is expected to return 0 code&quot;);
5053 
5054   return (tp.tv_sec * NANOSECS_PER_SEC) + tp.tv_nsec;
5055 }
5056 
5057 /////
5058 // glibc on Linux platform uses non-documented flag
5059 // to indicate, that some special sort of signal
5060 // trampoline is used.
5061 // We will never set this flag, and we should
5062 // ignore this flag in our diagnostic
5063 #ifdef SIGNIFICANT_SIGNAL_MASK
5064   #undef SIGNIFICANT_SIGNAL_MASK
5065 #endif
5066 #define SIGNIFICANT_SIGNAL_MASK (~0x04000000)
5067 
5068 static const char* get_signal_handler_name(address handler,
5069                                            char* buf, int buflen) {
5070   int offset = 0;
5071   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
5072   if (found) {
5073     // skip directory names
5074     const char *p1, *p2;
5075     p1 = buf;
5076     size_t len = strlen(os::file_separator());
5077     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
5078     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
5079   } else {
5080     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
5081   }
5082   return buf;
5083 }
5084 
5085 static void print_signal_handler(outputStream* st, int sig,
5086                                  char* buf, size_t buflen) {
5087   struct sigaction sa;
5088 
5089   sigaction(sig, NULL, &amp;sa);
5090 
5091   // See comment for SIGNIFICANT_SIGNAL_MASK define
5092   sa.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
5093 
5094   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
5095 
5096   address handler = (sa.sa_flags &amp; SA_SIGINFO)
5097     ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
5098     : CAST_FROM_FN_PTR(address, sa.sa_handler);
5099 
5100   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
5101     st-&gt;print(&quot;SIG_DFL&quot;);
5102   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
5103     st-&gt;print(&quot;SIG_IGN&quot;);
5104   } else {
5105     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
5106   }
5107 
5108   st-&gt;print(&quot;, sa_mask[0]=&quot;);
5109   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
5110 
5111   address rh = VMError::get_resetted_sighandler(sig);
5112   // May be, handler was resetted by VMError?
5113   if (rh != NULL) {
5114     handler = rh;
5115     sa.sa_flags = VMError::get_resetted_sigflags(sig) &amp; SIGNIFICANT_SIGNAL_MASK;
5116   }
5117 
5118   st-&gt;print(&quot;, sa_flags=&quot;);
5119   os::Posix::print_sa_flags(st, sa.sa_flags);
5120 
5121   // Check: is it our handler?
5122   if (handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler) ||
5123       handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler)) {
5124     // It is our signal handler
5125     // check for flags, reset system-used one!
5126     if ((int)sa.sa_flags != os::Linux::get_our_sigflags(sig)) {
5127       st-&gt;print(
5128                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
5129                 os::Linux::get_our_sigflags(sig));
5130     }
5131   }
5132   st-&gt;cr();
5133 }
5134 
5135 
5136 #define DO_SIGNAL_CHECK(sig)                      \
5137   do {                                            \
5138     if (!sigismember(&amp;check_signal_done, sig)) {  \
5139       os::Linux::check_signal_handler(sig);       \
5140     }                                             \
5141   } while (0)
5142 
5143 // This method is a periodic task to check for misbehaving JNI applications
5144 // under CheckJNI, we can add any periodic checks here
5145 
5146 void os::run_periodic_checks() {
5147   if (check_signals == false) return;
5148 
5149   // SEGV and BUS if overridden could potentially prevent
5150   // generation of hs*.log in the event of a crash, debugging
5151   // such a case can be very challenging, so we absolutely
5152   // check the following for a good measure:
5153   DO_SIGNAL_CHECK(SIGSEGV);
5154   DO_SIGNAL_CHECK(SIGILL);
5155   DO_SIGNAL_CHECK(SIGFPE);
5156   DO_SIGNAL_CHECK(SIGBUS);
5157   DO_SIGNAL_CHECK(SIGPIPE);
5158   DO_SIGNAL_CHECK(SIGXFSZ);
5159 #if defined(PPC64)
5160   DO_SIGNAL_CHECK(SIGTRAP);
5161 #endif
5162 
5163   // ReduceSignalUsage allows the user to override these handlers
5164   // see comments at the very top and jvm_md.h
5165   if (!ReduceSignalUsage) {
5166     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
5167     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
5168     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
5169     DO_SIGNAL_CHECK(BREAK_SIGNAL);
5170   }
5171 
5172   DO_SIGNAL_CHECK(SR_signum);
5173 }
5174 
5175 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
5176 
5177 static os_sigaction_t os_sigaction = NULL;
5178 
5179 void os::Linux::check_signal_handler(int sig) {
5180   char buf[O_BUFLEN];
5181   address jvmHandler = NULL;
5182 
5183 
5184   struct sigaction act;
5185   if (os_sigaction == NULL) {
5186     // only trust the default sigaction, in case it has been interposed
5187     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
5188     if (os_sigaction == NULL) return;
5189   }
5190 
5191   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
5192 
5193 
5194   act.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
5195 
5196   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
5197     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
5198     : CAST_FROM_FN_PTR(address, act.sa_handler);
5199 
5200 
5201   switch (sig) {
5202   case SIGSEGV:
5203   case SIGBUS:
5204   case SIGFPE:
5205   case SIGPIPE:
5206   case SIGILL:
5207   case SIGXFSZ:
5208     jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler);
5209     break;
5210 
5211   case SHUTDOWN1_SIGNAL:
5212   case SHUTDOWN2_SIGNAL:
5213   case SHUTDOWN3_SIGNAL:
5214   case BREAK_SIGNAL:
5215     jvmHandler = (address)user_handler();
5216     break;
5217 
5218   default:
5219     if (sig == SR_signum) {
5220       jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler);
5221     } else {
5222       return;
5223     }
5224     break;
5225   }
5226 
5227   if (thisHandler != jvmHandler) {
5228     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
5229     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
5230     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
5231     // No need to check this sig any longer
5232     sigaddset(&amp;check_signal_done, sig);
5233     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
5234     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
5235       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
5236                     exception_name(sig, buf, O_BUFLEN));
5237     }
5238   } else if(os::Linux::get_our_sigflags(sig) != 0 &amp;&amp; (int)act.sa_flags != os::Linux::get_our_sigflags(sig)) {
5239     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
5240     tty-&gt;print(&quot;expected:&quot;);
5241     os::Posix::print_sa_flags(tty, os::Linux::get_our_sigflags(sig));
5242     tty-&gt;cr();
5243     tty-&gt;print(&quot;  found:&quot;);
5244     os::Posix::print_sa_flags(tty, act.sa_flags);
5245     tty-&gt;cr();
5246     // No need to check this sig any longer
5247     sigaddset(&amp;check_signal_done, sig);
5248   }
5249 
5250   // Dump all the signal
5251   if (sigismember(&amp;check_signal_done, sig)) {
5252     print_signal_handlers(tty, buf, O_BUFLEN);
5253   }
5254 }
5255 
5256 extern void report_error(char* file_name, int line_no, char* title,
5257                          char* format, ...);
5258 
5259 // Some linux distributions (notably: Alpine Linux) include the
<a name="11" id="anc11"></a><span class="line-modified">5260 // grsecurity in the kernel. Of particular interest from a JVM perspective</span>
<span class="line-modified">5261 // is PaX (https://pax.grsecurity.net/), which adds some security features</span>
<span class="line-modified">5262 // related to page attributes. Specifically, the MPROTECT PaX functionality</span>

5263 // (https://pax.grsecurity.net/docs/mprotect.txt) prevents dynamic
5264 // code generation by disallowing a (previously) writable page to be
5265 // marked as executable. This is, of course, exactly what HotSpot does
5266 // for both JIT compiled method, as well as for stubs, adapters, etc.
5267 //
5268 // Instead of crashing &quot;lazily&quot; when trying to make a page executable,
5269 // this code probes for the presence of PaX and reports the failure
5270 // eagerly.
5271 static void check_pax(void) {
5272   // Zero doesn&#39;t generate code dynamically, so no need to perform the PaX check
5273 #ifndef ZERO
5274   size_t size = os::Linux::page_size();
5275 
5276   void* p = ::mmap(NULL, size, PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
5277   if (p == MAP_FAILED) {
<a name="12" id="anc12"></a><span class="line-added">5278     log_debug(os)(&quot;os_linux.cpp: check_pax: mmap failed (%s)&quot; , os::strerror(errno));</span>
5279     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;failed to allocate memory for PaX check.&quot;);
5280   }
5281 
5282   int res = ::mprotect(p, size, PROT_WRITE|PROT_EXEC);
5283   if (res == -1) {
<a name="13" id="anc13"></a><span class="line-added">5284     log_debug(os)(&quot;os_linux.cpp: check_pax: mprotect failed (%s)&quot; , os::strerror(errno));</span>
5285     vm_exit_during_initialization(&quot;Failed to mark memory page as executable&quot;,
5286                                   &quot;Please check if grsecurity/PaX is enabled in your kernel.\n&quot;
5287                                   &quot;\n&quot;
5288                                   &quot;For example, you can do this by running (note: you may need root privileges):\n&quot;
5289                                   &quot;\n&quot;
5290                                   &quot;    sysctl kernel.pax.softmode\n&quot;
5291                                   &quot;\n&quot;
5292                                   &quot;If PaX is included in the kernel you will see something like this:\n&quot;
5293                                   &quot;\n&quot;
5294                                   &quot;    kernel.pax.softmode = 0\n&quot;
5295                                   &quot;\n&quot;
5296                                   &quot;In particular, if the value is 0 (zero), then PaX is enabled.\n&quot;
5297                                   &quot;\n&quot;
5298                                   &quot;PaX includes security functionality which interferes with the dynamic code\n&quot;
5299                                   &quot;generation the JVM relies on. Specifically, the MPROTECT functionality as\n&quot;
5300                                   &quot;described on https://pax.grsecurity.net/docs/mprotect.txt is not compatible\n&quot;
5301                                   &quot;with the JVM. If you want to allow the JVM to run you will have to disable PaX.\n&quot;
5302                                   &quot;You can do this on a per-executable basis using the paxctl tool, for example:\n&quot;
5303                                   &quot;\n&quot;
5304                                   &quot;    paxctl -cm bin/java\n&quot;
5305                                   &quot;\n&quot;
5306                                   &quot;Please note that this modifies the executable binary in-place, so you may want\n&quot;
5307                                   &quot;to make a backup of it first. Also note that you have to repeat this for other\n&quot;
5308                                   &quot;executables like javac, jar, jcmd, etc.\n&quot;
5309                                   );
5310 
5311   }
5312 
5313   ::munmap(p, size);
5314 #endif
5315 }
5316 
5317 // this is called _before_ most of the global arguments have been parsed
5318 void os::init(void) {
5319   char dummy;   // used to get a guess on initial stack address
5320 
5321   clock_tics_per_sec = sysconf(_SC_CLK_TCK);
5322 
5323   init_random(1234567);
5324 
5325   Linux::set_page_size(sysconf(_SC_PAGESIZE));
5326   if (Linux::page_size() == -1) {
5327     fatal(&quot;os_linux.cpp: os::init: sysconf failed (%s)&quot;,
5328           os::strerror(errno));
5329   }
5330   init_page_sizes((size_t) Linux::page_size());
5331 
5332   Linux::initialize_system_info();
5333 
5334   os::Linux::CPUPerfTicks pticks;
5335   bool res = os::Linux::get_tick_information(&amp;pticks, -1);
5336 
5337   if (res &amp;&amp; pticks.has_steal_ticks) {
5338     has_initial_tick_info = true;
5339     initial_total_ticks = pticks.total;
5340     initial_steal_ticks = pticks.steal;
5341   }
5342 
5343   // _main_thread points to the thread that created/loaded the JVM.
5344   Linux::_main_thread = pthread_self();
5345 
5346   // retrieve entry point for pthread_setname_np
5347   Linux::_pthread_setname_np =
5348     (int(*)(pthread_t, const char*))dlsym(RTLD_DEFAULT, &quot;pthread_setname_np&quot;);
5349 
5350   check_pax();
5351 
5352   os::Posix::init();
5353 
5354   initial_time_count = javaTimeNanos();
5355 
5356   // Always warn if no monotonic clock available
5357   if (!os::Posix::supports_monotonic_clock()) {
5358     warning(&quot;No monotonic clock was available - timed services may &quot;    \
5359             &quot;be adversely affected if the time-of-day clock changes&quot;);
5360   }
5361 }
5362 
5363 // To install functions for atexit system call
5364 extern &quot;C&quot; {
5365   static void perfMemory_exit_helper() {
5366     perfMemory_exit();
5367   }
5368 }
5369 
5370 void os::pd_init_container_support() {
5371   OSContainer::init();
5372 }
5373 
5374 void os::Linux::numa_init() {
5375 
5376   // Java can be invoked as
5377   // 1. Without numactl and heap will be allocated/configured on all nodes as
5378   //    per the system policy.
5379   // 2. With numactl --interleave:
5380   //      Use numa_get_interleave_mask(v2) API to get nodes bitmask. The same
5381   //      API for membind case bitmask is reset.
5382   //      Interleave is only hint and Kernel can fallback to other nodes if
5383   //      no memory is available on the target nodes.
5384   // 3. With numactl --membind:
5385   //      Use numa_get_membind(v2) API to get nodes bitmask. The same API for
5386   //      interleave case returns bitmask of all nodes.
5387   // numa_all_nodes_ptr holds bitmask of all nodes.
5388   // numa_get_interleave_mask(v2) and numa_get_membind(v2) APIs returns correct
5389   // bitmask when externally configured to run on all or fewer nodes.
5390 
5391   if (!Linux::libnuma_init()) {
5392     FLAG_SET_ERGO(UseNUMA, false);
5393     FLAG_SET_ERGO(UseNUMAInterleaving, false); // Also depends on libnuma.
5394   } else {
5395     if ((Linux::numa_max_node() &lt; 1) || Linux::is_bound_to_single_node()) {
5396       // If there&#39;s only one node (they start from 0) or if the process
5397       // is bound explicitly to a single node using membind, disable NUMA
5398       UseNUMA = false;
5399     } else {
5400       LogTarget(Info,os) log;
5401       LogStream ls(log);
5402 
5403       Linux::set_configured_numa_policy(Linux::identify_numa_policy());
5404 
5405       struct bitmask* bmp = Linux::_numa_membind_bitmask;
5406       const char* numa_mode = &quot;membind&quot;;
5407 
5408       if (Linux::is_running_in_interleave_mode()) {
5409         bmp = Linux::_numa_interleave_bitmask;
5410         numa_mode = &quot;interleave&quot;;
5411       }
5412 
5413       ls.print(&quot;UseNUMA is enabled and invoked in &#39;%s&#39; mode.&quot;
5414                &quot; Heap will be configured using NUMA memory nodes:&quot;, numa_mode);
5415 
5416       for (int node = 0; node &lt;= Linux::numa_max_node(); node++) {
5417         if (Linux::_numa_bitmask_isbitset(bmp, node)) {
5418           ls.print(&quot; %d&quot;, node);
5419         }
5420       }
5421     }
5422   }
5423 
5424   // When NUMA requested, not-NUMA-aware allocations default to interleaving.
5425   if (UseNUMA &amp;&amp; !UseNUMAInterleaving) {
5426     FLAG_SET_ERGO_IF_DEFAULT(UseNUMAInterleaving, true);
5427   }
5428 
5429   if (UseParallelGC &amp;&amp; UseNUMA &amp;&amp; UseLargePages &amp;&amp; !can_commit_large_page_memory()) {
5430     // With SHM and HugeTLBFS large pages we cannot uncommit a page, so there&#39;s no way
5431     // we can make the adaptive lgrp chunk resizing work. If the user specified both
5432     // UseNUMA and UseLargePages (or UseSHM/UseHugeTLBFS) on the command line - warn
5433     // and disable adaptive resizing.
5434     if (UseAdaptiveSizePolicy || UseAdaptiveNUMAChunkSizing) {
5435       warning(&quot;UseNUMA is not fully compatible with SHM/HugeTLBFS large pages, &quot;
5436               &quot;disabling adaptive resizing (-XX:-UseAdaptiveSizePolicy -XX:-UseAdaptiveNUMAChunkSizing)&quot;);
5437       UseAdaptiveSizePolicy = false;
5438       UseAdaptiveNUMAChunkSizing = false;
5439     }
5440   }
5441 }
5442 
5443 // this is called _after_ the global arguments have been parsed
5444 jint os::init_2(void) {
5445 
5446   // This could be set after os::Posix::init() but all platforms
5447   // have to set it the same so we have to mirror Solaris.
5448   DEBUG_ONLY(os::set_mutex_init_done();)
5449 
5450   os::Posix::init_2();
5451 
5452   Linux::fast_thread_clock_init();
5453 
5454   // initialize suspend/resume support - must do this before signal_sets_init()
5455   if (SR_initialize() != 0) {
5456     perror(&quot;SR_initialize failed&quot;);
5457     return JNI_ERR;
5458   }
5459 
5460   Linux::signal_sets_init();
5461   Linux::install_signal_handlers();
5462   // Initialize data for jdk.internal.misc.Signal
5463   if (!ReduceSignalUsage) {
5464     jdk_misc_signal_init();
5465   }
5466 
5467   if (AdjustStackSizeForTLS) {
5468     get_minstack_init();
5469   }
5470 
5471   // Check and sets minimum stack sizes against command line options
5472   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
5473     return JNI_ERR;
5474   }
5475 
5476 #if defined(IA32)
5477   // Need to ensure we&#39;ve determined the process&#39;s initial stack to
5478   // perform the workaround
5479   Linux::capture_initial_stack(JavaThread::stack_size_at_create());
5480   workaround_expand_exec_shield_cs_limit();
5481 #else
5482   suppress_primordial_thread_resolution = Arguments::created_by_java_launcher();
5483   if (!suppress_primordial_thread_resolution) {
5484     Linux::capture_initial_stack(JavaThread::stack_size_at_create());
5485   }
5486 #endif
5487 
5488   Linux::libpthread_init();
5489   Linux::sched_getcpu_init();
5490   log_info(os)(&quot;HotSpot is running with %s, %s&quot;,
<a name="14" id="anc14"></a><span class="line-modified">5491                Linux::libc_version(), Linux::libpthread_version());</span>
5492 
5493   if (UseNUMA || UseNUMAInterleaving) {
5494     Linux::numa_init();
5495   }
5496 
5497   if (MaxFDLimit) {
5498     // set the number of file descriptors to max. print out error
5499     // if getrlimit/setrlimit fails but continue regardless.
5500     struct rlimit nbr_files;
5501     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
5502     if (status != 0) {
5503       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
5504     } else {
5505       nbr_files.rlim_cur = nbr_files.rlim_max;
5506       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
5507       if (status != 0) {
5508         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
5509       }
5510     }
5511   }
5512 
5513   // at-exit methods are called in the reverse order of their registration.
5514   // atexit functions are called on return from main or as a result of a
5515   // call to exit(3C). There can be only 32 of these functions registered
5516   // and atexit() does not set errno.
5517 
5518   if (PerfAllowAtExitRegistration) {
5519     // only register atexit functions if PerfAllowAtExitRegistration is set.
5520     // atexit functions can be delayed until process exit time, which
5521     // can be problematic for embedded VM situations. Embedded VMs should
5522     // call DestroyJavaVM() to assure that VM resources are released.
5523 
5524     // note: perfMemory_exit_helper atexit function may be removed in
5525     // the future if the appropriate cleanup code can be added to the
5526     // VM_Exit VMOperation&#39;s doit method.
5527     if (atexit(perfMemory_exit_helper) != 0) {
5528       warning(&quot;os::init_2 atexit(perfMemory_exit_helper) failed&quot;);
5529     }
5530   }
5531 
5532   // initialize thread priority policy
5533   prio_init();
5534 
5535   if (!FLAG_IS_DEFAULT(AllocateHeapAt) || !FLAG_IS_DEFAULT(AllocateOldGenAt)) {
5536     set_coredump_filter(DAX_SHARED_BIT);
5537   }
5538 
5539   if (DumpPrivateMappingsInCore) {
5540     set_coredump_filter(FILE_BACKED_PVT_BIT);
5541   }
5542 
5543   if (DumpSharedMappingsInCore) {
5544     set_coredump_filter(FILE_BACKED_SHARED_BIT);
5545   }
5546 
5547   return JNI_OK;
5548 }
5549 
5550 // older glibc versions don&#39;t have this macro (which expands to
5551 // an optimized bit-counting function) so we have to roll our own
5552 #ifndef CPU_COUNT
5553 
5554 static int _cpu_count(const cpu_set_t* cpus) {
5555   int count = 0;
5556   // only look up to the number of configured processors
5557   for (int i = 0; i &lt; os::processor_count(); i++) {
5558     if (CPU_ISSET(i, cpus)) {
5559       count++;
5560     }
5561   }
5562   return count;
5563 }
5564 
5565 #define CPU_COUNT(cpus) _cpu_count(cpus)
5566 
5567 #endif // CPU_COUNT
5568 
5569 // Get the current number of available processors for this process.
5570 // This value can change at any time during a process&#39;s lifetime.
5571 // sched_getaffinity gives an accurate answer as it accounts for cpusets.
5572 // If it appears there may be more than 1024 processors then we do a
5573 // dynamic check - see 6515172 for details.
5574 // If anything goes wrong we fallback to returning the number of online
5575 // processors - which can be greater than the number available to the process.
5576 int os::Linux::active_processor_count() {
5577   cpu_set_t cpus;  // can represent at most 1024 (CPU_SETSIZE) processors
5578   cpu_set_t* cpus_p = &amp;cpus;
5579   int cpus_size = sizeof(cpu_set_t);
5580 
5581   int configured_cpus = os::processor_count();  // upper bound on available cpus
5582   int cpu_count = 0;
5583 
5584 // old build platforms may not support dynamic cpu sets
5585 #ifdef CPU_ALLOC
5586 
5587   // To enable easy testing of the dynamic path on different platforms we
5588   // introduce a diagnostic flag: UseCpuAllocPath
5589   if (configured_cpus &gt;= CPU_SETSIZE || UseCpuAllocPath) {
5590     // kernel may use a mask bigger than cpu_set_t
5591     log_trace(os)(&quot;active_processor_count: using dynamic path %s&quot;
5592                   &quot;- configured processors: %d&quot;,
5593                   UseCpuAllocPath ? &quot;(forced) &quot; : &quot;&quot;,
5594                   configured_cpus);
5595     cpus_p = CPU_ALLOC(configured_cpus);
5596     if (cpus_p != NULL) {
5597       cpus_size = CPU_ALLOC_SIZE(configured_cpus);
5598       // zero it just to be safe
5599       CPU_ZERO_S(cpus_size, cpus_p);
5600     }
5601     else {
5602        // failed to allocate so fallback to online cpus
5603        int online_cpus = ::sysconf(_SC_NPROCESSORS_ONLN);
5604        log_trace(os)(&quot;active_processor_count: &quot;
5605                      &quot;CPU_ALLOC failed (%s) - using &quot;
5606                      &quot;online processor count: %d&quot;,
5607                      os::strerror(errno), online_cpus);
5608        return online_cpus;
5609     }
5610   }
5611   else {
5612     log_trace(os)(&quot;active_processor_count: using static path - configured processors: %d&quot;,
5613                   configured_cpus);
5614   }
5615 #else // CPU_ALLOC
5616 // these stubs won&#39;t be executed
5617 #define CPU_COUNT_S(size, cpus) -1
5618 #define CPU_FREE(cpus)
5619 
5620   log_trace(os)(&quot;active_processor_count: only static path available - configured processors: %d&quot;,
5621                 configured_cpus);
5622 #endif // CPU_ALLOC
5623 
5624   // pid 0 means the current thread - which we have to assume represents the process
5625   if (sched_getaffinity(0, cpus_size, cpus_p) == 0) {
5626     if (cpus_p != &amp;cpus) { // can only be true when CPU_ALLOC used
5627       cpu_count = CPU_COUNT_S(cpus_size, cpus_p);
5628     }
5629     else {
5630       cpu_count = CPU_COUNT(cpus_p);
5631     }
5632     log_trace(os)(&quot;active_processor_count: sched_getaffinity processor count: %d&quot;, cpu_count);
5633   }
5634   else {
5635     cpu_count = ::sysconf(_SC_NPROCESSORS_ONLN);
5636     warning(&quot;sched_getaffinity failed (%s)- using online processor count (%d) &quot;
5637             &quot;which may exceed available processors&quot;, os::strerror(errno), cpu_count);
5638   }
5639 
5640   if (cpus_p != &amp;cpus) { // can only be true when CPU_ALLOC used
5641     CPU_FREE(cpus_p);
5642   }
5643 
5644   assert(cpu_count &gt; 0 &amp;&amp; cpu_count &lt;= os::processor_count(), &quot;sanity check&quot;);
5645   return cpu_count;
5646 }
5647 
5648 // Determine the active processor count from one of
5649 // three different sources:
5650 //
5651 // 1. User option -XX:ActiveProcessorCount
5652 // 2. kernel os calls (sched_getaffinity or sysconf(_SC_NPROCESSORS_ONLN)
5653 // 3. extracted from cgroup cpu subsystem (shares and quotas)
5654 //
5655 // Option 1, if specified, will always override.
5656 // If the cgroup subsystem is active and configured, we
5657 // will return the min of the cgroup and option 2 results.
5658 // This is required since tools, such as numactl, that
5659 // alter cpu affinity do not update cgroup subsystem
5660 // cpuset configuration files.
5661 int os::active_processor_count() {
5662   // User has overridden the number of active processors
5663   if (ActiveProcessorCount &gt; 0) {
5664     log_trace(os)(&quot;active_processor_count: &quot;
5665                   &quot;active processor count set by user : %d&quot;,
5666                   ActiveProcessorCount);
5667     return ActiveProcessorCount;
5668   }
5669 
5670   int active_cpus;
5671   if (OSContainer::is_containerized()) {
5672     active_cpus = OSContainer::active_processor_count();
5673     log_trace(os)(&quot;active_processor_count: determined by OSContainer: %d&quot;,
5674                    active_cpus);
5675   } else {
5676     active_cpus = os::Linux::active_processor_count();
5677   }
5678 
5679   return active_cpus;
5680 }
5681 
5682 uint os::processor_id() {
5683   const int id = Linux::sched_getcpu();
5684   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
5685   return (uint)id;
5686 }
5687 
5688 void os::set_native_thread_name(const char *name) {
5689   if (Linux::_pthread_setname_np) {
5690     char buf [16]; // according to glibc manpage, 16 chars incl. &#39;/0&#39;
5691     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
5692     buf[sizeof(buf) - 1] = &#39;\0&#39;;
5693     const int rc = Linux::_pthread_setname_np(pthread_self(), buf);
5694     // ERANGE should not happen; all other errors should just be ignored.
5695     assert(rc != ERANGE, &quot;pthread_setname_np failed&quot;);
5696   }
5697 }
5698 
5699 bool os::bind_to_processor(uint processor_id) {
5700   // Not yet implemented.
5701   return false;
5702 }
5703 
5704 ///
5705 
5706 void os::SuspendedThreadTask::internal_do_task() {
5707   if (do_suspend(_thread-&gt;osthread())) {
5708     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
5709     do_task(context);
5710     do_resume(_thread-&gt;osthread());
5711   }
5712 }
5713 
5714 ////////////////////////////////////////////////////////////////////////////////
5715 // debug support
5716 
5717 bool os::find(address addr, outputStream* st) {
5718   Dl_info dlinfo;
5719   memset(&amp;dlinfo, 0, sizeof(dlinfo));
5720   if (dladdr(addr, &amp;dlinfo) != 0) {
5721     st-&gt;print(PTR_FORMAT &quot;: &quot;, p2i(addr));
5722     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
5723       st-&gt;print(&quot;%s+&quot; PTR_FORMAT, dlinfo.dli_sname,
5724                 p2i(addr) - p2i(dlinfo.dli_saddr));
5725     } else if (dlinfo.dli_fbase != NULL) {
5726       st-&gt;print(&quot;&lt;offset &quot; PTR_FORMAT &quot;&gt;&quot;, p2i(addr) - p2i(dlinfo.dli_fbase));
5727     } else {
5728       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
5729     }
5730     if (dlinfo.dli_fname != NULL) {
5731       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
5732     }
5733     if (dlinfo.dli_fbase != NULL) {
5734       st-&gt;print(&quot; at &quot; PTR_FORMAT, p2i(dlinfo.dli_fbase));
5735     }
5736     st-&gt;cr();
5737 
5738     if (Verbose) {
5739       // decode some bytes around the PC
5740       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
5741       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
5742       address       lowest = (address) dlinfo.dli_sname;
5743       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
5744       if (begin &lt; lowest)  begin = lowest;
5745       Dl_info dlinfo2;
5746       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
5747           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
5748         end = (address) dlinfo2.dli_saddr;
5749       }
5750       Disassembler::decode(begin, end, st);
5751     }
5752     return true;
5753   }
5754   return false;
5755 }
5756 
5757 ////////////////////////////////////////////////////////////////////////////////
5758 // misc
5759 
5760 // This does not do anything on Linux. This is basically a hook for being
5761 // able to use structured exception handling (thread-local exception filters)
5762 // on, e.g., Win32.
5763 void
5764 os::os_exception_wrapper(java_call_t f, JavaValue* value, const methodHandle&amp; method,
5765                          JavaCallArguments* args, Thread* thread) {
5766   f(value, method, args, thread);
5767 }
5768 
5769 void os::print_statistics() {
5770 }
5771 
5772 bool os::message_box(const char* title, const char* message) {
5773   int i;
5774   fdStream err(defaultStream::error_fd());
5775   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
5776   err.cr();
5777   err.print_raw_cr(title);
5778   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
5779   err.cr();
5780   err.print_raw_cr(message);
5781   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
5782   err.cr();
5783 
5784   char buf[16];
5785   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
5786   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
5787 
5788   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
5789 }
5790 
5791 // Is a (classpath) directory empty?
5792 bool os::dir_is_empty(const char* path) {
5793   DIR *dir = NULL;
5794   struct dirent *ptr;
5795 
5796   dir = opendir(path);
5797   if (dir == NULL) return true;
5798 
5799   // Scan the directory
5800   bool result = true;
5801   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
5802     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
5803       result = false;
5804     }
5805   }
5806   closedir(dir);
5807   return result;
5808 }
5809 
5810 // This code originates from JDK&#39;s sysOpen and open64_w
5811 // from src/solaris/hpi/src/system_md.c
5812 
5813 int os::open(const char *path, int oflag, int mode) {
5814   if (strlen(path) &gt; MAX_PATH - 1) {
5815     errno = ENAMETOOLONG;
5816     return -1;
5817   }
5818 
5819   // All file descriptors that are opened in the Java process and not
5820   // specifically destined for a subprocess should have the close-on-exec
5821   // flag set.  If we don&#39;t set it, then careless 3rd party native code
5822   // might fork and exec without closing all appropriate file descriptors
5823   // (e.g. as we do in closeDescriptors in UNIXProcess.c), and this in
5824   // turn might:
5825   //
5826   // - cause end-of-file to fail to be detected on some file
5827   //   descriptors, resulting in mysterious hangs, or
5828   //
5829   // - might cause an fopen in the subprocess to fail on a system
5830   //   suffering from bug 1085341.
5831   //
5832   // (Yes, the default setting of the close-on-exec flag is a Unix
5833   // design flaw)
5834   //
5835   // See:
5836   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
5837   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
5838   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
5839   //
5840   // Modern Linux kernels (after 2.6.23 2007) support O_CLOEXEC with open().
5841   // O_CLOEXEC is preferable to using FD_CLOEXEC on an open file descriptor
5842   // because it saves a system call and removes a small window where the flag
5843   // is unset.  On ancient Linux kernels the O_CLOEXEC flag will be ignored
5844   // and we fall back to using FD_CLOEXEC (see below).
5845 #ifdef O_CLOEXEC
5846   oflag |= O_CLOEXEC;
5847 #endif
5848 
5849   int fd = ::open64(path, oflag, mode);
5850   if (fd == -1) return -1;
5851 
5852   //If the open succeeded, the file might still be a directory
5853   {
5854     struct stat64 buf64;
5855     int ret = ::fstat64(fd, &amp;buf64);
5856     int st_mode = buf64.st_mode;
5857 
5858     if (ret != -1) {
5859       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
5860         errno = EISDIR;
5861         ::close(fd);
5862         return -1;
5863       }
5864     } else {
5865       ::close(fd);
5866       return -1;
5867     }
5868   }
5869 
5870 #ifdef FD_CLOEXEC
5871   // Validate that the use of the O_CLOEXEC flag on open above worked.
5872   // With recent kernels, we will perform this check exactly once.
5873   static sig_atomic_t O_CLOEXEC_is_known_to_work = 0;
5874   if (!O_CLOEXEC_is_known_to_work) {
5875     int flags = ::fcntl(fd, F_GETFD);
5876     if (flags != -1) {
5877       if ((flags &amp; FD_CLOEXEC) != 0)
5878         O_CLOEXEC_is_known_to_work = 1;
5879       else
5880         ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
5881     }
5882   }
5883 #endif
5884 
5885   return fd;
5886 }
5887 
5888 
5889 // create binary file, rewriting existing file if required
5890 int os::create_binary_file(const char* path, bool rewrite_existing) {
5891   int oflags = O_WRONLY | O_CREAT;
5892   if (!rewrite_existing) {
5893     oflags |= O_EXCL;
5894   }
5895   return ::open64(path, oflags, S_IREAD | S_IWRITE);
5896 }
5897 
5898 // return current position of file pointer
5899 jlong os::current_file_offset(int fd) {
5900   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
5901 }
5902 
5903 // move file pointer to the specified offset
5904 jlong os::seek_to_file_offset(int fd, jlong offset) {
5905   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
5906 }
5907 
5908 // This code originates from JDK&#39;s sysAvailable
5909 // from src/solaris/hpi/src/native_threads/src/sys_api_td.c
5910 
5911 int os::available(int fd, jlong *bytes) {
5912   jlong cur, end;
5913   int mode;
5914   struct stat64 buf64;
5915 
5916   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
5917     mode = buf64.st_mode;
5918     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
5919       int n;
5920       if (::ioctl(fd, FIONREAD, &amp;n) &gt;= 0) {
5921         *bytes = n;
5922         return 1;
5923       }
5924     }
5925   }
5926   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
5927     return 0;
5928   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
5929     return 0;
5930   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
5931     return 0;
5932   }
5933   *bytes = end - cur;
5934   return 1;
5935 }
5936 
5937 // Map a block of memory.
5938 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
5939                         char *addr, size_t bytes, bool read_only,
5940                         bool allow_exec) {
5941   int prot;
5942   int flags = MAP_PRIVATE;
5943 
5944   if (read_only) {
5945     prot = PROT_READ;
5946   } else {
5947     prot = PROT_READ | PROT_WRITE;
5948   }
5949 
5950   if (allow_exec) {
5951     prot |= PROT_EXEC;
5952   }
5953 
5954   if (addr != NULL) {
5955     flags |= MAP_FIXED;
5956   }
5957 
5958   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
5959                                      fd, file_offset);
5960   if (mapped_address == MAP_FAILED) {
5961     return NULL;
5962   }
5963   return mapped_address;
5964 }
5965 
5966 
5967 // Remap a block of memory.
5968 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
5969                           char *addr, size_t bytes, bool read_only,
5970                           bool allow_exec) {
5971   // same as map_memory() on this OS
5972   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
5973                         allow_exec);
5974 }
5975 
5976 
5977 // Unmap a block of memory.
5978 bool os::pd_unmap_memory(char* addr, size_t bytes) {
5979   return munmap(addr, bytes) == 0;
5980 }
5981 
5982 static jlong slow_thread_cpu_time(Thread *thread, bool user_sys_cpu_time);
5983 
5984 static jlong fast_cpu_time(Thread *thread) {
5985     clockid_t clockid;
5986     int rc = os::Linux::pthread_getcpuclockid(thread-&gt;osthread()-&gt;pthread_id(),
5987                                               &amp;clockid);
5988     if (rc == 0) {
5989       return os::Linux::fast_thread_cpu_time(clockid);
5990     } else {
5991       // It&#39;s possible to encounter a terminated native thread that failed
5992       // to detach itself from the VM - which should result in ESRCH.
5993       assert_status(rc == ESRCH, rc, &quot;pthread_getcpuclockid failed&quot;);
5994       return -1;
5995     }
5996 }
5997 
5998 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
5999 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
6000 // of a thread.
6001 //
6002 // current_thread_cpu_time() and thread_cpu_time(Thread*) returns
6003 // the fast estimate available on the platform.
6004 
6005 jlong os::current_thread_cpu_time() {
6006   if (os::Linux::supports_fast_thread_cpu_time()) {
6007     return os::Linux::fast_thread_cpu_time(CLOCK_THREAD_CPUTIME_ID);
6008   } else {
6009     // return user + sys since the cost is the same
6010     return slow_thread_cpu_time(Thread::current(), true /* user + sys */);
6011   }
6012 }
6013 
6014 jlong os::thread_cpu_time(Thread* thread) {
6015   // consistent with what current_thread_cpu_time() returns
6016   if (os::Linux::supports_fast_thread_cpu_time()) {
6017     return fast_cpu_time(thread);
6018   } else {
6019     return slow_thread_cpu_time(thread, true /* user + sys */);
6020   }
6021 }
6022 
6023 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
6024   if (user_sys_cpu_time &amp;&amp; os::Linux::supports_fast_thread_cpu_time()) {
6025     return os::Linux::fast_thread_cpu_time(CLOCK_THREAD_CPUTIME_ID);
6026   } else {
6027     return slow_thread_cpu_time(Thread::current(), user_sys_cpu_time);
6028   }
6029 }
6030 
6031 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
6032   if (user_sys_cpu_time &amp;&amp; os::Linux::supports_fast_thread_cpu_time()) {
6033     return fast_cpu_time(thread);
6034   } else {
6035     return slow_thread_cpu_time(thread, user_sys_cpu_time);
6036   }
6037 }
6038 
6039 //  -1 on error.
6040 static jlong slow_thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
6041   pid_t  tid = thread-&gt;osthread()-&gt;thread_id();
6042   char *s;
6043   char stat[2048];
6044   int statlen;
6045   char proc_name[64];
6046   int count;
6047   long sys_time, user_time;
6048   char cdummy;
6049   int idummy;
6050   long ldummy;
6051   FILE *fp;
6052 
6053   snprintf(proc_name, 64, &quot;/proc/self/task/%d/stat&quot;, tid);
6054   fp = fopen(proc_name, &quot;r&quot;);
6055   if (fp == NULL) return -1;
6056   statlen = fread(stat, 1, 2047, fp);
6057   stat[statlen] = &#39;\0&#39;;
6058   fclose(fp);
6059 
6060   // Skip pid and the command string. Note that we could be dealing with
6061   // weird command names, e.g. user could decide to rename java launcher
6062   // to &quot;java 1.4.2 :)&quot;, then the stat file would look like
6063   //                1234 (java 1.4.2 :)) R ... ...
6064   // We don&#39;t really need to know the command string, just find the last
6065   // occurrence of &quot;)&quot; and then start parsing from there. See bug 4726580.
6066   s = strrchr(stat, &#39;)&#39;);
6067   if (s == NULL) return -1;
6068 
6069   // Skip blank chars
6070   do { s++; } while (s &amp;&amp; isspace(*s));
6071 
6072   count = sscanf(s,&quot;%c %d %d %d %d %d %lu %lu %lu %lu %lu %lu %lu&quot;,
6073                  &amp;cdummy, &amp;idummy, &amp;idummy, &amp;idummy, &amp;idummy, &amp;idummy,
6074                  &amp;ldummy, &amp;ldummy, &amp;ldummy, &amp;ldummy, &amp;ldummy,
6075                  &amp;user_time, &amp;sys_time);
6076   if (count != 13) return -1;
6077   if (user_sys_cpu_time) {
6078     return ((jlong)sys_time + (jlong)user_time) * (1000000000 / clock_tics_per_sec);
6079   } else {
6080     return (jlong)user_time * (1000000000 / clock_tics_per_sec);
6081   }
6082 }
6083 
6084 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
6085   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
6086   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
6087   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
6088   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
6089 }
6090 
6091 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
6092   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
6093   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
6094   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
6095   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
6096 }
6097 
6098 bool os::is_thread_cpu_time_supported() {
6099   return true;
6100 }
6101 
6102 // System loadavg support.  Returns -1 if load average cannot be obtained.
6103 // Linux doesn&#39;t yet have a (official) notion of processor sets,
6104 // so just return the system wide load average.
6105 int os::loadavg(double loadavg[], int nelem) {
6106   return ::getloadavg(loadavg, nelem);
6107 }
6108 
6109 void os::pause() {
6110   char filename[MAX_PATH];
6111   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
6112     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
6113   } else {
6114     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
6115   }
6116 
6117   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
6118   if (fd != -1) {
6119     struct stat buf;
6120     ::close(fd);
6121     while (::stat(filename, &amp;buf) == 0) {
6122       (void)::poll(NULL, 0, 100);
6123     }
6124   } else {
6125     jio_fprintf(stderr,
6126                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
6127   }
6128 }
6129 
6130 extern char** environ;
6131 
6132 // Run the specified command in a separate process. Return its exit value,
6133 // or -1 on failure (e.g. can&#39;t fork a new process).
6134 // Unlike system(), this function can be called from signal handler. It
6135 // doesn&#39;t block SIGINT et al.
6136 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
6137   const char * argv[4] = {&quot;sh&quot;, &quot;-c&quot;, cmd, NULL};
6138 
6139   pid_t pid ;
6140 
6141   if (use_vfork_if_available) {
6142     pid = vfork();
6143   } else {
6144     pid = fork();
6145   }
6146 
6147   if (pid &lt; 0) {
6148     // fork failed
6149     return -1;
6150 
6151   } else if (pid == 0) {
6152     // child process
6153 
6154     execve(&quot;/bin/sh&quot;, (char* const*)argv, environ);
6155 
6156     // execve failed
6157     _exit(-1);
6158 
6159   } else  {
6160     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
6161     // care about the actual exit code, for now.
6162 
6163     int status;
6164 
6165     // Wait for the child process to exit.  This returns immediately if
6166     // the child has already exited. */
6167     while (waitpid(pid, &amp;status, 0) &lt; 0) {
6168       switch (errno) {
6169       case ECHILD: return 0;
6170       case EINTR: break;
6171       default: return -1;
6172       }
6173     }
6174 
6175     if (WIFEXITED(status)) {
6176       // The child exited normally; get its exit code.
6177       return WEXITSTATUS(status);
6178     } else if (WIFSIGNALED(status)) {
6179       // The child exited because of a signal
6180       // The best value to return is 0x80 + signal number,
6181       // because that is what all Unix shells do, and because
6182       // it allows callers to distinguish between process exit and
6183       // process death by signal.
6184       return 0x80 + WTERMSIG(status);
6185     } else {
6186       // Unknown exit code; pass it through
6187       return status;
6188     }
6189   }
6190 }
6191 
6192 // Get the default path to the core file
6193 // Returns the length of the string
6194 int os::get_core_path(char* buffer, size_t bufferSize) {
6195   /*
6196    * Max length of /proc/sys/kernel/core_pattern is 128 characters.
6197    * See https://www.kernel.org/doc/Documentation/sysctl/kernel.txt
6198    */
6199   const int core_pattern_len = 129;
6200   char core_pattern[core_pattern_len] = {0};
6201 
6202   int core_pattern_file = ::open(&quot;/proc/sys/kernel/core_pattern&quot;, O_RDONLY);
6203   if (core_pattern_file == -1) {
6204     return -1;
6205   }
6206 
6207   ssize_t ret = ::read(core_pattern_file, core_pattern, core_pattern_len);
6208   ::close(core_pattern_file);
6209   if (ret &lt;= 0 || ret &gt;= core_pattern_len || core_pattern[0] == &#39;\n&#39;) {
6210     return -1;
6211   }
6212   if (core_pattern[ret-1] == &#39;\n&#39;) {
6213     core_pattern[ret-1] = &#39;\0&#39;;
6214   } else {
6215     core_pattern[ret] = &#39;\0&#39;;
6216   }
6217 
6218   // Replace the %p in the core pattern with the process id. NOTE: we do this
6219   // only if the pattern doesn&#39;t start with &quot;|&quot;, and we support only one %p in
6220   // the pattern.
6221   char *pid_pos = strstr(core_pattern, &quot;%p&quot;);
6222   const char* tail = (pid_pos != NULL) ? (pid_pos + 2) : &quot;&quot;;  // skip over the &quot;%p&quot;
6223   int written;
6224 
6225   if (core_pattern[0] == &#39;/&#39;) {
6226     if (pid_pos != NULL) {
6227       *pid_pos = &#39;\0&#39;;
6228       written = jio_snprintf(buffer, bufferSize, &quot;%s%d%s&quot;, core_pattern,
6229                              current_process_id(), tail);
6230     } else {
6231       written = jio_snprintf(buffer, bufferSize, &quot;%s&quot;, core_pattern);
6232     }
6233   } else {
6234     char cwd[PATH_MAX];
6235 
6236     const char* p = get_current_directory(cwd, PATH_MAX);
6237     if (p == NULL) {
6238       return -1;
6239     }
6240 
6241     if (core_pattern[0] == &#39;|&#39;) {
6242       written = jio_snprintf(buffer, bufferSize,
6243                              &quot;\&quot;%s\&quot; (or dumping to %s/core.%d)&quot;,
6244                              &amp;core_pattern[1], p, current_process_id());
6245     } else if (pid_pos != NULL) {
6246       *pid_pos = &#39;\0&#39;;
6247       written = jio_snprintf(buffer, bufferSize, &quot;%s/%s%d%s&quot;, p, core_pattern,
6248                              current_process_id(), tail);
6249     } else {
6250       written = jio_snprintf(buffer, bufferSize, &quot;%s/%s&quot;, p, core_pattern);
6251     }
6252   }
6253 
6254   if (written &lt; 0) {
6255     return -1;
6256   }
6257 
6258   if (((size_t)written &lt; bufferSize) &amp;&amp; (pid_pos == NULL) &amp;&amp; (core_pattern[0] != &#39;|&#39;)) {
6259     int core_uses_pid_file = ::open(&quot;/proc/sys/kernel/core_uses_pid&quot;, O_RDONLY);
6260 
6261     if (core_uses_pid_file != -1) {
6262       char core_uses_pid = 0;
6263       ssize_t ret = ::read(core_uses_pid_file, &amp;core_uses_pid, 1);
6264       ::close(core_uses_pid_file);
6265 
6266       if (core_uses_pid == &#39;1&#39;) {
6267         jio_snprintf(buffer + written, bufferSize - written,
6268                                           &quot;.%d&quot;, current_process_id());
6269       }
6270     }
6271   }
6272 
6273   return strlen(buffer);
6274 }
6275 
6276 bool os::start_debugging(char *buf, int buflen) {
6277   int len = (int)strlen(buf);
6278   char *p = &amp;buf[len];
6279 
6280   jio_snprintf(p, buflen-len,
6281                &quot;\n\n&quot;
6282                &quot;Do you want to debug the problem?\n\n&quot;
6283                &quot;To debug, run &#39;gdb /proc/%d/exe %d&#39;; then switch to thread &quot; UINTX_FORMAT &quot; (&quot; INTPTR_FORMAT &quot;)\n&quot;
6284                &quot;Enter &#39;yes&#39; to launch gdb automatically (PATH must include gdb)\n&quot;
6285                &quot;Otherwise, press RETURN to abort...&quot;,
6286                os::current_process_id(), os::current_process_id(),
6287                os::current_thread_id(), os::current_thread_id());
6288 
6289   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
6290 
6291   if (yes) {
6292     // yes, user asked VM to launch debugger
6293     jio_snprintf(buf, sizeof(char)*buflen, &quot;gdb /proc/%d/exe %d&quot;,
6294                  os::current_process_id(), os::current_process_id());
6295 
6296     os::fork_and_exec(buf);
6297     yes = false;
6298   }
6299   return yes;
6300 }
6301 
6302 
6303 // Java/Compiler thread:
6304 //
6305 //   Low memory addresses
6306 // P0 +------------------------+
6307 //    |                        |\  Java thread created by VM does not have glibc
6308 //    |    glibc guard page    | - guard page, attached Java thread usually has
6309 //    |                        |/  1 glibc guard page.
6310 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
6311 //    |                        |\
6312 //    |  HotSpot Guard Pages   | - red, yellow and reserved pages
6313 //    |                        |/
6314 //    +------------------------+ JavaThread::stack_reserved_zone_base()
6315 //    |                        |\
6316 //    |      Normal Stack      | -
6317 //    |                        |/
6318 // P2 +------------------------+ Thread::stack_base()
6319 //
6320 // Non-Java thread:
6321 //
6322 //   Low memory addresses
6323 // P0 +------------------------+
6324 //    |                        |\
6325 //    |  glibc guard page      | - usually 1 page
6326 //    |                        |/
6327 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
6328 //    |                        |\
6329 //    |      Normal Stack      | -
6330 //    |                        |/
6331 // P2 +------------------------+ Thread::stack_base()
6332 //
6333 // ** P1 (aka bottom) and size (P2 = P1 - size) are the address and stack size
6334 //    returned from pthread_attr_getstack().
6335 // ** Due to NPTL implementation error, linux takes the glibc guard page out
6336 //    of the stack size given in pthread_attr. We work around this for
6337 //    threads created by the VM. (We adapt bottom to be P1 and size accordingly.)
6338 //
6339 #ifndef ZERO
6340 static void current_stack_region(address * bottom, size_t * size) {
6341   if (os::is_primordial_thread()) {
6342     // primordial thread needs special handling because pthread_getattr_np()
6343     // may return bogus value.
6344     *bottom = os::Linux::initial_thread_stack_bottom();
6345     *size   = os::Linux::initial_thread_stack_size();
6346   } else {
6347     pthread_attr_t attr;
6348 
6349     int rslt = pthread_getattr_np(pthread_self(), &amp;attr);
6350 
6351     // JVM needs to know exact stack location, abort if it fails
6352     if (rslt != 0) {
6353       if (rslt == ENOMEM) {
6354         vm_exit_out_of_memory(0, OOM_MMAP_ERROR, &quot;pthread_getattr_np&quot;);
6355       } else {
6356         fatal(&quot;pthread_getattr_np failed with error = %d&quot;, rslt);
6357       }
6358     }
6359 
6360     if (pthread_attr_getstack(&amp;attr, (void **)bottom, size) != 0) {
6361       fatal(&quot;Cannot locate current stack attributes!&quot;);
6362     }
6363 
6364     // Work around NPTL stack guard error.
6365     size_t guard_size = 0;
6366     rslt = pthread_attr_getguardsize(&amp;attr, &amp;guard_size);
6367     if (rslt != 0) {
6368       fatal(&quot;pthread_attr_getguardsize failed with error = %d&quot;, rslt);
6369     }
6370     *bottom += guard_size;
6371     *size   -= guard_size;
6372 
6373     pthread_attr_destroy(&amp;attr);
6374 
6375   }
6376   assert(os::current_stack_pointer() &gt;= *bottom &amp;&amp;
6377          os::current_stack_pointer() &lt; *bottom + *size, &quot;just checking&quot;);
6378 }
6379 
6380 address os::current_stack_base() {
6381   address bottom;
6382   size_t size;
6383   current_stack_region(&amp;bottom, &amp;size);
6384   return (bottom + size);
6385 }
6386 
6387 size_t os::current_stack_size() {
6388   // This stack size includes the usable stack and HotSpot guard pages
6389   // (for the threads that have Hotspot guard pages).
6390   address bottom;
6391   size_t size;
6392   current_stack_region(&amp;bottom, &amp;size);
6393   return size;
6394 }
6395 #endif
6396 
6397 static inline struct timespec get_mtime(const char* filename) {
6398   struct stat st;
6399   int ret = os::stat(filename, &amp;st);
6400   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
6401   return st.st_mtim;
6402 }
6403 
6404 int os::compare_file_modified_times(const char* file1, const char* file2) {
6405   struct timespec filetime1 = get_mtime(file1);
6406   struct timespec filetime2 = get_mtime(file2);
6407   int diff = filetime1.tv_sec - filetime2.tv_sec;
6408   if (diff == 0) {
6409     return filetime1.tv_nsec - filetime2.tv_nsec;
6410   }
6411   return diff;
6412 }
6413 
6414 bool os::supports_map_sync() {
6415   return true;
6416 }
6417 
6418 /////////////// Unit tests ///////////////
6419 
6420 #ifndef PRODUCT
6421 
6422 class TestReserveMemorySpecial : AllStatic {
6423  public:
6424   static void small_page_write(void* addr, size_t size) {
6425     size_t page_size = os::vm_page_size();
6426 
6427     char* end = (char*)addr + size;
6428     for (char* p = (char*)addr; p &lt; end; p += page_size) {
6429       *p = 1;
6430     }
6431   }
6432 
6433   static void test_reserve_memory_special_huge_tlbfs_only(size_t size) {
6434     if (!UseHugeTLBFS) {
6435       return;
6436     }
6437 
6438     char* addr = os::Linux::reserve_memory_special_huge_tlbfs_only(size, NULL, false);
6439 
6440     if (addr != NULL) {
6441       small_page_write(addr, size);
6442 
6443       os::Linux::release_memory_special_huge_tlbfs(addr, size);
6444     }
6445   }
6446 
6447   static void test_reserve_memory_special_huge_tlbfs_only() {
6448     if (!UseHugeTLBFS) {
6449       return;
6450     }
6451 
6452     size_t lp = os::large_page_size();
6453 
6454     for (size_t size = lp; size &lt;= lp * 10; size += lp) {
6455       test_reserve_memory_special_huge_tlbfs_only(size);
6456     }
6457   }
6458 
6459   static void test_reserve_memory_special_huge_tlbfs_mixed() {
6460     size_t lp = os::large_page_size();
6461     size_t ag = os::vm_allocation_granularity();
6462 
6463     // sizes to test
6464     const size_t sizes[] = {
6465       lp, lp + ag, lp + lp / 2, lp * 2,
6466       lp * 2 + ag, lp * 2 - ag, lp * 2 + lp / 2,
6467       lp * 10, lp * 10 + lp / 2
6468     };
6469     const int num_sizes = sizeof(sizes) / sizeof(size_t);
6470 
6471     // For each size/alignment combination, we test three scenarios:
6472     // 1) with req_addr == NULL
6473     // 2) with a non-null req_addr at which we expect to successfully allocate
6474     // 3) with a non-null req_addr which contains a pre-existing mapping, at which we
6475     //    expect the allocation to either fail or to ignore req_addr
6476 
6477     // Pre-allocate two areas; they shall be as large as the largest allocation
6478     //  and aligned to the largest alignment we will be testing.
6479     const size_t mapping_size = sizes[num_sizes - 1] * 2;
6480     char* const mapping1 = (char*) ::mmap(NULL, mapping_size,
6481       PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
6482       -1, 0);
6483     assert(mapping1 != MAP_FAILED, &quot;should work&quot;);
6484 
6485     char* const mapping2 = (char*) ::mmap(NULL, mapping_size,
6486       PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
6487       -1, 0);
6488     assert(mapping2 != MAP_FAILED, &quot;should work&quot;);
6489 
6490     // Unmap the first mapping, but leave the second mapping intact: the first
6491     // mapping will serve as a value for a &quot;good&quot; req_addr (case 2). The second
6492     // mapping, still intact, as &quot;bad&quot; req_addr (case 3).
6493     ::munmap(mapping1, mapping_size);
6494 
6495     // Case 1
6496     for (int i = 0; i &lt; num_sizes; i++) {
6497       const size_t size = sizes[i];
6498       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6499         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, NULL, false);
6500         if (p != NULL) {
6501           assert(is_aligned(p, alignment), &quot;must be&quot;);
6502           small_page_write(p, size);
6503           os::Linux::release_memory_special_huge_tlbfs(p, size);
6504         }
6505       }
6506     }
6507 
6508     // Case 2
6509     for (int i = 0; i &lt; num_sizes; i++) {
6510       const size_t size = sizes[i];
6511       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6512         char* const req_addr = align_up(mapping1, alignment);
6513         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, req_addr, false);
6514         if (p != NULL) {
6515           assert(p == req_addr, &quot;must be&quot;);
6516           small_page_write(p, size);
6517           os::Linux::release_memory_special_huge_tlbfs(p, size);
6518         }
6519       }
6520     }
6521 
6522     // Case 3
6523     for (int i = 0; i &lt; num_sizes; i++) {
6524       const size_t size = sizes[i];
6525       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6526         char* const req_addr = align_up(mapping2, alignment);
6527         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, req_addr, false);
6528         // as the area around req_addr contains already existing mappings, the API should always
6529         // return NULL (as per contract, it cannot return another address)
6530         assert(p == NULL, &quot;must be&quot;);
6531       }
6532     }
6533 
6534     ::munmap(mapping2, mapping_size);
6535 
6536   }
6537 
6538   static void test_reserve_memory_special_huge_tlbfs() {
6539     if (!UseHugeTLBFS) {
6540       return;
6541     }
6542 
6543     test_reserve_memory_special_huge_tlbfs_only();
6544     test_reserve_memory_special_huge_tlbfs_mixed();
6545   }
6546 
6547   static void test_reserve_memory_special_shm(size_t size, size_t alignment) {
6548     if (!UseSHM) {
6549       return;
6550     }
6551 
6552     char* addr = os::Linux::reserve_memory_special_shm(size, alignment, NULL, false);
6553 
6554     if (addr != NULL) {
6555       assert(is_aligned(addr, alignment), &quot;Check&quot;);
6556       assert(is_aligned(addr, os::large_page_size()), &quot;Check&quot;);
6557 
6558       small_page_write(addr, size);
6559 
6560       os::Linux::release_memory_special_shm(addr, size);
6561     }
6562   }
6563 
6564   static void test_reserve_memory_special_shm() {
6565     size_t lp = os::large_page_size();
6566     size_t ag = os::vm_allocation_granularity();
6567 
6568     for (size_t size = ag; size &lt; lp * 3; size += ag) {
6569       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6570         test_reserve_memory_special_shm(size, alignment);
6571       }
6572     }
6573   }
6574 
6575   static void test() {
6576     test_reserve_memory_special_huge_tlbfs();
6577     test_reserve_memory_special_shm();
6578   }
6579 };
6580 
6581 void TestReserveMemorySpecial_test() {
6582   TestReserveMemorySpecial::test();
6583 }
6584 
6585 #endif
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>