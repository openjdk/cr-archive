<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/gc/g1/g1CollectedHeap.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/metadataOnStackMark.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;code/codeCache.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;gc/g1/g1Allocator.inline.hpp&quot;
  32 #include &quot;gc/g1/g1Arguments.hpp&quot;
  33 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  34 #include &quot;gc/g1/g1CardTableEntryClosure.hpp&quot;
  35 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  36 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  37 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  38 #include &quot;gc/g1/g1ConcurrentRefine.hpp&quot;
  39 #include &quot;gc/g1/g1ConcurrentRefineThread.hpp&quot;
  40 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  41 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  42 #include &quot;gc/g1/g1EvacStats.inline.hpp&quot;
  43 #include &quot;gc/g1/g1FullCollector.hpp&quot;
  44 #include &quot;gc/g1/g1GCParPhaseTimesTracker.hpp&quot;
  45 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  46 #include &quot;gc/g1/g1HeapSizingPolicy.hpp&quot;
  47 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  48 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  49 #include &quot;gc/g1/g1HotCardCache.hpp&quot;
  50 #include &quot;gc/g1/g1InitLogger.hpp&quot;
  51 #include &quot;gc/g1/g1MemoryPool.hpp&quot;
  52 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  53 #include &quot;gc/g1/g1ParallelCleaning.hpp&quot;
  54 #include &quot;gc/g1/g1ParScanThreadState.inline.hpp&quot;
  55 #include &quot;gc/g1/g1Policy.hpp&quot;
  56 #include &quot;gc/g1/g1RedirtyCardsQueue.hpp&quot;
  57 #include &quot;gc/g1/g1RegionToSpaceMapper.hpp&quot;
  58 #include &quot;gc/g1/g1RemSet.hpp&quot;
  59 #include &quot;gc/g1/g1RootClosures.hpp&quot;
  60 #include &quot;gc/g1/g1RootProcessor.hpp&quot;
  61 #include &quot;gc/g1/g1SATBMarkQueueSet.hpp&quot;
  62 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  63 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  64 #include &quot;gc/g1/g1Trace.hpp&quot;
  65 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  66 #include &quot;gc/g1/g1YoungRemSetSamplingThread.hpp&quot;
  67 #include &quot;gc/g1/g1VMOperations.hpp&quot;
  68 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  69 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  70 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  71 #include &quot;gc/shared/concurrentGCBreakpoints.hpp&quot;
  72 #include &quot;gc/shared/gcBehaviours.hpp&quot;
  73 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  74 #include &quot;gc/shared/gcId.hpp&quot;
  75 #include &quot;gc/shared/gcLocker.hpp&quot;
  76 #include &quot;gc/shared/gcTimer.hpp&quot;
  77 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  78 #include &quot;gc/shared/generationSpec.hpp&quot;
  79 #include &quot;gc/shared/isGCActiveMark.hpp&quot;
  80 #include &quot;gc/shared/locationPrinter.inline.hpp&quot;
  81 #include &quot;gc/shared/oopStorageParState.hpp&quot;
  82 #include &quot;gc/shared/preservedMarks.inline.hpp&quot;
  83 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  84 #include &quot;gc/shared/referenceProcessor.inline.hpp&quot;
  85 #include &quot;gc/shared/taskTerminator.hpp&quot;
  86 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  87 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  88 #include &quot;gc/shared/workerPolicy.hpp&quot;
  89 #include &quot;logging/log.hpp&quot;
  90 #include &quot;memory/allocation.hpp&quot;
  91 #include &quot;memory/iterator.hpp&quot;
  92 #include &quot;memory/resourceArea.hpp&quot;
  93 #include &quot;memory/universe.hpp&quot;
  94 #include &quot;oops/access.inline.hpp&quot;
  95 #include &quot;oops/compressedOops.inline.hpp&quot;
  96 #include &quot;oops/oop.inline.hpp&quot;
  97 #include &quot;runtime/atomic.hpp&quot;
  98 #include &quot;runtime/handles.inline.hpp&quot;
  99 #include &quot;runtime/init.hpp&quot;
 100 #include &quot;runtime/orderAccess.hpp&quot;
 101 #include &quot;runtime/threadSMR.hpp&quot;
 102 #include &quot;runtime/vmThread.hpp&quot;
 103 #include &quot;utilities/align.hpp&quot;
 104 #include &quot;utilities/autoRestore.hpp&quot;
 105 #include &quot;utilities/bitMap.inline.hpp&quot;
 106 #include &quot;utilities/globalDefinitions.hpp&quot;
 107 #include &quot;utilities/stack.inline.hpp&quot;
 108 
 109 size_t G1CollectedHeap::_humongous_object_threshold_in_words = 0;
 110 
 111 // INVARIANTS/NOTES
 112 //
 113 // All allocation activity covered by the G1CollectedHeap interface is
 114 // serialized by acquiring the HeapLock.  This happens in mem_allocate
 115 // and allocate_new_tlab, which are the &quot;entry&quot; points to the
 116 // allocation code from the rest of the JVM.  (Note that this does not
 117 // apply to TLAB allocation, which is not part of this interface: it
 118 // is done by clients of this interface.)
 119 
 120 class RedirtyLoggedCardTableEntryClosure : public G1CardTableEntryClosure {
 121  private:
 122   size_t _num_dirtied;
 123   G1CollectedHeap* _g1h;
 124   G1CardTable* _g1_ct;
 125 
 126   HeapRegion* region_for_card(CardValue* card_ptr) const {
 127     return _g1h-&gt;heap_region_containing(_g1_ct-&gt;addr_for(card_ptr));
 128   }
 129 
 130   bool will_become_free(HeapRegion* hr) const {
 131     // A region will be freed by free_collection_set if the region is in the
 132     // collection set and has not had an evacuation failure.
 133     return _g1h-&gt;is_in_cset(hr) &amp;&amp; !hr-&gt;evacuation_failed();
 134   }
 135 
 136  public:
 137   RedirtyLoggedCardTableEntryClosure(G1CollectedHeap* g1h) : G1CardTableEntryClosure(),
 138     _num_dirtied(0), _g1h(g1h), _g1_ct(g1h-&gt;card_table()) { }
 139 
 140   void do_card_ptr(CardValue* card_ptr, uint worker_id) {
 141     HeapRegion* hr = region_for_card(card_ptr);
 142 
 143     // Should only dirty cards in regions that won&#39;t be freed.
 144     if (!will_become_free(hr)) {
 145       *card_ptr = G1CardTable::dirty_card_val();
 146       _num_dirtied++;
 147     }
 148   }
 149 
 150   size_t num_dirtied()   const { return _num_dirtied; }
 151 };
 152 
 153 
 154 void G1RegionMappingChangedListener::reset_from_card_cache(uint start_idx, size_t num_regions) {
 155   HeapRegionRemSet::invalidate_from_card_cache(start_idx, num_regions);
 156 }
 157 
 158 void G1RegionMappingChangedListener::on_commit(uint start_idx, size_t num_regions, bool zero_filled) {
 159   // The from card cache is not the memory that is actually committed. So we cannot
 160   // take advantage of the zero_filled parameter.
 161   reset_from_card_cache(start_idx, num_regions);
 162 }
 163 
 164 Tickspan G1CollectedHeap::run_task(AbstractGangTask* task) {
 165   Ticks start = Ticks::now();
 166   workers()-&gt;run_task(task, workers()-&gt;active_workers());
 167   return Ticks::now() - start;
 168 }
 169 
 170 HeapRegion* G1CollectedHeap::new_heap_region(uint hrs_index,
 171                                              MemRegion mr) {
 172   return new HeapRegion(hrs_index, bot(), mr);
 173 }
 174 
 175 // Private methods.
 176 
 177 HeapRegion* G1CollectedHeap::new_region(size_t word_size,
 178                                         HeapRegionType type,
 179                                         bool do_expand,
 180                                         uint node_index) {
 181   assert(!is_humongous(word_size) || word_size &lt;= HeapRegion::GrainWords,
 182          &quot;the only time we use this to allocate a humongous region is &quot;
 183          &quot;when we are allocating a single humongous region&quot;);
 184 
 185   HeapRegion* res = _hrm-&gt;allocate_free_region(type, node_index);
 186 
 187   if (res == NULL &amp;&amp; do_expand &amp;&amp; _expand_heap_after_alloc_failure) {
 188     // Currently, only attempts to allocate GC alloc regions set
 189     // do_expand to true. So, we should only reach here during a
 190     // safepoint. If this assumption changes we might have to
 191     // reconsider the use of _expand_heap_after_alloc_failure.
 192     assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 193 
 194     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (region allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 195                               word_size * HeapWordSize);
 196 
 197     assert(word_size * HeapWordSize &lt; HeapRegion::GrainBytes,
 198            &quot;This kind of expansion should never be more than one region. Size: &quot; SIZE_FORMAT,
 199            word_size * HeapWordSize);
 200     if (expand_single_region(node_index)) {
 201       // Given that expand_single_region() succeeded in expanding the heap, and we
 202       // always expand the heap by an amount aligned to the heap
 203       // region size, the free list should in theory not be empty.
 204       // In either case allocate_free_region() will check for NULL.
 205       res = _hrm-&gt;allocate_free_region(type, node_index);
 206     } else {
 207       _expand_heap_after_alloc_failure = false;
 208     }
 209   }
 210   return res;
 211 }
 212 
 213 HeapWord*
 214 G1CollectedHeap::humongous_obj_allocate_initialize_regions(HeapRegion* first_hr,
 215                                                            uint num_regions,
 216                                                            size_t word_size) {
 217   assert(first_hr != NULL, &quot;pre-condition&quot;);
 218   assert(is_humongous(word_size), &quot;word_size should be humongous&quot;);
 219   assert(num_regions * HeapRegion::GrainWords &gt;= word_size, &quot;pre-condition&quot;);
 220 
 221   // Index of last region in the series.
 222   uint first = first_hr-&gt;hrm_index();
 223   uint last = first + num_regions - 1;
 224 
 225   // We need to initialize the region(s) we just discovered. This is
 226   // a bit tricky given that it can happen concurrently with
 227   // refinement threads refining cards on these regions and
 228   // potentially wanting to refine the BOT as they are scanning
 229   // those cards (this can happen shortly after a cleanup; see CR
 230   // 6991377). So we have to set up the region(s) carefully and in
 231   // a specific order.
 232 
 233   // The word size sum of all the regions we will allocate.
 234   size_t word_size_sum = (size_t) num_regions * HeapRegion::GrainWords;
 235   assert(word_size &lt;= word_size_sum, &quot;sanity&quot;);
 236 
 237   // The passed in hr will be the &quot;starts humongous&quot; region. The header
 238   // of the new object will be placed at the bottom of this region.
 239   HeapWord* new_obj = first_hr-&gt;bottom();
 240   // This will be the new top of the new object.
 241   HeapWord* obj_top = new_obj + word_size;
 242 
 243   // First, we need to zero the header of the space that we will be
 244   // allocating. When we update top further down, some refinement
 245   // threads might try to scan the region. By zeroing the header we
 246   // ensure that any thread that will try to scan the region will
 247   // come across the zero klass word and bail out.
 248   //
 249   // NOTE: It would not have been correct to have used
 250   // CollectedHeap::fill_with_object() and make the space look like
 251   // an int array. The thread that is doing the allocation will
 252   // later update the object header to a potentially different array
 253   // type and, for a very short period of time, the klass and length
 254   // fields will be inconsistent. This could cause a refinement
 255   // thread to calculate the object size incorrectly.
 256   Copy::fill_to_words(new_obj, oopDesc::header_size(), 0);
 257 
 258   // Next, pad out the unused tail of the last region with filler
 259   // objects, for improved usage accounting.
 260   // How many words we use for filler objects.
 261   size_t word_fill_size = word_size_sum - word_size;
 262 
 263   // How many words memory we &quot;waste&quot; which cannot hold a filler object.
 264   size_t words_not_fillable = 0;
 265 
 266   if (word_fill_size &gt;= min_fill_size()) {
 267     fill_with_objects(obj_top, word_fill_size);
 268   } else if (word_fill_size &gt; 0) {
 269     // We have space to fill, but we cannot fit an object there.
 270     words_not_fillable = word_fill_size;
 271     word_fill_size = 0;
 272   }
 273 
 274   // We will set up the first region as &quot;starts humongous&quot;. This
 275   // will also update the BOT covering all the regions to reflect
 276   // that there is a single object that starts at the bottom of the
 277   // first region.
 278   first_hr-&gt;set_starts_humongous(obj_top, word_fill_size);
 279   _policy-&gt;remset_tracker()-&gt;update_at_allocate(first_hr);
 280   // Then, if there are any, we will set up the &quot;continues
 281   // humongous&quot; regions.
 282   HeapRegion* hr = NULL;
 283   for (uint i = first + 1; i &lt;= last; ++i) {
 284     hr = region_at(i);
 285     hr-&gt;set_continues_humongous(first_hr);
 286     _policy-&gt;remset_tracker()-&gt;update_at_allocate(hr);
 287   }
 288 
 289   // Up to this point no concurrent thread would have been able to
 290   // do any scanning on any region in this series. All the top
 291   // fields still point to bottom, so the intersection between
 292   // [bottom,top] and [card_start,card_end] will be empty. Before we
 293   // update the top fields, we&#39;ll do a storestore to make sure that
 294   // no thread sees the update to top before the zeroing of the
 295   // object header and the BOT initialization.
 296   OrderAccess::storestore();
 297 
 298   // Now, we will update the top fields of the &quot;continues humongous&quot;
 299   // regions except the last one.
 300   for (uint i = first; i &lt; last; ++i) {
 301     hr = region_at(i);
 302     hr-&gt;set_top(hr-&gt;end());
 303   }
 304 
 305   hr = region_at(last);
 306   // If we cannot fit a filler object, we must set top to the end
 307   // of the humongous object, otherwise we cannot iterate the heap
 308   // and the BOT will not be complete.
 309   hr-&gt;set_top(hr-&gt;end() - words_not_fillable);
 310 
 311   assert(hr-&gt;bottom() &lt; obj_top &amp;&amp; obj_top &lt;= hr-&gt;end(),
 312          &quot;obj_top should be in last region&quot;);
 313 
 314   _verifier-&gt;check_bitmaps(&quot;Humongous Region Allocation&quot;, first_hr);
 315 
 316   assert(words_not_fillable == 0 ||
 317          first_hr-&gt;bottom() + word_size_sum - words_not_fillable == hr-&gt;top(),
 318          &quot;Miscalculation in humongous allocation&quot;);
 319 
 320   increase_used((word_size_sum - words_not_fillable) * HeapWordSize);
 321 
 322   for (uint i = first; i &lt;= last; ++i) {
 323     hr = region_at(i);
 324     _humongous_set.add(hr);
 325     _hr_printer.alloc(hr);
 326   }
 327 
 328   return new_obj;
 329 }
 330 
 331 size_t G1CollectedHeap::humongous_obj_size_in_regions(size_t word_size) {
 332   assert(is_humongous(word_size), &quot;Object of size &quot; SIZE_FORMAT &quot; must be humongous here&quot;, word_size);
 333   return align_up(word_size, HeapRegion::GrainWords) / HeapRegion::GrainWords;
 334 }
 335 
 336 // If could fit into free regions w/o expansion, try.
 337 // Otherwise, if can expand, do so.
 338 // Otherwise, if using ex regions might help, try with ex given back.
 339 HeapWord* G1CollectedHeap::humongous_obj_allocate(size_t word_size) {
 340   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
 341 
 342   _verifier-&gt;verify_region_sets_optional();
 343 
 344   uint obj_regions = (uint) humongous_obj_size_in_regions(word_size);
 345 
 346   // Policy: First try to allocate a humongous object in the free list.
 347   HeapRegion* humongous_start = _hrm-&gt;allocate_humongous(obj_regions);
 348   if (humongous_start == NULL) {
 349     // Policy: We could not find enough regions for the humongous object in the
 350     // free list. Look through the heap to find a mix of free and uncommitted regions.
 351     // If so, expand the heap and allocate the humongous object.
 352     humongous_start = _hrm-&gt;expand_and_allocate_humongous(obj_regions);
 353     if (humongous_start != NULL) {
 354       // We managed to find a region by expanding the heap.
 355       log_debug(gc, ergo, heap)(&quot;Heap expansion (humongous allocation request). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 356                                 word_size * HeapWordSize);
 357       policy()-&gt;record_new_heap_size(num_regions());
 358     } else {
 359       // Policy: Potentially trigger a defragmentation GC.
 360     }
 361   }
 362 
 363   HeapWord* result = NULL;
 364   if (humongous_start != NULL) {
 365     result = humongous_obj_allocate_initialize_regions(humongous_start, obj_regions, word_size);
 366     assert(result != NULL, &quot;it should always return a valid result&quot;);
 367 
 368     // A successful humongous object allocation changes the used space
 369     // information of the old generation so we need to recalculate the
 370     // sizes and update the jstat counters here.
 371     g1mm()-&gt;update_sizes();
 372   }
 373 
 374   _verifier-&gt;verify_region_sets_optional();
 375 
 376   return result;
 377 }
 378 
 379 HeapWord* G1CollectedHeap::allocate_new_tlab(size_t min_size,
 380                                              size_t requested_size,
 381                                              size_t* actual_size) {
 382   assert_heap_not_locked_and_not_at_safepoint();
 383   assert(!is_humongous(requested_size), &quot;we do not allow humongous TLABs&quot;);
 384 
 385   return attempt_allocation(min_size, requested_size, actual_size);
 386 }
 387 
 388 HeapWord*
 389 G1CollectedHeap::mem_allocate(size_t word_size,
 390                               bool*  gc_overhead_limit_was_exceeded) {
 391   assert_heap_not_locked_and_not_at_safepoint();
 392 
 393   if (is_humongous(word_size)) {
 394     return attempt_allocation_humongous(word_size);
 395   }
 396   size_t dummy = 0;
 397   return attempt_allocation(word_size, word_size, &amp;dummy);
 398 }
 399 
 400 HeapWord* G1CollectedHeap::attempt_allocation_slow(size_t word_size) {
 401   ResourceMark rm; // For retrieving the thread names in log messages.
 402 
 403   // Make sure you read the note in attempt_allocation_humongous().
 404 
 405   assert_heap_not_locked_and_not_at_safepoint();
 406   assert(!is_humongous(word_size), &quot;attempt_allocation_slow() should not &quot;
 407          &quot;be called for humongous allocation requests&quot;);
 408 
 409   // We should only get here after the first-level allocation attempt
 410   // (attempt_allocation()) failed to allocate.
 411 
 412   // We will loop until a) we manage to successfully perform the
 413   // allocation or b) we successfully schedule a collection which
 414   // fails to perform the allocation. b) is the only case when we&#39;ll
 415   // return NULL.
 416   HeapWord* result = NULL;
 417   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 418     bool should_try_gc;
 419     uint gc_count_before;
 420 
 421     {
 422       MutexLocker x(Heap_lock);
 423       result = _allocator-&gt;attempt_allocation_locked(word_size);
 424       if (result != NULL) {
 425         return result;
 426       }
 427 
 428       // If the GCLocker is active and we are bound for a GC, try expanding young gen.
 429       // This is different to when only GCLocker::needs_gc() is set: try to avoid
 430       // waiting because the GCLocker is active to not wait too long.
 431       if (GCLocker::is_active_and_needs_gc() &amp;&amp; policy()-&gt;can_expand_young_list()) {
 432         // No need for an ergo message here, can_expand_young_list() does this when
 433         // it returns true.
 434         result = _allocator-&gt;attempt_allocation_force(word_size);
 435         if (result != NULL) {
 436           return result;
 437         }
 438       }
 439       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 440       // the GCLocker initiated GC has been performed and then retry. This includes
 441       // the case when the GC Locker is not active but has not been performed.
 442       should_try_gc = !GCLocker::needs_gc();
 443       // Read the GC count while still holding the Heap_lock.
 444       gc_count_before = total_collections();
 445     }
 446 
 447     if (should_try_gc) {
 448       bool succeeded;
 449       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 450                                    GCCause::_g1_inc_collection_pause);
 451       if (result != NULL) {
 452         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 453         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 454                              Thread::current()-&gt;name(), p2i(result));
 455         return result;
 456       }
 457 
 458       if (succeeded) {
 459         // We successfully scheduled a collection which failed to allocate. No
 460         // point in trying to allocate further. We&#39;ll just return NULL.
 461         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 462                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 463         return NULL;
 464       }
 465       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot; words&quot;,
 466                            Thread::current()-&gt;name(), word_size);
 467     } else {
 468       // Failed to schedule a collection.
 469       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 470         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 471                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 472         return NULL;
 473       }
 474       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 475       // The GCLocker is either active or the GCLocker initiated
 476       // GC has not yet been performed. Stall until it is and
 477       // then retry the allocation.
 478       GCLocker::stall_until_clear();
 479       gclocker_retry_count += 1;
 480     }
 481 
 482     // We can reach here if we were unsuccessful in scheduling a
 483     // collection (because another thread beat us to it) or if we were
 484     // stalled due to the GC locker. In either can we should retry the
 485     // allocation attempt in case another thread successfully
 486     // performed a collection and reclaimed enough space. We do the
 487     // first attempt (without holding the Heap_lock) here and the
 488     // follow-on attempt will be at the start of the next loop
 489     // iteration (after taking the Heap_lock).
 490     size_t dummy = 0;
 491     result = _allocator-&gt;attempt_allocation(word_size, word_size, &amp;dummy);
 492     if (result != NULL) {
 493       return result;
 494     }
 495 
 496     // Give a warning if we seem to be looping forever.
 497     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 498         (try_count % QueuedAllocationWarningCount == 0)) {
 499       log_warning(gc, alloc)(&quot;%s:  Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 500                              Thread::current()-&gt;name(), try_count, word_size);
 501     }
 502   }
 503 
 504   ShouldNotReachHere();
 505   return NULL;
 506 }
 507 
 508 void G1CollectedHeap::begin_archive_alloc_range(bool open) {
 509   assert_at_safepoint_on_vm_thread();
 510   if (_archive_allocator == NULL) {
 511     _archive_allocator = G1ArchiveAllocator::create_allocator(this, open);
 512   }
 513 }
 514 
 515 bool G1CollectedHeap::is_archive_alloc_too_large(size_t word_size) {
 516   // Allocations in archive regions cannot be of a size that would be considered
 517   // humongous even for a minimum-sized region, because G1 region sizes/boundaries
 518   // may be different at archive-restore time.
 519   return word_size &gt;= humongous_threshold_for(HeapRegion::min_region_size_in_words());
 520 }
 521 
 522 HeapWord* G1CollectedHeap::archive_mem_allocate(size_t word_size) {
 523   assert_at_safepoint_on_vm_thread();
 524   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 525   if (is_archive_alloc_too_large(word_size)) {
 526     return NULL;
 527   }
 528   return _archive_allocator-&gt;archive_mem_allocate(word_size);
 529 }
 530 
 531 void G1CollectedHeap::end_archive_alloc_range(GrowableArray&lt;MemRegion&gt;* ranges,
 532                                               size_t end_alignment_in_bytes) {
 533   assert_at_safepoint_on_vm_thread();
 534   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 535 
 536   // Call complete_archive to do the real work, filling in the MemRegion
 537   // array with the archive regions.
 538   _archive_allocator-&gt;complete_archive(ranges, end_alignment_in_bytes);
 539   delete _archive_allocator;
 540   _archive_allocator = NULL;
 541 }
 542 
 543 bool G1CollectedHeap::check_archive_addresses(MemRegion* ranges, size_t count) {
 544   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 545   assert(count != 0, &quot;No MemRegions provided&quot;);
 546   MemRegion reserved = _hrm-&gt;reserved();
 547   for (size_t i = 0; i &lt; count; i++) {
 548     if (!reserved.contains(ranges[i].start()) || !reserved.contains(ranges[i].last())) {
 549       return false;
 550     }
 551   }
 552   return true;
 553 }
 554 
 555 bool G1CollectedHeap::alloc_archive_regions(MemRegion* ranges,
 556                                             size_t count,
 557                                             bool open) {
 558   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 559   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 560   assert(count != 0, &quot;No MemRegions provided&quot;);
 561   MutexLocker x(Heap_lock);
 562 
 563   MemRegion reserved = _hrm-&gt;reserved();
 564   HeapWord* prev_last_addr = NULL;
 565   HeapRegion* prev_last_region = NULL;
 566 
 567   // Temporarily disable pretouching of heap pages. This interface is used
 568   // when mmap&#39;ing archived heap data in, so pre-touching is wasted.
 569   FlagSetting fs(AlwaysPreTouch, false);
 570 
 571   // Enable archive object checking used by G1MarkSweep. We have to let it know
 572   // about each archive range, so that objects in those ranges aren&#39;t marked.
 573   G1ArchiveAllocator::enable_archive_object_check();
 574 
 575   // For each specified MemRegion range, allocate the corresponding G1
 576   // regions and mark them as archive regions. We expect the ranges
 577   // in ascending starting address order, without overlap.
 578   for (size_t i = 0; i &lt; count; i++) {
 579     MemRegion curr_range = ranges[i];
 580     HeapWord* start_address = curr_range.start();
 581     size_t word_size = curr_range.word_size();
 582     HeapWord* last_address = curr_range.last();
 583     size_t commits = 0;
 584 
 585     guarantee(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 586               &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 587               p2i(start_address), p2i(last_address));
 588     guarantee(start_address &gt; prev_last_addr,
 589               &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 590               p2i(start_address), p2i(prev_last_addr));
 591     prev_last_addr = last_address;
 592 
 593     // Check for ranges that start in the same G1 region in which the previous
 594     // range ended, and adjust the start address so we don&#39;t try to allocate
 595     // the same region again. If the current range is entirely within that
 596     // region, skip it, just adjusting the recorded top.
 597     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 598     if ((prev_last_region != NULL) &amp;&amp; (start_region == prev_last_region)) {
 599       start_address = start_region-&gt;end();
 600       if (start_address &gt; last_address) {
 601         increase_used(word_size * HeapWordSize);
 602         start_region-&gt;set_top(last_address + 1);
 603         continue;
 604       }
 605       start_region-&gt;set_top(start_address);
 606       curr_range = MemRegion(start_address, last_address + 1);
 607       start_region = _hrm-&gt;addr_to_region(start_address);
 608     }
 609 
 610     // Perform the actual region allocation, exiting if it fails.
 611     // Then note how much new space we have allocated.
 612     if (!_hrm-&gt;allocate_containing_regions(curr_range, &amp;commits, workers())) {
 613       return false;
 614     }
 615     increase_used(word_size * HeapWordSize);
 616     if (commits != 0) {
 617       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocate archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 618                                 HeapRegion::GrainWords * HeapWordSize * commits);
 619 
 620     }
 621 
 622     // Mark each G1 region touched by the range as archive, add it to
 623     // the old set, and set top.
 624     HeapRegion* curr_region = _hrm-&gt;addr_to_region(start_address);
 625     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 626     prev_last_region = last_region;
 627 
 628     while (curr_region != NULL) {
 629       assert(curr_region-&gt;is_empty() &amp;&amp; !curr_region-&gt;is_pinned(),
 630              &quot;Region already in use (index %u)&quot;, curr_region-&gt;hrm_index());
 631       if (open) {
 632         curr_region-&gt;set_open_archive();
 633       } else {
 634         curr_region-&gt;set_closed_archive();
 635       }
 636       _hr_printer.alloc(curr_region);
 637       _archive_set.add(curr_region);
 638       HeapWord* top;
 639       HeapRegion* next_region;
 640       if (curr_region != last_region) {
 641         top = curr_region-&gt;end();
 642         next_region = _hrm-&gt;next_region_in_heap(curr_region);
 643       } else {
 644         top = last_address + 1;
 645         next_region = NULL;
 646       }
 647       curr_region-&gt;set_top(top);
 648       curr_region = next_region;
 649     }
 650 
 651     // Notify mark-sweep of the archive
 652     G1ArchiveAllocator::set_range_archive(curr_range, open);
 653   }
 654   return true;
 655 }
 656 
 657 void G1CollectedHeap::fill_archive_regions(MemRegion* ranges, size_t count) {
 658   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 659   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 660   assert(count != 0, &quot;No MemRegions provided&quot;);
 661   MemRegion reserved = _hrm-&gt;reserved();
 662   HeapWord *prev_last_addr = NULL;
 663   HeapRegion* prev_last_region = NULL;
 664 
 665   // For each MemRegion, create filler objects, if needed, in the G1 regions
 666   // that contain the address range. The address range actually within the
 667   // MemRegion will not be modified. That is assumed to have been initialized
 668   // elsewhere, probably via an mmap of archived heap data.
 669   MutexLocker x(Heap_lock);
 670   for (size_t i = 0; i &lt; count; i++) {
 671     HeapWord* start_address = ranges[i].start();
 672     HeapWord* last_address = ranges[i].last();
 673 
 674     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 675            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 676            p2i(start_address), p2i(last_address));
 677     assert(start_address &gt; prev_last_addr,
 678            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 679            p2i(start_address), p2i(prev_last_addr));
 680 
 681     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 682     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 683     HeapWord* bottom_address = start_region-&gt;bottom();
 684 
 685     // Check for a range beginning in the same region in which the
 686     // previous one ended.
 687     if (start_region == prev_last_region) {
 688       bottom_address = prev_last_addr + 1;
 689     }
 690 
 691     // Verify that the regions were all marked as archive regions by
 692     // alloc_archive_regions.
 693     HeapRegion* curr_region = start_region;
 694     while (curr_region != NULL) {
 695       guarantee(curr_region-&gt;is_archive(),
 696                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 697       if (curr_region != last_region) {
 698         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 699       } else {
 700         curr_region = NULL;
 701       }
 702     }
 703 
 704     prev_last_addr = last_address;
 705     prev_last_region = last_region;
 706 
 707     // Fill the memory below the allocated range with dummy object(s),
 708     // if the region bottom does not match the range start, or if the previous
 709     // range ended within the same G1 region, and there is a gap.
 710     if (start_address != bottom_address) {
 711       size_t fill_size = pointer_delta(start_address, bottom_address);
 712       G1CollectedHeap::fill_with_objects(bottom_address, fill_size);
 713       increase_used(fill_size * HeapWordSize);
 714     }
 715   }
 716 }
 717 
 718 inline HeapWord* G1CollectedHeap::attempt_allocation(size_t min_word_size,
 719                                                      size_t desired_word_size,
 720                                                      size_t* actual_word_size) {
 721   assert_heap_not_locked_and_not_at_safepoint();
 722   assert(!is_humongous(desired_word_size), &quot;attempt_allocation() should not &quot;
 723          &quot;be called for humongous allocation requests&quot;);
 724 
 725   HeapWord* result = _allocator-&gt;attempt_allocation(min_word_size, desired_word_size, actual_word_size);
 726 
 727   if (result == NULL) {
 728     *actual_word_size = desired_word_size;
 729     result = attempt_allocation_slow(desired_word_size);
 730   }
 731 
 732   assert_heap_not_locked();
 733   if (result != NULL) {
 734     assert(*actual_word_size != 0, &quot;Actual size must have been set here&quot;);
 735     dirty_young_block(result, *actual_word_size);
 736   } else {
 737     *actual_word_size = 0;
 738   }
 739 
 740   return result;
 741 }
 742 
 743 void G1CollectedHeap::dealloc_archive_regions(MemRegion* ranges, size_t count) {
 744   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 745   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 746   assert(count != 0, &quot;No MemRegions provided&quot;);
 747   MemRegion reserved = _hrm-&gt;reserved();
 748   HeapWord* prev_last_addr = NULL;
 749   HeapRegion* prev_last_region = NULL;
 750   size_t size_used = 0;
 751   size_t uncommitted_regions = 0;
 752 
 753   // For each Memregion, free the G1 regions that constitute it, and
 754   // notify mark-sweep that the range is no longer to be considered &#39;archive.&#39;
 755   MutexLocker x(Heap_lock);
 756   for (size_t i = 0; i &lt; count; i++) {
 757     HeapWord* start_address = ranges[i].start();
 758     HeapWord* last_address = ranges[i].last();
 759 
 760     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 761            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 762            p2i(start_address), p2i(last_address));
 763     assert(start_address &gt; prev_last_addr,
 764            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 765            p2i(start_address), p2i(prev_last_addr));
 766     size_used += ranges[i].byte_size();
 767     prev_last_addr = last_address;
 768 
 769     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 770     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 771 
 772     // Check for ranges that start in the same G1 region in which the previous
 773     // range ended, and adjust the start address so we don&#39;t try to free
 774     // the same region again. If the current range is entirely within that
 775     // region, skip it.
 776     if (start_region == prev_last_region) {
 777       start_address = start_region-&gt;end();
 778       if (start_address &gt; last_address) {
 779         continue;
 780       }
 781       start_region = _hrm-&gt;addr_to_region(start_address);
 782     }
 783     prev_last_region = last_region;
 784 
 785     // After verifying that each region was marked as an archive region by
 786     // alloc_archive_regions, set it free and empty and uncommit it.
 787     HeapRegion* curr_region = start_region;
 788     while (curr_region != NULL) {
 789       guarantee(curr_region-&gt;is_archive(),
 790                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 791       uint curr_index = curr_region-&gt;hrm_index();
 792       _archive_set.remove(curr_region);
 793       curr_region-&gt;set_free();
 794       curr_region-&gt;set_top(curr_region-&gt;bottom());
 795       if (curr_region != last_region) {
 796         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 797       } else {
 798         curr_region = NULL;
 799       }
 800       _hrm-&gt;shrink_at(curr_index, 1);
 801       uncommitted_regions++;
 802     }
 803 
 804     // Notify mark-sweep that this is no longer an archive range.
 805     G1ArchiveAllocator::clear_range_archive(ranges[i]);
 806   }
 807 
 808   if (uncommitted_regions != 0) {
 809     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (uncommitted archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 810                               HeapRegion::GrainWords * HeapWordSize * uncommitted_regions);
 811   }
 812   decrease_used(size_used);
 813 }
 814 
 815 oop G1CollectedHeap::materialize_archived_object(oop obj) {
 816   assert(obj != NULL, &quot;archived obj is NULL&quot;);
 817   assert(G1ArchiveAllocator::is_archived_object(obj), &quot;must be archived object&quot;);
 818 
 819   // Loading an archived object makes it strongly reachable. If it is
 820   // loaded during concurrent marking, it must be enqueued to the SATB
 821   // queue, shading the previously white object gray.
 822   G1BarrierSet::enqueue(obj);
 823 
 824   return obj;
 825 }
 826 
 827 HeapWord* G1CollectedHeap::attempt_allocation_humongous(size_t word_size) {
 828   ResourceMark rm; // For retrieving the thread names in log messages.
 829 
 830   // The structure of this method has a lot of similarities to
 831   // attempt_allocation_slow(). The reason these two were not merged
 832   // into a single one is that such a method would require several &quot;if
 833   // allocation is not humongous do this, otherwise do that&quot;
 834   // conditional paths which would obscure its flow. In fact, an early
 835   // version of this code did use a unified method which was harder to
 836   // follow and, as a result, it had subtle bugs that were hard to
 837   // track down. So keeping these two methods separate allows each to
 838   // be more readable. It will be good to keep these two in sync as
 839   // much as possible.
 840 
 841   assert_heap_not_locked_and_not_at_safepoint();
 842   assert(is_humongous(word_size), &quot;attempt_allocation_humongous() &quot;
 843          &quot;should only be called for humongous allocations&quot;);
 844 
 845   // Humongous objects can exhaust the heap quickly, so we should check if we
 846   // need to start a marking cycle at each humongous object allocation. We do
 847   // the check before we do the actual allocation. The reason for doing it
 848   // before the allocation is that we avoid having to keep track of the newly
 849   // allocated memory while we do a GC.
 850   if (policy()-&gt;need_to_start_conc_mark(&quot;concurrent humongous allocation&quot;,
 851                                            word_size)) {
 852     collect(GCCause::_g1_humongous_allocation);
 853   }
 854 
 855   // We will loop until a) we manage to successfully perform the
 856   // allocation or b) we successfully schedule a collection which
 857   // fails to perform the allocation. b) is the only case when we&#39;ll
 858   // return NULL.
 859   HeapWord* result = NULL;
 860   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 861     bool should_try_gc;
 862     uint gc_count_before;
 863 
 864 
 865     {
 866       MutexLocker x(Heap_lock);
 867 
 868       // Given that humongous objects are not allocated in young
 869       // regions, we&#39;ll first try to do the allocation without doing a
 870       // collection hoping that there&#39;s enough space in the heap.
 871       result = humongous_obj_allocate(word_size);
 872       if (result != NULL) {
 873         size_t size_in_regions = humongous_obj_size_in_regions(word_size);
 874         policy()-&gt;old_gen_alloc_tracker()-&gt;
 875           add_allocated_bytes_since_last_gc(size_in_regions * HeapRegion::GrainBytes);
 876         return result;
 877       }
 878 
 879       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 880       // the GCLocker initiated GC has been performed and then retry. This includes
 881       // the case when the GC Locker is not active but has not been performed.
 882       should_try_gc = !GCLocker::needs_gc();
 883       // Read the GC count while still holding the Heap_lock.
 884       gc_count_before = total_collections();
 885     }
 886 
 887     if (should_try_gc) {
 888       bool succeeded;
 889       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 890                                    GCCause::_g1_humongous_allocation);
 891       if (result != NULL) {
 892         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 893         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 894                              Thread::current()-&gt;name(), p2i(result));
 895         return result;
 896       }
 897 
 898       if (succeeded) {
 899         // We successfully scheduled a collection which failed to allocate. No
 900         // point in trying to allocate further. We&#39;ll just return NULL.
 901         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 902                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 903         return NULL;
 904       }
 905       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot;&quot;,
 906                            Thread::current()-&gt;name(), word_size);
 907     } else {
 908       // Failed to schedule a collection.
 909       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 910         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 911                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 912         return NULL;
 913       }
 914       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 915       // The GCLocker is either active or the GCLocker initiated
 916       // GC has not yet been performed. Stall until it is and
 917       // then retry the allocation.
 918       GCLocker::stall_until_clear();
 919       gclocker_retry_count += 1;
 920     }
 921 
 922 
 923     // We can reach here if we were unsuccessful in scheduling a
 924     // collection (because another thread beat us to it) or if we were
 925     // stalled due to the GC locker. In either can we should retry the
 926     // allocation attempt in case another thread successfully
 927     // performed a collection and reclaimed enough space.
 928     // Humongous object allocation always needs a lock, so we wait for the retry
 929     // in the next iteration of the loop, unlike for the regular iteration case.
 930     // Give a warning if we seem to be looping forever.
 931 
 932     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 933         (try_count % QueuedAllocationWarningCount == 0)) {
 934       log_warning(gc, alloc)(&quot;%s: Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 935                              Thread::current()-&gt;name(), try_count, word_size);
 936     }
 937   }
 938 
 939   ShouldNotReachHere();
 940   return NULL;
 941 }
 942 
 943 HeapWord* G1CollectedHeap::attempt_allocation_at_safepoint(size_t word_size,
 944                                                            bool expect_null_mutator_alloc_region) {
 945   assert_at_safepoint_on_vm_thread();
 946   assert(!_allocator-&gt;has_mutator_alloc_region() || !expect_null_mutator_alloc_region,
 947          &quot;the current alloc region was unexpectedly found to be non-NULL&quot;);
 948 
 949   if (!is_humongous(word_size)) {
 950     return _allocator-&gt;attempt_allocation_locked(word_size);
 951   } else {
 952     HeapWord* result = humongous_obj_allocate(word_size);
 953     if (result != NULL &amp;&amp; policy()-&gt;need_to_start_conc_mark(&quot;STW humongous allocation&quot;)) {
 954       collector_state()-&gt;set_initiate_conc_mark_if_possible(true);
 955     }
 956     return result;
 957   }
 958 
 959   ShouldNotReachHere();
 960 }
 961 
 962 class PostCompactionPrinterClosure: public HeapRegionClosure {
 963 private:
 964   G1HRPrinter* _hr_printer;
 965 public:
 966   bool do_heap_region(HeapRegion* hr) {
 967     assert(!hr-&gt;is_young(), &quot;not expecting to find young regions&quot;);
 968     _hr_printer-&gt;post_compaction(hr);
 969     return false;
 970   }
 971 
 972   PostCompactionPrinterClosure(G1HRPrinter* hr_printer)
 973     : _hr_printer(hr_printer) { }
 974 };
 975 
 976 void G1CollectedHeap::print_hrm_post_compaction() {
 977   if (_hr_printer.is_active()) {
 978     PostCompactionPrinterClosure cl(hr_printer());
 979     heap_region_iterate(&amp;cl);
 980   }
 981 }
 982 
 983 void G1CollectedHeap::abort_concurrent_cycle() {
 984   // If we start the compaction before the CM threads finish
 985   // scanning the root regions we might trip them over as we&#39;ll
 986   // be moving objects / updating references. So let&#39;s wait until
 987   // they are done. By telling them to abort, they should complete
 988   // early.
 989   _cm-&gt;root_regions()-&gt;abort();
 990   _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
 991 
 992   // Disable discovery and empty the discovered lists
 993   // for the CM ref processor.
 994   _ref_processor_cm-&gt;disable_discovery();
 995   _ref_processor_cm-&gt;abandon_partial_discovery();
 996   _ref_processor_cm-&gt;verify_no_references_recorded();
 997 
 998   // Abandon current iterations of concurrent marking and concurrent
 999   // refinement, if any are in progress.
1000   concurrent_mark()-&gt;concurrent_cycle_abort();
1001 }
1002 
1003 void G1CollectedHeap::prepare_heap_for_full_collection() {
1004   // Make sure we&#39;ll choose a new allocation region afterwards.
1005   _allocator-&gt;release_mutator_alloc_regions();
1006   _allocator-&gt;abandon_gc_alloc_regions();
1007 
1008   // We may have added regions to the current incremental collection
1009   // set between the last GC or pause and now. We need to clear the
1010   // incremental collection set and then start rebuilding it afresh
1011   // after this full GC.
1012   abandon_collection_set(collection_set());
1013 
1014   tear_down_region_sets(false /* free_list_only */);
1015 
1016   hrm()-&gt;prepare_for_full_collection_start();
1017 }
1018 
1019 void G1CollectedHeap::verify_before_full_collection(bool explicit_gc) {
1020   assert(!GCCause::is_user_requested_gc(gc_cause()) || explicit_gc, &quot;invariant&quot;);
1021   assert_used_and_recalculate_used_equal(this);
1022   _verifier-&gt;verify_region_sets_optional();
1023   _verifier-&gt;verify_before_gc(G1HeapVerifier::G1VerifyFull);
1024   _verifier-&gt;check_bitmaps(&quot;Full GC Start&quot;);
1025 }
1026 
1027 void G1CollectedHeap::prepare_heap_for_mutators() {
1028   hrm()-&gt;prepare_for_full_collection_end();
1029 
1030   // Delete metaspaces for unloaded class loaders and clean up loader_data graph
1031   ClassLoaderDataGraph::purge();
1032   MetaspaceUtils::verify_metrics();
1033 
1034   // Prepare heap for normal collections.
1035   assert(num_free_regions() == 0, &quot;we should not have added any free regions&quot;);
1036   rebuild_region_sets(false /* free_list_only */);
1037   abort_refinement();
1038   resize_heap_if_necessary();
1039 
1040   // Rebuild the strong code root lists for each region
1041   rebuild_strong_code_roots();
1042 
1043   // Purge code root memory
1044   purge_code_root_memory();
1045 
1046   // Start a new incremental collection set for the next pause
1047   start_new_collection_set();
1048 
1049   _allocator-&gt;init_mutator_alloc_regions();
1050 
1051   // Post collection state updates.
1052   MetaspaceGC::compute_new_size();
1053 }
1054 
1055 void G1CollectedHeap::abort_refinement() {
1056   if (_hot_card_cache-&gt;use_cache()) {
1057     _hot_card_cache-&gt;reset_hot_cache();
1058   }
1059 
1060   // Discard all remembered set updates and reset refinement statistics.
1061   G1BarrierSet::dirty_card_queue_set().abandon_logs();
1062   assert(G1BarrierSet::dirty_card_queue_set().num_cards() == 0,
1063          &quot;DCQS should be empty&quot;);
1064   concurrent_refine()-&gt;get_and_reset_refinement_stats();
1065 }
1066 
1067 void G1CollectedHeap::verify_after_full_collection() {
1068   _hrm-&gt;verify_optional();
1069   _verifier-&gt;verify_region_sets_optional();
1070   _verifier-&gt;verify_after_gc(G1HeapVerifier::G1VerifyFull);
1071   // Clear the previous marking bitmap, if needed for bitmap verification.
1072   // Note we cannot do this when we clear the next marking bitmap in
1073   // G1ConcurrentMark::abort() above since VerifyDuringGC verifies the
1074   // objects marked during a full GC against the previous bitmap.
1075   // But we need to clear it before calling check_bitmaps below since
1076   // the full GC has compacted objects and updated TAMS but not updated
1077   // the prev bitmap.
1078   if (G1VerifyBitmaps) {
1079     GCTraceTime(Debug, gc) tm(&quot;Clear Prev Bitmap for Verification&quot;);
1080     _cm-&gt;clear_prev_bitmap(workers());
1081   }
1082   // This call implicitly verifies that the next bitmap is clear after Full GC.
1083   _verifier-&gt;check_bitmaps(&quot;Full GC End&quot;);
1084 
1085   // At this point there should be no regions in the
1086   // entire heap tagged as young.
1087   assert(check_young_list_empty(), &quot;young list should be empty at this point&quot;);
1088 
1089   // Note: since we&#39;ve just done a full GC, concurrent
1090   // marking is no longer active. Therefore we need not
1091   // re-enable reference discovery for the CM ref processor.
1092   // That will be done at the start of the next marking cycle.
1093   // We also know that the STW processor should no longer
1094   // discover any new references.
1095   assert(!_ref_processor_stw-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1096   assert(!_ref_processor_cm-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1097   _ref_processor_stw-&gt;verify_no_references_recorded();
1098   _ref_processor_cm-&gt;verify_no_references_recorded();
1099 }
1100 
1101 void G1CollectedHeap::print_heap_after_full_collection(G1HeapTransition* heap_transition) {
1102   // Post collection logging.
1103   // We should do this after we potentially resize the heap so
1104   // that all the COMMIT / UNCOMMIT events are generated before
1105   // the compaction events.
1106   print_hrm_post_compaction();
1107   heap_transition-&gt;print();
1108   print_heap_after_gc();
1109   print_heap_regions();
1110 }
1111 
1112 bool G1CollectedHeap::do_full_collection(bool explicit_gc,
1113                                          bool clear_all_soft_refs) {
1114   assert_at_safepoint_on_vm_thread();
1115 
1116   if (GCLocker::check_active_before_gc()) {
1117     // Full GC was not completed.
1118     return false;
1119   }
1120 
1121   const bool do_clear_all_soft_refs = clear_all_soft_refs ||
1122       soft_ref_policy()-&gt;should_clear_all_soft_refs();
1123 
1124   G1FullCollector collector(this, explicit_gc, do_clear_all_soft_refs);
1125   GCTraceTime(Info, gc) tm(&quot;Pause Full&quot;, NULL, gc_cause(), true);
1126 
1127   collector.prepare_collection();
1128   collector.collect();
1129   collector.complete_collection();
1130 
1131   // Full collection was successfully completed.
1132   return true;
1133 }
1134 
1135 void G1CollectedHeap::do_full_collection(bool clear_all_soft_refs) {
1136   // Currently, there is no facility in the do_full_collection(bool) API to notify
1137   // the caller that the collection did not succeed (e.g., because it was locked
1138   // out by the GC locker). So, right now, we&#39;ll ignore the return value.
1139   bool dummy = do_full_collection(true,                /* explicit_gc */
1140                                   clear_all_soft_refs);
1141 }
1142 
1143 void G1CollectedHeap::resize_heap_if_necessary() {
1144   assert_at_safepoint_on_vm_thread();
1145 
1146   bool should_expand;
1147   size_t resize_amount = _heap_sizing_policy-&gt;full_collection_resize_amount(should_expand);
1148 
1149   if (resize_amount == 0) {
1150     return;
1151   } else if (should_expand) {
1152     expand(resize_amount, _workers);
1153   } else {
1154     shrink(resize_amount);
1155   }
1156 }
1157 
1158 HeapWord* G1CollectedHeap::satisfy_failed_allocation_helper(size_t word_size,
1159                                                             bool do_gc,
1160                                                             bool clear_all_soft_refs,
1161                                                             bool expect_null_mutator_alloc_region,
1162                                                             bool* gc_succeeded) {
1163   *gc_succeeded = true;
1164   // Let&#39;s attempt the allocation first.
1165   HeapWord* result =
1166     attempt_allocation_at_safepoint(word_size,
1167                                     expect_null_mutator_alloc_region);
1168   if (result != NULL) {
1169     return result;
1170   }
1171 
1172   // In a G1 heap, we&#39;re supposed to keep allocation from failing by
1173   // incremental pauses.  Therefore, at least for now, we&#39;ll favor
1174   // expansion over collection.  (This might change in the future if we can
1175   // do something smarter than full collection to satisfy a failed alloc.)
1176   result = expand_and_allocate(word_size);
1177   if (result != NULL) {
1178     return result;
1179   }
1180 
1181   if (do_gc) {
1182     // Expansion didn&#39;t work, we&#39;ll try to do a Full GC.
1183     *gc_succeeded = do_full_collection(false, /* explicit_gc */
1184                                        clear_all_soft_refs);
1185   }
1186 
1187   return NULL;
1188 }
1189 
1190 HeapWord* G1CollectedHeap::satisfy_failed_allocation(size_t word_size,
1191                                                      bool* succeeded) {
1192   assert_at_safepoint_on_vm_thread();
1193 
1194   // Attempts to allocate followed by Full GC.
1195   HeapWord* result =
1196     satisfy_failed_allocation_helper(word_size,
1197                                      true,  /* do_gc */
1198                                      false, /* clear_all_soft_refs */
1199                                      false, /* expect_null_mutator_alloc_region */
1200                                      succeeded);
1201 
1202   if (result != NULL || !*succeeded) {
1203     return result;
1204   }
1205 
1206   // Attempts to allocate followed by Full GC that will collect all soft references.
1207   result = satisfy_failed_allocation_helper(word_size,
1208                                             true, /* do_gc */
1209                                             true, /* clear_all_soft_refs */
1210                                             true, /* expect_null_mutator_alloc_region */
1211                                             succeeded);
1212 
1213   if (result != NULL || !*succeeded) {
1214     return result;
1215   }
1216 
1217   // Attempts to allocate, no GC
1218   result = satisfy_failed_allocation_helper(word_size,
1219                                             false, /* do_gc */
1220                                             false, /* clear_all_soft_refs */
1221                                             true,  /* expect_null_mutator_alloc_region */
1222                                             succeeded);
1223 
1224   if (result != NULL) {
1225     return result;
1226   }
1227 
1228   assert(!soft_ref_policy()-&gt;should_clear_all_soft_refs(),
1229          &quot;Flag should have been handled and cleared prior to this point&quot;);
1230 
1231   // What else?  We might try synchronous finalization later.  If the total
1232   // space available is large enough for the allocation, then a more
1233   // complete compaction phase than we&#39;ve tried so far might be
1234   // appropriate.
1235   return NULL;
1236 }
1237 
1238 // Attempting to expand the heap sufficiently
1239 // to support an allocation of the given &quot;word_size&quot;.  If
1240 // successful, perform the allocation and return the address of the
1241 // allocated block, or else &quot;NULL&quot;.
1242 
1243 HeapWord* G1CollectedHeap::expand_and_allocate(size_t word_size) {
1244   assert_at_safepoint_on_vm_thread();
1245 
1246   _verifier-&gt;verify_region_sets_optional();
1247 
1248   size_t expand_bytes = MAX2(word_size * HeapWordSize, MinHeapDeltaBytes);
1249   log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
1250                             word_size * HeapWordSize);
1251 
1252 
1253   if (expand(expand_bytes, _workers)) {
1254     _hrm-&gt;verify_optional();
1255     _verifier-&gt;verify_region_sets_optional();
1256     return attempt_allocation_at_safepoint(word_size,
1257                                            false /* expect_null_mutator_alloc_region */);
1258   }
1259   return NULL;
1260 }
1261 
1262 bool G1CollectedHeap::expand(size_t expand_bytes, WorkGang* pretouch_workers, double* expand_time_ms) {
1263   size_t aligned_expand_bytes = ReservedSpace::page_align_size_up(expand_bytes);
1264   aligned_expand_bytes = align_up(aligned_expand_bytes,
1265                                        HeapRegion::GrainBytes);
1266 
1267   log_debug(gc, ergo, heap)(&quot;Expand the heap. requested expansion amount: &quot; SIZE_FORMAT &quot;B expansion amount: &quot; SIZE_FORMAT &quot;B&quot;,
1268                             expand_bytes, aligned_expand_bytes);
1269 
1270   if (is_maximal_no_gc()) {
1271     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1272     return false;
1273   }
1274 
1275   double expand_heap_start_time_sec = os::elapsedTime();
1276   uint regions_to_expand = (uint)(aligned_expand_bytes / HeapRegion::GrainBytes);
1277   assert(regions_to_expand &gt; 0, &quot;Must expand by at least one region&quot;);
1278 
1279   uint expanded_by = _hrm-&gt;expand_by(regions_to_expand, pretouch_workers);
1280   if (expand_time_ms != NULL) {
1281     *expand_time_ms = (os::elapsedTime() - expand_heap_start_time_sec) * MILLIUNITS;
1282   }
1283 
1284   if (expanded_by &gt; 0) {
1285     size_t actual_expand_bytes = expanded_by * HeapRegion::GrainBytes;
1286     assert(actual_expand_bytes &lt;= aligned_expand_bytes, &quot;post-condition&quot;);
1287     policy()-&gt;record_new_heap_size(num_regions());
1288   } else {
1289     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap expansion operation failed)&quot;);
1290 
1291     // The expansion of the virtual storage space was unsuccessful.
1292     // Let&#39;s see if it was because we ran out of swap.
1293     if (G1ExitOnExpansionFailure &amp;&amp;
1294         _hrm-&gt;available() &gt;= regions_to_expand) {
1295       // We had head room...
1296       vm_exit_out_of_memory(aligned_expand_bytes, OOM_MMAP_ERROR, &quot;G1 heap expansion&quot;);
1297     }
1298   }
1299   return regions_to_expand &gt; 0;
1300 }
1301 
1302 bool G1CollectedHeap::expand_single_region(uint node_index) {
1303   uint expanded_by = _hrm-&gt;expand_on_preferred_node(node_index);
1304 
1305   if (expanded_by == 0) {
1306     assert(is_maximal_no_gc(), &quot;Should be no regions left, available: %u&quot;, _hrm-&gt;available());
1307     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1308     return false;
1309   }
1310 
1311   policy()-&gt;record_new_heap_size(num_regions());
1312   return true;
1313 }
1314 
1315 void G1CollectedHeap::shrink_helper(size_t shrink_bytes) {
1316   size_t aligned_shrink_bytes =
1317     ReservedSpace::page_align_size_down(shrink_bytes);
1318   aligned_shrink_bytes = align_down(aligned_shrink_bytes,
1319                                          HeapRegion::GrainBytes);
1320   uint num_regions_to_remove = (uint)(shrink_bytes / HeapRegion::GrainBytes);
1321 
1322   uint num_regions_removed = _hrm-&gt;shrink_by(num_regions_to_remove);
1323   size_t shrunk_bytes = num_regions_removed * HeapRegion::GrainBytes;
1324 
1325   log_debug(gc, ergo, heap)(&quot;Shrink the heap. requested shrinking amount: &quot; SIZE_FORMAT &quot;B aligned shrinking amount: &quot; SIZE_FORMAT &quot;B attempted shrinking amount: &quot; SIZE_FORMAT &quot;B&quot;,
1326                             shrink_bytes, aligned_shrink_bytes, shrunk_bytes);
1327   if (num_regions_removed &gt; 0) {
1328     policy()-&gt;record_new_heap_size(num_regions());
1329   } else {
1330     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap shrinking operation failed)&quot;);
1331   }
1332 }
1333 
1334 void G1CollectedHeap::shrink(size_t shrink_bytes) {
1335   _verifier-&gt;verify_region_sets_optional();
1336 
1337   // We should only reach here at the end of a Full GC or during Remark which
1338   // means we should not not be holding to any GC alloc regions. The method
1339   // below will make sure of that and do any remaining clean up.
1340   _allocator-&gt;abandon_gc_alloc_regions();
1341 
1342   // Instead of tearing down / rebuilding the free lists here, we
1343   // could instead use the remove_all_pending() method on free_list to
1344   // remove only the ones that we need to remove.
1345   tear_down_region_sets(true /* free_list_only */);
1346   shrink_helper(shrink_bytes);
1347   rebuild_region_sets(true /* free_list_only */);
1348 
1349   _hrm-&gt;verify_optional();
1350   _verifier-&gt;verify_region_sets_optional();
1351 }
1352 
1353 class OldRegionSetChecker : public HeapRegionSetChecker {
1354 public:
1355   void check_mt_safety() {
1356     // Master Old Set MT safety protocol:
1357     // (a) If we&#39;re at a safepoint, operations on the master old set
1358     // should be invoked:
1359     // - by the VM thread (which will serialize them), or
1360     // - by the GC workers while holding the FreeList_lock, if we&#39;re
1361     //   at a safepoint for an evacuation pause (this lock is taken
1362     //   anyway when an GC alloc region is retired so that a new one
1363     //   is allocated from the free list), or
1364     // - by the GC workers while holding the OldSets_lock, if we&#39;re at a
1365     //   safepoint for a cleanup pause.
1366     // (b) If we&#39;re not at a safepoint, operations on the master old set
1367     // should be invoked while holding the Heap_lock.
1368 
1369     if (SafepointSynchronize::is_at_safepoint()) {
1370       guarantee(Thread::current()-&gt;is_VM_thread() ||
1371                 FreeList_lock-&gt;owned_by_self() || OldSets_lock-&gt;owned_by_self(),
1372                 &quot;master old set MT safety protocol at a safepoint&quot;);
1373     } else {
1374       guarantee(Heap_lock-&gt;owned_by_self(), &quot;master old set MT safety protocol outside a safepoint&quot;);
1375     }
1376   }
1377   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_old(); }
1378   const char* get_description() { return &quot;Old Regions&quot;; }
1379 };
1380 
1381 class ArchiveRegionSetChecker : public HeapRegionSetChecker {
1382 public:
1383   void check_mt_safety() {
1384     guarantee(!Universe::is_fully_initialized() || SafepointSynchronize::is_at_safepoint(),
1385               &quot;May only change archive regions during initialization or safepoint.&quot;);
1386   }
1387   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_archive(); }
1388   const char* get_description() { return &quot;Archive Regions&quot;; }
1389 };
1390 
1391 class HumongousRegionSetChecker : public HeapRegionSetChecker {
1392 public:
1393   void check_mt_safety() {
1394     // Humongous Set MT safety protocol:
1395     // (a) If we&#39;re at a safepoint, operations on the master humongous
1396     // set should be invoked by either the VM thread (which will
1397     // serialize them) or by the GC workers while holding the
1398     // OldSets_lock.
1399     // (b) If we&#39;re not at a safepoint, operations on the master
1400     // humongous set should be invoked while holding the Heap_lock.
1401 
1402     if (SafepointSynchronize::is_at_safepoint()) {
1403       guarantee(Thread::current()-&gt;is_VM_thread() ||
1404                 OldSets_lock-&gt;owned_by_self(),
1405                 &quot;master humongous set MT safety protocol at a safepoint&quot;);
1406     } else {
1407       guarantee(Heap_lock-&gt;owned_by_self(),
1408                 &quot;master humongous set MT safety protocol outside a safepoint&quot;);
1409     }
1410   }
1411   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_humongous(); }
1412   const char* get_description() { return &quot;Humongous Regions&quot;; }
1413 };
1414 
1415 G1CollectedHeap::G1CollectedHeap() :
1416   CollectedHeap(),
1417   _young_gen_sampling_thread(NULL),
1418   _workers(NULL),
1419   _card_table(NULL),
1420   _soft_ref_policy(),
1421   _old_set(&quot;Old Region Set&quot;, new OldRegionSetChecker()),
1422   _archive_set(&quot;Archive Region Set&quot;, new ArchiveRegionSetChecker()),
1423   _humongous_set(&quot;Humongous Region Set&quot;, new HumongousRegionSetChecker()),
1424   _bot(NULL),
1425   _listener(),
1426   _numa(G1NUMA::create()),
1427   _hrm(NULL),
1428   _allocator(NULL),
1429   _verifier(NULL),
1430   _summary_bytes_used(0),
1431   _bytes_used_during_gc(0),
1432   _archive_allocator(NULL),
1433   _survivor_evac_stats(&quot;Young&quot;, YoungPLABSize, PLABWeight),
1434   _old_evac_stats(&quot;Old&quot;, OldPLABSize, PLABWeight),
1435   _expand_heap_after_alloc_failure(true),
1436   _g1mm(NULL),
1437   _humongous_reclaim_candidates(),
1438   _has_humongous_reclaim_candidates(false),
1439   _hr_printer(),
1440   _collector_state(),
1441   _old_marking_cycles_started(0),
1442   _old_marking_cycles_completed(0),
1443   _eden(),
1444   _survivor(),
1445   _gc_timer_stw(new (ResourceObj::C_HEAP, mtGC) STWGCTimer()),
1446   _gc_tracer_stw(new (ResourceObj::C_HEAP, mtGC) G1NewTracer()),
1447   _policy(G1Policy::create_policy(_gc_timer_stw)),
1448   _heap_sizing_policy(NULL),
1449   _collection_set(this, _policy),
1450   _hot_card_cache(NULL),
1451   _rem_set(NULL),
1452   _cm(NULL),
1453   _cm_thread(NULL),
1454   _cr(NULL),
1455   _task_queues(NULL),
1456   _evacuation_failed(false),
1457   _evacuation_failed_info_array(NULL),
1458   _preserved_marks_set(true /* in_c_heap */),
1459 #ifndef PRODUCT
1460   _evacuation_failure_alot_for_current_gc(false),
1461   _evacuation_failure_alot_gc_number(0),
1462   _evacuation_failure_alot_count(0),
1463 #endif
1464   _ref_processor_stw(NULL),
1465   _is_alive_closure_stw(this),
1466   _is_subject_to_discovery_stw(this),
1467   _ref_processor_cm(NULL),
1468   _is_alive_closure_cm(this),
1469   _is_subject_to_discovery_cm(this),
1470   _region_attr() {
1471 
1472   _verifier = new G1HeapVerifier(this);
1473 
1474   _allocator = new G1Allocator(this);
1475 
1476   _heap_sizing_policy = G1HeapSizingPolicy::create(this, _policy-&gt;analytics());
1477 
1478   _humongous_object_threshold_in_words = humongous_threshold_for(HeapRegion::GrainWords);
1479 
1480   // Override the default _filler_array_max_size so that no humongous filler
1481   // objects are created.
1482   _filler_array_max_size = _humongous_object_threshold_in_words;
1483 
1484   uint n_queues = ParallelGCThreads;
1485   _task_queues = new G1ScannerTasksQueueSet(n_queues);
1486 
1487   _evacuation_failed_info_array = NEW_C_HEAP_ARRAY(EvacuationFailedInfo, n_queues, mtGC);
1488 
1489   for (uint i = 0; i &lt; n_queues; i++) {
1490     G1ScannerTasksQueue* q = new G1ScannerTasksQueue();
1491     q-&gt;initialize();
1492     _task_queues-&gt;register_queue(i, q);
1493     ::new (&amp;_evacuation_failed_info_array[i]) EvacuationFailedInfo();
1494   }
1495 
1496   // Initialize the G1EvacuationFailureALot counters and flags.
1497   NOT_PRODUCT(reset_evacuation_should_fail();)
1498   _gc_tracer_stw-&gt;initialize();
1499 
1500   guarantee(_task_queues != NULL, &quot;task_queues allocation failure.&quot;);
1501 }
1502 
1503 static size_t actual_reserved_page_size(ReservedSpace rs) {
1504   size_t page_size = os::vm_page_size();
1505   if (UseLargePages) {
1506     // There are two ways to manage large page memory.
1507     // 1. OS supports committing large page memory.
1508     // 2. OS doesn&#39;t support committing large page memory so ReservedSpace manages it.
1509     //    And ReservedSpace calls it &#39;special&#39;. If we failed to set &#39;special&#39;,
1510     //    we reserved memory without large page.
1511     if (os::can_commit_large_page_memory() || rs.special()) {
1512       // An alignment at ReservedSpace comes from preferred page size or
1513       // heap alignment, and if the alignment came from heap alignment, it could be
1514       // larger than large pages size. So need to cap with the large page size.
1515       page_size = MIN2(rs.alignment(), os::large_page_size());
1516     }
1517   }
1518 
1519   return page_size;
1520 }
1521 
1522 G1RegionToSpaceMapper* G1CollectedHeap::create_aux_memory_mapper(const char* description,
1523                                                                  size_t size,
1524                                                                  size_t translation_factor) {
1525   size_t preferred_page_size = os::page_size_for_region_unaligned(size, 1);
1526   // Allocate a new reserved space, preferring to use large pages.
1527   ReservedSpace rs(size, preferred_page_size);
1528   size_t page_size = actual_reserved_page_size(rs);
1529   G1RegionToSpaceMapper* result  =
1530     G1RegionToSpaceMapper::create_mapper(rs,
1531                                          size,
1532                                          page_size,
1533                                          HeapRegion::GrainBytes,
1534                                          translation_factor,
1535                                          mtGC);
1536 
1537   os::trace_page_sizes_for_requested_size(description,
1538                                           size,
1539                                           preferred_page_size,
1540                                           page_size,
1541                                           rs.base(),
1542                                           rs.size());
1543 
1544   return result;
1545 }
1546 
1547 jint G1CollectedHeap::initialize_concurrent_refinement() {
1548   jint ecode = JNI_OK;
1549   _cr = G1ConcurrentRefine::create(&amp;ecode);
1550   return ecode;
1551 }
1552 
1553 jint G1CollectedHeap::initialize_young_gen_sampling_thread() {
1554   _young_gen_sampling_thread = new G1YoungRemSetSamplingThread();
1555   if (_young_gen_sampling_thread-&gt;osthread() == NULL) {
1556     vm_shutdown_during_initialization(&quot;Could not create G1YoungRemSetSamplingThread&quot;);
1557     return JNI_ENOMEM;
1558   }
1559   return JNI_OK;
1560 }
1561 
1562 jint G1CollectedHeap::initialize() {
1563 
1564   // Necessary to satisfy locking discipline assertions.
1565 
1566   MutexLocker x(Heap_lock);
1567 
1568   // While there are no constraints in the GC code that HeapWordSize
1569   // be any particular value, there are multiple other areas in the
1570   // system which believe this to be true (e.g. oop-&gt;object_size in some
1571   // cases incorrectly returns the size in wordSize units rather than
1572   // HeapWordSize).
1573   guarantee(HeapWordSize == wordSize, &quot;HeapWordSize must equal wordSize&quot;);
1574 
1575   size_t init_byte_size = InitialHeapSize;
1576   size_t reserved_byte_size = G1Arguments::heap_reserved_size_bytes();
1577 
1578   // Ensure that the sizes are properly aligned.
1579   Universe::check_alignment(init_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1580   Universe::check_alignment(reserved_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1581   Universe::check_alignment(reserved_byte_size, HeapAlignment, &quot;g1 heap&quot;);
1582 
1583   // Reserve the maximum.
1584 
1585   // When compressed oops are enabled, the preferred heap base
1586   // is calculated by subtracting the requested size from the
1587   // 32Gb boundary and using the result as the base address for
1588   // heap reservation. If the requested size is not aligned to
1589   // HeapRegion::GrainBytes (i.e. the alignment that is passed
1590   // into the ReservedHeapSpace constructor) then the actual
1591   // base of the reserved heap may end up differing from the
1592   // address that was requested (i.e. the preferred heap base).
1593   // If this happens then we could end up using a non-optimal
1594   // compressed oops mode.
1595 
1596   ReservedHeapSpace heap_rs = Universe::reserve_heap(reserved_byte_size,
1597                                                      HeapAlignment);
1598 
1599   initialize_reserved_region(heap_rs);
1600 
1601   // Create the barrier set for the entire reserved region.
1602   G1CardTable* ct = new G1CardTable(heap_rs.region());
1603   ct-&gt;initialize();
1604   G1BarrierSet* bs = new G1BarrierSet(ct);
1605   bs-&gt;initialize();
1606   assert(bs-&gt;is_a(BarrierSet::G1BarrierSet), &quot;sanity&quot;);
1607   BarrierSet::set_barrier_set(bs);
1608   _card_table = ct;
1609 
1610   {
1611     G1SATBMarkQueueSet&amp; satbqs = bs-&gt;satb_mark_queue_set();
1612     satbqs.set_process_completed_buffers_threshold(G1SATBProcessCompletedThreshold);
1613     satbqs.set_buffer_enqueue_threshold_percentage(G1SATBBufferEnqueueingThresholdPercent);
1614   }
1615 
1616   // Create the hot card cache.
1617   _hot_card_cache = new G1HotCardCache(this);
1618 
1619   // Carve out the G1 part of the heap.
1620   ReservedSpace g1_rs = heap_rs.first_part(reserved_byte_size);
1621   size_t page_size = actual_reserved_page_size(heap_rs);
1622   G1RegionToSpaceMapper* heap_storage =
1623     G1RegionToSpaceMapper::create_heap_mapper(g1_rs,
1624                                               g1_rs.size(),
1625                                               page_size,
1626                                               HeapRegion::GrainBytes,
1627                                               1,
1628                                               mtJavaHeap);
1629   if(heap_storage == NULL) {
1630     vm_shutdown_during_initialization(&quot;Could not initialize G1 heap&quot;);
1631     return JNI_ERR;
1632   }
1633 
1634   os::trace_page_sizes(&quot;Heap&quot;,
1635                        MinHeapSize,
1636                        reserved_byte_size,
1637                        page_size,
1638                        heap_rs.base(),
1639                        heap_rs.size());
1640   heap_storage-&gt;set_mapping_changed_listener(&amp;_listener);
1641 
1642   // Create storage for the BOT, card table, card counts table (hot card cache) and the bitmaps.
1643   G1RegionToSpaceMapper* bot_storage =
1644     create_aux_memory_mapper(&quot;Block Offset Table&quot;,
1645                              G1BlockOffsetTable::compute_size(g1_rs.size() / HeapWordSize),
1646                              G1BlockOffsetTable::heap_map_factor());
1647 
1648   G1RegionToSpaceMapper* cardtable_storage =
1649     create_aux_memory_mapper(&quot;Card Table&quot;,
1650                              G1CardTable::compute_size(g1_rs.size() / HeapWordSize),
1651                              G1CardTable::heap_map_factor());
1652 
1653   G1RegionToSpaceMapper* card_counts_storage =
1654     create_aux_memory_mapper(&quot;Card Counts Table&quot;,
1655                              G1CardCounts::compute_size(g1_rs.size() / HeapWordSize),
1656                              G1CardCounts::heap_map_factor());
1657 
1658   size_t bitmap_size = G1CMBitMap::compute_size(g1_rs.size());
1659   G1RegionToSpaceMapper* prev_bitmap_storage =
1660     create_aux_memory_mapper(&quot;Prev Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1661   G1RegionToSpaceMapper* next_bitmap_storage =
1662     create_aux_memory_mapper(&quot;Next Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1663 
1664   _hrm = HeapRegionManager::create_manager(this);
1665 
1666   _hrm-&gt;initialize(heap_storage, prev_bitmap_storage, next_bitmap_storage, bot_storage, cardtable_storage, card_counts_storage);
1667   _card_table-&gt;initialize(cardtable_storage);
1668 
1669   // Do later initialization work for concurrent refinement.
1670   _hot_card_cache-&gt;initialize(card_counts_storage);
1671 
1672   // 6843694 - ensure that the maximum region index can fit
1673   // in the remembered set structures.
1674   const uint max_region_idx = (1U &lt;&lt; (sizeof(RegionIdx_t)*BitsPerByte-1)) - 1;
1675   guarantee((max_regions() - 1) &lt;= max_region_idx, &quot;too many regions&quot;);
1676 
1677   // The G1FromCardCache reserves card with value 0 as &quot;invalid&quot;, so the heap must not
1678   // start within the first card.
1679   guarantee(g1_rs.base() &gt;= (char*)G1CardTable::card_size, &quot;Java heap must not start within the first card.&quot;);
1680   // Also create a G1 rem set.
1681   _rem_set = new G1RemSet(this, _card_table, _hot_card_cache);
1682   _rem_set-&gt;initialize(max_reserved_capacity(), max_regions());
1683 
1684   size_t max_cards_per_region = ((size_t)1 &lt;&lt; (sizeof(CardIdx_t)*BitsPerByte-1)) - 1;
1685   guarantee(HeapRegion::CardsPerRegion &gt; 0, &quot;make sure it&#39;s initialized&quot;);
1686   guarantee(HeapRegion::CardsPerRegion &lt; max_cards_per_region,
1687             &quot;too many cards per region&quot;);
1688 
1689   FreeRegionList::set_unrealistically_long_length(max_expandable_regions() + 1);
1690 
1691   _bot = new G1BlockOffsetTable(reserved_region(), bot_storage);
1692 
1693   {
1694     HeapWord* start = _hrm-&gt;reserved().start();
1695     HeapWord* end = _hrm-&gt;reserved().end();
1696     size_t granularity = HeapRegion::GrainBytes;
1697 
1698     _region_attr.initialize(start, end, granularity);
1699     _humongous_reclaim_candidates.initialize(start, end, granularity);
1700   }
1701 
1702   _workers = new WorkGang(&quot;GC Thread&quot;, ParallelGCThreads,
1703                           true /* are_GC_task_threads */,
1704                           false /* are_ConcurrentGC_threads */);
1705   if (_workers == NULL) {
1706     return JNI_ENOMEM;
1707   }
1708   _workers-&gt;initialize_workers();
1709 
1710   _numa-&gt;set_region_info(HeapRegion::GrainBytes, page_size);
1711 
1712   // Create the G1ConcurrentMark data structure and thread.
1713   // (Must do this late, so that &quot;max_regions&quot; is defined.)
1714   _cm = new G1ConcurrentMark(this, prev_bitmap_storage, next_bitmap_storage);
1715   _cm_thread = _cm-&gt;cm_thread();
1716 
1717   // Now expand into the initial heap size.
1718   if (!expand(init_byte_size, _workers)) {
1719     vm_shutdown_during_initialization(&quot;Failed to allocate initial heap.&quot;);
1720     return JNI_ENOMEM;
1721   }
1722 
1723   // Perform any initialization actions delegated to the policy.
1724   policy()-&gt;init(this, &amp;_collection_set);
1725 
1726   jint ecode = initialize_concurrent_refinement();
1727   if (ecode != JNI_OK) {
1728     return ecode;
1729   }
1730 
1731   ecode = initialize_young_gen_sampling_thread();
1732   if (ecode != JNI_OK) {
1733     return ecode;
1734   }
1735 
1736   {
1737     G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
1738     dcqs.set_process_cards_threshold(concurrent_refine()-&gt;yellow_zone());
1739     dcqs.set_max_cards(concurrent_refine()-&gt;red_zone());
1740   }
1741 
1742   // Here we allocate the dummy HeapRegion that is required by the
1743   // G1AllocRegion class.
1744   HeapRegion* dummy_region = _hrm-&gt;get_dummy_region();
1745 
1746   // We&#39;ll re-use the same region whether the alloc region will
1747   // require BOT updates or not and, if it doesn&#39;t, then a non-young
1748   // region will complain that it cannot support allocations without
1749   // BOT updates. So we&#39;ll tag the dummy region as eden to avoid that.
1750   dummy_region-&gt;set_eden();
1751   // Make sure it&#39;s full.
1752   dummy_region-&gt;set_top(dummy_region-&gt;end());
1753   G1AllocRegion::setup(this, dummy_region);
1754 
1755   _allocator-&gt;init_mutator_alloc_regions();
1756 
1757   // Do create of the monitoring and management support so that
1758   // values in the heap have been properly initialized.
1759   _g1mm = new G1MonitoringSupport(this);
1760 
1761   G1StringDedup::initialize();
1762 
1763   _preserved_marks_set.init(ParallelGCThreads);
1764 
1765   _collection_set.initialize(max_regions());
1766 
1767   G1InitLogger::print();
1768 
1769   return JNI_OK;
1770 }
1771 
1772 void G1CollectedHeap::stop() {
1773   // Stop all concurrent threads. We do this to make sure these threads
1774   // do not continue to execute and access resources (e.g. logging)
1775   // that are destroyed during shutdown.
1776   _cr-&gt;stop();
1777   _young_gen_sampling_thread-&gt;stop();
1778   _cm_thread-&gt;stop();
1779   if (G1StringDedup::is_enabled()) {
1780     G1StringDedup::stop();
1781   }
1782 }
1783 
1784 void G1CollectedHeap::safepoint_synchronize_begin() {
1785   SuspendibleThreadSet::synchronize();
1786 }
1787 
1788 void G1CollectedHeap::safepoint_synchronize_end() {
1789   SuspendibleThreadSet::desynchronize();
1790 }
1791 
1792 void G1CollectedHeap::post_initialize() {
1793   CollectedHeap::post_initialize();
1794   ref_processing_init();
1795 }
1796 
1797 void G1CollectedHeap::ref_processing_init() {
1798   // Reference processing in G1 currently works as follows:
1799   //
1800   // * There are two reference processor instances. One is
1801   //   used to record and process discovered references
1802   //   during concurrent marking; the other is used to
1803   //   record and process references during STW pauses
1804   //   (both full and incremental).
1805   // * Both ref processors need to &#39;span&#39; the entire heap as
1806   //   the regions in the collection set may be dotted around.
1807   //
1808   // * For the concurrent marking ref processor:
1809   //   * Reference discovery is enabled at concurrent start.
1810   //   * Reference discovery is disabled and the discovered
1811   //     references processed etc during remarking.
1812   //   * Reference discovery is MT (see below).
1813   //   * Reference discovery requires a barrier (see below).
1814   //   * Reference processing may or may not be MT
1815   //     (depending on the value of ParallelRefProcEnabled
1816   //     and ParallelGCThreads).
1817   //   * A full GC disables reference discovery by the CM
1818   //     ref processor and abandons any entries on it&#39;s
1819   //     discovered lists.
1820   //
1821   // * For the STW processor:
1822   //   * Non MT discovery is enabled at the start of a full GC.
1823   //   * Processing and enqueueing during a full GC is non-MT.
1824   //   * During a full GC, references are processed after marking.
1825   //
1826   //   * Discovery (may or may not be MT) is enabled at the start
1827   //     of an incremental evacuation pause.
1828   //   * References are processed near the end of a STW evacuation pause.
1829   //   * For both types of GC:
1830   //     * Discovery is atomic - i.e. not concurrent.
1831   //     * Reference discovery will not need a barrier.
1832 
1833   bool mt_processing = ParallelRefProcEnabled &amp;&amp; (ParallelGCThreads &gt; 1);
1834 
1835   // Concurrent Mark ref processor
1836   _ref_processor_cm =
1837     new ReferenceProcessor(&amp;_is_subject_to_discovery_cm,
1838                            mt_processing,                                  // mt processing
1839                            ParallelGCThreads,                              // degree of mt processing
1840                            (ParallelGCThreads &gt; 1) || (ConcGCThreads &gt; 1), // mt discovery
1841                            MAX2(ParallelGCThreads, ConcGCThreads),         // degree of mt discovery
1842                            false,                                          // Reference discovery is not atomic
1843                            &amp;_is_alive_closure_cm,                          // is alive closure
1844                            true);                                          // allow changes to number of processing threads
1845 
1846   // STW ref processor
1847   _ref_processor_stw =
1848     new ReferenceProcessor(&amp;_is_subject_to_discovery_stw,
1849                            mt_processing,                        // mt processing
1850                            ParallelGCThreads,                    // degree of mt processing
1851                            (ParallelGCThreads &gt; 1),              // mt discovery
1852                            ParallelGCThreads,                    // degree of mt discovery
1853                            true,                                 // Reference discovery is atomic
1854                            &amp;_is_alive_closure_stw,               // is alive closure
1855                            true);                                // allow changes to number of processing threads
1856 }
1857 
1858 SoftRefPolicy* G1CollectedHeap::soft_ref_policy() {
1859   return &amp;_soft_ref_policy;
1860 }
1861 
1862 size_t G1CollectedHeap::capacity() const {
1863   return _hrm-&gt;length() * HeapRegion::GrainBytes;
1864 }
1865 
1866 size_t G1CollectedHeap::unused_committed_regions_in_bytes() const {
1867   return _hrm-&gt;total_free_bytes();
1868 }
1869 
1870 void G1CollectedHeap::iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_id) {
1871   _hot_card_cache-&gt;drain(cl, worker_id);
1872 }
1873 
1874 // Computes the sum of the storage used by the various regions.
1875 size_t G1CollectedHeap::used() const {
1876   size_t result = _summary_bytes_used + _allocator-&gt;used_in_alloc_regions();
1877   if (_archive_allocator != NULL) {
1878     result += _archive_allocator-&gt;used();
1879   }
1880   return result;
1881 }
1882 
1883 size_t G1CollectedHeap::used_unlocked() const {
1884   return _summary_bytes_used;
1885 }
1886 
1887 class SumUsedClosure: public HeapRegionClosure {
1888   size_t _used;
1889 public:
1890   SumUsedClosure() : _used(0) {}
1891   bool do_heap_region(HeapRegion* r) {
1892     _used += r-&gt;used();
1893     return false;
1894   }
1895   size_t result() { return _used; }
1896 };
1897 
1898 size_t G1CollectedHeap::recalculate_used() const {
1899   SumUsedClosure blk;
1900   heap_region_iterate(&amp;blk);
1901   return blk.result();
1902 }
1903 
1904 bool  G1CollectedHeap::is_user_requested_concurrent_full_gc(GCCause::Cause cause) {
1905   switch (cause) {
1906     case GCCause::_java_lang_system_gc:                 return ExplicitGCInvokesConcurrent;
1907     case GCCause::_dcmd_gc_run:                         return ExplicitGCInvokesConcurrent;
1908     case GCCause::_wb_conc_mark:                        return true;
1909     default :                                           return false;
1910   }
1911 }
1912 
1913 bool G1CollectedHeap::should_do_concurrent_full_gc(GCCause::Cause cause) {
1914   switch (cause) {
1915     case GCCause::_g1_humongous_allocation: return true;
1916     case GCCause::_g1_periodic_collection:  return G1PeriodicGCInvokesConcurrent;
1917     case GCCause::_wb_breakpoint:           return true;
1918     default:                                return is_user_requested_concurrent_full_gc(cause);
1919   }
1920 }
1921 
1922 bool G1CollectedHeap::should_upgrade_to_full_gc(GCCause::Cause cause) {
1923   if (policy()-&gt;force_upgrade_to_full()) {
1924     return true;
1925   } else if (should_do_concurrent_full_gc(_gc_cause)) {
1926     return false;
1927   } else if (has_regions_left_for_allocation()) {
1928     return false;
1929   } else {
1930     return true;
1931   }
1932 }
1933 
1934 #ifndef PRODUCT
1935 void G1CollectedHeap::allocate_dummy_regions() {
1936   // Let&#39;s fill up most of the region
1937   size_t word_size = HeapRegion::GrainWords - 1024;
1938   // And as a result the region we&#39;ll allocate will be humongous.
1939   guarantee(is_humongous(word_size), &quot;sanity&quot;);
1940 
1941   // _filler_array_max_size is set to humongous object threshold
1942   // but temporarily change it to use CollectedHeap::fill_with_object().
1943   AutoModifyRestore&lt;size_t&gt; temporarily(_filler_array_max_size, word_size);
1944 
1945   for (uintx i = 0; i &lt; G1DummyRegionsPerGC; ++i) {
1946     // Let&#39;s use the existing mechanism for the allocation
1947     HeapWord* dummy_obj = humongous_obj_allocate(word_size);
1948     if (dummy_obj != NULL) {
1949       MemRegion mr(dummy_obj, word_size);
1950       CollectedHeap::fill_with_object(mr);
1951     } else {
1952       // If we can&#39;t allocate once, we probably cannot allocate
1953       // again. Let&#39;s get out of the loop.
1954       break;
1955     }
1956   }
1957 }
1958 #endif // !PRODUCT
1959 
1960 void G1CollectedHeap::increment_old_marking_cycles_started() {
1961   assert(_old_marking_cycles_started == _old_marking_cycles_completed ||
1962          _old_marking_cycles_started == _old_marking_cycles_completed + 1,
1963          &quot;Wrong marking cycle count (started: %d, completed: %d)&quot;,
1964          _old_marking_cycles_started, _old_marking_cycles_completed);
1965 
1966   _old_marking_cycles_started++;
1967 }
1968 
1969 void G1CollectedHeap::increment_old_marking_cycles_completed(bool concurrent) {
1970   MonitorLocker ml(G1OldGCCount_lock, Mutex::_no_safepoint_check_flag);
1971 
1972   // We assume that if concurrent == true, then the caller is a
1973   // concurrent thread that was joined the Suspendible Thread
1974   // Set. If there&#39;s ever a cheap way to check this, we should add an
1975   // assert here.
1976 
1977   // Given that this method is called at the end of a Full GC or of a
1978   // concurrent cycle, and those can be nested (i.e., a Full GC can
1979   // interrupt a concurrent cycle), the number of full collections
1980   // completed should be either one (in the case where there was no
1981   // nesting) or two (when a Full GC interrupted a concurrent cycle)
1982   // behind the number of full collections started.
1983 
1984   // This is the case for the inner caller, i.e. a Full GC.
1985   assert(concurrent ||
1986          (_old_marking_cycles_started == _old_marking_cycles_completed + 1) ||
1987          (_old_marking_cycles_started == _old_marking_cycles_completed + 2),
1988          &quot;for inner caller (Full GC): _old_marking_cycles_started = %u &quot;
1989          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
1990          _old_marking_cycles_started, _old_marking_cycles_completed);
1991 
1992   // This is the case for the outer caller, i.e. the concurrent cycle.
1993   assert(!concurrent ||
1994          (_old_marking_cycles_started == _old_marking_cycles_completed + 1),
1995          &quot;for outer caller (concurrent cycle): &quot;
1996          &quot;_old_marking_cycles_started = %u &quot;
1997          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
1998          _old_marking_cycles_started, _old_marking_cycles_completed);
1999 
2000   _old_marking_cycles_completed += 1;
2001 
2002   // We need to clear the &quot;in_progress&quot; flag in the CM thread before
2003   // we wake up any waiters (especially when ExplicitInvokesConcurrent
2004   // is set) so that if a waiter requests another System.gc() it doesn&#39;t
2005   // incorrectly see that a marking cycle is still in progress.
2006   if (concurrent) {
2007     _cm_thread-&gt;set_idle();
2008   }
2009 
2010   // Notify threads waiting in System.gc() (with ExplicitGCInvokesConcurrent)
2011   // for a full GC to finish that their wait is over.
2012   ml.notify_all();
2013 }
2014 
2015 void G1CollectedHeap::collect(GCCause::Cause cause) {
2016   try_collect(cause);
2017 }
2018 
2019 // Return true if (x &lt; y) with allowance for wraparound.
2020 static bool gc_counter_less_than(uint x, uint y) {
2021   return (x - y) &gt; (UINT_MAX/2);
2022 }
2023 
2024 // LOG_COLLECT_CONCURRENTLY(cause, msg, args...)
2025 // Macro so msg printing is format-checked.
2026 #define LOG_COLLECT_CONCURRENTLY(cause, ...)                            \
2027   do {                                                                  \
2028     LogTarget(Trace, gc) LOG_COLLECT_CONCURRENTLY_lt;                   \
2029     if (LOG_COLLECT_CONCURRENTLY_lt.is_enabled()) {                     \
2030       ResourceMark rm; /* For thread name. */                           \
2031       LogStream LOG_COLLECT_CONCURRENTLY_s(&amp;LOG_COLLECT_CONCURRENTLY_lt); \
2032       LOG_COLLECT_CONCURRENTLY_s.print(&quot;%s: Try Collect Concurrently (%s): &quot;, \
2033                                        Thread::current()-&gt;name(),       \
2034                                        GCCause::to_string(cause));      \
2035       LOG_COLLECT_CONCURRENTLY_s.print(__VA_ARGS__);                    \
2036     }                                                                   \
2037   } while (0)
2038 
2039 #define LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, result) \
2040   LOG_COLLECT_CONCURRENTLY(cause, &quot;complete %s&quot;, BOOL_TO_STR(result))
2041 
2042 bool G1CollectedHeap::try_collect_concurrently(GCCause::Cause cause,
2043                                                uint gc_counter,
2044                                                uint old_marking_started_before) {
2045   assert_heap_not_locked();
2046   assert(should_do_concurrent_full_gc(cause),
2047          &quot;Non-concurrent cause %s&quot;, GCCause::to_string(cause));
2048 
2049   for (uint i = 1; true; ++i) {
2050     // Try to schedule concurrent start evacuation pause that will
2051     // start a concurrent cycle.
2052     LOG_COLLECT_CONCURRENTLY(cause, &quot;attempt %u&quot;, i);
2053     VM_G1TryInitiateConcMark op(gc_counter,
2054                                 cause,
2055                                 policy()-&gt;max_pause_time_ms());
2056     VMThread::execute(&amp;op);
2057 
2058     // Request is trivially finished.
2059     if (cause == GCCause::_g1_periodic_collection) {
2060       LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, op.gc_succeeded());
2061       return op.gc_succeeded();
2062     }
2063 
2064     // If VMOp skipped initiating concurrent marking cycle because
2065     // we&#39;re terminating, then we&#39;re done.
2066     if (op.terminating()) {
2067       LOG_COLLECT_CONCURRENTLY(cause, &quot;skipped: terminating&quot;);
2068       return false;
2069     }
2070 
2071     // Lock to get consistent set of values.
2072     uint old_marking_started_after;
2073     uint old_marking_completed_after;
2074     {
2075       MutexLocker ml(Heap_lock);
2076       // Update gc_counter for retrying VMOp if needed. Captured here to be
2077       // consistent with the values we use below for termination tests.  If
2078       // a retry is needed after a possible wait, and another collection
2079       // occurs in the meantime, it will cause our retry to be skipped and
2080       // we&#39;ll recheck for termination with updated conditions from that
2081       // more recent collection.  That&#39;s what we want, rather than having
2082       // our retry possibly perform an unnecessary collection.
2083       gc_counter = total_collections();
2084       old_marking_started_after = _old_marking_cycles_started;
2085       old_marking_completed_after = _old_marking_cycles_completed;
2086     }
2087 
2088     if (cause == GCCause::_wb_breakpoint) {
2089       if (op.gc_succeeded()) {
2090         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2091         return true;
2092       }
2093       // When _wb_breakpoint there can&#39;t be another cycle or deferred.
2094       assert(!op.cycle_already_in_progress(), &quot;invariant&quot;);
2095       assert(!op.whitebox_attached(), &quot;invariant&quot;);
2096       // Concurrent cycle attempt might have been cancelled by some other
2097       // collection, so retry.  Unlike other cases below, we want to retry
2098       // even if cancelled by a STW full collection, because we really want
2099       // to start a concurrent cycle.
2100       if (old_marking_started_before != old_marking_started_after) {
2101         LOG_COLLECT_CONCURRENTLY(cause, &quot;ignoring STW full GC&quot;);
2102         old_marking_started_before = old_marking_started_after;
2103       }
2104     } else if (!GCCause::is_user_requested_gc(cause)) {
2105       // For an &quot;automatic&quot; (not user-requested) collection, we just need to
2106       // ensure that progress is made.
2107       //
2108       // Request is finished if any of
2109       // (1) the VMOp successfully performed a GC,
2110       // (2) a concurrent cycle was already in progress,
2111       // (3) whitebox is controlling concurrent cycles,
2112       // (4) a new cycle was started (by this thread or some other), or
2113       // (5) a Full GC was performed.
2114       // Cases (4) and (5) are detected together by a change to
2115       // _old_marking_cycles_started.
2116       //
2117       // Note that (1) does not imply (4).  If we&#39;re still in the mixed
2118       // phase of an earlier concurrent collection, the request to make the
2119       // collection a concurrent start won&#39;t be honored.  If we don&#39;t check for
2120       // both conditions we&#39;ll spin doing back-to-back collections.
2121       if (op.gc_succeeded() ||
2122           op.cycle_already_in_progress() ||
2123           op.whitebox_attached() ||
2124           (old_marking_started_before != old_marking_started_after)) {
2125         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2126         return true;
2127       }
2128     } else {                    // User-requested GC.
2129       // For a user-requested collection, we want to ensure that a complete
2130       // full collection has been performed before returning, but without
2131       // waiting for more than needed.
2132 
2133       // For user-requested GCs (unlike non-UR), a successful VMOp implies a
2134       // new cycle was started.  That&#39;s good, because it&#39;s not clear what we
2135       // should do otherwise.  Trying again just does back to back GCs.
2136       // Can&#39;t wait for someone else to start a cycle.  And returning fails
2137       // to meet the goal of ensuring a full collection was performed.
2138       assert(!op.gc_succeeded() ||
2139              (old_marking_started_before != old_marking_started_after),
2140              &quot;invariant: succeeded %s, started before %u, started after %u&quot;,
2141              BOOL_TO_STR(op.gc_succeeded()),
2142              old_marking_started_before, old_marking_started_after);
2143 
2144       // Request is finished if a full collection (concurrent or stw)
2145       // was started after this request and has completed, e.g.
2146       // started_before &lt; completed_after.
2147       if (gc_counter_less_than(old_marking_started_before,
2148                                old_marking_completed_after)) {
2149         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2150         return true;
2151       }
2152 
2153       if (old_marking_started_after != old_marking_completed_after) {
2154         // If there is an in-progress cycle (possibly started by us), then
2155         // wait for that cycle to complete, e.g.
2156         // while completed_now &lt; started_after.
2157         LOG_COLLECT_CONCURRENTLY(cause, &quot;wait&quot;);
2158         MonitorLocker ml(G1OldGCCount_lock);
2159         while (gc_counter_less_than(_old_marking_cycles_completed,
2160                                     old_marking_started_after)) {
2161           ml.wait();
2162         }
2163         // Request is finished if the collection we just waited for was
2164         // started after this request.
2165         if (old_marking_started_before != old_marking_started_after) {
2166           LOG_COLLECT_CONCURRENTLY(cause, &quot;complete after wait&quot;);
2167           return true;
2168         }
2169       }
2170 
2171       // If VMOp was successful then it started a new cycle that the above
2172       // wait &amp;etc should have recognized as finishing this request.  This
2173       // differs from a non-user-request, where gc_succeeded does not imply
2174       // a new cycle was started.
2175       assert(!op.gc_succeeded(), &quot;invariant&quot;);
2176 
2177       if (op.cycle_already_in_progress()) {
2178         // If VMOp failed because a cycle was already in progress, it
2179         // is now complete.  But it didn&#39;t finish this user-requested
2180         // GC, so try again.
2181         LOG_COLLECT_CONCURRENTLY(cause, &quot;retry after in-progress&quot;);
2182         continue;
2183       } else if (op.whitebox_attached()) {
2184         // If WhiteBox wants control, wait for notification of a state
2185         // change in the controller, then try again.  Don&#39;t wait for
2186         // release of control, since collections may complete while in
2187         // control.  Note: This won&#39;t recognize a STW full collection
2188         // while waiting; we can&#39;t wait on multiple monitors.
2189         LOG_COLLECT_CONCURRENTLY(cause, &quot;whitebox control stall&quot;);
2190         MonitorLocker ml(ConcurrentGCBreakpoints::monitor());
2191         if (ConcurrentGCBreakpoints::is_controlled()) {
2192           ml.wait();
2193         }
2194         continue;
2195       }
2196     }
2197 
2198     // Collection failed and should be retried.
2199     assert(op.transient_failure(), &quot;invariant&quot;);
2200 
2201     if (GCLocker::is_active_and_needs_gc()) {
2202       // If GCLocker is active, wait until clear before retrying.
2203       LOG_COLLECT_CONCURRENTLY(cause, &quot;gc-locker stall&quot;);
2204       GCLocker::stall_until_clear();
2205     }
2206 
2207     LOG_COLLECT_CONCURRENTLY(cause, &quot;retry&quot;);
2208   }
2209 }
2210 
2211 bool G1CollectedHeap::try_collect(GCCause::Cause cause) {
2212   assert_heap_not_locked();
2213 
2214   // Lock to get consistent set of values.
2215   uint gc_count_before;
2216   uint full_gc_count_before;
2217   uint old_marking_started_before;
2218   {
2219     MutexLocker ml(Heap_lock);
2220     gc_count_before = total_collections();
2221     full_gc_count_before = total_full_collections();
2222     old_marking_started_before = _old_marking_cycles_started;
2223   }
2224 
2225   if (should_do_concurrent_full_gc(cause)) {
2226     return try_collect_concurrently(cause,
2227                                     gc_count_before,
2228                                     old_marking_started_before);
2229   } else if (GCLocker::should_discard(cause, gc_count_before)) {
2230     // Indicate failure to be consistent with VMOp failure due to
2231     // another collection slipping in after our gc_count but before
2232     // our request is processed.
2233     return false;
2234   } else if (cause == GCCause::_gc_locker || cause == GCCause::_wb_young_gc
2235              DEBUG_ONLY(|| cause == GCCause::_scavenge_alot)) {
2236 
2237     // Schedule a standard evacuation pause. We&#39;re setting word_size
2238     // to 0 which means that we are not requesting a post-GC allocation.
2239     VM_G1CollectForAllocation op(0,     /* word_size */
2240                                  gc_count_before,
2241                                  cause,
2242                                  policy()-&gt;max_pause_time_ms());
2243     VMThread::execute(&amp;op);
2244     return op.gc_succeeded();
2245   } else {
2246     // Schedule a Full GC.
2247     VM_G1CollectFull op(gc_count_before, full_gc_count_before, cause);
2248     VMThread::execute(&amp;op);
2249     return op.gc_succeeded();
2250   }
2251 }
2252 
2253 bool G1CollectedHeap::is_in(const void* p) const {
2254   if (_hrm-&gt;reserved().contains(p)) {
2255     // Given that we know that p is in the reserved space,
2256     // heap_region_containing() should successfully
2257     // return the containing region.
2258     HeapRegion* hr = heap_region_containing(p);
2259     return hr-&gt;is_in(p);
2260   } else {
2261     return false;
2262   }
2263 }
2264 
2265 #ifdef ASSERT
2266 bool G1CollectedHeap::is_in_exact(const void* p) const {
2267   bool contains = reserved_region().contains(p);
2268   bool available = _hrm-&gt;is_available(addr_to_region((HeapWord*)p));
2269   if (contains &amp;&amp; available) {
2270     return true;
2271   } else {
2272     return false;
2273   }
2274 }
2275 #endif
2276 
2277 // Iteration functions.
2278 
2279 // Iterates an ObjectClosure over all objects within a HeapRegion.
2280 
2281 class IterateObjectClosureRegionClosure: public HeapRegionClosure {
2282   ObjectClosure* _cl;
2283 public:
2284   IterateObjectClosureRegionClosure(ObjectClosure* cl) : _cl(cl) {}
2285   bool do_heap_region(HeapRegion* r) {
2286     if (!r-&gt;is_continues_humongous()) {
2287       r-&gt;object_iterate(_cl);
2288     }
2289     return false;
2290   }
2291 };
2292 
2293 void G1CollectedHeap::object_iterate(ObjectClosure* cl) {
2294   IterateObjectClosureRegionClosure blk(cl);
2295   heap_region_iterate(&amp;blk);
2296 }
2297 
2298 void G1CollectedHeap::keep_alive(oop obj) {
2299   G1BarrierSet::enqueue(obj);
2300 }
2301 
2302 void G1CollectedHeap::heap_region_iterate(HeapRegionClosure* cl) const {
2303   _hrm-&gt;iterate(cl);
2304 }
2305 
2306 void G1CollectedHeap::heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
2307                                                                  HeapRegionClaimer *hrclaimer,
2308                                                                  uint worker_id) const {
2309   _hrm-&gt;par_iterate(cl, hrclaimer, hrclaimer-&gt;offset_for_worker(worker_id));
2310 }
2311 
2312 void G1CollectedHeap::heap_region_par_iterate_from_start(HeapRegionClosure* cl,
2313                                                          HeapRegionClaimer *hrclaimer) const {
2314   _hrm-&gt;par_iterate(cl, hrclaimer, 0);
2315 }
2316 
2317 void G1CollectedHeap::collection_set_iterate_all(HeapRegionClosure* cl) {
2318   _collection_set.iterate(cl);
2319 }
2320 
2321 void G1CollectedHeap::collection_set_par_iterate_all(HeapRegionClosure* cl, HeapRegionClaimer* hr_claimer, uint worker_id) {
2322   _collection_set.par_iterate(cl, hr_claimer, worker_id, workers()-&gt;active_workers());
2323 }
2324 
2325 void G1CollectedHeap::collection_set_iterate_increment_from(HeapRegionClosure *cl, HeapRegionClaimer* hr_claimer, uint worker_id) {
2326   _collection_set.iterate_incremental_part_from(cl, hr_claimer, worker_id, workers()-&gt;active_workers());
2327 }
2328 
2329 HeapWord* G1CollectedHeap::block_start(const void* addr) const {
2330   HeapRegion* hr = heap_region_containing(addr);
2331   return hr-&gt;block_start(addr);
2332 }
2333 
2334 bool G1CollectedHeap::block_is_obj(const HeapWord* addr) const {
2335   HeapRegion* hr = heap_region_containing(addr);
2336   return hr-&gt;block_is_obj(addr);
2337 }
2338 
2339 bool G1CollectedHeap::supports_tlab_allocation() const {
2340   return true;
2341 }
2342 
2343 size_t G1CollectedHeap::tlab_capacity(Thread* ignored) const {
2344   return (_policy-&gt;young_list_target_length() - _survivor.length()) * HeapRegion::GrainBytes;
2345 }
2346 
2347 size_t G1CollectedHeap::tlab_used(Thread* ignored) const {
2348   return _eden.length() * HeapRegion::GrainBytes;
2349 }
2350 
2351 // For G1 TLABs should not contain humongous objects, so the maximum TLAB size
2352 // must be equal to the humongous object limit.
2353 size_t G1CollectedHeap::max_tlab_size() const {
2354   return align_down(_humongous_object_threshold_in_words, MinObjAlignment);
2355 }
2356 
2357 size_t G1CollectedHeap::unsafe_max_tlab_alloc(Thread* ignored) const {
2358   return _allocator-&gt;unsafe_max_tlab_alloc();
2359 }
2360 
2361 size_t G1CollectedHeap::max_capacity() const {
2362   return _hrm-&gt;max_expandable_length() * HeapRegion::GrainBytes;
2363 }
2364 
2365 size_t G1CollectedHeap::max_reserved_capacity() const {
2366   return _hrm-&gt;max_length() * HeapRegion::GrainBytes;
2367 }
2368 
2369 jlong G1CollectedHeap::millis_since_last_gc() {
2370   // See the notes in GenCollectedHeap::millis_since_last_gc()
2371   // for more information about the implementation.
2372   jlong ret_val = (os::javaTimeNanos() / NANOSECS_PER_MILLISEC) -
2373                   _policy-&gt;collection_pause_end_millis();
2374   if (ret_val &lt; 0) {
2375     log_warning(gc)(&quot;millis_since_last_gc() would return : &quot; JLONG_FORMAT
2376       &quot;. returning zero instead.&quot;, ret_val);
2377     return 0;
2378   }
2379   return ret_val;
2380 }
2381 
2382 void G1CollectedHeap::deduplicate_string(oop str) {
2383   assert(java_lang_String::is_instance(str), &quot;invariant&quot;);
2384 
2385   if (G1StringDedup::is_enabled()) {
2386     G1StringDedup::deduplicate(str);
2387   }
2388 }
2389 
2390 void G1CollectedHeap::prepare_for_verify() {
2391   _verifier-&gt;prepare_for_verify();
2392 }
2393 
2394 void G1CollectedHeap::verify(VerifyOption vo) {
2395   _verifier-&gt;verify(vo);
2396 }
2397 
2398 bool G1CollectedHeap::supports_concurrent_gc_breakpoints() const {
2399   return true;
2400 }
2401 
2402 bool G1CollectedHeap::is_heterogeneous_heap() const {
2403   return G1Arguments::is_heterogeneous_heap();
2404 }
2405 
2406 class PrintRegionClosure: public HeapRegionClosure {
2407   outputStream* _st;
2408 public:
2409   PrintRegionClosure(outputStream* st) : _st(st) {}
2410   bool do_heap_region(HeapRegion* r) {
2411     r-&gt;print_on(_st);
2412     return false;
2413   }
2414 };
2415 
2416 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2417                                        const HeapRegion* hr,
2418                                        const VerifyOption vo) const {
2419   switch (vo) {
2420   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj, hr);
2421   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj, hr);
2422   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj, hr);
2423   default:                            ShouldNotReachHere();
2424   }
2425   return false; // keep some compilers happy
2426 }
2427 
2428 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2429                                        const VerifyOption vo) const {
2430   switch (vo) {
2431   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj);
2432   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj);
2433   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj);
2434   default:                            ShouldNotReachHere();
2435   }
2436   return false; // keep some compilers happy
2437 }
2438 
2439 void G1CollectedHeap::print_heap_regions() const {
2440   LogTarget(Trace, gc, heap, region) lt;
2441   if (lt.is_enabled()) {
2442     LogStream ls(lt);
2443     print_regions_on(&amp;ls);
2444   }
2445 }
2446 
2447 void G1CollectedHeap::print_on(outputStream* st) const {
2448   st-&gt;print(&quot; %-20s&quot;, &quot;garbage-first heap&quot;);
2449   if (_hrm != NULL) {
2450     st-&gt;print(&quot; total &quot; SIZE_FORMAT &quot;K, used &quot; SIZE_FORMAT &quot;K&quot;,
2451               capacity()/K, used_unlocked()/K);
2452     st-&gt;print(&quot; [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;)&quot;,
2453               p2i(_hrm-&gt;reserved().start()),
2454               p2i(_hrm-&gt;reserved().end()));
2455   }
2456   st-&gt;cr();
2457   st-&gt;print(&quot;  region size &quot; SIZE_FORMAT &quot;K, &quot;, HeapRegion::GrainBytes / K);
2458   uint young_regions = young_regions_count();
2459   st-&gt;print(&quot;%u young (&quot; SIZE_FORMAT &quot;K), &quot;, young_regions,
2460             (size_t) young_regions * HeapRegion::GrainBytes / K);
2461   uint survivor_regions = survivor_regions_count();
2462   st-&gt;print(&quot;%u survivors (&quot; SIZE_FORMAT &quot;K)&quot;, survivor_regions,
2463             (size_t) survivor_regions * HeapRegion::GrainBytes / K);
2464   st-&gt;cr();
2465   if (_numa-&gt;is_enabled()) {
2466     uint num_nodes = _numa-&gt;num_active_nodes();
2467     st-&gt;print(&quot;  remaining free region(s) on each NUMA node: &quot;);
2468     const int* node_ids = _numa-&gt;node_ids();
2469     for (uint node_index = 0; node_index &lt; num_nodes; node_index++) {
2470       uint num_free_regions = (_hrm != NULL ? _hrm-&gt;num_free_regions(node_index) : 0);
2471       st-&gt;print(&quot;%d=%u &quot;, node_ids[node_index], num_free_regions);
2472     }
2473     st-&gt;cr();
2474   }
2475   MetaspaceUtils::print_on(st);
2476 }
2477 
2478 void G1CollectedHeap::print_regions_on(outputStream* st) const {
2479   if (_hrm == NULL) {
2480     return;
2481   }
2482 
2483   st-&gt;print_cr(&quot;Heap Regions: E=young(eden), S=young(survivor), O=old, &quot;
2484                &quot;HS=humongous(starts), HC=humongous(continues), &quot;
2485                &quot;CS=collection set, F=free, &quot;
2486                &quot;OA=open archive, CA=closed archive, &quot;
2487                &quot;TAMS=top-at-mark-start (previous, next)&quot;);
2488   PrintRegionClosure blk(st);
2489   heap_region_iterate(&amp;blk);
2490 }
2491 
2492 void G1CollectedHeap::print_extended_on(outputStream* st) const {
2493   print_on(st);
2494 
2495   // Print the per-region information.
2496   if (_hrm != NULL) {
2497     st-&gt;cr();
2498     print_regions_on(st);
2499   }
2500 }
2501 
2502 void G1CollectedHeap::print_on_error(outputStream* st) const {
2503   this-&gt;CollectedHeap::print_on_error(st);
2504 
2505   if (_cm != NULL) {
2506     st-&gt;cr();
2507     _cm-&gt;print_on_error(st);
2508   }
2509 }
2510 
2511 void G1CollectedHeap::gc_threads_do(ThreadClosure* tc) const {
2512   workers()-&gt;threads_do(tc);
2513   tc-&gt;do_thread(_cm_thread);
2514   _cm-&gt;threads_do(tc);
2515   _cr-&gt;threads_do(tc);
2516   tc-&gt;do_thread(_young_gen_sampling_thread);
2517   if (G1StringDedup::is_enabled()) {
2518     G1StringDedup::threads_do(tc);
2519   }
2520 }
2521 
2522 void G1CollectedHeap::print_tracing_info() const {
2523   rem_set()-&gt;print_summary_info();
2524   concurrent_mark()-&gt;print_summary_info();
2525 }
2526 
2527 #ifndef PRODUCT
2528 // Helpful for debugging RSet issues.
2529 
2530 class PrintRSetsClosure : public HeapRegionClosure {
2531 private:
2532   const char* _msg;
2533   size_t _occupied_sum;
2534 
2535 public:
2536   bool do_heap_region(HeapRegion* r) {
2537     HeapRegionRemSet* hrrs = r-&gt;rem_set();
2538     size_t occupied = hrrs-&gt;occupied();
2539     _occupied_sum += occupied;
2540 
2541     tty-&gt;print_cr(&quot;Printing RSet for region &quot; HR_FORMAT, HR_FORMAT_PARAMS(r));
2542     if (occupied == 0) {
2543       tty-&gt;print_cr(&quot;  RSet is empty&quot;);
2544     } else {
2545       hrrs-&gt;print();
2546     }
2547     tty-&gt;print_cr(&quot;----------&quot;);
2548     return false;
2549   }
2550 
2551   PrintRSetsClosure(const char* msg) : _msg(msg), _occupied_sum(0) {
2552     tty-&gt;cr();
2553     tty-&gt;print_cr(&quot;========================================&quot;);
2554     tty-&gt;print_cr(&quot;%s&quot;, msg);
2555     tty-&gt;cr();
2556   }
2557 
2558   ~PrintRSetsClosure() {
2559     tty-&gt;print_cr(&quot;Occupied Sum: &quot; SIZE_FORMAT, _occupied_sum);
2560     tty-&gt;print_cr(&quot;========================================&quot;);
2561     tty-&gt;cr();
2562   }
2563 };
2564 
2565 void G1CollectedHeap::print_cset_rsets() {
2566   PrintRSetsClosure cl(&quot;Printing CSet RSets&quot;);
2567   collection_set_iterate_all(&amp;cl);
2568 }
2569 
2570 void G1CollectedHeap::print_all_rsets() {
2571   PrintRSetsClosure cl(&quot;Printing All RSets&quot;);;
2572   heap_region_iterate(&amp;cl);
2573 }
2574 #endif // PRODUCT
2575 
2576 bool G1CollectedHeap::print_location(outputStream* st, void* addr) const {
2577   return BlockLocationPrinter&lt;G1CollectedHeap&gt;::print_location(st, addr);
2578 }
2579 
2580 G1HeapSummary G1CollectedHeap::create_g1_heap_summary() {
2581 
2582   size_t eden_used_bytes = _eden.used_bytes();
2583   size_t survivor_used_bytes = _survivor.used_bytes();
2584   size_t heap_used = Heap_lock-&gt;owned_by_self() ? used() : used_unlocked();
2585 
2586   size_t eden_capacity_bytes =
2587     (policy()-&gt;young_list_target_length() * HeapRegion::GrainBytes) - survivor_used_bytes;
2588 
2589   VirtualSpaceSummary heap_summary = create_heap_space_summary();
2590   return G1HeapSummary(heap_summary, heap_used, eden_used_bytes,
2591                        eden_capacity_bytes, survivor_used_bytes, num_regions());
2592 }
2593 
2594 G1EvacSummary G1CollectedHeap::create_g1_evac_summary(G1EvacStats* stats) {
2595   return G1EvacSummary(stats-&gt;allocated(), stats-&gt;wasted(), stats-&gt;undo_wasted(),
2596                        stats-&gt;unused(), stats-&gt;used(), stats-&gt;region_end_waste(),
2597                        stats-&gt;regions_filled(), stats-&gt;direct_allocated(),
2598                        stats-&gt;failure_used(), stats-&gt;failure_waste());
2599 }
2600 
2601 void G1CollectedHeap::trace_heap(GCWhen::Type when, const GCTracer* gc_tracer) {
2602   const G1HeapSummary&amp; heap_summary = create_g1_heap_summary();
2603   gc_tracer-&gt;report_gc_heap_summary(when, heap_summary);
2604 
2605   const MetaspaceSummary&amp; metaspace_summary = create_metaspace_summary();
2606   gc_tracer-&gt;report_metaspace_summary(when, metaspace_summary);
2607 }
2608 
2609 void G1CollectedHeap::gc_prologue(bool full) {
2610   assert(InlineCacheBuffer::is_empty(), &quot;should have cleaned up ICBuffer&quot;);
2611 
2612   // This summary needs to be printed before incrementing total collections.
2613   rem_set()-&gt;print_periodic_summary_info(&quot;Before GC RS summary&quot;, total_collections());
2614 
2615   // Update common counters.
2616   increment_total_collections(full /* full gc */);
2617   if (full || collector_state()-&gt;in_concurrent_start_gc()) {
2618     increment_old_marking_cycles_started();
2619   }
2620 
2621   // Fill TLAB&#39;s and such
2622   {
2623     Ticks start = Ticks::now();
2624     ensure_parsability(true);
2625     Tickspan dt = Ticks::now() - start;
2626     phase_times()-&gt;record_prepare_tlab_time_ms(dt.seconds() * MILLIUNITS);
2627   }
2628 
2629   if (!full) {
2630     // Flush dirty card queues to qset, so later phases don&#39;t need to account
2631     // for partially filled per-thread queues and such.  Not needed for full
2632     // collections, which ignore those logs.
2633     Ticks start = Ticks::now();
2634     G1BarrierSet::dirty_card_queue_set().concatenate_logs();
2635     Tickspan dt = Ticks::now() - start;
2636     phase_times()-&gt;record_concatenate_dirty_card_logs_time_ms(dt.seconds() * MILLIUNITS);
2637   }
2638 }
2639 
2640 void G1CollectedHeap::gc_epilogue(bool full) {
2641   // Update common counters.
2642   if (full) {
2643     // Update the number of full collections that have been completed.
2644     increment_old_marking_cycles_completed(false /* concurrent */);
2645   }
2646 
2647   // We are at the end of the GC. Total collections has already been increased.
2648   rem_set()-&gt;print_periodic_summary_info(&quot;After GC RS summary&quot;, total_collections() - 1);
2649 
2650   // FIXME: what is this about?
2651   // I&#39;m ignoring the &quot;fill_newgen()&quot; call if &quot;alloc_event_enabled&quot;
2652   // is set.
2653 #if COMPILER2_OR_JVMCI
2654   assert(DerivedPointerTable::is_empty(), &quot;derived pointer present&quot;);
2655 #endif
2656 
2657   double start = os::elapsedTime();
2658   resize_all_tlabs();
2659   phase_times()-&gt;record_resize_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2660 
2661   MemoryService::track_memory_usage();
2662   // We have just completed a GC. Update the soft reference
2663   // policy with the new heap occupancy
2664   Universe::update_heap_info_at_gc();
2665 
2666   // Print NUMA statistics.
2667   _numa-&gt;print_statistics();
2668 }
2669 
2670 void G1CollectedHeap::verify_numa_regions(const char* desc) {
2671   LogTarget(Trace, gc, heap, verify) lt;
2672 
2673   if (lt.is_enabled()) {
2674     LogStream ls(lt);
2675     // Iterate all heap regions to print matching between preferred numa id and actual numa id.
2676     G1NodeIndexCheckClosure cl(desc, _numa, &amp;ls);
2677     heap_region_iterate(&amp;cl);
2678   }
2679 }
2680 
2681 HeapWord* G1CollectedHeap::do_collection_pause(size_t word_size,
2682                                                uint gc_count_before,
2683                                                bool* succeeded,
2684                                                GCCause::Cause gc_cause) {
2685   assert_heap_not_locked_and_not_at_safepoint();
2686   VM_G1CollectForAllocation op(word_size,
2687                                gc_count_before,
2688                                gc_cause,
2689                                policy()-&gt;max_pause_time_ms());
2690   VMThread::execute(&amp;op);
2691 
2692   HeapWord* result = op.result();
2693   bool ret_succeeded = op.prologue_succeeded() &amp;&amp; op.gc_succeeded();
2694   assert(result == NULL || ret_succeeded,
2695          &quot;the result should be NULL if the VM did not succeed&quot;);
2696   *succeeded = ret_succeeded;
2697 
2698   assert_heap_not_locked();
2699   return result;
2700 }
2701 
2702 void G1CollectedHeap::do_concurrent_mark() {
2703   MutexLocker x(CGC_lock, Mutex::_no_safepoint_check_flag);
2704   if (!_cm_thread-&gt;in_progress()) {
2705     _cm_thread-&gt;set_started();
2706     CGC_lock-&gt;notify();
2707   }
2708 }
2709 
2710 bool G1CollectedHeap::is_potential_eager_reclaim_candidate(HeapRegion* r) const {
2711   // We don&#39;t nominate objects with many remembered set entries, on
2712   // the assumption that such objects are likely still live.
2713   HeapRegionRemSet* rem_set = r-&gt;rem_set();
2714 
2715   return G1EagerReclaimHumongousObjectsWithStaleRefs ?
2716          rem_set-&gt;occupancy_less_or_equal_than(G1RSetSparseRegionEntries) :
2717          G1EagerReclaimHumongousObjects &amp;&amp; rem_set-&gt;is_empty();
2718 }
2719 
2720 #ifndef PRODUCT
2721 void G1CollectedHeap::verify_region_attr_remset_update() {
2722   class VerifyRegionAttrRemSet : public HeapRegionClosure {
2723   public:
2724     virtual bool do_heap_region(HeapRegion* r) {
2725       G1CollectedHeap* g1h = G1CollectedHeap::heap();
2726       bool const needs_remset_update = g1h-&gt;region_attr(r-&gt;bottom()).needs_remset_update();
2727       assert(r-&gt;rem_set()-&gt;is_tracked() == needs_remset_update,
2728              &quot;Region %u remset tracking status (%s) different to region attribute (%s)&quot;,
2729              r-&gt;hrm_index(), BOOL_TO_STR(r-&gt;rem_set()-&gt;is_tracked()), BOOL_TO_STR(needs_remset_update));
2730       return false;
2731     }
2732   } cl;
2733   heap_region_iterate(&amp;cl);
2734 }
2735 #endif
2736 
2737 class VerifyRegionRemSetClosure : public HeapRegionClosure {
2738   public:
2739     bool do_heap_region(HeapRegion* hr) {
2740       if (!hr-&gt;is_archive() &amp;&amp; !hr-&gt;is_continues_humongous()) {
2741         hr-&gt;verify_rem_set();
2742       }
2743       return false;
2744     }
2745 };
2746 
2747 uint G1CollectedHeap::num_task_queues() const {
2748   return _task_queues-&gt;size();
2749 }
2750 
2751 #if TASKQUEUE_STATS
2752 void G1CollectedHeap::print_taskqueue_stats_hdr(outputStream* const st) {
2753   st-&gt;print_raw_cr(&quot;GC Task Stats&quot;);
2754   st-&gt;print_raw(&quot;thr &quot;); TaskQueueStats::print_header(1, st); st-&gt;cr();
2755   st-&gt;print_raw(&quot;--- &quot;); TaskQueueStats::print_header(2, st); st-&gt;cr();
2756 }
2757 
2758 void G1CollectedHeap::print_taskqueue_stats() const {
2759   if (!log_is_enabled(Trace, gc, task, stats)) {
2760     return;
2761   }
2762   Log(gc, task, stats) log;
2763   ResourceMark rm;
2764   LogStream ls(log.trace());
2765   outputStream* st = &amp;ls;
2766 
2767   print_taskqueue_stats_hdr(st);
2768 
2769   TaskQueueStats totals;
2770   const uint n = num_task_queues();
2771   for (uint i = 0; i &lt; n; ++i) {
2772     st-&gt;print(&quot;%3u &quot;, i); task_queue(i)-&gt;stats.print(st); st-&gt;cr();
2773     totals += task_queue(i)-&gt;stats;
2774   }
2775   st-&gt;print_raw(&quot;tot &quot;); totals.print(st); st-&gt;cr();
2776 
2777   DEBUG_ONLY(totals.verify());
2778 }
2779 
2780 void G1CollectedHeap::reset_taskqueue_stats() {
2781   const uint n = num_task_queues();
2782   for (uint i = 0; i &lt; n; ++i) {
2783     task_queue(i)-&gt;stats.reset();
2784   }
2785 }
2786 #endif // TASKQUEUE_STATS
2787 
2788 void G1CollectedHeap::wait_for_root_region_scanning() {
2789   double scan_wait_start = os::elapsedTime();
2790   // We have to wait until the CM threads finish scanning the
2791   // root regions as it&#39;s the only way to ensure that all the
2792   // objects on them have been correctly scanned before we start
2793   // moving them during the GC.
2794   bool waited = _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
2795   double wait_time_ms = 0.0;
2796   if (waited) {
2797     double scan_wait_end = os::elapsedTime();
2798     wait_time_ms = (scan_wait_end - scan_wait_start) * 1000.0;
2799   }
2800   phase_times()-&gt;record_root_region_scan_wait_time(wait_time_ms);
2801 }
2802 
2803 class G1PrintCollectionSetClosure : public HeapRegionClosure {
2804 private:
2805   G1HRPrinter* _hr_printer;
2806 public:
2807   G1PrintCollectionSetClosure(G1HRPrinter* hr_printer) : HeapRegionClosure(), _hr_printer(hr_printer) { }
2808 
2809   virtual bool do_heap_region(HeapRegion* r) {
2810     _hr_printer-&gt;cset(r);
2811     return false;
2812   }
2813 };
2814 
2815 void G1CollectedHeap::start_new_collection_set() {
2816   double start = os::elapsedTime();
2817 
2818   collection_set()-&gt;start_incremental_building();
2819 
2820   clear_region_attr();
2821 
2822   guarantee(_eden.length() == 0, &quot;eden should have been cleared&quot;);
2823   policy()-&gt;transfer_survivors_to_cset(survivor());
2824 
2825   // We redo the verification but now wrt to the new CSet which
2826   // has just got initialized after the previous CSet was freed.
2827   _cm-&gt;verify_no_collection_set_oops();
2828 
2829   phase_times()-&gt;record_start_new_cset_time_ms((os::elapsedTime() - start) * 1000.0);
2830 }
2831 
2832 void G1CollectedHeap::calculate_collection_set(G1EvacuationInfo&amp; evacuation_info, double target_pause_time_ms) {
2833 
2834   _collection_set.finalize_initial_collection_set(target_pause_time_ms, &amp;_survivor);
2835   evacuation_info.set_collectionset_regions(collection_set()-&gt;region_length() +
2836                                             collection_set()-&gt;optional_region_length());
2837 
2838   _cm-&gt;verify_no_collection_set_oops();
2839 
2840   if (_hr_printer.is_active()) {
2841     G1PrintCollectionSetClosure cl(&amp;_hr_printer);
2842     _collection_set.iterate(&amp;cl);
2843     _collection_set.iterate_optional(&amp;cl);
2844   }
2845 }
2846 
2847 G1HeapVerifier::G1VerifyType G1CollectedHeap::young_collection_verify_type() const {
2848   if (collector_state()-&gt;in_concurrent_start_gc()) {
2849     return G1HeapVerifier::G1VerifyConcurrentStart;
2850   } else if (collector_state()-&gt;in_young_only_phase()) {
2851     return G1HeapVerifier::G1VerifyYoungNormal;
2852   } else {
2853     return G1HeapVerifier::G1VerifyMixed;
2854   }
2855 }
2856 
2857 void G1CollectedHeap::verify_before_young_collection(G1HeapVerifier::G1VerifyType type) {
2858   if (VerifyRememberedSets) {
2859     log_info(gc, verify)(&quot;[Verifying RemSets before GC]&quot;);
2860     VerifyRegionRemSetClosure v_cl;
2861     heap_region_iterate(&amp;v_cl);
2862   }
2863   _verifier-&gt;verify_before_gc(type);
2864   _verifier-&gt;check_bitmaps(&quot;GC Start&quot;);
2865   verify_numa_regions(&quot;GC Start&quot;);
2866 }
2867 
2868 void G1CollectedHeap::verify_after_young_collection(G1HeapVerifier::G1VerifyType type) {
2869   if (VerifyRememberedSets) {
2870     log_info(gc, verify)(&quot;[Verifying RemSets after GC]&quot;);
2871     VerifyRegionRemSetClosure v_cl;
2872     heap_region_iterate(&amp;v_cl);
2873   }
2874   _verifier-&gt;verify_after_gc(type);
2875   _verifier-&gt;check_bitmaps(&quot;GC End&quot;);
2876   verify_numa_regions(&quot;GC End&quot;);
2877 }
2878 
2879 void G1CollectedHeap::expand_heap_after_young_collection(){
2880   size_t expand_bytes = _heap_sizing_policy-&gt;young_collection_expansion_amount();
2881   if (expand_bytes &gt; 0) {
2882     // No need for an ergo logging here,
2883     // expansion_amount() does this when it returns a value &gt; 0.
2884     double expand_ms;
2885     if (!expand(expand_bytes, _workers, &amp;expand_ms)) {
2886       // We failed to expand the heap. Cannot do anything about it.
2887     }
2888     phase_times()-&gt;record_expand_heap_time(expand_ms);
2889   }
2890 }
2891 
2892 const char* G1CollectedHeap::young_gc_name() const {
2893   if (collector_state()-&gt;in_concurrent_start_gc()) {
2894     return &quot;Pause Young (Concurrent Start)&quot;;
2895   } else if (collector_state()-&gt;in_young_only_phase()) {
2896     if (collector_state()-&gt;in_young_gc_before_mixed()) {
2897       return &quot;Pause Young (Prepare Mixed)&quot;;
2898     } else {
2899       return &quot;Pause Young (Normal)&quot;;
2900     }
2901   } else {
2902     return &quot;Pause Young (Mixed)&quot;;
2903   }
2904 }
2905 
2906 bool G1CollectedHeap::do_collection_pause_at_safepoint(double target_pause_time_ms) {
2907   assert_at_safepoint_on_vm_thread();
2908   guarantee(!is_gc_active(), &quot;collection is not reentrant&quot;);
2909 
2910   if (GCLocker::check_active_before_gc()) {
2911     return false;
2912   }
2913 
2914   do_collection_pause_at_safepoint_helper(target_pause_time_ms);
2915   if (should_upgrade_to_full_gc(gc_cause())) {
2916     log_info(gc, ergo)(&quot;Attempting maximally compacting collection&quot;);
2917     bool result = do_full_collection(false /* explicit gc */,
2918                                      true /* clear_all_soft_refs */);
2919     // do_full_collection only fails if blocked by GC locker, but
2920     // we&#39;ve already checked for that above.
2921     assert(result, &quot;invariant&quot;);
2922   }
2923   return true;
2924 }
2925 
2926 void G1CollectedHeap::do_collection_pause_at_safepoint_helper(double target_pause_time_ms) {
2927   GCIdMark gc_id_mark;
2928 
2929   SvcGCMarker sgcm(SvcGCMarker::MINOR);
2930   ResourceMark rm;
2931 
2932   policy()-&gt;note_gc_start();
2933 
2934   _gc_timer_stw-&gt;register_gc_start();
2935   _gc_tracer_stw-&gt;report_gc_start(gc_cause(), _gc_timer_stw-&gt;gc_start());
2936 
2937   wait_for_root_region_scanning();
2938 
2939   print_heap_before_gc();
2940   print_heap_regions();
2941   trace_heap_before_gc(_gc_tracer_stw);
2942 
2943   _verifier-&gt;verify_region_sets_optional();
2944   _verifier-&gt;verify_dirty_young_regions();
2945 
2946   // We should not be doing concurrent start unless the concurrent mark thread is running
2947   if (!_cm_thread-&gt;should_terminate()) {
2948     // This call will decide whether this pause is a concurrent start
2949     // pause. If it is, in_concurrent_start_gc() will return true
2950     // for the duration of this pause.
2951     policy()-&gt;decide_on_conc_mark_initiation();
2952   }
2953 
2954   // We do not allow concurrent start to be piggy-backed on a mixed GC.
2955   assert(!collector_state()-&gt;in_concurrent_start_gc() ||
2956          collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
2957   // We also do not allow mixed GCs during marking.
2958   assert(!collector_state()-&gt;mark_or_rebuild_in_progress() || collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
2959 
2960   // Record whether this pause is a concurrent start. When the current
2961   // thread has completed its logging output and it&#39;s safe to signal
2962   // the CM thread, the flag&#39;s value in the policy has been reset.
2963   bool should_start_conc_mark = collector_state()-&gt;in_concurrent_start_gc();
2964   if (should_start_conc_mark) {
2965     _cm-&gt;gc_tracer_cm()-&gt;set_gc_cause(gc_cause());
2966   }
2967 
2968   // Inner scope for scope based logging, timers, and stats collection
2969   {
2970     G1EvacuationInfo evacuation_info;
2971 
2972     _gc_tracer_stw-&gt;report_yc_type(collector_state()-&gt;yc_type());
2973 
2974     GCTraceCPUTime tcpu;
2975 
2976     GCTraceTime(Info, gc) tm(young_gc_name(), NULL, gc_cause(), true);
2977 
2978     uint active_workers = WorkerPolicy::calc_active_workers(workers()-&gt;total_workers(),
2979                                                             workers()-&gt;active_workers(),
2980                                                             Threads::number_of_non_daemon_threads());
2981     active_workers = workers()-&gt;update_active_workers(active_workers);
2982     log_info(gc,task)(&quot;Using %u workers of %u for evacuation&quot;, active_workers, workers()-&gt;total_workers());
2983 
2984     G1MonitoringScope ms(g1mm(),
2985                          false /* full_gc */,
2986                          collector_state()-&gt;yc_type() == Mixed /* all_memory_pools_affected */);
2987 
2988     G1HeapTransition heap_transition(this);
2989 
2990     {
2991       IsGCActiveMark x;
2992 
2993       gc_prologue(false);
2994 
2995       G1HeapVerifier::G1VerifyType verify_type = young_collection_verify_type();
2996       verify_before_young_collection(verify_type);
2997 
2998       {
2999         // The elapsed time induced by the start time below deliberately elides
3000         // the possible verification above.
3001         double sample_start_time_sec = os::elapsedTime();
3002 
3003         // Please see comment in g1CollectedHeap.hpp and
3004         // G1CollectedHeap::ref_processing_init() to see how
3005         // reference processing currently works in G1.
3006         _ref_processor_stw-&gt;enable_discovery();
3007 
3008         // We want to temporarily turn off discovery by the
3009         // CM ref processor, if necessary, and turn it back on
3010         // on again later if we do. Using a scoped
3011         // NoRefDiscovery object will do this.
3012         NoRefDiscovery no_cm_discovery(_ref_processor_cm);
3013 
3014         policy()-&gt;record_collection_pause_start(sample_start_time_sec);
3015 
3016         // Forget the current allocation region (we might even choose it to be part
3017         // of the collection set!).
3018         _allocator-&gt;release_mutator_alloc_regions();
3019 
3020         calculate_collection_set(evacuation_info, target_pause_time_ms);
3021 
3022         G1RedirtyCardsQueueSet rdcqs(G1BarrierSet::dirty_card_queue_set().allocator());
3023         G1ParScanThreadStateSet per_thread_states(this,
3024                                                   &amp;rdcqs,
3025                                                   workers()-&gt;active_workers(),
3026                                                   collection_set()-&gt;young_region_length(),
3027                                                   collection_set()-&gt;optional_region_length());
3028         pre_evacuate_collection_set(evacuation_info, &amp;per_thread_states);
3029 
3030         // Actually do the work...
3031         evacuate_initial_collection_set(&amp;per_thread_states);
3032 
3033         if (_collection_set.optional_region_length() != 0) {
3034           evacuate_optional_collection_set(&amp;per_thread_states);
3035         }
3036         post_evacuate_collection_set(evacuation_info, &amp;rdcqs, &amp;per_thread_states);
3037 
3038         start_new_collection_set();
3039 
3040         _survivor_evac_stats.adjust_desired_plab_sz();
3041         _old_evac_stats.adjust_desired_plab_sz();
3042 
3043         if (should_start_conc_mark) {
3044           // We have to do this before we notify the CM threads that
3045           // they can start working to make sure that all the
3046           // appropriate initialization is done on the CM object.
3047           concurrent_mark()-&gt;post_concurrent_start();
3048           // Note that we don&#39;t actually trigger the CM thread at
3049           // this point. We do that later when we&#39;re sure that
3050           // the current thread has completed its logging output.
3051         }
3052 
3053         allocate_dummy_regions();
3054 
3055         _allocator-&gt;init_mutator_alloc_regions();
3056 
3057         expand_heap_after_young_collection();
3058 
3059         double sample_end_time_sec = os::elapsedTime();
3060         double pause_time_ms = (sample_end_time_sec - sample_start_time_sec) * MILLIUNITS;
3061         policy()-&gt;record_collection_pause_end(pause_time_ms);
3062       }
3063 
3064       verify_after_young_collection(verify_type);
3065 
3066       gc_epilogue(false);
3067     }
3068 
3069     // Print the remainder of the GC log output.
3070     if (evacuation_failed()) {
3071       log_info(gc)(&quot;To-space exhausted&quot;);
3072     }
3073 
3074     policy()-&gt;print_phases();
3075     heap_transition.print();
3076 
3077     _hrm-&gt;verify_optional();
3078     _verifier-&gt;verify_region_sets_optional();
3079 
3080     TASKQUEUE_STATS_ONLY(print_taskqueue_stats());
3081     TASKQUEUE_STATS_ONLY(reset_taskqueue_stats());
3082 
3083     print_heap_after_gc();
3084     print_heap_regions();
3085     trace_heap_after_gc(_gc_tracer_stw);
3086 
3087     // We must call G1MonitoringSupport::update_sizes() in the same scoping level
3088     // as an active TraceMemoryManagerStats object (i.e. before the destructor for the
3089     // TraceMemoryManagerStats is called) so that the G1 memory pools are updated
3090     // before any GC notifications are raised.
3091     g1mm()-&gt;update_sizes();
3092 
3093     _gc_tracer_stw-&gt;report_evacuation_info(&amp;evacuation_info);
3094     _gc_tracer_stw-&gt;report_tenuring_threshold(_policy-&gt;tenuring_threshold());
3095     _gc_timer_stw-&gt;register_gc_end();
3096     _gc_tracer_stw-&gt;report_gc_end(_gc_timer_stw-&gt;gc_end(), _gc_timer_stw-&gt;time_partitions());
3097   }
3098   // It should now be safe to tell the concurrent mark thread to start
3099   // without its logging output interfering with the logging output
3100   // that came from the pause.
3101 
3102   if (should_start_conc_mark) {
3103     // CAUTION: after the doConcurrentMark() call below, the concurrent marking
3104     // thread(s) could be running concurrently with us. Make sure that anything
3105     // after this point does not assume that we are the only GC thread running.
3106     // Note: of course, the actual marking work will not start until the safepoint
3107     // itself is released in SuspendibleThreadSet::desynchronize().
3108     do_concurrent_mark();
3109     ConcurrentGCBreakpoints::notify_idle_to_active();
3110   }
3111 }
3112 
3113 void G1CollectedHeap::remove_self_forwarding_pointers(G1RedirtyCardsQueueSet* rdcqs) {
3114   G1ParRemoveSelfForwardPtrsTask rsfp_task(rdcqs);
3115   workers()-&gt;run_task(&amp;rsfp_task);
3116 }
3117 
3118 void G1CollectedHeap::restore_after_evac_failure(G1RedirtyCardsQueueSet* rdcqs) {
3119   double remove_self_forwards_start = os::elapsedTime();
3120 
3121   remove_self_forwarding_pointers(rdcqs);
3122   _preserved_marks_set.restore(workers());
3123 
3124   phase_times()-&gt;record_evac_fail_remove_self_forwards((os::elapsedTime() - remove_self_forwards_start) * 1000.0);
3125 }
3126 
3127 void G1CollectedHeap::preserve_mark_during_evac_failure(uint worker_id, oop obj, markWord m) {
3128   if (!_evacuation_failed) {
3129     _evacuation_failed = true;
3130   }
3131 
3132   _evacuation_failed_info_array[worker_id].register_copy_failure(obj-&gt;size());
3133   _preserved_marks_set.get(worker_id)-&gt;push_if_necessary(obj, m);
3134 }
3135 
3136 bool G1ParEvacuateFollowersClosure::offer_termination() {
3137   EventGCPhaseParallel event;
3138   G1ParScanThreadState* const pss = par_scan_state();
3139   start_term_time();
3140   const bool res = terminator()-&gt;offer_termination();
3141   end_term_time();
3142   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(G1GCPhaseTimes::Termination));
3143   return res;
3144 }
3145 
3146 void G1ParEvacuateFollowersClosure::do_void() {
3147   EventGCPhaseParallel event;
3148   G1ParScanThreadState* const pss = par_scan_state();
3149   pss-&gt;trim_queue();
3150   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3151   do {
3152     EventGCPhaseParallel event;
3153     pss-&gt;steal_and_trim_queue(queues());
3154     event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3155   } while (!offer_termination());
3156 }
3157 
3158 void G1CollectedHeap::complete_cleaning(BoolObjectClosure* is_alive,
3159                                         bool class_unloading_occurred) {
3160   uint num_workers = workers()-&gt;active_workers();
3161   G1ParallelCleaningTask unlink_task(is_alive, num_workers, class_unloading_occurred, false);
3162   workers()-&gt;run_task(&amp;unlink_task);
3163 }
3164 
3165 // Clean string dedup data structures.
3166 // Ideally we would prefer to use a StringDedupCleaningTask here, but we want to
3167 // record the durations of the phases. Hence the almost-copy.
3168 class G1StringDedupCleaningTask : public AbstractGangTask {
3169   BoolObjectClosure* _is_alive;
3170   OopClosure* _keep_alive;
3171   G1GCPhaseTimes* _phase_times;
3172 
3173 public:
3174   G1StringDedupCleaningTask(BoolObjectClosure* is_alive,
3175                             OopClosure* keep_alive,
3176                             G1GCPhaseTimes* phase_times) :
3177     AbstractGangTask(&quot;Partial Cleaning Task&quot;),
3178     _is_alive(is_alive),
3179     _keep_alive(keep_alive),
3180     _phase_times(phase_times)
3181   {
3182     assert(G1StringDedup::is_enabled(), &quot;String deduplication disabled.&quot;);
3183     StringDedup::gc_prologue(true);
3184   }
3185 
3186   ~G1StringDedupCleaningTask() {
3187     StringDedup::gc_epilogue();
3188   }
3189 
3190   void work(uint worker_id) {
3191     StringDedupUnlinkOrOopsDoClosure cl(_is_alive, _keep_alive);
3192     {
3193       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupQueueFixup, worker_id);
3194       StringDedupQueue::unlink_or_oops_do(&amp;cl);
3195     }
3196     {
3197       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupTableFixup, worker_id);
3198       StringDedupTable::unlink_or_oops_do(&amp;cl, worker_id);
3199     }
3200   }
3201 };
3202 
3203 void G1CollectedHeap::string_dedup_cleaning(BoolObjectClosure* is_alive,
3204                                             OopClosure* keep_alive,
3205                                             G1GCPhaseTimes* phase_times) {
3206   G1StringDedupCleaningTask cl(is_alive, keep_alive, phase_times);
3207   workers()-&gt;run_task(&amp;cl);
3208 }
3209 
3210 class G1RedirtyLoggedCardsTask : public AbstractGangTask {
3211  private:
3212   G1RedirtyCardsQueueSet* _qset;
3213   G1CollectedHeap* _g1h;
3214   BufferNode* volatile _nodes;
3215 
3216   void par_apply(RedirtyLoggedCardTableEntryClosure* cl, uint worker_id) {
3217     size_t buffer_size = _qset-&gt;buffer_size();
3218     BufferNode* next = Atomic::load(&amp;_nodes);
3219     while (next != NULL) {
3220       BufferNode* node = next;
3221       next = Atomic::cmpxchg(&amp;_nodes, node, node-&gt;next());
3222       if (next == node) {
3223         cl-&gt;apply_to_buffer(node, buffer_size, worker_id);
3224         next = node-&gt;next();
3225       }
3226     }
3227   }
3228 
3229  public:
3230   G1RedirtyLoggedCardsTask(G1RedirtyCardsQueueSet* qset, G1CollectedHeap* g1h) :
3231     AbstractGangTask(&quot;Redirty Cards&quot;),
3232     _qset(qset), _g1h(g1h), _nodes(qset-&gt;all_completed_buffers()) { }
3233 
3234   virtual void work(uint worker_id) {
3235     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3236     G1GCParPhaseTimesTracker x(p, G1GCPhaseTimes::RedirtyCards, worker_id);
3237 
3238     RedirtyLoggedCardTableEntryClosure cl(_g1h);
3239     par_apply(&amp;cl, worker_id);
3240 
3241     p-&gt;record_thread_work_item(G1GCPhaseTimes::RedirtyCards, worker_id, cl.num_dirtied());
3242   }
3243 };
3244 
3245 void G1CollectedHeap::redirty_logged_cards(G1RedirtyCardsQueueSet* rdcqs) {
3246   double redirty_logged_cards_start = os::elapsedTime();
3247 
3248   G1RedirtyLoggedCardsTask redirty_task(rdcqs, this);
3249   workers()-&gt;run_task(&amp;redirty_task);
3250 
3251   G1DirtyCardQueueSet&amp; dcq = G1BarrierSet::dirty_card_queue_set();
3252   dcq.merge_bufferlists(rdcqs);
3253 
3254   phase_times()-&gt;record_redirty_logged_cards_time_ms((os::elapsedTime() - redirty_logged_cards_start) * 1000.0);
3255 }
3256 
3257 // Weak Reference Processing support
3258 
3259 bool G1STWIsAliveClosure::do_object_b(oop p) {
3260   // An object is reachable if it is outside the collection set,
3261   // or is inside and copied.
3262   return !_g1h-&gt;is_in_cset(p) || p-&gt;is_forwarded();
3263 }
3264 
3265 bool G1STWSubjectToDiscoveryClosure::do_object_b(oop obj) {
3266   assert(obj != NULL, &quot;must not be NULL&quot;);
3267   assert(_g1h-&gt;is_in_reserved(obj), &quot;Trying to discover obj &quot; PTR_FORMAT &quot; not in heap&quot;, p2i(obj));
3268   // The areas the CM and STW ref processor manage must be disjoint. The is_in_cset() below
3269   // may falsely indicate that this is not the case here: however the collection set only
3270   // contains old regions when concurrent mark is not running.
3271   return _g1h-&gt;is_in_cset(obj) || _g1h-&gt;heap_region_containing(obj)-&gt;is_survivor();
3272 }
3273 
3274 // Non Copying Keep Alive closure
3275 class G1KeepAliveClosure: public OopClosure {
3276   G1CollectedHeap*_g1h;
3277 public:
3278   G1KeepAliveClosure(G1CollectedHeap* g1h) :_g1h(g1h) {}
3279   void do_oop(narrowOop* p) { guarantee(false, &quot;Not needed&quot;); }
3280   void do_oop(oop* p) {
3281     oop obj = *p;
3282     assert(obj != NULL, &quot;the caller should have filtered out NULL values&quot;);
3283 
3284     const G1HeapRegionAttr region_attr =_g1h-&gt;region_attr(obj);
3285     if (!region_attr.is_in_cset_or_humongous()) {
3286       return;
3287     }
3288     if (region_attr.is_in_cset()) {
3289       assert( obj-&gt;is_forwarded(), &quot;invariant&quot; );
3290       *p = obj-&gt;forwardee();
3291     } else {
3292       assert(!obj-&gt;is_forwarded(), &quot;invariant&quot; );
3293       assert(region_attr.is_humongous(),
3294              &quot;Only allowed G1HeapRegionAttr state is IsHumongous, but is %d&quot;, region_attr.type());
3295      _g1h-&gt;set_humongous_is_live(obj);
3296     }
3297   }
3298 };
3299 
3300 // Copying Keep Alive closure - can be called from both
3301 // serial and parallel code as long as different worker
3302 // threads utilize different G1ParScanThreadState instances
3303 // and different queues.
3304 
3305 class G1CopyingKeepAliveClosure: public OopClosure {
3306   G1CollectedHeap*         _g1h;
3307   G1ParScanThreadState*    _par_scan_state;
3308 
3309 public:
3310   G1CopyingKeepAliveClosure(G1CollectedHeap* g1h,
3311                             G1ParScanThreadState* pss):
3312     _g1h(g1h),
3313     _par_scan_state(pss)
3314   {}
3315 
3316   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
3317   virtual void do_oop(      oop* p) { do_oop_work(p); }
3318 
3319   template &lt;class T&gt; void do_oop_work(T* p) {
3320     oop obj = RawAccess&lt;&gt;::oop_load(p);
3321 
3322     if (_g1h-&gt;is_in_cset_or_humongous(obj)) {
3323       // If the referent object has been forwarded (either copied
3324       // to a new location or to itself in the event of an
3325       // evacuation failure) then we need to update the reference
3326       // field and, if both reference and referent are in the G1
3327       // heap, update the RSet for the referent.
3328       //
3329       // If the referent has not been forwarded then we have to keep
3330       // it alive by policy. Therefore we have copy the referent.
3331       //
3332       // When the queue is drained (after each phase of reference processing)
3333       // the object and it&#39;s followers will be copied, the reference field set
3334       // to point to the new location, and the RSet updated.
3335       _par_scan_state-&gt;push_on_queue(ScannerTask(p));
3336     }
3337   }
3338 };
3339 
3340 // Serial drain queue closure. Called as the &#39;complete_gc&#39;
3341 // closure for each discovered list in some of the
3342 // reference processing phases.
3343 
3344 class G1STWDrainQueueClosure: public VoidClosure {
3345 protected:
3346   G1CollectedHeap* _g1h;
3347   G1ParScanThreadState* _par_scan_state;
3348 
3349   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
3350 
3351 public:
3352   G1STWDrainQueueClosure(G1CollectedHeap* g1h, G1ParScanThreadState* pss) :
3353     _g1h(g1h),
3354     _par_scan_state(pss)
3355   { }
3356 
3357   void do_void() {
3358     G1ParScanThreadState* const pss = par_scan_state();
3359     pss-&gt;trim_queue();
3360   }
3361 };
3362 
3363 // Parallel Reference Processing closures
3364 
3365 // Implementation of AbstractRefProcTaskExecutor for parallel reference
3366 // processing during G1 evacuation pauses.
3367 
3368 class G1STWRefProcTaskExecutor: public AbstractRefProcTaskExecutor {
3369 private:
3370   G1CollectedHeap*          _g1h;
3371   G1ParScanThreadStateSet*  _pss;
3372   G1ScannerTasksQueueSet*   _queues;
3373   WorkGang*                 _workers;
3374 
3375 public:
3376   G1STWRefProcTaskExecutor(G1CollectedHeap* g1h,
3377                            G1ParScanThreadStateSet* per_thread_states,
3378                            WorkGang* workers,
3379                            G1ScannerTasksQueueSet *task_queues) :
3380     _g1h(g1h),
3381     _pss(per_thread_states),
3382     _queues(task_queues),
3383     _workers(workers)
3384   {
3385     g1h-&gt;ref_processor_stw()-&gt;set_active_mt_degree(workers-&gt;active_workers());
3386   }
3387 
3388   // Executes the given task using concurrent marking worker threads.
3389   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
3390 };
3391 
3392 // Gang task for possibly parallel reference processing
3393 
3394 class G1STWRefProcTaskProxy: public AbstractGangTask {
3395   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
3396   ProcessTask&amp;     _proc_task;
3397   G1CollectedHeap* _g1h;
3398   G1ParScanThreadStateSet* _pss;
3399   G1ScannerTasksQueueSet* _task_queues;
3400   TaskTerminator* _terminator;
3401 
3402 public:
3403   G1STWRefProcTaskProxy(ProcessTask&amp; proc_task,
3404                         G1CollectedHeap* g1h,
3405                         G1ParScanThreadStateSet* per_thread_states,
3406                         G1ScannerTasksQueueSet *task_queues,
3407                         TaskTerminator* terminator) :
3408     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
3409     _proc_task(proc_task),
3410     _g1h(g1h),
3411     _pss(per_thread_states),
3412     _task_queues(task_queues),
3413     _terminator(terminator)
3414   {}
3415 
3416   virtual void work(uint worker_id) {
3417     // The reference processing task executed by a single worker.
3418     ResourceMark rm;
3419     HandleMark   hm;
3420 
3421     G1STWIsAliveClosure is_alive(_g1h);
3422 
3423     G1ParScanThreadState* pss = _pss-&gt;state_for_worker(worker_id);
3424     pss-&gt;set_ref_discoverer(NULL);
3425 
3426     // Keep alive closure.
3427     G1CopyingKeepAliveClosure keep_alive(_g1h, pss);
3428 
3429     // Complete GC closure
3430     G1ParEvacuateFollowersClosure drain_queue(_g1h, pss, _task_queues, _terminator, G1GCPhaseTimes::ObjCopy);
3431 
3432     // Call the reference processing task&#39;s work routine.
3433     _proc_task.work(worker_id, is_alive, keep_alive, drain_queue);
3434 
3435     // Note we cannot assert that the refs array is empty here as not all
3436     // of the processing tasks (specifically phase2 - pp2_work) execute
3437     // the complete_gc closure (which ordinarily would drain the queue) so
3438     // the queue may not be empty.
3439   }
3440 };
3441 
3442 // Driver routine for parallel reference processing.
3443 // Creates an instance of the ref processing gang
3444 // task and has the worker threads execute it.
3445 void G1STWRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
3446   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
3447 
3448   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
3449          &quot;Ergonomically chosen workers (%u) should be less than or equal to active workers (%u)&quot;,
3450          ergo_workers, _workers-&gt;active_workers());
3451   TaskTerminator terminator(ergo_workers, _queues);
3452   G1STWRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _pss, _queues, &amp;terminator);
3453 
3454   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
3455 }
3456 
3457 // End of weak reference support closures
3458 
3459 void G1CollectedHeap::process_discovered_references(G1ParScanThreadStateSet* per_thread_states) {
3460   double ref_proc_start = os::elapsedTime();
3461 
3462   ReferenceProcessor* rp = _ref_processor_stw;
3463   assert(rp-&gt;discovery_enabled(), &quot;should have been enabled&quot;);
3464 
3465   // Closure to test whether a referent is alive.
3466   G1STWIsAliveClosure is_alive(this);
3467 
3468   // Even when parallel reference processing is enabled, the processing
3469   // of JNI refs is serial and performed serially by the current thread
3470   // rather than by a worker. The following PSS will be used for processing
3471   // JNI refs.
3472 
3473   // Use only a single queue for this PSS.
3474   G1ParScanThreadState*          pss = per_thread_states-&gt;state_for_worker(0);
3475   pss-&gt;set_ref_discoverer(NULL);
3476   assert(pss-&gt;queue_is_empty(), &quot;pre-condition&quot;);
3477 
3478   // Keep alive closure.
3479   G1CopyingKeepAliveClosure keep_alive(this, pss);
3480 
3481   // Serial Complete GC closure
3482   G1STWDrainQueueClosure drain_queue(this, pss);
3483 
3484   // Setup the soft refs policy...
3485   rp-&gt;setup_policy(false);
3486 
3487   ReferenceProcessorPhaseTimes* pt = phase_times()-&gt;ref_phase_times();
3488 
3489   ReferenceProcessorStats stats;
3490   if (!rp-&gt;processing_is_mt()) {
3491     // Serial reference processing...
3492     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3493                                               &amp;keep_alive,
3494                                               &amp;drain_queue,
3495                                               NULL,
3496                                               pt);
3497   } else {
3498     uint no_of_gc_workers = workers()-&gt;active_workers();
3499 
3500     // Parallel reference processing
3501     assert(no_of_gc_workers &lt;= rp-&gt;max_num_queues(),
3502            &quot;Mismatch between the number of GC workers %u and the maximum number of Reference process queues %u&quot;,
3503            no_of_gc_workers,  rp-&gt;max_num_queues());
3504 
3505     G1STWRefProcTaskExecutor par_task_executor(this, per_thread_states, workers(), _task_queues);
3506     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3507                                               &amp;keep_alive,
3508                                               &amp;drain_queue,
3509                                               &amp;par_task_executor,
3510                                               pt);
3511   }
3512 
3513   _gc_tracer_stw-&gt;report_gc_reference_stats(stats);
3514 
3515   // We have completed copying any necessary live referent objects.
3516   assert(pss-&gt;queue_is_empty(), &quot;both queue and overflow should be empty&quot;);
3517 
3518   make_pending_list_reachable();
3519 
3520   assert(!rp-&gt;discovery_enabled(), &quot;Postcondition&quot;);
3521   rp-&gt;verify_no_references_recorded();
3522 
3523   double ref_proc_time = os::elapsedTime() - ref_proc_start;
3524   phase_times()-&gt;record_ref_proc_time(ref_proc_time * 1000.0);
3525 }
3526 
3527 void G1CollectedHeap::make_pending_list_reachable() {
3528   if (collector_state()-&gt;in_concurrent_start_gc()) {
3529     oop pll_head = Universe::reference_pending_list();
3530     if (pll_head != NULL) {
3531       // Any valid worker id is fine here as we are in the VM thread and single-threaded.
3532       _cm-&gt;mark_in_next_bitmap(0 /* worker_id */, pll_head);
3533     }
3534   }
3535 }
3536 
3537 void G1CollectedHeap::merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states) {
3538   Ticks start = Ticks::now();
3539   per_thread_states-&gt;flush();
3540   phase_times()-&gt;record_or_add_time_secs(G1GCPhaseTimes::MergePSS, 0 /* worker_id */, (Ticks::now() - start).seconds());
3541 }
3542 
3543 class G1PrepareEvacuationTask : public AbstractGangTask {
3544   class G1PrepareRegionsClosure : public HeapRegionClosure {
3545     G1CollectedHeap* _g1h;
3546     G1PrepareEvacuationTask* _parent_task;
3547     size_t _worker_humongous_total;
3548     size_t _worker_humongous_candidates;
3549 
3550     bool humongous_region_is_candidate(HeapRegion* region) const {
3551       assert(region-&gt;is_starts_humongous(), &quot;Must start a humongous object&quot;);
3552 
3553       oop obj = oop(region-&gt;bottom());
3554 
3555       // Dead objects cannot be eager reclaim candidates. Due to class
3556       // unloading it is unsafe to query their classes so we return early.
3557       if (_g1h-&gt;is_obj_dead(obj, region)) {
3558         return false;
3559       }
3560 
3561       // If we do not have a complete remembered set for the region, then we can
3562       // not be sure that we have all references to it.
3563       if (!region-&gt;rem_set()-&gt;is_complete()) {
3564         return false;
3565       }
3566       // Candidate selection must satisfy the following constraints
3567       // while concurrent marking is in progress:
3568       //
3569       // * In order to maintain SATB invariants, an object must not be
3570       // reclaimed if it was allocated before the start of marking and
3571       // has not had its references scanned.  Such an object must have
3572       // its references (including type metadata) scanned to ensure no
3573       // live objects are missed by the marking process.  Objects
3574       // allocated after the start of concurrent marking don&#39;t need to
3575       // be scanned.
3576       //
3577       // * An object must not be reclaimed if it is on the concurrent
3578       // mark stack.  Objects allocated after the start of concurrent
3579       // marking are never pushed on the mark stack.
3580       //
3581       // Nominating only objects allocated after the start of concurrent
3582       // marking is sufficient to meet both constraints.  This may miss
3583       // some objects that satisfy the constraints, but the marking data
3584       // structures don&#39;t support efficiently performing the needed
3585       // additional tests or scrubbing of the mark stack.
3586       //
3587       // However, we presently only nominate is_typeArray() objects.
3588       // A humongous object containing references induces remembered
3589       // set entries on other regions.  In order to reclaim such an
3590       // object, those remembered sets would need to be cleaned up.
3591       //
3592       // We also treat is_typeArray() objects specially, allowing them
3593       // to be reclaimed even if allocated before the start of
3594       // concurrent mark.  For this we rely on mark stack insertion to
3595       // exclude is_typeArray() objects, preventing reclaiming an object
3596       // that is in the mark stack.  We also rely on the metadata for
3597       // such objects to be built-in and so ensured to be kept live.
3598       // Frequent allocation and drop of large binary blobs is an
3599       // important use case for eager reclaim, and this special handling
3600       // may reduce needed headroom.
3601 
3602       return obj-&gt;is_typeArray() &amp;&amp;
3603              _g1h-&gt;is_potential_eager_reclaim_candidate(region);
3604     }
3605 
3606   public:
3607     G1PrepareRegionsClosure(G1CollectedHeap* g1h, G1PrepareEvacuationTask* parent_task) :
3608       _g1h(g1h),
3609       _parent_task(parent_task),
3610       _worker_humongous_total(0),
3611       _worker_humongous_candidates(0) { }
3612 
3613     ~G1PrepareRegionsClosure() {
3614       _parent_task-&gt;add_humongous_candidates(_worker_humongous_candidates);
3615       _parent_task-&gt;add_humongous_total(_worker_humongous_total);
3616     }
3617 
3618     virtual bool do_heap_region(HeapRegion* hr) {
3619       // First prepare the region for scanning
3620       _g1h-&gt;rem_set()-&gt;prepare_region_for_scan(hr);
3621 
3622       // Now check if region is a humongous candidate
3623       if (!hr-&gt;is_starts_humongous()) {
3624         _g1h-&gt;register_region_with_region_attr(hr);
3625         return false;
3626       }
3627 
3628       uint index = hr-&gt;hrm_index();
3629       if (humongous_region_is_candidate(hr)) {
3630         _g1h-&gt;set_humongous_reclaim_candidate(index, true);
3631         _g1h-&gt;register_humongous_region_with_region_attr(index);
3632         _worker_humongous_candidates++;
3633         // We will later handle the remembered sets of these regions.
3634       } else {
3635         _g1h-&gt;set_humongous_reclaim_candidate(index, false);
3636         _g1h-&gt;register_region_with_region_attr(hr);
3637       }
3638       _worker_humongous_total++;
3639 
3640       return false;
3641     }
3642   };
3643 
3644   G1CollectedHeap* _g1h;
3645   HeapRegionClaimer _claimer;
3646   volatile size_t _humongous_total;
3647   volatile size_t _humongous_candidates;
3648 public:
3649   G1PrepareEvacuationTask(G1CollectedHeap* g1h) :
3650     AbstractGangTask(&quot;Prepare Evacuation&quot;),
3651     _g1h(g1h),
3652     _claimer(_g1h-&gt;workers()-&gt;active_workers()),
3653     _humongous_total(0),
3654     _humongous_candidates(0) { }
3655 
3656   ~G1PrepareEvacuationTask() {
3657     _g1h-&gt;set_has_humongous_reclaim_candidate(_humongous_candidates &gt; 0);
3658   }
3659 
3660   void work(uint worker_id) {
3661     G1PrepareRegionsClosure cl(_g1h, this);
3662     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;cl, &amp;_claimer, worker_id);
3663   }
3664 
3665   void add_humongous_candidates(size_t candidates) {
3666     Atomic::add(&amp;_humongous_candidates, candidates);
3667   }
3668 
3669   void add_humongous_total(size_t total) {
3670     Atomic::add(&amp;_humongous_total, total);
3671   }
3672 
3673   size_t humongous_candidates() {
3674     return _humongous_candidates;
3675   }
3676 
3677   size_t humongous_total() {
3678     return _humongous_total;
3679   }
3680 };
3681 
3682 void G1CollectedHeap::pre_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* per_thread_states) {
3683   _bytes_used_during_gc = 0;
3684 
3685   _expand_heap_after_alloc_failure = true;
3686   _evacuation_failed = false;
3687 
3688   // Disable the hot card cache.
3689   _hot_card_cache-&gt;reset_hot_cache_claimed_index();
3690   _hot_card_cache-&gt;set_use_cache(false);
3691 
3692   // Initialize the GC alloc regions.
3693   _allocator-&gt;init_gc_alloc_regions(evacuation_info);
3694 
3695   {
3696     Ticks start = Ticks::now();
3697     rem_set()-&gt;prepare_for_scan_heap_roots();
3698     phase_times()-&gt;record_prepare_heap_roots_time_ms((Ticks::now() - start).seconds() * 1000.0);
3699   }
3700 
3701   {
3702     G1PrepareEvacuationTask g1_prep_task(this);
3703     Tickspan task_time = run_task(&amp;g1_prep_task);
3704 
3705     phase_times()-&gt;record_register_regions(task_time.seconds() * 1000.0,
3706                                            g1_prep_task.humongous_total(),
3707                                            g1_prep_task.humongous_candidates());
3708   }
3709 
3710   assert(_verifier-&gt;check_region_attr_table(), &quot;Inconsistency in the region attributes table.&quot;);
3711   _preserved_marks_set.assert_empty();
3712 
3713 #if COMPILER2_OR_JVMCI
3714   DerivedPointerTable::clear();
3715 #endif
3716 
3717   // Concurrent start needs claim bits to keep track of the marked-through CLDs.
3718   if (collector_state()-&gt;in_concurrent_start_gc()) {
3719     concurrent_mark()-&gt;pre_concurrent_start();
3720 
3721     double start_clear_claimed_marks = os::elapsedTime();
3722 
3723     ClassLoaderDataGraph::clear_claimed_marks();
3724 
3725     double recorded_clear_claimed_marks_time_ms = (os::elapsedTime() - start_clear_claimed_marks) * 1000.0;
3726     phase_times()-&gt;record_clear_claimed_marks_time_ms(recorded_clear_claimed_marks_time_ms);
3727   }
3728 
3729   // Should G1EvacuationFailureALot be in effect for this GC?
3730   NOT_PRODUCT(set_evacuation_failure_alot_for_current_gc();)
3731 }
3732 
3733 class G1EvacuateRegionsBaseTask : public AbstractGangTask {
3734 protected:
3735   G1CollectedHeap* _g1h;
3736   G1ParScanThreadStateSet* _per_thread_states;
3737   G1ScannerTasksQueueSet* _task_queues;
3738   TaskTerminator _terminator;
3739   uint _num_workers;
3740 
3741   void evacuate_live_objects(G1ParScanThreadState* pss,
3742                              uint worker_id,
3743                              G1GCPhaseTimes::GCParPhases objcopy_phase,
3744                              G1GCPhaseTimes::GCParPhases termination_phase) {
3745     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3746 
3747     Ticks start = Ticks::now();
3748     G1ParEvacuateFollowersClosure cl(_g1h, pss, _task_queues, &amp;_terminator, objcopy_phase);
3749     cl.do_void();
3750 
3751     assert(pss-&gt;queue_is_empty(), &quot;should be empty&quot;);
3752 
3753     Tickspan evac_time = (Ticks::now() - start);
3754     p-&gt;record_or_add_time_secs(objcopy_phase, worker_id, evac_time.seconds() - cl.term_time());
3755 
3756     if (termination_phase == G1GCPhaseTimes::Termination) {
3757       p-&gt;record_time_secs(termination_phase, worker_id, cl.term_time());
3758       p-&gt;record_thread_work_item(termination_phase, worker_id, cl.term_attempts());
3759     } else {
3760       p-&gt;record_or_add_time_secs(termination_phase, worker_id, cl.term_time());
3761       p-&gt;record_or_add_thread_work_item(termination_phase, worker_id, cl.term_attempts());
3762     }
3763     assert(pss-&gt;trim_ticks().seconds() == 0.0, &quot;Unexpected partial trimming during evacuation&quot;);
3764   }
3765 
3766   virtual void start_work(uint worker_id) { }
3767 
3768   virtual void end_work(uint worker_id) { }
3769 
3770   virtual void scan_roots(G1ParScanThreadState* pss, uint worker_id) = 0;
3771 
3772   virtual void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) = 0;
3773 
3774 public:
3775   G1EvacuateRegionsBaseTask(const char* name,
3776                             G1ParScanThreadStateSet* per_thread_states,
3777                             G1ScannerTasksQueueSet* task_queues,
3778                             uint num_workers) :
3779     AbstractGangTask(name),
3780     _g1h(G1CollectedHeap::heap()),
3781     _per_thread_states(per_thread_states),
3782     _task_queues(task_queues),
3783     _terminator(num_workers, _task_queues),
3784     _num_workers(num_workers)
3785   { }
3786 
3787   void work(uint worker_id) {
3788     start_work(worker_id);
3789 
3790     {
3791       ResourceMark rm;
3792       HandleMark   hm;
3793 
3794       G1ParScanThreadState* pss = _per_thread_states-&gt;state_for_worker(worker_id);
3795       pss-&gt;set_ref_discoverer(_g1h-&gt;ref_processor_stw());
3796 
3797       scan_roots(pss, worker_id);
3798       evacuate_live_objects(pss, worker_id);
3799     }
3800 
3801     end_work(worker_id);
3802   }
3803 };
3804 
3805 class G1EvacuateRegionsTask : public G1EvacuateRegionsBaseTask {
3806   G1RootProcessor* _root_processor;
3807 
3808   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3809     _root_processor-&gt;evacuate_roots(pss, worker_id);
3810     _g1h-&gt;rem_set()-&gt;scan_heap_roots(pss, worker_id, G1GCPhaseTimes::ScanHR, G1GCPhaseTimes::ObjCopy);
3811     _g1h-&gt;rem_set()-&gt;scan_collection_set_regions(pss, worker_id, G1GCPhaseTimes::ScanHR, G1GCPhaseTimes::CodeRoots, G1GCPhaseTimes::ObjCopy);
3812   }
3813 
3814   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3815     G1EvacuateRegionsBaseTask::evacuate_live_objects(pss, worker_id, G1GCPhaseTimes::ObjCopy, G1GCPhaseTimes::Termination);
3816   }
3817 
3818   void start_work(uint worker_id) {
3819     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerStart, worker_id, Ticks::now().seconds());
3820   }
3821 
3822   void end_work(uint worker_id) {
3823     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerEnd, worker_id, Ticks::now().seconds());
3824   }
3825 
3826 public:
3827   G1EvacuateRegionsTask(G1CollectedHeap* g1h,
3828                         G1ParScanThreadStateSet* per_thread_states,
3829                         G1ScannerTasksQueueSet* task_queues,
3830                         G1RootProcessor* root_processor,
3831                         uint num_workers) :
3832     G1EvacuateRegionsBaseTask(&quot;G1 Evacuate Regions&quot;, per_thread_states, task_queues, num_workers),
3833     _root_processor(root_processor)
3834   { }
3835 };
3836 
3837 void G1CollectedHeap::evacuate_initial_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3838   G1GCPhaseTimes* p = phase_times();
3839 
3840   {
3841     Ticks start = Ticks::now();
3842     rem_set()-&gt;merge_heap_roots(true /* initial_evacuation */);
3843     p-&gt;record_merge_heap_roots_time((Ticks::now() - start).seconds() * 1000.0);
3844   }
3845 
3846   Tickspan task_time;
3847   const uint num_workers = workers()-&gt;active_workers();
3848 
3849   Ticks start_processing = Ticks::now();
3850   {
3851     G1RootProcessor root_processor(this, num_workers);
3852     G1EvacuateRegionsTask g1_par_task(this, per_thread_states, _task_queues, &amp;root_processor, num_workers);
3853     task_time = run_task(&amp;g1_par_task);
3854     // Closing the inner scope will execute the destructor for the G1RootProcessor object.
3855     // To extract its code root fixup time we measure total time of this scope and
3856     // subtract from the time the WorkGang task took.
3857   }
3858   Tickspan total_processing = Ticks::now() - start_processing;
3859 
3860   p-&gt;record_initial_evac_time(task_time.seconds() * 1000.0);
3861   p-&gt;record_or_add_code_root_fixup_time((total_processing - task_time).seconds() * 1000.0);
3862 }
3863 
3864 class G1EvacuateOptionalRegionsTask : public G1EvacuateRegionsBaseTask {
3865 
3866   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3867     _g1h-&gt;rem_set()-&gt;scan_heap_roots(pss, worker_id, G1GCPhaseTimes::OptScanHR, G1GCPhaseTimes::OptObjCopy);
3868     _g1h-&gt;rem_set()-&gt;scan_collection_set_regions(pss, worker_id, G1GCPhaseTimes::OptScanHR, G1GCPhaseTimes::OptCodeRoots, G1GCPhaseTimes::OptObjCopy);
3869   }
3870 
3871   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3872     G1EvacuateRegionsBaseTask::evacuate_live_objects(pss, worker_id, G1GCPhaseTimes::OptObjCopy, G1GCPhaseTimes::OptTermination);
3873   }
3874 
3875 public:
3876   G1EvacuateOptionalRegionsTask(G1ParScanThreadStateSet* per_thread_states,
3877                                 G1ScannerTasksQueueSet* queues,
3878                                 uint num_workers) :
3879     G1EvacuateRegionsBaseTask(&quot;G1 Evacuate Optional Regions&quot;, per_thread_states, queues, num_workers) {
3880   }
3881 };
3882 
3883 void G1CollectedHeap::evacuate_next_optional_regions(G1ParScanThreadStateSet* per_thread_states) {
3884   class G1MarkScope : public MarkScope { };
3885 
3886   Tickspan task_time;
3887 
3888   Ticks start_processing = Ticks::now();
3889   {
3890     G1MarkScope code_mark_scope;
3891     G1EvacuateOptionalRegionsTask task(per_thread_states, _task_queues, workers()-&gt;active_workers());
3892     task_time = run_task(&amp;task);
3893     // See comment in evacuate_collection_set() for the reason of the scope.
3894   }
3895   Tickspan total_processing = Ticks::now() - start_processing;
3896 
3897   G1GCPhaseTimes* p = phase_times();
3898   p-&gt;record_or_add_code_root_fixup_time((total_processing - task_time).seconds() * 1000.0);
3899 }
3900 
3901 void G1CollectedHeap::evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3902   const double gc_start_time_ms = phase_times()-&gt;cur_collection_start_sec() * 1000.0;
3903 
3904   while (!evacuation_failed() &amp;&amp; _collection_set.optional_region_length() &gt; 0) {
3905 
3906     double time_used_ms = os::elapsedTime() * 1000.0 - gc_start_time_ms;
3907     double time_left_ms = MaxGCPauseMillis - time_used_ms;
3908 
3909     if (time_left_ms &lt; 0 ||
3910         !_collection_set.finalize_optional_for_evacuation(time_left_ms * policy()-&gt;optional_evacuation_fraction())) {
3911       log_trace(gc, ergo, cset)(&quot;Skipping evacuation of %u optional regions, no more regions can be evacuated in %.3fms&quot;,
3912                                 _collection_set.optional_region_length(), time_left_ms);
3913       break;
3914     }
3915 
3916     {
3917       Ticks start = Ticks::now();
3918       rem_set()-&gt;merge_heap_roots(false /* initial_evacuation */);
3919       phase_times()-&gt;record_or_add_optional_merge_heap_roots_time((Ticks::now() - start).seconds() * 1000.0);
3920     }
3921 
3922     {
3923       Ticks start = Ticks::now();
3924       evacuate_next_optional_regions(per_thread_states);
3925       phase_times()-&gt;record_or_add_optional_evac_time((Ticks::now() - start).seconds() * 1000.0);
3926     }
3927   }
3928 
3929   _collection_set.abandon_optional_collection_set(per_thread_states);
3930 }
3931 
3932 void G1CollectedHeap::post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info,
3933                                                    G1RedirtyCardsQueueSet* rdcqs,
3934                                                    G1ParScanThreadStateSet* per_thread_states) {
3935   G1GCPhaseTimes* p = phase_times();
3936 
3937   rem_set()-&gt;cleanup_after_scan_heap_roots();
3938 
3939   // Process any discovered reference objects - we have
3940   // to do this _before_ we retire the GC alloc regions
3941   // as we may have to copy some &#39;reachable&#39; referent
3942   // objects (and their reachable sub-graphs) that were
3943   // not copied during the pause.
3944   process_discovered_references(per_thread_states);
3945 
3946   G1STWIsAliveClosure is_alive(this);
3947   G1KeepAliveClosure keep_alive(this);
3948 
3949   WeakProcessor::weak_oops_do(workers(), &amp;is_alive, &amp;keep_alive, p-&gt;weak_phase_times());
3950 
3951   if (G1StringDedup::is_enabled()) {
3952     double string_dedup_time_ms = os::elapsedTime();
3953 
3954     string_dedup_cleaning(&amp;is_alive, &amp;keep_alive, p);
3955 
3956     double string_cleanup_time_ms = (os::elapsedTime() - string_dedup_time_ms) * 1000.0;
3957     p-&gt;record_string_deduplication_time(string_cleanup_time_ms);
3958   }
3959 
3960   _allocator-&gt;release_gc_alloc_regions(evacuation_info);
3961 
3962   if (evacuation_failed()) {
3963     restore_after_evac_failure(rdcqs);
3964 
3965     // Reset the G1EvacuationFailureALot counters and flags
3966     NOT_PRODUCT(reset_evacuation_should_fail();)
3967 
3968     double recalculate_used_start = os::elapsedTime();
3969     set_used(recalculate_used());
3970     p-&gt;record_evac_fail_recalc_used_time((os::elapsedTime() - recalculate_used_start) * 1000.0);
3971 
3972     if (_archive_allocator != NULL) {
3973       _archive_allocator-&gt;clear_used();
3974     }
3975     for (uint i = 0; i &lt; ParallelGCThreads; i++) {
3976       if (_evacuation_failed_info_array[i].has_failed()) {
3977         _gc_tracer_stw-&gt;report_evacuation_failed(_evacuation_failed_info_array[i]);
3978       }
3979     }
3980   } else {
3981     // The &quot;used&quot; of the the collection set have already been subtracted
3982     // when they were freed.  Add in the bytes used.
3983     increase_used(_bytes_used_during_gc);
3984   }
3985 
3986   _preserved_marks_set.assert_empty();
3987 
3988   merge_per_thread_state_info(per_thread_states);
3989 
3990   // Reset and re-enable the hot card cache.
3991   // Note the counts for the cards in the regions in the
3992   // collection set are reset when the collection set is freed.
3993   _hot_card_cache-&gt;reset_hot_cache();
3994   _hot_card_cache-&gt;set_use_cache(true);
3995 
3996   purge_code_root_memory();
3997 
3998   redirty_logged_cards(rdcqs);
3999 
4000   free_collection_set(&amp;_collection_set, evacuation_info, per_thread_states-&gt;surviving_young_words());
4001 
4002   eagerly_reclaim_humongous_regions();
4003 
4004   record_obj_copy_mem_stats();
4005 
4006   evacuation_info.set_collectionset_used_before(collection_set()-&gt;bytes_used_before());
4007   evacuation_info.set_bytes_used(_bytes_used_during_gc);
4008 
4009 #if COMPILER2_OR_JVMCI
4010   double start = os::elapsedTime();
4011   DerivedPointerTable::update_pointers();
4012   phase_times()-&gt;record_derived_pointer_table_update_time((os::elapsedTime() - start) * 1000.0);
4013 #endif
4014   policy()-&gt;print_age_table();
4015 }
4016 
4017 void G1CollectedHeap::record_obj_copy_mem_stats() {
4018   policy()-&gt;old_gen_alloc_tracker()-&gt;
4019     add_allocated_bytes_since_last_gc(_old_evac_stats.allocated() * HeapWordSize);
4020 
4021   _gc_tracer_stw-&gt;report_evacuation_statistics(create_g1_evac_summary(&amp;_survivor_evac_stats),
4022                                                create_g1_evac_summary(&amp;_old_evac_stats));
4023 }
4024 
4025 void G1CollectedHeap::free_region(HeapRegion* hr, FreeRegionList* free_list) {
4026   assert(!hr-&gt;is_free(), &quot;the region should not be free&quot;);
4027   assert(!hr-&gt;is_empty(), &quot;the region should not be empty&quot;);
4028   assert(_hrm-&gt;is_available(hr-&gt;hrm_index()), &quot;region should be committed&quot;);
4029 
4030   if (G1VerifyBitmaps) {
4031     MemRegion mr(hr-&gt;bottom(), hr-&gt;end());
4032     concurrent_mark()-&gt;clear_range_in_prev_bitmap(mr);
4033   }
4034 
4035   // Clear the card counts for this region.
4036   // Note: we only need to do this if the region is not young
4037   // (since we don&#39;t refine cards in young regions).
4038   if (!hr-&gt;is_young()) {
4039     _hot_card_cache-&gt;reset_card_counts(hr);
4040   }
4041 
4042   // Reset region metadata to allow reuse.
4043   hr-&gt;hr_clear(true /* clear_space */);
4044   _policy-&gt;remset_tracker()-&gt;update_at_free(hr);
4045 
4046   if (free_list != NULL) {
4047     free_list-&gt;add_ordered(hr);
4048   }
4049 }
4050 
4051 void G1CollectedHeap::free_humongous_region(HeapRegion* hr,
4052                                             FreeRegionList* free_list) {
4053   assert(hr-&gt;is_humongous(), &quot;this is only for humongous regions&quot;);
4054   assert(free_list != NULL, &quot;pre-condition&quot;);
4055   hr-&gt;clear_humongous();
4056   free_region(hr, free_list);
4057 }
4058 
4059 void G1CollectedHeap::remove_from_old_sets(const uint old_regions_removed,
4060                                            const uint humongous_regions_removed) {
4061   if (old_regions_removed &gt; 0 || humongous_regions_removed &gt; 0) {
4062     MutexLocker x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4063     _old_set.bulk_remove(old_regions_removed);
4064     _humongous_set.bulk_remove(humongous_regions_removed);
4065   }
4066 
4067 }
4068 
4069 void G1CollectedHeap::prepend_to_freelist(FreeRegionList* list) {
4070   assert(list != NULL, &quot;list can&#39;t be null&quot;);
4071   if (!list-&gt;is_empty()) {
4072     MutexLocker x(FreeList_lock, Mutex::_no_safepoint_check_flag);
4073     _hrm-&gt;insert_list_into_free_list(list);
4074   }
4075 }
4076 
4077 void G1CollectedHeap::decrement_summary_bytes(size_t bytes) {
4078   decrease_used(bytes);
4079 }
4080 
4081 class G1FreeCollectionSetTask : public AbstractGangTask {
4082   // Helper class to keep statistics for the collection set freeing
4083   class FreeCSetStats {
4084     size_t _before_used_bytes;   // Usage in regions successfully evacutate
4085     size_t _after_used_bytes;    // Usage in regions failing evacuation
4086     size_t _bytes_allocated_in_old_since_last_gc; // Size of young regions turned into old
4087     size_t _failure_used_words;  // Live size in failed regions
4088     size_t _failure_waste_words; // Wasted size in failed regions
4089     size_t _rs_length;           // Remembered set size
4090     uint _regions_freed;         // Number of regions freed
4091   public:
4092     FreeCSetStats() :
4093         _before_used_bytes(0),
4094         _after_used_bytes(0),
4095         _bytes_allocated_in_old_since_last_gc(0),
4096         _failure_used_words(0),
4097         _failure_waste_words(0),
4098         _rs_length(0),
4099         _regions_freed(0) { }
4100 
4101     void merge_stats(FreeCSetStats* other) {
4102       assert(other != NULL, &quot;invariant&quot;);
4103       _before_used_bytes += other-&gt;_before_used_bytes;
4104       _after_used_bytes += other-&gt;_after_used_bytes;
4105       _bytes_allocated_in_old_since_last_gc += other-&gt;_bytes_allocated_in_old_since_last_gc;
4106       _failure_used_words += other-&gt;_failure_used_words;
4107       _failure_waste_words += other-&gt;_failure_waste_words;
4108       _rs_length += other-&gt;_rs_length;
4109       _regions_freed += other-&gt;_regions_freed;
4110     }
4111 
4112     void report(G1CollectedHeap* g1h, G1EvacuationInfo* evacuation_info) {
4113       evacuation_info-&gt;set_regions_freed(_regions_freed);
4114       evacuation_info-&gt;increment_collectionset_used_after(_after_used_bytes);
4115 
4116       g1h-&gt;decrement_summary_bytes(_before_used_bytes);
4117       g1h-&gt;alloc_buffer_stats(G1HeapRegionAttr::Old)-&gt;add_failure_used_and_waste(_failure_used_words, _failure_waste_words);
4118 
4119       G1Policy *policy = g1h-&gt;policy();
4120       policy-&gt;old_gen_alloc_tracker()-&gt;add_allocated_bytes_since_last_gc(_bytes_allocated_in_old_since_last_gc);
4121       policy-&gt;record_rs_length(_rs_length);
4122       policy-&gt;cset_regions_freed();
4123     }
4124 
4125     void account_failed_region(HeapRegion* r) {
4126       size_t used_words = r-&gt;marked_bytes() / HeapWordSize;
4127       _failure_used_words += used_words;
4128       _failure_waste_words += HeapRegion::GrainWords - used_words;
4129       _after_used_bytes += r-&gt;used();
4130 
4131       // When moving a young gen region to old gen, we &quot;allocate&quot; that whole
4132       // region there. This is in addition to any already evacuated objects.
4133       // Notify the policy about that. Old gen regions do not cause an
4134       // additional allocation: both the objects still in the region and the
4135       // ones already moved are accounted for elsewhere.
4136       if (r-&gt;is_young()) {
4137         _bytes_allocated_in_old_since_last_gc += HeapRegion::GrainBytes;
4138       }
4139     }
4140 
4141     void account_evacuated_region(HeapRegion* r) {
4142       _before_used_bytes += r-&gt;used();
4143       _regions_freed += 1;
4144     }
4145 
4146     void account_rs_length(HeapRegion* r) {
4147       _rs_length += r-&gt;rem_set()-&gt;occupied();
4148     }
4149   };
4150 
4151   // Closure applied to all regions in the collection set.
4152   class FreeCSetClosure : public HeapRegionClosure {
4153     // Helper to send JFR events for regions.
4154     class JFREventForRegion {
4155       EventGCPhaseParallel _event;
4156     public:
4157       JFREventForRegion(HeapRegion* region, uint worker_id) : _event() {
4158         _event.set_gcId(GCId::current());
4159         _event.set_gcWorkerId(worker_id);
4160         if (region-&gt;is_young()) {
4161           _event.set_name(G1GCPhaseTimes::phase_name(G1GCPhaseTimes::YoungFreeCSet));
4162         } else {
4163           _event.set_name(G1GCPhaseTimes::phase_name(G1GCPhaseTimes::NonYoungFreeCSet));
4164         }
4165       }
4166 
4167       ~JFREventForRegion() {
4168         _event.commit();
4169       }
4170     };
4171 
4172     // Helper to do timing for region work.
4173     class TimerForRegion {
4174       Tickspan&amp; _time;
4175       Ticks     _start_time;
4176     public:
4177       TimerForRegion(Tickspan&amp; time) : _time(time), _start_time(Ticks::now()) { }
4178       ~TimerForRegion() {
4179         _time += Ticks::now() - _start_time;
4180       }
4181     };
4182 
4183     // FreeCSetClosure members
4184     G1CollectedHeap* _g1h;
4185     const size_t*    _surviving_young_words;
4186     uint             _worker_id;
4187     Tickspan         _young_time;
4188     Tickspan         _non_young_time;
4189     FreeCSetStats*   _stats;
4190 
4191     void assert_in_cset(HeapRegion* r) {
4192       assert(r-&gt;young_index_in_cset() != 0 &amp;&amp;
4193              (uint)r-&gt;young_index_in_cset() &lt;= _g1h-&gt;collection_set()-&gt;young_region_length(),
4194              &quot;Young index %u is wrong for region %u of type %s with %u young regions&quot;,
4195              r-&gt;young_index_in_cset(), r-&gt;hrm_index(), r-&gt;get_type_str(), _g1h-&gt;collection_set()-&gt;young_region_length());
4196     }
4197 
4198     void handle_evacuated_region(HeapRegion* r) {
4199       assert(!r-&gt;is_empty(), &quot;Region %u is an empty region in the collection set.&quot;, r-&gt;hrm_index());
4200       stats()-&gt;account_evacuated_region(r);
4201 
4202       // Free the region and and its remembered set.
4203       _g1h-&gt;free_region(r, NULL);
4204     }
4205 
4206     void handle_failed_region(HeapRegion* r) {
4207       // Do some allocation statistics accounting. Regions that failed evacuation
4208       // are always made old, so there is no need to update anything in the young
4209       // gen statistics, but we need to update old gen statistics.
4210       stats()-&gt;account_failed_region(r);
4211 
4212       // Update the region state due to the failed evacuation.
4213       r-&gt;handle_evacuation_failure();
4214 
4215       // Add region to old set, need to hold lock.
4216       MutexLocker x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4217       _g1h-&gt;old_set_add(r);
4218     }
4219 
4220     Tickspan&amp; timer_for_region(HeapRegion* r) {
4221       return r-&gt;is_young() ? _young_time : _non_young_time;
4222     }
4223 
4224     FreeCSetStats* stats() {
4225       return _stats;
4226     }
4227   public:
4228     FreeCSetClosure(const size_t* surviving_young_words,
4229                     uint worker_id,
4230                     FreeCSetStats* stats) :
4231         HeapRegionClosure(),
4232         _g1h(G1CollectedHeap::heap()),
4233         _surviving_young_words(surviving_young_words),
4234         _worker_id(worker_id),
4235         _young_time(),
4236         _non_young_time(),
4237         _stats(stats) { }
4238 
4239     virtual bool do_heap_region(HeapRegion* r) {
4240       assert(r-&gt;in_collection_set(), &quot;Invariant: %u missing from CSet&quot;, r-&gt;hrm_index());
4241       JFREventForRegion event(r, _worker_id);
4242       TimerForRegion timer(timer_for_region(r));
4243 
4244       _g1h-&gt;clear_region_attr(r);
4245       stats()-&gt;account_rs_length(r);
4246 
4247       if (r-&gt;is_young()) {
4248         assert_in_cset(r);
4249         r-&gt;record_surv_words_in_group(_surviving_young_words[r-&gt;young_index_in_cset()]);
4250       }
4251 
4252       if (r-&gt;evacuation_failed()) {
4253         handle_failed_region(r);
4254       } else {
4255         handle_evacuated_region(r);
4256       }
4257       assert(!_g1h-&gt;is_on_master_free_list(r), &quot;sanity&quot;);
4258 
4259       return false;
4260     }
4261 
4262     void report_timing(Tickspan parallel_time) {
4263       G1GCPhaseTimes* pt = _g1h-&gt;phase_times();
4264       pt-&gt;record_time_secs(G1GCPhaseTimes::ParFreeCSet, _worker_id, parallel_time.seconds());
4265       if (_young_time.value() &gt; 0) {
4266         pt-&gt;record_time_secs(G1GCPhaseTimes::YoungFreeCSet, _worker_id, _young_time.seconds());
4267       }
4268       if (_non_young_time.value() &gt; 0) {
4269         pt-&gt;record_time_secs(G1GCPhaseTimes::NonYoungFreeCSet, _worker_id, _non_young_time.seconds());
4270       }
4271     }
4272   };
4273 
4274   // G1FreeCollectionSetTask members
4275   G1CollectedHeap*  _g1h;
4276   G1EvacuationInfo* _evacuation_info;
4277   FreeCSetStats*    _worker_stats;
4278   HeapRegionClaimer _claimer;
4279   const size_t*     _surviving_young_words;
4280   uint              _active_workers;
4281 
4282   FreeCSetStats* worker_stats(uint worker) {
4283     return &amp;_worker_stats[worker];
4284   }
4285 
4286   void report_statistics() {
4287     // Merge the accounting
4288     FreeCSetStats total_stats;
4289     for (uint worker = 0; worker &lt; _active_workers; worker++) {
4290       total_stats.merge_stats(worker_stats(worker));
4291     }
4292     total_stats.report(_g1h, _evacuation_info);
4293   }
4294 
4295 public:
4296   G1FreeCollectionSetTask(G1EvacuationInfo* evacuation_info, const size_t* surviving_young_words, uint active_workers) :
4297       AbstractGangTask(&quot;G1 Free Collection Set&quot;),
4298       _g1h(G1CollectedHeap::heap()),
4299       _evacuation_info(evacuation_info),
4300       _worker_stats(NEW_C_HEAP_ARRAY(FreeCSetStats, active_workers, mtGC)),
4301       _claimer(active_workers),
4302       _surviving_young_words(surviving_young_words),
4303       _active_workers(active_workers) {
4304     for (uint worker = 0; worker &lt; active_workers; worker++) {
4305       ::new (&amp;_worker_stats[worker]) FreeCSetStats();
4306     }
4307   }
4308 
4309   ~G1FreeCollectionSetTask() {
4310     Ticks serial_time = Ticks::now();
4311     report_statistics();
4312     for (uint worker = 0; worker &lt; _active_workers; worker++) {
4313       _worker_stats[worker].~FreeCSetStats();
4314     }
4315     FREE_C_HEAP_ARRAY(FreeCSetStats, _worker_stats);
4316     _g1h-&gt;phase_times()-&gt;record_serial_free_cset_time_ms((Ticks::now() - serial_time).seconds() * 1000.0);
4317   }
4318 
4319   virtual void work(uint worker_id) {
4320     EventGCPhaseParallel event;
4321     Ticks start = Ticks::now();
4322     FreeCSetClosure cl(_surviving_young_words, worker_id, worker_stats(worker_id));
4323     _g1h-&gt;collection_set_par_iterate_all(&amp;cl, &amp;_claimer, worker_id);
4324 
4325     // Report the total parallel time along with some more detailed metrics.
4326     cl.report_timing(Ticks::now() - start);
4327     event.commit(GCId::current(), worker_id, G1GCPhaseTimes::phase_name(G1GCPhaseTimes::ParFreeCSet));
4328   }
4329 };
4330 
4331 void G1CollectedHeap::free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words) {
4332   _eden.clear();
4333 
4334   // The free collections set is split up in two tasks, the first
4335   // frees the collection set and records what regions are free,
4336   // and the second one rebuilds the free list. This proved to be
4337   // more efficient than adding a sorted list to another.
4338 
4339   Ticks free_cset_start_time = Ticks::now();
4340   {
4341     uint const num_cs_regions = _collection_set.region_length();
4342     uint const num_workers = clamp(num_cs_regions, 1u, workers()-&gt;active_workers());
4343     G1FreeCollectionSetTask cl(&amp;evacuation_info, surviving_young_words, num_workers);
4344 
4345     log_debug(gc, ergo)(&quot;Running %s using %u workers for collection set length %u (%u)&quot;,
4346                         cl.name(), num_workers, num_cs_regions, num_regions());
4347     workers()-&gt;run_task(&amp;cl, num_workers);
4348   }
4349 
4350   Ticks free_cset_end_time = Ticks::now();
4351   phase_times()-&gt;record_total_free_cset_time_ms((free_cset_end_time - free_cset_start_time).seconds() * 1000.0);
4352 
4353   // Now rebuild the free region list.
4354   hrm()-&gt;rebuild_free_list(workers());
4355   phase_times()-&gt;record_total_rebuild_freelist_time_ms((Ticks::now() - free_cset_end_time).seconds() * 1000.0);
4356 
4357   collection_set-&gt;clear();
4358 }
4359 
4360 class G1FreeHumongousRegionClosure : public HeapRegionClosure {
4361  private:
4362   FreeRegionList* _free_region_list;
4363   HeapRegionSet* _proxy_set;
4364   uint _humongous_objects_reclaimed;
4365   uint _humongous_regions_reclaimed;
4366   size_t _freed_bytes;
4367  public:
4368 
4369   G1FreeHumongousRegionClosure(FreeRegionList* free_region_list) :
4370     _free_region_list(free_region_list), _proxy_set(NULL), _humongous_objects_reclaimed(0), _humongous_regions_reclaimed(0), _freed_bytes(0) {
4371   }
4372 
4373   virtual bool do_heap_region(HeapRegion* r) {
4374     if (!r-&gt;is_starts_humongous()) {
4375       return false;
4376     }
4377 
4378     G1CollectedHeap* g1h = G1CollectedHeap::heap();
4379 
4380     oop obj = (oop)r-&gt;bottom();
4381     G1CMBitMap* next_bitmap = g1h-&gt;concurrent_mark()-&gt;next_mark_bitmap();
4382 
4383     // The following checks whether the humongous object is live are sufficient.
4384     // The main additional check (in addition to having a reference from the roots
4385     // or the young gen) is whether the humongous object has a remembered set entry.
4386     //
4387     // A humongous object cannot be live if there is no remembered set for it
4388     // because:
4389     // - there can be no references from within humongous starts regions referencing
4390     // the object because we never allocate other objects into them.
4391     // (I.e. there are no intra-region references that may be missed by the
4392     // remembered set)
4393     // - as soon there is a remembered set entry to the humongous starts region
4394     // (i.e. it has &quot;escaped&quot; to an old object) this remembered set entry will stay
4395     // until the end of a concurrent mark.
4396     //
4397     // It is not required to check whether the object has been found dead by marking
4398     // or not, in fact it would prevent reclamation within a concurrent cycle, as
4399     // all objects allocated during that time are considered live.
4400     // SATB marking is even more conservative than the remembered set.
4401     // So if at this point in the collection there is no remembered set entry,
4402     // nobody has a reference to it.
4403     // At the start of collection we flush all refinement logs, and remembered sets
4404     // are completely up-to-date wrt to references to the humongous object.
4405     //
4406     // Other implementation considerations:
4407     // - never consider object arrays at this time because they would pose
4408     // considerable effort for cleaning up the the remembered sets. This is
4409     // required because stale remembered sets might reference locations that
4410     // are currently allocated into.
4411     uint region_idx = r-&gt;hrm_index();
4412     if (!g1h-&gt;is_humongous_reclaim_candidate(region_idx) ||
4413         !r-&gt;rem_set()-&gt;is_empty()) {
4414       log_debug(gc, humongous)(&quot;Live humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot;  with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4415                                region_idx,
4416                                (size_t)obj-&gt;size() * HeapWordSize,
4417                                p2i(r-&gt;bottom()),
4418                                r-&gt;rem_set()-&gt;occupied(),
4419                                r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4420                                next_bitmap-&gt;is_marked(r-&gt;bottom()),
4421                                g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4422                                obj-&gt;is_typeArray()
4423                               );
4424       return false;
4425     }
4426 
4427     guarantee(obj-&gt;is_typeArray(),
4428               &quot;Only eagerly reclaiming type arrays is supported, but the object &quot;
4429               PTR_FORMAT &quot; is not.&quot;, p2i(r-&gt;bottom()));
4430 
4431     log_debug(gc, humongous)(&quot;Dead humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot; with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4432                              region_idx,
4433                              (size_t)obj-&gt;size() * HeapWordSize,
4434                              p2i(r-&gt;bottom()),
4435                              r-&gt;rem_set()-&gt;occupied(),
4436                              r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4437                              next_bitmap-&gt;is_marked(r-&gt;bottom()),
4438                              g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4439                              obj-&gt;is_typeArray()
4440                             );
4441 
4442     G1ConcurrentMark* const cm = g1h-&gt;concurrent_mark();
4443     cm-&gt;humongous_object_eagerly_reclaimed(r);
4444     assert(!cm-&gt;is_marked_in_prev_bitmap(obj) &amp;&amp; !cm-&gt;is_marked_in_next_bitmap(obj),
4445            &quot;Eagerly reclaimed humongous region %u should not be marked at all but is in prev %s next %s&quot;,
4446            region_idx,
4447            BOOL_TO_STR(cm-&gt;is_marked_in_prev_bitmap(obj)),
4448            BOOL_TO_STR(cm-&gt;is_marked_in_next_bitmap(obj)));
4449     _humongous_objects_reclaimed++;
4450     do {
4451       HeapRegion* next = g1h-&gt;next_region_in_humongous(r);
4452       _freed_bytes += r-&gt;used();
4453       r-&gt;set_containing_set(NULL);
4454       _humongous_regions_reclaimed++;
4455       g1h-&gt;free_humongous_region(r, _free_region_list);
4456       r = next;
4457     } while (r != NULL);
4458 
4459     return false;
4460   }
4461 
4462   uint humongous_objects_reclaimed() {
4463     return _humongous_objects_reclaimed;
4464   }
4465 
4466   uint humongous_regions_reclaimed() {
4467     return _humongous_regions_reclaimed;
4468   }
4469 
4470   size_t bytes_freed() const {
4471     return _freed_bytes;
4472   }
4473 };
4474 
4475 void G1CollectedHeap::eagerly_reclaim_humongous_regions() {
4476   assert_at_safepoint_on_vm_thread();
4477 
4478   if (!G1EagerReclaimHumongousObjects ||
4479       (!_has_humongous_reclaim_candidates &amp;&amp; !log_is_enabled(Debug, gc, humongous))) {
4480     phase_times()-&gt;record_fast_reclaim_humongous_time_ms(0.0, 0);
4481     return;
4482   }
4483 
4484   double start_time = os::elapsedTime();
4485 
4486   FreeRegionList local_cleanup_list(&quot;Local Humongous Cleanup List&quot;);
4487 
4488   G1FreeHumongousRegionClosure cl(&amp;local_cleanup_list);
4489   heap_region_iterate(&amp;cl);
4490 
4491   remove_from_old_sets(0, cl.humongous_regions_reclaimed());
4492 
4493   G1HRPrinter* hrp = hr_printer();
4494   if (hrp-&gt;is_active()) {
4495     FreeRegionListIterator iter(&amp;local_cleanup_list);
4496     while (iter.more_available()) {
4497       HeapRegion* hr = iter.get_next();
4498       hrp-&gt;cleanup(hr);
4499     }
4500   }
4501 
4502   prepend_to_freelist(&amp;local_cleanup_list);
4503   decrement_summary_bytes(cl.bytes_freed());
4504 
4505   phase_times()-&gt;record_fast_reclaim_humongous_time_ms((os::elapsedTime() - start_time) * 1000.0,
4506                                                        cl.humongous_objects_reclaimed());
4507 }
4508 
4509 class G1AbandonCollectionSetClosure : public HeapRegionClosure {
4510 public:
4511   virtual bool do_heap_region(HeapRegion* r) {
4512     assert(r-&gt;in_collection_set(), &quot;Region %u must have been in collection set&quot;, r-&gt;hrm_index());
4513     G1CollectedHeap::heap()-&gt;clear_region_attr(r);
4514     r-&gt;clear_young_index_in_cset();
4515     return false;
4516   }
4517 };
4518 
4519 void G1CollectedHeap::abandon_collection_set(G1CollectionSet* collection_set) {
4520   G1AbandonCollectionSetClosure cl;
4521   collection_set_iterate_all(&amp;cl);
4522 
4523   collection_set-&gt;clear();
4524   collection_set-&gt;stop_incremental_building();
4525 }
4526 
4527 bool G1CollectedHeap::is_old_gc_alloc_region(HeapRegion* hr) {
4528   return _allocator-&gt;is_retained_old_region(hr);
4529 }
4530 
4531 void G1CollectedHeap::set_region_short_lived_locked(HeapRegion* hr) {
4532   _eden.add(hr);
4533   _policy-&gt;set_region_eden(hr);
4534 }
4535 
4536 #ifdef ASSERT
4537 
4538 class NoYoungRegionsClosure: public HeapRegionClosure {
4539 private:
4540   bool _success;
4541 public:
4542   NoYoungRegionsClosure() : _success(true) { }
4543   bool do_heap_region(HeapRegion* r) {
4544     if (r-&gt;is_young()) {
4545       log_error(gc, verify)(&quot;Region [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;) tagged as young&quot;,
4546                             p2i(r-&gt;bottom()), p2i(r-&gt;end()));
4547       _success = false;
4548     }
4549     return false;
4550   }
4551   bool success() { return _success; }
4552 };
4553 
4554 bool G1CollectedHeap::check_young_list_empty() {
4555   bool ret = (young_regions_count() == 0);
4556 
4557   NoYoungRegionsClosure closure;
4558   heap_region_iterate(&amp;closure);
4559   ret = ret &amp;&amp; closure.success();
4560 
4561   return ret;
4562 }
4563 
4564 #endif // ASSERT
4565 
4566 class TearDownRegionSetsClosure : public HeapRegionClosure {
4567   HeapRegionSet *_old_set;
4568 
4569 public:
4570   TearDownRegionSetsClosure(HeapRegionSet* old_set) : _old_set(old_set) { }
4571 
4572   bool do_heap_region(HeapRegion* r) {
4573     if (r-&gt;is_old()) {
4574       _old_set-&gt;remove(r);
4575     } else if(r-&gt;is_young()) {
4576       r-&gt;uninstall_surv_rate_group();
4577     } else {
4578       // We ignore free regions, we&#39;ll empty the free list afterwards.
4579       // We ignore humongous and archive regions, we&#39;re not tearing down these
4580       // sets.
4581       assert(r-&gt;is_archive() || r-&gt;is_free() || r-&gt;is_humongous(),
4582              &quot;it cannot be another type&quot;);
4583     }
4584     return false;
4585   }
4586 
4587   ~TearDownRegionSetsClosure() {
4588     assert(_old_set-&gt;is_empty(), &quot;post-condition&quot;);
4589   }
4590 };
4591 
4592 void G1CollectedHeap::tear_down_region_sets(bool free_list_only) {
4593   assert_at_safepoint_on_vm_thread();
4594 
4595   if (!free_list_only) {
4596     TearDownRegionSetsClosure cl(&amp;_old_set);
4597     heap_region_iterate(&amp;cl);
4598 
4599     // Note that emptying the _young_list is postponed and instead done as
4600     // the first step when rebuilding the regions sets again. The reason for
4601     // this is that during a full GC string deduplication needs to know if
4602     // a collected region was young or old when the full GC was initiated.
4603   }
4604   _hrm-&gt;remove_all_free_regions();
4605 }
4606 
4607 void G1CollectedHeap::increase_used(size_t bytes) {
4608   _summary_bytes_used += bytes;
4609 }
4610 
4611 void G1CollectedHeap::decrease_used(size_t bytes) {
4612   assert(_summary_bytes_used &gt;= bytes,
4613          &quot;invariant: _summary_bytes_used: &quot; SIZE_FORMAT &quot; should be &gt;= bytes: &quot; SIZE_FORMAT,
4614          _summary_bytes_used, bytes);
4615   _summary_bytes_used -= bytes;
4616 }
4617 
4618 void G1CollectedHeap::set_used(size_t bytes) {
4619   _summary_bytes_used = bytes;
4620 }
4621 
4622 class RebuildRegionSetsClosure : public HeapRegionClosure {
4623 private:
4624   bool _free_list_only;
4625 
4626   HeapRegionSet* _old_set;
4627   HeapRegionManager* _hrm;
4628 
4629   size_t _total_used;
4630 
4631 public:
4632   RebuildRegionSetsClosure(bool free_list_only,
4633                            HeapRegionSet* old_set,
4634                            HeapRegionManager* hrm) :
4635     _free_list_only(free_list_only),
4636     _old_set(old_set), _hrm(hrm), _total_used(0) {
4637     assert(_hrm-&gt;num_free_regions() == 0, &quot;pre-condition&quot;);
4638     if (!free_list_only) {
4639       assert(_old_set-&gt;is_empty(), &quot;pre-condition&quot;);
4640     }
4641   }
4642 
4643   bool do_heap_region(HeapRegion* r) {
4644     if (r-&gt;is_empty()) {
4645       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;Empty regions should have empty remembered sets.&quot;);
4646       // Add free regions to the free list
4647       r-&gt;set_free();
4648       _hrm-&gt;insert_into_free_list(r);
4649     } else if (!_free_list_only) {
4650       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;At this point remembered sets must have been cleared.&quot;);
4651 
4652       if (r-&gt;is_archive() || r-&gt;is_humongous()) {
4653         // We ignore archive and humongous regions. We left these sets unchanged.
4654       } else {
4655         assert(r-&gt;is_young() || r-&gt;is_free() || r-&gt;is_old(), &quot;invariant&quot;);
4656         // We now move all (non-humongous, non-old, non-archive) regions to old gen, and register them as such.
4657         r-&gt;move_to_old();
4658         _old_set-&gt;add(r);
4659       }
4660       _total_used += r-&gt;used();
4661     }
4662 
4663     return false;
4664   }
4665 
4666   size_t total_used() {
4667     return _total_used;
4668   }
4669 };
4670 
4671 void G1CollectedHeap::rebuild_region_sets(bool free_list_only) {
4672   assert_at_safepoint_on_vm_thread();
4673 
4674   if (!free_list_only) {
4675     _eden.clear();
4676     _survivor.clear();
4677   }
4678 
4679   RebuildRegionSetsClosure cl(free_list_only, &amp;_old_set, _hrm);
4680   heap_region_iterate(&amp;cl);
4681 
4682   if (!free_list_only) {
4683     set_used(cl.total_used());
4684     if (_archive_allocator != NULL) {
4685       _archive_allocator-&gt;clear_used();
4686     }
4687   }
4688   assert_used_and_recalculate_used_equal(this);
4689 }
4690 
4691 // Methods for the mutator alloc region
4692 
4693 HeapRegion* G1CollectedHeap::new_mutator_alloc_region(size_t word_size,
4694                                                       bool force,
4695                                                       uint node_index) {
4696   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4697   bool should_allocate = policy()-&gt;should_allocate_mutator_region();
4698   if (force || should_allocate) {
4699     HeapRegion* new_alloc_region = new_region(word_size,
4700                                               HeapRegionType::Eden,
4701                                               false /* do_expand */,
4702                                               node_index);
4703     if (new_alloc_region != NULL) {
4704       set_region_short_lived_locked(new_alloc_region);
4705       _hr_printer.alloc(new_alloc_region, !should_allocate);
4706       _verifier-&gt;check_bitmaps(&quot;Mutator Region Allocation&quot;, new_alloc_region);
4707       _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4708       return new_alloc_region;
4709     }
4710   }
4711   return NULL;
4712 }
4713 
4714 void G1CollectedHeap::retire_mutator_alloc_region(HeapRegion* alloc_region,
4715                                                   size_t allocated_bytes) {
4716   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4717   assert(alloc_region-&gt;is_eden(), &quot;all mutator alloc regions should be eden&quot;);
4718 
4719   collection_set()-&gt;add_eden_region(alloc_region);
4720   increase_used(allocated_bytes);
4721   _eden.add_used_bytes(allocated_bytes);
4722   _hr_printer.retire(alloc_region);
4723 
4724   // We update the eden sizes here, when the region is retired,
4725   // instead of when it&#39;s allocated, since this is the point that its
4726   // used space has been recorded in _summary_bytes_used.
4727   g1mm()-&gt;update_eden_size();
4728 }
4729 
4730 // Methods for the GC alloc regions
4731 
4732 bool G1CollectedHeap::has_more_regions(G1HeapRegionAttr dest) {
4733   if (dest.is_old()) {
4734     return true;
4735   } else {
4736     return survivor_regions_count() &lt; policy()-&gt;max_survivor_regions();
4737   }
4738 }
4739 
4740 HeapRegion* G1CollectedHeap::new_gc_alloc_region(size_t word_size, G1HeapRegionAttr dest, uint node_index) {
4741   assert(FreeList_lock-&gt;owned_by_self(), &quot;pre-condition&quot;);
4742 
4743   if (!has_more_regions(dest)) {
4744     return NULL;
4745   }
4746 
4747   HeapRegionType type;
4748   if (dest.is_young()) {
4749     type = HeapRegionType::Survivor;
4750   } else {
4751     type = HeapRegionType::Old;
4752   }
4753 
4754   HeapRegion* new_alloc_region = new_region(word_size,
4755                                             type,
4756                                             true /* do_expand */,
4757                                             node_index);
4758 
4759   if (new_alloc_region != NULL) {
4760     if (type.is_survivor()) {
4761       new_alloc_region-&gt;set_survivor();
4762       _survivor.add(new_alloc_region);
4763       _verifier-&gt;check_bitmaps(&quot;Survivor Region Allocation&quot;, new_alloc_region);
4764     } else {
4765       new_alloc_region-&gt;set_old();
4766       _verifier-&gt;check_bitmaps(&quot;Old Region Allocation&quot;, new_alloc_region);
4767     }
4768     _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4769     register_region_with_region_attr(new_alloc_region);
4770     _hr_printer.alloc(new_alloc_region);
4771     return new_alloc_region;
4772   }
4773   return NULL;
4774 }
4775 
4776 void G1CollectedHeap::retire_gc_alloc_region(HeapRegion* alloc_region,
4777                                              size_t allocated_bytes,
4778                                              G1HeapRegionAttr dest) {
4779   _bytes_used_during_gc += allocated_bytes;
4780   if (dest.is_old()) {
4781     old_set_add(alloc_region);
4782   } else {
4783     assert(dest.is_young(), &quot;Retiring alloc region should be young (%d)&quot;, dest.type());
4784     _survivor.add_used_bytes(allocated_bytes);
4785   }
4786 
4787   bool const during_im = collector_state()-&gt;in_concurrent_start_gc();
4788   if (during_im &amp;&amp; allocated_bytes &gt; 0) {
4789     _cm-&gt;root_regions()-&gt;add(alloc_region-&gt;next_top_at_mark_start(), alloc_region-&gt;top());
4790   }
4791   _hr_printer.retire(alloc_region);
4792 }
4793 
4794 HeapRegion* G1CollectedHeap::alloc_highest_free_region() {
4795   bool expanded = false;
4796   uint index = _hrm-&gt;find_highest_free(&amp;expanded);
4797 
4798   if (index != G1_NO_HRM_INDEX) {
4799     if (expanded) {
4800       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (requested address range outside heap bounds). region size: &quot; SIZE_FORMAT &quot;B&quot;,
4801                                 HeapRegion::GrainWords * HeapWordSize);
4802     }
4803     return _hrm-&gt;allocate_free_regions_starting_at(index, 1);
4804   }
4805   return NULL;
4806 }
4807 
4808 // Optimized nmethod scanning
4809 
4810 class RegisterNMethodOopClosure: public OopClosure {
4811   G1CollectedHeap* _g1h;
4812   nmethod* _nm;
4813 
4814   template &lt;class T&gt; void do_oop_work(T* p) {
4815     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4816     if (!CompressedOops::is_null(heap_oop)) {
4817       oop obj = CompressedOops::decode_not_null(heap_oop);
4818       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4819       assert(!hr-&gt;is_continues_humongous(),
4820              &quot;trying to add code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4821              &quot; starting at &quot; HR_FORMAT,
4822              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4823 
4824       // HeapRegion::add_strong_code_root_locked() avoids adding duplicate entries.
4825       hr-&gt;add_strong_code_root_locked(_nm);
4826     }
4827   }
4828 
4829 public:
4830   RegisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4831     _g1h(g1h), _nm(nm) {}
4832 
4833   void do_oop(oop* p)       { do_oop_work(p); }
4834   void do_oop(narrowOop* p) { do_oop_work(p); }
4835 };
4836 
4837 class UnregisterNMethodOopClosure: public OopClosure {
4838   G1CollectedHeap* _g1h;
4839   nmethod* _nm;
4840 
4841   template &lt;class T&gt; void do_oop_work(T* p) {
4842     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4843     if (!CompressedOops::is_null(heap_oop)) {
4844       oop obj = CompressedOops::decode_not_null(heap_oop);
4845       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4846       assert(!hr-&gt;is_continues_humongous(),
4847              &quot;trying to remove code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4848              &quot; starting at &quot; HR_FORMAT,
4849              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4850 
4851       hr-&gt;remove_strong_code_root(_nm);
4852     }
4853   }
4854 
4855 public:
4856   UnregisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4857     _g1h(g1h), _nm(nm) {}
4858 
4859   void do_oop(oop* p)       { do_oop_work(p); }
4860   void do_oop(narrowOop* p) { do_oop_work(p); }
4861 };
4862 
4863 void G1CollectedHeap::register_nmethod(nmethod* nm) {
4864   guarantee(nm != NULL, &quot;sanity&quot;);
4865   RegisterNMethodOopClosure reg_cl(this, nm);
4866   nm-&gt;oops_do(&amp;reg_cl);
4867 }
4868 
4869 void G1CollectedHeap::unregister_nmethod(nmethod* nm) {
4870   guarantee(nm != NULL, &quot;sanity&quot;);
4871   UnregisterNMethodOopClosure reg_cl(this, nm);
4872   nm-&gt;oops_do(&amp;reg_cl, true);
4873 }
4874 
4875 void G1CollectedHeap::purge_code_root_memory() {
4876   double purge_start = os::elapsedTime();
4877   G1CodeRootSet::purge();
4878   double purge_time_ms = (os::elapsedTime() - purge_start) * 1000.0;
4879   phase_times()-&gt;record_strong_code_root_purge_time(purge_time_ms);
4880 }
4881 
4882 class RebuildStrongCodeRootClosure: public CodeBlobClosure {
4883   G1CollectedHeap* _g1h;
4884 
4885 public:
4886   RebuildStrongCodeRootClosure(G1CollectedHeap* g1h) :
4887     _g1h(g1h) {}
4888 
4889   void do_code_blob(CodeBlob* cb) {
4890     nmethod* nm = (cb != NULL) ? cb-&gt;as_nmethod_or_null() : NULL;
4891     if (nm == NULL) {
4892       return;
4893     }
4894 
4895     _g1h-&gt;register_nmethod(nm);
4896   }
4897 };
4898 
4899 void G1CollectedHeap::rebuild_strong_code_roots() {
4900   RebuildStrongCodeRootClosure blob_cl(this);
4901   CodeCache::blobs_do(&amp;blob_cl);
4902 }
4903 
4904 void G1CollectedHeap::initialize_serviceability() {
4905   _g1mm-&gt;initialize_serviceability();
4906 }
4907 
4908 MemoryUsage G1CollectedHeap::memory_usage() {
4909   return _g1mm-&gt;memory_usage();
4910 }
4911 
4912 GrowableArray&lt;GCMemoryManager*&gt; G1CollectedHeap::memory_managers() {
4913   return _g1mm-&gt;memory_managers();
4914 }
4915 
4916 GrowableArray&lt;MemoryPool*&gt; G1CollectedHeap::memory_pools() {
4917   return _g1mm-&gt;memory_pools();
4918 }
    </pre>
  </body>
</html>