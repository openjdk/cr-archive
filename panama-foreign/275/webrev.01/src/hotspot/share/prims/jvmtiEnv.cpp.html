<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/prims/jvmtiEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderExt.hpp&quot;
  27 #include &quot;classfile/javaClasses.inline.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/modules.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
  34 #include &quot;jfr/jfrEvents.hpp&quot;
  35 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;logging/logConfiguration.hpp&quot;
  38 #include &quot;memory/resourceArea.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/instanceKlass.hpp&quot;
  41 #include &quot;oops/objArrayOop.inline.hpp&quot;
  42 #include &quot;oops/oop.inline.hpp&quot;
  43 #include &quot;prims/jniCheck.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  46 #include &quot;prims/jvmtiClassFileReconstituter.hpp&quot;
  47 #include &quot;prims/jvmtiCodeBlobEvents.hpp&quot;
  48 #include &quot;prims/jvmtiExtensions.hpp&quot;
  49 #include &quot;prims/jvmtiGetLoadedClasses.hpp&quot;
  50 #include &quot;prims/jvmtiImpl.hpp&quot;
  51 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  52 #include &quot;prims/jvmtiRawMonitor.hpp&quot;
  53 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  54 #include &quot;prims/jvmtiTagMap.hpp&quot;
  55 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  56 #include &quot;prims/jvmtiUtil.hpp&quot;
  57 #include &quot;runtime/arguments.hpp&quot;
  58 #include &quot;runtime/deoptimization.hpp&quot;
  59 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  60 #include &quot;runtime/handles.inline.hpp&quot;
  61 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  62 #include &quot;runtime/javaCalls.hpp&quot;
  63 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  64 #include &quot;runtime/jniHandles.inline.hpp&quot;
  65 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  66 #include &quot;runtime/osThread.hpp&quot;
  67 #include &quot;runtime/reflectionUtils.hpp&quot;
  68 #include &quot;runtime/signature.hpp&quot;
  69 #include &quot;runtime/thread.inline.hpp&quot;
  70 #include &quot;runtime/threadHeapSampler.hpp&quot;
  71 #include &quot;runtime/threadSMR.hpp&quot;
  72 #include &quot;runtime/timerTrace.hpp&quot;
  73 #include &quot;runtime/vframe.inline.hpp&quot;
  74 #include &quot;runtime/vmThread.hpp&quot;
  75 #include &quot;services/threadService.hpp&quot;
  76 #include &quot;utilities/exceptions.hpp&quot;
  77 #include &quot;utilities/preserveException.hpp&quot;
  78 #include &quot;utilities/utf8.hpp&quot;
  79 
  80 
  81 #define FIXLATER 0 // REMOVE this when completed.
  82 
  83  // FIXLATER: hook into JvmtiTrace
  84 #define TraceJVMTICalls false
  85 
  86 JvmtiEnv::JvmtiEnv(jint version) : JvmtiEnvBase(version) {
  87 }
  88 
  89 JvmtiEnv::~JvmtiEnv() {
  90 }
  91 
  92 JvmtiEnv*
  93 JvmtiEnv::create_a_jvmti(jint version) {
  94   return new JvmtiEnv(version);
  95 }
  96 
  97 // VM operation class to copy jni function table at safepoint.
  98 // More than one java threads or jvmti agents may be reading/
  99 // modifying jni function tables. To reduce the risk of bad
 100 // interaction b/w these threads it is copied at safepoint.
 101 class VM_JNIFunctionTableCopier : public VM_Operation {
 102  private:
 103   const struct JNINativeInterface_ *_function_table;
 104  public:
 105   VM_JNIFunctionTableCopier(const struct JNINativeInterface_ *func_tbl) {
 106     _function_table = func_tbl;
 107   };
 108 
 109   VMOp_Type type() const { return VMOp_JNIFunctionTableCopier; }
 110   void doit() {
 111     copy_jni_function_table(_function_table);
 112   };
 113 };
 114 
 115 //
 116 // Do not change the &quot;prefix&quot; marker below, everything above it is copied
 117 // unchanged into the filled stub, everything below is controlled by the
 118 // stub filler (only method bodies are carried forward, and then only for
 119 // functionality still in the spec).
 120 //
 121 // end file prefix
 122 
 123   //
 124   // Memory Management functions
 125   //
 126 
 127 // mem_ptr - pre-checked for NULL
 128 jvmtiError
 129 JvmtiEnv::Allocate(jlong size, unsigned char** mem_ptr) {
 130   return allocate(size, mem_ptr);
 131 } /* end Allocate */
 132 
 133 
 134 // mem - NULL is a valid value, must be checked
 135 jvmtiError
 136 JvmtiEnv::Deallocate(unsigned char* mem) {
 137   return deallocate(mem);
 138 } /* end Deallocate */
 139 
 140 // Threads_lock NOT held, java_thread not protected by lock
 141 // java_thread - pre-checked
 142 // data - NULL is a valid value, must be checked
 143 jvmtiError
 144 JvmtiEnv::SetThreadLocalStorage(JavaThread* java_thread, const void* data) {
 145   JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 146   if (state == NULL) {
 147     if (data == NULL) {
 148       // leaving state unset same as data set to NULL
 149       return JVMTI_ERROR_NONE;
 150     }
 151     // otherwise, create the state
 152     state = JvmtiThreadState::state_for(java_thread);
 153     if (state == NULL) {
 154       return JVMTI_ERROR_THREAD_NOT_ALIVE;
 155     }
 156   }
 157   state-&gt;env_thread_state(this)-&gt;set_agent_thread_local_storage_data((void*)data);
 158   return JVMTI_ERROR_NONE;
 159 } /* end SetThreadLocalStorage */
 160 
 161 
 162 // Threads_lock NOT held
 163 // thread - NOT pre-checked
 164 // data_ptr - pre-checked for NULL
 165 jvmtiError
 166 JvmtiEnv::GetThreadLocalStorage(jthread thread, void** data_ptr) {
 167   JavaThread* current_thread = JavaThread::current();
 168   if (thread == NULL) {
 169     JvmtiThreadState* state = current_thread-&gt;jvmti_thread_state();
 170     *data_ptr = (state == NULL) ? NULL :
 171       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 172   } else {
 173     // jvmti_GetThreadLocalStorage is &quot;in native&quot; and doesn&#39;t transition
 174     // the thread to _thread_in_vm. However, when the TLS for a thread
 175     // other than the current thread is required we need to transition
 176     // from native so as to resolve the jthread.
 177 
 178     ThreadInVMfromNative __tiv(current_thread);
 179     VM_ENTRY_BASE(jvmtiError, JvmtiEnv::GetThreadLocalStorage , current_thread)
 180     debug_only(VMNativeEntryWrapper __vew;)
 181 
 182     JavaThread* java_thread = NULL;
 183     ThreadsListHandle tlh(current_thread);
 184     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
 185     if (err != JVMTI_ERROR_NONE) {
 186       return err;
 187     }
 188 
 189     JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 190     *data_ptr = (state == NULL) ? NULL :
 191       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 192   }
 193   return JVMTI_ERROR_NONE;
 194 } /* end GetThreadLocalStorage */
 195 
 196   //
 197   // Module functions
 198   //
 199 
 200 // module_count_ptr - pre-checked for NULL
 201 // modules_ptr - pre-checked for NULL
 202 jvmtiError
 203 JvmtiEnv::GetAllModules(jint* module_count_ptr, jobject** modules_ptr) {
 204     JvmtiModuleClosure jmc;
 205 
 206     return jmc.get_all_modules(this, module_count_ptr, modules_ptr);
 207 } /* end GetAllModules */
 208 
 209 
 210 // class_loader - NULL is a valid value, must be pre-checked
 211 // package_name - pre-checked for NULL
 212 // module_ptr - pre-checked for NULL
 213 jvmtiError
 214 JvmtiEnv::GetNamedModule(jobject class_loader, const char* package_name, jobject* module_ptr) {
 215   JavaThread* THREAD = JavaThread::current(); // pass to macros
 216   ResourceMark rm(THREAD);
 217   Handle h_loader (THREAD, JNIHandles::resolve(class_loader));
 218   // Check that loader is a subclass of java.lang.ClassLoader.
 219   if (h_loader.not_null() &amp;&amp; !java_lang_ClassLoader::is_subclass(h_loader-&gt;klass())) {
 220     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 221   }
 222   jobject module = Modules::get_named_module(h_loader, package_name, THREAD);
 223   if (HAS_PENDING_EXCEPTION) {
 224     CLEAR_PENDING_EXCEPTION;
 225     return JVMTI_ERROR_INTERNAL; // unexpected exception
 226   }
 227   *module_ptr = module;
 228   return JVMTI_ERROR_NONE;
 229 } /* end GetNamedModule */
 230 
 231 
 232 // module - pre-checked for NULL
 233 // to_module - pre-checked for NULL
 234 jvmtiError
 235 JvmtiEnv::AddModuleReads(jobject module, jobject to_module) {
 236   JavaThread* THREAD = JavaThread::current();
 237 
 238   // check module
 239   Handle h_module(THREAD, JNIHandles::resolve(module));
 240   if (!java_lang_Module::is_instance(h_module())) {
 241     return JVMTI_ERROR_INVALID_MODULE;
 242   }
 243   // check to_module
 244   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 245   if (!java_lang_Module::is_instance(h_to_module())) {
 246     return JVMTI_ERROR_INVALID_MODULE;
 247   }
 248   return JvmtiExport::add_module_reads(h_module, h_to_module, THREAD);
 249 } /* end AddModuleReads */
 250 
 251 
 252 // module - pre-checked for NULL
 253 // pkg_name - pre-checked for NULL
 254 // to_module - pre-checked for NULL
 255 jvmtiError
 256 JvmtiEnv::AddModuleExports(jobject module, const char* pkg_name, jobject to_module) {
 257   JavaThread* THREAD = JavaThread::current();
 258   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 259 
 260   // check module
 261   Handle h_module(THREAD, JNIHandles::resolve(module));
 262   if (!java_lang_Module::is_instance(h_module())) {
 263     return JVMTI_ERROR_INVALID_MODULE;
 264   }
 265   // check to_module
 266   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 267   if (!java_lang_Module::is_instance(h_to_module())) {
 268     return JVMTI_ERROR_INVALID_MODULE;
 269   }
 270   return JvmtiExport::add_module_exports(h_module, h_pkg, h_to_module, THREAD);
 271 } /* end AddModuleExports */
 272 
 273 
 274 // module - pre-checked for NULL
 275 // pkg_name - pre-checked for NULL
 276 // to_module - pre-checked for NULL
 277 jvmtiError
 278 JvmtiEnv::AddModuleOpens(jobject module, const char* pkg_name, jobject to_module) {
 279   JavaThread* THREAD = JavaThread::current();
 280   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 281 
 282   // check module
 283   Handle h_module(THREAD, JNIHandles::resolve(module));
 284   if (!java_lang_Module::is_instance(h_module())) {
 285     return JVMTI_ERROR_INVALID_MODULE;
 286   }
 287   // check to_module
 288   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 289   if (!java_lang_Module::is_instance(h_to_module())) {
 290     return JVMTI_ERROR_INVALID_MODULE;
 291   }
 292   return JvmtiExport::add_module_opens(h_module, h_pkg, h_to_module, THREAD);
 293 } /* end AddModuleOpens */
 294 
 295 
 296 // module - pre-checked for NULL
 297 // service - pre-checked for NULL
 298 jvmtiError
 299 JvmtiEnv::AddModuleUses(jobject module, jclass service) {
 300   JavaThread* THREAD = JavaThread::current();
 301 
 302   // check module
 303   Handle h_module(THREAD, JNIHandles::resolve(module));
 304   if (!java_lang_Module::is_instance(h_module())) {
 305     return JVMTI_ERROR_INVALID_MODULE;
 306   }
 307   // check service
 308   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 309   if (!java_lang_Class::is_instance(h_service()) ||
 310       java_lang_Class::is_primitive(h_service())) {
 311     return JVMTI_ERROR_INVALID_CLASS;
 312   }
 313   return JvmtiExport::add_module_uses(h_module, h_service, THREAD);
 314 } /* end AddModuleUses */
 315 
 316 
 317 // module - pre-checked for NULL
 318 // service - pre-checked for NULL
 319 // impl_class - pre-checked for NULL
 320 jvmtiError
 321 JvmtiEnv::AddModuleProvides(jobject module, jclass service, jclass impl_class) {
 322   JavaThread* THREAD = JavaThread::current();
 323 
 324   // check module
 325   Handle h_module(THREAD, JNIHandles::resolve(module));
 326   if (!java_lang_Module::is_instance(h_module())) {
 327     return JVMTI_ERROR_INVALID_MODULE;
 328   }
 329   // check service
 330   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 331   if (!java_lang_Class::is_instance(h_service()) ||
 332       java_lang_Class::is_primitive(h_service())) {
 333     return JVMTI_ERROR_INVALID_CLASS;
 334   }
 335   // check impl_class
 336   Handle h_impl_class(THREAD, JNIHandles::resolve_external_guard(impl_class));
 337   if (!java_lang_Class::is_instance(h_impl_class()) ||
 338       java_lang_Class::is_primitive(h_impl_class())) {
 339     return JVMTI_ERROR_INVALID_CLASS;
 340   }
 341   return JvmtiExport::add_module_provides(h_module, h_service, h_impl_class, THREAD);
 342 } /* end AddModuleProvides */
 343 
 344 // module - pre-checked for NULL
 345 // is_modifiable_class_ptr - pre-checked for NULL
 346 jvmtiError
 347 JvmtiEnv::IsModifiableModule(jobject module, jboolean* is_modifiable_module_ptr) {
 348   JavaThread* THREAD = JavaThread::current();
 349 
 350   // check module
 351   Handle h_module(THREAD, JNIHandles::resolve(module));
 352   if (!java_lang_Module::is_instance(h_module())) {
 353     return JVMTI_ERROR_INVALID_MODULE;
 354   }
 355 
 356   *is_modifiable_module_ptr = JNI_TRUE;
 357   return JVMTI_ERROR_NONE;
 358 } /* end IsModifiableModule */
 359 
 360 
 361   //
 362   // Class functions
 363   //
 364 
 365 // class_count_ptr - pre-checked for NULL
 366 // classes_ptr - pre-checked for NULL
 367 jvmtiError
 368 JvmtiEnv::GetLoadedClasses(jint* class_count_ptr, jclass** classes_ptr) {
 369   return JvmtiGetLoadedClasses::getLoadedClasses(this, class_count_ptr, classes_ptr);
 370 } /* end GetLoadedClasses */
 371 
 372 
 373 // initiating_loader - NULL is a valid value, must be checked
 374 // class_count_ptr - pre-checked for NULL
 375 // classes_ptr - pre-checked for NULL
 376 jvmtiError
 377 JvmtiEnv::GetClassLoaderClasses(jobject initiating_loader, jint* class_count_ptr, jclass** classes_ptr) {
 378   return JvmtiGetLoadedClasses::getClassLoaderClasses(this, initiating_loader,
 379                                                   class_count_ptr, classes_ptr);
 380 } /* end GetClassLoaderClasses */
 381 
 382 // k_mirror - may be primitive, this must be checked
 383 // is_modifiable_class_ptr - pre-checked for NULL
 384 jvmtiError
 385 JvmtiEnv::IsModifiableClass(oop k_mirror, jboolean* is_modifiable_class_ptr) {
 386   *is_modifiable_class_ptr = VM_RedefineClasses::is_modifiable_class(k_mirror)?
 387                                                        JNI_TRUE : JNI_FALSE;
 388   return JVMTI_ERROR_NONE;
 389 } /* end IsModifiableClass */
 390 
 391 // class_count - pre-checked to be greater than or equal to 0
 392 // classes - pre-checked for NULL
 393 jvmtiError
 394 JvmtiEnv::RetransformClasses(jint class_count, const jclass* classes) {
 395 //TODO: add locking
 396 
 397   int index;
 398   JavaThread* current_thread = JavaThread::current();
 399   ResourceMark rm(current_thread);
 400 
 401   jvmtiClassDefinition* class_definitions =
 402                             NEW_RESOURCE_ARRAY(jvmtiClassDefinition, class_count);
 403   NULL_CHECK(class_definitions, JVMTI_ERROR_OUT_OF_MEMORY);
 404 
 405   for (index = 0; index &lt; class_count; index++) {
 406     HandleMark hm(current_thread);
 407 
 408     jclass jcls = classes[index];
 409     oop k_mirror = JNIHandles::resolve_external_guard(jcls);
 410     if (k_mirror == NULL) {
 411       return JVMTI_ERROR_INVALID_CLASS;
 412     }
 413     if (!k_mirror-&gt;is_a(SystemDictionary::Class_klass())) {
 414       return JVMTI_ERROR_INVALID_CLASS;
 415     }
 416 
 417     if (!VM_RedefineClasses::is_modifiable_class(k_mirror)) {
 418       return JVMTI_ERROR_UNMODIFIABLE_CLASS;
 419     }
 420 
 421     Klass* klass = java_lang_Class::as_Klass(k_mirror);
 422 
 423     jint status = klass-&gt;jvmti_class_status();
 424     if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
 425       return JVMTI_ERROR_INVALID_CLASS;
 426     }
 427 
 428     InstanceKlass* ik = InstanceKlass::cast(klass);
 429     if (ik-&gt;get_cached_class_file_bytes() == NULL) {
 430       // Not cached, we need to reconstitute the class file from the
 431       // VM representation. We don&#39;t attach the reconstituted class
 432       // bytes to the InstanceKlass here because they have not been
 433       // validated and we&#39;re not at a safepoint.
 434       JvmtiClassFileReconstituter reconstituter(ik);
 435       if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
 436         return reconstituter.get_error();
 437       }
 438 
 439       class_definitions[index].class_byte_count = (jint)reconstituter.class_file_size();
 440       class_definitions[index].class_bytes      = (unsigned char*)
 441                                                        reconstituter.class_file_bytes();
 442     } else {
 443       // it is cached, get it from the cache
 444       class_definitions[index].class_byte_count = ik-&gt;get_cached_class_file_len();
 445       class_definitions[index].class_bytes      = ik-&gt;get_cached_class_file_bytes();
 446     }
 447     class_definitions[index].klass              = jcls;
 448   }
 449   EventRetransformClasses event;
 450   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_retransform);
 451   VMThread::execute(&amp;op);
 452   jvmtiError error = op.check_error();
 453   if (error == JVMTI_ERROR_NONE) {
 454     event.set_classCount(class_count);
 455     event.set_redefinitionId(op.id());
 456     event.commit();
 457   }
 458   return error;
 459 } /* end RetransformClasses */
 460 
 461 
 462 // class_count - pre-checked to be greater than or equal to 0
 463 // class_definitions - pre-checked for NULL
 464 jvmtiError
 465 JvmtiEnv::RedefineClasses(jint class_count, const jvmtiClassDefinition* class_definitions) {
 466 //TODO: add locking
 467   EventRedefineClasses event;
 468   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_redefine);
 469   VMThread::execute(&amp;op);
 470   jvmtiError error = op.check_error();
 471   if (error == JVMTI_ERROR_NONE) {
 472     event.set_classCount(class_count);
 473     event.set_redefinitionId(op.id());
 474     event.commit();
 475   }
 476   return error;
 477 } /* end RedefineClasses */
 478 
 479 
 480   //
 481   // Object functions
 482   //
 483 
 484 // size_ptr - pre-checked for NULL
 485 jvmtiError
 486 JvmtiEnv::GetObjectSize(jobject object, jlong* size_ptr) {
 487   oop mirror = JNIHandles::resolve_external_guard(object);
 488   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 489   *size_ptr = (jlong)mirror-&gt;size() * wordSize;
 490   return JVMTI_ERROR_NONE;
 491 } /* end GetObjectSize */
 492 
 493   //
 494   // Method functions
 495   //
 496 
 497 // prefix - NULL is a valid value, must be checked
 498 jvmtiError
 499 JvmtiEnv::SetNativeMethodPrefix(const char* prefix) {
 500   return prefix == NULL?
 501               SetNativeMethodPrefixes(0, NULL) :
 502               SetNativeMethodPrefixes(1, (char**)&amp;prefix);
 503 } /* end SetNativeMethodPrefix */
 504 
 505 
 506 // prefix_count - pre-checked to be greater than or equal to 0
 507 // prefixes - pre-checked for NULL
 508 jvmtiError
 509 JvmtiEnv::SetNativeMethodPrefixes(jint prefix_count, char** prefixes) {
 510   // Have to grab JVMTI thread state lock to be sure that some thread
 511   // isn&#39;t accessing the prefixes at the same time we are setting them.
 512   // No locks during VM bring-up.
 513   if (Threads::number_of_threads() == 0) {
 514     return set_native_method_prefixes(prefix_count, prefixes);
 515   } else {
 516     MutexLocker mu(JvmtiThreadState_lock);
 517     return set_native_method_prefixes(prefix_count, prefixes);
 518   }
 519 } /* end SetNativeMethodPrefixes */
 520 
 521   //
 522   // Event Management functions
 523   //
 524 
 525 // callbacks - NULL is a valid value, must be checked
 526 // size_of_callbacks - pre-checked to be greater than or equal to 0
 527 jvmtiError
 528 JvmtiEnv::SetEventCallbacks(const jvmtiEventCallbacks* callbacks, jint size_of_callbacks) {
 529   JvmtiEventController::set_event_callbacks(this, callbacks, size_of_callbacks);
 530   return JVMTI_ERROR_NONE;
 531 } /* end SetEventCallbacks */
 532 
 533 
 534 // event_thread - NULL is a valid value, must be checked
 535 jvmtiError
 536 JvmtiEnv::SetEventNotificationMode(jvmtiEventMode mode, jvmtiEvent event_type, jthread event_thread,   ...) {
 537   if (event_thread == NULL) {
 538     // Can be called at Agent_OnLoad() time with event_thread == NULL
 539     // when Thread::current() does not work yet so we cannot create a
 540     // ThreadsListHandle that is common to both thread-specific and
 541     // global code paths.
 542 
 543     // event_type must be valid
 544     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 545       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 546     }
 547 
 548     bool enabled = (mode == JVMTI_ENABLE);
 549 
 550     // assure that needed capabilities are present
 551     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 552       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 553     }
 554 
 555     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 556       record_class_file_load_hook_enabled();
 557     }
 558 
 559     JvmtiEventController::set_user_enabled(this, (JavaThread*) NULL, event_type, enabled);
 560   } else {
 561     // We have a specified event_thread.
 562     JavaThread* java_thread = NULL;
 563     ThreadsListHandle tlh;
 564     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), event_thread, &amp;java_thread, NULL);
 565     if (err != JVMTI_ERROR_NONE) {
 566       return err;
 567     }
 568 
 569     // event_type must be valid
 570     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 571       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 572     }
 573 
 574     // global events cannot be controlled at thread level.
 575     if (JvmtiEventController::is_global_event(event_type)) {
 576       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 577     }
 578 
 579     bool enabled = (mode == JVMTI_ENABLE);
 580 
 581     // assure that needed capabilities are present
 582     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 583       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 584     }
 585 
 586     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 587       record_class_file_load_hook_enabled();
 588     }
 589     JvmtiEventController::set_user_enabled(this, java_thread, event_type, enabled);
 590   }
 591 
 592   return JVMTI_ERROR_NONE;
 593 } /* end SetEventNotificationMode */
 594 
 595   //
 596   // Capability functions
 597   //
 598 
 599 // capabilities_ptr - pre-checked for NULL
 600 jvmtiError
 601 JvmtiEnv::GetPotentialCapabilities(jvmtiCapabilities* capabilities_ptr) {
 602   JvmtiManageCapabilities::get_potential_capabilities(get_capabilities(),
 603                                                       get_prohibited_capabilities(),
 604                                                       capabilities_ptr);
 605   return JVMTI_ERROR_NONE;
 606 } /* end GetPotentialCapabilities */
 607 
 608 
 609 // capabilities_ptr - pre-checked for NULL
 610 jvmtiError
 611 JvmtiEnv::AddCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 612   return JvmtiManageCapabilities::add_capabilities(get_capabilities(),
 613                                                    get_prohibited_capabilities(),
 614                                                    capabilities_ptr,
 615                                                    get_capabilities());
 616 } /* end AddCapabilities */
 617 
 618 
 619 // capabilities_ptr - pre-checked for NULL
 620 jvmtiError
 621 JvmtiEnv::RelinquishCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 622   JvmtiManageCapabilities::relinquish_capabilities(get_capabilities(), capabilities_ptr, get_capabilities());
 623   return JVMTI_ERROR_NONE;
 624 } /* end RelinquishCapabilities */
 625 
 626 
 627 // capabilities_ptr - pre-checked for NULL
 628 jvmtiError
 629 JvmtiEnv::GetCapabilities(jvmtiCapabilities* capabilities_ptr) {
 630   JvmtiManageCapabilities::copy_capabilities(get_capabilities(), capabilities_ptr);
 631   return JVMTI_ERROR_NONE;
 632 } /* end GetCapabilities */
 633 
 634   //
 635   // Class Loader Search functions
 636   //
 637 
 638 // segment - pre-checked for NULL
 639 jvmtiError
 640 JvmtiEnv::AddToBootstrapClassLoaderSearch(const char* segment) {
 641   jvmtiPhase phase = get_phase();
 642   if (phase == JVMTI_PHASE_ONLOAD) {
 643     Arguments::append_sysclasspath(segment);
 644     return JVMTI_ERROR_NONE;
 645   } else if (use_version_1_0_semantics()) {
 646     // This JvmtiEnv requested version 1.0 semantics and this function
 647     // is only allowed in the ONLOAD phase in version 1.0 so we need to
 648     // return an error here.
 649     return JVMTI_ERROR_WRONG_PHASE;
 650   } else if (phase == JVMTI_PHASE_LIVE) {
 651     // The phase is checked by the wrapper that called this function,
 652     // but this thread could be racing with the thread that is
 653     // terminating the VM so we check one more time.
 654 
 655     // create the zip entry
 656     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, true);
 657     if (zip_entry == NULL) {
 658       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 659     }
 660 
 661     // lock the loader
 662     Thread* thread = Thread::current();
 663     HandleMark hm(thread);
 664     Handle loader_lock = Handle(thread, SystemDictionary::system_loader_lock());
 665 
 666     ObjectLocker ol(loader_lock, thread);
 667 
 668     // add the jar file to the bootclasspath
 669     log_info(class, load)(&quot;opened: %s&quot;, zip_entry-&gt;name());
 670 #if INCLUDE_CDS
 671     ClassLoaderExt::append_boot_classpath(zip_entry);
 672 #else
 673     ClassLoader::add_to_boot_append_entries(zip_entry);
 674 #endif
 675     return JVMTI_ERROR_NONE;
 676   } else {
 677     return JVMTI_ERROR_WRONG_PHASE;
 678   }
 679 
 680 } /* end AddToBootstrapClassLoaderSearch */
 681 
 682 
 683 // segment - pre-checked for NULL
 684 jvmtiError
 685 JvmtiEnv::AddToSystemClassLoaderSearch(const char* segment) {
 686   jvmtiPhase phase = get_phase();
 687 
 688   if (phase == JVMTI_PHASE_ONLOAD) {
 689     for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
 690       if (strcmp(&quot;java.class.path&quot;, p-&gt;key()) == 0) {
 691         p-&gt;append_value(segment);
 692         break;
 693       }
 694     }
 695     return JVMTI_ERROR_NONE;
 696   } else if (phase == JVMTI_PHASE_LIVE) {
 697     // The phase is checked by the wrapper that called this function,
 698     // but this thread could be racing with the thread that is
 699     // terminating the VM so we check one more time.
 700     Thread* THREAD = Thread::current();
 701     HandleMark hm(THREAD);
 702 
 703     // create the zip entry (which will open the zip file and hence
 704     // check that the segment is indeed a zip file).
 705     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, false);
 706     if (zip_entry == NULL) {
 707       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 708     }
 709     delete zip_entry;   // no longer needed
 710 
 711     // lock the loader
 712     Handle loader = Handle(THREAD, SystemDictionary::java_system_loader());
 713     ObjectLocker ol(loader, THREAD);
 714 
 715     // need the path as java.lang.String
 716     Handle path = java_lang_String::create_from_platform_dependent_str(segment, THREAD);
 717     if (HAS_PENDING_EXCEPTION) {
 718       CLEAR_PENDING_EXCEPTION;
 719       return JVMTI_ERROR_INTERNAL;
 720     }
 721 
 722     // Invoke the appendToClassPathForInstrumentation method - if the method
 723     // is not found it means the loader doesn&#39;t support adding to the class path
 724     // in the live phase.
 725     {
 726       JavaValue res(T_VOID);
 727       JavaCalls::call_special(&amp;res,
 728                               loader,
 729                               loader-&gt;klass(),
 730                               vmSymbols::appendToClassPathForInstrumentation_name(),
 731                               vmSymbols::appendToClassPathForInstrumentation_signature(),
 732                               path,
 733                               THREAD);
 734       if (HAS_PENDING_EXCEPTION) {
 735         Symbol* ex_name = PENDING_EXCEPTION-&gt;klass()-&gt;name();
 736         CLEAR_PENDING_EXCEPTION;
 737 
 738         if (ex_name == vmSymbols::java_lang_NoSuchMethodError()) {
 739           return JVMTI_ERROR_CLASS_LOADER_UNSUPPORTED;
 740         } else {
 741           return JVMTI_ERROR_INTERNAL;
 742         }
 743       }
 744     }
 745 
 746     return JVMTI_ERROR_NONE;
 747   } else {
 748     return JVMTI_ERROR_WRONG_PHASE;
 749   }
 750 } /* end AddToSystemClassLoaderSearch */
 751 
 752   //
 753   // General functions
 754   //
 755 
 756 // phase_ptr - pre-checked for NULL
 757 jvmtiError
 758 JvmtiEnv::GetPhase(jvmtiPhase* phase_ptr) {
 759   *phase_ptr = phase();
 760   return JVMTI_ERROR_NONE;
 761 } /* end GetPhase */
 762 
 763 
 764 jvmtiError
 765 JvmtiEnv::DisposeEnvironment() {
 766   dispose();
 767   return JVMTI_ERROR_NONE;
 768 } /* end DisposeEnvironment */
 769 
 770 
 771 // data - NULL is a valid value, must be checked
 772 jvmtiError
 773 JvmtiEnv::SetEnvironmentLocalStorage(const void* data) {
 774   set_env_local_storage(data);
 775   return JVMTI_ERROR_NONE;
 776 } /* end SetEnvironmentLocalStorage */
 777 
 778 
 779 // data_ptr - pre-checked for NULL
 780 jvmtiError
 781 JvmtiEnv::GetEnvironmentLocalStorage(void** data_ptr) {
 782   *data_ptr = (void*)get_env_local_storage();
 783   return JVMTI_ERROR_NONE;
 784 } /* end GetEnvironmentLocalStorage */
 785 
 786 // version_ptr - pre-checked for NULL
 787 jvmtiError
 788 JvmtiEnv::GetVersionNumber(jint* version_ptr) {
 789   *version_ptr = JVMTI_VERSION;
 790   return JVMTI_ERROR_NONE;
 791 } /* end GetVersionNumber */
 792 
 793 
 794 // name_ptr - pre-checked for NULL
 795 jvmtiError
 796 JvmtiEnv::GetErrorName(jvmtiError error, char** name_ptr) {
 797   if (error &lt; JVMTI_ERROR_NONE || error &gt; JVMTI_ERROR_MAX) {
 798     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 799   }
 800   const char *name = JvmtiUtil::error_name(error);
 801   if (name == NULL) {
 802     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 803   }
 804   size_t len = strlen(name) + 1;
 805   jvmtiError err = allocate(len, (unsigned char**)name_ptr);
 806   if (err == JVMTI_ERROR_NONE) {
 807     memcpy(*name_ptr, name, len);
 808   }
 809   return err;
 810 } /* end GetErrorName */
 811 
 812 
 813 jvmtiError
 814 JvmtiEnv::SetVerboseFlag(jvmtiVerboseFlag flag, jboolean value) {
 815   LogLevelType level = value == 0 ? LogLevel::Off : LogLevel::Info;
 816   switch (flag) {
 817   case JVMTI_VERBOSE_OTHER:
 818     // ignore
 819     break;
 820   case JVMTI_VERBOSE_CLASS:
 821     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, unload));
 822     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, load));
 823     break;
 824   case JVMTI_VERBOSE_GC:
 825     LogConfiguration::configure_stdout(level, true, LOG_TAGS(gc));
 826     break;
 827   case JVMTI_VERBOSE_JNI:
 828     level = value == 0 ? LogLevel::Off : LogLevel::Debug;
 829     LogConfiguration::configure_stdout(level, true, LOG_TAGS(jni, resolve));
 830     break;
 831   default:
 832     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 833   };
 834   return JVMTI_ERROR_NONE;
 835 } /* end SetVerboseFlag */
 836 
 837 
 838 // format_ptr - pre-checked for NULL
 839 jvmtiError
 840 JvmtiEnv::GetJLocationFormat(jvmtiJlocationFormat* format_ptr) {
 841   *format_ptr = JVMTI_JLOCATION_JVMBCI;
 842   return JVMTI_ERROR_NONE;
 843 } /* end GetJLocationFormat */
 844 
 845   //
 846   // Thread functions
 847   //
 848 
 849 // Threads_lock NOT held
 850 // thread - NOT pre-checked
 851 // thread_state_ptr - pre-checked for NULL
 852 jvmtiError
 853 JvmtiEnv::GetThreadState(jthread thread, jint* thread_state_ptr) {
 854   JavaThread* current_thread = JavaThread::current();
 855   JavaThread* java_thread = NULL;
 856   oop thread_oop = NULL;
 857   ThreadsListHandle tlh(current_thread);
 858 
 859   if (thread == NULL) {
 860     java_thread = current_thread;
 861     thread_oop = java_thread-&gt;threadObj();
 862 
 863     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
 864       return JVMTI_ERROR_INVALID_THREAD;
 865     }
 866   } else {
 867     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
 868     if (err != JVMTI_ERROR_NONE) {
 869       // We got an error code so we don&#39;t have a JavaThread *, but
 870       // only return an error from here if we didn&#39;t get a valid
 871       // thread_oop.
 872       if (thread_oop == NULL) {
 873         return err;
 874       }
 875       // We have a valid thread_oop so we can return some thread state.
 876     }
 877   }
 878 
 879   // get most state bits
 880   jint state = (jint)java_lang_Thread::get_thread_status(thread_oop);
 881 
 882   if (java_thread != NULL) {
 883     // We have a JavaThread* so add more state bits.
 884     JavaThreadState jts = java_thread-&gt;thread_state();
 885 
 886     if (java_thread-&gt;is_being_ext_suspended()) {
 887       state |= JVMTI_THREAD_STATE_SUSPENDED;
 888     }
 889     if (jts == _thread_in_native) {
 890       state |= JVMTI_THREAD_STATE_IN_NATIVE;
 891     }
 892     if (java_thread-&gt;is_interrupted(false)) {
 893       state |= JVMTI_THREAD_STATE_INTERRUPTED;
 894     }
 895   }
 896 
 897   *thread_state_ptr = state;
 898   return JVMTI_ERROR_NONE;
 899 } /* end GetThreadState */
 900 
 901 
 902 // thread_ptr - pre-checked for NULL
 903 jvmtiError
 904 JvmtiEnv::GetCurrentThread(jthread* thread_ptr) {
 905   JavaThread* current_thread  = JavaThread::current();
 906   *thread_ptr = (jthread)JNIHandles::make_local(current_thread, current_thread-&gt;threadObj());
 907   return JVMTI_ERROR_NONE;
 908 } /* end GetCurrentThread */
 909 
 910 
 911 // threads_count_ptr - pre-checked for NULL
 912 // threads_ptr - pre-checked for NULL
 913 jvmtiError
 914 JvmtiEnv::GetAllThreads(jint* threads_count_ptr, jthread** threads_ptr) {
 915   int nthreads        = 0;
 916   Handle *thread_objs = NULL;
 917   Thread* current_thread = Thread::current();
 918   ResourceMark rm(current_thread);
 919   HandleMark hm(current_thread);
 920 
 921   // enumerate threads (including agent threads)
 922   ThreadsListEnumerator tle(current_thread, true);
 923   nthreads = tle.num_threads();
 924   *threads_count_ptr = nthreads;
 925 
 926   if (nthreads == 0) {
 927     *threads_ptr = NULL;
 928     return JVMTI_ERROR_NONE;
 929   }
 930 
 931   thread_objs = NEW_RESOURCE_ARRAY(Handle, nthreads);
 932   NULL_CHECK(thread_objs, JVMTI_ERROR_OUT_OF_MEMORY);
 933 
 934   for (int i = 0; i &lt; nthreads; i++) {
 935     thread_objs[i] = Handle(tle.get_threadObj(i));
 936   }
 937 
 938   jthread *jthreads  = new_jthreadArray(nthreads, thread_objs);
 939   NULL_CHECK(jthreads, JVMTI_ERROR_OUT_OF_MEMORY);
 940 
 941   *threads_ptr = jthreads;
 942   return JVMTI_ERROR_NONE;
 943 } /* end GetAllThreads */
 944 
 945 
 946 // Threads_lock NOT held, java_thread not protected by lock
 947 // java_thread - pre-checked
 948 jvmtiError
 949 JvmtiEnv::SuspendThread(JavaThread* java_thread) {
 950   // don&#39;t allow hidden thread suspend request.
 951   if (java_thread-&gt;is_hidden_from_external_view()) {
 952     return (JVMTI_ERROR_NONE);
 953   }
 954 
 955   {
 956     MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
 957     if (java_thread-&gt;is_external_suspend()) {
 958       // don&#39;t allow nested external suspend requests.
 959       return (JVMTI_ERROR_THREAD_SUSPENDED);
 960     }
 961     if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
 962       return (JVMTI_ERROR_THREAD_NOT_ALIVE);
 963     }
 964     java_thread-&gt;set_external_suspend();
 965   }
 966 
 967   if (!JvmtiSuspendControl::suspend(java_thread)) {
 968     // the thread was in the process of exiting
 969     return (JVMTI_ERROR_THREAD_NOT_ALIVE);
 970   }
 971   return JVMTI_ERROR_NONE;
 972 } /* end SuspendThread */
 973 
 974 
 975 // request_count - pre-checked to be greater than or equal to 0
 976 // request_list - pre-checked for NULL
 977 // results - pre-checked for NULL
 978 jvmtiError
 979 JvmtiEnv::SuspendThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
 980   int needSafepoint = 0;  // &gt; 0 if we need a safepoint
 981   ThreadsListHandle tlh;
 982   for (int i = 0; i &lt; request_count; i++) {
 983     JavaThread *java_thread = NULL;
 984     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
 985     if (err != JVMTI_ERROR_NONE) {
 986       results[i] = err;
 987       continue;
 988     }
 989     // don&#39;t allow hidden thread suspend request.
 990     if (java_thread-&gt;is_hidden_from_external_view()) {
 991       results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
 992       continue;
 993     }
 994 
 995     {
 996       MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
 997       if (java_thread-&gt;is_external_suspend()) {
 998         // don&#39;t allow nested external suspend requests.
 999         results[i] = JVMTI_ERROR_THREAD_SUSPENDED;
1000         continue;
1001       }
1002       if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
1003         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1004         continue;
1005       }
1006       java_thread-&gt;set_external_suspend();
1007     }
1008     if (java_thread-&gt;thread_state() == _thread_in_native) {
1009       // We need to try and suspend native threads here. Threads in
1010       // other states will self-suspend on their next transition.
1011       if (!JvmtiSuspendControl::suspend(java_thread)) {
1012         // The thread was in the process of exiting. Force another
1013         // safepoint to make sure that this thread transitions.
1014         needSafepoint++;
1015         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1016         continue;
1017       }
1018     } else {
1019       needSafepoint++;
1020     }
1021     results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
1022   }
1023   if (needSafepoint &gt; 0) {
1024     VM_ThreadsSuspendJVMTI tsj;
1025     VMThread::execute(&amp;tsj);
1026   }
1027   // per-thread suspend results returned via results parameter
1028   return JVMTI_ERROR_NONE;
1029 } /* end SuspendThreadList */
1030 
1031 
1032 // Threads_lock NOT held, java_thread not protected by lock
1033 // java_thread - pre-checked
1034 jvmtiError
1035 JvmtiEnv::ResumeThread(JavaThread* java_thread) {
1036   // don&#39;t allow hidden thread resume request.
1037   if (java_thread-&gt;is_hidden_from_external_view()) {
1038     return JVMTI_ERROR_NONE;
1039   }
1040 
1041   if (!java_thread-&gt;is_being_ext_suspended()) {
1042     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1043   }
1044 
1045   if (!JvmtiSuspendControl::resume(java_thread)) {
1046     return JVMTI_ERROR_INTERNAL;
1047   }
1048   return JVMTI_ERROR_NONE;
1049 } /* end ResumeThread */
1050 
1051 
1052 // request_count - pre-checked to be greater than or equal to 0
1053 // request_list - pre-checked for NULL
1054 // results - pre-checked for NULL
1055 jvmtiError
1056 JvmtiEnv::ResumeThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
1057   ThreadsListHandle tlh;
1058   for (int i = 0; i &lt; request_count; i++) {
1059     JavaThread* java_thread = NULL;
1060     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
1061     if (err != JVMTI_ERROR_NONE) {
1062       results[i] = err;
1063       continue;
1064     }
1065     // don&#39;t allow hidden thread resume request.
1066     if (java_thread-&gt;is_hidden_from_external_view()) {
1067       results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1068       continue;
1069     }
1070     if (!java_thread-&gt;is_being_ext_suspended()) {
1071       results[i] = JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1072       continue;
1073     }
1074 
1075     if (!JvmtiSuspendControl::resume(java_thread)) {
1076       results[i] = JVMTI_ERROR_INTERNAL;
1077       continue;
1078     }
1079 
1080     results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1081   }
1082   // per-thread resume results returned via results parameter
1083   return JVMTI_ERROR_NONE;
1084 } /* end ResumeThreadList */
1085 
1086 
1087 // Threads_lock NOT held, java_thread not protected by lock
1088 // java_thread - pre-checked
1089 jvmtiError
1090 JvmtiEnv::StopThread(JavaThread* java_thread, jobject exception) {
1091   oop e = JNIHandles::resolve_external_guard(exception);
1092   NULL_CHECK(e, JVMTI_ERROR_NULL_POINTER);
1093 
1094   JavaThread::send_async_exception(java_thread-&gt;threadObj(), e);
1095 
1096   return JVMTI_ERROR_NONE;
1097 
1098 } /* end StopThread */
1099 
1100 
1101 // Threads_lock NOT held
1102 // thread - NOT pre-checked
1103 jvmtiError
1104 JvmtiEnv::InterruptThread(jthread thread) {
1105   JavaThread* current_thread  = JavaThread::current();
1106   JavaThread* java_thread = NULL;
1107   ThreadsListHandle tlh(current_thread);
1108   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
1109   if (err != JVMTI_ERROR_NONE) {
1110     return err;
1111   }
1112   // Really this should be a Java call to Thread.interrupt to ensure the same
1113   // semantics, however historically this has not been done for some reason.
1114   // So we continue with that (which means we don&#39;t interact with any Java-level
1115   // Interruptible object) but we must set the Java-level interrupted state.
1116   java_lang_Thread::set_interrupted(JNIHandles::resolve(thread), true);
1117   java_thread-&gt;interrupt();
1118 
1119   return JVMTI_ERROR_NONE;
1120 } /* end InterruptThread */
1121 
1122 
1123 // Threads_lock NOT held
1124 // thread - NOT pre-checked
1125 // info_ptr - pre-checked for NULL
1126 jvmtiError
1127 JvmtiEnv::GetThreadInfo(jthread thread, jvmtiThreadInfo* info_ptr) {
1128   JavaThread* current_thread = JavaThread::current();
1129   ResourceMark rm(current_thread);
1130   HandleMark hm(current_thread);
1131 
1132   ThreadsListHandle tlh(current_thread);
1133 
1134   // if thread is NULL the current thread is used
1135   oop thread_oop = NULL;
1136   if (thread == NULL) {
1137     thread_oop = current_thread-&gt;threadObj();
1138     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
1139       return JVMTI_ERROR_INVALID_THREAD;
1140     }
1141   } else {
1142     JavaThread* java_thread = NULL;
1143     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1144     if (err != JVMTI_ERROR_NONE) {
1145       // We got an error code so we don&#39;t have a JavaThread *, but
1146       // only return an error from here if we didn&#39;t get a valid
1147       // thread_oop.
1148       if (thread_oop == NULL) {
1149         return err;
1150       }
1151       // We have a valid thread_oop so we can return some thread info.
1152     }
1153   }
1154 
1155   Handle thread_obj(current_thread, thread_oop);
1156   Handle name;
1157   ThreadPriority priority;
1158   Handle     thread_group;
1159   Handle context_class_loader;
1160   bool          is_daemon;
1161 
1162   name = Handle(current_thread, java_lang_Thread::name(thread_obj()));
1163   priority = java_lang_Thread::priority(thread_obj());
1164   thread_group = Handle(current_thread, java_lang_Thread::threadGroup(thread_obj()));
1165   is_daemon = java_lang_Thread::is_daemon(thread_obj());
1166 
1167   oop loader = java_lang_Thread::context_class_loader(thread_obj());
1168   context_class_loader = Handle(current_thread, loader);
1169 
1170   { const char *n;
1171 
1172     if (name() != NULL) {
1173       n = java_lang_String::as_utf8_string(name());
1174     } else {
1175       int utf8_length = 0;
1176       n = UNICODE::as_utf8((jchar*) NULL, utf8_length);
1177     }
1178 
1179     info_ptr-&gt;name = (char *) jvmtiMalloc(strlen(n)+1);
1180     if (info_ptr-&gt;name == NULL)
1181       return JVMTI_ERROR_OUT_OF_MEMORY;
1182 
1183     strcpy(info_ptr-&gt;name, n);
1184   }
1185   info_ptr-&gt;is_daemon = is_daemon;
1186   info_ptr-&gt;priority  = priority;
1187 
1188   info_ptr-&gt;context_class_loader = (context_class_loader.is_null()) ? NULL :
1189                                      jni_reference(context_class_loader);
1190   info_ptr-&gt;thread_group = jni_reference(thread_group);
1191 
1192   return JVMTI_ERROR_NONE;
1193 } /* end GetThreadInfo */
1194 
1195 
1196 // Threads_lock NOT held, java_thread not protected by lock
1197 // java_thread - pre-checked
1198 // owned_monitor_count_ptr - pre-checked for NULL
1199 // owned_monitors_ptr - pre-checked for NULL
1200 jvmtiError
1201 JvmtiEnv::GetOwnedMonitorInfo(JavaThread* java_thread, jint* owned_monitor_count_ptr, jobject** owned_monitors_ptr) {
1202   jvmtiError err = JVMTI_ERROR_NONE;
1203   JavaThread* calling_thread = JavaThread::current();
1204 
1205   // growable array of jvmti monitors info on the C-heap
1206   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1207       new (ResourceObj::C_HEAP, mtServiceability) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, mtServiceability);
1208 
1209   // It is only safe to perform the direct operation on the current
1210   // thread. All other usage needs to use a direct handshake for safety.
1211   if (java_thread == calling_thread) {
1212     err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1213   } else {
1214     // get owned monitors info with handshake
1215     GetOwnedMonitorInfoClosure op(calling_thread, this, owned_monitors_list);
1216     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1217     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1218   }
1219   jint owned_monitor_count = owned_monitors_list-&gt;length();
1220   if (err == JVMTI_ERROR_NONE) {
1221     if ((err = allocate(owned_monitor_count * sizeof(jobject *),
1222                       (unsigned char**)owned_monitors_ptr)) == JVMTI_ERROR_NONE) {
1223       // copy into the returned array
1224       for (int i = 0; i &lt; owned_monitor_count; i++) {
1225         (*owned_monitors_ptr)[i] =
1226           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1227       }
1228       *owned_monitor_count_ptr = owned_monitor_count;
1229     }
1230   }
1231   // clean up.
1232   for (int i = 0; i &lt; owned_monitor_count; i++) {
1233     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1234   }
1235   delete owned_monitors_list;
1236 
1237   return err;
1238 } /* end GetOwnedMonitorInfo */
1239 
1240 
1241 // Threads_lock NOT held, java_thread not protected by lock
1242 // java_thread - pre-checked
1243 // monitor_info_count_ptr - pre-checked for NULL
1244 // monitor_info_ptr - pre-checked for NULL
1245 jvmtiError
1246 JvmtiEnv::GetOwnedMonitorStackDepthInfo(JavaThread* java_thread, jint* monitor_info_count_ptr, jvmtiMonitorStackDepthInfo** monitor_info_ptr) {
1247   jvmtiError err = JVMTI_ERROR_NONE;
1248   JavaThread* calling_thread = JavaThread::current();
1249 
1250   // growable array of jvmti monitors info on the C-heap
1251   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1252          new (ResourceObj::C_HEAP, mtServiceability) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, mtServiceability);
1253 
1254   // It is only safe to perform the direct operation on the current
1255   // thread. All other usage needs to use a direct handshake for safety.
1256   if (java_thread == calling_thread) {
1257     err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1258   } else {
1259     // get owned monitors info with handshake
1260     GetOwnedMonitorInfoClosure op(calling_thread, this, owned_monitors_list);
1261     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1262     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1263   }
1264 
1265   jint owned_monitor_count = owned_monitors_list-&gt;length();
1266   if (err == JVMTI_ERROR_NONE) {
1267     if ((err = allocate(owned_monitor_count * sizeof(jvmtiMonitorStackDepthInfo),
1268                       (unsigned char**)monitor_info_ptr)) == JVMTI_ERROR_NONE) {
1269       // copy to output array.
1270       for (int i = 0; i &lt; owned_monitor_count; i++) {
1271         (*monitor_info_ptr)[i].monitor =
1272           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1273         (*monitor_info_ptr)[i].stack_depth =
1274           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;stack_depth;
1275       }
1276     }
1277     *monitor_info_count_ptr = owned_monitor_count;
1278   }
1279 
1280   // clean up.
1281   for (int i = 0; i &lt; owned_monitor_count; i++) {
1282     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1283   }
1284   delete owned_monitors_list;
1285 
1286   return err;
1287 } /* end GetOwnedMonitorStackDepthInfo */
1288 
1289 
1290 // Threads_lock NOT held, java_thread not protected by lock
1291 // java_thread - pre-checked
1292 // monitor_ptr - pre-checked for NULL
1293 jvmtiError
1294 JvmtiEnv::GetCurrentContendedMonitor(JavaThread* java_thread, jobject* monitor_ptr) {
1295   jvmtiError err = JVMTI_ERROR_NONE;
1296   JavaThread* calling_thread = JavaThread::current();
1297 
1298   // It is only safe to perform the direct operation on the current
1299   // thread. All other usage needs to use a direct handshake for safety.
1300   if (java_thread == calling_thread) {
1301     err = get_current_contended_monitor(calling_thread, java_thread, monitor_ptr);
1302   } else {
1303     // get contended monitor information with handshake
1304     GetCurrentContendedMonitorClosure op(calling_thread, this, monitor_ptr);
1305     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1306     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1307   }
1308   return err;
1309 } /* end GetCurrentContendedMonitor */
1310 
1311 
1312 // Threads_lock NOT held
1313 // thread - NOT pre-checked
1314 // proc - pre-checked for NULL
1315 // arg - NULL is a valid value, must be checked
1316 jvmtiError
1317 JvmtiEnv::RunAgentThread(jthread thread, jvmtiStartFunction proc, const void* arg, jint priority) {
1318   JavaThread* current_thread = JavaThread::current();
1319 
1320   JavaThread* java_thread = NULL;
1321   oop thread_oop = NULL;
1322   ThreadsListHandle tlh(current_thread);
1323   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1324   if (err != JVMTI_ERROR_NONE) {
1325     // We got an error code so we don&#39;t have a JavaThread *, but
1326     // only return an error from here if we didn&#39;t get a valid
1327     // thread_oop.
1328     if (thread_oop == NULL) {
1329       return err;
1330     }
1331     // We have a valid thread_oop.
1332   }
1333 
1334   if (java_thread != NULL) {
1335     // &#39;thread&#39; refers to an existing JavaThread.
1336     return JVMTI_ERROR_INVALID_THREAD;
1337   }
1338 
1339   if (priority &lt; JVMTI_THREAD_MIN_PRIORITY || priority &gt; JVMTI_THREAD_MAX_PRIORITY) {
1340     return JVMTI_ERROR_INVALID_PRIORITY;
1341   }
1342 
1343   Handle thread_hndl(current_thread, thread_oop);
1344   {
1345     MutexLocker mu(current_thread, Threads_lock); // grab Threads_lock
1346 
1347     JvmtiAgentThread *new_thread = new JvmtiAgentThread(this, proc, arg);
1348 
1349     // At this point it may be possible that no osthread was created for the
1350     // JavaThread due to lack of memory.
1351     if (new_thread == NULL || new_thread-&gt;osthread() == NULL) {
1352       if (new_thread != NULL) {
1353         new_thread-&gt;smr_delete();
1354       }
1355       return JVMTI_ERROR_OUT_OF_MEMORY;
1356     }
1357 
1358     java_lang_Thread::set_thread(thread_hndl(), new_thread);
1359     java_lang_Thread::set_priority(thread_hndl(), (ThreadPriority)priority);
1360     java_lang_Thread::set_daemon(thread_hndl());
1361 
1362     new_thread-&gt;set_threadObj(thread_hndl());
1363     Threads::add(new_thread);
1364     Thread::start(new_thread);
1365   } // unlock Threads_lock
1366 
1367   return JVMTI_ERROR_NONE;
1368 } /* end RunAgentThread */
1369 
1370   //
1371   // Thread Group functions
1372   //
1373 
1374 // group_count_ptr - pre-checked for NULL
1375 // groups_ptr - pre-checked for NULL
1376 jvmtiError
1377 JvmtiEnv::GetTopThreadGroups(jint* group_count_ptr, jthreadGroup** groups_ptr) {
1378   JavaThread* current_thread = JavaThread::current();
1379 
1380   // Only one top level thread group now.
1381   *group_count_ptr = 1;
1382 
1383   // Allocate memory to store global-refs to the thread groups.
1384   // Assume this area is freed by caller.
1385   *groups_ptr = (jthreadGroup *) jvmtiMalloc((sizeof(jthreadGroup)) * (*group_count_ptr));
1386 
1387   NULL_CHECK(*groups_ptr, JVMTI_ERROR_OUT_OF_MEMORY);
1388 
1389   // Convert oop to Handle, then convert Handle to global-ref.
1390   {
1391     HandleMark hm(current_thread);
1392     Handle system_thread_group(current_thread, Universe::system_thread_group());
1393     *groups_ptr[0] = jni_reference(system_thread_group);
1394   }
1395 
1396   return JVMTI_ERROR_NONE;
1397 } /* end GetTopThreadGroups */
1398 
1399 
1400 // info_ptr - pre-checked for NULL
1401 jvmtiError
1402 JvmtiEnv::GetThreadGroupInfo(jthreadGroup group, jvmtiThreadGroupInfo* info_ptr) {
1403   Thread* current_thread = Thread::current();
1404   ResourceMark rm(current_thread);
1405   HandleMark hm(current_thread);
1406 
1407   Handle group_obj (current_thread, JNIHandles::resolve_external_guard(group));
1408   NULL_CHECK(group_obj(), JVMTI_ERROR_INVALID_THREAD_GROUP);
1409 
1410   const char* name;
1411   Handle parent_group;
1412   bool is_daemon;
1413   ThreadPriority max_priority;
1414 
1415   name         = java_lang_ThreadGroup::name(group_obj());
1416   parent_group = Handle(current_thread, java_lang_ThreadGroup::parent(group_obj()));
1417   is_daemon    = java_lang_ThreadGroup::is_daemon(group_obj());
1418   max_priority = java_lang_ThreadGroup::maxPriority(group_obj());
1419 
1420   info_ptr-&gt;is_daemon    = is_daemon;
1421   info_ptr-&gt;max_priority = max_priority;
1422   info_ptr-&gt;parent       = jni_reference(parent_group);
1423 
1424   if (name != NULL) {
1425     info_ptr-&gt;name = (char*)jvmtiMalloc(strlen(name)+1);
1426     NULL_CHECK(info_ptr-&gt;name, JVMTI_ERROR_OUT_OF_MEMORY);
1427     strcpy(info_ptr-&gt;name, name);
1428   } else {
1429     info_ptr-&gt;name = NULL;
1430   }
1431 
1432   return JVMTI_ERROR_NONE;
1433 } /* end GetThreadGroupInfo */
1434 
1435 
1436 // thread_count_ptr - pre-checked for NULL
1437 // threads_ptr - pre-checked for NULL
1438 // group_count_ptr - pre-checked for NULL
1439 // groups_ptr - pre-checked for NULL
1440 jvmtiError
1441 JvmtiEnv::GetThreadGroupChildren(jthreadGroup group, jint* thread_count_ptr, jthread** threads_ptr, jint* group_count_ptr, jthreadGroup** groups_ptr) {
1442   JavaThread* current_thread = JavaThread::current();
1443   oop group_obj = (oop) JNIHandles::resolve_external_guard(group);
1444   NULL_CHECK(group_obj, JVMTI_ERROR_INVALID_THREAD_GROUP);
1445 
1446   Handle *thread_objs = NULL;
1447   Handle *group_objs  = NULL;
1448   int nthreads = 0;
1449   int ngroups = 0;
1450   int hidden_threads = 0;
1451 
1452   ResourceMark rm(current_thread);
1453   HandleMark hm(current_thread);
1454 
1455   Handle group_hdl(current_thread, group_obj);
1456 
1457   { // Cannot allow thread or group counts to change.
1458     ObjectLocker ol(group_hdl, current_thread);
1459 
1460     nthreads = java_lang_ThreadGroup::nthreads(group_hdl());
1461     ngroups  = java_lang_ThreadGroup::ngroups(group_hdl());
1462 
1463     if (nthreads &gt; 0) {
1464       ThreadsListHandle tlh(current_thread);
1465       objArrayOop threads = java_lang_ThreadGroup::threads(group_hdl());
1466       assert(nthreads &lt;= threads-&gt;length(), &quot;too many threads&quot;);
1467       thread_objs = NEW_RESOURCE_ARRAY(Handle,nthreads);
1468       for (int i = 0, j = 0; i &lt; nthreads; i++) {
1469         oop thread_obj = threads-&gt;obj_at(i);
1470         assert(thread_obj != NULL, &quot;thread_obj is NULL&quot;);
1471         JavaThread *java_thread = NULL;
1472         jvmtiError err = JvmtiExport::cv_oop_to_JavaThread(tlh.list(), thread_obj, &amp;java_thread);
1473         if (err == JVMTI_ERROR_NONE) {
1474           // Have a valid JavaThread*.
1475           if (java_thread-&gt;is_hidden_from_external_view()) {
1476             // Filter out hidden java threads.
1477             hidden_threads++;
1478             continue;
1479           }
1480         } else {
1481           // We couldn&#39;t convert thread_obj into a JavaThread*.
1482           if (err == JVMTI_ERROR_INVALID_THREAD) {
1483             // The thread_obj does not refer to a java.lang.Thread object
1484             // so skip it.
1485             hidden_threads++;
1486             continue;
1487           }
1488           // We have a valid thread_obj, but no JavaThread*; the caller
1489           // can still have limited use for the thread_obj.
1490         }
1491         thread_objs[j++] = Handle(current_thread, thread_obj);
1492       }
1493       nthreads -= hidden_threads;
1494     } // ThreadsListHandle is destroyed here.
1495 
1496     if (ngroups &gt; 0) {
1497       objArrayOop groups = java_lang_ThreadGroup::groups(group_hdl());
1498       assert(ngroups &lt;= groups-&gt;length(), &quot;too many groups&quot;);
1499       group_objs = NEW_RESOURCE_ARRAY(Handle,ngroups);
1500       for (int i = 0; i &lt; ngroups; i++) {
1501         oop group_obj = groups-&gt;obj_at(i);
1502         assert(group_obj != NULL, &quot;group_obj != NULL&quot;);
1503         group_objs[i] = Handle(current_thread, group_obj);
1504       }
1505     }
1506   } // ThreadGroup unlocked here
1507 
1508   *group_count_ptr  = ngroups;
1509   *thread_count_ptr = nthreads;
1510   *threads_ptr     = new_jthreadArray(nthreads, thread_objs);
1511   *groups_ptr      = new_jthreadGroupArray(ngroups, group_objs);
1512   if ((nthreads &gt; 0) &amp;&amp; (*threads_ptr == NULL)) {
1513     return JVMTI_ERROR_OUT_OF_MEMORY;
1514   }
1515   if ((ngroups &gt; 0) &amp;&amp; (*groups_ptr == NULL)) {
1516     return JVMTI_ERROR_OUT_OF_MEMORY;
1517   }
1518 
1519   return JVMTI_ERROR_NONE;
1520 } /* end GetThreadGroupChildren */
1521 
1522 
1523   //
1524   // Stack Frame functions
1525   //
1526 
1527 // Threads_lock NOT held, java_thread not protected by lock
1528 // java_thread - pre-checked
1529 // max_frame_count - pre-checked to be greater than or equal to 0
1530 // frame_buffer - pre-checked for NULL
1531 // count_ptr - pre-checked for NULL
1532 jvmtiError
1533 JvmtiEnv::GetStackTrace(JavaThread* java_thread, jint start_depth, jint max_frame_count, jvmtiFrameInfo* frame_buffer, jint* count_ptr) {
1534   jvmtiError err = JVMTI_ERROR_NONE;
1535 
1536   // It is only safe to perform the direct operation on the current
1537   // thread. All other usage needs to use a direct handshake for safety.
1538   if (java_thread == JavaThread::current()) {
1539     err = get_stack_trace(java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1540   } else {
1541     // Get stack trace with handshake.
1542     GetStackTraceClosure op(this, start_depth, max_frame_count, frame_buffer, count_ptr);
1543     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1544     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1545   }
1546 
1547   return err;
1548 } /* end GetStackTrace */
1549 
1550 
1551 // max_frame_count - pre-checked to be greater than or equal to 0
1552 // stack_info_ptr - pre-checked for NULL
1553 // thread_count_ptr - pre-checked for NULL
1554 jvmtiError
1555 JvmtiEnv::GetAllStackTraces(jint max_frame_count, jvmtiStackInfo** stack_info_ptr, jint* thread_count_ptr) {
1556   jvmtiError err = JVMTI_ERROR_NONE;
1557   JavaThread* calling_thread = JavaThread::current();
1558 
1559   // JVMTI get stack traces at safepoint.
1560   VM_GetAllStackTraces op(this, calling_thread, max_frame_count);
1561   VMThread::execute(&amp;op);
1562   *thread_count_ptr = op.final_thread_count();
1563   *stack_info_ptr = op.stack_info();
1564   err = op.result();
1565   return err;
1566 } /* end GetAllStackTraces */
1567 
1568 
1569 // thread_count - pre-checked to be greater than or equal to 0
1570 // thread_list - pre-checked for NULL
1571 // max_frame_count - pre-checked to be greater than or equal to 0
1572 // stack_info_ptr - pre-checked for NULL
1573 jvmtiError
1574 JvmtiEnv::GetThreadListStackTraces(jint thread_count, const jthread* thread_list, jint max_frame_count, jvmtiStackInfo** stack_info_ptr) {
1575   jvmtiError err = JVMTI_ERROR_NONE;
1576 
1577   if (thread_count == 1) {
1578     // Use direct handshake if we need to get only one stack trace.
1579     JavaThread *current_thread = JavaThread::current();
1580     ThreadsListHandle tlh(current_thread);
1581     JavaThread *java_thread;
1582     err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), *thread_list, &amp;java_thread, NULL);
1583     if (err != JVMTI_ERROR_NONE) {
1584       return err;
1585     }
1586 
1587     GetSingleStackTraceClosure op(this, current_thread, *thread_list, max_frame_count);
1588     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1589     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1590     if (err == JVMTI_ERROR_NONE) {
1591       *stack_info_ptr = op.stack_info();
1592     }
1593   } else {
1594     // JVMTI get stack traces at safepoint.
1595     VM_GetThreadListStackTraces op(this, thread_count, thread_list, max_frame_count);
1596     VMThread::execute(&amp;op);
1597     err = op.result();
1598     if (err == JVMTI_ERROR_NONE) {
1599       *stack_info_ptr = op.stack_info();
1600     }
1601   }
1602   return err;
1603 } /* end GetThreadListStackTraces */
1604 
1605 
1606 // Threads_lock NOT held, java_thread not protected by lock
1607 // java_thread - pre-checked
1608 // count_ptr - pre-checked for NULL
1609 jvmtiError
1610 JvmtiEnv::GetFrameCount(JavaThread* java_thread, jint* count_ptr) {
1611   jvmtiError err = JVMTI_ERROR_NONE;
1612 
1613   // retrieve or create JvmtiThreadState.
1614   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1615   if (state == NULL) {
1616     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1617   }
1618 
1619   // It is only safe to perform the direct operation on the current
1620   // thread. All other usage needs to use a direct handshake for safety.
1621   if (java_thread == JavaThread::current()) {
1622     err = get_frame_count(state, count_ptr);
1623   } else {
1624     // get java stack frame count with handshake.
1625     GetFrameCountClosure op(this, state, count_ptr);
1626     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1627     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1628   }
1629   return err;
1630 } /* end GetFrameCount */
1631 
1632 
1633 // Threads_lock NOT held, java_thread not protected by lock
1634 // java_thread - pre-checked
1635 jvmtiError
1636 JvmtiEnv::PopFrame(JavaThread* java_thread) {
1637   JavaThread* current_thread  = JavaThread::current();
1638   HandleMark hm(current_thread);
1639   uint32_t debug_bits = 0;
1640 
1641   // retrieve or create the state
1642   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1643   if (state == NULL) {
1644     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1645   }
1646 
1647   // Check if java_thread is fully suspended
1648   if (!java_thread-&gt;is_thread_fully_suspended(true /* wait for suspend completion */, &amp;debug_bits)) {
1649     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1650   }
1651   // Check to see if a PopFrame was already in progress
1652   if (java_thread-&gt;popframe_condition() != JavaThread::popframe_inactive) {
1653     // Probably possible for JVMTI clients to trigger this, but the
1654     // JPDA backend shouldn&#39;t allow this to happen
1655     return JVMTI_ERROR_INTERNAL;
1656   }
1657 
1658   {
1659     // Was workaround bug
1660     //    4812902: popFrame hangs if the method is waiting at a synchronize
1661     // Catch this condition and return an error to avoid hanging.
1662     // Now JVMTI spec allows an implementation to bail out with an opaque frame error.
1663     OSThread* osThread = java_thread-&gt;osthread();
1664     if (osThread-&gt;get_state() == MONITOR_WAIT) {
1665       return JVMTI_ERROR_OPAQUE_FRAME;
1666     }
1667   }
1668 
1669   {
1670     ResourceMark rm(current_thread);
1671     // Check if there are more than one Java frame in this thread, that the top two frames
1672     // are Java (not native) frames, and that there is no intervening VM frame
1673     int frame_count = 0;
1674     bool is_interpreted[2];
1675     intptr_t *frame_sp[2];
1676     // The 2-nd arg of constructor is needed to stop iterating at java entry frame.
1677     for (vframeStream vfs(java_thread, true); !vfs.at_end(); vfs.next()) {
1678       methodHandle mh(current_thread, vfs.method());
1679       if (mh-&gt;is_native()) return(JVMTI_ERROR_OPAQUE_FRAME);
1680       is_interpreted[frame_count] = vfs.is_interpreted_frame();
1681       frame_sp[frame_count] = vfs.frame_id();
1682       if (++frame_count &gt; 1) break;
1683     }
1684     if (frame_count &lt; 2)  {
1685       // We haven&#39;t found two adjacent non-native Java frames on the top.
1686       // There can be two situations here:
1687       //  1. There are no more java frames
1688       //  2. Two top java frames are separated by non-java native frames
1689       if(vframeFor(java_thread, 1) == NULL) {
1690         return JVMTI_ERROR_NO_MORE_FRAMES;
1691       } else {
1692         // Intervening non-java native or VM frames separate java frames.
1693         // Current implementation does not support this. See bug #5031735.
1694         // In theory it is possible to pop frames in such cases.
1695         return JVMTI_ERROR_OPAQUE_FRAME;
1696       }
1697     }
1698 
1699     // If any of the top 2 frames is a compiled one, need to deoptimize it
1700     for (int i = 0; i &lt; 2; i++) {
1701       if (!is_interpreted[i]) {
1702         Deoptimization::deoptimize_frame(java_thread, frame_sp[i]);
1703       }
1704     }
1705 
1706     // Update the thread state to reflect that the top frame is popped
1707     // so that cur_stack_depth is maintained properly and all frameIDs
1708     // are invalidated.
1709     // The current frame will be popped later when the suspended thread
1710     // is resumed and right before returning from VM to Java.
1711     // (see call_VM_base() in assembler_&lt;cpu&gt;.cpp).
1712 
1713     // It&#39;s fine to update the thread state here because no JVMTI events
1714     // shall be posted for this PopFrame.
1715 
1716     // It is only safe to perform the direct operation on the current
1717     // thread. All other usage needs to use a vm-safepoint-op for safety.
1718     if (java_thread == JavaThread::current()) {
1719       state-&gt;update_for_pop_top_frame();
1720     } else {
1721       VM_UpdateForPopTopFrame op(state);
1722       VMThread::execute(&amp;op);
1723       jvmtiError err = op.result();
1724       if (err != JVMTI_ERROR_NONE) {
1725         return err;
1726       }
1727     }
1728 
1729     java_thread-&gt;set_popframe_condition(JavaThread::popframe_pending_bit);
1730     // Set pending step flag for this popframe and it is cleared when next
1731     // step event is posted.
1732     state-&gt;set_pending_step_for_popframe();
1733   }
1734 
1735   return JVMTI_ERROR_NONE;
1736 } /* end PopFrame */
1737 
1738 
1739 // Threads_lock NOT held, java_thread not protected by lock
1740 // java_thread - pre-checked
1741 // java_thread - unchecked
1742 // depth - pre-checked as non-negative
1743 // method_ptr - pre-checked for NULL
1744 // location_ptr - pre-checked for NULL
1745 jvmtiError
1746 JvmtiEnv::GetFrameLocation(JavaThread* java_thread, jint depth, jmethodID* method_ptr, jlocation* location_ptr) {
1747   jvmtiError err = JVMTI_ERROR_NONE;
1748 
1749   // It is only safe to perform the direct operation on the current
1750   // thread. All other usage needs to use a direct handshake for safety.
1751   if (java_thread == JavaThread::current()) {
1752     err = get_frame_location(java_thread, depth, method_ptr, location_ptr);
1753   } else {
1754     // JVMTI get java stack frame location via direct handshake.
1755     GetFrameLocationClosure op(this, depth, method_ptr, location_ptr);
1756     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1757     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1758   }
1759   return err;
1760 } /* end GetFrameLocation */
1761 
1762 
1763 // Threads_lock NOT held, java_thread not protected by lock
1764 // java_thread - pre-checked
1765 // java_thread - unchecked
1766 // depth - pre-checked as non-negative
1767 jvmtiError
1768 JvmtiEnv::NotifyFramePop(JavaThread* java_thread, jint depth) {
1769   jvmtiError err = JVMTI_ERROR_NONE;
1770   ResourceMark rm;
1771   uint32_t debug_bits = 0;
1772 
1773   JvmtiThreadState *state = JvmtiThreadState::state_for(java_thread);
1774   if (state == NULL) {
1775     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1776   }
1777 
1778   if (!java_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
1779     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1780   }
1781 
1782   if (TraceJVMTICalls) {
1783     JvmtiSuspendControl::print();
1784   }
1785 
1786   vframe *vf = vframeFor(java_thread, depth);
1787   if (vf == NULL) {
1788     return JVMTI_ERROR_NO_MORE_FRAMES;
1789   }
1790 
1791   if (!vf-&gt;is_java_frame() || ((javaVFrame*) vf)-&gt;method()-&gt;is_native()) {
1792     return JVMTI_ERROR_OPAQUE_FRAME;
1793   }
1794 
1795   assert(vf-&gt;frame_pointer() != NULL, &quot;frame pointer mustn&#39;t be NULL&quot;);
1796 
1797   // It is only safe to perform the direct operation on the current
1798   // thread. All other usage needs to use a vm-safepoint-op for safety.
1799   if (java_thread == JavaThread::current()) {
1800     int frame_number = state-&gt;count_frames() - depth;
1801     state-&gt;env_thread_state(this)-&gt;set_frame_pop(frame_number);
1802   } else {
1803     VM_SetFramePop op(this, state, depth);
1804     VMThread::execute(&amp;op);
1805     err = op.result();
1806   }
1807   return err;
1808 } /* end NotifyFramePop */
1809 
1810 
1811   //
1812   // Force Early Return functions
1813   //
1814 
1815 // Threads_lock NOT held, java_thread not protected by lock
1816 // java_thread - pre-checked
1817 jvmtiError
1818 JvmtiEnv::ForceEarlyReturnObject(JavaThread* java_thread, jobject value) {
1819   jvalue val;
1820   val.l = value;
1821   return force_early_return(java_thread, val, atos);
1822 } /* end ForceEarlyReturnObject */
1823 
1824 
1825 // Threads_lock NOT held, java_thread not protected by lock
1826 // java_thread - pre-checked
1827 jvmtiError
1828 JvmtiEnv::ForceEarlyReturnInt(JavaThread* java_thread, jint value) {
1829   jvalue val;
1830   val.i = value;
1831   return force_early_return(java_thread, val, itos);
1832 } /* end ForceEarlyReturnInt */
1833 
1834 
1835 // Threads_lock NOT held, java_thread not protected by lock
1836 // java_thread - pre-checked
1837 jvmtiError
1838 JvmtiEnv::ForceEarlyReturnLong(JavaThread* java_thread, jlong value) {
1839   jvalue val;
1840   val.j = value;
1841   return force_early_return(java_thread, val, ltos);
1842 } /* end ForceEarlyReturnLong */
1843 
1844 
1845 // Threads_lock NOT held, java_thread not protected by lock
1846 // java_thread - pre-checked
1847 jvmtiError
1848 JvmtiEnv::ForceEarlyReturnFloat(JavaThread* java_thread, jfloat value) {
1849   jvalue val;
1850   val.f = value;
1851   return force_early_return(java_thread, val, ftos);
1852 } /* end ForceEarlyReturnFloat */
1853 
1854 
1855 // Threads_lock NOT held, java_thread not protected by lock
1856 // java_thread - pre-checked
1857 jvmtiError
1858 JvmtiEnv::ForceEarlyReturnDouble(JavaThread* java_thread, jdouble value) {
1859   jvalue val;
1860   val.d = value;
1861   return force_early_return(java_thread, val, dtos);
1862 } /* end ForceEarlyReturnDouble */
1863 
1864 
1865 // Threads_lock NOT held, java_thread not protected by lock
1866 // java_thread - pre-checked
1867 jvmtiError
1868 JvmtiEnv::ForceEarlyReturnVoid(JavaThread* java_thread) {
1869   jvalue val;
1870   val.j = 0L;
1871   return force_early_return(java_thread, val, vtos);
1872 } /* end ForceEarlyReturnVoid */
1873 
1874 
1875   //
1876   // Heap functions
1877   //
1878 
1879 // klass - NULL is a valid value, must be checked
1880 // initial_object - NULL is a valid value, must be checked
1881 // callbacks - pre-checked for NULL
1882 // user_data - NULL is a valid value, must be checked
1883 jvmtiError
1884 JvmtiEnv::FollowReferences(jint heap_filter, jclass klass, jobject initial_object, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
1885   // check klass if provided
1886   Klass* k = NULL;
1887   if (klass != NULL) {
1888     oop k_mirror = JNIHandles::resolve_external_guard(klass);
1889     if (k_mirror == NULL) {
1890       return JVMTI_ERROR_INVALID_CLASS;
1891     }
1892     if (java_lang_Class::is_primitive(k_mirror)) {
1893       return JVMTI_ERROR_NONE;
1894     }
1895     k = java_lang_Class::as_Klass(k_mirror);
1896     if (klass == NULL) {
1897       return JVMTI_ERROR_INVALID_CLASS;
1898     }
1899   }
1900 
1901   if (initial_object != NULL) {
1902     oop init_obj = JNIHandles::resolve_external_guard(initial_object);
1903     if (init_obj == NULL) {
1904       return JVMTI_ERROR_INVALID_OBJECT;
1905     }
1906   }
1907 
1908   Thread *thread = Thread::current();
1909   HandleMark hm(thread);
1910 
1911   TraceTime t(&quot;FollowReferences&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1912   JvmtiTagMap::tag_map_for(this)-&gt;follow_references(heap_filter, k, initial_object, callbacks, user_data);
1913   return JVMTI_ERROR_NONE;
1914 } /* end FollowReferences */
1915 
1916 
1917 // klass - NULL is a valid value, must be checked
1918 // callbacks - pre-checked for NULL
1919 // user_data - NULL is a valid value, must be checked
1920 jvmtiError
1921 JvmtiEnv::IterateThroughHeap(jint heap_filter, jclass klass, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
1922   // check klass if provided
1923   Klass* k = NULL;
1924   if (klass != NULL) {
1925     oop k_mirror = JNIHandles::resolve_external_guard(klass);
1926     if (k_mirror == NULL) {
1927       return JVMTI_ERROR_INVALID_CLASS;
1928     }
1929     if (java_lang_Class::is_primitive(k_mirror)) {
1930       return JVMTI_ERROR_NONE;
1931     }
1932     k = java_lang_Class::as_Klass(k_mirror);
1933     if (k == NULL) {
1934       return JVMTI_ERROR_INVALID_CLASS;
1935     }
1936   }
1937 
1938   TraceTime t(&quot;IterateThroughHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1939   JvmtiTagMap::tag_map_for(this)-&gt;iterate_through_heap(heap_filter, k, callbacks, user_data);
1940   return JVMTI_ERROR_NONE;
1941 } /* end IterateThroughHeap */
1942 
1943 
1944 // tag_ptr - pre-checked for NULL
1945 jvmtiError
1946 JvmtiEnv::GetTag(jobject object, jlong* tag_ptr) {
1947   oop o = JNIHandles::resolve_external_guard(object);
1948   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1949   *tag_ptr = JvmtiTagMap::tag_map_for(this)-&gt;get_tag(object);
1950   return JVMTI_ERROR_NONE;
1951 } /* end GetTag */
1952 
1953 
1954 jvmtiError
1955 JvmtiEnv::SetTag(jobject object, jlong tag) {
1956   oop o = JNIHandles::resolve_external_guard(object);
1957   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1958   JvmtiTagMap::tag_map_for(this)-&gt;set_tag(object, tag);
1959   return JVMTI_ERROR_NONE;
1960 } /* end SetTag */
1961 
1962 
1963 // tag_count - pre-checked to be greater than or equal to 0
1964 // tags - pre-checked for NULL
1965 // count_ptr - pre-checked for NULL
1966 // object_result_ptr - NULL is a valid value, must be checked
1967 // tag_result_ptr - NULL is a valid value, must be checked
1968 jvmtiError
1969 JvmtiEnv::GetObjectsWithTags(jint tag_count, const jlong* tags, jint* count_ptr, jobject** object_result_ptr, jlong** tag_result_ptr) {
1970   TraceTime t(&quot;GetObjectsWithTags&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1971   return JvmtiTagMap::tag_map_for(this)-&gt;get_objects_with_tags((jlong*)tags, tag_count, count_ptr, object_result_ptr, tag_result_ptr);
1972 } /* end GetObjectsWithTags */
1973 
1974 
1975 jvmtiError
1976 JvmtiEnv::ForceGarbageCollection() {
1977   Universe::heap()-&gt;collect(GCCause::_jvmti_force_gc);
1978   return JVMTI_ERROR_NONE;
1979 } /* end ForceGarbageCollection */
1980 
1981 
1982   //
1983   // Heap (1.0) functions
1984   //
1985 
1986 // object_reference_callback - pre-checked for NULL
1987 // user_data - NULL is a valid value, must be checked
1988 jvmtiError
1989 JvmtiEnv::IterateOverObjectsReachableFromObject(jobject object, jvmtiObjectReferenceCallback object_reference_callback, const void* user_data) {
1990   oop o = JNIHandles::resolve_external_guard(object);
1991   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1992   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_objects_reachable_from_object(object, object_reference_callback, user_data);
1993   return JVMTI_ERROR_NONE;
1994 } /* end IterateOverObjectsReachableFromObject */
1995 
1996 
1997 // heap_root_callback - NULL is a valid value, must be checked
1998 // stack_ref_callback - NULL is a valid value, must be checked
1999 // object_ref_callback - NULL is a valid value, must be checked
2000 // user_data - NULL is a valid value, must be checked
2001 jvmtiError
2002 JvmtiEnv::IterateOverReachableObjects(jvmtiHeapRootCallback heap_root_callback, jvmtiStackReferenceCallback stack_ref_callback, jvmtiObjectReferenceCallback object_ref_callback, const void* user_data) {
2003   TraceTime t(&quot;IterateOverReachableObjects&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2004   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_reachable_objects(heap_root_callback, stack_ref_callback, object_ref_callback, user_data);
2005   return JVMTI_ERROR_NONE;
2006 } /* end IterateOverReachableObjects */
2007 
2008 
2009 // heap_object_callback - pre-checked for NULL
2010 // user_data - NULL is a valid value, must be checked
2011 jvmtiError
2012 JvmtiEnv::IterateOverHeap(jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2013   TraceTime t(&quot;IterateOverHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2014   Thread *thread = Thread::current();
2015   HandleMark hm(thread);
2016   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, NULL, heap_object_callback, user_data);
2017   return JVMTI_ERROR_NONE;
2018 } /* end IterateOverHeap */
2019 
2020 
2021 // k_mirror - may be primitive, this must be checked
2022 // heap_object_callback - pre-checked for NULL
2023 // user_data - NULL is a valid value, must be checked
2024 jvmtiError
2025 JvmtiEnv::IterateOverInstancesOfClass(oop k_mirror, jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2026   if (java_lang_Class::is_primitive(k_mirror)) {
2027     // DO PRIMITIVE CLASS PROCESSING
2028     return JVMTI_ERROR_NONE;
2029   }
2030   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2031   if (klass == NULL) {
2032     return JVMTI_ERROR_INVALID_CLASS;
2033   }
2034   TraceTime t(&quot;IterateOverInstancesOfClass&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2035   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, klass, heap_object_callback, user_data);
2036   return JVMTI_ERROR_NONE;
2037 } /* end IterateOverInstancesOfClass */
2038 
2039 
2040   //
2041   // Local Variable functions
2042   //
2043 
2044 // Threads_lock NOT held, java_thread not protected by lock
2045 // java_thread - pre-checked
2046 // java_thread - unchecked
2047 // depth - pre-checked as non-negative
2048 // value_ptr - pre-checked for NULL
2049 jvmtiError
2050 JvmtiEnv::GetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject* value_ptr) {
2051   JavaThread* current_thread = JavaThread::current();
2052   // rm object is created to clean up the javaVFrame created in
2053   // doit_prologue(), but after doit() is finished with it.
2054   ResourceMark rm(current_thread);
2055 
2056   VM_GetOrSetLocal op(java_thread, current_thread, depth, slot);
2057   VMThread::execute(&amp;op);
2058   jvmtiError err = op.result();
2059   if (err != JVMTI_ERROR_NONE) {
2060     return err;
2061   } else {
2062     *value_ptr = op.value().l;
2063     return JVMTI_ERROR_NONE;
2064   }
2065 } /* end GetLocalObject */
2066 
2067 // Threads_lock NOT held, java_thread not protected by lock
2068 // java_thread - pre-checked
2069 // java_thread - unchecked
2070 // depth - pre-checked as non-negative
2071 // value - pre-checked for NULL
2072 jvmtiError
2073 JvmtiEnv::GetLocalInstance(JavaThread* java_thread, jint depth, jobject* value_ptr){
2074   JavaThread* current_thread = JavaThread::current();
2075   // rm object is created to clean up the javaVFrame created in
2076   // doit_prologue(), but after doit() is finished with it.
2077   ResourceMark rm(current_thread);
2078 
2079   VM_GetReceiver op(java_thread, current_thread, depth);
2080   VMThread::execute(&amp;op);
2081   jvmtiError err = op.result();
2082   if (err != JVMTI_ERROR_NONE) {
2083     return err;
2084   } else {
2085     *value_ptr = op.value().l;
2086     return JVMTI_ERROR_NONE;
2087   }
2088 } /* end GetLocalInstance */
2089 
2090 
2091 // Threads_lock NOT held, java_thread not protected by lock
2092 // java_thread - pre-checked
2093 // java_thread - unchecked
2094 // depth - pre-checked as non-negative
2095 // value_ptr - pre-checked for NULL
2096 jvmtiError
2097 JvmtiEnv::GetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint* value_ptr) {
2098   // rm object is created to clean up the javaVFrame created in
2099   // doit_prologue(), but after doit() is finished with it.
2100   ResourceMark rm;
2101 
2102   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT);
2103   VMThread::execute(&amp;op);
2104   *value_ptr = op.value().i;
2105   return op.result();
2106 } /* end GetLocalInt */
2107 
2108 
2109 // Threads_lock NOT held, java_thread not protected by lock
2110 // java_thread - pre-checked
2111 // java_thread - unchecked
2112 // depth - pre-checked as non-negative
2113 // value_ptr - pre-checked for NULL
2114 jvmtiError
2115 JvmtiEnv::GetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong* value_ptr) {
2116   // rm object is created to clean up the javaVFrame created in
2117   // doit_prologue(), but after doit() is finished with it.
2118   ResourceMark rm;
2119 
2120   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG);
2121   VMThread::execute(&amp;op);
2122   *value_ptr = op.value().j;
2123   return op.result();
2124 } /* end GetLocalLong */
2125 
2126 
2127 // Threads_lock NOT held, java_thread not protected by lock
2128 // java_thread - pre-checked
2129 // java_thread - unchecked
2130 // depth - pre-checked as non-negative
2131 // value_ptr - pre-checked for NULL
2132 jvmtiError
2133 JvmtiEnv::GetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat* value_ptr) {
2134   // rm object is created to clean up the javaVFrame created in
2135   // doit_prologue(), but after doit() is finished with it.
2136   ResourceMark rm;
2137 
2138   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT);
2139   VMThread::execute(&amp;op);
2140   *value_ptr = op.value().f;
2141   return op.result();
2142 } /* end GetLocalFloat */
2143 
2144 
2145 // Threads_lock NOT held, java_thread not protected by lock
2146 // java_thread - pre-checked
2147 // java_thread - unchecked
2148 // depth - pre-checked as non-negative
2149 // value_ptr - pre-checked for NULL
2150 jvmtiError
2151 JvmtiEnv::GetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble* value_ptr) {
2152   // rm object is created to clean up the javaVFrame created in
2153   // doit_prologue(), but after doit() is finished with it.
2154   ResourceMark rm;
2155 
2156   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE);
2157   VMThread::execute(&amp;op);
2158   *value_ptr = op.value().d;
2159   return op.result();
2160 } /* end GetLocalDouble */
2161 
2162 
2163 // Threads_lock NOT held, java_thread not protected by lock
2164 // java_thread - pre-checked
2165 // java_thread - unchecked
2166 // depth - pre-checked as non-negative
2167 jvmtiError
2168 JvmtiEnv::SetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject value) {
2169   // rm object is created to clean up the javaVFrame created in
2170   // doit_prologue(), but after doit() is finished with it.
2171   ResourceMark rm;
2172   jvalue val;
2173   val.l = value;
2174   VM_GetOrSetLocal op(java_thread, depth, slot, T_OBJECT, val);
2175   VMThread::execute(&amp;op);
2176   return op.result();
2177 } /* end SetLocalObject */
2178 
2179 
2180 // Threads_lock NOT held, java_thread not protected by lock
2181 // java_thread - pre-checked
2182 // java_thread - unchecked
2183 // depth - pre-checked as non-negative
2184 jvmtiError
2185 JvmtiEnv::SetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint value) {
2186   // rm object is created to clean up the javaVFrame created in
2187   // doit_prologue(), but after doit() is finished with it.
2188   ResourceMark rm;
2189   jvalue val;
2190   val.i = value;
2191   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT, val);
2192   VMThread::execute(&amp;op);
2193   return op.result();
2194 } /* end SetLocalInt */
2195 
2196 
2197 // Threads_lock NOT held, java_thread not protected by lock
2198 // java_thread - pre-checked
2199 // java_thread - unchecked
2200 // depth - pre-checked as non-negative
2201 jvmtiError
2202 JvmtiEnv::SetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong value) {
2203   // rm object is created to clean up the javaVFrame created in
2204   // doit_prologue(), but after doit() is finished with it.
2205   ResourceMark rm;
2206   jvalue val;
2207   val.j = value;
2208   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG, val);
2209   VMThread::execute(&amp;op);
2210   return op.result();
2211 } /* end SetLocalLong */
2212 
2213 
2214 // Threads_lock NOT held, java_thread not protected by lock
2215 // java_thread - pre-checked
2216 // java_thread - unchecked
2217 // depth - pre-checked as non-negative
2218 jvmtiError
2219 JvmtiEnv::SetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat value) {
2220   // rm object is created to clean up the javaVFrame created in
2221   // doit_prologue(), but after doit() is finished with it.
2222   ResourceMark rm;
2223   jvalue val;
2224   val.f = value;
2225   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT, val);
2226   VMThread::execute(&amp;op);
2227   return op.result();
2228 } /* end SetLocalFloat */
2229 
2230 
2231 // Threads_lock NOT held, java_thread not protected by lock
2232 // java_thread - pre-checked
2233 // java_thread - unchecked
2234 // depth - pre-checked as non-negative
2235 jvmtiError
2236 JvmtiEnv::SetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble value) {
2237   // rm object is created to clean up the javaVFrame created in
2238   // doit_prologue(), but after doit() is finished with it.
2239   ResourceMark rm;
2240   jvalue val;
2241   val.d = value;
2242   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE, val);
2243   VMThread::execute(&amp;op);
2244   return op.result();
2245 } /* end SetLocalDouble */
2246 
2247 
2248   //
2249   // Breakpoint functions
2250   //
2251 
2252 // method - pre-checked for validity, but may be NULL meaning obsolete method
2253 jvmtiError
2254 JvmtiEnv::SetBreakpoint(Method* method, jlocation location) {
2255   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
2256   if (location &lt; 0) {   // simple invalid location check first
2257     return JVMTI_ERROR_INVALID_LOCATION;
2258   }
2259   // verify that the breakpoint is not past the end of the method
2260   if (location &gt;= (jlocation) method-&gt;code_size()) {
2261     return JVMTI_ERROR_INVALID_LOCATION;
2262   }
2263 
2264   ResourceMark rm;
2265   JvmtiBreakpoint bp(method, location);
2266   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2267   if (jvmti_breakpoints.set(bp) == JVMTI_ERROR_DUPLICATE)
2268     return JVMTI_ERROR_DUPLICATE;
2269 
2270   if (TraceJVMTICalls) {
2271     jvmti_breakpoints.print();
2272   }
2273 
2274   return JVMTI_ERROR_NONE;
2275 } /* end SetBreakpoint */
2276 
2277 
2278 // method - pre-checked for validity, but may be NULL meaning obsolete method
2279 jvmtiError
2280 JvmtiEnv::ClearBreakpoint(Method* method, jlocation location) {
2281   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
2282 
2283   if (location &lt; 0) {   // simple invalid location check first
2284     return JVMTI_ERROR_INVALID_LOCATION;
2285   }
2286 
2287   // verify that the breakpoint is not past the end of the method
2288   if (location &gt;= (jlocation) method-&gt;code_size()) {
2289     return JVMTI_ERROR_INVALID_LOCATION;
2290   }
2291 
2292   JvmtiBreakpoint bp(method, location);
2293 
2294   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2295   if (jvmti_breakpoints.clear(bp) == JVMTI_ERROR_NOT_FOUND)
2296     return JVMTI_ERROR_NOT_FOUND;
2297 
2298   if (TraceJVMTICalls) {
2299     jvmti_breakpoints.print();
2300   }
2301 
2302   return JVMTI_ERROR_NONE;
2303 } /* end ClearBreakpoint */
2304 
2305 
2306   //
2307   // Watched Field functions
2308   //
2309 
2310 jvmtiError
2311 JvmtiEnv::SetFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2312   // make sure we haven&#39;t set this watch before
2313   if (fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_DUPLICATE;
2314   fdesc_ptr-&gt;set_is_field_access_watched(true);
2315 
2316   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, true);
2317 
2318   return JVMTI_ERROR_NONE;
2319 } /* end SetFieldAccessWatch */
2320 
2321 
2322 jvmtiError
2323 JvmtiEnv::ClearFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2324   // make sure we have a watch to clear
2325   if (!fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_NOT_FOUND;
2326   fdesc_ptr-&gt;set_is_field_access_watched(false);
2327 
2328   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, false);
2329 
2330   return JVMTI_ERROR_NONE;
2331 } /* end ClearFieldAccessWatch */
2332 
2333 
2334 jvmtiError
2335 JvmtiEnv::SetFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2336   // make sure we haven&#39;t set this watch before
2337   if (fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_DUPLICATE;
2338   fdesc_ptr-&gt;set_is_field_modification_watched(true);
2339 
2340   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, true);
2341 
2342   return JVMTI_ERROR_NONE;
2343 } /* end SetFieldModificationWatch */
2344 
2345 
2346 jvmtiError
2347 JvmtiEnv::ClearFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2348    // make sure we have a watch to clear
2349   if (!fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_NOT_FOUND;
2350   fdesc_ptr-&gt;set_is_field_modification_watched(false);
2351 
2352   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, false);
2353 
2354   return JVMTI_ERROR_NONE;
2355 } /* end ClearFieldModificationWatch */
2356 
2357   //
2358   // Class functions
2359   //
2360 
2361 
2362 // k_mirror - may be primitive, this must be checked
2363 // signature_ptr - NULL is a valid value, must be checked
2364 // generic_ptr - NULL is a valid value, must be checked
2365 jvmtiError
2366 JvmtiEnv::GetClassSignature(oop k_mirror, char** signature_ptr, char** generic_ptr) {
2367   ResourceMark rm;
2368   bool isPrimitive = java_lang_Class::is_primitive(k_mirror);
2369   Klass* k = NULL;
2370   if (!isPrimitive) {
2371     k = java_lang_Class::as_Klass(k_mirror);
2372     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2373   }
2374   if (signature_ptr != NULL) {
2375     char* result = NULL;
2376     if (isPrimitive) {
2377       char tchar = type2char(java_lang_Class::primitive_type(k_mirror));
2378       result = (char*) jvmtiMalloc(2);
2379       result[0] = tchar;
2380       result[1] = &#39;\0&#39;;
2381     } else {
2382       const char* class_sig = k-&gt;signature_name();
2383       result = (char *) jvmtiMalloc(strlen(class_sig)+1);
2384       strcpy(result, class_sig);
2385     }
2386     *signature_ptr = result;
2387   }
2388   if (generic_ptr != NULL) {
2389     *generic_ptr = NULL;
2390     if (!isPrimitive &amp;&amp; k-&gt;is_instance_klass()) {
2391       Symbol* soo = InstanceKlass::cast(k)-&gt;generic_signature();
2392       if (soo != NULL) {
2393         const char *gen_sig = soo-&gt;as_C_string();
2394         if (gen_sig != NULL) {
2395           char* gen_result;
2396           jvmtiError err = allocate(strlen(gen_sig) + 1,
2397                                     (unsigned char **)&amp;gen_result);
2398           if (err != JVMTI_ERROR_NONE) {
2399             return err;
2400           }
2401           strcpy(gen_result, gen_sig);
2402           *generic_ptr = gen_result;
2403         }
2404       }
2405     }
2406   }
2407   return JVMTI_ERROR_NONE;
2408 } /* end GetClassSignature */
2409 
2410 
2411 // k_mirror - may be primitive, this must be checked
2412 // status_ptr - pre-checked for NULL
2413 jvmtiError
2414 JvmtiEnv::GetClassStatus(oop k_mirror, jint* status_ptr) {
2415   jint result = 0;
2416   if (java_lang_Class::is_primitive(k_mirror)) {
2417     result |= JVMTI_CLASS_STATUS_PRIMITIVE;
2418   } else {
2419     Klass* k = java_lang_Class::as_Klass(k_mirror);
2420     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2421     result = k-&gt;jvmti_class_status();
2422   }
2423   *status_ptr = result;
2424 
2425   return JVMTI_ERROR_NONE;
2426 } /* end GetClassStatus */
2427 
2428 
2429 // k_mirror - may be primitive, this must be checked
2430 // source_name_ptr - pre-checked for NULL
2431 jvmtiError
2432 JvmtiEnv::GetSourceFileName(oop k_mirror, char** source_name_ptr) {
2433   if (java_lang_Class::is_primitive(k_mirror)) {
2434      return JVMTI_ERROR_ABSENT_INFORMATION;
2435   }
2436   Klass* k_klass = java_lang_Class::as_Klass(k_mirror);
2437   NULL_CHECK(k_klass, JVMTI_ERROR_INVALID_CLASS);
2438 
2439   if (!k_klass-&gt;is_instance_klass()) {
2440     return JVMTI_ERROR_ABSENT_INFORMATION;
2441   }
2442 
2443   Symbol* sfnOop = InstanceKlass::cast(k_klass)-&gt;source_file_name();
2444   NULL_CHECK(sfnOop, JVMTI_ERROR_ABSENT_INFORMATION);
2445   {
2446     JavaThread* current_thread  = JavaThread::current();
2447     ResourceMark rm(current_thread);
2448     const char* sfncp = (const char*) sfnOop-&gt;as_C_string();
2449     *source_name_ptr = (char *) jvmtiMalloc(strlen(sfncp)+1);
2450     strcpy(*source_name_ptr, sfncp);
2451   }
2452 
2453   return JVMTI_ERROR_NONE;
2454 } /* end GetSourceFileName */
2455 
2456 
2457 // k_mirror - may be primitive, this must be checked
2458 // modifiers_ptr - pre-checked for NULL
2459 jvmtiError
2460 JvmtiEnv::GetClassModifiers(oop k_mirror, jint* modifiers_ptr) {
2461   JavaThread* current_thread  = JavaThread::current();
2462   jint result = 0;
2463   if (!java_lang_Class::is_primitive(k_mirror)) {
2464     Klass* k = java_lang_Class::as_Klass(k_mirror);
2465     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2466     result = k-&gt;compute_modifier_flags(current_thread);
2467     JavaThread* THREAD = current_thread; // pass to macros
2468     if (HAS_PENDING_EXCEPTION) {
2469       CLEAR_PENDING_EXCEPTION;
2470       return JVMTI_ERROR_INTERNAL;
2471     };
2472 
2473     // Reset the deleted  ACC_SUPER bit ( deleted in compute_modifier_flags()).
2474     if(k-&gt;is_super()) {
2475       result |= JVM_ACC_SUPER;
2476     }
2477   } else {
2478     result = (JVM_ACC_ABSTRACT | JVM_ACC_FINAL | JVM_ACC_PUBLIC);
2479   }
2480   *modifiers_ptr = result;
2481 
2482   return JVMTI_ERROR_NONE;
2483 } /* end GetClassModifiers */
2484 
2485 
2486 // k_mirror - may be primitive, this must be checked
2487 // method_count_ptr - pre-checked for NULL
2488 // methods_ptr - pre-checked for NULL
2489 jvmtiError
2490 JvmtiEnv::GetClassMethods(oop k_mirror, jint* method_count_ptr, jmethodID** methods_ptr) {
2491   JavaThread* current_thread  = JavaThread::current();
2492   HandleMark hm(current_thread);
2493 
2494   if (java_lang_Class::is_primitive(k_mirror)) {
2495     *method_count_ptr = 0;
2496     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2497     return JVMTI_ERROR_NONE;
2498   }
2499   Klass* k = java_lang_Class::as_Klass(k_mirror);
2500   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2501 
2502   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2503   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2504     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2505   }
2506 
2507   if (!k-&gt;is_instance_klass()) {
2508     *method_count_ptr = 0;
2509     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2510     return JVMTI_ERROR_NONE;
2511   }
2512   InstanceKlass* ik = InstanceKlass::cast(k);
2513   // Allocate the result and fill it in
2514   int result_length = ik-&gt;methods()-&gt;length();
2515   jmethodID* result_list = (jmethodID*)jvmtiMalloc(result_length * sizeof(jmethodID));
2516   int index;
2517   bool jmethodids_found = true;
2518   int skipped = 0;  // skip overpass methods
2519 
2520   for (index = 0; index &lt; result_length; index++) {
2521     Method* m = ik-&gt;methods()-&gt;at(index);
2522     // Depending on can_maintain_original_method_order capability use the original
2523     // method ordering indices stored in the class, so we can emit jmethodIDs in
2524     // the order they appeared in the class file or just copy in current order.
2525     int result_index = JvmtiExport::can_maintain_original_method_order() ? ik-&gt;method_ordering()-&gt;at(index) : index;
2526     assert(result_index &gt;= 0 &amp;&amp; result_index &lt; result_length, &quot;invalid original method index&quot;);
2527     if (m-&gt;is_overpass()) {
2528       result_list[result_index] = NULL;
2529       skipped++;
2530       continue;
2531     }
2532     jmethodID id;
2533     if (jmethodids_found) {
2534       id = m-&gt;find_jmethod_id_or_null();
2535       if (id == NULL) {
2536         // If we find an uninitialized value, make sure there is
2537         // enough space for all the uninitialized values we might
2538         // find.
2539         ik-&gt;ensure_space_for_methodids(index);
2540         jmethodids_found = false;
2541         id = m-&gt;jmethod_id();
2542       }
2543     } else {
2544       id = m-&gt;jmethod_id();
2545     }
2546     result_list[result_index] = id;
2547   }
2548 
2549   // Fill in return value.
2550   if (skipped &gt; 0) {
2551     // copy results skipping NULL methodIDs
2552     *methods_ptr = (jmethodID*)jvmtiMalloc((result_length - skipped) * sizeof(jmethodID));
2553     *method_count_ptr = result_length - skipped;
2554     for (index = 0, skipped = 0; index &lt; result_length; index++) {
2555       if (result_list[index] == NULL) {
2556         skipped++;
2557       } else {
2558         (*methods_ptr)[index - skipped] = result_list[index];
2559       }
2560     }
2561     deallocate((unsigned char *)result_list);
2562   } else {
2563     *method_count_ptr = result_length;
2564     *methods_ptr = result_list;
2565   }
2566 
2567   return JVMTI_ERROR_NONE;
2568 } /* end GetClassMethods */
2569 
2570 
2571 // k_mirror - may be primitive, this must be checked
2572 // field_count_ptr - pre-checked for NULL
2573 // fields_ptr - pre-checked for NULL
2574 jvmtiError
2575 JvmtiEnv::GetClassFields(oop k_mirror, jint* field_count_ptr, jfieldID** fields_ptr) {
2576   if (java_lang_Class::is_primitive(k_mirror)) {
2577     *field_count_ptr = 0;
2578     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2579     return JVMTI_ERROR_NONE;
2580   }
2581   JavaThread* current_thread = JavaThread::current();
2582   HandleMark hm(current_thread);
2583   Klass* k = java_lang_Class::as_Klass(k_mirror);
2584   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2585 
2586   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2587   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2588     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2589   }
2590 
2591   if (!k-&gt;is_instance_klass()) {
2592     *field_count_ptr = 0;
2593     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2594     return JVMTI_ERROR_NONE;
2595   }
2596 
2597 
2598   InstanceKlass* ik = InstanceKlass::cast(k);
2599 
2600   int result_count = 0;
2601   // First, count the fields.
2602   FilteredFieldStream flds(ik, true, true);
2603   result_count = flds.field_count();
2604 
2605   // Allocate the result and fill it in
2606   jfieldID* result_list = (jfieldID*) jvmtiMalloc(result_count * sizeof(jfieldID));
2607   // The JVMTI spec requires fields in the order they occur in the class file,
2608   // this is the reverse order of what FieldStream hands out.
2609   int id_index = (result_count - 1);
2610 
2611   for (FilteredFieldStream src_st(ik, true, true); !src_st.eos(); src_st.next()) {
2612     result_list[id_index--] = jfieldIDWorkaround::to_jfieldID(
2613                                             ik, src_st.offset(),
2614                                             src_st.access_flags().is_static());
2615   }
2616   assert(id_index == -1, &quot;just checking&quot;);
2617   // Fill in the results
2618   *field_count_ptr = result_count;
2619   *fields_ptr = result_list;
2620 
2621   return JVMTI_ERROR_NONE;
2622 } /* end GetClassFields */
2623 
2624 
2625 // k_mirror - may be primitive, this must be checked
2626 // interface_count_ptr - pre-checked for NULL
2627 // interfaces_ptr - pre-checked for NULL
2628 jvmtiError
2629 JvmtiEnv::GetImplementedInterfaces(oop k_mirror, jint* interface_count_ptr, jclass** interfaces_ptr) {
2630   {
2631     if (java_lang_Class::is_primitive(k_mirror)) {
2632       *interface_count_ptr = 0;
2633       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2634       return JVMTI_ERROR_NONE;
2635     }
2636     JavaThread* current_thread = JavaThread::current();
2637     HandleMark hm(current_thread);
2638     Klass* k = java_lang_Class::as_Klass(k_mirror);
2639     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2640 
2641     // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2642     if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) ))
2643       return JVMTI_ERROR_CLASS_NOT_PREPARED;
2644 
2645     if (!k-&gt;is_instance_klass()) {
2646       *interface_count_ptr = 0;
2647       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2648       return JVMTI_ERROR_NONE;
2649     }
2650 
2651     Array&lt;InstanceKlass*&gt;* interface_list = InstanceKlass::cast(k)-&gt;local_interfaces();
2652     const int result_length = (interface_list == NULL ? 0 : interface_list-&gt;length());
2653     jclass* result_list = (jclass*) jvmtiMalloc(result_length * sizeof(jclass));
2654     for (int i_index = 0; i_index &lt; result_length; i_index += 1) {
2655       InstanceKlass* klass_at = interface_list-&gt;at(i_index);
2656       assert(klass_at-&gt;is_klass(), &quot;interfaces must be Klass*s&quot;);
2657       assert(klass_at-&gt;is_interface(), &quot;interfaces must be interfaces&quot;);
2658       oop mirror_at = klass_at-&gt;java_mirror();
2659       Handle handle_at = Handle(current_thread, mirror_at);
2660       result_list[i_index] = (jclass) jni_reference(handle_at);
2661     }
2662     *interface_count_ptr = result_length;
2663     *interfaces_ptr = result_list;
2664   }
2665 
2666   return JVMTI_ERROR_NONE;
2667 } /* end GetImplementedInterfaces */
2668 
2669 
2670 // k_mirror - may be primitive, this must be checked
2671 // minor_version_ptr - pre-checked for NULL
2672 // major_version_ptr - pre-checked for NULL
2673 jvmtiError
2674 JvmtiEnv::GetClassVersionNumbers(oop k_mirror, jint* minor_version_ptr, jint* major_version_ptr) {
2675   if (java_lang_Class::is_primitive(k_mirror)) {
2676     return JVMTI_ERROR_ABSENT_INFORMATION;
2677   }
2678   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2679 
2680   jint status = klass-&gt;jvmti_class_status();
2681   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
2682     return JVMTI_ERROR_INVALID_CLASS;
2683   }
2684   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
2685     return JVMTI_ERROR_ABSENT_INFORMATION;
2686   }
2687 
2688   InstanceKlass* ik = InstanceKlass::cast(klass);
2689   *minor_version_ptr = ik-&gt;minor_version();
2690   *major_version_ptr = ik-&gt;major_version();
2691 
2692   return JVMTI_ERROR_NONE;
2693 } /* end GetClassVersionNumbers */
2694 
2695 
2696 // k_mirror - may be primitive, this must be checked
2697 // constant_pool_count_ptr - pre-checked for NULL
2698 // constant_pool_byte_count_ptr - pre-checked for NULL
2699 // constant_pool_bytes_ptr - pre-checked for NULL
2700 jvmtiError
2701 JvmtiEnv::GetConstantPool(oop k_mirror, jint* constant_pool_count_ptr, jint* constant_pool_byte_count_ptr, unsigned char** constant_pool_bytes_ptr) {
2702   if (java_lang_Class::is_primitive(k_mirror)) {
2703     return JVMTI_ERROR_ABSENT_INFORMATION;
2704   }
2705 
2706   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2707   Thread *thread = Thread::current();
2708   ResourceMark rm(thread);
2709 
2710   jint status = klass-&gt;jvmti_class_status();
2711   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
2712     return JVMTI_ERROR_INVALID_CLASS;
2713   }
2714   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
2715     return JVMTI_ERROR_ABSENT_INFORMATION;
2716   }
2717 
2718   InstanceKlass* ik = InstanceKlass::cast(klass);
2719   JvmtiConstantPoolReconstituter reconstituter(ik);
2720   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2721     return reconstituter.get_error();
2722   }
2723 
2724   unsigned char *cpool_bytes;
2725   int cpool_size = reconstituter.cpool_size();
2726   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2727     return reconstituter.get_error();
2728   }
2729   jvmtiError res = allocate(cpool_size, &amp;cpool_bytes);
2730   if (res != JVMTI_ERROR_NONE) {
2731     return res;
2732   }
2733   reconstituter.copy_cpool_bytes(cpool_bytes);
2734   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2735     return reconstituter.get_error();
2736   }
2737 
2738   constantPoolHandle  constants(thread, ik-&gt;constants());
2739   *constant_pool_count_ptr      = constants-&gt;length();
2740   *constant_pool_byte_count_ptr = cpool_size;
2741   *constant_pool_bytes_ptr      = cpool_bytes;
2742 
2743   return JVMTI_ERROR_NONE;
2744 } /* end GetConstantPool */
2745 
2746 
2747 // k_mirror - may be primitive, this must be checked
2748 // is_interface_ptr - pre-checked for NULL
2749 jvmtiError
2750 JvmtiEnv::IsInterface(oop k_mirror, jboolean* is_interface_ptr) {
2751   {
2752     bool result = false;
2753     if (!java_lang_Class::is_primitive(k_mirror)) {
2754       Klass* k = java_lang_Class::as_Klass(k_mirror);
2755       if (k != NULL &amp;&amp; k-&gt;is_interface()) {
2756         result = true;
2757       }
2758     }
2759     *is_interface_ptr = result;
2760   }
2761 
2762   return JVMTI_ERROR_NONE;
2763 } /* end IsInterface */
2764 
2765 
2766 // k_mirror - may be primitive, this must be checked
2767 // is_array_class_ptr - pre-checked for NULL
2768 jvmtiError
2769 JvmtiEnv::IsArrayClass(oop k_mirror, jboolean* is_array_class_ptr) {
2770   {
2771     bool result = false;
2772     if (!java_lang_Class::is_primitive(k_mirror)) {
2773       Klass* k = java_lang_Class::as_Klass(k_mirror);
2774       if (k != NULL &amp;&amp; k-&gt;is_array_klass()) {
2775         result = true;
2776       }
2777     }
2778     *is_array_class_ptr = result;
2779   }
2780 
2781   return JVMTI_ERROR_NONE;
2782 } /* end IsArrayClass */
2783 
2784 
2785 // k_mirror - may be primitive, this must be checked
2786 // classloader_ptr - pre-checked for NULL
2787 jvmtiError
2788 JvmtiEnv::GetClassLoader(oop k_mirror, jobject* classloader_ptr) {
2789   {
2790     if (java_lang_Class::is_primitive(k_mirror)) {
2791       *classloader_ptr = (jclass) jni_reference(Handle());
2792       return JVMTI_ERROR_NONE;
2793     }
2794     JavaThread* current_thread = JavaThread::current();
2795     HandleMark hm(current_thread);
2796     Klass* k = java_lang_Class::as_Klass(k_mirror);
2797     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2798 
2799     oop result_oop = k-&gt;class_loader();
2800     if (result_oop == NULL) {
2801       *classloader_ptr = (jclass) jni_reference(Handle());
2802       return JVMTI_ERROR_NONE;
2803     }
2804     Handle result_handle = Handle(current_thread, result_oop);
2805     jclass result_jnihandle = (jclass) jni_reference(result_handle);
2806     *classloader_ptr = result_jnihandle;
2807   }
2808   return JVMTI_ERROR_NONE;
2809 } /* end GetClassLoader */
2810 
2811 
2812 // k_mirror - may be primitive, this must be checked
2813 // source_debug_extension_ptr - pre-checked for NULL
2814 jvmtiError
2815 JvmtiEnv::GetSourceDebugExtension(oop k_mirror, char** source_debug_extension_ptr) {
2816   {
2817     if (java_lang_Class::is_primitive(k_mirror)) {
2818       return JVMTI_ERROR_ABSENT_INFORMATION;
2819     }
2820     Klass* k = java_lang_Class::as_Klass(k_mirror);
2821     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2822     if (!k-&gt;is_instance_klass()) {
2823       return JVMTI_ERROR_ABSENT_INFORMATION;
2824     }
2825     const char* sde = InstanceKlass::cast(k)-&gt;source_debug_extension();
2826     NULL_CHECK(sde, JVMTI_ERROR_ABSENT_INFORMATION);
2827 
2828     {
2829       *source_debug_extension_ptr = (char *) jvmtiMalloc(strlen(sde)+1);
2830       strcpy(*source_debug_extension_ptr, sde);
2831     }
2832   }
2833 
2834   return JVMTI_ERROR_NONE;
2835 } /* end GetSourceDebugExtension */
2836 
2837   //
2838   // Object functions
2839   //
2840 
2841 // hash_code_ptr - pre-checked for NULL
2842 jvmtiError
2843 JvmtiEnv::GetObjectHashCode(jobject object, jint* hash_code_ptr) {
2844   oop mirror = JNIHandles::resolve_external_guard(object);
2845   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
2846   NULL_CHECK(hash_code_ptr, JVMTI_ERROR_NULL_POINTER);
2847 
2848   {
2849     jint result = (jint) mirror-&gt;identity_hash();
2850     *hash_code_ptr = result;
2851   }
2852   return JVMTI_ERROR_NONE;
2853 } /* end GetObjectHashCode */
2854 
2855 
2856 // info_ptr - pre-checked for NULL
2857 jvmtiError
2858 JvmtiEnv::GetObjectMonitorUsage(jobject object, jvmtiMonitorUsage* info_ptr) {
2859   // This needs to be performed at a safepoint to gather stable data
2860   // because monitor owner / waiters might not be suspended.
2861   VM_GetObjectMonitorUsage op(this, JavaThread::current(), object, info_ptr);
2862   VMThread::execute(&amp;op);
2863   return op.result();
2864 } /* end GetObjectMonitorUsage */
2865 
2866 
2867   //
2868   // Field functions
2869   //
2870 
2871 // name_ptr - NULL is a valid value, must be checked
2872 // signature_ptr - NULL is a valid value, must be checked
2873 // generic_ptr - NULL is a valid value, must be checked
2874 jvmtiError
2875 JvmtiEnv::GetFieldName(fieldDescriptor* fdesc_ptr, char** name_ptr, char** signature_ptr, char** generic_ptr) {
2876   JavaThread* current_thread  = JavaThread::current();
2877   ResourceMark rm(current_thread);
2878   if (name_ptr == NULL) {
2879     // just don&#39;t return the name
2880   } else {
2881     const char* fieldName = fdesc_ptr-&gt;name()-&gt;as_C_string();
2882     *name_ptr =  (char*) jvmtiMalloc(strlen(fieldName) + 1);
2883     if (*name_ptr == NULL)
2884       return JVMTI_ERROR_OUT_OF_MEMORY;
2885     strcpy(*name_ptr, fieldName);
2886   }
2887   if (signature_ptr== NULL) {
2888     // just don&#39;t return the signature
2889   } else {
2890     const char* fieldSignature = fdesc_ptr-&gt;signature()-&gt;as_C_string();
2891     *signature_ptr = (char*) jvmtiMalloc(strlen(fieldSignature) + 1);
2892     if (*signature_ptr == NULL)
2893       return JVMTI_ERROR_OUT_OF_MEMORY;
2894     strcpy(*signature_ptr, fieldSignature);
2895   }
2896   if (generic_ptr != NULL) {
2897     *generic_ptr = NULL;
2898     Symbol* soop = fdesc_ptr-&gt;generic_signature();
2899     if (soop != NULL) {
2900       const char* gen_sig = soop-&gt;as_C_string();
2901       if (gen_sig != NULL) {
2902         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
2903         if (err != JVMTI_ERROR_NONE) {
2904           return err;
2905         }
2906         strcpy(*generic_ptr, gen_sig);
2907       }
2908     }
2909   }
2910   return JVMTI_ERROR_NONE;
2911 } /* end GetFieldName */
2912 
2913 
2914 // declaring_class_ptr - pre-checked for NULL
2915 jvmtiError
2916 JvmtiEnv::GetFieldDeclaringClass(fieldDescriptor* fdesc_ptr, jclass* declaring_class_ptr) {
2917 
2918   *declaring_class_ptr = get_jni_class_non_null(fdesc_ptr-&gt;field_holder());
2919   return JVMTI_ERROR_NONE;
2920 } /* end GetFieldDeclaringClass */
2921 
2922 
2923 // modifiers_ptr - pre-checked for NULL
2924 jvmtiError
2925 JvmtiEnv::GetFieldModifiers(fieldDescriptor* fdesc_ptr, jint* modifiers_ptr) {
2926 
2927   AccessFlags resultFlags = fdesc_ptr-&gt;access_flags();
2928   jint result = resultFlags.as_int();
2929   *modifiers_ptr = result;
2930 
2931   return JVMTI_ERROR_NONE;
2932 } /* end GetFieldModifiers */
2933 
2934 
2935 // is_synthetic_ptr - pre-checked for NULL
2936 jvmtiError
2937 JvmtiEnv::IsFieldSynthetic(fieldDescriptor* fdesc_ptr, jboolean* is_synthetic_ptr) {
2938   *is_synthetic_ptr = fdesc_ptr-&gt;is_synthetic();
2939   return JVMTI_ERROR_NONE;
2940 } /* end IsFieldSynthetic */
2941 
2942 
2943   //
2944   // Method functions
2945   //
2946 
2947 // method - pre-checked for validity, but may be NULL meaning obsolete method
2948 // name_ptr - NULL is a valid value, must be checked
2949 // signature_ptr - NULL is a valid value, must be checked
2950 // generic_ptr - NULL is a valid value, must be checked
2951 jvmtiError
2952 JvmtiEnv::GetMethodName(Method* method, char** name_ptr, char** signature_ptr, char** generic_ptr) {
2953   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
2954   JavaThread* current_thread  = JavaThread::current();
2955 
2956   ResourceMark rm(current_thread); // get the utf8 name and signature
2957   if (name_ptr == NULL) {
2958     // just don&#39;t return the name
2959   } else {
2960     const char* utf8_name = (const char *) method-&gt;name()-&gt;as_utf8();
2961     *name_ptr = (char *) jvmtiMalloc(strlen(utf8_name)+1);
2962     strcpy(*name_ptr, utf8_name);
2963   }
2964   if (signature_ptr == NULL) {
2965     // just don&#39;t return the signature
2966   } else {
2967     const char* utf8_signature = (const char *) method-&gt;signature()-&gt;as_utf8();
2968     *signature_ptr = (char *) jvmtiMalloc(strlen(utf8_signature) + 1);
2969     strcpy(*signature_ptr, utf8_signature);
2970   }
2971 
2972   if (generic_ptr != NULL) {
2973     *generic_ptr = NULL;
2974     Symbol* soop = method-&gt;generic_signature();
2975     if (soop != NULL) {
2976       const char* gen_sig = soop-&gt;as_C_string();
2977       if (gen_sig != NULL) {
2978         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
2979         if (err != JVMTI_ERROR_NONE) {
2980           return err;
2981         }
2982         strcpy(*generic_ptr, gen_sig);
2983       }
2984     }
2985   }
2986   return JVMTI_ERROR_NONE;
2987 } /* end GetMethodName */
2988 
2989 
2990 // method - pre-checked for validity, but may be NULL meaning obsolete method
2991 // declaring_class_ptr - pre-checked for NULL
2992 jvmtiError
2993 JvmtiEnv::GetMethodDeclaringClass(Method* method, jclass* declaring_class_ptr) {
2994   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
2995   (*declaring_class_ptr) = get_jni_class_non_null(method-&gt;method_holder());
2996   return JVMTI_ERROR_NONE;
2997 } /* end GetMethodDeclaringClass */
2998 
2999 
3000 // method - pre-checked for validity, but may be NULL meaning obsolete method
3001 // modifiers_ptr - pre-checked for NULL
3002 jvmtiError
3003 JvmtiEnv::GetMethodModifiers(Method* method, jint* modifiers_ptr) {
3004   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3005   (*modifiers_ptr) = method-&gt;access_flags().as_int() &amp; JVM_RECOGNIZED_METHOD_MODIFIERS;
3006   return JVMTI_ERROR_NONE;
3007 } /* end GetMethodModifiers */
3008 
3009 
3010 // method - pre-checked for validity, but may be NULL meaning obsolete method
3011 // max_ptr - pre-checked for NULL
3012 jvmtiError
3013 JvmtiEnv::GetMaxLocals(Method* method, jint* max_ptr) {
3014   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3015   // get max stack
3016   (*max_ptr) = method-&gt;max_locals();
3017   return JVMTI_ERROR_NONE;
3018 } /* end GetMaxLocals */
3019 
3020 
3021 // method - pre-checked for validity, but may be NULL meaning obsolete method
3022 // size_ptr - pre-checked for NULL
3023 jvmtiError
3024 JvmtiEnv::GetArgumentsSize(Method* method, jint* size_ptr) {
3025   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3026   // get size of arguments
3027 
3028   (*size_ptr) = method-&gt;size_of_parameters();
3029   return JVMTI_ERROR_NONE;
3030 } /* end GetArgumentsSize */
3031 
3032 
3033 // method - pre-checked for validity, but may be NULL meaning obsolete method
3034 // entry_count_ptr - pre-checked for NULL
3035 // table_ptr - pre-checked for NULL
3036 jvmtiError
3037 JvmtiEnv::GetLineNumberTable(Method* method, jint* entry_count_ptr, jvmtiLineNumberEntry** table_ptr) {
3038   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3039   if (!method-&gt;has_linenumber_table()) {
3040     return (JVMTI_ERROR_ABSENT_INFORMATION);
3041   }
3042 
3043   // The line number table is compressed so we don&#39;t know how big it is until decompressed.
3044   // Decompression is really fast so we just do it twice.
3045 
3046   // Compute size of table
3047   jint num_entries = 0;
3048   CompressedLineNumberReadStream stream(method-&gt;compressed_linenumber_table());
3049   while (stream.read_pair()) {
3050     num_entries++;
3051   }
3052   jvmtiLineNumberEntry *jvmti_table =
3053             (jvmtiLineNumberEntry *)jvmtiMalloc(num_entries * (sizeof(jvmtiLineNumberEntry)));
3054 
3055   // Fill jvmti table
3056   if (num_entries &gt; 0) {
3057     int index = 0;
3058     CompressedLineNumberReadStream stream(method-&gt;compressed_linenumber_table());
3059     while (stream.read_pair()) {
3060       jvmti_table[index].start_location = (jlocation) stream.bci();
3061       jvmti_table[index].line_number = (jint) stream.line();
3062       index++;
3063     }
3064     assert(index == num_entries, &quot;sanity check&quot;);
3065   }
3066 
3067   // Set up results
3068   (*entry_count_ptr) = num_entries;
3069   (*table_ptr) = jvmti_table;
3070 
3071   return JVMTI_ERROR_NONE;
3072 } /* end GetLineNumberTable */
3073 
3074 
3075 // method - pre-checked for validity, but may be NULL meaning obsolete method
3076 // start_location_ptr - pre-checked for NULL
3077 // end_location_ptr - pre-checked for NULL
3078 jvmtiError
3079 JvmtiEnv::GetMethodLocation(Method* method, jlocation* start_location_ptr, jlocation* end_location_ptr) {
3080 
3081   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3082   // get start and end location
3083   (*end_location_ptr) = (jlocation) (method-&gt;code_size() - 1);
3084   if (method-&gt;code_size() == 0) {
3085     // there is no code so there is no start location
3086     (*start_location_ptr) = (jlocation)(-1);
3087   } else {
3088     (*start_location_ptr) = (jlocation)(0);
3089   }
3090 
3091   return JVMTI_ERROR_NONE;
3092 } /* end GetMethodLocation */
3093 
3094 
3095 // method - pre-checked for validity, but may be NULL meaning obsolete method
3096 // entry_count_ptr - pre-checked for NULL
3097 // table_ptr - pre-checked for NULL
3098 jvmtiError
3099 JvmtiEnv::GetLocalVariableTable(Method* method, jint* entry_count_ptr, jvmtiLocalVariableEntry** table_ptr) {
3100 
3101   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3102   JavaThread* current_thread  = JavaThread::current();
3103 
3104   // does the klass have any local variable information?
3105   InstanceKlass* ik = method-&gt;method_holder();
3106   if (!ik-&gt;access_flags().has_localvariable_table()) {
3107     return (JVMTI_ERROR_ABSENT_INFORMATION);
3108   }
3109 
3110   ConstantPool* constants = method-&gt;constants();
3111   NULL_CHECK(constants, JVMTI_ERROR_ABSENT_INFORMATION);
3112 
3113   // in the vm localvariable table representation, 6 consecutive elements in the table
3114   // represent a 6-tuple of shorts
3115   // [start_pc, length, name_index, descriptor_index, signature_index, index]
3116   jint num_entries = method-&gt;localvariable_table_length();
3117   jvmtiLocalVariableEntry *jvmti_table = (jvmtiLocalVariableEntry *)
3118                 jvmtiMalloc(num_entries * (sizeof(jvmtiLocalVariableEntry)));
3119 
3120   if (num_entries &gt; 0) {
3121     LocalVariableTableElement* table = method-&gt;localvariable_table_start();
3122     for (int i = 0; i &lt; num_entries; i++) {
3123       // get the 5 tuple information from the vm table
3124       jlocation start_location = (jlocation) table[i].start_bci;
3125       jint length = (jint) table[i].length;
3126       int name_index = (int) table[i].name_cp_index;
3127       int signature_index = (int) table[i].descriptor_cp_index;
3128       int generic_signature_index = (int) table[i].signature_cp_index;
3129       jint slot = (jint) table[i].slot;
3130 
3131       // get utf8 name and signature
3132       char *name_buf = NULL;
3133       char *sig_buf = NULL;
3134       char *gen_sig_buf = NULL;
3135       {
3136         ResourceMark rm(current_thread);
3137 
3138         const char *utf8_name = (const char *) constants-&gt;symbol_at(name_index)-&gt;as_utf8();
3139         name_buf = (char *) jvmtiMalloc(strlen(utf8_name)+1);
3140         strcpy(name_buf, utf8_name);
3141 
3142         const char *utf8_signature = (const char *) constants-&gt;symbol_at(signature_index)-&gt;as_utf8();
3143         sig_buf = (char *) jvmtiMalloc(strlen(utf8_signature)+1);
3144         strcpy(sig_buf, utf8_signature);
3145 
3146         if (generic_signature_index &gt; 0) {
3147           const char *utf8_gen_sign = (const char *)
3148                                        constants-&gt;symbol_at(generic_signature_index)-&gt;as_utf8();
3149           gen_sig_buf = (char *) jvmtiMalloc(strlen(utf8_gen_sign)+1);
3150           strcpy(gen_sig_buf, utf8_gen_sign);
3151         }
3152       }
3153 
3154       // fill in the jvmti local variable table
3155       jvmti_table[i].start_location = start_location;
3156       jvmti_table[i].length = length;
3157       jvmti_table[i].name = name_buf;
3158       jvmti_table[i].signature = sig_buf;
3159       jvmti_table[i].generic_signature = gen_sig_buf;
3160       jvmti_table[i].slot = slot;
3161     }
3162   }
3163 
3164   // set results
3165   (*entry_count_ptr) = num_entries;
3166   (*table_ptr) = jvmti_table;
3167 
3168   return JVMTI_ERROR_NONE;
3169 } /* end GetLocalVariableTable */
3170 
3171 
3172 // method - pre-checked for validity, but may be NULL meaning obsolete method
3173 // bytecode_count_ptr - pre-checked for NULL
3174 // bytecodes_ptr - pre-checked for NULL
3175 jvmtiError
3176 JvmtiEnv::GetBytecodes(Method* method, jint* bytecode_count_ptr, unsigned char** bytecodes_ptr) {
3177   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3178 
3179   methodHandle mh(Thread::current(), method);
3180   jint size = (jint)mh-&gt;code_size();
3181   jvmtiError err = allocate(size, bytecodes_ptr);
3182   if (err != JVMTI_ERROR_NONE) {
3183     return err;
3184   }
3185 
3186   (*bytecode_count_ptr) = size;
3187   // get byte codes
3188   JvmtiClassFileReconstituter::copy_bytecodes(mh, *bytecodes_ptr);
3189 
3190   return JVMTI_ERROR_NONE;
3191 } /* end GetBytecodes */
3192 
3193 
3194 // method - pre-checked for validity, but may be NULL meaning obsolete method
3195 // is_native_ptr - pre-checked for NULL
3196 jvmtiError
3197 JvmtiEnv::IsMethodNative(Method* method, jboolean* is_native_ptr) {
3198   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3199   (*is_native_ptr) = method-&gt;is_native();
3200   return JVMTI_ERROR_NONE;
3201 } /* end IsMethodNative */
3202 
3203 
3204 // method - pre-checked for validity, but may be NULL meaning obsolete method
3205 // is_synthetic_ptr - pre-checked for NULL
3206 jvmtiError
3207 JvmtiEnv::IsMethodSynthetic(Method* method, jboolean* is_synthetic_ptr) {
3208   NULL_CHECK(method, JVMTI_ERROR_INVALID_METHODID);
3209   (*is_synthetic_ptr) = method-&gt;is_synthetic();
3210   return JVMTI_ERROR_NONE;
3211 } /* end IsMethodSynthetic */
3212 
3213 
3214 // method - pre-checked for validity, but may be NULL meaning obsolete method
3215 // is_obsolete_ptr - pre-checked for NULL
3216 jvmtiError
3217 JvmtiEnv::IsMethodObsolete(Method* method, jboolean* is_obsolete_ptr) {
3218   if (use_version_1_0_semantics() &amp;&amp;
3219       get_capabilities()-&gt;can_redefine_classes == 0) {
3220     // This JvmtiEnv requested version 1.0 semantics and this function
3221     // requires the can_redefine_classes capability in version 1.0 so
3222     // we need to return an error here.
3223     return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3224   }
3225 
3226   if (method == NULL || method-&gt;is_obsolete()) {
3227     *is_obsolete_ptr = true;
3228   } else {
3229     *is_obsolete_ptr = false;
3230   }
3231   return JVMTI_ERROR_NONE;
3232 } /* end IsMethodObsolete */
3233 
3234   //
3235   // Raw Monitor functions
3236   //
3237 
3238 // name - pre-checked for NULL
3239 // monitor_ptr - pre-checked for NULL
3240 jvmtiError
3241 JvmtiEnv::CreateRawMonitor(const char* name, jrawMonitorID* monitor_ptr) {
3242   JvmtiRawMonitor* rmonitor = new JvmtiRawMonitor(name);
3243   NULL_CHECK(rmonitor, JVMTI_ERROR_OUT_OF_MEMORY);
3244 
3245   *monitor_ptr = (jrawMonitorID)rmonitor;
3246 
3247   return JVMTI_ERROR_NONE;
3248 } /* end CreateRawMonitor */
3249 
3250 
3251 // rmonitor - pre-checked for validity
3252 jvmtiError
3253 JvmtiEnv::DestroyRawMonitor(JvmtiRawMonitor * rmonitor) {
3254   if (Threads::number_of_threads() == 0) {
3255     // Remove this monitor from pending raw monitors list
3256     // if it has entered in onload or start phase.
3257     JvmtiPendingMonitors::destroy(rmonitor);
3258   } else {
3259     Thread* thread  = Thread::current();
3260     if (rmonitor-&gt;owner() == thread) {
3261       // The caller owns this monitor which we are about to destroy.
3262       // We exit the underlying synchronization object so that the
3263       // &quot;delete monitor&quot; call below can work without an assertion
3264       // failure on systems that don&#39;t like destroying synchronization
3265       // objects that are locked.
3266       int r;
3267       int recursion = rmonitor-&gt;recursions();
3268       for (int i = 0; i &lt;= recursion; i++) {
3269         r = rmonitor-&gt;raw_exit(thread);
3270         assert(r == JvmtiRawMonitor::M_OK, &quot;raw_exit should have worked&quot;);
3271         if (r != JvmtiRawMonitor::M_OK) {  // robustness
3272           return JVMTI_ERROR_INTERNAL;
3273         }
3274       }
3275     }
3276     if (rmonitor-&gt;owner() != NULL) {
3277       // The caller is trying to destroy a monitor that is locked by
3278       // someone else. While this is not forbidden by the JVMTI
3279       // spec, it will cause an assertion failure on systems that don&#39;t
3280       // like destroying synchronization objects that are locked.
3281       // We indicate a problem with the error return (and leak the
3282       // monitor&#39;s memory).
3283       return JVMTI_ERROR_NOT_MONITOR_OWNER;
3284     }
3285   }
3286 
3287   delete rmonitor;
3288 
3289   return JVMTI_ERROR_NONE;
3290 } /* end DestroyRawMonitor */
3291 
3292 
3293 // rmonitor - pre-checked for validity
3294 jvmtiError
3295 JvmtiEnv::RawMonitorEnter(JvmtiRawMonitor * rmonitor) {
3296   if (Threads::number_of_threads() == 0) {
3297     // No JavaThreads exist so JvmtiRawMonitor enter cannot be
3298     // used, add this raw monitor to the pending list.
3299     // The pending monitors will be actually entered when
3300     // the VM is setup.
3301     // See transition_pending_raw_monitors in create_vm()
3302     // in thread.cpp.
3303     JvmtiPendingMonitors::enter(rmonitor);
3304   } else {
3305     Thread* thread = Thread::current();
3306     if (thread-&gt;is_Java_thread()) {
3307       JavaThread* current_thread = (JavaThread*)thread;
3308 
3309       /* Transition to thread_blocked without entering vm state          */
3310       /* This is really evil. Normally you can&#39;t undo _thread_blocked    */
3311       /* transitions like this because it would cause us to miss a       */
3312       /* safepoint but since the thread was already in _thread_in_native */
3313       /* the thread is not leaving a safepoint safe state and it will    */
3314       /* block when it tries to return from native. We can&#39;t safepoint   */
3315       /* block in here because we could deadlock the vmthread. Blech.    */
3316 
3317       JavaThreadState state = current_thread-&gt;thread_state();
3318       assert(state == _thread_in_native, &quot;Must be _thread_in_native&quot;);
3319       // frame should already be walkable since we are in native
3320       assert(!current_thread-&gt;has_last_Java_frame() ||
3321              current_thread-&gt;frame_anchor()-&gt;walkable(), &quot;Must be walkable&quot;);
3322       current_thread-&gt;set_thread_state(_thread_blocked);
3323 
3324       rmonitor-&gt;raw_enter(current_thread);
3325       // restore state, still at a safepoint safe state
3326       current_thread-&gt;set_thread_state(state);
3327     } else {
3328       rmonitor-&gt;raw_enter(thread);
3329     }
3330   }
3331   return JVMTI_ERROR_NONE;
3332 } /* end RawMonitorEnter */
3333 
3334 
3335 // rmonitor - pre-checked for validity
3336 jvmtiError
3337 JvmtiEnv::RawMonitorExit(JvmtiRawMonitor * rmonitor) {
3338   jvmtiError err = JVMTI_ERROR_NONE;
3339 
3340   if (Threads::number_of_threads() == 0) {
3341     // No JavaThreads exist so just remove this monitor from the pending list.
3342     // Bool value from exit is false if rmonitor is not in the list.
3343     if (!JvmtiPendingMonitors::exit(rmonitor)) {
3344       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3345     }
3346   } else {
3347     Thread* thread = Thread::current();
3348     int r = rmonitor-&gt;raw_exit(thread);
3349     if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3350       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3351     }
3352   }
3353   return err;
3354 } /* end RawMonitorExit */
3355 
3356 
3357 // rmonitor - pre-checked for validity
3358 jvmtiError
3359 JvmtiEnv::RawMonitorWait(JvmtiRawMonitor * rmonitor, jlong millis) {
3360   Thread* thread = Thread::current();
3361   int r = rmonitor-&gt;raw_wait(millis, thread);
3362 
3363   switch (r) {
3364   case JvmtiRawMonitor::M_INTERRUPTED:
3365     return JVMTI_ERROR_INTERRUPT;
3366   case JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE:
3367     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3368   default:
3369     return JVMTI_ERROR_NONE;
3370   }
3371 } /* end RawMonitorWait */
3372 
3373 
3374 // rmonitor - pre-checked for validity
3375 jvmtiError
3376 JvmtiEnv::RawMonitorNotify(JvmtiRawMonitor * rmonitor) {
3377   Thread* thread = Thread::current();
3378   int r = rmonitor-&gt;raw_notify(thread);
3379 
3380   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3381     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3382   }
3383   return JVMTI_ERROR_NONE;
3384 } /* end RawMonitorNotify */
3385 
3386 
3387 // rmonitor - pre-checked for validity
3388 jvmtiError
3389 JvmtiEnv::RawMonitorNotifyAll(JvmtiRawMonitor * rmonitor) {
3390   Thread* thread = Thread::current();
3391   int r = rmonitor-&gt;raw_notifyAll(thread);
3392 
3393   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3394     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3395   }
3396   return JVMTI_ERROR_NONE;
3397 } /* end RawMonitorNotifyAll */
3398 
3399 
3400   //
3401   // JNI Function Interception functions
3402   //
3403 
3404 
3405 // function_table - pre-checked for NULL
3406 jvmtiError
3407 JvmtiEnv::SetJNIFunctionTable(const jniNativeInterface* function_table) {
3408   // Copy jni function table at safepoint.
3409   VM_JNIFunctionTableCopier copier(function_table);
3410   VMThread::execute(&amp;copier);
3411 
3412   return JVMTI_ERROR_NONE;
3413 } /* end SetJNIFunctionTable */
3414 
3415 
3416 // function_table - pre-checked for NULL
3417 jvmtiError
3418 JvmtiEnv::GetJNIFunctionTable(jniNativeInterface** function_table) {
3419   *function_table=(jniNativeInterface*)jvmtiMalloc(sizeof(jniNativeInterface));
3420   if (*function_table == NULL)
3421     return JVMTI_ERROR_OUT_OF_MEMORY;
3422   memcpy(*function_table,(JavaThread::current())-&gt;get_jni_functions(),sizeof(jniNativeInterface));
3423   return JVMTI_ERROR_NONE;
3424 } /* end GetJNIFunctionTable */
3425 
3426 
3427   //
3428   // Event Management functions
3429   //
3430 
3431 jvmtiError
3432 JvmtiEnv::GenerateEvents(jvmtiEvent event_type) {
3433   // can only generate two event types
3434   if (event_type != JVMTI_EVENT_COMPILED_METHOD_LOAD &amp;&amp;
3435       event_type != JVMTI_EVENT_DYNAMIC_CODE_GENERATED) {
3436     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3437   }
3438 
3439   // for compiled_method_load events we must check that the environment
3440   // has the can_generate_compiled_method_load_events capability.
3441   if (event_type == JVMTI_EVENT_COMPILED_METHOD_LOAD) {
3442     if (get_capabilities()-&gt;can_generate_compiled_method_load_events == 0) {
3443       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3444     }
3445     return JvmtiCodeBlobEvents::generate_compiled_method_load_events(this);
3446   } else {
3447     return JvmtiCodeBlobEvents::generate_dynamic_code_events(this);
3448   }
3449 
3450 } /* end GenerateEvents */
3451 
3452 
3453   //
3454   // Extension Mechanism functions
3455   //
3456 
3457 // extension_count_ptr - pre-checked for NULL
3458 // extensions - pre-checked for NULL
3459 jvmtiError
3460 JvmtiEnv::GetExtensionFunctions(jint* extension_count_ptr, jvmtiExtensionFunctionInfo** extensions) {
3461   return JvmtiExtensions::get_functions(this, extension_count_ptr, extensions);
3462 } /* end GetExtensionFunctions */
3463 
3464 
3465 // extension_count_ptr - pre-checked for NULL
3466 // extensions - pre-checked for NULL
3467 jvmtiError
3468 JvmtiEnv::GetExtensionEvents(jint* extension_count_ptr, jvmtiExtensionEventInfo** extensions) {
3469   return JvmtiExtensions::get_events(this, extension_count_ptr, extensions);
3470 } /* end GetExtensionEvents */
3471 
3472 
3473 // callback - NULL is a valid value, must be checked
3474 jvmtiError
3475 JvmtiEnv::SetExtensionEventCallback(jint extension_event_index, jvmtiExtensionEvent callback) {
3476   return JvmtiExtensions::set_event_callback(this, extension_event_index, callback);
3477 } /* end SetExtensionEventCallback */
3478 
3479   //
3480   // Timers functions
3481   //
3482 
3483 // info_ptr - pre-checked for NULL
3484 jvmtiError
3485 JvmtiEnv::GetCurrentThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3486   os::current_thread_cpu_time_info(info_ptr);
3487   return JVMTI_ERROR_NONE;
3488 } /* end GetCurrentThreadCpuTimerInfo */
3489 
3490 
3491 // nanos_ptr - pre-checked for NULL
3492 jvmtiError
3493 JvmtiEnv::GetCurrentThreadCpuTime(jlong* nanos_ptr) {
3494   *nanos_ptr = os::current_thread_cpu_time();
3495   return JVMTI_ERROR_NONE;
3496 } /* end GetCurrentThreadCpuTime */
3497 
3498 
3499 // info_ptr - pre-checked for NULL
3500 jvmtiError
3501 JvmtiEnv::GetThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3502   os::thread_cpu_time_info(info_ptr);
3503   return JVMTI_ERROR_NONE;
3504 } /* end GetThreadCpuTimerInfo */
3505 
3506 
3507 // Threads_lock NOT held, java_thread not protected by lock
3508 // java_thread - pre-checked
3509 // nanos_ptr - pre-checked for NULL
3510 jvmtiError
3511 JvmtiEnv::GetThreadCpuTime(JavaThread* java_thread, jlong* nanos_ptr) {
3512   *nanos_ptr = os::thread_cpu_time(java_thread);
3513   return JVMTI_ERROR_NONE;
3514 } /* end GetThreadCpuTime */
3515 
3516 
3517 // info_ptr - pre-checked for NULL
3518 jvmtiError
3519 JvmtiEnv::GetTimerInfo(jvmtiTimerInfo* info_ptr) {
3520   os::javaTimeNanos_info(info_ptr);
3521   return JVMTI_ERROR_NONE;
3522 } /* end GetTimerInfo */
3523 
3524 
3525 // nanos_ptr - pre-checked for NULL
3526 jvmtiError
3527 JvmtiEnv::GetTime(jlong* nanos_ptr) {
3528   *nanos_ptr = os::javaTimeNanos();
3529   return JVMTI_ERROR_NONE;
3530 } /* end GetTime */
3531 
3532 
3533 // processor_count_ptr - pre-checked for NULL
3534 jvmtiError
3535 JvmtiEnv::GetAvailableProcessors(jint* processor_count_ptr) {
3536   *processor_count_ptr = os::active_processor_count();
3537   return JVMTI_ERROR_NONE;
3538 } /* end GetAvailableProcessors */
3539 
3540 jvmtiError
3541 JvmtiEnv::SetHeapSamplingInterval(jint sampling_interval) {
3542   if (sampling_interval &lt; 0) {
3543     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3544   }
3545   ThreadHeapSampler::set_sampling_interval(sampling_interval);
3546   return JVMTI_ERROR_NONE;
3547 } /* end SetHeapSamplingInterval */
3548 
3549   //
3550   // System Properties functions
3551   //
3552 
3553 // count_ptr - pre-checked for NULL
3554 // property_ptr - pre-checked for NULL
3555 jvmtiError
3556 JvmtiEnv::GetSystemProperties(jint* count_ptr, char*** property_ptr) {
3557   jvmtiError err = JVMTI_ERROR_NONE;
3558 
3559   // Get the number of readable properties.
3560   *count_ptr = Arguments::PropertyList_readable_count(Arguments::system_properties());
3561 
3562   // Allocate memory to hold the exact number of readable properties.
3563   err = allocate(*count_ptr * sizeof(char *), (unsigned char **)property_ptr);
3564   if (err != JVMTI_ERROR_NONE) {
3565     return err;
3566   }
3567   int readable_count = 0;
3568   // Loop through the system properties until all the readable properties are found.
3569   for (SystemProperty* p = Arguments::system_properties(); p != NULL &amp;&amp; readable_count &lt; *count_ptr; p = p-&gt;next()) {
3570     if (p-&gt;is_readable()) {
3571       const char *key = p-&gt;key();
3572       char **tmp_value = *property_ptr+readable_count;
3573       readable_count++;
3574       err = allocate((strlen(key)+1) * sizeof(char), (unsigned char**)tmp_value);
3575       if (err == JVMTI_ERROR_NONE) {
3576         strcpy(*tmp_value, key);
3577       } else {
3578         // clean up previously allocated memory.
3579         for (int j = 0; j &lt; readable_count; j++) {
3580           Deallocate((unsigned char*)*property_ptr+j);
3581         }
3582         Deallocate((unsigned char*)property_ptr);
3583         break;
3584       }
3585     }
3586   }
3587   assert(err != JVMTI_ERROR_NONE || readable_count == *count_ptr, &quot;Bad readable property count&quot;);
3588   return err;
3589 } /* end GetSystemProperties */
3590 
3591 
3592 // property - pre-checked for NULL
3593 // value_ptr - pre-checked for NULL
3594 jvmtiError
3595 JvmtiEnv::GetSystemProperty(const char* property, char** value_ptr) {
3596   jvmtiError err = JVMTI_ERROR_NONE;
3597   const char *value;
3598 
3599   // Return JVMTI_ERROR_NOT_AVAILABLE if property is not readable or doesn&#39;t exist.
3600   value = Arguments::PropertyList_get_readable_value(Arguments::system_properties(), property);
3601   if (value == NULL) {
3602     err =  JVMTI_ERROR_NOT_AVAILABLE;
3603   } else {
3604     err = allocate((strlen(value)+1) * sizeof(char), (unsigned char **)value_ptr);
3605     if (err == JVMTI_ERROR_NONE) {
3606       strcpy(*value_ptr, value);
3607     }
3608   }
3609   return err;
3610 } /* end GetSystemProperty */
3611 
3612 
3613 // property - pre-checked for NULL
3614 // value - NULL is a valid value, must be checked
3615 jvmtiError
3616 JvmtiEnv::SetSystemProperty(const char* property, const char* value_ptr) {
3617   jvmtiError err =JVMTI_ERROR_NOT_AVAILABLE;
3618 
3619   for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
3620     if (strcmp(property, p-&gt;key()) == 0) {
3621       if (p-&gt;set_writeable_value(value_ptr)) {
3622         err =  JVMTI_ERROR_NONE;
3623       }
3624     }
3625   }
3626   return err;
3627 } /* end SetSystemProperty */
    </pre>
  </body>
</html>