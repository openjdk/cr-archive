<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/thread.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/classLoader.hpp&quot;
  29 #include &quot;classfile/javaClasses.hpp&quot;
  30 #include &quot;classfile/moduleEntry.hpp&quot;
  31 #include &quot;classfile/systemDictionary.hpp&quot;
  32 #include &quot;classfile/vmSymbols.hpp&quot;
  33 #include &quot;code/codeCache.hpp&quot;
  34 #include &quot;code/scopeDesc.hpp&quot;
  35 #include &quot;compiler/compileBroker.hpp&quot;
  36 #include &quot;compiler/compileTask.hpp&quot;
  37 #include &quot;gc/shared/barrierSet.hpp&quot;
  38 #include &quot;gc/shared/gcId.hpp&quot;
  39 #include &quot;gc/shared/gcLocker.inline.hpp&quot;
  40 #include &quot;gc/shared/workgroup.hpp&quot;
  41 #include &quot;interpreter/interpreter.hpp&quot;
  42 #include &quot;interpreter/linkResolver.hpp&quot;
  43 #include &quot;interpreter/oopMapCache.hpp&quot;
  44 #include &quot;jfr/jfrEvents.hpp&quot;
  45 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  46 #include &quot;logging/log.hpp&quot;
  47 #include &quot;logging/logConfiguration.hpp&quot;
  48 #include &quot;logging/logStream.hpp&quot;
  49 #include &quot;memory/allocation.inline.hpp&quot;
  50 #include &quot;memory/iterator.hpp&quot;
  51 #include &quot;memory/metaspaceShared.hpp&quot;
  52 #include &quot;memory/oopFactory.hpp&quot;
  53 #include &quot;memory/resourceArea.hpp&quot;
  54 #include &quot;memory/universe.hpp&quot;
  55 #include &quot;oops/access.inline.hpp&quot;
  56 #include &quot;oops/instanceKlass.hpp&quot;
  57 #include &quot;oops/objArrayOop.hpp&quot;
  58 #include &quot;oops/oop.inline.hpp&quot;
  59 #include &quot;oops/symbol.hpp&quot;
  60 #include &quot;oops/typeArrayOop.inline.hpp&quot;
  61 #include &quot;oops/verifyOopClosure.hpp&quot;
  62 #include &quot;prims/jvm_misc.hpp&quot;
  63 #include &quot;prims/jvmtiExport.hpp&quot;
  64 #include &quot;prims/jvmtiThreadState.hpp&quot;
  65 #include &quot;runtime/arguments.hpp&quot;
  66 #include &quot;runtime/atomic.hpp&quot;
  67 #include &quot;runtime/biasedLocking.hpp&quot;
  68 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  69 #include &quot;runtime/flags/jvmFlagConstraintList.hpp&quot;
  70 #include &quot;runtime/flags/jvmFlagRangeList.hpp&quot;
  71 #include &quot;runtime/deoptimization.hpp&quot;
  72 #include &quot;runtime/frame.inline.hpp&quot;
  73 #include &quot;runtime/handles.inline.hpp&quot;
  74 #include &quot;runtime/handshake.hpp&quot;
  75 #include &quot;runtime/init.hpp&quot;
  76 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  77 #include &quot;runtime/java.hpp&quot;
  78 #include &quot;runtime/javaCalls.hpp&quot;
  79 #include &quot;runtime/jniHandles.inline.hpp&quot;
  80 #include &quot;runtime/jniPeriodicChecker.hpp&quot;
  81 #include &quot;runtime/memprofiler.hpp&quot;
  82 #include &quot;runtime/mutexLocker.hpp&quot;
  83 #include &quot;runtime/objectMonitor.hpp&quot;
  84 #include &quot;runtime/orderAccess.hpp&quot;
  85 #include &quot;runtime/osThread.hpp&quot;
  86 #include &quot;runtime/prefetch.inline.hpp&quot;
  87 #include &quot;runtime/safepoint.hpp&quot;
  88 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  89 #include &quot;runtime/safepointVerifiers.hpp&quot;
  90 #include &quot;runtime/serviceThread.hpp&quot;
  91 #include &quot;runtime/sharedRuntime.hpp&quot;
  92 #include &quot;runtime/statSampler.hpp&quot;
  93 #include &quot;runtime/stubRoutines.hpp&quot;
  94 #include &quot;runtime/sweeper.hpp&quot;
  95 #include &quot;runtime/task.hpp&quot;
  96 #include &quot;runtime/thread.inline.hpp&quot;
  97 #include &quot;runtime/threadCritical.hpp&quot;
  98 #include &quot;runtime/threadSMR.inline.hpp&quot;
  99 #include &quot;runtime/threadStatisticalInfo.hpp&quot;
 100 #include &quot;runtime/timer.hpp&quot;
 101 #include &quot;runtime/timerTrace.hpp&quot;
 102 #include &quot;runtime/vframe.inline.hpp&quot;
 103 #include &quot;runtime/vframeArray.hpp&quot;
 104 #include &quot;runtime/vframe_hp.hpp&quot;
 105 #include &quot;runtime/vmThread.hpp&quot;
 106 #include &quot;runtime/vmOperations.hpp&quot;
 107 #include &quot;runtime/vm_version.hpp&quot;
 108 #include &quot;services/attachListener.hpp&quot;
 109 #include &quot;services/management.hpp&quot;
 110 #include &quot;services/memTracker.hpp&quot;
 111 #include &quot;services/threadService.hpp&quot;
 112 #include &quot;utilities/align.hpp&quot;
 113 #include &quot;utilities/copy.hpp&quot;
 114 #include &quot;utilities/defaultStream.hpp&quot;
 115 #include &quot;utilities/dtrace.hpp&quot;
 116 #include &quot;utilities/events.hpp&quot;
 117 #include &quot;utilities/macros.hpp&quot;
 118 #include &quot;utilities/preserveException.hpp&quot;
 119 #include &quot;utilities/singleWriterSynchronizer.hpp&quot;
 120 #include &quot;utilities/vmError.hpp&quot;
 121 #if INCLUDE_JVMCI
 122 #include &quot;jvmci/jvmci.hpp&quot;
 123 #include &quot;jvmci/jvmciEnv.hpp&quot;
 124 #endif
 125 #ifdef COMPILER1
 126 #include &quot;c1/c1_Compiler.hpp&quot;
 127 #endif
 128 #ifdef COMPILER2
 129 #include &quot;opto/c2compiler.hpp&quot;
 130 #include &quot;opto/idealGraphPrinter.hpp&quot;
 131 #endif
 132 #if INCLUDE_RTM_OPT
 133 #include &quot;runtime/rtmLocking.hpp&quot;
 134 #endif
 135 #if INCLUDE_JFR
 136 #include &quot;jfr/jfr.hpp&quot;
 137 #endif
 138 
 139 // Initialization after module runtime initialization
 140 void universe_post_module_init();  // must happen after call_initPhase2
 141 
 142 #ifdef DTRACE_ENABLED
 143 
 144 // Only bother with this argument setup if dtrace is available
 145 
 146   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 147   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 148 
 149   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 150     {                                                                      \
 151       ResourceMark rm(this);                                               \
 152       int len = 0;                                                         \
 153       const char* name = (javathread)-&gt;get_thread_name();                  \
 154       len = strlen(name);                                                  \
 155       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 156         (char *) name, len,                                                \
 157         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 158         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 159         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 160     }
 161 
 162 #else //  ndef DTRACE_ENABLED
 163 
 164   #define DTRACE_THREAD_PROBE(probe, javathread)
 165 
 166 #endif // ndef DTRACE_ENABLED
 167 
 168 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 169 // Current thread is maintained as a thread-local variable
 170 THREAD_LOCAL Thread* Thread::_thr_current = NULL;
 171 #endif
 172 
 173 // ======= Thread ========
 174 // Support for forcing alignment of thread objects for biased locking
 175 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 176   if (UseBiasedLocking) {
 177     const size_t alignment = markWord::biased_lock_alignment;
 178     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 179     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 180                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 181                                                          AllocFailStrategy::RETURN_NULL);
 182     void* aligned_addr     = align_up(real_malloc_addr, alignment);
 183     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 184            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 185            &quot;JavaThread alignment code overflowed allocated storage&quot;);
 186     if (aligned_addr != real_malloc_addr) {
 187       log_info(biasedlocking)(&quot;Aligned thread &quot; INTPTR_FORMAT &quot; to &quot; INTPTR_FORMAT,
 188                               p2i(real_malloc_addr),
 189                               p2i(aligned_addr));
 190     }
 191     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 192     return aligned_addr;
 193   } else {
 194     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 195                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 196   }
 197 }
 198 
 199 void Thread::operator delete(void* p) {
 200   if (UseBiasedLocking) {
 201     FreeHeap(((Thread*) p)-&gt;_real_malloc_address);
 202   } else {
 203     FreeHeap(p);
 204   }
 205 }
 206 
 207 void JavaThread::smr_delete() {
 208   if (_on_thread_list) {
 209     ThreadsSMRSupport::smr_delete(this);
 210   } else {
 211     delete this;
 212   }
 213 }
 214 
 215 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 216 // JavaThread
 217 
 218 DEBUG_ONLY(Thread* Thread::_starting_thread = NULL;)
 219 
 220 Thread::Thread() {
 221 
 222   DEBUG_ONLY(_run_state = PRE_CALL_RUN;)
 223 
 224   // stack and get_thread
 225   set_stack_base(NULL);
 226   set_stack_size(0);
 227   set_lgrp_id(-1);
 228   DEBUG_ONLY(clear_suspendible_thread();)
 229 
 230   // allocated data structures
 231   set_osthread(NULL);
 232   set_resource_area(new (mtThread)ResourceArea());
 233   DEBUG_ONLY(_current_resource_mark = NULL;)
 234   set_handle_area(new (mtThread) HandleArea(NULL));
 235   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, mtClass));
 236   set_active_handles(NULL);
 237   set_free_handle_block(NULL);
 238   set_last_handle_mark(NULL);
 239   DEBUG_ONLY(_missed_ic_stub_refill_verifier = NULL);
 240 
 241   // Initial value of zero ==&gt; never claimed.
 242   _threads_do_token = 0;
 243   _threads_hazard_ptr = NULL;
 244   _threads_list_ptr = NULL;
 245   _nested_threads_hazard_ptr_cnt = 0;
 246   _rcu_counter = 0;
 247 
 248   // the handle mark links itself to last_handle_mark
 249   new HandleMark(this);
 250 
 251   // plain initialization
 252   debug_only(_owned_locks = NULL;)
 253   NOT_PRODUCT(_no_safepoint_count = 0;)
 254   NOT_PRODUCT(_skip_gcalot = false;)
 255   _jvmti_env_iteration_count = 0;
 256   set_allocated_bytes(0);
 257   _vm_operation_started_count = 0;
 258   _vm_operation_completed_count = 0;
 259   _current_pending_monitor = NULL;
 260   _current_pending_monitor_is_from_java = true;
 261   _current_waiting_monitor = NULL;
 262   _current_pending_raw_monitor = NULL;
 263   _num_nested_signal = 0;
 264   om_free_list = NULL;
 265   om_free_count = 0;
 266   om_free_provision = 32;
 267   om_in_use_list = NULL;
 268   om_in_use_count = 0;
 269 
 270 #ifdef ASSERT
 271   _visited_for_critical_count = false;
 272 #endif
 273 
 274   _SR_lock = new Monitor(Mutex::suspend_resume, &quot;SR_lock&quot;, true,
 275                          Monitor::_safepoint_check_sometimes);
 276   _suspend_flags = 0;
 277 
 278   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 279   _hashStateX = os::random();
 280   _hashStateY = 842502087;
 281   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 282   _hashStateW = 273326509;
 283 
 284   _OnTrap   = 0;
 285   _Stalled  = 0;
 286   _TypeTag  = 0x2BAD;
 287 
 288   // Many of the following fields are effectively final - immutable
 289   // Note that nascent threads can&#39;t use the Native Monitor-Mutex
 290   // construct until the _MutexEvent is initialized ...
 291   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 292   // we might instead use a stack of ParkEvents that we could provision on-demand.
 293   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 294   // and ::Release()
 295   _ParkEvent   = ParkEvent::Allocate(this);
 296   _MuxEvent    = ParkEvent::Allocate(this);
 297 
 298 #ifdef CHECK_UNHANDLED_OOPS
 299   if (CheckUnhandledOops) {
 300     _unhandled_oops = new UnhandledOops(this);
 301   }
 302 #endif // CHECK_UNHANDLED_OOPS
 303 #ifdef ASSERT
 304   if (UseBiasedLocking) {
 305     assert(is_aligned(this, markWord::biased_lock_alignment), &quot;forced alignment of thread object failed&quot;);
 306     assert(this == _real_malloc_address ||
 307            this == align_up(_real_malloc_address, markWord::biased_lock_alignment),
 308            &quot;bug in forced alignment of thread objects&quot;);
 309   }
 310 #endif // ASSERT
 311 
 312   // Notify the barrier set that a thread is being created. The initial
 313   // thread is created before the barrier set is available.  The call to
 314   // BarrierSet::on_thread_create() for this thread is therefore deferred
 315   // to BarrierSet::set_barrier_set().
 316   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 317   if (barrier_set != NULL) {
 318     barrier_set-&gt;on_thread_create(this);
 319   } else {
 320     // Only the main thread should be created before the barrier set
 321     // and that happens just before Thread::current is set. No other thread
 322     // can attach as the VM is not created yet, so they can&#39;t execute this code.
 323     // If the main thread creates other threads before the barrier set that is an error.
 324     assert(Thread::current_or_null() == NULL, &quot;creating thread before barrier set&quot;);
 325   }
 326 }
 327 
 328 void Thread::initialize_thread_current() {
 329 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 330   assert(_thr_current == NULL, &quot;Thread::current already initialized&quot;);
 331   _thr_current = this;
 332 #endif
 333   assert(ThreadLocalStorage::thread() == NULL, &quot;ThreadLocalStorage::thread already initialized&quot;);
 334   ThreadLocalStorage::set_thread(this);
 335   assert(Thread::current() == ThreadLocalStorage::thread(), &quot;TLS mismatch!&quot;);
 336 }
 337 
 338 void Thread::clear_thread_current() {
 339   assert(Thread::current() == ThreadLocalStorage::thread(), &quot;TLS mismatch!&quot;);
 340 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 341   _thr_current = NULL;
 342 #endif
 343   ThreadLocalStorage::set_thread(NULL);
 344 }
 345 
 346 void Thread::record_stack_base_and_size() {
 347   // Note: at this point, Thread object is not yet initialized. Do not rely on
 348   // any members being initialized. Do not rely on Thread::current() being set.
 349   // If possible, refrain from doing anything which may crash or assert since
 350   // quite probably those crash dumps will be useless.
 351   set_stack_base(os::current_stack_base());
 352   set_stack_size(os::current_stack_size());
 353 
 354   // Set stack limits after thread is initialized.
 355   if (is_Java_thread()) {
 356     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 357     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 358   }
 359 }
 360 
 361 #if INCLUDE_NMT
 362 void Thread::register_thread_stack_with_NMT() {
 363   MemTracker::record_thread_stack(stack_end(), stack_size());
 364 }
 365 #endif // INCLUDE_NMT
 366 
 367 void Thread::call_run() {
 368   DEBUG_ONLY(_run_state = CALL_RUN;)
 369 
 370   // At this point, Thread object should be fully initialized and
 371   // Thread::current() should be set.
 372 
 373   assert(Thread::current_or_null() != NULL, &quot;current thread is unset&quot;);
 374   assert(Thread::current_or_null() == this, &quot;current thread is wrong&quot;);
 375 
 376   // Perform common initialization actions
 377 
 378   register_thread_stack_with_NMT();
 379 
 380   JFR_ONLY(Jfr::on_thread_start(this);)
 381 
 382   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack dimensions: &quot;
 383     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot;k).&quot;,
 384     os::current_thread_id(), p2i(stack_end()),
 385     p2i(stack_base()), stack_size()/1024);
 386 
 387   // Perform &lt;ChildClass&gt; initialization actions
 388   DEBUG_ONLY(_run_state = PRE_RUN;)
 389   this-&gt;pre_run();
 390 
 391   // Invoke &lt;ChildClass&gt;::run()
 392   DEBUG_ONLY(_run_state = RUN;)
 393   this-&gt;run();
 394   // Returned from &lt;ChildClass&gt;::run(). Thread finished.
 395 
 396   // Perform common tear-down actions
 397 
 398   assert(Thread::current_or_null() != NULL, &quot;current thread is unset&quot;);
 399   assert(Thread::current_or_null() == this, &quot;current thread is wrong&quot;);
 400 
 401   // Perform &lt;ChildClass&gt; tear-down actions
 402   DEBUG_ONLY(_run_state = POST_RUN;)
 403   this-&gt;post_run();
 404 
 405   // Note: at this point the thread object may already have deleted itself,
 406   // so from here on do not dereference *this*. Not all thread types currently
 407   // delete themselves when they terminate. But no thread should ever be deleted
 408   // asynchronously with respect to its termination - that is what _run_state can
 409   // be used to check.
 410 
 411   assert(Thread::current_or_null() == NULL, &quot;current thread still present&quot;);
 412 }
 413 
 414 Thread::~Thread() {
 415 
 416   // Attached threads will remain in PRE_CALL_RUN, as will threads that don&#39;t actually
 417   // get started due to errors etc. Any active thread should at least reach post_run
 418   // before it is deleted (usually in post_run()).
 419   assert(_run_state == PRE_CALL_RUN ||
 420          _run_state == POST_RUN, &quot;Active Thread deleted before post_run(): &quot;
 421          &quot;_run_state=%d&quot;, (int)_run_state);
 422 
 423   // Notify the barrier set that a thread is being destroyed. Note that a barrier
 424   // set might not be available if we encountered errors during bootstrapping.
 425   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 426   if (barrier_set != NULL) {
 427     barrier_set-&gt;on_thread_destroy(this);
 428   }
 429 
 430   // stack_base can be NULL if the thread is never started or exited before
 431   // record_stack_base_and_size called. Although, we would like to ensure
 432   // that all started threads do call record_stack_base_and_size(), there is
 433   // not proper way to enforce that.
 434 #if INCLUDE_NMT
 435   if (_stack_base != NULL) {
 436     MemTracker::release_thread_stack(stack_end(), stack_size());
 437 #ifdef ASSERT
 438     set_stack_base(NULL);
 439 #endif
 440   }
 441 #endif // INCLUDE_NMT
 442 
 443   // deallocate data structures
 444   delete resource_area();
 445   // since the handle marks are using the handle area, we have to deallocated the root
 446   // handle mark before deallocating the thread&#39;s handle area,
 447   assert(last_handle_mark() != NULL, &quot;check we have an element&quot;);
 448   delete last_handle_mark();
 449   assert(last_handle_mark() == NULL, &quot;check we have reached the end&quot;);
 450 
 451   // It&#39;s possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 452   // We NULL out the fields for good hygiene.
 453   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 454   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 455 
 456   delete handle_area();
 457   delete metadata_handles();
 458 
 459   // SR_handler uses this as a termination indicator -
 460   // needs to happen before os::free_thread()
 461   delete _SR_lock;
 462   _SR_lock = NULL;
 463 
 464   // osthread() can be NULL, if creation of thread failed.
 465   if (osthread() != NULL) os::free_thread(osthread());
 466 
 467   // Clear Thread::current if thread is deleting itself and it has not
 468   // already been done. This must be done before the memory is deallocated.
 469   // Needed to ensure JNI correctly detects non-attached threads.
 470   if (this == Thread::current_or_null()) {
 471     Thread::clear_thread_current();
 472   }
 473 
 474   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 475 }
 476 
 477 #ifdef ASSERT
 478 // A JavaThread is considered &quot;dangling&quot; if it is not the current
 479 // thread, has been added the Threads list, the system is not at a
 480 // safepoint and the Thread is not &quot;protected&quot;.
 481 //
 482 void Thread::check_for_dangling_thread_pointer(Thread *thread) {
 483   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread ||
 484          !((JavaThread *) thread)-&gt;on_thread_list() ||
 485          SafepointSynchronize::is_at_safepoint() ||
 486          ThreadsSMRSupport::is_a_protected_JavaThread_with_lock((JavaThread *) thread),
 487          &quot;possibility of dangling Thread pointer&quot;);
 488 }
 489 #endif
 490 
 491 ThreadPriority Thread::get_priority(const Thread* const thread) {
 492   ThreadPriority priority;
 493   // Can return an error!
 494   (void)os::get_priority(thread, priority);
 495   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, &quot;non-Java priority found&quot;);
 496   return priority;
 497 }
 498 
 499 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 500   debug_only(check_for_dangling_thread_pointer(thread);)
 501   // Can return an error!
 502   (void)os::set_priority(thread, priority);
 503 }
 504 
 505 
 506 void Thread::start(Thread* thread) {
 507   // Start is different from resume in that its safety is guaranteed by context or
 508   // being called from a Java method synchronized on the Thread object.
 509   if (!DisableStartThread) {
 510     if (thread-&gt;is_Java_thread()) {
 511       // Initialize the thread state to RUNNABLE before starting this thread.
 512       // Can not set it after the thread started because we do not know the
 513       // exact thread state at that time. It could be in MONITOR_WAIT or
 514       // in SLEEPING or some other state.
 515       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 516                                           java_lang_Thread::RUNNABLE);
 517     }
 518     os::start_thread(thread);
 519   }
 520 }
 521 
 522 class InstallAsyncExceptionClosure : public HandshakeClosure {
 523   Handle _throwable; // The Throwable thrown at the target Thread
 524 public:
 525   InstallAsyncExceptionClosure(Handle throwable) : HandshakeClosure(&quot;InstallAsyncException&quot;), _throwable(throwable) {}
 526 
 527   void do_thread(Thread* thr) {
 528     JavaThread* target = (JavaThread*)thr;
 529     // Note that this now allows multiple ThreadDeath exceptions to be
 530     // thrown at a thread.
 531     // The target thread has run and has not exited yet.
 532     target-&gt;send_thread_stop(_throwable());
 533   }
 534 };
 535 
 536 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 537   Handle throwable(Thread::current(), java_throwable);
 538   JavaThread* target = java_lang_Thread::thread(java_thread);
 539   InstallAsyncExceptionClosure vm_stop(throwable);
 540   Handshake::execute(&amp;vm_stop, target);
 541 }
 542 
 543 
 544 // Check if an external suspend request has completed (or has been
 545 // cancelled). Returns true if the thread is externally suspended and
 546 // false otherwise.
 547 //
 548 // The bits parameter returns information about the code path through
 549 // the routine. Useful for debugging:
 550 //
 551 // set in is_ext_suspend_completed():
 552 // 0x00000001 - routine was entered
 553 // 0x00000010 - routine return false at end
 554 // 0x00000100 - thread exited (return false)
 555 // 0x00000200 - suspend request cancelled (return false)
 556 // 0x00000400 - thread suspended (return true)
 557 // 0x00001000 - thread is in a suspend equivalent state (return true)
 558 // 0x00002000 - thread is native and walkable (return true)
 559 // 0x00004000 - thread is native_trans and walkable (needed retry)
 560 //
 561 // set in wait_for_ext_suspend_completion():
 562 // 0x00010000 - routine was entered
 563 // 0x00020000 - suspend request cancelled before loop (return false)
 564 // 0x00040000 - thread suspended before loop (return true)
 565 // 0x00080000 - suspend request cancelled in loop (return false)
 566 // 0x00100000 - thread suspended in loop (return true)
 567 // 0x00200000 - suspend not completed during retry loop (return false)
 568 
 569 // Helper class for tracing suspend wait debug bits.
 570 //
 571 // 0x00000100 indicates that the target thread exited before it could
 572 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 573 // 0x00080000 each indicate a cancelled suspend request so they don&#39;t
 574 // count as wait failures either.
 575 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 576 
 577 class TraceSuspendDebugBits : public StackObj {
 578  private:
 579   JavaThread * jt;
 580   bool         is_wait;
 581   bool         called_by_wait;  // meaningful when !is_wait
 582   uint32_t *   bits;
 583 
 584  public:
 585   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 586                         uint32_t *_bits) {
 587     jt             = _jt;
 588     is_wait        = _is_wait;
 589     called_by_wait = _called_by_wait;
 590     bits           = _bits;
 591   }
 592 
 593   ~TraceSuspendDebugBits() {
 594     if (!is_wait) {
 595 #if 1
 596       // By default, don&#39;t trace bits for is_ext_suspend_completed() calls.
 597       // That trace is very chatty.
 598       return;
 599 #else
 600       if (!called_by_wait) {
 601         // If tracing for is_ext_suspend_completed() is enabled, then only
 602         // trace calls to it from wait_for_ext_suspend_completion()
 603         return;
 604       }
 605 #endif
 606     }
 607 
 608     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 609       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 610         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 611         ResourceMark rm;
 612 
 613         tty-&gt;print_cr(
 614                       &quot;Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)&quot;,
 615                       jt-&gt;get_thread_name(), *bits);
 616 
 617         guarantee(!AssertOnSuspendWaitFailure, &quot;external suspend wait failed&quot;);
 618       }
 619     }
 620   }
 621 };
 622 #undef DEBUG_FALSE_BITS
 623 
 624 
 625 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 626                                           uint32_t *bits) {
 627   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 628 
 629   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 630   bool do_trans_retry;           // flag to force the retry
 631 
 632   *bits |= 0x00000001;
 633 
 634   do {
 635     do_trans_retry = false;
 636 
 637     if (is_exiting()) {
 638       // Thread is in the process of exiting. This is always checked
 639       // first to reduce the risk of dereferencing a freed JavaThread.
 640       *bits |= 0x00000100;
 641       return false;
 642     }
 643 
 644     if (!is_external_suspend()) {
 645       // Suspend request is cancelled. This is always checked before
 646       // is_ext_suspended() to reduce the risk of a rogue resume
 647       // confusing the thread that made the suspend request.
 648       *bits |= 0x00000200;
 649       return false;
 650     }
 651 
 652     if (is_ext_suspended()) {
 653       // thread is suspended
 654       *bits |= 0x00000400;
 655       return true;
 656     }
 657 
 658     // Now that we no longer do hard suspends of threads running
 659     // native code, the target thread can be changing thread state
 660     // while we are in this routine:
 661     //
 662     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 663     //
 664     // We save a copy of the thread state as observed at this moment
 665     // and make our decision about suspend completeness based on the
 666     // copy. This closes the race where the thread state is seen as
 667     // _thread_in_native_trans in the if-thread_blocked check, but is
 668     // seen as _thread_blocked in if-thread_in_native_trans check.
 669     JavaThreadState save_state = thread_state();
 670 
 671     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 672       // If the thread&#39;s state is _thread_blocked and this blocking
 673       // condition is known to be equivalent to a suspend, then we can
 674       // consider the thread to be externally suspended. This means that
 675       // the code that sets _thread_blocked has been modified to do
 676       // self-suspension if the blocking condition releases. We also
 677       // used to check for CONDVAR_WAIT here, but that is now covered by
 678       // the _thread_blocked with self-suspension check.
 679       //
 680       // Return true since we wouldn&#39;t be here unless there was still an
 681       // external suspend request.
 682       *bits |= 0x00001000;
 683       return true;
 684     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 685       // Threads running native code will self-suspend on native==&gt;VM/Java
 686       // transitions. If its stack is walkable (should always be the case
 687       // unless this function is called before the actual java_suspend()
 688       // call), then the wait is done.
 689       *bits |= 0x00002000;
 690       return true;
 691     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 692                save_state == _thread_in_native_trans &amp;&amp;
 693                frame_anchor()-&gt;walkable()) {
 694       // The thread is transitioning from thread_in_native to another
 695       // thread state. check_safepoint_and_suspend_for_native_trans()
 696       // will force the thread to self-suspend. If it hasn&#39;t gotten
 697       // there yet we may have caught the thread in-between the native
 698       // code check above and the self-suspend. Lucky us. If we were
 699       // called by wait_for_ext_suspend_completion(), then it
 700       // will be doing the retries so we don&#39;t have to.
 701       //
 702       // Since we use the saved thread state in the if-statement above,
 703       // there is a chance that the thread has already transitioned to
 704       // _thread_blocked by the time we get here. In that case, we will
 705       // make a single unnecessary pass through the logic below. This
 706       // doesn&#39;t hurt anything since we still do the trans retry.
 707 
 708       *bits |= 0x00004000;
 709 
 710       // Once the thread leaves thread_in_native_trans for another
 711       // thread state, we break out of this retry loop. We shouldn&#39;t
 712       // need this flag to prevent us from getting back here, but
 713       // sometimes paranoia is good.
 714       did_trans_retry = true;
 715 
 716       // We wait for the thread to transition to a more usable state.
 717       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 718         // We used to do an &quot;os::yield_all(i)&quot; call here with the intention
 719         // that yielding would increase on each retry. However, the parameter
 720         // is ignored on Linux which means the yield didn&#39;t scale up. Waiting
 721         // on the SR_lock below provides a much more predictable scale up for
 722         // the delay. It also provides a simple/direct point to check for any
 723         // safepoint requests from the VMThread
 724 
 725         // temporarily drops SR_lock while doing wait with safepoint check
 726         // (if we&#39;re a JavaThread - the WatcherThread can also call this)
 727         // and increase delay with each retry
 728         if (Thread::current()-&gt;is_Java_thread()) {
 729           SR_lock()-&gt;wait(i * delay);
 730         } else {
 731           SR_lock()-&gt;wait_without_safepoint_check(i * delay);
 732         }
 733 
 734         // check the actual thread state instead of what we saved above
 735         if (thread_state() != _thread_in_native_trans) {
 736           // the thread has transitioned to another thread state so
 737           // try all the checks (except this one) one more time.
 738           do_trans_retry = true;
 739           break;
 740         }
 741       } // end retry loop
 742 
 743 
 744     }
 745   } while (do_trans_retry);
 746 
 747   *bits |= 0x00000010;
 748   return false;
 749 }
 750 
 751 // Wait for an external suspend request to complete (or be cancelled).
 752 // Returns true if the thread is externally suspended and false otherwise.
 753 //
 754 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 755                                                  uint32_t *bits) {
 756   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 757                              false /* !called_by_wait */, bits);
 758 
 759   // local flag copies to minimize SR_lock hold time
 760   bool is_suspended;
 761   bool pending;
 762   uint32_t reset_bits;
 763 
 764   // set a marker so is_ext_suspend_completed() knows we are the caller
 765   *bits |= 0x00010000;
 766 
 767   // We use reset_bits to reinitialize the bits value at the top of
 768   // each retry loop. This allows the caller to make use of any
 769   // unused bits for their own marking purposes.
 770   reset_bits = *bits;
 771 
 772   {
 773     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 774     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 775                                             delay, bits);
 776     pending = is_external_suspend();
 777   }
 778   // must release SR_lock to allow suspension to complete
 779 
 780   if (!pending) {
 781     // A cancelled suspend request is the only false return from
 782     // is_ext_suspend_completed() that keeps us from entering the
 783     // retry loop.
 784     *bits |= 0x00020000;
 785     return false;
 786   }
 787 
 788   if (is_suspended) {
 789     *bits |= 0x00040000;
 790     return true;
 791   }
 792 
 793   for (int i = 1; i &lt;= retries; i++) {
 794     *bits = reset_bits;  // reinit to only track last retry
 795 
 796     // We used to do an &quot;os::yield_all(i)&quot; call here with the intention
 797     // that yielding would increase on each retry. However, the parameter
 798     // is ignored on Linux which means the yield didn&#39;t scale up. Waiting
 799     // on the SR_lock below provides a much more predictable scale up for
 800     // the delay. It also provides a simple/direct point to check for any
 801     // safepoint requests from the VMThread
 802 
 803     {
 804       Thread* t = Thread::current();
 805       MonitorLocker ml(SR_lock(),
 806                        t-&gt;is_Java_thread() ? Mutex::_safepoint_check_flag : Mutex::_no_safepoint_check_flag);
 807       // wait with safepoint check (if we&#39;re a JavaThread - the WatcherThread
 808       // can also call this)  and increase delay with each retry
 809       ml.wait(i * delay);
 810 
 811       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 812                                               delay, bits);
 813 
 814       // It is possible for the external suspend request to be cancelled
 815       // (by a resume) before the actual suspend operation is completed.
 816       // Refresh our local copy to see if we still need to wait.
 817       pending = is_external_suspend();
 818     }
 819 
 820     if (!pending) {
 821       // A cancelled suspend request is the only false return from
 822       // is_ext_suspend_completed() that keeps us from staying in the
 823       // retry loop.
 824       *bits |= 0x00080000;
 825       return false;
 826     }
 827 
 828     if (is_suspended) {
 829       *bits |= 0x00100000;
 830       return true;
 831     }
 832   } // end retry loop
 833 
 834   // thread did not suspend after all our retries
 835   *bits |= 0x00200000;
 836   return false;
 837 }
 838 
 839 // Called from API entry points which perform stack walking. If the
 840 // associated JavaThread is the current thread, then wait_for_suspend
 841 // is not used. Otherwise, it determines if we should wait for the
 842 // &quot;other&quot; thread to complete external suspension. (NOTE: in future
 843 // releases the suspension mechanism should be reimplemented so this
 844 // is not necessary.)
 845 //
 846 bool
 847 JavaThread::is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits) {
 848   if (this != JavaThread::current()) {
 849     // &quot;other&quot; threads require special handling.
 850     if (wait_for_suspend) {
 851       // We are allowed to wait for the external suspend to complete
 852       // so give the other thread a chance to get suspended.
 853       if (!wait_for_ext_suspend_completion(SuspendRetryCount,
 854                                            SuspendRetryDelay, bits)) {
 855         // Didn&#39;t make it so let the caller know.
 856         return false;
 857       }
 858     }
 859     // We aren&#39;t allowed to wait for the external suspend to complete
 860     // so if the other thread isn&#39;t externally suspended we need to
 861     // let the caller know.
 862     else if (!is_ext_suspend_completed_with_lock(bits)) {
 863       return false;
 864     }
 865   }
 866 
 867   return true;
 868 }
 869 
 870 // GC Support
 871 bool Thread::claim_par_threads_do(uintx claim_token) {
 872   uintx token = _threads_do_token;
 873   if (token != claim_token) {
 874     uintx res = Atomic::cmpxchg(&amp;_threads_do_token, token, claim_token);
 875     if (res == token) {
 876       return true;
 877     }
 878     guarantee(res == claim_token, &quot;invariant&quot;);
 879   }
 880   return false;
 881 }
 882 
 883 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 884   if (active_handles() != NULL) {
 885     active_handles()-&gt;oops_do(f);
 886   }
 887   // Do oop for ThreadShadow
 888   f-&gt;do_oop((oop*)&amp;_pending_exception);
 889   handle_area()-&gt;oops_do(f);
 890 
 891   // We scan thread local monitor lists here, and the remaining global
 892   // monitors in ObjectSynchronizer::oops_do().
 893   ObjectSynchronizer::thread_local_used_oops_do(this, f);
 894 }
 895 
 896 void Thread::metadata_handles_do(void f(Metadata*)) {
 897   // Only walk the Handles in Thread.
 898   if (metadata_handles() != NULL) {
 899     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 900       f(metadata_handles()-&gt;at(i));
 901     }
 902   }
 903 }
 904 
 905 void Thread::print_on(outputStream* st, bool print_extended_info) const {
 906   // get_priority assumes osthread initialized
 907   if (osthread() != NULL) {
 908     int os_prio;
 909     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 910       st-&gt;print(&quot;os_prio=%d &quot;, os_prio);
 911     }
 912 
 913     st-&gt;print(&quot;cpu=%.2fms &quot;,
 914               os::thread_cpu_time(const_cast&lt;Thread*&gt;(this), true) / 1000000.0
 915               );
 916     st-&gt;print(&quot;elapsed=%.2fs &quot;,
 917               _statistical_info.getElapsedTime() / 1000.0
 918               );
 919     if (is_Java_thread() &amp;&amp; (PrintExtendedThreadInfo || print_extended_info)) {
 920       size_t allocated_bytes = (size_t) const_cast&lt;Thread*&gt;(this)-&gt;cooked_allocated_bytes();
 921       st-&gt;print(&quot;allocated=&quot; SIZE_FORMAT &quot;%s &quot;,
 922                 byte_size_in_proper_unit(allocated_bytes),
 923                 proper_unit_for_byte_size(allocated_bytes)
 924                 );
 925       st-&gt;print(&quot;defined_classes=&quot; INT64_FORMAT &quot; &quot;, _statistical_info.getDefineClassCount());
 926     }
 927 
 928     st-&gt;print(&quot;tid=&quot; INTPTR_FORMAT &quot; &quot;, p2i(this));
 929     osthread()-&gt;print_on(st);
 930   }
 931   ThreadsSMRSupport::print_info_on(this, st);
 932   st-&gt;print(&quot; &quot;);
 933   debug_only(if (WizardMode) print_owned_locks_on(st);)
 934 }
 935 
 936 void Thread::print() const { print_on(tty); }
 937 
 938 // Thread::print_on_error() is called by fatal error handler. Don&#39;t use
 939 // any lock or allocate memory.
 940 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 941   assert(!(is_Compiler_thread() || is_Java_thread()), &quot;Can&#39;t call name() here if it allocates&quot;);
 942 
 943   if (is_VM_thread())                 { st-&gt;print(&quot;VMThread&quot;); }
 944   else if (is_GC_task_thread())       { st-&gt;print(&quot;GCTaskThread&quot;); }
 945   else if (is_Watcher_thread())       { st-&gt;print(&quot;WatcherThread&quot;); }
 946   else if (is_ConcurrentGC_thread())  { st-&gt;print(&quot;ConcurrentGCThread&quot;); }
 947   else                                { st-&gt;print(&quot;Thread&quot;); }
 948 
 949   if (is_Named_thread()) {
 950     st-&gt;print(&quot; \&quot;%s\&quot;&quot;, name());
 951   }
 952 
 953   st-&gt;print(&quot; [stack: &quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;]&quot;,
 954             p2i(stack_end()), p2i(stack_base()));
 955 
 956   if (osthread()) {
 957     st-&gt;print(&quot; [id=%d]&quot;, osthread()-&gt;thread_id());
 958   }
 959 
 960   ThreadsSMRSupport::print_info_on(this, st);
 961 }
 962 
 963 void Thread::print_value_on(outputStream* st) const {
 964   if (is_Named_thread()) {
 965     st-&gt;print(&quot; \&quot;%s\&quot; &quot;, name());
 966   }
 967   st-&gt;print(INTPTR_FORMAT, p2i(this));   // print address
 968 }
 969 
 970 #ifdef ASSERT
 971 void Thread::print_owned_locks_on(outputStream* st) const {
 972   Mutex* cur = _owned_locks;
 973   if (cur == NULL) {
 974     st-&gt;print(&quot; (no locks) &quot;);
 975   } else {
 976     st-&gt;print_cr(&quot; Locks owned:&quot;);
 977     while (cur) {
 978       cur-&gt;print_on(st);
 979       cur = cur-&gt;next();
 980     }
 981   }
 982 }
 983 
 984 // Checks safepoint allowed and clears unhandled oops at potential safepoints.
 985 void Thread::check_possible_safepoint() {
 986   if (!is_Java_thread()) return;
 987 
 988   if (_no_safepoint_count &gt; 0) {
 989     print_owned_locks();
 990     fatal(&quot;Possible safepoint reached by thread that does not allow it&quot;);
 991   }
 992 #ifdef CHECK_UNHANDLED_OOPS
 993   // Clear unhandled oops in JavaThreads so we get a crash right away.
 994   clear_unhandled_oops();
 995 #endif // CHECK_UNHANDLED_OOPS
 996 }
 997 
 998 void Thread::check_for_valid_safepoint_state() {
 999   if (!is_Java_thread()) return;
1000 
1001   // Check NoSafepointVerifier, which is implied by locks taken that can be
1002   // shared with the VM thread.  This makes sure that no locks with allow_vm_block
1003   // are held.
1004   check_possible_safepoint();
1005 
1006   if (((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
1007     fatal(&quot;LEAF method calling lock?&quot;);
1008   }
1009 
1010   if (GCALotAtAllSafepoints) {
1011     // We could enter a safepoint here and thus have a gc
1012     InterfaceSupport::check_gc_alot();
1013   }
1014 }
1015 #endif // ASSERT
1016 
1017 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
1018 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
1019 // used for compilation in the future. If that change is made, the need for these methods
1020 // should be revisited, and they should be removed if possible.
1021 
1022 bool Thread::is_lock_owned(address adr) const {
1023   return is_in_full_stack(adr);
1024 }
1025 
1026 bool Thread::set_as_starting_thread() {
1027   assert(_starting_thread == NULL, &quot;already initialized: &quot;
1028          &quot;_starting_thread=&quot; INTPTR_FORMAT, p2i(_starting_thread));
1029   // NOTE: this must be called inside the main thread.
1030   DEBUG_ONLY(_starting_thread = this;)
1031   return os::create_main_thread((JavaThread*)this);
1032 }
1033 
1034 static void initialize_class(Symbol* class_name, TRAPS) {
1035   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
1036   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1037 }
1038 
1039 
1040 // Creates the initial ThreadGroup
1041 static Handle create_initial_thread_group(TRAPS) {
1042   Handle system_instance = JavaCalls::construct_new_instance(
1043                             SystemDictionary::ThreadGroup_klass(),
1044                             vmSymbols::void_method_signature(),
1045                             CHECK_NH);
1046   Universe::set_system_thread_group(system_instance());
1047 
1048   Handle string = java_lang_String::create_from_str(&quot;main&quot;, CHECK_NH);
1049   Handle main_instance = JavaCalls::construct_new_instance(
1050                             SystemDictionary::ThreadGroup_klass(),
1051                             vmSymbols::threadgroup_string_void_signature(),
1052                             system_instance,
1053                             string,
1054                             CHECK_NH);
1055   return main_instance;
1056 }
1057 
1058 // Creates the initial Thread
1059 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
1060                                  TRAPS) {
1061   InstanceKlass* ik = SystemDictionary::Thread_klass();
1062   assert(ik-&gt;is_initialized(), &quot;must be&quot;);
1063   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK_NULL);
1064 
1065   // Cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1066   // constructor calls Thread.current(), which must be set here for the
1067   // initial thread.
1068   java_lang_Thread::set_thread(thread_oop(), thread);
1069   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1070   thread-&gt;set_threadObj(thread_oop());
1071 
1072   Handle string = java_lang_String::create_from_str(&quot;main&quot;, CHECK_NULL);
1073 
1074   JavaValue result(T_VOID);
1075   JavaCalls::call_special(&amp;result, thread_oop,
1076                           ik,
1077                           vmSymbols::object_initializer_name(),
1078                           vmSymbols::threadgroup_string_void_signature(),
1079                           thread_group,
1080                           string,
1081                           CHECK_NULL);
1082   return thread_oop();
1083 }
1084 
1085 char java_runtime_name[128] = &quot;&quot;;
1086 char java_runtime_version[128] = &quot;&quot;;
1087 char java_runtime_vendor_version[128] = &quot;&quot;;
1088 char java_runtime_vendor_vm_bug_url[128] = &quot;&quot;;
1089 
1090 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1091 static const char* get_java_runtime_name(TRAPS) {
1092   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1093                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1094   fieldDescriptor fd;
1095   bool found = k != NULL &amp;&amp;
1096                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1097                                                         vmSymbols::string_signature(), &amp;fd);
1098   if (found) {
1099     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1100     if (name_oop == NULL) {
1101       return NULL;
1102     }
1103     const char* name = java_lang_String::as_utf8_string(name_oop,
1104                                                         java_runtime_name,
1105                                                         sizeof(java_runtime_name));
1106     return name;
1107   } else {
1108     return NULL;
1109   }
1110 }
1111 
1112 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1113 static const char* get_java_runtime_version(TRAPS) {
1114   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1115                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1116   fieldDescriptor fd;
1117   bool found = k != NULL &amp;&amp;
1118                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1119                                                         vmSymbols::string_signature(), &amp;fd);
1120   if (found) {
1121     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1122     if (name_oop == NULL) {
1123       return NULL;
1124     }
1125     const char* name = java_lang_String::as_utf8_string(name_oop,
1126                                                         java_runtime_version,
1127                                                         sizeof(java_runtime_version));
1128     return name;
1129   } else {
1130     return NULL;
1131   }
1132 }
1133 
1134 // extract the JRE vendor version from java.lang.VersionProps.VENDOR_VERSION
1135 static const char* get_java_runtime_vendor_version(TRAPS) {
1136   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1137                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1138   fieldDescriptor fd;
1139   bool found = k != NULL &amp;&amp;
1140                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_vendor_version_name(),
1141                                                         vmSymbols::string_signature(), &amp;fd);
1142   if (found) {
1143     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1144     if (name_oop == NULL) {
1145       return NULL;
1146     }
1147     const char* name = java_lang_String::as_utf8_string(name_oop,
1148                                                         java_runtime_vendor_version,
1149                                                         sizeof(java_runtime_vendor_version));
1150     return name;
1151   } else {
1152     return NULL;
1153   }
1154 }
1155 
1156 // extract the JRE vendor VM bug URL from java.lang.VersionProps.VENDOR_URL_VM_BUG
1157 static const char* get_java_runtime_vendor_vm_bug_url(TRAPS) {
1158   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1159                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1160   fieldDescriptor fd;
1161   bool found = k != NULL &amp;&amp;
1162                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_vendor_vm_bug_url_name(),
1163                                                         vmSymbols::string_signature(), &amp;fd);
1164   if (found) {
1165     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1166     if (name_oop == NULL) {
1167       return NULL;
1168     }
1169     const char* name = java_lang_String::as_utf8_string(name_oop,
1170                                                         java_runtime_vendor_vm_bug_url,
1171                                                         sizeof(java_runtime_vendor_vm_bug_url));
1172     return name;
1173   } else {
1174     return NULL;
1175   }
1176 }
1177 
1178 // General purpose hook into Java code, run once when the VM is initialized.
1179 // The Java library method itself may be changed independently from the VM.
1180 static void call_postVMInitHook(TRAPS) {
1181   Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1182   if (klass != NULL) {
1183     JavaValue result(T_VOID);
1184     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1185                            vmSymbols::void_method_signature(),
1186                            CHECK);
1187   }
1188 }
1189 
1190 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1191                                     bool daemon, TRAPS) {
1192   assert(thread_group.not_null(), &quot;thread group should be specified&quot;);
1193   assert(threadObj() == NULL, &quot;should only create Java thread object once&quot;);
1194 
1195   InstanceKlass* ik = SystemDictionary::Thread_klass();
1196   assert(ik-&gt;is_initialized(), &quot;must be&quot;);
1197   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK);
1198 
1199   // We are called from jni_AttachCurrentThread/jni_AttachCurrentThreadAsDaemon.
1200   // We cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1201   // constructor calls Thread.current(), which must be set here.
1202   java_lang_Thread::set_thread(thread_oop(), this);
1203   java_lang_Thread::set_priority(thread_oop(), NormPriority);
1204   set_threadObj(thread_oop());
1205 
1206   JavaValue result(T_VOID);
1207   if (thread_name != NULL) {
1208     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1209     // Thread gets assigned specified name and null target
1210     JavaCalls::call_special(&amp;result,
1211                             thread_oop,
1212                             ik,
1213                             vmSymbols::object_initializer_name(),
1214                             vmSymbols::threadgroup_string_void_signature(),
1215                             thread_group,
1216                             name,
1217                             THREAD);
1218   } else {
1219     // Thread gets assigned name &quot;Thread-nnn&quot; and null target
1220     // (java.lang.Thread doesn&#39;t have a constructor taking only a ThreadGroup argument)
1221     JavaCalls::call_special(&amp;result,
1222                             thread_oop,
1223                             ik,
1224                             vmSymbols::object_initializer_name(),
1225                             vmSymbols::threadgroup_runnable_void_signature(),
1226                             thread_group,
1227                             Handle(),
1228                             THREAD);
1229   }
1230 
1231 
1232   if (daemon) {
1233     java_lang_Thread::set_daemon(thread_oop());
1234   }
1235 
1236   if (HAS_PENDING_EXCEPTION) {
1237     return;
1238   }
1239 
1240   Klass* group = SystemDictionary::ThreadGroup_klass();
1241   Handle threadObj(THREAD, this-&gt;threadObj());
1242 
1243   JavaCalls::call_special(&amp;result,
1244                           thread_group,
1245                           group,
1246                           vmSymbols::add_method_name(),
1247                           vmSymbols::thread_void_signature(),
1248                           threadObj,          // Arg 1
1249                           THREAD);
1250 }
1251 
1252 // List of all NonJavaThreads and safe iteration over that list.
1253 
1254 class NonJavaThread::List {
1255 public:
1256   NonJavaThread* volatile _head;
1257   SingleWriterSynchronizer _protect;
1258 
1259   List() : _head(NULL), _protect() {}
1260 };
1261 
1262 NonJavaThread::List NonJavaThread::_the_list;
1263 
1264 NonJavaThread::Iterator::Iterator() :
1265   _protect_enter(_the_list._protect.enter()),
1266   _current(Atomic::load_acquire(&amp;_the_list._head))
1267 {}
1268 
1269 NonJavaThread::Iterator::~Iterator() {
1270   _the_list._protect.exit(_protect_enter);
1271 }
1272 
1273 void NonJavaThread::Iterator::step() {
1274   assert(!end(), &quot;precondition&quot;);
1275   _current = Atomic::load_acquire(&amp;_current-&gt;_next);
1276 }
1277 
1278 NonJavaThread::NonJavaThread() : Thread(), _next(NULL) {
1279   assert(BarrierSet::barrier_set() != NULL, &quot;NonJavaThread created too soon!&quot;);
1280 }
1281 
1282 NonJavaThread::~NonJavaThread() { }
1283 
1284 void NonJavaThread::add_to_the_list() {
1285   MutexLocker ml(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1286   // Initialize BarrierSet-related data before adding to list.
1287   BarrierSet::barrier_set()-&gt;on_thread_attach(this);
1288   Atomic::release_store(&amp;_next, _the_list._head);
1289   Atomic::release_store(&amp;_the_list._head, this);
1290 }
1291 
1292 void NonJavaThread::remove_from_the_list() {
1293   {
1294     MutexLocker ml(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1295     // Cleanup BarrierSet-related data before removing from list.
1296     BarrierSet::barrier_set()-&gt;on_thread_detach(this);
1297     NonJavaThread* volatile* p = &amp;_the_list._head;
1298     for (NonJavaThread* t = *p; t != NULL; p = &amp;t-&gt;_next, t = *p) {
1299       if (t == this) {
1300         *p = _next;
1301         break;
1302       }
1303     }
1304   }
1305   // Wait for any in-progress iterators.  Concurrent synchronize is not
1306   // allowed, so do it while holding a dedicated lock.  Outside and distinct
1307   // from NJTList_lock in case an iteration attempts to lock it.
1308   MutexLocker ml(NonJavaThreadsListSync_lock, Mutex::_no_safepoint_check_flag);
1309   _the_list._protect.synchronize();
1310   _next = NULL;                 // Safe to drop the link now.
1311 }
1312 
1313 void NonJavaThread::pre_run() {
1314   add_to_the_list();
1315 
1316   // This is slightly odd in that NamedThread is a subclass, but
1317   // in fact name() is defined in Thread
1318   assert(this-&gt;name() != NULL, &quot;thread name was not set before it was started&quot;);
1319   this-&gt;set_native_thread_name(this-&gt;name());
1320 }
1321 
1322 void NonJavaThread::post_run() {
1323   JFR_ONLY(Jfr::on_thread_exit(this);)
1324   remove_from_the_list();
1325   // Ensure thread-local-storage is cleared before termination.
1326   Thread::clear_thread_current();
1327 }
1328 
1329 // NamedThread --  non-JavaThread subclasses with multiple
1330 // uniquely named instances should derive from this.
1331 NamedThread::NamedThread() :
1332   NonJavaThread(),
1333   _name(NULL),
1334   _processed_thread(NULL),
1335   _gc_id(GCId::undefined())
1336 {}
1337 
1338 NamedThread::~NamedThread() {
1339   FREE_C_HEAP_ARRAY(char, _name);
1340 }
1341 
1342 void NamedThread::set_name(const char* format, ...) {
1343   guarantee(_name == NULL, &quot;Only get to set name once.&quot;);
1344   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1345   va_list ap;
1346   va_start(ap, format);
1347   jio_vsnprintf(_name, max_name_len, format, ap);
1348   va_end(ap);
1349 }
1350 
1351 void NamedThread::print_on(outputStream* st) const {
1352   st-&gt;print(&quot;\&quot;%s\&quot; &quot;, name());
1353   Thread::print_on(st);
1354   st-&gt;cr();
1355 }
1356 
1357 
1358 // ======= WatcherThread ========
1359 
1360 // The watcher thread exists to simulate timer interrupts.  It should
1361 // be replaced by an abstraction over whatever native support for
1362 // timer interrupts exists on the platform.
1363 
1364 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1365 bool WatcherThread::_startable = false;
1366 volatile bool  WatcherThread::_should_terminate = false;
1367 
1368 WatcherThread::WatcherThread() : NonJavaThread() {
1369   assert(watcher_thread() == NULL, &quot;we can only allocate one WatcherThread&quot;);
1370   if (os::create_thread(this, os::watcher_thread)) {
1371     _watcher_thread = this;
1372 
1373     // Set the watcher thread to the highest OS priority which should not be
1374     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1375     // is created. The only normal thread using this priority is the reference
1376     // handler thread, which runs for very short intervals only.
1377     // If the VMThread&#39;s priority is not lower than the WatcherThread profiling
1378     // will be inaccurate.
1379     os::set_priority(this, MaxPriority);
1380     if (!DisableStartThread) {
1381       os::start_thread(this);
1382     }
1383   }
1384 }
1385 
1386 int WatcherThread::sleep() const {
1387   // The WatcherThread does not participate in the safepoint protocol
1388   // for the PeriodicTask_lock because it is not a JavaThread.
1389   MonitorLocker ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1390 
1391   if (_should_terminate) {
1392     // check for termination before we do any housekeeping or wait
1393     return 0;  // we did not sleep.
1394   }
1395 
1396   // remaining will be zero if there are no tasks,
1397   // causing the WatcherThread to sleep until a task is
1398   // enrolled
1399   int remaining = PeriodicTask::time_to_wait();
1400   int time_slept = 0;
1401 
1402   // we expect this to timeout - we only ever get unparked when
1403   // we should terminate or when a new task has been enrolled
1404   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1405 
1406   jlong time_before_loop = os::javaTimeNanos();
1407 
1408   while (true) {
1409     bool timedout = ml.wait(remaining);
1410     jlong now = os::javaTimeNanos();
1411 
1412     if (remaining == 0) {
1413       // if we didn&#39;t have any tasks we could have waited for a long time
1414       // consider the time_slept zero and reset time_before_loop
1415       time_slept = 0;
1416       time_before_loop = now;
1417     } else {
1418       // need to recalculate since we might have new tasks in _tasks
1419       time_slept = (int) ((now - time_before_loop) / 1000000);
1420     }
1421 
1422     // Change to task list or spurious wakeup of some kind
1423     if (timedout || _should_terminate) {
1424       break;
1425     }
1426 
1427     remaining = PeriodicTask::time_to_wait();
1428     if (remaining == 0) {
1429       // Last task was just disenrolled so loop around and wait until
1430       // another task gets enrolled
1431       continue;
1432     }
1433 
1434     remaining -= time_slept;
1435     if (remaining &lt;= 0) {
1436       break;
1437     }
1438   }
1439 
1440   return time_slept;
1441 }
1442 
1443 void WatcherThread::run() {
1444   assert(this == watcher_thread(), &quot;just checking&quot;);
1445 
1446   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1447   while (true) {
1448     assert(watcher_thread() == Thread::current(), &quot;thread consistency check&quot;);
1449     assert(watcher_thread() == this, &quot;thread consistency check&quot;);
1450 
1451     // Calculate how long it&#39;ll be until the next PeriodicTask work
1452     // should be done, and sleep that amount of time.
1453     int time_waited = sleep();
1454 
1455     if (VMError::is_error_reported()) {
1456       // A fatal error has happened, the error handler(VMError::report_and_die)
1457       // should abort JVM after creating an error log file. However in some
1458       // rare cases, the error handler itself might deadlock. Here periodically
1459       // check for error reporting timeouts, and if it happens, just proceed to
1460       // abort the VM.
1461 
1462       // This code is in WatcherThread because WatcherThread wakes up
1463       // periodically so the fatal error handler doesn&#39;t need to do anything;
1464       // also because the WatcherThread is less likely to crash than other
1465       // threads.
1466 
1467       for (;;) {
1468         // Note: we use naked sleep in this loop because we want to avoid using
1469         // any kind of VM infrastructure which may be broken at this point.
1470         if (VMError::check_timeout()) {
1471           // We hit error reporting timeout. Error reporting was interrupted and
1472           // will be wrapping things up now (closing files etc). Give it some more
1473           // time, then quit the VM.
1474           os::naked_short_sleep(200);
1475           // Print a message to stderr.
1476           fdStream err(defaultStream::output_fd());
1477           err.print_raw_cr(&quot;# [ timer expired, abort... ]&quot;);
1478           // skip atexit/vm_exit/vm_abort hooks
1479           os::die();
1480         }
1481 
1482         // Wait a second, then recheck for timeout.
1483         os::naked_short_sleep(999);
1484       }
1485     }
1486 
1487     if (_should_terminate) {
1488       // check for termination before posting the next tick
1489       break;
1490     }
1491 
1492     PeriodicTask::real_time_tick(time_waited);
1493   }
1494 
1495   // Signal that it is terminated
1496   {
1497     MutexLocker mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1498     _watcher_thread = NULL;
1499     Terminator_lock-&gt;notify_all();
1500   }
1501 }
1502 
1503 void WatcherThread::start() {
1504   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1505 
1506   if (watcher_thread() == NULL &amp;&amp; _startable) {
1507     _should_terminate = false;
1508     // Create the single instance of WatcherThread
1509     new WatcherThread();
1510   }
1511 }
1512 
1513 void WatcherThread::make_startable() {
1514   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1515   _startable = true;
1516 }
1517 
1518 void WatcherThread::stop() {
1519   {
1520     // Follow normal safepoint aware lock enter protocol since the
1521     // WatcherThread is stopped by another JavaThread.
1522     MutexLocker ml(PeriodicTask_lock);
1523     _should_terminate = true;
1524 
1525     WatcherThread* watcher = watcher_thread();
1526     if (watcher != NULL) {
1527       // unpark the WatcherThread so it can see that it should terminate
1528       watcher-&gt;unpark();
1529     }
1530   }
1531 
1532   MonitorLocker mu(Terminator_lock);
1533 
1534   while (watcher_thread() != NULL) {
1535     // This wait should make safepoint checks, wait without a timeout,
1536     // and wait as a suspend-equivalent condition.
1537     mu.wait(0, Mutex::_as_suspend_equivalent_flag);
1538   }
1539 }
1540 
1541 void WatcherThread::unpark() {
1542   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1543   PeriodicTask_lock-&gt;notify();
1544 }
1545 
1546 void WatcherThread::print_on(outputStream* st) const {
1547   st-&gt;print(&quot;\&quot;%s\&quot; &quot;, name());
1548   Thread::print_on(st);
1549   st-&gt;cr();
1550 }
1551 
1552 // ======= JavaThread ========
1553 
1554 #if INCLUDE_JVMCI
1555 
1556 jlong* JavaThread::_jvmci_old_thread_counters;
1557 
1558 bool jvmci_counters_include(JavaThread* thread) {
1559   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1560 }
1561 
1562 void JavaThread::collect_counters(jlong* array, int length) {
1563   assert(length == JVMCICounterSize, &quot;wrong value&quot;);
1564   for (int i = 0; i &lt; length; i++) {
1565     array[i] = _jvmci_old_thread_counters[i];
1566   }
1567   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *tp = jtiwh.next(); ) {
1568     if (jvmci_counters_include(tp)) {
1569       for (int i = 0; i &lt; length; i++) {
1570         array[i] += tp-&gt;_jvmci_counters[i];
1571       }
1572     }
1573   }
1574 }
1575 
1576 // Attempt to enlarge the array for per thread counters.
1577 jlong* resize_counters_array(jlong* old_counters, int current_size, int new_size) {
<a name="1" id="anc1"></a><span class="line-modified">1578   jlong* new_counters = NEW_C_HEAP_ARRAY_RETURN_NULL(jlong, new_size, mtJVMCI);</span>
<span class="line-added">1579   if (new_counters == NULL) {</span>
<span class="line-added">1580     return NULL;</span>
<span class="line-added">1581   }</span>
1582   if (old_counters == NULL) {
1583     old_counters = new_counters;
1584     memset(old_counters, 0, sizeof(jlong) * new_size);
1585   } else {
1586     for (int i = 0; i &lt; MIN2((int) current_size, new_size); i++) {
1587       new_counters[i] = old_counters[i];
1588     }
1589     if (new_size &gt; current_size) {
1590       memset(new_counters + current_size, 0, sizeof(jlong) * (new_size - current_size));
1591     }
1592     FREE_C_HEAP_ARRAY(jlong, old_counters);
1593   }
1594   return new_counters;
1595 }
1596 
1597 // Attempt to enlarge the array for per thread counters.
<a name="2" id="anc2"></a><span class="line-modified">1598 bool JavaThread::resize_counters(int current_size, int new_size) {</span>
<span class="line-modified">1599   jlong* new_counters = resize_counters_array(_jvmci_counters, current_size, new_size);</span>
<span class="line-added">1600   if (new_counters == NULL) {</span>
<span class="line-added">1601     return false;</span>
<span class="line-added">1602   } else {</span>
<span class="line-added">1603     _jvmci_counters = new_counters;</span>
<span class="line-added">1604     return true;</span>
<span class="line-added">1605   }</span>
1606 }
1607 
1608 class VM_JVMCIResizeCounters : public VM_Operation {
1609  private:
1610   int _new_size;
<a name="3" id="anc3"></a><span class="line-added">1611   bool _failed;</span>
1612 
1613  public:
<a name="4" id="anc4"></a><span class="line-modified">1614   VM_JVMCIResizeCounters(int new_size) : _new_size(new_size), _failed(false) { }</span>
1615   VMOp_Type type()                  const        { return VMOp_JVMCIResizeCounters; }
1616   bool allow_nested_vm_operations() const        { return true; }
1617   void doit() {
1618     // Resize the old thread counters array
1619     jlong* new_counters = resize_counters_array(JavaThread::_jvmci_old_thread_counters, JVMCICounterSize, _new_size);
<a name="5" id="anc5"></a><span class="line-modified">1620     if (new_counters == NULL) {</span>
<span class="line-added">1621       _failed = true;</span>
<span class="line-added">1622       return;</span>
<span class="line-added">1623     } else {</span>
<span class="line-added">1624       JavaThread::_jvmci_old_thread_counters = new_counters;</span>
<span class="line-added">1625     }</span>
1626 
1627     // Now resize each threads array
1628     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *tp = jtiwh.next(); ) {
<a name="6" id="anc6"></a><span class="line-modified">1629       if (!tp-&gt;resize_counters(JVMCICounterSize, _new_size)) {</span>
<span class="line-added">1630         _failed = true;</span>
<span class="line-added">1631         break;</span>
<span class="line-added">1632       }</span>
<span class="line-added">1633     }</span>
<span class="line-added">1634     if (!_failed) {</span>
<span class="line-added">1635       JVMCICounterSize = _new_size;</span>
1636     }
<a name="7" id="anc7"></a>
1637   }
<a name="8" id="anc8"></a><span class="line-added">1638 </span>
<span class="line-added">1639   bool failed() { return _failed; }</span>
1640 };
1641 
<a name="9" id="anc9"></a><span class="line-modified">1642 bool JavaThread::resize_all_jvmci_counters(int new_size) {</span>
1643   VM_JVMCIResizeCounters op(new_size);
1644   VMThread::execute(&amp;op);
<a name="10" id="anc10"></a><span class="line-added">1645   return !op.failed();</span>
1646 }
1647 
1648 #endif // INCLUDE_JVMCI
1649 
1650 // A JavaThread is a normal Java thread
1651 
1652 void JavaThread::initialize() {
1653   // Initialize fields
1654 
1655   set_saved_exception_pc(NULL);
1656   set_threadObj(NULL);
1657   _anchor.clear();
1658   set_entry_point(NULL);
1659   set_jni_functions(jni_functions());
1660   set_callee_target(NULL);
1661   set_vm_result(NULL);
1662   set_vm_result_2(NULL);
1663   set_vframe_array_head(NULL);
1664   set_vframe_array_last(NULL);
1665   set_deferred_locals(NULL);
1666   set_deopt_mark(NULL);
1667   set_deopt_compiled_method(NULL);
1668   set_monitor_chunks(NULL);
1669   _on_thread_list = false;
1670   _thread_state = _thread_new;
1671   _terminated = _not_terminated;
1672   _array_for_gc = NULL;
1673   _suspend_equivalent = false;
1674   _in_deopt_handler = 0;
1675   _doing_unsafe_access = false;
1676   _stack_guard_state = stack_guard_unused;
1677 #if INCLUDE_JVMCI
1678   _pending_monitorenter = false;
1679   _pending_deoptimization = -1;
1680   _pending_failed_speculation = 0;
1681   _pending_transfer_to_interpreter = false;
1682   _in_retryable_allocation = false;
1683   _jvmci._alternate_call_target = NULL;
1684   assert(_jvmci._implicit_exception_pc == NULL, &quot;must be&quot;);
1685   _jvmci_counters = NULL;
1686   if (JVMCICounterSize &gt; 0) {
1687     resize_counters(0, (int) JVMCICounterSize);
1688   }
1689 #endif // INCLUDE_JVMCI
1690   _reserved_stack_activation = NULL;  // stack base not known yet
1691   set_exception_oop(oop());
1692   _exception_pc  = 0;
1693   _exception_handler_pc = 0;
1694   _is_method_handle_return = 0;
1695   _jvmti_thread_state= NULL;
1696   _should_post_on_exceptions_flag = JNI_FALSE;
1697   _interp_only_mode    = 0;
1698   _special_runtime_exit_condition = _no_async_condition;
1699   _pending_async_exception = NULL;
1700   _thread_stat = NULL;
1701   _thread_stat = new ThreadStatistics();
1702   _jni_active_critical = 0;
1703   _pending_jni_exception_check_fn = NULL;
1704   _do_not_unlock_if_synchronized = false;
1705   _cached_monitor_info = NULL;
1706   _parker = Parker::Allocate(this);
1707   _SleepEvent = ParkEvent::Allocate(this);
1708   // Setup safepoint state info for this thread
1709   ThreadSafepointState::create(this);
1710   _handshake.set_handshakee(this);
1711 
1712   debug_only(_java_call_counter = 0);
1713 
1714   // JVMTI PopFrame support
1715   _popframe_condition = popframe_inactive;
1716   _popframe_preserved_args = NULL;
1717   _popframe_preserved_args_size = 0;
1718   _frames_to_pop_failed_realloc = 0;
1719 
1720   SafepointMechanism::initialize_header(this);
1721 
1722   _class_to_be_initialized = NULL;
1723 
1724   pd_initialize();
1725 }
1726 
1727 JavaThread::JavaThread(bool is_attaching_via_jni) :
1728                        Thread() {
1729   initialize();
1730   if (is_attaching_via_jni) {
1731     _jni_attach_state = _attaching_via_jni;
1732   } else {
1733     _jni_attach_state = _not_attaching_via_jni;
1734   }
1735   assert(deferred_card_mark().is_empty(), &quot;Default MemRegion ctor&quot;);
1736 }
1737 
1738 
1739 // interrupt support
1740 
1741 void JavaThread::interrupt() {
1742   debug_only(check_for_dangling_thread_pointer(this);)
1743 
1744   // For Windows _interrupt_event
1745   osthread()-&gt;set_interrupted(true);
1746 
1747   // For Thread.sleep
1748   _SleepEvent-&gt;unpark();
1749 
1750   // For JSR166 LockSupport.park
1751   parker()-&gt;unpark();
1752 
1753   // For ObjectMonitor and JvmtiRawMonitor
1754   _ParkEvent-&gt;unpark();
1755 }
1756 
1757 
1758 bool JavaThread::is_interrupted(bool clear_interrupted) {
1759   debug_only(check_for_dangling_thread_pointer(this);)
1760 
1761   if (threadObj() == NULL) {
1762     // If there is no j.l.Thread then it is impossible to have
1763     // been interrupted. We can find NULL during VM initialization
1764     // or when a JNI thread is still in the process of attaching.
1765     // In such cases this must be the current thread.
1766     assert(this == Thread::current(), &quot;invariant&quot;);
1767     return false;
1768   }
1769 
1770   bool interrupted = java_lang_Thread::interrupted(threadObj());
1771 
1772   // NOTE that since there is no &quot;lock&quot; around the interrupt and
1773   // is_interrupted operations, there is the possibility that the
1774   // interrupted flag will be &quot;false&quot; but that the
1775   // low-level events will be in the signaled state. This is
1776   // intentional. The effect of this is that Object.wait() and
1777   // LockSupport.park() will appear to have a spurious wakeup, which
1778   // is allowed and not harmful, and the possibility is so rare that
1779   // it is not worth the added complexity to add yet another lock.
1780   // For the sleep event an explicit reset is performed on entry
1781   // to JavaThread::sleep, so there is no early return. It has also been
1782   // recommended not to put the interrupted flag into the &quot;event&quot;
1783   // structure because it hides the issue.
1784   // Also, because there is no lock, we must only clear the interrupt
1785   // state if we are going to report that we were interrupted; otherwise
1786   // an interrupt that happens just after we read the field would be lost.
1787   if (interrupted &amp;&amp; clear_interrupted) {
1788     assert(this == Thread::current(), &quot;only the current thread can clear&quot;);
1789     java_lang_Thread::set_interrupted(threadObj(), false);
1790     osthread()-&gt;set_interrupted(false);
1791   }
1792 
1793   return interrupted;
1794 }
1795 
1796 bool JavaThread::reguard_stack(address cur_sp) {
1797   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1798       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1799     return true; // Stack already guarded or guard pages not needed.
1800   }
1801 
1802   if (register_stack_overflow()) {
1803     // For those architectures which have separate register and
1804     // memory stacks, we must check the register stack to see if
1805     // it has overflowed.
1806     return false;
1807   }
1808 
1809   // Java code never executes within the yellow zone: the latter is only
1810   // there to provoke an exception during stack banging.  If java code
1811   // is executing there, either StackShadowPages should be larger, or
1812   // some exception code in c1, c2 or the interpreter isn&#39;t unwinding
1813   // when it should.
1814   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1815             &quot;not enough space to reguard - increase StackShadowPages&quot;);
1816   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1817     enable_stack_yellow_reserved_zone();
1818     if (reserved_stack_activation() != stack_base()) {
1819       set_reserved_stack_activation(stack_base());
1820     }
1821   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1822     set_reserved_stack_activation(stack_base());
1823     enable_stack_reserved_zone();
1824   }
1825   return true;
1826 }
1827 
1828 bool JavaThread::reguard_stack(void) {
1829   return reguard_stack(os::current_stack_pointer());
1830 }
1831 
1832 void JavaThread::block_if_vm_exited() {
1833   if (_terminated == _vm_exited) {
1834     // _vm_exited is set at safepoint, and Threads_lock is never released
1835     // we will block here forever.
1836     // Here we can be doing a jump from a safe state to an unsafe state without
1837     // proper transition, but it happens after the final safepoint has begun.
1838     set_thread_state(_thread_in_vm);
1839     Threads_lock-&gt;lock();
1840     ShouldNotReachHere();
1841   }
1842 }
1843 
1844 
1845 // Remove this ifdef when C1 is ported to the compiler interface.
1846 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1847 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1848 
1849 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1850                        Thread() {
1851   initialize();
1852   _jni_attach_state = _not_attaching_via_jni;
1853   set_entry_point(entry_point);
1854   // Create the native thread itself.
1855   // %note runtime_23
1856   os::ThreadType thr_type = os::java_thread;
1857   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1858                                                      os::java_thread;
1859   os::create_thread(this, thr_type, stack_sz);
1860   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1861   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1862   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1863   // the exception consists of creating the exception object &amp; initializing it, initialization
1864   // will leave the VM via a JavaCall and then all locks must be unlocked).
1865   //
1866   // The thread is still suspended when we reach here. Thread must be explicit started
1867   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1868   // by calling Threads:add. The reason why this is not done here, is because the thread
1869   // object must be fully initialized (take a look at JVM_Start)
1870 }
1871 
1872 JavaThread::~JavaThread() {
1873 
1874   // JSR166 -- return the parker to the free list
1875   Parker::Release(_parker);
1876   _parker = NULL;
1877 
1878   // Return the sleep event to the free list
1879   ParkEvent::Release(_SleepEvent);
1880   _SleepEvent = NULL;
1881 
1882   // Free any remaining  previous UnrollBlock
1883   vframeArray* old_array = vframe_array_last();
1884 
1885   if (old_array != NULL) {
1886     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1887     old_array-&gt;set_unroll_block(NULL);
1888     delete old_info;
1889     delete old_array;
1890   }
1891 
1892   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1893   if (deferred != NULL) {
1894     // This can only happen if thread is destroyed before deoptimization occurs.
1895     assert(deferred-&gt;length() != 0, &quot;empty array!&quot;);
1896     do {
1897       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1898       deferred-&gt;remove_at(0);
1899       // individual jvmtiDeferredLocalVariableSet are CHeapObj&#39;s
1900       delete dlv;
1901     } while (deferred-&gt;length() != 0);
1902     delete deferred;
1903   }
1904 
1905   // All Java related clean up happens in exit
1906   ThreadSafepointState::destroy(this);
1907   if (_thread_stat != NULL) delete _thread_stat;
1908 
1909 #if INCLUDE_JVMCI
1910   if (JVMCICounterSize &gt; 0) {
1911     if (jvmci_counters_include(this)) {
1912       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1913         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1914       }
1915     }
1916     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1917   }
1918 #endif // INCLUDE_JVMCI
1919 }
1920 
1921 
1922 // First JavaThread specific code executed by a new Java thread.
1923 void JavaThread::pre_run() {
1924   // empty - see comments in run()
1925 }
1926 
1927 // The main routine called by a new Java thread. This isn&#39;t overridden
1928 // by subclasses, instead different subclasses define a different &quot;entry_point&quot;
1929 // which defines the actual logic for that kind of thread.
1930 void JavaThread::run() {
1931   // initialize thread-local alloc buffer related fields
1932   this-&gt;initialize_tlab();
1933 
1934   // Used to test validity of stack trace backs.
1935   // This can&#39;t be moved into pre_run() else we invalidate
1936   // the requirement that thread_main_inner is lower on
1937   // the stack. Consequently all the initialization logic
1938   // stays here in run() rather than pre_run().
1939   this-&gt;record_base_of_stack_pointer();
1940 
1941   this-&gt;create_stack_guard_pages();
1942 
1943   this-&gt;cache_global_variables();
1944 
1945   // Thread is now sufficiently initialized to be handled by the safepoint code as being
1946   // in the VM. Change thread state from _thread_new to _thread_in_vm
1947   ThreadStateTransition::transition(this, _thread_new, _thread_in_vm);
1948   // Before a thread is on the threads list it is always safe, so after leaving the
1949   // _thread_new we should emit a instruction barrier. The distance to modified code
1950   // from here is probably far enough, but this is consistent and safe.
1951   OrderAccess::cross_modify_fence();
1952 
1953   assert(JavaThread::current() == this, &quot;sanity check&quot;);
1954   assert(!Thread::current()-&gt;owns_locks(), &quot;sanity check&quot;);
1955 
1956   DTRACE_THREAD_PROBE(start, this);
1957 
1958   // This operation might block. We call that after all safepoint checks for a new thread has
1959   // been completed.
1960   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1961 
1962   if (JvmtiExport::should_post_thread_life()) {
1963     JvmtiExport::post_thread_start(this);
1964 
1965   }
1966 
1967   // We call another function to do the rest so we are sure that the stack addresses used
1968   // from there will be lower than the stack base just computed.
1969   thread_main_inner();
1970 }
1971 
1972 void JavaThread::thread_main_inner() {
1973   assert(JavaThread::current() == this, &quot;sanity check&quot;);
1974   assert(this-&gt;threadObj() != NULL, &quot;just checking&quot;);
1975 
1976   // Execute thread entry point unless this thread has a pending exception
1977   // or has been stopped before starting.
1978   // Note: Due to JVM_StopThread we can have pending exceptions already!
1979   if (!this-&gt;has_pending_exception() &amp;&amp;
1980       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1981     {
1982       ResourceMark rm(this);
1983       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1984     }
1985     HandleMark hm(this);
1986     this-&gt;entry_point()(this, this);
1987   }
1988 
1989   DTRACE_THREAD_PROBE(stop, this);
1990 
1991   // Cleanup is handled in post_run()
1992 }
1993 
1994 // Shared teardown for all JavaThreads
1995 void JavaThread::post_run() {
1996   this-&gt;exit(false);
1997   // Defer deletion to here to ensure &#39;this&#39; is still referenceable in call_run
1998   // for any shared tear-down.
1999   this-&gt;smr_delete();
2000 }
2001 
2002 static void ensure_join(JavaThread* thread) {
2003   // We do not need to grab the Threads_lock, since we are operating on ourself.
2004   Handle threadObj(thread, thread-&gt;threadObj());
2005   assert(threadObj.not_null(), &quot;java thread object must exist&quot;);
2006   ObjectLocker lock(threadObj, thread);
2007   // Ignore pending exception (ThreadDeath), since we are exiting anyway
2008   thread-&gt;clear_pending_exception();
2009   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
2010   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
2011   // Clear the native thread instance - this makes isAlive return false and allows the join()
2012   // to complete once we&#39;ve done the notify_all below
2013   java_lang_Thread::set_thread(threadObj(), NULL);
2014   lock.notify_all(thread);
2015   // Ignore pending exception (ThreadDeath), since we are exiting anyway
2016   thread-&gt;clear_pending_exception();
2017 }
2018 
2019 static bool is_daemon(oop threadObj) {
2020   return (threadObj != NULL &amp;&amp; java_lang_Thread::is_daemon(threadObj));
2021 }
2022 
2023 // For any new cleanup additions, please check to see if they need to be applied to
2024 // cleanup_failed_attach_current_thread as well.
2025 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
2026   assert(this == JavaThread::current(), &quot;thread consistency check&quot;);
2027 
2028   elapsedTimer _timer_exit_phase1;
2029   elapsedTimer _timer_exit_phase2;
2030   elapsedTimer _timer_exit_phase3;
2031   elapsedTimer _timer_exit_phase4;
2032 
2033   if (log_is_enabled(Debug, os, thread, timer)) {
2034     _timer_exit_phase1.start();
2035   }
2036 
2037   HandleMark hm(this);
2038   Handle uncaught_exception(this, this-&gt;pending_exception());
2039   this-&gt;clear_pending_exception();
2040   Handle threadObj(this, this-&gt;threadObj());
2041   assert(threadObj.not_null(), &quot;Java thread object should be created&quot;);
2042 
2043   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
2044   {
2045     EXCEPTION_MARK;
2046 
2047     CLEAR_PENDING_EXCEPTION;
2048   }
2049   if (!destroy_vm) {
2050     if (uncaught_exception.not_null()) {
2051       EXCEPTION_MARK;
2052       // Call method Thread.dispatchUncaughtException().
2053       Klass* thread_klass = SystemDictionary::Thread_klass();
2054       JavaValue result(T_VOID);
2055       JavaCalls::call_virtual(&amp;result,
2056                               threadObj, thread_klass,
2057                               vmSymbols::dispatchUncaughtException_name(),
2058                               vmSymbols::throwable_void_signature(),
2059                               uncaught_exception,
2060                               THREAD);
2061       if (HAS_PENDING_EXCEPTION) {
2062         ResourceMark rm(this);
2063         jio_fprintf(defaultStream::error_stream(),
2064                     &quot;\nException: %s thrown from the UncaughtExceptionHandler&quot;
2065                     &quot; in thread \&quot;%s\&quot;\n&quot;,
2066                     pending_exception()-&gt;klass()-&gt;external_name(),
2067                     get_thread_name());
2068         CLEAR_PENDING_EXCEPTION;
2069       }
2070     }
2071 
2072     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
2073     // the execution of the method. If that is not enough, then we don&#39;t really care. Thread.stop
2074     // is deprecated anyhow.
2075     if (!is_Compiler_thread()) {
2076       int count = 3;
2077       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
2078         EXCEPTION_MARK;
2079         JavaValue result(T_VOID);
2080         Klass* thread_klass = SystemDictionary::Thread_klass();
2081         JavaCalls::call_virtual(&amp;result,
2082                                 threadObj, thread_klass,
2083                                 vmSymbols::exit_method_name(),
2084                                 vmSymbols::void_method_signature(),
2085                                 THREAD);
2086         CLEAR_PENDING_EXCEPTION;
2087       }
2088     }
2089     // notify JVMTI
2090     if (JvmtiExport::should_post_thread_life()) {
2091       JvmtiExport::post_thread_end(this);
2092     }
2093 
2094     // We have notified the agents that we are exiting, before we go on,
2095     // we must check for a pending external suspend request and honor it
2096     // in order to not surprise the thread that made the suspend request.
2097     while (true) {
2098       {
2099         MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2100         if (!is_external_suspend()) {
2101           set_terminated(_thread_exiting);
2102           ThreadService::current_thread_exiting(this, is_daemon(threadObj()));
2103           break;
2104         }
2105         // Implied else:
2106         // Things get a little tricky here. We have a pending external
2107         // suspend request, but we are holding the SR_lock so we
2108         // can&#39;t just self-suspend. So we temporarily drop the lock
2109         // and then self-suspend.
2110       }
2111 
2112       ThreadBlockInVM tbivm(this);
2113       java_suspend_self();
2114 
2115       // We&#39;re done with this suspend request, but we have to loop around
2116       // and check again. Eventually we will get SR_lock without a pending
2117       // external suspend request and will be able to mark ourselves as
2118       // exiting.
2119     }
2120     // no more external suspends are allowed at this point
2121   } else {
2122     assert(!is_terminated() &amp;&amp; !is_exiting(), &quot;must not be exiting&quot;);
2123     // before_exit() has already posted JVMTI THREAD_END events
2124   }
2125 
2126   if (log_is_enabled(Debug, os, thread, timer)) {
2127     _timer_exit_phase1.stop();
2128     _timer_exit_phase2.start();
2129   }
2130 
2131   // Capture daemon status before the thread is marked as terminated.
2132   bool daemon = is_daemon(threadObj());
2133 
2134   // Notify waiters on thread object. This has to be done after exit() is called
2135   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
2136   // group should have the destroyed bit set before waiters are notified).
2137   ensure_join(this);
2138   assert(!this-&gt;has_pending_exception(), &quot;ensure_join should have cleared&quot;);
2139 
2140   if (log_is_enabled(Debug, os, thread, timer)) {
2141     _timer_exit_phase2.stop();
2142     _timer_exit_phase3.start();
2143   }
2144   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
2145   // held by this thread must be released. The spec does not distinguish
2146   // between JNI-acquired and regular Java monitors. We can only see
2147   // regular Java monitors here if monitor enter-exit matching is broken.
2148   //
2149   // ensure_join() ignores IllegalThreadStateExceptions, and so does
2150   // ObjectSynchronizer::release_monitors_owned_by_thread().
2151   if (exit_type == jni_detach) {
2152     // Sanity check even though JNI DetachCurrentThread() would have
2153     // returned JNI_ERR if there was a Java frame. JavaThread exit
2154     // should be done executing Java code by the time we get here.
2155     assert(!this-&gt;has_last_Java_frame(),
2156            &quot;should not have a Java frame when detaching or exiting&quot;);
2157     ObjectSynchronizer::release_monitors_owned_by_thread(this);
2158     assert(!this-&gt;has_pending_exception(), &quot;release_monitors should have cleared&quot;);
2159   }
2160 
2161   // These things needs to be done while we are still a Java Thread. Make sure that thread
2162   // is in a consistent state, in case GC happens
2163   JFR_ONLY(Jfr::on_thread_exit(this);)
2164 
2165   if (active_handles() != NULL) {
2166     JNIHandleBlock* block = active_handles();
2167     set_active_handles(NULL);
2168     JNIHandleBlock::release_block(block);
2169   }
2170 
2171   if (free_handle_block() != NULL) {
2172     JNIHandleBlock* block = free_handle_block();
2173     set_free_handle_block(NULL);
2174     JNIHandleBlock::release_block(block);
2175   }
2176 
2177   // These have to be removed while this is still a valid thread.
2178   remove_stack_guard_pages();
2179 
2180   if (UseTLAB) {
2181     tlab().retire();
2182   }
2183 
2184   if (JvmtiEnv::environments_might_exist()) {
2185     JvmtiExport::cleanup_thread(this);
2186   }
2187 
2188   // We need to cache the thread name for logging purposes below as once
2189   // we have called on_thread_detach this thread must not access any oops.
2190   char* thread_name = NULL;
2191   if (log_is_enabled(Debug, os, thread, timer)) {
2192     ResourceMark rm(this);
2193     thread_name = os::strdup(get_thread_name());
2194   }
2195 
2196   // We must flush any deferred card marks and other various GC barrier
2197   // related buffers (e.g. G1 SATB buffer and G1 dirty card queue buffer)
2198   // before removing a thread from the list of active threads.
2199   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2200 
2201   log_info(os, thread)(&quot;JavaThread %s (tid: &quot; UINTX_FORMAT &quot;).&quot;,
2202     exit_type == JavaThread::normal_exit ? &quot;exiting&quot; : &quot;detaching&quot;,
2203     os::current_thread_id());
2204 
2205   if (log_is_enabled(Debug, os, thread, timer)) {
2206     _timer_exit_phase3.stop();
2207     _timer_exit_phase4.start();
2208   }
2209   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
2210   Threads::remove(this, daemon);
2211 
2212   if (log_is_enabled(Debug, os, thread, timer)) {
2213     _timer_exit_phase4.stop();
2214     log_debug(os, thread, timer)(&quot;name=&#39;%s&#39;&quot;
2215                                  &quot;, exit-phase1=&quot; JLONG_FORMAT
2216                                  &quot;, exit-phase2=&quot; JLONG_FORMAT
2217                                  &quot;, exit-phase3=&quot; JLONG_FORMAT
2218                                  &quot;, exit-phase4=&quot; JLONG_FORMAT,
2219                                  thread_name,
2220                                  _timer_exit_phase1.milliseconds(),
2221                                  _timer_exit_phase2.milliseconds(),
2222                                  _timer_exit_phase3.milliseconds(),
2223                                  _timer_exit_phase4.milliseconds());
2224     os::free(thread_name);
2225   }
2226 }
2227 
2228 void JavaThread::cleanup_failed_attach_current_thread(bool is_daemon) {
2229   if (active_handles() != NULL) {
2230     JNIHandleBlock* block = active_handles();
2231     set_active_handles(NULL);
2232     JNIHandleBlock::release_block(block);
2233   }
2234 
2235   if (free_handle_block() != NULL) {
2236     JNIHandleBlock* block = free_handle_block();
2237     set_free_handle_block(NULL);
2238     JNIHandleBlock::release_block(block);
2239   }
2240 
2241   // These have to be removed while this is still a valid thread.
2242   remove_stack_guard_pages();
2243 
2244   if (UseTLAB) {
2245     tlab().retire();
2246   }
2247 
2248   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2249 
2250   Threads::remove(this, is_daemon);
2251   this-&gt;smr_delete();
2252 }
2253 
2254 JavaThread* JavaThread::active() {
2255   Thread* thread = Thread::current();
2256   if (thread-&gt;is_Java_thread()) {
2257     return (JavaThread*) thread;
2258   } else {
2259     assert(thread-&gt;is_VM_thread(), &quot;this must be a vm thread&quot;);
2260     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2261     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2262     assert(ret-&gt;is_Java_thread(), &quot;must be a Java thread&quot;);
2263     return ret;
2264   }
2265 }
2266 
2267 bool JavaThread::is_lock_owned(address adr) const {
2268   if (Thread::is_lock_owned(adr)) return true;
2269 
2270   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2271     if (chunk-&gt;contains(adr)) return true;
2272   }
2273 
2274   return false;
2275 }
2276 
2277 oop JavaThread::exception_oop() const {
2278   return Atomic::load(&amp;_exception_oop);
2279 }
2280 
2281 void JavaThread::set_exception_oop(oop o) {
2282   Atomic::store(&amp;_exception_oop, o);
2283 }
2284 
2285 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2286   chunk-&gt;set_next(monitor_chunks());
2287   set_monitor_chunks(chunk);
2288 }
2289 
2290 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2291   guarantee(monitor_chunks() != NULL, &quot;must be non empty&quot;);
2292   if (monitor_chunks() == chunk) {
2293     set_monitor_chunks(chunk-&gt;next());
2294   } else {
2295     MonitorChunk* prev = monitor_chunks();
2296     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2297     prev-&gt;set_next(chunk-&gt;next());
2298   }
2299 }
2300 
2301 // JVM support.
2302 
2303 // Note: this function shouldn&#39;t block if it&#39;s called in
2304 // _thread_in_native_trans state (such as from
2305 // check_special_condition_for_native_trans()).
2306 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2307   // May be we are at method entry and requires to save do not unlock flag.
2308   UnlockFlagSaver fs(this);
2309   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2310     // If we are at a polling page safepoint (not a poll return)
2311     // then we must defer async exception because live registers
2312     // will be clobbered by the exception path. Poll return is
2313     // ok because the call we a returning from already collides
2314     // with exception handling registers and so there is no issue.
2315     // (The exception handling path kills call result registers but
2316     //  this is ok since the exception kills the result anyway).
2317 
2318     if (is_at_poll_safepoint()) {
2319       // if the code we are returning to has deoptimized we must defer
2320       // the exception otherwise live registers get clobbered on the
2321       // exception path before deoptimization is able to retrieve them.
2322       //
2323       RegisterMap map(this, false);
2324       frame caller_fr = last_frame().sender(&amp;map);
2325       assert(caller_fr.is_compiled_frame(), &quot;what?&quot;);
2326       if (caller_fr.is_deoptimized_frame()) {
2327         log_info(exceptions)(&quot;deferred async exception at compiled safepoint&quot;);
2328         return;
2329       }
2330     }
2331   }
2332 
2333   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2334   if (condition == _no_async_condition) {
2335     // Conditions have changed since has_special_runtime_exit_condition()
2336     // was called:
2337     // - if we were here only because of an external suspend request,
2338     //   then that was taken care of above (or cancelled) so we are done
2339     // - if we were here because of another async request, then it has
2340     //   been cleared between the has_special_runtime_exit_condition()
2341     //   and now so again we are done
2342     return;
2343   }
2344 
2345   // Check for pending async. exception
2346   if (_pending_async_exception != NULL) {
2347     // Only overwrite an already pending exception, if it is not a threadDeath.
2348     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2349 
2350       // We cannot call Exceptions::_throw(...) here because we cannot block
2351       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2352 
2353       LogTarget(Info, exceptions) lt;
2354       if (lt.is_enabled()) {
2355         ResourceMark rm;
2356         LogStream ls(lt);
2357         ls.print(&quot;Async. exception installed at runtime exit (&quot; INTPTR_FORMAT &quot;)&quot;, p2i(this));
2358           if (has_last_Java_frame()) {
2359             frame f = last_frame();
2360            ls.print(&quot; (pc: &quot; INTPTR_FORMAT &quot; sp: &quot; INTPTR_FORMAT &quot; )&quot;, p2i(f.pc()), p2i(f.sp()));
2361           }
2362         ls.print_cr(&quot; of type: %s&quot;, _pending_async_exception-&gt;klass()-&gt;external_name());
2363       }
2364       _pending_async_exception = NULL;
2365       clear_has_async_exception();
2366     }
2367   }
2368 
2369   if (check_unsafe_error &amp;&amp;
2370       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2371     condition = _no_async_condition;  // done
2372     switch (thread_state()) {
2373     case _thread_in_vm: {
2374       JavaThread* THREAD = this;
2375       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in an unsafe memory access operation&quot;);
2376     }
2377     case _thread_in_native: {
2378       ThreadInVMfromNative tiv(this);
2379       JavaThread* THREAD = this;
2380       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in an unsafe memory access operation&quot;);
2381     }
2382     case _thread_in_Java: {
2383       ThreadInVMfromJava tiv(this);
2384       JavaThread* THREAD = this;
2385       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in a recent unsafe memory access operation in compiled Java code&quot;);
2386     }
2387     default:
2388       ShouldNotReachHere();
2389     }
2390   }
2391 
2392   assert(condition == _no_async_condition || has_pending_exception() ||
2393          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2394          &quot;must have handled the async condition, if no exception&quot;);
2395 }
2396 
2397 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2398 
2399   // Check for pending external suspend.
2400   if (is_external_suspend_with_lock()) {
2401     frame_anchor()-&gt;make_walkable(this);
2402     java_suspend_self_with_safepoint_check();
2403   }
2404 
2405   // We might be here for reasons in addition to the self-suspend request
2406   // so check for other async requests.
2407   if (check_asyncs) {
2408     check_and_handle_async_exceptions();
2409   }
2410 
2411   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(this);)
2412 }
2413 
2414 void JavaThread::send_thread_stop(oop java_throwable)  {
2415   ResourceMark rm;
2416   assert(Thread::current()-&gt;is_VM_thread() || Thread::current() == this, &quot;should be in the vm thread&quot;);
2417 
2418   // Do not throw asynchronous exceptions against the compiler thread
2419   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2420   if (!can_call_java()) return;
2421 
2422   {
2423     // Actually throw the Throwable against the target Thread - however
2424     // only if there is no thread death exception installed already.
2425     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2426       // If the topmost frame is a runtime stub, then we are calling into
2427       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2428       // must deoptimize the caller before continuing, as the compiled  exception handler table
2429       // may not be valid
2430       if (has_last_Java_frame()) {
2431         frame f = last_frame();
2432         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2433           RegisterMap reg_map(this, false);
2434           frame compiled_frame = f.sender(&amp;reg_map);
2435           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2436             Deoptimization::deoptimize(this, compiled_frame);
2437           }
2438         }
2439       }
2440 
2441       // Set async. pending exception in thread.
2442       set_pending_async_exception(java_throwable);
2443 
2444       if (log_is_enabled(Info, exceptions)) {
2445          ResourceMark rm;
2446         log_info(exceptions)(&quot;Pending Async. exception installed of type: %s&quot;,
2447                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2448       }
2449       // for AbortVMOnException flag
2450       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2451     }
2452   }
2453 
2454 
2455   // Interrupt thread so it will wake up from a potential wait()/sleep()/park()
2456   java_lang_Thread::set_interrupted(threadObj(), true);
2457   this-&gt;interrupt();
2458 }
2459 
2460 // External suspension mechanism.
2461 //
2462 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2463 // to any VM_locks and it is at a transition
2464 // Self-suspension will happen on the transition out of the vm.
2465 // Catch &quot;this&quot; coming in from JNIEnv pointers when the thread has been freed
2466 //
2467 // Guarantees on return:
2468 //   + Target thread will not execute any new bytecode (that&#39;s why we need to
2469 //     force a safepoint)
2470 //   + Target thread will not enter any new monitors
2471 //
2472 void JavaThread::java_suspend() {
2473   ThreadsListHandle tlh;
2474   if (!tlh.includes(this) || threadObj() == NULL || is_exiting()) {
2475     return;
2476   }
2477 
2478   { MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2479     if (!is_external_suspend()) {
2480       // a racing resume has cancelled us; bail out now
2481       return;
2482     }
2483 
2484     // suspend is done
2485     uint32_t debug_bits = 0;
2486     // Warning: is_ext_suspend_completed() may temporarily drop the
2487     // SR_lock to allow the thread to reach a stable thread state if
2488     // it is currently in a transient thread state.
2489     if (is_ext_suspend_completed(false /* !called_by_wait */,
2490                                  SuspendRetryDelay, &amp;debug_bits)) {
2491       return;
2492     }
2493   }
2494 
2495   if (Thread::current() == this) {
2496     // Safely self-suspend.
2497     // If we don&#39;t do this explicitly it will implicitly happen
2498     // before we transition back to Java, and on some other thread-state
2499     // transition paths, but not as we exit a JVM TI SuspendThread call.
2500     // As SuspendThread(current) must not return (until resumed) we must
2501     // self-suspend here.
2502     ThreadBlockInVM tbivm(this);
2503     java_suspend_self();
2504   } else {
2505     VM_ThreadSuspend vm_suspend;
2506     VMThread::execute(&amp;vm_suspend);
2507   }
2508 }
2509 
2510 // Part II of external suspension.
2511 // A JavaThread self suspends when it detects a pending external suspend
2512 // request. This is usually on transitions. It is also done in places
2513 // where continuing to the next transition would surprise the caller,
2514 // e.g., monitor entry.
2515 //
2516 // Returns the number of times that the thread self-suspended.
2517 //
2518 // Note: DO NOT call java_suspend_self() when you just want to block current
2519 //       thread. java_suspend_self() is the second stage of cooperative
2520 //       suspension for external suspend requests and should only be used
2521 //       to complete an external suspend request.
2522 //
2523 int JavaThread::java_suspend_self() {
2524   assert(thread_state() == _thread_blocked, &quot;wrong state for java_suspend_self()&quot;);
2525   int ret = 0;
2526 
2527   // we are in the process of exiting so don&#39;t suspend
2528   if (is_exiting()) {
2529     clear_external_suspend();
2530     return ret;
2531   }
2532 
2533   assert(_anchor.walkable() ||
2534          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2535          &quot;must have walkable stack&quot;);
2536 
2537   MonitorLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2538 
2539   assert(!this-&gt;is_ext_suspended(),
2540          &quot;a thread trying to self-suspend should not already be suspended&quot;);
2541 
2542   if (this-&gt;is_suspend_equivalent()) {
2543     // If we are self-suspending as a result of the lifting of a
2544     // suspend equivalent condition, then the suspend_equivalent
2545     // flag is not cleared until we set the ext_suspended flag so
2546     // that wait_for_ext_suspend_completion() returns consistent
2547     // results.
2548     this-&gt;clear_suspend_equivalent();
2549   }
2550 
2551   // A racing resume may have cancelled us before we grabbed SR_lock
2552   // above. Or another external suspend request could be waiting for us
2553   // by the time we return from SR_lock()-&gt;wait(). The thread
2554   // that requested the suspension may already be trying to walk our
2555   // stack and if we return now, we can change the stack out from under
2556   // it. This would be a &quot;bad thing (TM)&quot; and cause the stack walker
2557   // to crash. We stay self-suspended until there are no more pending
2558   // external suspend requests.
2559   while (is_external_suspend()) {
2560     ret++;
2561     this-&gt;set_ext_suspended();
2562 
2563     // _ext_suspended flag is cleared by java_resume()
2564     while (is_ext_suspended()) {
2565       ml.wait();
2566     }
2567   }
2568   return ret;
2569 }
2570 
2571 // Helper routine to set up the correct thread state before calling java_suspend_self.
2572 // This is called when regular thread-state transition helpers can&#39;t be used because
2573 // we can be in various states, in particular _thread_in_native_trans.
2574 // Because this thread is external suspended the safepoint code will count it as at
2575 // a safepoint, regardless of what its actual current thread-state is. But
2576 // is_ext_suspend_completed() may be waiting to see a thread transition from
2577 // _thread_in_native_trans to _thread_blocked. So we set the thread state directly
2578 // to _thread_blocked. The problem with setting thread state directly is that a
2579 // safepoint could happen just after java_suspend_self() returns after being resumed,
2580 // and the VM thread will see the _thread_blocked state. So we must check for a safepoint
2581 // after restoring the state to make sure we won&#39;t leave while a safepoint is in progress.
2582 // However, not all initial-states are allowed when performing a safepoint check, as we
2583 // should never be blocking at a safepoint whilst in those states. Of these &#39;bad&#39; states
2584 // only _thread_in_native is possible when executing this code (based on our two callers).
2585 // A thread that is _thread_in_native is already safepoint-safe and so it doesn&#39;t matter
2586 // whether the VMThread sees the _thread_blocked state, or the _thread_in_native state,
2587 // and so we don&#39;t need the explicit safepoint check.
2588 
2589 void JavaThread::java_suspend_self_with_safepoint_check() {
2590   assert(this == Thread::current(), &quot;invariant&quot;);
2591   JavaThreadState state = thread_state();
2592   set_thread_state(_thread_blocked);
2593   java_suspend_self();
2594   set_thread_state_fence(state);
2595   // Since we are not using a regular thread-state transition helper here,
2596   // we must manually emit the instruction barrier after leaving a safe state.
2597   OrderAccess::cross_modify_fence();
2598   if (state != _thread_in_native) {
2599     SafepointMechanism::block_if_requested(this);
2600   }
2601 }
2602 
2603 #ifdef ASSERT
2604 // Verify the JavaThread has not yet been published in the Threads::list, and
2605 // hence doesn&#39;t need protection from concurrent access at this stage.
2606 void JavaThread::verify_not_published() {
2607   // Cannot create a ThreadsListHandle here and check !tlh.includes(this)
2608   // since an unpublished JavaThread doesn&#39;t participate in the
2609   // Thread-SMR protocol for keeping a ThreadsList alive.
2610   assert(!on_thread_list(), &quot;JavaThread shouldn&#39;t have been published yet!&quot;);
2611 }
2612 #endif
2613 
2614 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2615 // progress or when _suspend_flags is non-zero.
2616 // Current thread needs to self-suspend if there is a suspend request and/or
2617 // block if a safepoint is in progress.
2618 // Async exception ISN&#39;T checked.
2619 // Note only the ThreadInVMfromNative transition can call this function
2620 // directly and when thread state is _thread_in_native_trans
2621 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2622   assert(thread-&gt;thread_state() == _thread_in_native_trans, &quot;wrong state&quot;);
2623 
2624   assert(!thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable(), &quot;Unwalkable stack in native-&gt;vm transition&quot;);
2625 
2626   if (thread-&gt;is_external_suspend()) {
2627     thread-&gt;java_suspend_self_with_safepoint_check();
2628   } else {
2629     SafepointMechanism::block_if_requested(thread);
2630   }
2631 
2632   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(thread);)
2633 }
2634 
2635 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2636 // progress or when _suspend_flags is non-zero.
2637 // Current thread needs to self-suspend if there is a suspend request and/or
2638 // block if a safepoint is in progress.
2639 // Also check for pending async exception (not including unsafe access error).
2640 // Note only the native==&gt;VM/Java barriers can call this function and when
2641 // thread state is _thread_in_native_trans.
2642 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2643   check_safepoint_and_suspend_for_native_trans(thread);
2644 
2645   if (thread-&gt;has_async_exception()) {
2646     // We are in _thread_in_native_trans state, don&#39;t handle unsafe
2647     // access error since that may block.
2648     thread-&gt;check_and_handle_async_exceptions(false);
2649   }
2650 }
2651 
2652 // This is a variant of the normal
2653 // check_special_condition_for_native_trans with slightly different
2654 // semantics for use by critical native wrappers.  It does all the
2655 // normal checks but also performs the transition back into
2656 // thread_in_Java state.  This is required so that critical natives
2657 // can potentially block and perform a GC if they are the last thread
2658 // exiting the GCLocker.
2659 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2660   check_special_condition_for_native_trans(thread);
2661 
2662   // Finish the transition
2663   thread-&gt;set_thread_state(_thread_in_Java);
2664 
2665   if (thread-&gt;do_critical_native_unlock()) {
2666     ThreadInVMfromJavaNoAsyncException tiv(thread);
2667     GCLocker::unlock_critical(thread);
2668     thread-&gt;clear_critical_native_unlock();
2669   }
2670 }
2671 
2672 // We need to guarantee the Threads_lock here, since resumes are not
2673 // allowed during safepoint synchronization
2674 // Can only resume from an external suspension
2675 void JavaThread::java_resume() {
2676   assert_locked_or_safepoint(Threads_lock);
2677 
2678   // Sanity check: thread is gone, has started exiting or the thread
2679   // was not externally suspended.
2680   ThreadsListHandle tlh;
2681   if (!tlh.includes(this) || is_exiting() || !is_external_suspend()) {
2682     return;
2683   }
2684 
2685   MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2686 
2687   clear_external_suspend();
2688 
2689   if (is_ext_suspended()) {
2690     clear_ext_suspended();
2691     SR_lock()-&gt;notify_all();
2692   }
2693 }
2694 
2695 size_t JavaThread::_stack_red_zone_size = 0;
2696 size_t JavaThread::_stack_yellow_zone_size = 0;
2697 size_t JavaThread::_stack_reserved_zone_size = 0;
2698 size_t JavaThread::_stack_shadow_zone_size = 0;
2699 
2700 void JavaThread::create_stack_guard_pages() {
2701   if (!os::uses_stack_guard_pages() ||
2702       _stack_guard_state != stack_guard_unused ||
2703       (DisablePrimordialThreadGuardPages &amp;&amp; os::is_primordial_thread())) {
2704       log_info(os, thread)(&quot;Stack guard page creation for thread &quot;
2705                            UINTX_FORMAT &quot; disabled&quot;, os::current_thread_id());
2706     return;
2707   }
2708   address low_addr = stack_end();
2709   size_t len = stack_guard_zone_size();
2710 
2711   assert(is_aligned(low_addr, os::vm_page_size()), &quot;Stack base should be the start of a page&quot;);
2712   assert(is_aligned(len, os::vm_page_size()), &quot;Stack size should be a multiple of page size&quot;);
2713 
2714   int must_commit = os::must_commit_stack_guard_pages();
2715   // warning(&quot;Guarding at &quot; PTR_FORMAT &quot; for len &quot; SIZE_FORMAT &quot;\n&quot;, low_addr, len);
2716 
2717   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2718     log_warning(os, thread)(&quot;Attempt to allocate stack guard pages failed.&quot;);
2719     return;
2720   }
2721 
2722   if (os::guard_memory((char *) low_addr, len)) {
2723     _stack_guard_state = stack_guard_enabled;
2724   } else {
2725     log_warning(os, thread)(&quot;Attempt to protect stack guard pages failed (&quot;
2726       PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2727     if (os::uncommit_memory((char *) low_addr, len)) {
2728       log_warning(os, thread)(&quot;Attempt to deallocate stack guard pages failed.&quot;);
2729     }
2730     return;
2731   }
2732 
2733   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack guard pages activated: &quot;
2734     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;.&quot;,
2735     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2736 }
2737 
2738 void JavaThread::remove_stack_guard_pages() {
2739   assert(Thread::current() == this, &quot;from different thread&quot;);
2740   if (_stack_guard_state == stack_guard_unused) return;
2741   address low_addr = stack_end();
2742   size_t len = stack_guard_zone_size();
2743 
2744   if (os::must_commit_stack_guard_pages()) {
2745     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2746       _stack_guard_state = stack_guard_unused;
2747     } else {
2748       log_warning(os, thread)(&quot;Attempt to deallocate stack guard pages failed (&quot;
2749         PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2750       return;
2751     }
2752   } else {
2753     if (_stack_guard_state == stack_guard_unused) return;
2754     if (os::unguard_memory((char *) low_addr, len)) {
2755       _stack_guard_state = stack_guard_unused;
2756     } else {
2757       log_warning(os, thread)(&quot;Attempt to unprotect stack guard pages failed (&quot;
2758         PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2759       return;
2760     }
2761   }
2762 
2763   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack guard pages removed: &quot;
2764     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;.&quot;,
2765     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2766 }
2767 
2768 void JavaThread::enable_stack_reserved_zone() {
2769   assert(_stack_guard_state == stack_guard_reserved_disabled, &quot;inconsistent state&quot;);
2770 
2771   // The base notation is from the stack&#39;s point of view, growing downward.
2772   // We need to adjust it to work correctly with guard_memory()
2773   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2774 
2775   guarantee(base &lt; stack_base(),&quot;Error calculating stack reserved zone&quot;);
2776   guarantee(base &lt; os::current_stack_pointer(),&quot;Error calculating stack reserved zone&quot;);
2777 
2778   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2779     _stack_guard_state = stack_guard_enabled;
2780   } else {
2781     warning(&quot;Attempt to guard stack reserved zone failed.&quot;);
2782   }
2783   enable_register_stack_guard();
2784 }
2785 
2786 void JavaThread::disable_stack_reserved_zone() {
2787   assert(_stack_guard_state == stack_guard_enabled, &quot;inconsistent state&quot;);
2788 
2789   // Simply return if called for a thread that does not use guard pages.
2790   if (_stack_guard_state != stack_guard_enabled) return;
2791 
2792   // The base notation is from the stack&#39;s point of view, growing downward.
2793   // We need to adjust it to work correctly with guard_memory()
2794   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2795 
2796   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2797     _stack_guard_state = stack_guard_reserved_disabled;
2798   } else {
2799     warning(&quot;Attempt to unguard stack reserved zone failed.&quot;);
2800   }
2801   disable_register_stack_guard();
2802 }
2803 
2804 void JavaThread::enable_stack_yellow_reserved_zone() {
2805   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2806   assert(_stack_guard_state != stack_guard_enabled, &quot;already enabled&quot;);
2807 
2808   // The base notation is from the stacks point of view, growing downward.
2809   // We need to adjust it to work correctly with guard_memory()
2810   address base = stack_red_zone_base();
2811 
2812   guarantee(base &lt; stack_base(), &quot;Error calculating stack yellow zone&quot;);
2813   guarantee(base &lt; os::current_stack_pointer(), &quot;Error calculating stack yellow zone&quot;);
2814 
2815   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2816     _stack_guard_state = stack_guard_enabled;
2817   } else {
2818     warning(&quot;Attempt to guard stack yellow zone failed.&quot;);
2819   }
2820   enable_register_stack_guard();
2821 }
2822 
2823 void JavaThread::disable_stack_yellow_reserved_zone() {
2824   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2825   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, &quot;already disabled&quot;);
2826 
2827   // Simply return if called for a thread that does not use guard pages.
2828   if (_stack_guard_state == stack_guard_unused) return;
2829 
2830   // The base notation is from the stacks point of view, growing downward.
2831   // We need to adjust it to work correctly with guard_memory()
2832   address base = stack_red_zone_base();
2833 
2834   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2835     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2836   } else {
2837     warning(&quot;Attempt to unguard stack yellow zone failed.&quot;);
2838   }
2839   disable_register_stack_guard();
2840 }
2841 
2842 void JavaThread::enable_stack_red_zone() {
2843   // The base notation is from the stacks point of view, growing downward.
2844   // We need to adjust it to work correctly with guard_memory()
2845   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2846   address base = stack_red_zone_base() - stack_red_zone_size();
2847 
2848   guarantee(base &lt; stack_base(), &quot;Error calculating stack red zone&quot;);
2849   guarantee(base &lt; os::current_stack_pointer(), &quot;Error calculating stack red zone&quot;);
2850 
2851   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2852     warning(&quot;Attempt to guard stack red zone failed.&quot;);
2853   }
2854 }
2855 
2856 void JavaThread::disable_stack_red_zone() {
2857   // The base notation is from the stacks point of view, growing downward.
2858   // We need to adjust it to work correctly with guard_memory()
2859   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2860   address base = stack_red_zone_base() - stack_red_zone_size();
2861   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2862     warning(&quot;Attempt to unguard stack red zone failed.&quot;);
2863   }
2864 }
2865 
2866 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2867   // ignore is there is no stack
2868   if (!has_last_Java_frame()) return;
2869   // traverse the stack frames. Starts from top frame.
2870   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2871     frame* fr = fst.current();
2872     f(fr, fst.register_map());
2873   }
2874 }
2875 
2876 
2877 #ifndef PRODUCT
2878 // Deoptimization
2879 // Function for testing deoptimization
2880 void JavaThread::deoptimize() {
2881   StackFrameStream fst(this, false);
2882   bool deopt = false;           // Dump stack only if a deopt actually happens.
2883   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2884   // Iterate over all frames in the thread and deoptimize
2885   for (; !fst.is_done(); fst.next()) {
2886     if (fst.current()-&gt;can_be_deoptimized()) {
2887 
2888       if (only_at) {
2889         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2890         // consists of comma or carriage return separated numbers so
2891         // search for the current bci in that string.
2892         address pc = fst.current()-&gt;pc();
2893         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2894         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2895         char buffer[8];
2896         jio_snprintf(buffer, sizeof(buffer), &quot;%d&quot;, sd-&gt;bci());
2897         size_t len = strlen(buffer);
2898         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2899         while (found != NULL) {
2900           if ((found[len] == &#39;,&#39; || found[len] == &#39;\n&#39; || found[len] == &#39;\0&#39;) &amp;&amp;
2901               (found == DeoptimizeOnlyAt || found[-1] == &#39;,&#39; || found[-1] == &#39;\n&#39;)) {
2902             // Check that the bci found is bracketed by terminators.
2903             break;
2904           }
2905           found = strstr(found + 1, buffer);
2906         }
2907         if (!found) {
2908           continue;
2909         }
2910       }
2911 
2912       if (DebugDeoptimization &amp;&amp; !deopt) {
2913         deopt = true; // One-time only print before deopt
2914         tty-&gt;print_cr(&quot;[BEFORE Deoptimization]&quot;);
2915         trace_frames();
2916         trace_stack();
2917       }
2918       Deoptimization::deoptimize(this, *fst.current());
2919     }
2920   }
2921 
2922   if (DebugDeoptimization &amp;&amp; deopt) {
2923     tty-&gt;print_cr(&quot;[AFTER Deoptimization]&quot;);
2924     trace_frames();
2925   }
2926 }
2927 
2928 
2929 // Make zombies
2930 void JavaThread::make_zombies() {
2931   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2932     if (fst.current()-&gt;can_be_deoptimized()) {
2933       // it is a Java nmethod
2934       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2935       nm-&gt;make_not_entrant();
2936     }
2937   }
2938 }
2939 #endif // PRODUCT
2940 
2941 
2942 void JavaThread::deoptimize_marked_methods() {
2943   if (!has_last_Java_frame()) return;
2944   StackFrameStream fst(this, false);
2945   for (; !fst.is_done(); fst.next()) {
2946     if (fst.current()-&gt;should_be_deoptimized()) {
2947       Deoptimization::deoptimize(this, *fst.current());
2948     }
2949   }
2950 }
2951 
2952 // If the caller is a NamedThread, then remember, in the current scope,
2953 // the given JavaThread in its _processed_thread field.
2954 class RememberProcessedThread: public StackObj {
2955   NamedThread* _cur_thr;
2956  public:
2957   RememberProcessedThread(JavaThread* jthr) {
2958     Thread* thread = Thread::current();
2959     if (thread-&gt;is_Named_thread()) {
2960       _cur_thr = (NamedThread *)thread;
2961       _cur_thr-&gt;set_processed_thread(jthr);
2962     } else {
2963       _cur_thr = NULL;
2964     }
2965   }
2966 
2967   ~RememberProcessedThread() {
2968     if (_cur_thr) {
2969       _cur_thr-&gt;set_processed_thread(NULL);
2970     }
2971   }
2972 };
2973 
2974 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2975   // Verify that the deferred card marks have been flushed.
2976   assert(deferred_card_mark().is_empty(), &quot;Should be empty during GC&quot;);
2977 
2978   // Traverse the GCHandles
2979   Thread::oops_do(f, cf);
2980 
2981   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2982          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), &quot;wrong java_sp info!&quot;);
2983 
2984   if (has_last_Java_frame()) {
2985     // Record JavaThread to GC thread
2986     RememberProcessedThread rpt(this);
2987 
2988     // traverse the registered growable array
2989     if (_array_for_gc != NULL) {
2990       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
2991         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
2992       }
2993     }
2994 
2995     // Traverse the monitor chunks
2996     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2997       chunk-&gt;oops_do(f);
2998     }
2999 
3000     // Traverse the execution stack
3001     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3002       fst.current()-&gt;oops_do(f, cf, fst.register_map());
3003     }
3004   }
3005 
3006   assert(vframe_array_head() == NULL, &quot;deopt in progress at a safepoint!&quot;);
3007   // If we have deferred set_locals there might be oops waiting to be
3008   // written
3009   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
3010   if (list != NULL) {
3011     for (int i = 0; i &lt; list-&gt;length(); i++) {
3012       list-&gt;at(i)-&gt;oops_do(f);
3013     }
3014   }
3015 
3016   // Traverse instance variables at the end since the GC may be moving things
3017   // around using this function
3018   f-&gt;do_oop((oop*) &amp;_threadObj);
3019   f-&gt;do_oop((oop*) &amp;_vm_result);
3020   f-&gt;do_oop((oop*) &amp;_exception_oop);
3021   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
3022 
3023   if (jvmti_thread_state() != NULL) {
3024     jvmti_thread_state()-&gt;oops_do(f, cf);
3025   }
3026 }
3027 
3028 #ifdef ASSERT
3029 void JavaThread::verify_states_for_handshake() {
3030   // This checks that the thread has a correct frame state during a handshake.
3031   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
3032          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0),
3033          &quot;unexpected frame info: has_last_frame=%d, java_call_counter=%d&quot;,
3034          has_last_Java_frame(), java_call_counter());
3035 }
3036 #endif
3037 
3038 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
3039   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
3040          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0),
3041          &quot;unexpected frame info: has_last_frame=%d, java_call_counter=%d&quot;,
3042          has_last_Java_frame(), java_call_counter());
3043 
3044   if (has_last_Java_frame()) {
3045     // Traverse the execution stack
3046     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3047       fst.current()-&gt;nmethods_do(cf);
3048     }
3049   }
3050 
3051   if (jvmti_thread_state() != NULL) {
3052     jvmti_thread_state()-&gt;nmethods_do(cf);
3053   }
3054 }
3055 
3056 void JavaThread::metadata_do(MetadataClosure* f) {
3057   if (has_last_Java_frame()) {
3058     // Traverse the execution stack to call f() on the methods in the stack
3059     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3060       fst.current()-&gt;metadata_do(f);
3061     }
3062   } else if (is_Compiler_thread()) {
3063     // need to walk ciMetadata in current compile tasks to keep alive.
3064     CompilerThread* ct = (CompilerThread*)this;
3065     if (ct-&gt;env() != NULL) {
3066       ct-&gt;env()-&gt;metadata_do(f);
3067     }
3068     CompileTask* task = ct-&gt;task();
3069     if (task != NULL) {
3070       task-&gt;metadata_do(f);
3071     }
3072   }
3073 }
3074 
3075 // Printing
3076 const char* _get_thread_state_name(JavaThreadState _thread_state) {
3077   switch (_thread_state) {
3078   case _thread_uninitialized:     return &quot;_thread_uninitialized&quot;;
3079   case _thread_new:               return &quot;_thread_new&quot;;
3080   case _thread_new_trans:         return &quot;_thread_new_trans&quot;;
3081   case _thread_in_native:         return &quot;_thread_in_native&quot;;
3082   case _thread_in_native_trans:   return &quot;_thread_in_native_trans&quot;;
3083   case _thread_in_vm:             return &quot;_thread_in_vm&quot;;
3084   case _thread_in_vm_trans:       return &quot;_thread_in_vm_trans&quot;;
3085   case _thread_in_Java:           return &quot;_thread_in_Java&quot;;
3086   case _thread_in_Java_trans:     return &quot;_thread_in_Java_trans&quot;;
3087   case _thread_blocked:           return &quot;_thread_blocked&quot;;
3088   case _thread_blocked_trans:     return &quot;_thread_blocked_trans&quot;;
3089   default:                        return &quot;unknown thread state&quot;;
3090   }
3091 }
3092 
3093 #ifndef PRODUCT
3094 void JavaThread::print_thread_state_on(outputStream *st) const {
3095   st-&gt;print_cr(&quot;   JavaThread state: %s&quot;, _get_thread_state_name(_thread_state));
3096 };
3097 #endif // PRODUCT
3098 
3099 // Called by Threads::print() for VM_PrintThreads operation
3100 void JavaThread::print_on(outputStream *st, bool print_extended_info) const {
3101   st-&gt;print_raw(&quot;\&quot;&quot;);
3102   st-&gt;print_raw(get_thread_name());
3103   st-&gt;print_raw(&quot;\&quot; &quot;);
3104   oop thread_oop = threadObj();
3105   if (thread_oop != NULL) {
3106     st-&gt;print(&quot;#&quot; INT64_FORMAT &quot; &quot;, (int64_t)java_lang_Thread::thread_id(thread_oop));
3107     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print(&quot;daemon &quot;);
3108     st-&gt;print(&quot;prio=%d &quot;, java_lang_Thread::priority(thread_oop));
3109   }
3110   Thread::print_on(st, print_extended_info);
3111   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
3112   st-&gt;print_cr(&quot;[&quot; INTPTR_FORMAT &quot;]&quot;, (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
3113   if (thread_oop != NULL) {
3114     st-&gt;print_cr(&quot;   java.lang.Thread.State: %s&quot;, java_lang_Thread::thread_status_name(thread_oop));
3115   }
3116 #ifndef PRODUCT
3117   _safepoint_state-&gt;print_on(st);
3118 #endif // PRODUCT
3119   if (is_Compiler_thread()) {
3120     CompileTask *task = ((CompilerThread*)this)-&gt;task();
3121     if (task != NULL) {
3122       st-&gt;print(&quot;   Compiling: &quot;);
3123       task-&gt;print(st, NULL, true, false);
3124     } else {
3125       st-&gt;print(&quot;   No compile task&quot;);
3126     }
3127     st-&gt;cr();
3128   }
3129 }
3130 
3131 void JavaThread::print() const { print_on(tty); }
3132 
3133 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
3134   st-&gt;print(&quot;%s&quot;, get_thread_name_string(buf, buflen));
3135 }
3136 
3137 // Called by fatal error handler. The difference between this and
3138 // JavaThread::print() is that we can&#39;t grab lock or allocate memory.
3139 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
3140   st-&gt;print(&quot;JavaThread \&quot;%s\&quot;&quot;, get_thread_name_string(buf, buflen));
3141   oop thread_obj = threadObj();
3142   if (thread_obj != NULL) {
3143     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(&quot; daemon&quot;);
3144   }
3145   st-&gt;print(&quot; [&quot;);
3146   st-&gt;print(&quot;%s&quot;, _get_thread_state_name(_thread_state));
3147   if (osthread()) {
3148     st-&gt;print(&quot;, id=%d&quot;, osthread()-&gt;thread_id());
3149   }
3150   st-&gt;print(&quot;, stack(&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;)&quot;,
3151             p2i(stack_end()), p2i(stack_base()));
3152   st-&gt;print(&quot;]&quot;);
3153 
3154   ThreadsSMRSupport::print_info_on(this, st);
3155   return;
3156 }
3157 
3158 // Verification
3159 
3160 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
3161 
3162 void JavaThread::verify() {
3163   // Verify oops in the thread.
3164   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
3165 
3166   // Verify the stack frames.
3167   frames_do(frame_verify);
3168 }
3169 
3170 // CR 6300358 (sub-CR 2137150)
3171 // Most callers of this method assume that it can&#39;t return NULL but a
3172 // thread may not have a name whilst it is in the process of attaching to
3173 // the VM - see CR 6412693, and there are places where a JavaThread can be
3174 // seen prior to having it&#39;s threadObj set (eg JNI attaching threads and
3175 // if vm exit occurs during initialization). These cases can all be accounted
3176 // for such that this method never returns NULL.
3177 const char* JavaThread::get_thread_name() const {
3178 #ifdef ASSERT
3179   // early safepoints can hit while current thread does not yet have TLS
3180   if (!SafepointSynchronize::is_at_safepoint()) {
3181     Thread *cur = Thread::current();
3182     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
3183       // Current JavaThreads are allowed to get their own name without
3184       // the Threads_lock.
3185       assert_locked_or_safepoint_or_handshake(Threads_lock, this);
3186     }
3187   }
3188 #endif // ASSERT
3189   return get_thread_name_string();
3190 }
3191 
3192 // Returns a non-NULL representation of this thread&#39;s name, or a suitable
3193 // descriptive string if there is no set name
3194 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
3195   const char* name_str;
3196   oop thread_obj = threadObj();
3197   if (thread_obj != NULL) {
3198     oop name = java_lang_Thread::name(thread_obj);
3199     if (name != NULL) {
3200       if (buf == NULL) {
3201         name_str = java_lang_String::as_utf8_string(name);
3202       } else {
3203         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
3204       }
3205     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
3206       name_str = &quot;&lt;no-name - thread is attaching&gt;&quot;;
3207     } else {
3208       name_str = Thread::name();
3209     }
3210   } else {
3211     name_str = Thread::name();
3212   }
3213   assert(name_str != NULL, &quot;unexpected NULL thread name&quot;);
3214   return name_str;
3215 }
3216 
3217 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3218 
3219   assert(Threads_lock-&gt;owner() == Thread::current(), &quot;must have threads lock&quot;);
3220   assert(NoPriority &lt;= prio &amp;&amp; prio &lt;= MaxPriority, &quot;sanity check&quot;);
3221   // Link Java Thread object &lt;-&gt; C++ Thread
3222 
3223   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3224   // and put it into a new Handle.  The Handle &quot;thread_oop&quot; can then
3225   // be used to pass the C++ thread object to other methods.
3226 
3227   // Set the Java level thread object (jthread) field of the
3228   // new thread (a JavaThread *) to C++ thread object using the
3229   // &quot;thread_oop&quot; handle.
3230 
3231   // Set the thread field (a JavaThread *) of the
3232   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3233 
3234   Handle thread_oop(Thread::current(),
3235                     JNIHandles::resolve_non_null(jni_thread));
3236   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3237          &quot;must be initialized&quot;);
3238   set_threadObj(thread_oop());
3239   java_lang_Thread::set_thread(thread_oop(), this);
3240 
3241   if (prio == NoPriority) {
3242     prio = java_lang_Thread::priority(thread_oop());
3243     assert(prio != NoPriority, &quot;A valid priority should be present&quot;);
3244   }
3245 
3246   // Push the Java priority down to the native thread; needs Threads_lock
3247   Thread::set_priority(this, prio);
3248 
3249   // Add the new thread to the Threads list and set it in motion.
3250   // We must have threads lock in order to call Threads::add.
3251   // It is crucial that we do not block before the thread is
3252   // added to the Threads list for if a GC happens, then the java_thread oop
3253   // will not be visited by GC.
3254   Threads::add(this);
3255 }
3256 
3257 oop JavaThread::current_park_blocker() {
3258   // Support for JSR-166 locks
3259   oop thread_oop = threadObj();
3260   if (thread_oop != NULL) {
3261     return java_lang_Thread::park_blocker(thread_oop);
3262   }
3263   return NULL;
3264 }
3265 
3266 
3267 void JavaThread::print_stack_on(outputStream* st) {
3268   if (!has_last_Java_frame()) return;
<a name="11" id="anc11"></a><span class="line-modified">3269 </span>
<span class="line-modified">3270   Thread* current_thread = Thread::current();</span>
<span class="line-added">3271   ResourceMark rm(current_thread);</span>
<span class="line-added">3272   HandleMark hm(current_thread);</span>
3273 
3274   RegisterMap reg_map(this);
3275   vframe* start_vf = last_java_vframe(&amp;reg_map);
3276   int count = 0;
3277   for (vframe* f = start_vf; f != NULL; f = f-&gt;sender()) {
3278     if (f-&gt;is_java_frame()) {
3279       javaVFrame* jvf = javaVFrame::cast(f);
3280       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3281 
3282       // Print out lock information
3283       if (JavaMonitorsInStackTrace) {
3284         jvf-&gt;print_lock_info_on(st, count);
3285       }
3286     } else {
3287       // Ignore non-Java frames
3288     }
3289 
3290     // Bail-out case for too deep stacks if MaxJavaStackTraceDepth &gt; 0
3291     count++;
3292     if (MaxJavaStackTraceDepth &gt; 0 &amp;&amp; MaxJavaStackTraceDepth == count) return;
3293   }
3294 }
3295 
3296 
3297 // JVMTI PopFrame support
3298 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3299   assert(_popframe_preserved_args == NULL, &quot;should not wipe out old PopFrame preserved arguments&quot;);
3300   if (in_bytes(size_in_bytes) != 0) {
3301     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3302     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3303     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3304   }
3305 }
3306 
3307 void* JavaThread::popframe_preserved_args() {
3308   return _popframe_preserved_args;
3309 }
3310 
3311 ByteSize JavaThread::popframe_preserved_args_size() {
3312   return in_ByteSize(_popframe_preserved_args_size);
3313 }
3314 
3315 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3316   int sz = in_bytes(popframe_preserved_args_size());
3317   assert(sz % wordSize == 0, &quot;argument size must be multiple of wordSize&quot;);
3318   return in_WordSize(sz / wordSize);
3319 }
3320 
3321 void JavaThread::popframe_free_preserved_args() {
3322   assert(_popframe_preserved_args != NULL, &quot;should not free PopFrame preserved arguments twice&quot;);
3323   FREE_C_HEAP_ARRAY(char, (char*)_popframe_preserved_args);
3324   _popframe_preserved_args = NULL;
3325   _popframe_preserved_args_size = 0;
3326 }
3327 
3328 #ifndef PRODUCT
3329 
3330 void JavaThread::trace_frames() {
3331   tty-&gt;print_cr(&quot;[Describe stack]&quot;);
3332   int frame_no = 1;
3333   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3334     tty-&gt;print(&quot;  %d. &quot;, frame_no++);
3335     fst.current()-&gt;print_value_on(tty, this);
3336     tty-&gt;cr();
3337   }
3338 }
3339 
3340 class PrintAndVerifyOopClosure: public OopClosure {
3341  protected:
3342   template &lt;class T&gt; inline void do_oop_work(T* p) {
3343     oop obj = RawAccess&lt;&gt;::oop_load(p);
3344     if (obj == NULL) return;
3345     tty-&gt;print(INTPTR_FORMAT &quot;: &quot;, p2i(p));
3346     if (oopDesc::is_oop_or_null(obj)) {
3347       if (obj-&gt;is_objArray()) {
3348         tty-&gt;print_cr(&quot;valid objArray: &quot; INTPTR_FORMAT, p2i(obj));
3349       } else {
3350         obj-&gt;print();
3351       }
3352     } else {
3353       tty-&gt;print_cr(&quot;invalid oop: &quot; INTPTR_FORMAT, p2i(obj));
3354     }
3355     tty-&gt;cr();
3356   }
3357  public:
3358   virtual void do_oop(oop* p) { do_oop_work(p); }
3359   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3360 };
3361 
3362 #ifdef ASSERT
3363 // Print or validate the layout of stack frames
3364 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3365   ResourceMark rm;
3366   PRESERVE_EXCEPTION_MARK;
3367   FrameValues values;
3368   int frame_no = 0;
3369   for (StackFrameStream fst(this, false); !fst.is_done(); fst.next()) {
3370     fst.current()-&gt;describe(values, ++frame_no);
3371     if (depth == frame_no) break;
3372   }
3373   if (validate_only) {
3374     values.validate();
3375   } else {
3376     tty-&gt;print_cr(&quot;[Describe stack layout]&quot;);
3377     values.print(this);
3378   }
3379 }
3380 #endif
3381 
3382 void JavaThread::trace_stack_from(vframe* start_vf) {
3383   ResourceMark rm;
3384   int vframe_no = 1;
3385   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3386     if (f-&gt;is_java_frame()) {
3387       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3388     } else {
3389       f-&gt;print();
3390     }
3391     if (vframe_no &gt; StackPrintLimit) {
3392       tty-&gt;print_cr(&quot;...&lt;more frames&gt;...&quot;);
3393       return;
3394     }
3395   }
3396 }
3397 
3398 
3399 void JavaThread::trace_stack() {
3400   if (!has_last_Java_frame()) return;
<a name="12" id="anc12"></a><span class="line-modified">3401   Thread* current_thread = Thread::current();</span>
<span class="line-modified">3402   ResourceMark rm(current_thread);</span>
<span class="line-added">3403   HandleMark hm(current_thread);</span>
3404   RegisterMap reg_map(this);
3405   trace_stack_from(last_java_vframe(&amp;reg_map));
3406 }
3407 
3408 
3409 #endif // PRODUCT
3410 
3411 
3412 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3413   assert(reg_map != NULL, &quot;a map must be given&quot;);
3414   frame f = last_frame();
3415   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3416     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3417   }
3418   return NULL;
3419 }
3420 
3421 
3422 Klass* JavaThread::security_get_caller_class(int depth) {
3423   vframeStream vfst(this);
3424   vfst.security_get_caller_frame(depth);
3425   if (!vfst.at_end()) {
3426     return vfst.method()-&gt;method_holder();
3427   }
3428   return NULL;
3429 }
3430 
3431 // java.lang.Thread.sleep support
3432 // Returns true if sleep time elapsed as expected, and false
3433 // if the thread was interrupted.
3434 bool JavaThread::sleep(jlong millis) {
3435   assert(this == Thread::current(),  &quot;thread consistency check&quot;);
3436 
3437   ParkEvent * const slp = this-&gt;_SleepEvent;
3438   // Because there can be races with thread interruption sending an unpark()
3439   // to the event, we explicitly reset it here to avoid an immediate return.
3440   // The actual interrupt state will be checked before we park().
3441   slp-&gt;reset();
3442   // Thread interruption establishes a happens-before ordering in the
3443   // Java Memory Model, so we need to ensure we synchronize with the
3444   // interrupt state.
3445   OrderAccess::fence();
3446 
3447   jlong prevtime = os::javaTimeNanos();
3448 
3449   for (;;) {
3450     // interruption has precedence over timing out
3451     if (this-&gt;is_interrupted(true)) {
3452       return false;
3453     }
3454 
3455     if (millis &lt;= 0) {
3456       return true;
3457     }
3458 
3459     {
3460       ThreadBlockInVM tbivm(this);
3461       OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
3462 
3463       this-&gt;set_suspend_equivalent();
3464       // cleared by handle_special_suspend_equivalent_condition() or
3465       // java_suspend_self() via check_and_wait_while_suspended()
3466 
3467       slp-&gt;park(millis);
3468 
3469       // were we externally suspended while we were waiting?
3470       this-&gt;check_and_wait_while_suspended();
3471     }
3472 
3473     // Update elapsed time tracking
3474     jlong newtime = os::javaTimeNanos();
3475     if (newtime - prevtime &lt; 0) {
3476       // time moving backwards, should only happen if no monotonic clock
3477       // not a guarantee() because JVM should not abort on kernel/glibc bugs
3478       assert(!os::supports_monotonic_clock(),
3479              &quot;unexpected time moving backwards detected in JavaThread::sleep()&quot;);
3480     } else {
3481       millis -= (newtime - prevtime) / NANOSECS_PER_MILLISEC;
3482     }
3483     prevtime = newtime;
3484   }
3485 }
3486 
3487 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3488   assert(thread-&gt;is_Compiler_thread(), &quot;must be compiler thread&quot;);
3489   CompileBroker::compiler_thread_loop();
3490 }
3491 
3492 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3493   NMethodSweeper::sweeper_loop();
3494 }
3495 
3496 // Create a CompilerThread
3497 CompilerThread::CompilerThread(CompileQueue* queue,
3498                                CompilerCounters* counters)
3499                                : JavaThread(&amp;compiler_thread_entry) {
3500   _env   = NULL;
3501   _log   = NULL;
3502   _task  = NULL;
3503   _queue = queue;
3504   _counters = counters;
3505   _buffer_blob = NULL;
3506   _compiler = NULL;
3507 
3508   // Compiler uses resource area for compilation, let&#39;s bias it to mtCompiler
3509   resource_area()-&gt;bias_to(mtCompiler);
3510 
3511 #ifndef PRODUCT
3512   _ideal_graph_printer = NULL;
3513 #endif
3514 }
3515 
3516 CompilerThread::~CompilerThread() {
3517   // Delete objects which were allocated on heap.
3518   delete _counters;
3519 }
3520 
3521 bool CompilerThread::can_call_java() const {
3522   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3523 }
3524 
3525 // Create sweeper thread
3526 CodeCacheSweeperThread::CodeCacheSweeperThread()
3527 : JavaThread(&amp;sweeper_thread_entry) {
3528   _scanned_compiled_method = NULL;
3529 }
3530 
3531 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3532   JavaThread::oops_do(f, cf);
3533   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3534     // Safepoints can occur when the sweeper is scanning an nmethod so
3535     // process it here to make sure it isn&#39;t unloaded in the middle of
3536     // a scan.
3537     cf-&gt;do_code_blob(_scanned_compiled_method);
3538   }
3539 }
3540 
3541 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3542   JavaThread::nmethods_do(cf);
3543   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3544     // Safepoints can occur when the sweeper is scanning an nmethod so
3545     // process it here to make sure it isn&#39;t unloaded in the middle of
3546     // a scan.
3547     cf-&gt;do_code_blob(_scanned_compiled_method);
3548   }
3549 }
3550 
3551 
3552 // ======= Threads ========
3553 
3554 // The Threads class links together all active threads, and provides
3555 // operations over all threads. It is protected by the Threads_lock,
3556 // which is also used in other global contexts like safepointing.
3557 // ThreadsListHandles are used to safely perform operations on one
3558 // or more threads without the risk of the thread exiting during the
3559 // operation.
3560 //
3561 // Note: The Threads_lock is currently more widely used than we
3562 // would like. We are actively migrating Threads_lock uses to other
3563 // mechanisms in order to reduce Threads_lock contention.
3564 
3565 int         Threads::_number_of_threads = 0;
3566 int         Threads::_number_of_non_daemon_threads = 0;
3567 int         Threads::_return_code = 0;
3568 uintx       Threads::_thread_claim_token = 1; // Never zero.
3569 size_t      JavaThread::_stack_size_at_create = 0;
3570 
3571 #ifdef ASSERT
3572 bool        Threads::_vm_complete = false;
3573 #endif
3574 
3575 static inline void *prefetch_and_load_ptr(void **addr, intx prefetch_interval) {
3576   Prefetch::read((void*)addr, prefetch_interval);
3577   return *addr;
3578 }
3579 
3580 // Possibly the ugliest for loop the world has seen. C++ does not allow
3581 // multiple types in the declaration section of the for loop. In this case
3582 // we are only dealing with pointers and hence can cast them. It looks ugly
3583 // but macros are ugly and therefore it&#39;s fine to make things absurdly ugly.
3584 #define DO_JAVA_THREADS(LIST, X)                                                                                          \
3585     for (JavaThread *MACRO_scan_interval = (JavaThread*)(uintptr_t)PrefetchScanIntervalInBytes,                           \
3586              *MACRO_list = (JavaThread*)(LIST),                                                                           \
3587              **MACRO_end = ((JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads()) + ((ThreadsList*)MACRO_list)-&gt;length(),  \
3588              **MACRO_current_p = (JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads(),                                     \
3589              *X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval);                 \
3590          MACRO_current_p != MACRO_end;                                                                                    \
3591          MACRO_current_p++,                                                                                               \
3592              X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval))
3593 
3594 // All JavaThreads
3595 #define ALL_JAVA_THREADS(X) DO_JAVA_THREADS(ThreadsSMRSupport::get_java_thread_list(), X)
3596 
3597 // All NonJavaThreads (i.e., every non-JavaThread in the system).
3598 void Threads::non_java_threads_do(ThreadClosure* tc) {
3599   NoSafepointVerifier nsv;
3600   for (NonJavaThread::Iterator njti; !njti.end(); njti.step()) {
3601     tc-&gt;do_thread(njti.current());
3602   }
3603 }
3604 
3605 // All JavaThreads
3606 void Threads::java_threads_do(ThreadClosure* tc) {
3607   assert_locked_or_safepoint(Threads_lock);
3608   // ALL_JAVA_THREADS iterates through all JavaThreads.
3609   ALL_JAVA_THREADS(p) {
3610     tc-&gt;do_thread(p);
3611   }
3612 }
3613 
3614 void Threads::java_threads_and_vm_thread_do(ThreadClosure* tc) {
3615   assert_locked_or_safepoint(Threads_lock);
3616   java_threads_do(tc);
3617   tc-&gt;do_thread(VMThread::vm_thread());
3618 }
3619 
3620 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system).
3621 void Threads::threads_do(ThreadClosure* tc) {
3622   assert_locked_or_safepoint(Threads_lock);
3623   java_threads_do(tc);
3624   non_java_threads_do(tc);
3625 }
3626 
3627 void Threads::possibly_parallel_threads_do(bool is_par, ThreadClosure* tc) {
3628   uintx claim_token = Threads::thread_claim_token();
3629   ALL_JAVA_THREADS(p) {
3630     if (p-&gt;claim_threads_do(is_par, claim_token)) {
3631       tc-&gt;do_thread(p);
3632     }
3633   }
3634   VMThread* vmt = VMThread::vm_thread();
3635   if (vmt-&gt;claim_threads_do(is_par, claim_token)) {
3636     tc-&gt;do_thread(vmt);
3637   }
3638 }
3639 
3640 // The system initialization in the library has three phases.
3641 //
3642 // Phase 1: java.lang.System class initialization
3643 //     java.lang.System is a primordial class loaded and initialized
3644 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3645 //     only does registerNatives and keeps the rest of the class
3646 //     initialization work later until thread initialization completes.
3647 //
3648 //     System.initPhase1 initializes the system properties, the static
3649 //     fields in, out, and err. Set up java signal handlers, OS-specific
3650 //     system settings, and thread group of the main thread.
3651 static void call_initPhase1(TRAPS) {
3652   Klass* klass = SystemDictionary::System_klass();
3653   JavaValue result(T_VOID);
3654   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3655                                          vmSymbols::void_method_signature(), CHECK);
3656 }
3657 
3658 // Phase 2. Module system initialization
3659 //     This will initialize the module system.  Only java.base classes
3660 //     can be loaded until phase 2 completes.
3661 //
3662 //     Call System.initPhase2 after the compiler initialization and jsr292
3663 //     classes get initialized because module initialization runs a lot of java
3664 //     code, that for performance reasons, should be compiled.  Also, this will
3665 //     enable the startup code to use lambda and other language features in this
3666 //     phase and onward.
3667 //
3668 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3669 static void call_initPhase2(TRAPS) {
3670   TraceTime timer(&quot;Initialize module system&quot;, TRACETIME_LOG(Info, startuptime));
3671 
3672   Klass* klass = SystemDictionary::System_klass();
3673 
3674   JavaValue result(T_INT);
3675   JavaCallArguments args;
3676   args.push_int(DisplayVMOutputToStderr);
3677   args.push_int(log_is_enabled(Debug, init)); // print stack trace if exception thrown
3678   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3679                                          vmSymbols::boolean_boolean_int_signature(), &amp;args, CHECK);
3680   if (result.get_jint() != JNI_OK) {
3681     vm_exit_during_initialization(); // no message or exception
3682   }
3683 
3684   universe_post_module_init();
3685 }
3686 
3687 // Phase 3. final setup - set security manager, system class loader and TCCL
3688 //
3689 //     This will instantiate and set the security manager, set the system class
3690 //     loader as well as the thread context class loader.  The security manager
3691 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3692 //     other modules or the application&#39;s classpath.
3693 static void call_initPhase3(TRAPS) {
3694   Klass* klass = SystemDictionary::System_klass();
3695   JavaValue result(T_VOID);
3696   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3697                                          vmSymbols::void_method_signature(), CHECK);
3698 }
3699 
3700 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3701   TraceTime timer(&quot;Initialize java.lang classes&quot;, TRACETIME_LOG(Info, startuptime));
3702 
3703   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3704     create_vm_init_libraries();
3705   }
3706 
3707   initialize_class(vmSymbols::java_lang_String(), CHECK);
3708 
3709   // Inject CompactStrings value after the static initializers for String ran.
3710   java_lang_String::set_compact_strings(CompactStrings);
3711 
3712   // Initialize java_lang.System (needed before creating the thread)
3713   initialize_class(vmSymbols::java_lang_System(), CHECK);
3714   // The VM creates &amp; returns objects of this class. Make sure it&#39;s initialized.
3715   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3716   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3717   Handle thread_group = create_initial_thread_group(CHECK);
3718   Universe::set_main_thread_group(thread_group());
3719   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3720   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3721   main_thread-&gt;set_threadObj(thread_object);
3722 
3723   // Set thread status to running since main thread has
3724   // been started and running.
3725   java_lang_Thread::set_thread_status(thread_object,
3726                                       java_lang_Thread::RUNNABLE);
3727 
3728   // The VM creates objects of this class.
3729   initialize_class(vmSymbols::java_lang_Module(), CHECK);
3730 
3731 #ifdef ASSERT
3732   InstanceKlass *k = SystemDictionary::UnsafeConstants_klass();
3733   assert(k-&gt;is_not_initialized(), &quot;UnsafeConstants should not already be initialized&quot;);
3734 #endif
3735 
3736   // initialize the hardware-specific constants needed by Unsafe
3737   initialize_class(vmSymbols::jdk_internal_misc_UnsafeConstants(), CHECK);
3738   jdk_internal_misc_UnsafeConstants::set_unsafe_constants();
3739 
3740   // The VM preresolves methods to these classes. Make sure that they get initialized
3741   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3742   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3743 
3744   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3745   call_initPhase1(CHECK);
3746 
3747   // get the Java runtime name, version, and vendor info after java.lang.System is initialized
3748   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3749   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3750   JDK_Version::set_runtime_vendor_version(get_java_runtime_vendor_version(THREAD));
3751   JDK_Version::set_runtime_vendor_vm_bug_url(get_java_runtime_vendor_vm_bug_url(THREAD));
3752 
3753   // an instance of OutOfMemory exception has been allocated earlier
3754   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3755   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3756   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3757   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3758   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3759   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3760   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3761   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3762 
3763   // Eager box cache initialization only if AOT is on and any library is loaded.
3764   AOTLoader::initialize_box_caches(CHECK);
3765 }
3766 
3767 void Threads::initialize_jsr292_core_classes(TRAPS) {
3768   TraceTime timer(&quot;Initialize java.lang.invoke classes&quot;, TRACETIME_LOG(Info, startuptime));
3769 
3770   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3771   initialize_class(vmSymbols::java_lang_invoke_ResolvedMethodName(), CHECK);
3772   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3773   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3774 }
3775 
3776 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3777   extern void JDK_Version_init();
3778 
3779   // Preinitialize version info.
3780   VM_Version::early_initialize();
3781 
3782   // Check version
3783   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3784 
3785   // Initialize library-based TLS
3786   ThreadLocalStorage::init();
3787 
3788   // Initialize the output stream module
3789   ostream_init();
3790 
3791   // Process java launcher properties.
3792   Arguments::process_sun_java_launcher_properties(args);
3793 
3794   // Initialize the os module
3795   os::init();
3796 
3797   // Record VM creation timing statistics
3798   TraceVmCreationTime create_vm_timer;
3799   create_vm_timer.start();
3800 
3801   // Initialize system properties.
3802   Arguments::init_system_properties();
3803 
3804   // So that JDK version can be used as a discriminator when parsing arguments
3805   JDK_Version_init();
3806 
3807   // Update/Initialize System properties after JDK version number is known
3808   Arguments::init_version_specific_system_properties();
3809 
3810   // Make sure to initialize log configuration *before* parsing arguments
3811   LogConfiguration::initialize(create_vm_timer.begin_time());
3812 
3813   // Parse arguments
3814   // Note: this internally calls os::init_container_support()
3815   jint parse_result = Arguments::parse(args);
3816   if (parse_result != JNI_OK) return parse_result;
3817 
3818   os::init_before_ergo();
3819 
3820   jint ergo_result = Arguments::apply_ergo();
3821   if (ergo_result != JNI_OK) return ergo_result;
3822 
3823   // Final check of all ranges after ergonomics which may change values.
3824   if (!JVMFlagRangeList::check_ranges()) {
3825     return JNI_EINVAL;
3826   }
3827 
3828   // Final check of all &#39;AfterErgo&#39; constraints after ergonomics which may change values.
3829   bool constraint_result = JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterErgo);
3830   if (!constraint_result) {
3831     return JNI_EINVAL;
3832   }
3833 
3834   if (PauseAtStartup) {
3835     os::pause();
3836   }
3837 
3838   HOTSPOT_VM_INIT_BEGIN();
3839 
3840   // Timing (must come after argument parsing)
3841   TraceTime timer(&quot;Create VM&quot;, TRACETIME_LOG(Info, startuptime));
3842 
3843   // Initialize the os module after parsing the args
3844   jint os_init_2_result = os::init_2();
3845   if (os_init_2_result != JNI_OK) return os_init_2_result;
3846 
3847 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3848   // Initialize assert poison page mechanism.
3849   if (ShowRegistersOnAssert) {
3850     initialize_assert_poison();
3851   }
3852 #endif // CAN_SHOW_REGISTERS_ON_ASSERT
3853 
3854   SafepointMechanism::initialize();
3855 
3856   jint adjust_after_os_result = Arguments::adjust_after_os();
3857   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3858 
3859   // Initialize output stream logging
3860   ostream_init_log();
3861 
3862   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3863   // Must be before create_vm_init_agents()
3864   if (Arguments::init_libraries_at_startup()) {
3865     convert_vm_init_libraries_to_agents();
3866   }
3867 
3868   // Launch -agentlib/-agentpath and converted -Xrun agents
3869   if (Arguments::init_agents_at_startup()) {
3870     create_vm_init_agents();
3871   }
3872 
3873   // Initialize Threads state
3874   _number_of_threads = 0;
3875   _number_of_non_daemon_threads = 0;
3876 
3877   // Initialize global data structures and create system classes in heap
3878   vm_init_globals();
3879 
3880 #if INCLUDE_JVMCI
3881   if (JVMCICounterSize &gt; 0) {
3882     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtJVMCI);
3883     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3884   } else {
3885     JavaThread::_jvmci_old_thread_counters = NULL;
3886   }
3887 #endif // INCLUDE_JVMCI
3888 
3889   // Attach the main thread to this os thread
3890   JavaThread* main_thread = new JavaThread();
3891   main_thread-&gt;set_thread_state(_thread_in_vm);
3892   main_thread-&gt;initialize_thread_current();
3893   // must do this before set_active_handles
3894   main_thread-&gt;record_stack_base_and_size();
3895   main_thread-&gt;register_thread_stack_with_NMT();
3896   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3897 
3898   if (!main_thread-&gt;set_as_starting_thread()) {
3899     vm_shutdown_during_initialization(
3900                                       &quot;Failed necessary internal allocation. Out of swap space&quot;);
3901     main_thread-&gt;smr_delete();
3902     *canTryAgain = false; // don&#39;t let caller call JNI_CreateJavaVM again
3903     return JNI_ENOMEM;
3904   }
3905 
3906   // Enable guard page *after* os::create_main_thread(), otherwise it would
3907   // crash Linux VM, see notes in os_linux.cpp.
3908   main_thread-&gt;create_stack_guard_pages();
3909 
3910   // Initialize Java-Level synchronization subsystem
3911   ObjectMonitor::Initialize();
3912 
3913   // Initialize global modules
3914   jint status = init_globals();
3915   if (status != JNI_OK) {
3916     main_thread-&gt;smr_delete();
3917     *canTryAgain = false; // don&#39;t let caller call JNI_CreateJavaVM again
3918     return status;
3919   }
3920 
3921   JFR_ONLY(Jfr::on_create_vm_1();)
3922 
3923   // Should be done after the heap is fully created
3924   main_thread-&gt;cache_global_variables();
3925 
<a name="13" id="anc13"></a>

3926   { MutexLocker mu(Threads_lock);
3927     Threads::add(main_thread);
3928   }
3929 
3930   // Any JVMTI raw monitors entered in onload will transition into
3931   // real raw monitor. VM is setup enough here for raw monitor enter.
3932   JvmtiExport::transition_pending_onload_raw_monitors();
3933 
3934   // Create the VMThread
3935   { TraceTime timer(&quot;Start VMThread&quot;, TRACETIME_LOG(Info, startuptime));
3936 
3937     VMThread::create();
3938     Thread* vmthread = VMThread::vm_thread();
3939 
3940     if (!os::create_thread(vmthread, os::vm_thread)) {
3941       vm_exit_during_initialization(&quot;Cannot create VM thread. &quot;
3942                                     &quot;Out of system resources.&quot;);
3943     }
3944 
3945     // Wait for the VM thread to become ready, and VMThread::run to initialize
3946     // Monitors can have spurious returns, must always check another state flag
3947     {
3948       MonitorLocker ml(Notify_lock);
3949       os::start_thread(vmthread);
3950       while (vmthread-&gt;active_handles() == NULL) {
3951         ml.wait();
3952       }
3953     }
3954   }
3955 
3956   assert(Universe::is_fully_initialized(), &quot;not initialized&quot;);
3957   if (VerifyDuringStartup) {
3958     // Make sure we&#39;re starting with a clean slate.
3959     VM_Verify verify_op;
3960     VMThread::execute(&amp;verify_op);
3961   }
3962 
3963   // We need this to update the java.vm.info property in case any flags used
3964   // to initially define it have been changed. This is needed for both CDS and
3965   // AOT, since UseSharedSpaces and UseAOT may be changed after java.vm.info
3966   // is initially computed. See Abstract_VM_Version::vm_info_string().
3967   // This update must happen before we initialize the java classes, but
3968   // after any initialization logic that might modify the flags.
3969   Arguments::update_vm_info_property(VM_Version::vm_info_string());
3970 
3971   Thread* THREAD = Thread::current();
<a name="14" id="anc14"></a><span class="line-added">3972   HandleMark hm(THREAD);</span>
3973 
3974   // Always call even when there are not JVMTI environments yet, since environments
3975   // may be attached late and JVMTI must track phases of VM execution
3976   JvmtiExport::enter_early_start_phase();
3977 
3978   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3979   JvmtiExport::post_early_vm_start();
3980 
3981   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
3982 
3983   quicken_jni_functions();
3984 
3985   // No more stub generation allowed after that point.
3986   StubCodeDesc::freeze();
3987 
3988   // Set flag that basic initialization has completed. Used by exceptions and various
3989   // debug stuff, that does not work until all basic classes have been initialized.
3990   set_init_completed();
3991 
3992   LogConfiguration::post_initialize();
3993   Metaspace::post_initialize();
3994 
3995   HOTSPOT_VM_INIT_END();
3996 
3997   // record VM initialization completion time
3998 #if INCLUDE_MANAGEMENT
3999   Management::record_vm_init_completed();
4000 #endif // INCLUDE_MANAGEMENT
4001 
4002   // Signal Dispatcher needs to be started before VMInit event is posted
4003   os::initialize_jdk_signal_support(CHECK_JNI_ERR);
4004 
4005   // Start Attach Listener if +StartAttachListener or it can&#39;t be started lazily
4006   if (!DisableAttachMechanism) {
4007     AttachListener::vm_start();
4008     if (StartAttachListener || AttachListener::init_at_startup()) {
4009       AttachListener::init();
4010     }
4011   }
4012 
4013   // Launch -Xrun agents
4014   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
4015   // back-end can launch with -Xdebug -Xrunjdwp.
4016   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
4017     create_vm_init_libraries();
4018   }
4019 
4020   if (CleanChunkPoolAsync) {
4021     Chunk::start_chunk_pool_cleaner_task();
4022   }
4023 
4024   // Start the service thread
4025   // The service thread enqueues JVMTI deferred events and does various hashtable
4026   // and other cleanups.  Needs to start before the compilers start posting events.
4027   ServiceThread::initialize();
4028 
4029   // initialize compiler(s)
4030 #if defined(COMPILER1) || COMPILER2_OR_JVMCI
4031 #if INCLUDE_JVMCI
4032   bool force_JVMCI_intialization = false;
4033   if (EnableJVMCI) {
4034     // Initialize JVMCI eagerly when it is explicitly requested.
4035     // Or when JVMCILibDumpJNIConfig or JVMCIPrintProperties is enabled.
4036     force_JVMCI_intialization = EagerJVMCI || JVMCIPrintProperties || JVMCILibDumpJNIConfig;
4037 
4038     if (!force_JVMCI_intialization) {
4039       // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
4040       // compilations via JVMCI will not actually block until JVMCI is initialized.
4041       force_JVMCI_intialization = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);
4042     }
4043   }
4044 #endif
4045   CompileBroker::compilation_init_phase1(CHECK_JNI_ERR);
4046   // Postpone completion of compiler initialization to after JVMCI
4047   // is initialized to avoid timeouts of blocking compilations.
4048   if (JVMCI_ONLY(!force_JVMCI_intialization) NOT_JVMCI(true)) {
4049     CompileBroker::compilation_init_phase2();
4050   }
4051 #endif
4052 
4053   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
4054   // It is done after compilers are initialized, because otherwise compilations of
4055   // signature polymorphic MH intrinsics can be missed
4056   // (see SystemDictionary::find_method_handle_intrinsic).
4057   initialize_jsr292_core_classes(CHECK_JNI_ERR);
4058 
4059   // This will initialize the module system.  Only java.base classes can be
4060   // loaded until phase 2 completes
4061   call_initPhase2(CHECK_JNI_ERR);
4062 
4063   JFR_ONLY(Jfr::on_create_vm_2();)
4064 
4065   // Always call even when there are not JVMTI environments yet, since environments
4066   // may be attached late and JVMTI must track phases of VM execution
4067   JvmtiExport::enter_start_phase();
4068 
4069   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
4070   JvmtiExport::post_vm_start();
4071 
4072   // Final system initialization including security manager and system class loader
4073   call_initPhase3(CHECK_JNI_ERR);
4074 
4075   // cache the system and platform class loaders
4076   SystemDictionary::compute_java_loaders(CHECK_JNI_ERR);
4077 
4078 #if INCLUDE_CDS
4079   // capture the module path info from the ModuleEntryTable
4080   ClassLoader::initialize_module_path(THREAD);
4081 #endif
4082 
4083 #if INCLUDE_JVMCI
4084   if (force_JVMCI_intialization) {
4085     JVMCI::initialize_compiler(CHECK_JNI_ERR);
4086     CompileBroker::compilation_init_phase2();
4087   }
4088 #endif
4089 
4090   // Always call even when there are not JVMTI environments yet, since environments
4091   // may be attached late and JVMTI must track phases of VM execution
4092   JvmtiExport::enter_live_phase();
4093 
4094   // Make perfmemory accessible
4095   PerfMemory::set_accessible(true);
4096 
4097   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
4098   JvmtiExport::post_vm_initialized();
4099 
4100   JFR_ONLY(Jfr::on_create_vm_3();)
4101 
4102 #if INCLUDE_MANAGEMENT
4103   Management::initialize(THREAD);
4104 
4105   if (HAS_PENDING_EXCEPTION) {
4106     // management agent fails to start possibly due to
4107     // configuration problem and is responsible for printing
4108     // stack trace if appropriate. Simply exit VM.
4109     vm_exit(1);
4110   }
4111 #endif // INCLUDE_MANAGEMENT
4112 
4113   if (MemProfiling)                   MemProfiler::engage();
4114   StatSampler::engage();
4115   if (CheckJNICalls)                  JniPeriodicChecker::engage();
4116 
4117   BiasedLocking::init();
4118 
4119 #if INCLUDE_RTM_OPT
4120   RTMLockingCounters::init();
4121 #endif
4122 
4123   call_postVMInitHook(THREAD);
4124   // The Java side of PostVMInitHook.run must deal with all
4125   // exceptions and provide means of diagnosis.
4126   if (HAS_PENDING_EXCEPTION) {
4127     CLEAR_PENDING_EXCEPTION;
4128   }
4129 
4130   {
4131     MutexLocker ml(PeriodicTask_lock);
4132     // Make sure the WatcherThread can be started by WatcherThread::start()
4133     // or by dynamic enrollment.
4134     WatcherThread::make_startable();
4135     // Start up the WatcherThread if there are any periodic tasks
4136     // NOTE:  All PeriodicTasks should be registered by now. If they
4137     //   aren&#39;t, late joiners might appear to start slowly (we might
4138     //   take a while to process their first tick).
4139     if (PeriodicTask::num_tasks() &gt; 0) {
4140       WatcherThread::start();
4141     }
4142   }
4143 
4144   create_vm_timer.end();
4145 #ifdef ASSERT
4146   _vm_complete = true;
4147 #endif
4148 
4149   if (DumpSharedSpaces) {
4150     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
4151     ShouldNotReachHere();
4152   }
4153 
4154   return JNI_OK;
4155 }
4156 
4157 // type for the Agent_OnLoad and JVM_OnLoad entry points
4158 extern &quot;C&quot; {
4159   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
4160 }
4161 // Find a command line agent library and return its entry point for
4162 //         -agentlib:  -agentpath:   -Xrun
4163 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
4164 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
4165                                     const char *on_load_symbols[],
4166                                     size_t num_symbol_entries) {
4167   OnLoadEntry_t on_load_entry = NULL;
4168   void *library = NULL;
4169 
4170   if (!agent-&gt;valid()) {
4171     char buffer[JVM_MAXPATHLEN];
4172     char ebuf[1024] = &quot;&quot;;
4173     const char *name = agent-&gt;name();
4174     const char *msg = &quot;Could not find agent library &quot;;
4175 
4176     // First check to see if agent is statically linked into executable
4177     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
4178       library = agent-&gt;os_lib();
4179     } else if (agent-&gt;is_absolute_path()) {
4180       library = os::dll_load(name, ebuf, sizeof ebuf);
4181       if (library == NULL) {
4182         const char *sub_msg = &quot; in absolute path, with error: &quot;;
4183         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
4184         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4185         jio_snprintf(buf, len, &quot;%s%s%s%s&quot;, msg, name, sub_msg, ebuf);
4186         // If we can&#39;t find the agent, exit.
4187         vm_exit_during_initialization(buf, NULL);
4188         FREE_C_HEAP_ARRAY(char, buf);
4189       }
4190     } else {
4191       // Try to load the agent from the standard dll directory
4192       if (os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
4193                              name)) {
4194         library = os::dll_load(buffer, ebuf, sizeof ebuf);
4195       }
4196       if (library == NULL) { // Try the library path directory.
4197         if (os::dll_build_name(buffer, sizeof(buffer), name)) {
4198           library = os::dll_load(buffer, ebuf, sizeof ebuf);
4199         }
4200         if (library == NULL) {
4201           const char *sub_msg = &quot; on the library path, with error: &quot;;
4202           const char *sub_msg2 = &quot;\nModule java.instrument may be missing from runtime image.&quot;;
4203 
4204           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) +
4205                        strlen(ebuf) + strlen(sub_msg2) + 1;
4206           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4207           if (!agent-&gt;is_instrument_lib()) {
4208             jio_snprintf(buf, len, &quot;%s%s%s%s&quot;, msg, name, sub_msg, ebuf);
4209           } else {
4210             jio_snprintf(buf, len, &quot;%s%s%s%s%s&quot;, msg, name, sub_msg, ebuf, sub_msg2);
4211           }
4212           // If we can&#39;t find the agent, exit.
4213           vm_exit_during_initialization(buf, NULL);
4214           FREE_C_HEAP_ARRAY(char, buf);
4215         }
4216       }
4217     }
4218     agent-&gt;set_os_lib(library);
4219     agent-&gt;set_valid();
4220   }
4221 
4222   // Find the OnLoad function.
4223   on_load_entry =
4224     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
4225                                                           false,
4226                                                           on_load_symbols,
4227                                                           num_symbol_entries));
4228   return on_load_entry;
4229 }
4230 
4231 // Find the JVM_OnLoad entry point
4232 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
4233   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
4234   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4235 }
4236 
4237 // Find the Agent_OnLoad entry point
4238 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
4239   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
4240   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4241 }
4242 
4243 // For backwards compatibility with -Xrun
4244 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
4245 // treated like -agentpath:
4246 // Must be called before agent libraries are created
4247 void Threads::convert_vm_init_libraries_to_agents() {
4248   AgentLibrary* agent;
4249   AgentLibrary* next;
4250 
4251   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
4252     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
4253     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4254 
4255     // If there is an JVM_OnLoad function it will get called later,
4256     // otherwise see if there is an Agent_OnLoad
4257     if (on_load_entry == NULL) {
4258       on_load_entry = lookup_agent_on_load(agent);
4259       if (on_load_entry != NULL) {
4260         // switch it to the agent list -- so that Agent_OnLoad will be called,
4261         // JVM_OnLoad won&#39;t be attempted and Agent_OnUnload will
4262         Arguments::convert_library_to_agent(agent);
4263       } else {
4264         vm_exit_during_initialization(&quot;Could not find JVM_OnLoad or Agent_OnLoad function in the library&quot;, agent-&gt;name());
4265       }
4266     }
4267   }
4268 }
4269 
4270 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
4271 // Invokes Agent_OnLoad
4272 // Called very early -- before JavaThreads exist
4273 void Threads::create_vm_init_agents() {
4274   extern struct JavaVM_ main_vm;
4275   AgentLibrary* agent;
4276 
4277   JvmtiExport::enter_onload_phase();
4278 
4279   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4280     // CDS dumping does not support native JVMTI agent.
4281     // CDS dumping supports Java agent if the AllowArchivingWithJavaAgent diagnostic option is specified.
4282     if (Arguments::is_dumping_archive()) {
4283       if(!agent-&gt;is_instrument_lib()) {
4284         vm_exit_during_cds_dumping(&quot;CDS dumping does not support native JVMTI agent, name&quot;, agent-&gt;name());
4285       } else if (!AllowArchivingWithJavaAgent) {
4286         vm_exit_during_cds_dumping(
4287           &quot;Must enable AllowArchivingWithJavaAgent in order to run Java agent during CDS dumping&quot;);
4288       }
4289     }
4290 
4291     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
4292 
4293     if (on_load_entry != NULL) {
4294       // Invoke the Agent_OnLoad function
4295       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4296       if (err != JNI_OK) {
4297         vm_exit_during_initialization(&quot;agent library failed to init&quot;, agent-&gt;name());
4298       }
4299     } else {
4300       vm_exit_during_initialization(&quot;Could not find Agent_OnLoad function in the agent library&quot;, agent-&gt;name());
4301     }
4302   }
4303 
4304   JvmtiExport::enter_primordial_phase();
4305 }
4306 
4307 extern &quot;C&quot; {
4308   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
4309 }
4310 
4311 void Threads::shutdown_vm_agents() {
4312   // Send any Agent_OnUnload notifications
4313   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
4314   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
4315   extern struct JavaVM_ main_vm;
4316   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4317 
4318     // Find the Agent_OnUnload function.
4319     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
4320                                                    os::find_agent_function(agent,
4321                                                    false,
4322                                                    on_unload_symbols,
4323                                                    num_symbol_entries));
4324 
4325     // Invoke the Agent_OnUnload function
4326     if (unload_entry != NULL) {
4327       JavaThread* thread = JavaThread::current();
4328       ThreadToNativeFromVM ttn(thread);
4329       HandleMark hm(thread);
4330       (*unload_entry)(&amp;main_vm);
4331     }
4332   }
4333 }
4334 
4335 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4336 // Invokes JVM_OnLoad
4337 void Threads::create_vm_init_libraries() {
4338   extern struct JavaVM_ main_vm;
4339   AgentLibrary* agent;
4340 
4341   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4342     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4343 
4344     if (on_load_entry != NULL) {
4345       // Invoke the JVM_OnLoad function
4346       JavaThread* thread = JavaThread::current();
4347       ThreadToNativeFromVM ttn(thread);
4348       HandleMark hm(thread);
4349       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4350       if (err != JNI_OK) {
4351         vm_exit_during_initialization(&quot;-Xrun library failed to init&quot;, agent-&gt;name());
4352       }
4353     } else {
4354       vm_exit_during_initialization(&quot;Could not find JVM_OnLoad function in -Xrun library&quot;, agent-&gt;name());
4355     }
4356   }
4357 }
4358 
4359 
4360 // Last thread running calls java.lang.Shutdown.shutdown()
4361 void JavaThread::invoke_shutdown_hooks() {
4362   HandleMark hm(this);
4363 
4364   // Link all classes for dynamic CDS dumping before vm exit.
4365   // Same operation is being done in JVM_BeforeHalt for handling the
4366   // case where the application calls System.exit().
4367   if (DynamicDumpSharedSpaces) {
4368     MetaspaceShared::link_and_cleanup_shared_classes(this);
4369   }
4370 
4371   // We could get here with a pending exception, if so clear it now.
4372   if (this-&gt;has_pending_exception()) {
4373     this-&gt;clear_pending_exception();
4374   }
4375 
4376   EXCEPTION_MARK;
4377   Klass* shutdown_klass =
4378     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4379                                       THREAD);
4380   if (shutdown_klass != NULL) {
4381     // SystemDictionary::resolve_or_null will return null if there was
4382     // an exception.  If we cannot load the Shutdown class, just don&#39;t
4383     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4384     // won&#39;t be run.  Note that if a shutdown hook was registered,
4385     // the Shutdown class would have already been loaded
4386     // (Runtime.addShutdownHook will load it).
4387     JavaValue result(T_VOID);
4388     JavaCalls::call_static(&amp;result,
4389                            shutdown_klass,
4390                            vmSymbols::shutdown_name(),
4391                            vmSymbols::void_method_signature(),
4392                            THREAD);
4393   }
4394   CLEAR_PENDING_EXCEPTION;
4395 }
4396 
4397 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4398 // the program falls off the end of main(). Another VM exit path is through
4399 // vm_exit() when the program calls System.exit() to return a value or when
4400 // there is a serious error in VM. The two shutdown paths are not exactly
4401 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4402 // and VM_Exit op at VM level.
4403 //
4404 // Shutdown sequence:
4405 //   + Shutdown native memory tracking if it is on
4406 //   + Wait until we are the last non-daemon thread to execute
4407 //     &lt;-- every thing is still working at this moment --&gt;
4408 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4409 //        shutdown hooks
4410 //   + Call before_exit(), prepare for VM exit
4411 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4412 //        currently the only user of this mechanism is File.deleteOnExit())
4413 //      &gt; stop StatSampler, watcher thread,
4414 //        post thread end and vm death events to JVMTI,
4415 //        stop signal thread
4416 //   + Call JavaThread::exit(), it will:
4417 //      &gt; release JNI handle blocks, remove stack guard pages
4418 //      &gt; remove this thread from Threads list
4419 //     &lt;-- no more Java code from this thread after this point --&gt;
4420 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4421 //     the compiler threads at safepoint
4422 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4423 //   + Disable tracing at JNI/JVM barriers
4424 //   + Set _vm_exited flag for threads that are still running native code
4425 //   + Call exit_globals()
4426 //      &gt; deletes tty
4427 //      &gt; deletes PerfMemory resources
4428 //   + Delete this thread
4429 //   + Return to caller
4430 
4431 bool Threads::destroy_vm() {
4432   JavaThread* thread = JavaThread::current();
4433 
4434 #ifdef ASSERT
4435   _vm_complete = false;
4436 #endif
4437   // Wait until we are the last non-daemon thread to execute
4438   { MonitorLocker nu(Threads_lock);
4439     while (Threads::number_of_non_daemon_threads() &gt; 1)
4440       // This wait should make safepoint checks, wait without a timeout,
4441       // and wait as a suspend-equivalent condition.
4442       nu.wait(0, Mutex::_as_suspend_equivalent_flag);
4443   }
4444 
4445   EventShutdown e;
4446   if (e.should_commit()) {
4447     e.set_reason(&quot;No remaining non-daemon Java threads&quot;);
4448     e.commit();
4449   }
4450 
4451   // Hang forever on exit if we are reporting an error.
4452   if (ShowMessageBoxOnError &amp;&amp; VMError::is_error_reported()) {
4453     os::infinite_sleep();
4454   }
4455   os::wait_for_keypress_at_exit();
4456 
4457   // run Java level shutdown hooks
4458   thread-&gt;invoke_shutdown_hooks();
4459 
4460   before_exit(thread);
4461 
4462   thread-&gt;exit(true);
4463 
4464   // We are no longer on the main thread list but could still be in a
4465   // secondary list where another thread may try to interact with us.
4466   // So wait until all such interactions are complete before we bring
4467   // the VM to the termination safepoint. Normally this would be done
4468   // using thread-&gt;smr_delete() below where we delete the thread, but
4469   // we can&#39;t call that after the termination safepoint is active as
4470   // we will deadlock on the Threads_lock. Once all interactions are
4471   // complete it is safe to directly delete the thread at any time.
4472   ThreadsSMRSupport::wait_until_not_protected(thread);
4473 
4474   // Stop VM thread.
4475   {
4476     // 4945125 The vm thread comes to a safepoint during exit.
4477     // GC vm_operations can get caught at the safepoint, and the
4478     // heap is unparseable if they are caught. Grab the Heap_lock
4479     // to prevent this. The GC vm_operations will not be able to
4480     // queue until after the vm thread is dead. After this point,
4481     // we&#39;ll never emerge out of the safepoint before the VM exits.
4482 
4483     MutexLocker ml(Heap_lock, Mutex::_no_safepoint_check_flag);
4484 
4485     VMThread::wait_for_vm_thread_exit();
4486     assert(SafepointSynchronize::is_at_safepoint(), &quot;VM thread should exit at Safepoint&quot;);
4487     VMThread::destroy();
4488   }
4489 
4490   // Now, all Java threads are gone except daemon threads. Daemon threads
4491   // running Java code or in VM are stopped by the Safepoint. However,
4492   // daemon threads executing native code are still running.  But they
4493   // will be stopped at native=&gt;Java/VM barriers. Note that we can&#39;t
4494   // simply kill or suspend them, as it is inherently deadlock-prone.
4495 
4496   VM_Exit::set_vm_exited();
4497 
4498   // Clean up ideal graph printers after the VMThread has started
4499   // the final safepoint which will block all the Compiler threads.
4500   // Note that this Thread has already logically exited so the
4501   // clean_up() function&#39;s use of a JavaThreadIteratorWithHandle
4502   // would be a problem except set_vm_exited() has remembered the
4503   // shutdown thread which is granted a policy exception.
4504 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4505   IdealGraphPrinter::clean_up();
4506 #endif
4507 
4508   notify_vm_shutdown();
4509 
4510   // exit_globals() will delete tty
4511   exit_globals();
4512 
4513   // Deleting the shutdown thread here is safe. See comment on
4514   // wait_until_not_protected() above.
4515   delete thread;
4516 
4517 #if INCLUDE_JVMCI
4518   if (JVMCICounterSize &gt; 0) {
4519     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4520   }
4521 #endif
4522 
4523   LogConfiguration::finalize();
4524 
4525   return true;
4526 }
4527 
4528 
4529 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4530   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4531   return is_supported_jni_version(version);
4532 }
4533 
4534 
4535 jboolean Threads::is_supported_jni_version(jint version) {
4536   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4537   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4538   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4539   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4540   if (version == JNI_VERSION_9) return JNI_TRUE;
4541   if (version == JNI_VERSION_10) return JNI_TRUE;
4542   return JNI_FALSE;
4543 }
4544 
4545 
4546 void Threads::add(JavaThread* p, bool force_daemon) {
4547   // The threads lock must be owned at this point
4548   assert(Threads_lock-&gt;owned_by_self(), &quot;must have threads lock&quot;);
4549 
4550   BarrierSet::barrier_set()-&gt;on_thread_attach(p);
4551 
4552   // Once a JavaThread is added to the Threads list, smr_delete() has
4553   // to be used to delete it. Otherwise we can just delete it directly.
4554   p-&gt;set_on_thread_list();
4555 
4556   _number_of_threads++;
4557   oop threadObj = p-&gt;threadObj();
4558   bool daemon = true;
4559   // Bootstrapping problem: threadObj can be null for initial
4560   // JavaThread (or for threads attached via JNI)
4561   if ((!force_daemon) &amp;&amp; !is_daemon((threadObj))) {
4562     _number_of_non_daemon_threads++;
4563     daemon = false;
4564   }
4565 
4566   ThreadService::add_thread(p, daemon);
4567 
4568   // Maintain fast thread list
4569   ThreadsSMRSupport::add_thread(p);
4570 
4571   // Possible GC point.
4572   Events::log(p, &quot;Thread added: &quot; INTPTR_FORMAT, p2i(p));
4573 }
4574 
4575 void Threads::remove(JavaThread* p, bool is_daemon) {
4576 
4577   // Reclaim the ObjectMonitors from the om_in_use_list and om_free_list of the moribund thread.
4578   ObjectSynchronizer::om_flush(p);
4579 
4580   // Extra scope needed for Thread_lock, so we can check
4581   // that we do not remove thread without safepoint code notice
4582   { MonitorLocker ml(Threads_lock);
4583 
4584     assert(ThreadsSMRSupport::get_java_thread_list()-&gt;includes(p), &quot;p must be present&quot;);
4585 
4586     // Maintain fast thread list
4587     ThreadsSMRSupport::remove_thread(p);
4588 
4589     _number_of_threads--;
4590     if (!is_daemon) {
4591       _number_of_non_daemon_threads--;
4592 
4593       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4594       // on destroy_vm will wake up.
4595       if (number_of_non_daemon_threads() == 1) {
4596         ml.notify_all();
4597       }
4598     }
4599     ThreadService::remove_thread(p, is_daemon);
4600 
4601     // Make sure that safepoint code disregard this thread. This is needed since
4602     // the thread might mess around with locks after this point. This can cause it
4603     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4604     // of this thread since it is removed from the queue.
4605     p-&gt;set_terminated_value();
4606   } // unlock Threads_lock
4607 
4608   // Since Events::log uses a lock, we grab it outside the Threads_lock
4609   Events::log(p, &quot;Thread exited: &quot; INTPTR_FORMAT, p2i(p));
4610 }
4611 
4612 // Operations on the Threads list for GC.  These are not explicitly locked,
4613 // but the garbage collector must provide a safe context for them to run.
4614 // In particular, these things should never be called when the Threads_lock
4615 // is held by some other thread. (Note: the Safepoint abstraction also
4616 // uses the Threads_lock to guarantee this property. It also makes sure that
4617 // all threads gets blocked when exiting or starting).
4618 
4619 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4620   ALL_JAVA_THREADS(p) {
4621     p-&gt;oops_do(f, cf);
4622   }
4623   VMThread::vm_thread()-&gt;oops_do(f, cf);
4624 }
4625 
4626 void Threads::change_thread_claim_token() {
4627   if (++_thread_claim_token == 0) {
4628     // On overflow of the token counter, there is a risk of future
4629     // collisions between a new global token value and a stale token
4630     // for a thread, because not all iterations visit all threads.
4631     // (Though it&#39;s pretty much a theoretical concern for non-trivial
4632     // token counter sizes.)  To deal with the possibility, reset all
4633     // the thread tokens to zero on global token overflow.
4634     struct ResetClaims : public ThreadClosure {
4635       virtual void do_thread(Thread* t) {
4636         t-&gt;claim_threads_do(false, 0);
4637       }
4638     } reset_claims;
4639     Threads::threads_do(&amp;reset_claims);
4640     // On overflow, update the global token to non-zero, to
4641     // avoid the special &quot;never claimed&quot; initial thread value.
4642     _thread_claim_token = 1;
4643   }
4644 }
4645 
4646 #ifdef ASSERT
4647 void assert_thread_claimed(const char* kind, Thread* t, uintx expected) {
4648   const uintx token = t-&gt;threads_do_token();
4649   assert(token == expected,
4650          &quot;%s &quot; PTR_FORMAT &quot; has incorrect value &quot; UINTX_FORMAT &quot; != &quot;
4651          UINTX_FORMAT, kind, p2i(t), token, expected);
4652 }
4653 
4654 void Threads::assert_all_threads_claimed() {
4655   ALL_JAVA_THREADS(p) {
4656     assert_thread_claimed(&quot;Thread&quot;, p, _thread_claim_token);
4657   }
4658   assert_thread_claimed(&quot;VMThread&quot;, VMThread::vm_thread(), _thread_claim_token);
4659 }
4660 #endif // ASSERT
4661 
4662 class ParallelOopsDoThreadClosure : public ThreadClosure {
4663 private:
4664   OopClosure* _f;
4665   CodeBlobClosure* _cf;
4666 public:
4667   ParallelOopsDoThreadClosure(OopClosure* f, CodeBlobClosure* cf) : _f(f), _cf(cf) {}
4668   void do_thread(Thread* t) {
4669     t-&gt;oops_do(_f, _cf);
4670   }
4671 };
4672 
4673 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4674   ParallelOopsDoThreadClosure tc(f, cf);
4675   possibly_parallel_threads_do(is_par, &amp;tc);
4676 }
4677 
4678 void Threads::nmethods_do(CodeBlobClosure* cf) {
4679   ALL_JAVA_THREADS(p) {
4680     // This is used by the code cache sweeper to mark nmethods that are active
4681     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4682     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4683     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4684       p-&gt;nmethods_do(cf);
4685     }
4686   }
4687 }
4688 
4689 void Threads::metadata_do(MetadataClosure* f) {
4690   ALL_JAVA_THREADS(p) {
4691     p-&gt;metadata_do(f);
4692   }
4693 }
4694 
4695 class ThreadHandlesClosure : public ThreadClosure {
4696   void (*_f)(Metadata*);
4697  public:
4698   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4699   virtual void do_thread(Thread* thread) {
4700     thread-&gt;metadata_handles_do(_f);
4701   }
4702 };
4703 
4704 void Threads::metadata_handles_do(void f(Metadata*)) {
4705   // Only walk the Handles in Thread.
4706   ThreadHandlesClosure handles_closure(f);
4707   threads_do(&amp;handles_closure);
4708 }
4709 
4710 // Get count Java threads that are waiting to enter the specified monitor.
4711 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(ThreadsList * t_list,
4712                                                          int count,
4713                                                          address monitor) {
4714   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4715 
4716   int i = 0;
4717   DO_JAVA_THREADS(t_list, p) {
4718     if (!p-&gt;can_call_java()) continue;
4719 
4720     // The first stage of async deflation does not affect any field
4721     // used by this comparison so the ObjectMonitor* is usable here.
4722     address pending = (address)p-&gt;current_pending_monitor();
4723     if (pending == monitor) {             // found a match
4724       if (i &lt; count) result-&gt;append(p);   // save the first count matches
4725       i++;
4726     }
4727   }
4728 
4729   return result;
4730 }
4731 
4732 
4733 JavaThread *Threads::owning_thread_from_monitor_owner(ThreadsList * t_list,
4734                                                       address owner) {
4735   // NULL owner means not locked so we can skip the search
4736   if (owner == NULL) return NULL;
4737 
4738   DO_JAVA_THREADS(t_list, p) {
4739     // first, see if owner is the address of a Java thread
4740     if (owner == (address)p) return p;
4741   }
4742 
4743   // Cannot assert on lack of success here since this function may be
4744   // used by code that is trying to report useful problem information
4745   // like deadlock detection.
4746   if (UseHeavyMonitors) return NULL;
4747 
4748   // If we didn&#39;t find a matching Java thread and we didn&#39;t force use of
4749   // heavyweight monitors, then the owner is the stack address of the
4750   // Lock Word in the owning Java thread&#39;s stack.
4751   //
4752   JavaThread* the_owner = NULL;
4753   DO_JAVA_THREADS(t_list, q) {
4754     if (q-&gt;is_lock_owned(owner)) {
4755       the_owner = q;
4756       break;
4757     }
4758   }
4759 
4760   // cannot assert on lack of success here; see above comment
4761   return the_owner;
4762 }
4763 
4764 class PrintOnClosure : public ThreadClosure {
4765 private:
4766   outputStream* _st;
4767 
4768 public:
4769   PrintOnClosure(outputStream* st) :
4770       _st(st) {}
4771 
4772   virtual void do_thread(Thread* thread) {
4773     if (thread != NULL) {
4774       thread-&gt;print_on(_st);
4775       _st-&gt;cr();
4776     }
4777   }
4778 };
4779 
4780 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4781 void Threads::print_on(outputStream* st, bool print_stacks,
4782                        bool internal_format, bool print_concurrent_locks,
4783                        bool print_extended_info) {
4784   char buf[32];
4785   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4786 
4787   st-&gt;print_cr(&quot;Full thread dump %s (%s %s):&quot;,
4788                VM_Version::vm_name(),
4789                VM_Version::vm_release(),
4790                VM_Version::vm_info_string());
4791   st-&gt;cr();
4792 
4793 #if INCLUDE_SERVICES
4794   // Dump concurrent locks
4795   ConcurrentLocksDump concurrent_locks;
4796   if (print_concurrent_locks) {
4797     concurrent_locks.dump_at_safepoint();
4798   }
4799 #endif // INCLUDE_SERVICES
4800 
4801   ThreadsSMRSupport::print_info_on(st);
4802   st-&gt;cr();
4803 
4804   ALL_JAVA_THREADS(p) {
4805     ResourceMark rm;
4806     p-&gt;print_on(st, print_extended_info);
4807     if (print_stacks) {
4808       if (internal_format) {
4809         p-&gt;trace_stack();
4810       } else {
4811         p-&gt;print_stack_on(st);
4812       }
4813     }
4814     st-&gt;cr();
4815 #if INCLUDE_SERVICES
4816     if (print_concurrent_locks) {
4817       concurrent_locks.print_locks_on(p, st);
4818     }
4819 #endif // INCLUDE_SERVICES
4820   }
4821 
4822   PrintOnClosure cl(st);
4823   cl.do_thread(VMThread::vm_thread());
4824   Universe::heap()-&gt;gc_threads_do(&amp;cl);
4825   cl.do_thread(WatcherThread::watcher_thread());
4826 
4827   st-&gt;flush();
4828 }
4829 
4830 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4831                              int buflen, bool* found_current) {
4832   if (this_thread != NULL) {
4833     bool is_current = (current == this_thread);
4834     *found_current = *found_current || is_current;
4835     st-&gt;print(&quot;%s&quot;, is_current ? &quot;=&gt;&quot; : &quot;  &quot;);
4836 
4837     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4838     st-&gt;print(&quot; &quot;);
4839     this_thread-&gt;print_on_error(st, buf, buflen);
4840     st-&gt;cr();
4841   }
4842 }
4843 
4844 class PrintOnErrorClosure : public ThreadClosure {
4845   outputStream* _st;
4846   Thread* _current;
4847   char* _buf;
4848   int _buflen;
4849   bool* _found_current;
4850  public:
4851   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4852                       int buflen, bool* found_current) :
4853    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4854 
4855   virtual void do_thread(Thread* thread) {
4856     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4857   }
4858 };
4859 
4860 // Threads::print_on_error() is called by fatal error handler. It&#39;s possible
4861 // that VM is not at safepoint and/or current thread is inside signal handler.
4862 // Don&#39;t print stack trace, as the stack may not be walkable. Don&#39;t allocate
4863 // memory (even in resource area), it might deadlock the error handler.
4864 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4865                              int buflen) {
4866   ThreadsSMRSupport::print_info_on(st);
4867   st-&gt;cr();
4868 
4869   bool found_current = false;
4870   st-&gt;print_cr(&quot;Java Threads: ( =&gt; current thread )&quot;);
4871   ALL_JAVA_THREADS(thread) {
4872     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4873   }
4874   st-&gt;cr();
4875 
4876   st-&gt;print_cr(&quot;Other Threads:&quot;);
4877   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4878   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4879 
4880   if (Universe::heap() != NULL) {
4881     PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4882     Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4883   }
4884 
4885   if (!found_current) {
4886     st-&gt;cr();
4887     st-&gt;print(&quot;=&gt;&quot; PTR_FORMAT &quot; (exited) &quot;, p2i(current));
4888     current-&gt;print_on_error(st, buf, buflen);
4889     st-&gt;cr();
4890   }
4891   st-&gt;cr();
4892 
4893   st-&gt;print_cr(&quot;Threads with active compile tasks:&quot;);
4894   print_threads_compiling(st, buf, buflen);
4895 }
4896 
4897 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen, bool short_form) {
4898   ALL_JAVA_THREADS(thread) {
4899     if (thread-&gt;is_Compiler_thread()) {
4900       CompilerThread* ct = (CompilerThread*) thread;
4901 
4902       // Keep task in local variable for NULL check.
4903       // ct-&gt;_task might be set to NULL by concurring compiler thread
4904       // because it completed the compilation. The task is never freed,
4905       // though, just returned to a free list.
4906       CompileTask* task = ct-&gt;task();
4907       if (task != NULL) {
4908         thread-&gt;print_name_on_error(st, buf, buflen);
4909         st-&gt;print(&quot;  &quot;);
4910         task-&gt;print(st, NULL, short_form, true);
4911       }
4912     }
4913   }
4914 }
4915 
4916 
4917 // Internal SpinLock and Mutex
4918 // Based on ParkEvent
4919 
4920 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4921 //
4922 // We employ SpinLocks _only for low-contention, fixed-length
4923 // short-duration critical sections where we&#39;re concerned
4924 // about native mutex_t or HotSpot Mutex:: latency.
4925 // The mux construct provides a spin-then-block mutual exclusion
4926 // mechanism.
4927 //
4928 // Testing has shown that contention on the ListLock guarding gFreeList
4929 // is common.  If we implement ListLock as a simple SpinLock it&#39;s common
4930 // for the JVM to devolve to yielding with little progress.  This is true
4931 // despite the fact that the critical sections protected by ListLock are
4932 // extremely short.
4933 //
4934 // TODO-FIXME: ListLock should be of type SpinLock.
4935 // We should make this a 1st-class type, integrated into the lock
4936 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4937 // should have sufficient padding to avoid false-sharing and excessive
4938 // cache-coherency traffic.
4939 
4940 
4941 typedef volatile int SpinLockT;
4942 
4943 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4944   if (Atomic::cmpxchg(adr, 0, 1) == 0) {
4945     return;   // normal fast-path return
4946   }
4947 
4948   // Slow-path : We&#39;ve encountered contention -- Spin/Yield/Block strategy.
4949   int ctr = 0;
4950   int Yields = 0;
4951   for (;;) {
4952     while (*adr != 0) {
4953       ++ctr;
4954       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4955         if (Yields &gt; 5) {
4956           os::naked_short_sleep(1);
4957         } else {
4958           os::naked_yield();
4959           ++Yields;
4960         }
4961       } else {
4962         SpinPause();
4963       }
4964     }
4965     if (Atomic::cmpxchg(adr, 0, 1) == 0) return;
4966   }
4967 }
4968 
4969 void Thread::SpinRelease(volatile int * adr) {
4970   assert(*adr != 0, &quot;invariant&quot;);
4971   OrderAccess::fence();      // guarantee at least release consistency.
4972   // Roach-motel semantics.
4973   // It&#39;s safe if subsequent LDs and STs float &quot;up&quot; into the critical section,
4974   // but prior LDs and STs within the critical section can&#39;t be allowed
4975   // to reorder or float past the ST that releases the lock.
4976   // Loads and stores in the critical section - which appear in program
4977   // order before the store that releases the lock - must also appear
4978   // before the store that releases the lock in memory visibility order.
4979   // Conceptually we need a #loadstore|#storestore &quot;release&quot; MEMBAR before
4980   // the ST of 0 into the lock-word which releases the lock, so fence
4981   // more than covers this on all platforms.
4982   *adr = 0;
4983 }
4984 
4985 // muxAcquire and muxRelease:
4986 //
4987 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4988 //    The LSB of the word is set IFF the lock is held.
4989 //    The remainder of the word points to the head of a singly-linked list
4990 //    of threads blocked on the lock.
4991 //
4992 // *  The current implementation of muxAcquire-muxRelease uses its own
4993 //    dedicated Thread._MuxEvent instance.  If we&#39;re interested in
4994 //    minimizing the peak number of extant ParkEvent instances then
4995 //    we could eliminate _MuxEvent and &quot;borrow&quot; _ParkEvent as long
4996 //    as certain invariants were satisfied.  Specifically, care would need
4997 //    to be taken with regards to consuming unpark() &quot;permits&quot;.
4998 //    A safe rule of thumb is that a thread would never call muxAcquire()
4999 //    if it&#39;s enqueued (cxq, EntryList, WaitList, etc) and will subsequently
5000 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
5001 //    consume an unpark() permit intended for monitorenter, for instance.
5002 //    One way around this would be to widen the restricted-range semaphore
5003 //    implemented in park().  Another alternative would be to provide
5004 //    multiple instances of the PlatformEvent() for each thread.  One
5005 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
5006 //
5007 // *  Usage:
5008 //    -- Only as leaf locks
5009 //    -- for short-term locking only as muxAcquire does not perform
5010 //       thread state transitions.
5011 //
5012 // Alternatives:
5013 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
5014 //    but with parking or spin-then-park instead of pure spinning.
5015 // *  Use Taura-Oyama-Yonenzawa locks.
5016 // *  It&#39;s possible to construct a 1-0 lock if we encode the lockword as
5017 //    (List,LockByte).  Acquire will CAS the full lockword while Release
5018 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
5019 //    acquiring threads use timers (ParkTimed) to detect and recover from
5020 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
5021 //    boundaries by using placement-new.
5022 // *  Augment MCS with advisory back-link fields maintained with CAS().
5023 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
5024 //    The validity of the backlinks must be ratified before we trust the value.
5025 //    If the backlinks are invalid the exiting thread must back-track through the
5026 //    the forward links, which are always trustworthy.
5027 // *  Add a successor indication.  The LockWord is currently encoded as
5028 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
5029 //    to provide the usual futile-wakeup optimization.
5030 //    See RTStt for details.
5031 //
5032 
5033 
5034 const intptr_t LOCKBIT = 1;
5035 
5036 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
5037   intptr_t w = Atomic::cmpxchg(Lock, (intptr_t)0, LOCKBIT);
5038   if (w == 0) return;
5039   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(Lock, w, w|LOCKBIT) == w) {
5040     return;
5041   }
5042 
5043   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
5044   assert((intptr_t(Self) &amp; LOCKBIT) == 0, &quot;invariant&quot;);
5045   for (;;) {
5046     int its = (os::is_MP() ? 100 : 0) + 1;
5047 
5048     // Optional spin phase: spin-then-park strategy
5049     while (--its &gt;= 0) {
5050       w = *Lock;
5051       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(Lock, w, w|LOCKBIT) == w) {
5052         return;
5053       }
5054     }
5055 
5056     Self-&gt;reset();
5057     Self-&gt;OnList = intptr_t(Lock);
5058     // The following fence() isn&#39;t _strictly necessary as the subsequent
5059     // CAS() both serializes execution and ratifies the fetched *Lock value.
5060     OrderAccess::fence();
5061     for (;;) {
5062       w = *Lock;
5063       if ((w &amp; LOCKBIT) == 0) {
5064         if (Atomic::cmpxchg(Lock, w, w|LOCKBIT) == w) {
5065           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
5066           return;
5067         }
5068         continue;      // Interference -- *Lock changed -- Just retry
5069       }
5070       assert(w &amp; LOCKBIT, &quot;invariant&quot;);
5071       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
5072       if (Atomic::cmpxchg(Lock, w, intptr_t(Self)|LOCKBIT) == w) break;
5073     }
5074 
5075     while (Self-&gt;OnList != 0) {
5076       Self-&gt;park();
5077     }
5078   }
5079 }
5080 
5081 // Release() must extract a successor from the list and then wake that thread.
5082 // It can &quot;pop&quot; the front of the list or use a detach-modify-reattach (DMR) scheme
5083 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
5084 // Release() would :
5085 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
5086 // (B) Extract a successor from the private list &quot;in-hand&quot;
5087 // (C) attempt to CAS() the residual back into *Lock over null.
5088 //     If there were any newly arrived threads and the CAS() would fail.
5089 //     In that case Release() would detach the RATs, re-merge the list in-hand
5090 //     with the RATs and repeat as needed.  Alternately, Release() might
5091 //     detach and extract a successor, but then pass the residual list to the wakee.
5092 //     The wakee would be responsible for reattaching and remerging before it
5093 //     competed for the lock.
5094 //
5095 // Both &quot;pop&quot; and DMR are immune from ABA corruption -- there can be
5096 // multiple concurrent pushers, but only one popper or detacher.
5097 // This implementation pops from the head of the list.  This is unfair,
5098 // but tends to provide excellent throughput as hot threads remain hot.
5099 // (We wake recently run threads first).
5100 //
5101 // All paths through muxRelease() will execute a CAS.
5102 // Release consistency -- We depend on the CAS in muxRelease() to provide full
5103 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
5104 // executed within the critical section are complete and globally visible before the
5105 // store (CAS) to the lock-word that releases the lock becomes globally visible.
5106 void Thread::muxRelease(volatile intptr_t * Lock)  {
5107   for (;;) {
5108     const intptr_t w = Atomic::cmpxchg(Lock, LOCKBIT, (intptr_t)0);
5109     assert(w &amp; LOCKBIT, &quot;invariant&quot;);
5110     if (w == LOCKBIT) return;
5111     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
5112     assert(List != NULL, &quot;invariant&quot;);
5113     assert(List-&gt;OnList == intptr_t(Lock), &quot;invariant&quot;);
5114     ParkEvent * const nxt = List-&gt;ListNext;
5115     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, &quot;invariant&quot;);
5116 
5117     // The following CAS() releases the lock and pops the head element.
5118     // The CAS() also ratifies the previously fetched lock-word value.
5119     if (Atomic::cmpxchg(Lock, w, intptr_t(nxt)) != w) {
5120       continue;
5121     }
5122     List-&gt;OnList = 0;
5123     OrderAccess::fence();
5124     List-&gt;unpark();
5125     return;
5126   }
5127 }
5128 
5129 
5130 void Threads::verify() {
5131   ALL_JAVA_THREADS(p) {
5132     p-&gt;verify();
5133   }
5134   VMThread* thread = VMThread::vm_thread();
5135   if (thread != NULL) thread-&gt;verify();
5136 }
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>