<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames test/langtools/tools/javac/api/TestGetScopeResult.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 /*
 25  * @test
<a name="1" id="anc1"></a><span class="line-modified"> 26  * @bug 8205418 8207229 8207230 8230847 8245786 8247334 8248641</span>
 27  * @summary Test the outcomes from Trees.getScope
 28  * @modules jdk.compiler/com.sun.tools.javac.api
 29  *          jdk.compiler/com.sun.tools.javac.comp
 30  *          jdk.compiler/com.sun.tools.javac.tree
 31  *          jdk.compiler/com.sun.tools.javac.util
 32  */
 33 
 34 import java.io.IOException;
 35 import java.net.URI;
 36 import java.util.ArrayList;
<a name="2" id="anc2"></a><span class="line-added"> 37 import java.util.Collections;</span>
 38 import java.util.List;
 39 
 40 import javax.lang.model.element.Element;
 41 import javax.tools.JavaCompiler;
 42 import javax.tools.SimpleJavaFileObject;
 43 import javax.tools.StandardJavaFileManager;
 44 import javax.tools.ToolProvider;
 45 
 46 import com.sun.source.tree.AnnotationTree;
 47 import com.sun.source.tree.BlockTree;
 48 import com.sun.source.tree.ClassTree;
 49 import com.sun.source.tree.CompilationUnitTree;
 50 import com.sun.source.tree.ConditionalExpressionTree;
 51 import com.sun.source.tree.IdentifierTree;
 52 import com.sun.source.tree.LambdaExpressionTree;
 53 import com.sun.source.tree.MethodInvocationTree;
 54 import com.sun.source.tree.MethodTree;
 55 import com.sun.source.tree.Scope;
 56 import com.sun.source.tree.Tree;
 57 import com.sun.source.tree.VariableTree;
 58 import com.sun.source.util.JavacTask;
 59 import com.sun.source.util.TaskEvent;
 60 import com.sun.source.util.TaskListener;
 61 import com.sun.source.util.TreePath;
 62 import com.sun.source.util.TreePathScanner;
 63 import com.sun.source.util.Trees;
<a name="3" id="anc3"></a><span class="line-added"> 64 import com.sun.tools.javac.api.JavacScope;</span>
 65 
 66 import com.sun.tools.javac.api.JavacTool;
 67 import com.sun.tools.javac.comp.Analyzer;
 68 import com.sun.tools.javac.comp.AttrContext;
 69 import com.sun.tools.javac.comp.Env;
<a name="4" id="anc4"></a><span class="line-added"> 70 import com.sun.tools.javac.tree.JCTree;</span>
<span class="line-added"> 71 import com.sun.tools.javac.tree.JCTree.JCCase;</span>
 72 import com.sun.tools.javac.tree.JCTree.JCStatement;
 73 import com.sun.tools.javac.util.Context;
 74 import com.sun.tools.javac.util.Context.Factory;
 75 
 76 import static javax.tools.JavaFileObject.Kind.SOURCE;
 77 
 78 public class TestGetScopeResult {
 79     public static void main(String... args) throws IOException {
 80         new TestGetScopeResult().run();
 81         new TestGetScopeResult().testAnalyzerDisabled();
 82         new TestGetScopeResult().testVariablesInSwitch();
 83         new TestGetScopeResult().testMemberRefs();
 84         new TestGetScopeResult().testAnnotations();
 85         new TestGetScopeResult().testAnnotationsLazy();
 86         new TestGetScopeResult().testCircular();
 87         new TestGetScopeResult().testRecord();
 88         new TestGetScopeResult().testLocalRecordAnnotation();
<a name="5" id="anc5"></a><span class="line-added"> 89         new TestGetScopeResult().testRuleCases();</span>
 90     }
 91 
 92     public void run() throws IOException {
 93         String[] simpleLambda = {
 94             &quot;s:java.lang.String&quot;,
 95             &quot;i:Test.I&quot;,
 96             &quot;super:java.lang.Object&quot;,
 97             &quot;this:Test&quot;
 98         };
 99         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public void test(String s); } }&quot;,
100                simpleLambda);
101         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public int test(String s); } }&quot;,
102                simpleLambda);
103         doTest(&quot;class Test { void test() { I i = s -&gt; { }; } interface I { public String test(String s); } }&quot;,
104                simpleLambda);
105         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public void test(String s); } }&quot;,
106                simpleLambda);
107         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public int test(String s); } }&quot;,
108                simpleLambda);
109         doTest(&quot;class Test { void test() { I i; inv(s -&gt; { }); } void inv(I i) { } interface I { public String test(String s); } }&quot;,
110                simpleLambda);
111         String[] dualLambda = {
112             &quot;s:java.lang.String&quot;,
113             &quot;i:Test.I1&quot;,
114             &quot;super:java.lang.Object&quot;,
115             &quot;this:Test&quot;,
116             &quot;s:java.lang.CharSequence&quot;,
117             &quot;i:Test.I1&quot;,
118             &quot;super:java.lang.Object&quot;,
119             &quot;this:Test&quot;
120         };
121         doTest(&quot;class Test { void test() { I1 i; inv(s -&gt; { }, s -&gt; { }); } void inv(I1 i, I2 i) { } interface I1 { public String test(String s); } interface I2 { public void test(CharSequence s); } }&quot;,
122                dualLambda);
123         doTest(&quot;class Test { void test() { I1 i; inv(s -&gt; { }, s -&gt; { }); } void inv(I1 i, I2 i) { } interface I1 { public String test(String s); } interface I2 { public int test(CharSequence s); } }&quot;,
124                dualLambda);
125         String[] brokenType = {
126             &quot;s:&lt;any&gt;&quot;,
127             &quot;u:Undefined&quot;,
128             &quot;super:java.lang.Object&quot;,
129             &quot;this:Test&quot;
130         };
131         doTest(&quot;class Test { void test() { Undefined u = s -&gt; { }; } }&quot;,
132                brokenType);
133         String[] multipleCandidates1 = {
134             &quot;s:&lt;any&gt;&quot;,
135             &quot;super:java.lang.Object&quot;,
136             &quot;this:Test&quot;
137         };
138         doTest(&quot;class Test { void test() { cand1(s -&gt; { }); } void cand1(I1 i) { } void cand1(I2 i) { } interface I1 { public String test(String s); } interface I2 { public int test(CharSequence s); } }&quot;,
139                multipleCandidates1);
140         String[] multipleCandidates2 = {
141             &quot;s:java.lang.String&quot;,
142             &quot;super:java.lang.Object&quot;,
143             &quot;this:Test&quot;
144         };
145         doTest(&quot;class Test { void test() { cand1(s -&gt; { }); } void cand1(I1 i) { } void cand1(I2 i, int i) { } interface I1 { public String test(String s); } interface I2 { public int test(CharSequence s); } }&quot;,
146                multipleCandidates2);
147 
148         String[] implicitExplicitConflict1 = {
149             &quot;:t&quot;,
150             &quot;s:java.lang.String&quot;,
151             &quot;super:java.lang.Object&quot;,
152             &quot;this:Test&quot;
153         };
154 
155         doTest(&quot;class Test { void test() { cand((var s, t) -&gt; \&quot;\&quot;); } void cand(I i) { } interface I { public String test(String s); }  }&quot;,
156                implicitExplicitConflict1);
157 
158         String[] implicitExplicitConflict2 = {
159             &quot;s:none&quot;,
160             &quot;:t&quot;,
161             &quot;super:java.lang.Object&quot;,
162             &quot;this:Test&quot;
163         };
164 
165         doTest(&quot;class Test { void test() { cand((t, var s) -&gt; \&quot;\&quot;); } void cand(I i) { } interface I { public String test(String s); }  }&quot;,
166                implicitExplicitConflict2);
167 
168         String[] noFunctionInterface = {
169             &quot;s:none&quot;,
170             &quot;:t&quot;,
171             &quot;super:java.lang.Object&quot;,
172             &quot;this:Test&quot;
173         };
174 
175         doTest(&quot;class Test { void test() { cand((t, var s) -&gt; \&quot;\&quot;); } void cand(String s) { } }&quot;,
176                noFunctionInterface);
177 
178         String[] invocationInMethodInvocation = {
179             &quot;d2:java.lang.Double&quot;,
180             &quot;d1:java.lang.Double&quot;,
181             &quot;super:java.lang.Object&quot;,
182             &quot;this:Test&quot;
183         };
184 
185         doTest(&quot;&quot;&quot;
186                class Test {
187                    void test() { test(reduce(0.0, (d1, d2) -&gt; 0)); }
188                    void test(int i) {}
189                    &lt;T&gt; T reduce(T t, BiFunction&lt;T, T, T&gt; f1) {}
190                    static interface BiFunction&lt;R, P, Q&gt; {
191                        R apply(P p, Q q);
192                    }
193                }&quot;&quot;&quot;,
194                invocationInMethodInvocation);
195     }
196 
197     public void doTest(String code, String... expected) throws IOException {
198         JavaCompiler c = ToolProvider.getSystemJavaCompiler();
199         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
200             class MyFileObject extends SimpleJavaFileObject {
201                 MyFileObject() {
202                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
203                 }
204                 @Override
205                 public String getCharContent(boolean ignoreEncodingErrors) {
206                     return code;
207                 }
208             }
209             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null, List.of(new MyFileObject()));
210             CompilationUnitTree cut = t.parse().iterator().next();
211             t.analyze();
212 
213             List&lt;String&gt; actual = new ArrayList&lt;&gt;();
214 
215             new TreePathScanner&lt;Void, Void&gt;() {
216                 @Override
217                 public Void visitLambdaExpression(LambdaExpressionTree node, Void p) {
218                     Scope scope = Trees.instance(t).getScope(new TreePath(getCurrentPath(), node.getBody()));
219                     actual.addAll(dumpScope(scope));
220                     return super.visitLambdaExpression(node, p);
221                 }
222             }.scan(cut, null);
223 
224             List&lt;String&gt; expectedList = List.of(expected);
225 
226             if (!expectedList.equals(actual)) {
227                 throw new IllegalStateException(&quot;Unexpected scope content: &quot; + actual + &quot;\n&quot; +
228                                                  &quot;expected: &quot; + expectedList);
229             }
230         }
231     }
232 
233     void testAnalyzerDisabled() throws IOException {
234         JavacTool c = JavacTool.create();
235         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
236             class MyFileObject extends SimpleJavaFileObject {
237                 MyFileObject() {
238                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
239                 }
240                 @Override
241                 public String getCharContent(boolean ignoreEncodingErrors) {
242                     return &quot;class Test {&quot; +
243                            &quot;    void test() { cand(() -&gt; { System.err.println(); }); }&quot; +
244                            &quot;    Runnable r = new Runnable() { public void test() { System.err.println(); } };&quot; +
245                            &quot;    void cand(Runnable r) { }&quot; +
246                            &quot;}&quot;;
247                 }
248             }
249             Context ctx = new Context();
250             TestAnalyzer.preRegister(ctx);
251             JavacTask t = (JavacTask) c.getTask(null, fm, null, List.of(&quot;-XDfind=lambda&quot;), null,
252                                                 List.of(new MyFileObject()), ctx);
253             CompilationUnitTree cut = t.parse().iterator().next();
254             t.analyze();
255 
256             TestAnalyzer analyzer = (TestAnalyzer) TestAnalyzer.instance(ctx);
257 
258             if (!analyzer.analyzeCalled) {
259                 throw new IllegalStateException(&quot;Analyzer didn&#39;t run!&quot;);
260             }
261 
262             new TreePathScanner&lt;Void, Void&gt;() {
263                 @Override
264                 public Void visitLambdaExpression(LambdaExpressionTree node, Void p) {
265                     analyzer.analyzeCalled = false;
266                     Trees.instance(t).getScope(new TreePath(getCurrentPath(), node.getBody()));
267                     if (analyzer.analyzeCalled) {
268                         throw new IllegalStateException(&quot;Analyzer was run during getScope!&quot;);
269                     }
270                     return super.visitLambdaExpression(node, p);
271                 }
272 
273                 @Override
274                 public Void visitVariable(VariableTree node, Void p) {
275                     if (node.getInitializer() != null) {
276                         analyzer.analyzeCalled = false;
277                         TreePath tp = new TreePath(getCurrentPath(), node.getInitializer());
278                         Trees.instance(t).getScope(tp);
279                         if (analyzer.analyzeCalled) {
280                             throw new IllegalStateException(&quot;Analyzer was run during getScope!&quot;);
281                         }
282                     }
283                     return super.visitVariable(node, p);
284                 }
285             }.scan(cut, null);
286         }
287     }
288 
289     private static final class TestAnalyzer extends Analyzer {
290 
291         public static void preRegister(Context context) {
292             context.put(analyzerKey, (Factory&lt;Analyzer&gt;) ctx -&gt; new TestAnalyzer(ctx));
293         }
294 
295         private boolean analyzeCalled;
296 
297         public TestAnalyzer(Context context) {
298             super(context);
299         }
300 
301         @Override
302         protected void analyze(JCStatement statement, Env&lt;AttrContext&gt; env) {
303             analyzeCalled = true;
304             super.analyze(statement, env);
305         }
306     }
307 
308     void testVariablesInSwitch() throws IOException {
309         JavacTool c = JavacTool.create();
310         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
311             class MyFileObject extends SimpleJavaFileObject {
312                 MyFileObject() {
313                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
314                 }
315                 @Override
316                 public String getCharContent(boolean ignoreEncodingErrors) {
317                     return &quot;class Test {&quot; +
318                            &quot;    void test() {\n&quot; +
319                            &quot;        E e = E.A;\n&quot; +
320                            &quot;        Object o = E.A;\n&quot; +
321                            &quot;        switch (e) {\n&quot; +
322                            &quot;            case A:\n&quot; +
323                            &quot;                return;\n&quot; +
324                            &quot;            case B:\n&quot; +
325                            &quot;                test();\n&quot; +
326                            &quot;                E ee = null;\n&quot; +
327                            &quot;                break;\n&quot; +
328                            &quot;        }\n&quot; +
329                            &quot;    }\n&quot; +
330                            &quot;    enum E {A, B}\n&quot; +
331                            &quot;}&quot;;
332                 }
333             }
334             Context ctx = new Context();
335             TestAnalyzer.preRegister(ctx);
336             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,
337                                                 List.of(new MyFileObject()), ctx);
338             CompilationUnitTree cut = t.parse().iterator().next();
339             t.analyze();
340 
341             new TreePathScanner&lt;Void, Void&gt;() {
342                 @Override
343                 public Void visitMethodInvocation(MethodInvocationTree node, Void p) {
344                     Trees.instance(t).getScope(getCurrentPath());
345                     return super.visitMethodInvocation(node, p);
346                 }
347             }.scan(cut, null);
348         }
349     }
350 
351     void testMemberRefs() throws IOException {
352         JavacTool c = JavacTool.create();
353         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
354             class MyFileObject extends SimpleJavaFileObject {
355                 MyFileObject() {
356                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
357                 }
358                 @Override
359                 public String getCharContent(boolean ignoreEncodingErrors) {
360                     return &quot;class Test {&quot; +
361                            &quot;    void test() {\n&quot; +
362                            &quot;        Test t = this;\n&quot; +
363                            &quot;        Runnable r1 = t::test;\n&quot; +
364                            &quot;        Runnable r2 = true ? t::test : t::test;\n&quot; +
365                            &quot;        c(t::test);\n&quot; +
366                            &quot;        c(true ? t::test : t::test);\n&quot; +
367                            &quot;    }\n&quot; +
368                            &quot;    void c(Runnable r) {}\n&quot; +
369                            &quot;}&quot;;
370                 }
371             }
372             Context ctx = new Context();
373             TestAnalyzer.preRegister(ctx);
374             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,
375                                                 List.of(new MyFileObject()), ctx);
376             CompilationUnitTree cut = t.parse().iterator().next();
377             t.analyze();
378 
379             new TreePathScanner&lt;Void, Void&gt;() {
380                 @Override
381                 public Void visitConditionalExpression(ConditionalExpressionTree node, Void p) {
382                     Trees.instance(t).getScope(new TreePath(getCurrentPath(), node.getCondition()));
383                     return super.visitConditionalExpression(node, p);
384                 }
385 
386                 @Override
387                 public Void visitBlock(BlockTree node, Void p) {
388                     Trees.instance(t).getScope(getCurrentPath());
389                     return super.visitBlock(node, p);
390                 }
391             }.scan(cut, null);
392         }
393     }
394 
395     void testAnnotations() throws IOException {
396         JavacTool c = JavacTool.create();
397         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
398             class MyFileObject extends SimpleJavaFileObject {
399                 MyFileObject() {
400                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
401                 }
402                 @Override
403                 public String getCharContent(boolean ignoreEncodingErrors) {
404                     return &quot;class Test {&quot; +
405                            &quot;    void test() {\n&quot; +
406                            &quot;        new Object() {\n&quot; +
407                            &quot;            @A\n&quot; +
408                            &quot;            public String t() { return null; }\n&quot; +
409                            &quot;        };\n&quot; +
410                            &quot;    }\n&quot; +
411                            &quot;    @interface A {}\n&quot; +
412                            &quot;}&quot;;
413                 }
414             }
415             Context ctx = new Context();
416             TestAnalyzer.preRegister(ctx);
417             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,
418                                                 List.of(new MyFileObject()), ctx);
419             CompilationUnitTree cut = t.parse().iterator().next();
420             t.analyze();
421 
422             new TreePathScanner&lt;Void, Void&gt;() {
423                 @Override
424                 public Void visitIdentifier(IdentifierTree node, Void p) {
425                     if (node.getName().contentEquals(&quot;A&quot;)) {
426                         Trees.instance(t).getScope(getCurrentPath());
427                     }
428                     return super.visitIdentifier(node, p);
429                 }
430 
431                 @Override
432                 public Void visitMethod(MethodTree node, Void p) {
433                     super.visitMethod(node, p);
434                     if (node.getReturnType() != null) {
435                         Trees.instance(t).getScope(new TreePath(getCurrentPath(), node.getReturnType()));
436                     }
437                     return null;
438                 }
439             }.scan(cut, null);
440         }
441     }
442 
443     void testAnnotationsLazy() throws IOException {
444         JavacTool c = JavacTool.create();
445         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
446             class MyFileObject extends SimpleJavaFileObject {
447                 MyFileObject() {
448                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
449                 }
450                 @Override
451                 public String getCharContent(boolean ignoreEncodingErrors) {
452                     return &quot;import java.lang.annotation.*;\n&quot; +
453                            &quot;\n&quot; +
454                            &quot;class ClassA {\n&quot; +
455                            &quot;    Object o = ClassB.lcv;\n&quot; +
456                            &quot;}\n&quot; +
457                            &quot;\n&quot; +
458                            &quot;class ClassB {\n&quot; +
459                            &quot;    static final String[] lcv = new @TA String[0];\n&quot; +
460                            &quot;}\n&quot; +
461                            &quot;\n&quot; +
462                            &quot;class ClassC {\n&quot; +
463                            &quot;    static final Object o = (@TA Object) null;\n&quot; +
464                            &quot;}\n&quot; +
465                            &quot;\n&quot; +
466                            &quot;@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})\n&quot; +
467                            &quot;@interface TA {}\n&quot;;
468                 }
469             }
470             Context ctx = new Context();
471             TestAnalyzer.preRegister(ctx);
472             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,
473                                                 List.of(new MyFileObject()), ctx);
474             t.addTaskListener(new TaskListener() {
475                 @Override
476                 public void finished(TaskEvent e) {
477                     if (e.getKind() == TaskEvent.Kind.ANALYZE) {
478                         new TreePathScanner&lt;Void, Void&gt;() {
479                             @Override
480                             public Void scan(Tree tree, Void p) {
481                                 if (tree != null) {
482                                     Trees.instance(t).getScope(new TreePath(getCurrentPath(), tree));
483                                 }
484                                 return super.scan(tree, p);
485                             }
486                         }.scan(Trees.instance(t).getPath(e.getTypeElement()), null);
487                     }
488                 }
489             });
490 
491             t.call();
492         }
493     }
494 
495     void testCircular() throws IOException {
496         JavacTool c = JavacTool.create();
497         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
498             class MyFileObject extends SimpleJavaFileObject {
499                 MyFileObject() {
500                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
501                 }
502                 @Override
503                 public String getCharContent(boolean ignoreEncodingErrors) {
504                     return &quot;class Test extends Test {&quot; +
505                            &quot;    {\n&quot; +
506                            &quot;        int i;\n&quot; +
507                            &quot;    }\n&quot; +
508                            &quot;}&quot;;
509                 }
510             }
511             Context ctx = new Context();
512             TestAnalyzer.preRegister(ctx);
513             JavacTask t = (JavacTask) c.getTask(null, fm, null, null, null,
514                                                 List.of(new MyFileObject()), ctx);
515             CompilationUnitTree cut = t.parse().iterator().next();
516             t.analyze();
517 
518             new TreePathScanner&lt;Void, Void&gt;() {
519                 @Override
520                 public Void visitBlock(BlockTree node, Void p) {
521                     Trees.instance(t).getScope(getCurrentPath());
522                     return super.visitBlock(node, p);
523                 }
524             }.scan(cut, null);
525         }
526     }
527 
528     void testRecord() throws IOException {
529         JavacTool c = JavacTool.create();
530         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
531             class MyFileObject extends SimpleJavaFileObject {
532                 MyFileObject() {
533                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
534                 }
535                 @Override
536                 public String getCharContent(boolean ignoreEncodingErrors) {
537                     return &quot;record Test&lt;T&gt;(int mark) {}&quot;;
538                 }
539             }
540             Context ctx = new Context();
541             TestAnalyzer.preRegister(ctx);
542             List&lt;String&gt; options = List.of(&quot;--enable-preview&quot;,
543                                            &quot;-source&quot;, System.getProperty(&quot;java.specification.version&quot;));
544             JavacTask t = (JavacTask) c.getTask(null, fm, null, options, null,
545                                                 List.of(new MyFileObject()), ctx);
546             CompilationUnitTree cut = t.parse().iterator().next();
547             t.analyze();
548 
549             List&lt;String&gt; actual = new ArrayList&lt;&gt;();
550 
551             new TreePathScanner&lt;Void, Void&gt;() {
552                 @Override
553                 public Void visitClass(ClassTree node, Void p) {
554                     Scope scope = Trees.instance(t).getScope(getCurrentPath());
555                     actual.addAll(dumpScope(scope));
556                     return super.visitClass(node, p);
557                 }
558             }.scan(cut, null);
559 
560             List&lt;String&gt; expected = List.of(
561                     &quot;super:java.lang.Record&quot;,
562                     &quot;this:Test&lt;T&gt;&quot;,
563                     &quot;T:T&quot;
564             );
565 
566             if (!expected.equals(actual)) {
567                 throw new AssertionError(&quot;Unexpected Scope content: &quot; + actual);
568             }
569         }
570     }
571 
572     void testLocalRecordAnnotation() throws IOException {
573         JavacTool c = JavacTool.create();
574         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {
575             class Variant {
576                 final String code;
577                 final List&lt;List&lt;String&gt;&gt; expectedScopeContent;
578                 public Variant(String code, List&lt;List&lt;String&gt;&gt; expectedScopeContent) {
579                     this.code = code;
580                     this.expectedScopeContent = expectedScopeContent;
581                 }
582             }
583             Variant[] variants = new Variant[] {
584                 new Variant(&quot;&quot;&quot;
585                             class Test {
586                                 void t() {
587                                     record R(@Annotation int i) {
588                                         void stop () {}
589                                     }
590                                 }
591                             }
592                             @interface Annotation {}
593                             &quot;&quot;&quot;,
594                             List.of(
595                                 List.of(&quot;super:java.lang.Object&quot;, &quot;this:Test&quot;),
596                                 List.of(&quot;super:java.lang.Object&quot;, &quot;this:Test&quot;)
597                             )),
598                 new Variant(&quot;&quot;&quot;
599                             record Test(@Annotation int i) {}
600                             @interface Annotation {}
601                             &quot;&quot;&quot;,
602                             List.of(
603                                 List.of(&quot;i:int&quot;, &quot;super:java.lang.Record&quot;, &quot;this:Test&quot;),
604                                 List.of(&quot;super:java.lang.Record&quot;, &quot;this:Test&quot;)
605                             ))
606             };
607             for (Variant currentVariant : variants) {
608                 class MyFileObject extends SimpleJavaFileObject {
609                     MyFileObject() {
610                         super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);
611                     }
612                     @Override
613                     public String getCharContent(boolean ignoreEncodingErrors) {
614                         return currentVariant.code;
615                     }
616                 }
617                 Context ctx = new Context();
618                 TestAnalyzer.preRegister(ctx);
619                 List&lt;String&gt; options = List.of(&quot;--enable-preview&quot;,
620                                                &quot;-source&quot;, System.getProperty(&quot;java.specification.version&quot;));
621                 JavacTask t = (JavacTask) c.getTask(null, fm, null, options, null,
622                                                     List.of(new MyFileObject()), ctx);
623                 CompilationUnitTree cut = t.parse().iterator().next();
624                 t.analyze();
625 
626                 List&lt;List&lt;String&gt;&gt; actual = new ArrayList&lt;&gt;();
627 
628                 new TreePathScanner&lt;Void, Void&gt;() {
629                     @Override
630                     public Void visitAnnotation(AnnotationTree node, Void p) {
631                         Scope scope = Trees.instance(t).getScope(getCurrentPath());
632                         actual.add(dumpScope(scope));
633                         return super.visitAnnotation(node, p);
634                     }
635                 }.scan(cut, null);
636 
637                 if (!currentVariant.expectedScopeContent.equals(actual)) {
638                     throw new AssertionError(&quot;Unexpected Scope content: &quot; + actual);
639                 }
640             }
641         }
642     }
643 
<a name="6" id="anc6"></a><span class="line-added">644     void testRuleCases() throws IOException {</span>
<span class="line-added">645         JavacTool c = JavacTool.create();</span>
<span class="line-added">646         try (StandardJavaFileManager fm = c.getStandardFileManager(null, null, null)) {</span>
<span class="line-added">647             String code = &quot;&quot;&quot;</span>
<span class="line-added">648                           class Test {</span>
<span class="line-added">649                               void t(int i) {</span>
<span class="line-added">650                                   long local;</span>
<span class="line-added">651                                   System.err.println(switch (i) {</span>
<span class="line-added">652                                     case 0 -&gt; {</span>
<span class="line-added">653                                         String var;</span>
<span class="line-added">654                                         int scopeHere;</span>
<span class="line-added">655                                         yield &quot;&quot;;</span>
<span class="line-added">656                                     }</span>
<span class="line-added">657                                     default -&gt; {</span>
<span class="line-added">658                                         String var;</span>
<span class="line-added">659                                         int scopeHere;</span>
<span class="line-added">660                                         yield &quot;&quot;;</span>
<span class="line-added">661                                     }</span>
<span class="line-added">662                                   });</span>
<span class="line-added">663                                   switch (i) {</span>
<span class="line-added">664                                     case 0 -&gt; {</span>
<span class="line-added">665                                         String var;</span>
<span class="line-added">666                                         int scopeHere;</span>
<span class="line-added">667                                     }</span>
<span class="line-added">668                                     default -&gt; {</span>
<span class="line-added">669                                         String var;</span>
<span class="line-added">670                                         int scopeHere;</span>
<span class="line-added">671                                     }</span>
<span class="line-added">672                                   };</span>
<span class="line-added">673                                   switch (i) {</span>
<span class="line-added">674                                     case 0: {</span>
<span class="line-added">675                                         int checkTree;</span>
<span class="line-added">676                                     }</span>
<span class="line-added">677                                   }</span>
<span class="line-added">678                               }</span>
<span class="line-added">679                           }</span>
<span class="line-added">680                           &quot;&quot;&quot;;</span>
<span class="line-added">681             class MyFileObject extends SimpleJavaFileObject {</span>
<span class="line-added">682                 MyFileObject() {</span>
<span class="line-added">683                     super(URI.create(&quot;myfo:///Test.java&quot;), SOURCE);</span>
<span class="line-added">684                 }</span>
<span class="line-added">685                 @Override</span>
<span class="line-added">686                 public String getCharContent(boolean ignoreEncodingErrors) {</span>
<span class="line-added">687                     return code;</span>
<span class="line-added">688                 }</span>
<span class="line-added">689             }</span>
<span class="line-added">690             Context ctx = new Context();</span>
<span class="line-added">691             TestAnalyzer.preRegister(ctx);</span>
<span class="line-added">692             List&lt;String&gt; options = List.of(&quot;--enable-preview&quot;,</span>
<span class="line-added">693                                            &quot;-source&quot;, System.getProperty(&quot;java.specification.version&quot;));</span>
<span class="line-added">694             JavacTask t = (JavacTask) c.getTask(null, fm, null, options, null,</span>
<span class="line-added">695                                                 List.of(new MyFileObject()), ctx);</span>
<span class="line-added">696             CompilationUnitTree cut = t.parse().iterator().next();</span>
<span class="line-added">697             t.analyze();</span>
<span class="line-added">698 </span>
<span class="line-added">699             List&lt;List&lt;String&gt;&gt; actual = new ArrayList&lt;&gt;();</span>
<span class="line-added">700 </span>
<span class="line-added">701             new TreePathScanner&lt;Void, Void&gt;() {</span>
<span class="line-added">702                 @Override</span>
<span class="line-added">703                 public Void visitVariable(VariableTree node, Void p) {</span>
<span class="line-added">704                     if (node.getName().contentEquals(&quot;scopeHere&quot;)) {</span>
<span class="line-added">705                         Scope scope = Trees.instance(t).getScope(getCurrentPath());</span>
<span class="line-added">706                         actual.add(dumpScope(scope));</span>
<span class="line-added">707                         JCTree body = getCaseBody(scope);</span>
<span class="line-added">708                         if (body == null) {</span>
<span class="line-added">709                             throw new AssertionError(&quot;Unexpected null body.&quot;);</span>
<span class="line-added">710                         }</span>
<span class="line-added">711                     } else if (node.getName().contentEquals(&quot;checkTree&quot;)) {</span>
<span class="line-added">712                         Scope scope = Trees.instance(t).getScope(getCurrentPath());</span>
<span class="line-added">713                         JCTree body = getCaseBody(scope);</span>
<span class="line-added">714                         if (body != null) {</span>
<span class="line-added">715                             throw new AssertionError(&quot;Unexpected body tree: &quot; + body);</span>
<span class="line-added">716                         }</span>
<span class="line-added">717                     }</span>
<span class="line-added">718                     return super.visitVariable(node, p);</span>
<span class="line-added">719                 }</span>
<span class="line-added">720                 JCTree getCaseBody(Scope scope) {</span>
<span class="line-added">721                     return ((JCCase) ((JavacScope) scope).getEnv().next.next.tree).body;</span>
<span class="line-added">722                 }</span>
<span class="line-added">723             }.scan(cut, null);</span>
<span class="line-added">724 </span>
<span class="line-added">725             List&lt;List&lt;String&gt;&gt; expected =</span>
<span class="line-added">726                     Collections.nCopies(4,</span>
<span class="line-added">727                                         List.of(&quot;scopeHere:int&quot;,</span>
<span class="line-added">728                                                 &quot;var:java.lang.String&quot;,</span>
<span class="line-added">729                                                 &quot;local:long&quot;,</span>
<span class="line-added">730                                                 &quot;i:int&quot;,</span>
<span class="line-added">731                                                 &quot;super:java.lang.Object&quot;,</span>
<span class="line-added">732                                                 &quot;this:Test&quot;</span>
<span class="line-added">733                                             ));</span>
<span class="line-added">734 </span>
<span class="line-added">735             if (!expected.equals(actual)) {</span>
<span class="line-added">736                 throw new AssertionError(&quot;Unexpected Scope content: &quot; + actual);</span>
<span class="line-added">737             }</span>
<span class="line-added">738         }</span>
<span class="line-added">739     }</span>
<span class="line-added">740 </span>
741     private List&lt;String&gt; dumpScope(Scope scope) {
742         List&lt;String&gt; content = new ArrayList&lt;&gt;();
743         while (scope.getEnclosingClass() != null) {
744             for (Element el : scope.getLocalElements()) {
745                 content.add(el.getSimpleName() + &quot;:&quot; +el.asType().toString());
746             }
747             scope = scope.getEnclosingScope();
748         }
749         return content;
750     }
751 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>