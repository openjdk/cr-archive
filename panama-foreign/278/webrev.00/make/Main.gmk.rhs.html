<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/Main.gmk</title>
    <link rel="stylesheet" href="../style.css" />
    <script type="text/javascript" src="../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 #
   2 # Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.
   3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4 #
   5 # This code is free software; you can redistribute it and/or modify it
   6 # under the terms of the GNU General Public License version 2 only, as
   7 # published by the Free Software Foundation.  Oracle designates this
   8 # particular file as subject to the &quot;Classpath&quot; exception as provided
   9 # by Oracle in the LICENSE file that accompanied this code.
  10 #
  11 # This code is distributed in the hope that it will be useful, but WITHOUT
  12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14 # version 2 for more details (a copy is included in the LICENSE file that
  15 # accompanied this code).
  16 #
  17 # You should have received a copy of the GNU General Public License version
  18 # 2 along with this work; if not, write to the Free Software Foundation,
  19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20 #
  21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22 # or visit www.oracle.com if you need additional information or have any
  23 # questions.
  24 #
  25 
  26 ################################################################################
  27 # This is the main makefile containing most actual top level targets. It needs
  28 # to be called with a SPEC file defined.
  29 ################################################################################
  30 
  31 # Declare default target
  32 default:
  33 
  34 ifeq ($(wildcard $(SPEC)),)
  35   $(error Main.gmk needs SPEC set to a proper spec.gmk)
  36 endif
  37 
  38 # Now load the spec
  39 include $(SPEC)
  40 
  41 # Load the vital tools for all the makefiles.
  42 include $(TOPDIR)/make/common/MakeBase.gmk
  43 include $(TOPDIR)/make/common/Modules.gmk
  44 include $(TOPDIR)/make/common/FindTests.gmk
  45 
  46 include $(TOPDIR)/make/MainSupport.gmk
  47 
  48 # Are we requested to ignore dependencies?
  49 ifneq ($(findstring -only, $(MAKECMDGOALS)), )
  50   DEPS := none
  51 endif
  52 
  53 # Declare ALL_TARGETS as an immediate variable. This variable is a list of all
  54 # valid top level targets. It&#39;s used to declare them all as PHONY and to
  55 # generate the -only targets.
  56 ALL_TARGETS :=
  57 
  58 # Hook to include the corresponding custom file, if present.
  59 $(eval $(call IncludeCustomExtension, Main.gmk))
  60 
  61 # All modules for the current target platform.
  62 ALL_MODULES := $(call FindAllModules)
  63 
  64 ################################################################################
  65 ################################################################################
  66 #
  67 # Recipes for all targets. Only recipes, dependencies are declared later.
  68 #
  69 ################################################################################
  70 
  71 ################################################################################
  72 # Interim/build tools targets, compiling tools used during the build
  73 
  74 $(eval $(call SetupTarget, buildtools-langtools, \
  75     MAKEFILE := ToolsLangtools, \
  76 ))
  77 
  78 $(eval $(call SetupTarget, interim-langtools, \
  79     MAKEFILE := CompileInterimLangtools, \
  80 ))
  81 
  82 $(eval $(call SetupTarget, interim-tzdb, \
  83     MAKEFILE := CopyInterimTZDB, \
  84 ))
  85 
  86 $(eval $(call SetupTarget, buildtools-jdk, \
  87     MAKEFILE := CompileToolsJdk, \
  88     DEPS := interim-langtools interim-tzdb, \
  89 ))
  90 
  91 $(eval $(call SetupTarget, buildtools-modules, \
  92     MAKEFILE := CompileModuleTools, \
  93     DEPS := exploded-image-base, \
  94 ))
  95 
  96 $(eval $(call SetupTarget, buildtools-hotspot, \
  97     MAKEFILE := CompileToolsHotspot, \
  98     DEPS := interim-langtools, \
  99 ))
 100 
 101 ################################################################################
 102 # Special targets for certain modules
 103 
 104 $(eval $(call SetupTarget, generate-exported-symbols, \
 105     MAKEFILE := BuildStatic, \
 106     DEPS := java.base-libs jdk.jdwp.agent-libs, \
 107 ))
 108 
 109 ################################################################################
 110 # Gensrc targets, generating source before java compilation can be done
 111 #
 112 $(eval $(call DeclareRecipesForPhase, GENSRC, \
 113     TARGET_SUFFIX := gensrc-src, \
 114     FILE_PREFIX := Gensrc, \
 115     MAKE_SUBDIR := gensrc, \
 116     CHECK_MODULES := $(ALL_MODULES), \
 117 ))
 118 
 119 $(foreach m, $(GENSRC_MODULES), $(eval $m-gensrc: $m-gensrc-src))
 120 
 121 LANGTOOLS_GENSRC_TARGETS := $(filter $(addsuffix -%, $(LANGTOOLS_MODULES)), $(GENSRC_TARGETS))
 122 INTERIM_LANGTOOLS_GENSRC_TARGETS := $(filter $(addsuffix -%, \
 123     $(INTERIM_LANGTOOLS_BASE_MODULES)), $(GENSRC_TARGETS))
 124 HOTSPOT_GENSRC_TARGETS := $(filter $(addsuffix -%, $(HOTSPOT_MODULES)), $(GENSRC_TARGETS))
 125 JDK_GENSRC_TARGETS := $(filter-out $(LANGTOOLS_GENSRC_TARGETS) \
 126     $(HOTSPOT_GENSRC_TARGETS), $(GENSRC_TARGETS))
 127 
 128 GENSRC_MODULEINFO_MODULES := $(ALL_MODULES)
 129 GENSRC_MODULEINFO_TARGETS := $(addsuffix -gensrc-moduleinfo, \
 130     $(GENSRC_MODULEINFO_MODULES))
 131 
 132 GENSRC_MODULES := $(GENSRC_MODULEINFO_MODULES)
 133 GENSRC_TARGETS += $(sort $(GENSRC_MODULEINFO_TARGETS) \
 134     $(addsuffix -gensrc, $(GENSRC_MODULES)))
 135 
 136 define DeclareModuleInfoRecipe
 137   $1-gensrc-moduleinfo:
 138 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 139 	    -f common/modules/GensrcModuleInfo.gmk MODULE=$1)
 140 
 141   $1-gensrc: $1-gensrc-moduleinfo
 142 endef
 143 
 144 $(foreach m, $(GENSRC_MODULEINFO_MODULES), $(eval $(call DeclareModuleInfoRecipe,$m)))
 145 
 146 ALL_TARGETS += $(GENSRC_TARGETS)
 147 
 148 ################################################################################
 149 # Generate data targets
 150 $(eval $(call DeclareRecipesForPhase, GENDATA, \
 151     TARGET_SUFFIX := gendata, \
 152     FILE_PREFIX := Gendata, \
 153     MAKE_SUBDIR := gendata, \
 154     CHECK_MODULES := $(ALL_MODULES), \
 155 ))
 156 
 157 ALL_TARGETS += $(GENDATA_TARGETS)
 158 
 159 ################################################################################
 160 # Copy files targets
 161 $(eval $(call DeclareRecipesForPhase, COPY, \
 162     TARGET_SUFFIX := copy, \
 163     FILE_PREFIX := Copy, \
 164     MAKE_SUBDIR := copy, \
 165     CHECK_MODULES := $(ALL_MODULES), \
 166 ))
 167 
 168 ALL_COPY_MODULES += $(COPY_MODULES)
 169 ALL_COPY_TARGETS += $(COPY_TARGETS)
 170 
 171 IMPORT_COPY_MODULES := $(call FindImportedModules)
 172 IMPORT_COPY_TARGETS := $(addsuffix -copy, $(IMPORT_COPY_MODULES))
 173 ALL_COPY_MODULES += $(IMPORT_COPY_MODULES)
 174 ALL_COPY_TARGETS += $(IMPORT_COPY_TARGETS)
 175 
 176 define DeclareImportCopyRecipe
 177   $1-copy:
 178 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 179 	    -f CopyImportModules.gmk MODULE=$1)
 180 endef
 181 
 182 $(foreach m, $(IMPORT_COPY_MODULES), $(eval $(call DeclareImportCopyRecipe,$m)))
 183 
 184 ALL_TARGETS += $(ALL_COPY_TARGETS)
 185 
 186 ################################################################################
 187 # Targets for compiling all java modules.
 188 JAVA_MODULES := $(ALL_MODULES)
 189 JAVA_TARGETS := $(addsuffix -java, $(JAVA_MODULES))
 190 
 191 define DeclareCompileJavaRecipe
 192   $1-java:
 193 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) \
 194 	    -f CompileJavaModules.gmk MODULE=$1)
 195 endef
 196 
 197 $(foreach m, $(JAVA_MODULES), $(eval $(call DeclareCompileJavaRecipe,$m)))
 198 
 199 ALL_TARGETS += $(JAVA_TARGETS)
 200 
 201 ################################################################################
 202 # Targets for compiling native libraries
 203 $(eval $(call DeclareRecipesForPhase, LIBS, \
 204     TARGET_SUFFIX := libs, \
 205     FILE_PREFIX := Lib, \
 206     MAKE_SUBDIR := lib, \
 207     CHECK_MODULES := $(ALL_MODULES), \
 208 ))
 209 
 210 ALL_TARGETS += $(LIBS_TARGETS)
 211 
 212 ################################################################################
 213 # Targets for compiling static versions of certain native libraries. These do
 214 # not end up in the jmods or the normal JDK image, but are instead bundled into
 215 # a special deliverable.
 216 $(eval $(call DeclareRecipesForPhase, STATIC_LIBS, \
 217     TARGET_SUFFIX := static-libs, \
 218     FILE_PREFIX := Lib, \
 219     MAKE_SUBDIR := lib, \
 220     CHECK_MODULES := $(ALL_MODULES), \
 221     EXTRA_ARGS := STATIC_LIBS=true, \
 222 ))
 223 
 224 ALL_TARGETS += $(STATIC_LIBS_TARGETS)
 225 
 226 ################################################################################
 227 # Targets for compiling native executables
 228 $(eval $(call DeclareRecipesForPhase, LAUNCHER, \
 229     TARGET_SUFFIX := launchers, \
 230     FILE_PREFIX := Launcher, \
 231     MAKE_SUBDIR := launcher, \
 232     CHECK_MODULES := $(ALL_MODULES), \
 233 ))
 234 
 235 ALL_TARGETS += $(LAUNCHER_TARGETS)
 236 
 237 ################################################################################
 238 # Build hotspot target
 239 
 240 HOTSPOT_VARIANT_TARGETS := $(addprefix hotspot-, $(JVM_VARIANTS))
 241 HOTSPOT_VARIANT_GENSRC_TARGETS := $(addsuffix -gensrc, $(HOTSPOT_VARIANT_TARGETS))
 242 HOTSPOT_VARIANT_LIBS_TARGETS := $(addsuffix -libs, $(HOTSPOT_VARIANT_TARGETS))
 243 
 244 define DeclareHotspotGensrcRecipe
 245   hotspot-$1-gensrc:
 246 	$$(call LogInfo, Building JVM variant &#39;$1&#39; with features &#39;$(JVM_FEATURES_$1)&#39;)
 247 	+($(CD) $(TOPDIR)/make/hotspot &amp;&amp; $(MAKE) $(MAKE_ARGS) -f gensrc/GenerateSources.gmk \
 248 	    JVM_VARIANT=$1)
 249 endef
 250 
 251 $(foreach v, $(JVM_VARIANTS), $(eval $(call DeclareHotspotGensrcRecipe,$v)))
 252 
 253 define DeclareHotspotLibsRecipe
 254   hotspot-$1-libs:
 255 	+($(CD) $(TOPDIR)/make/hotspot &amp;&amp; $(MAKE) $(MAKE_ARGS) -f lib/CompileLibraries.gmk \
 256 	    JVM_VARIANT=$1)
 257 endef
 258 
 259 $(foreach v, $(JVM_VARIANTS), $(eval $(call DeclareHotspotLibsRecipe,$v)))
 260 
 261 $(eval $(call SetupTarget, hotspot-ide-project, \
 262     MAKEFILE := ide/visualstudio/hotspot/CreateVSProject, \
 263     DEPS := hotspot exploded-image, \
 264     ARGS := -I$(TOPDIR)/make/hotspot, \
 265 ))
 266 
 267 ALL_TARGETS += $(HOTSPOT_VARIANT_TARGETS) $(HOTSPOT_VARIANT_GENSRC_TARGETS) \
 268     $(HOTSPOT_VARIANT_LIBS_TARGETS)
 269 
 270 ################################################################################
 271 # Generate libs and launcher targets for creating compile_commands.json fragments
 272 define DeclareCompileCommandsRecipe
 273   $1-compile-commands:
 274 	$$(call LogInfo, Generating compile_commands.json fragments for $1)
 275 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f Main.gmk $1-only \
 276 	    GENERATE_COMPILE_COMMANDS_ONLY=true)
 277 
 278   COMPILE_COMMANDS_TARGETS_$2 += $1-compile-commands
 279 endef
 280 
 281 $(foreach t, $(HOTSPOT_VARIANT_LIBS_TARGETS), \
 282   $(eval $(call DeclareCompileCommandsRecipe,$t,HOTSPOT)) \
 283 )
 284 
 285 $(foreach t, $(LIBS_TARGETS) $(LAUNCHER_TARGETS), \
 286   $(eval $(call DeclareCompileCommandsRecipe,$t,JDK)) \
 287 )
 288 
 289 $(eval $(call SetupTarget, compile-commands, \
 290     MAKEFILE := CompileCommands, \
 291 ))
 292 
 293 $(eval $(call SetupTarget, compile-commands-hotspot, \
 294     MAKEFILE := CompileCommands, \
 295 ))
 296 
 297 ALL_TARGETS += $(COMPILE_COMMANDS_TARGETS_HOTSPOT) $(COMPILE_COMMANDS_TARGETS_JDK)
 298 
 299 ################################################################################
 300 # VS Code projects
 301 
 302 $(eval $(call SetupTarget, vscode-project, \
 303     MAKEFILE := ide/vscode/hotspot/CreateVSCodeProject, \
 304     ARGS := VSCODE_INDEXER=cpptools, \
 305     DEPS := compile-commands, \
 306 ))
 307 
 308 $(eval $(call SetupTarget, vscode-project-clangd, \
 309     MAKEFILE := ide/vscode/hotspot/CreateVSCodeProject, \
 310     ARGS := VSCODE_INDEXER=clangd, \
 311     DEPS := compile-commands, \
 312 ))
 313 
 314 $(eval $(call SetupTarget, vscode-project-rtags, \
 315     MAKEFILE := ide/vscode/hotspot/CreateVSCodeProject, \
 316     ARGS := VSCODE_INDEXER=rtags, \
 317     DEPS := compile-commands, \
 318 ))
 319 
 320 $(eval $(call SetupTarget, vscode-project-ccls, \
 321     MAKEFILE := ide/vscode/hotspot/CreateVSCodeProject, \
 322     ARGS := VSCODE_INDEXER=ccls, \
 323     DEPS := compile-commands, \
 324 ))
 325 
 326 ################################################################################
 327 # Build demos targets
 328 
 329 # The demos are currently linking to libjvm and libjava, just like all other
 330 # jdk libs, even though they don&#39;t need to. To avoid warnings, make sure they
 331 # aren&#39;t built until after libjava and libjvm are available to link to.
 332 $(eval $(call SetupTarget, demos-jdk, \
 333     MAKEFILE := CompileDemos, \
 334     DEPS := java.base-libs exploded-image, \
 335 ))
 336 
 337 $(eval $(call SetupTarget, test-image-demos-jdk, \
 338     MAKEFILE := CompileDemos, \
 339     TARGET := images, \
 340     DEPS := demos-jdk, \
 341 ))
 342 
 343 ################################################################################
 344 # Jigsaw specific data and analysis targets.
 345 
 346 $(eval $(call SetupTarget, generate-summary, \
 347     MAKEFILE := GenerateModuleSummary, \
 348     DEPS := jmods buildtools-modules, \
 349 ))
 350 
 351 ################################################################################
 352 # Jmod targets
 353 
 354 JMOD_MODULES := $(ALL_MODULES)
 355 JMOD_TARGETS := $(addsuffix -jmod, $(JMOD_MODULES))
 356 
 357 define DeclareJmodRecipe
 358   $1-jmod:
 359 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f CreateJmods.gmk \
 360 	    MODULE=$1)
 361 endef
 362 
 363 $(foreach m, $(JMOD_MODULES), $(eval $(call DeclareJmodRecipe,$m)))
 364 
 365 ALL_TARGETS += $(JMOD_TARGETS)
 366 
 367 ################################################################################
 368 # Images targets
 369 
 370 $(eval $(call SetupTarget, store-source-revision, \
 371     MAKEFILE := SourceRevision, \
 372     TARGET := store-source-revision, \
 373 ))
 374 
 375 $(eval $(call SetupTarget, create-source-revision-tracker, \
 376     MAKEFILE := SourceRevision, \
 377     TARGET := create-source-revision-tracker, \
 378 ))
 379 
 380 BOOTCYCLE_TARGET := product-images
 381 bootcycle-images:
 382         ifneq ($(COMPILE_TYPE), cross)
 383 	  $(call LogWarn, Boot cycle build step 2: Building a new JDK image using previously built image)
 384 	  $(call MakeDir, $(OUTPUTDIR)/bootcycle-build)
 385 	  +$(MAKE) $(MAKE_ARGS) -f $(TOPDIR)/make/Init.gmk PARALLEL_TARGETS=$(BOOTCYCLE_TARGET) \
 386 	      LOG_PREFIX=&quot;[bootcycle] &quot; JOBS= SPEC=$(dir $(SPEC))bootcycle-spec.gmk main
 387         else
 388 	  $(call LogWarn, Boot cycle build disabled when cross compiling)
 389         endif
 390 
 391 $(eval $(call SetupTarget, zip-security, \
 392     MAKEFILE := ZipSecurity, \
 393     DEPS := java.base-java java.security.jgss-java java.security.jgss-libs, \
 394 ))
 395 
 396 $(eval $(call SetupTarget, zip-source, \
 397     MAKEFILE := ZipSource, \
 398     DEPS := gensrc, \
 399 ))
 400 
 401 $(eval $(call SetupTarget, jrtfs-jar, \
 402     MAKEFILE := JrtfsJar, \
 403     DEPS := interim-langtools, \
 404 ))
 405 
 406 $(eval $(call SetupTarget, jdk-image, \
 407     MAKEFILE := Images, \
 408     TARGET := jdk, \
 409     DEPS := jmods zip-source demos release-file, \
 410 ))
 411 
 412 $(eval $(call SetupTarget, legacy-jre-image, \
 413     MAKEFILE := Images, \
 414     TARGET := jre, \
 415     DEPS := jmods release-file, \
 416 ))
 417 
 418 $(eval $(call SetupTarget, symbols-image, \
 419     MAKEFILE := Images, \
 420     TARGET := symbols, \
 421 ))
 422 
 423 $(eval $(call SetupTarget, static-libs-image, \
 424     MAKEFILE := StaticLibsImage, \
 425 ))
 426 
 427 $(eval $(call SetupTarget, mac-jdk-bundle, \
 428     MAKEFILE := MacBundles, \
 429     TARGET := jdk-bundle, \
 430     DEPS := jdk-image, \
 431 ))
 432 
 433 $(eval $(call SetupTarget, mac-legacy-jre-bundle, \
 434     MAKEFILE := MacBundles, \
 435     TARGET := jre-bundle, \
 436     DEPS := legacy-jre-image, \
 437 ))
 438 
 439 $(eval $(call SetupTarget, release-file, \
 440     MAKEFILE := ReleaseFile, \
 441     DEPS := create-source-revision-tracker, \
 442 ))
 443 
 444 $(eval $(call SetupTarget, exploded-image-optimize, \
 445     MAKEFILE := ExplodedImageOptimize, \
 446     DEPS := java copy gendata java.base-libs java.base-launchers \
 447         buildtools-modules, \
 448 ))
 449 
 450 $(eval $(call SetupTarget, graal-builder-image, \
 451     MAKEFILE := GraalBuilderImage, \
 452     DEPS := jdk-image static-libs-image, \
 453 ))
 454 
 455 ifeq ($(JCOV_ENABLED), true)
 456   $(eval $(call SetupTarget, jcov-image, \
 457       MAKEFILE := Coverage, \
 458       TARGET := jcov-image, \
 459       DEPS := jdk-image, \
 460   ))
 461 endif
 462 
 463 ALL_TARGETS += bootcycle-images
 464 
 465 ################################################################################
 466 # Docs targets
 467 
 468 # If building full docs, to complete docs-*-api we need both the javadoc and
 469 # modulegraph targets.
 470 $(eval $(call SetupTarget, docs-jdk-api-javadoc, \
 471     MAKEFILE := Docs, \
 472     TARGET := docs-jdk-api-javadoc, \
 473 ))
 474 
 475 $(eval $(call SetupTarget, docs-jdk-api-modulegraph, \
 476     MAKEFILE := Docs, \
 477     TARGET := docs-jdk-api-modulegraph, \
 478     DEPS := exploded-image buildtools-modules, \
 479 ))
 480 
 481 $(eval $(call SetupTarget, docs-javase-api-javadoc, \
 482     MAKEFILE := Docs, \
 483     TARGET := docs-javase-api-javadoc, \
 484 ))
 485 
 486 $(eval $(call SetupTarget, docs-javase-api-modulegraph, \
 487     MAKEFILE := Docs, \
 488     TARGET := docs-javase-api-modulegraph, \
 489     DEPS := exploded-image buildtools-modules, \
 490 ))
 491 
 492 $(eval $(call SetupTarget, docs-reference-api-javadoc, \
 493     MAKEFILE := Docs, \
 494     TARGET := docs-reference-api-javadoc, \
 495 ))
 496 
 497 $(eval $(call SetupTarget, docs-reference-api-modulegraph, \
 498     MAKEFILE := Docs, \
 499     TARGET := docs-reference-api-modulegraph, \
 500     DEPS := exploded-image buildtools-modules, \
 501 ))
 502 
 503 # The gensrc steps for jdk.jdi create html spec files.
 504 $(eval $(call SetupTarget, docs-jdk-specs, \
 505     MAKEFILE := Docs, \
 506     TARGET := docs-jdk-specs, \
 507     DEPS := buildtools-jdk jdk.jdi-gensrc docs-jdk-index, \
 508 ))
 509 
 510 $(eval $(call SetupTarget, docs-jdk-index, \
 511     MAKEFILE := Docs, \
 512     TARGET := docs-jdk-index, \
 513 ))
 514 
 515 $(eval $(call SetupTarget, docs-zip, \
 516     MAKEFILE := Docs, \
 517     TARGET := docs-zip, \
 518     DEPS :=  docs-jdk, \
 519 ))
 520 
 521 $(eval $(call SetupTarget, docs-specs-zip, \
 522     MAKEFILE := Docs, \
 523     TARGET := docs-specs-zip, \
 524     DEPS := docs-jdk-specs, \
 525 ))
 526 
 527 $(eval $(call SetupTarget, update-build-docs, \
 528     MAKEFILE := UpdateBuildDocs, \
 529 ))
 530 
 531 $(eval $(call SetupTarget, update-x11wrappers, \
 532     MAKEFILE := UpdateX11Wrappers, \
 533     DEPS := java.base-copy buildtools-jdk, \
 534 ))
 535 
 536 ################################################################################
 537 # Cross compilation support
 538 
 539 ifeq ($(CREATING_BUILDJDK), true)
 540   # This target is only called by the recursive call below.
 541   create-buildjdk-interim-image-helper: interim-image jdk.jlink-launchers \
 542       java.base-copy jdk.jdeps-launchers
 543 endif
 544 
 545 BUILDJDK_MODULES := $(sort $(foreach m, jdk.jlink $(INTERIM_IMAGE_MODULES), \
 546     $(call FindTransitiveDepsForModule, $m) $m))
 547 
 548 $(eval $(call SetupTarget, create-buildjdk-interim-image, \
 549     MAKEFILE := Main, \
 550     TARGET := create-buildjdk-interim-image-helper, \
 551     ARGS := SPEC=$(dir $(SPEC))buildjdk-spec.gmk \
 552         HOTSPOT_SPEC=$(dir $(SPEC))buildjdk-spec.gmk \
 553         CREATING_BUILDJDK=true \
 554         LOG_PREFIX=&quot;[buildjdk] &quot; \
 555         JAVA_MODULES=&quot;$(BUILDJDK_MODULES)&quot;, \
 556 ))
 557 
 558 ################################################################################
 559 # The interim-image is a small jlinked image that is used to generate artifacts
 560 # at build time for use when linking the real images.
 561 
 562 INTERIM_JMOD_TARGETS := $(addsuffix -interim-jmod, $(INTERIM_IMAGE_MODULES))
 563 
 564 define DeclareInterimJmodRecipe
 565   $1-interim-jmod:
 566 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f CreateJmods.gmk \
 567 	    MODULE=$1 \
 568 	    JMODS_DIR=$(INTERIM_JMODS_DIR) \
 569 	    JMODS_SUPPORT_DIR=$(INTERIM_JMODS_DIR)/support \
 570 	    INTERIM_JMOD=true \
 571 	)
 572 endef
 573 
 574 $(foreach m, $(INTERIM_IMAGE_MODULES), $(eval $(call DeclareInterimJmodRecipe,$m)))
 575 
 576 $(eval $(call SetupTarget, interim-image, \
 577     MAKEFILE := InterimImage, \
 578 ))
 579 
 580 ifeq ($(ENABLE_GENERATE_CLASSLIST), true)
 581   $(eval $(call SetupTarget, generate-link-opt-data, \
 582       MAKEFILE := GenerateLinkOptData, \
 583   ))
 584 endif
 585 
 586 ################################################################################
 587 # Generate test names for all JTReg test groups
 588 #
 589 
 590 define DeclareRunTestRecipe
 591   test-$1:
 592 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f RunTests.gmk \
 593 	    TEST=&quot;$1&quot;)
 594 
 595   exploded-test-$1:
 596 	+($(CD) $(TOPDIR)/make &amp;&amp; $(MAKE) $(MAKE_ARGS) -f RunTests.gmk \
 597 	    TEST=&quot;$1&quot; JDK_IMAGE_DIR=$(JDK_OUTPUTDIR))
 598 endef
 599 
 600 # ALL_NAMED_TESTS is defined in FindTests.gmk
 601 $(foreach t, $(ALL_NAMED_TESTS), $(eval $(call DeclareRunTestRecipe,$t)))
 602 ALL_TEST_TARGETS := $(addprefix test-, $(ALL_NAMED_TESTS))
 603 
 604 # We only support the &quot;exploded-test-gtest&quot; shortcut
 605 ALL_EXPLODED_TESTS := gtest
 606 ALL_EXPLODED_TEST_TARGETS := $(addprefix exploded-test-, $(ALL_EXPLODED_TESTS))
 607 
 608 ALL_TARGETS += $(ALL_TEST_TARGETS) $(ALL_EXPLODED_TEST_TARGETS)
 609 
 610 ################################################################################
 611 # Build tests and microbenchmarks
 612 #
 613 
 614 $(eval $(call SetupTarget, prepare-test-image, \
 615     MAKEFILE := TestImage, \
 616     TARGET := prepare-test-image, \
 617 ))
 618 
 619 $(eval $(call SetupTarget, build-test-hotspot-jtreg-native, \
 620     MAKEFILE := test/JtregNativeHotspot, \
 621     TARGET := build-test-hotspot-jtreg-native, \
 622     DEPS := buildtools-jdk, \
 623 ))
 624 
 625 $(eval $(call SetupTarget, test-image-hotspot-jtreg-native, \
 626     MAKEFILE := test/JtregNativeHotspot, \
 627     TARGET := test-image-hotspot-jtreg-native, \
 628     DEPS := build-test-hotspot-jtreg-native, \
 629 ))
 630 
 631 $(eval $(call SetupTarget, build-test-jdk-jtreg-native, \
 632     MAKEFILE := test/JtregNativeJdk, \
 633     TARGET := build-test-jdk-jtreg-native, \
 634     DEPS := buildtools-jdk java.base-libs, \
 635 ))
 636 
 637 $(eval $(call SetupTarget, test-image-jdk-jtreg-native, \
 638     MAKEFILE := test/JtregNativeJdk, \
 639     TARGET := test-image-jdk-jtreg-native, \
 640     DEPS := build-test-jdk-jtreg-native, \
 641 ))
 642 
 643 # Native files needed by the testlib
 644 $(eval $(call SetupTarget, build-test-lib-native, \
 645     MAKEFILE := test/BuildTestLibNative, \
 646     TARGET := build-test-lib-native, \
 647     DEPS := buildtools-jdk java.base-libs, \
 648 ))
 649 
 650 $(eval $(call SetupTarget, test-image-lib-native, \
 651     MAKEFILE := test/BuildTestLibNative, \
 652     TARGET := test-image-lib-native, \
 653     DEPS := build-test-lib-native, \
 654 ))
 655 
 656 # Native files needed when testing the testlib itself
 657 $(eval $(call SetupTarget, build-test-libtest-jtreg-native, \
 658     MAKEFILE := test/JtregNativeLibTest, \
 659     TARGET := build-test-libtest-jtreg-native, \
 660     DEPS := buildtools-jdk, \
 661 ))
 662 
 663 $(eval $(call SetupTarget, test-image-libtest-jtreg-native, \
 664     MAKEFILE := test/JtregNativeLibTest, \
 665     TARGET := test-image-libtest-jtreg-native, \
 666     DEPS := build-test-libtest-jtreg-native, \
 667 ))
 668 
 669 $(eval $(call SetupTarget, build-test-hotspot-jtreg-graal, \
 670     MAKEFILE := test/JtregGraalUnit, \
 671     TARGET := build-test-hotspot-jtreg-graal, \
 672     DEPS := exploded-image, \
 673 ))
 674 
 675 $(eval $(call SetupTarget, test-image-hotspot-jtreg-graal, \
 676     MAKEFILE := test/JtregGraalUnit, \
 677     TARGET := test-image-hotspot-jtreg-graal, \
 678     DEPS := build-test-hotspot-jtreg-graal, \
 679 ))
 680 
 681 ifneq ($GTEST_FRAMEWORK_SRC), )
 682   $(eval $(call SetupTarget, test-image-hotspot-gtest, \
 683       MAKEFILE := hotspot/test/GtestImage, \
 684       DEPS := hotspot, \
 685   ))
 686 endif
 687 
 688 $(eval $(call SetupTarget, build-test-lib, \
 689     MAKEFILE := test/BuildTestLib, \
 690     DEPS := exploded-image, \
 691 ))
 692 
 693 ifeq ($(BUILD_FAILURE_HANDLER), true)
 694   # Builds the failure handler jtreg extension
 695   $(eval $(call SetupTarget, build-test-failure-handler, \
 696       MAKEFILE := test/BuildFailureHandler, \
 697       TARGET := build, \
 698       DEPS := interim-langtools, \
 699   ))
 700 
 701   # Copies the failure handler jtreg extension into the test image
 702   $(eval $(call SetupTarget, test-image-failure-handler, \
 703       MAKEFILE := test/BuildFailureHandler, \
 704       TARGET := images, \
 705       DEPS := build-test-failure-handler, \
 706   ))
 707 endif
 708 
 709 $(eval $(call SetupTarget, build-microbenchmark, \
 710     MAKEFILE := test/BuildMicrobenchmark, \
 711     DEPS := interim-langtools exploded-image, \
 712 ))
 713 
 714 ################################################################################
 715 # Run tests
 716 
 717 $(eval $(call SetupTarget, test, \
 718     MAKEFILE := RunTests, \
 719     ARGS := TEST=&quot;$(TEST)&quot;, \
 720     DEPS := jdk-image test-image, \
 721 ))
 722 
 723 $(eval $(call SetupTarget, exploded-test, \
 724     MAKEFILE := RunTests, \
 725     ARGS := TEST=&quot;$(TEST)&quot; JDK_IMAGE_DIR=$(JDK_OUTPUTDIR), \
 726     DEPS := exploded-image test-image, \
 727 ))
 728 
 729 ifeq ($(JCOV_ENABLED), true)
 730   $(eval $(call SetupTarget, jcov-test, \
 731       MAKEFILE := RunTests, \
 732       ARGS := TEST=&quot;$(TEST)&quot; TEST_OPTS_JCOV=true, \
 733       DEPS := jcov-image test-image, \
 734   ))
 735 endif
 736 
 737 ################################################################################
 738 # Bundles
 739 
 740 $(eval $(call SetupTarget, product-bundles, \
 741     MAKEFILE := Bundles, \
 742     TARGET := product-bundles, \
 743     DEPS := product-images, \
 744 ))
 745 
 746 $(eval $(call SetupTarget, legacy-bundles, \
 747     MAKEFILE := Bundles, \
 748     TARGET := legacy-bundles, \
 749     DEPS := legacy-images, \
 750 ))
 751 
 752 $(eval $(call SetupTarget, test-bundles, \
 753     MAKEFILE := Bundles, \
 754     TARGET := test-bundles, \
 755     DEPS := test-image, \
 756 ))
 757 
 758 $(eval $(call SetupTarget, docs-bundles, \
 759     MAKEFILE := Bundles, \
 760     TARGET := docs-bundles, \
 761     DEPS := docs-image, \
 762 ))
 763 
 764 $(eval $(call SetupTarget, static-libs-bundles, \
 765     MAKEFILE := Bundles, \
 766     TARGET := static-libs-bundles, \
 767     DEPS := static-libs-image, \
 768 ))
 769 
 770 ifeq ($(JCOV_ENABLED), true)
 771   $(eval $(call SetupTarget, jcov-bundles, \
 772       MAKEFILE := Bundles, \
 773       TARGET := jcov-bundles, \
 774       DEPS := jcov-image, \
 775   ))
 776 endif
 777 
 778 ################################################################################
 779 # Install targets
 780 
 781 $(eval $(call SetupTarget, install, \
 782     MAKEFILE := Install, \
 783     DEPS := product-images, \
 784 ))
 785 
 786 ################################################################################
 787 #
 788 # Dependency declarations between targets.
 789 #
 790 # These are declared in two groups. First all dependencies between targets that
 791 # have recipes above as these dependencies may be disabled. Then the aggregator
 792 # targets that do not have recipes of their own, which will never have their
 793 # dependencies disabled.
 794 #
 795 ################################################################################
 796 # Targets with recipes above
 797 
 798 # If running an *-only target, parallel execution and dependencies between
 799 # recipe targets are disabled. This makes it possible to run a select set of
 800 # recipe targets in order. It&#39;s the responsibility of the user to make sure
 801 # all prerequisites are fulfilled.
 802 ifeq ($(DEPS), none)
 803   .NOTPARALLEL:
 804 else
 805   $(LANGTOOLS_GENSRC_TARGETS): buildtools-langtools
 806 
 807   interim-langtools: $(INTERIM_LANGTOOLS_GENSRC_TARGETS)
 808 
 809   $(HOTSPOT_GENSRC_TARGETS): interim-langtools buildtools-hotspot
 810 
 811   $(JDK_GENSRC_TARGETS): interim-langtools buildtools-jdk
 812 
 813   $(GENSRC_MODULEINFO_TARGETS): buildtools-jdk
 814 
 815   $(GENDATA_TARGETS): interim-langtools buildtools-jdk
 816 
 817   $(JAVA_TARGETS): interim-langtools
 818 
 819   # Declare dependencies between hotspot-&lt;variant&gt;* targets
 820   $(foreach v, $(JVM_VARIANTS), \
 821       $(eval hotspot-$v-gensrc: java.base-copy buildtools-hotspot) \
 822       $(eval hotspot-$v-libs: hotspot-$v-gensrc java.base-copy) \
 823   )
 824 
 825   # If not already set, set the JVM variant target so that the JVM will be built.
 826   JVM_MAIN_LIB_TARGETS ?= hotspot-$(JVM_VARIANT_MAIN)-libs
 827   JVM_MAIN_GENSRC_TARGETS ?= hotspot-$(JVM_VARIANT_MAIN)-gensrc
 828 
 829   # Building one JVM variant is enough to start building the other libs
 830   $(LIBS_TARGETS): $(JVM_MAIN_LIB_TARGETS)
 831 
 832   # Static libs depend on hotspot gensrc
 833   $(STATIC_LIBS_TARGETS): $(JVM_MAIN_GENSRC_TARGETS)
 834 
 835   $(LAUNCHER_TARGETS): java.base-libs
 836 
 837   ifeq ($(STATIC_BUILD), true)
 838     $(LAUNCHER_TARGETS): generate-exported-symbols
 839   endif
 840 
 841   # Declare dependency from &lt;module&gt;-java to &lt;module&gt;-gensrc
 842   $(foreach m, $(GENSRC_MODULES), $(eval $m-java: $m-gensrc))
 843 
 844   # Declare dependencies between java modules
 845   $(foreach m, $(JAVA_MODULES), \
 846       $(eval $m-java: $(addsuffix -java, $(filter $(JAVA_MODULES), \
 847       $(call FindDepsForModule,$m)))))
 848   # Declare dependencies between the module meta targets
 849   $(foreach m, $(ALL_MODULES), $(eval $m: $(call FindDepsForModule,$m)))
 850 
 851   # Declare dependencies from &lt;module&gt;-lib to &lt;module&gt;-java
 852   # Skip modules that do not have java source.
 853   $(foreach m, $(filter $(JAVA_MODULES), $(LIBS_MODULES)), $(eval $m-libs: $m-java))
 854 
 855   # Declare dependencies from all other &lt;module&gt;-lib to java.base-lib
 856   $(foreach t, $(filter-out java.base-libs, $(LIBS_TARGETS)), \
 857       $(eval $t: java.base-libs))
 858 
 859   # jdk.accessibility depends on java.desktop
 860   jdk.accessibility-libs: java.desktop-libs
 861 
 862   # This dependency needs to be explicitly declared. jdk.jdi-gensrc generates a
 863   # header file used by jdk.jdwp.agent-libs. The jdk.jdwp.agent-gensrc is a
 864   # virtual target.
 865   jdk.jdwp.agent-libs: jdk.jdwp.agent-gensrc
 866 
 867   # The swing beans need to have java base properly generated to avoid errors
 868   # in javadoc. The X11 wrappers need the java.base include files to have been
 869   # copied and processed.
 870   java.desktop-gensrc-src: java.base-gensrc java.base-copy
 871 
 872   # The annotation processing for jdk.internal.vm.compiler
 873   # and jdk.internal.vm.compiler.management needs classes from the current JDK.
 874   jdk.internal.vm.compiler-gensrc-src: $(addsuffix -java, \
 875       $(call FindTransitiveDepsForModule, jdk.internal.vm.compiler))
 876   jdk.internal.vm.compiler.management-gensrc-src: $(addsuffix -java, \
 877       $(call FindTransitiveDepsForModule, jdk.internal.vm.compiler.management))
 878 
 879   # For these modules, the gensrc step is generating a module-info.java.extra
 880   # file to be processed by the gensrc-moduleinfo target.
 881   jdk.internal.vm.compiler-gensrc-moduleinfo: jdk.internal.vm.compiler-gensrc-src
 882   jdk.internal.vm.compiler.management-gensrc-moduleinfo: jdk.internal.vm.compiler.management-gensrc-src
 883 
 884   jdk.jdeps-gendata: java
 885 
 886   # The ct.sym generation uses all the moduleinfos as input
 887   jdk.compiler-gendata: $(GENSRC_MODULEINFO_TARGETS)
 888 
 889   # Declare dependencies between jmod targets.
 890   # java.base jmod needs jrt-fs.jar and access to the other jmods to be built.
 891   # When creating the BUILDJDK, we don&#39;t need to add hashes to java.base, thus
 892   # we don&#39;t need to depend on all other jmods
 893   ifneq ($(CREATING_BUILDJDK), true)
 894     java.base-jmod: jrtfs-jar $(filter-out java.base-jmod, $(JMOD_TARGETS))
 895   endif
 896 
 897   # If not already set, set the JVM target so that the JVM will be built.
 898   JVM_MAIN_TARGETS ?= hotspot
 899 
 900   # Building java.base-jmod requires all of VM (ie hotspot) to be built.
 901   java.base-jmod: $(JVM_MAIN_TARGETS)
 902 
 903   # Declare dependencies from &lt;module&gt;-jmod to all other module targets
 904   $(foreach m, $(JAVA_MODULES), $(eval $m_JMOD_DEPS += $m-java))
 905   $(foreach m, $(GENDATA_MODULES), $(eval $m_JMOD_DEPS += $m-gendata))
 906   $(foreach m, $(LIBS_MODULES), $(eval $m_JMOD_DEPS += $m-libs))
 907   $(foreach m, $(LAUNCHER_MODULES), $(eval $m_JMOD_DEPS += $m-launchers))
 908   $(foreach m, $(COPY_MODULES), $(eval $m_JMOD_DEPS += $m-copy))
 909   $(foreach m, $(ALL_MODULES), $(eval $m-jmod: $($(m)_JMOD_DEPS)))
 910   $(foreach m, $(INTERIM_IMAGE_MODULES), $(eval $m-interim-jmod: $($(m)_JMOD_DEPS)))
 911 
 912   # Setup the minimal set of generated native source dependencies for hotspot
 913   $(foreach v, $(JVM_VARIANTS), \
 914     $(eval hotspot-$v-libs-compile-commands: hotspot-$v-gensrc) \
 915     $(foreach m, $(filter java.desktop jdk.hotspot.agent, $(GENSRC_MODULES)), \
 916       $(eval hotspot-$v-libs-compile-commands: $m-gensrc)) \
 917   )
 918 
 919   # For the full JDK compile commands, create all possible generated sources
 920   $(foreach m, $(GENSRC_MODULES), $(eval $m-libs-compile-commands: $m-gensrc))
 921   $(foreach m, $(filter $(JAVA_MODULES), $(LIBS_MODULES)), $(eval $m-libs-compile-commands: $m-java))
 922 
 923   $(COMPILE_COMMANDS_TARGETS_HOTSPOT): clean-compile-commands
 924   $(COMPILE_COMMANDS_TARGETS_JDK): clean-compile-commands
 925   compile-commands-hotspot: $(COMPILE_COMMANDS_TARGETS_HOTSPOT)
 926   compile-commands: $(COMPILE_COMMANDS_TARGETS_HOTSPOT) $(COMPILE_COMMANDS_TARGETS_JDK)
 927 
 928   # The -static-libs targets depend on -java as well as java.base-copy.
 929   $(foreach m, $(filter $(JAVA_MODULES), $(STATIC_LIBS_MODULES)), \
 930     $(eval $m-static-libs: $m-java java.base-copy))
 931 
 932   # Jmods cannot be created until we have the jmod tool ready to run. During
 933   # a normal build we run it from the exploded image, but when cross compiling
 934   # it&#39;s run from the buildjdk, which is either created at build time or user
 935   # supplied.
 936   ifeq ($(CREATE_BUILDJDK), true)
 937     ifneq ($(CREATING_BUILDJDK), true)
 938       # When cross compiling and buildjdk is to be created, simply depend on
 939       # creating the buildjdk.
 940       $(JMOD_TARGETS): create-buildjdk
 941       buildtools-modules: create-buildjdk
 942     else
 943       # While actually creating the buildjdk, we need to list the bare
 944       # minimum dependencies needed before running jmod, to avoid building
 945       # more than necessary. This includes:
 946       # * all java modules
 947       # * jdk.jlink-launchers
 948       # * copy jvm.cfg (done in java.base-copy)
 949       # * tzdb.dat (done in java.base-gendata)
 950       # Without all of these jimage, jlink and jmod won&#39;t start.
 951       $(JMOD_TARGETS) $(INTERIM_JMOD_TARGETS): java.base-libs java.base-copy \
 952           java.base-gendata jdk.jlink-launchers java
 953     endif
 954   else
 955     # The normal non cross compilation case uses needs to wait for the full
 956     # exploded-image to avoid a race with the optimize target.
 957     $(JMOD_TARGETS) $(INTERIM_JMOD_TARGETS): exploded-image
 958   endif
 959 
 960   # All modules include the main license files from java.base.
 961   $(JMOD_TARGETS): java.base-copy
 962 
 963   zip-security: $(filter jdk.crypto%, $(JAVA_TARGETS))
 964 
 965   ifeq ($(ENABLE_GENERATE_CLASSLIST), true)
 966     ifeq ($(CREATE_BUILDJDK), true)
 967       # If creating a buildjdk, the interim image needs to be based on that.
 968       generate-link-opt-data: create-buildjdk
 969     else ifeq ($(EXTERNAL_BUILDJDK), false)
 970       # If an external buildjdk has been provided, we skip generating an
 971       # interim-image and just use the external buildjdk for generating
 972       # classlist.
 973       generate-link-opt-data: interim-image
 974     endif
 975     generate-link-opt-data: buildtools-jdk
 976 
 977     # The generated classlist needs to go into java.base-jmod.
 978     java.base-jmod jdk.jlink-jmod jdk-image legacy-jre-image: generate-link-opt-data
 979   endif
 980 
 981   symbols-image: $(LIBS_TARGETS) $(LAUNCHER_TARGETS)
 982 
 983   static-libs-image: $(STATIC_LIBS_TARGETS)
 984 
 985   bootcycle-images: jdk-image
 986 
 987   docs-jdk-api-javadoc: $(GENSRC_TARGETS)
 988 
 989   docs-javase-api-javadoc: $(GENSRC_TARGETS)
 990 
 991   docs-reference-api-javadoc: $(GENSRC_TARGETS)
 992 
 993   # If not already set, then set the JVM specific docs targets
 994   JVM_DOCS_TARGETS ?= hotspot-$(JVM_VARIANT_MAIN)-gensrc
 995 
 996   # The gensrc steps for hotspot create html spec files.
 997   docs-jdk-specs: $(JVM_DOCS_TARGETS)
 998 
 999   # Tests
1000   test-make: clean-test-make compile-commands
1001 
1002   test-make-compile-commands: compile-commands
1003 
1004   # Declare dependency for all generated test targets
1005   $(foreach t, $(filter-out test-make%, $(ALL_TEST_TARGETS)), $(eval $t: jdk-image test-image))
1006   $(foreach t, $(ALL_EXPLODED_TEST_TARGETS), $(eval $t: exploded-image test-image))
1007 
1008   interim-image: $(INTERIM_JMOD_TARGETS)
1009 
1010   build-test-hotspot-jtreg-native: hotspot-$(JVM_VARIANT_MAIN)-libs
1011   build-test-libtest-jtreg-native: hotspot-$(JVM_VARIANT_MAIN)-libs
1012 
1013 endif
1014 
1015 ################################################################################
1016 # Virtual targets without recipes
1017 
1018 # If not already set, set the JVM specific tools targets
1019 JVM_TOOLS_TARGETS ?= buildtools-hotspot
1020 buildtools: buildtools-langtools interim-langtools \
1021     buildtools-jdk $(JVM_TOOLS_TARGETS)
1022 
1023 # Declare dependencies from hotspot-&lt;variant&gt; targets
1024 $(foreach v, $(JVM_VARIANTS), \
1025   $(eval hotspot-$v: hotspot-$v-gensrc hotspot-$v-libs) \
1026 )
1027 hotspot: $(HOTSPOT_VARIANT_TARGETS)
1028 
1029 # Create targets hotspot-libs and hotspot-gensrc.
1030 $(foreach v, $(JVM_VARIANTS), \
1031   $(eval hotspot-libs: hotspot-$v-libs) \
1032   $(eval hotspot-gensrc: hotspot-$v-gensrc) \
1033 )
1034 
1035 gensrc: $(GENSRC_TARGETS)
1036 
1037 gendata: $(GENDATA_TARGETS)
1038 
1039 copy: $(ALL_COPY_TARGETS)
1040 
1041 java: $(JAVA_TARGETS)
1042 
1043 libs: $(LIBS_TARGETS)
1044 
1045 static-libs: $(STATIC_LIBS_TARGETS)
1046 
1047 launchers: $(LAUNCHER_TARGETS)
1048 
1049 jmods: $(JMOD_TARGETS)
1050 
1051 # Explicitly declare dependency for virtual target jdk.jdwp.agent-gensrc which
1052 # is actually handled by jdk.jdi-gensrc
1053 jdk.jdwp.agent-gensrc: jdk.jdi-gensrc
1054 
1055 # Declare dependencies from &lt;module&gt; to all the individual targets specific
1056 # to that module &lt;module&gt;-*, that are needed for the exploded image.
1057 $(foreach m, $(GENSRC_MODULES), $(eval $m: $m-gensrc))
1058 $(foreach m, $(JAVA_MODULES), $(eval $m: $m-java))
1059 $(foreach m, $(GENDATA_MODULES), $(eval $m: $m-gendata))
1060 $(foreach m, $(LIBS_MODULES), $(eval $m: $m-libs))
1061 $(foreach m, $(LAUNCHER_MODULES), $(eval $m: $m-launchers))
1062 $(foreach m, $(ALL_COPY_MODULES), $(eval $m: $m-copy))
1063 
1064 # Building java.base includes building all of hotspot.
1065 java.base: $(JVM_MAIN_TARGETS)
1066 
1067 demos: demos-jdk
1068 
1069 # The &quot;exploded image&quot; is a locally runnable JDK in $(OUTPUTDIR)/jdk.
1070 exploded-image-base: $(ALL_MODULES)
1071 exploded-image: exploded-image-base release-file
1072 # When cross compiling, no need to optimize the exploded image since it won&#39;t
1073 # be runnable on the host platform anyway.
1074 ifneq ($(COMPILE_TYPE), cross)
1075   exploded-image: exploded-image-optimize
1076 endif
1077 
1078 create-buildjdk: create-buildjdk-interim-image
1079 
1080 docs-jdk-api: docs-jdk-api-javadoc
1081 docs-javase-api: docs-javase-api-javadoc
1082 docs-reference-api: docs-reference-api-javadoc
1083 
1084 # If we&#39;re building full docs, we must also generate the module graphs to
1085 # get non-broken api documentation.
1086 ifeq ($(ENABLE_FULL_DOCS), true)
1087   docs-jdk-api: docs-jdk-api-modulegraph
1088   docs-javase-api: docs-javase-api-modulegraph
1089   docs-reference-api: docs-reference-api-modulegraph
1090 endif
1091 
1092 docs-jdk: docs-jdk-api docs-jdk-specs docs-jdk-index
1093 docs-javase: docs-javase-api
1094 docs-reference: docs-reference-api
1095 
1096 # alias for backwards compatibility
1097 docs-javadoc: docs-jdk-api
1098 
1099 mac-bundles: mac-jdk-bundle
1100 
1101 # The $(OUTPUTDIR)/images directory contain the resulting deliverables,
1102 # and in line with this, our targets for creating these are named *-image[s].
1103 
1104 # This target builds the product images, e.g. the JDK image
1105 # (and possibly other, more specific versions)
1106 product-images: jdk-image symbols-image exploded-image
1107 
1108 # This target builds the legacy images, e.g. the legacy JRE image
1109 legacy-images: legacy-jre-image
1110 
1111 # zip-security is actually a bundle, but for now it needs to be considered
1112 # an image until this can be cleaned up properly.
1113 product-images: zip-security
1114 
1115 # The module summary cannot be run when:
1116 # * Cross compiling and building a partial BUILDJDK for the build host
1117 # * An external buildjdk has been supplied since it may not match the
1118 #   module selection of the target jdk
1119 ifneq ($(CREATE_BUILDJDK), true)
1120   ifeq ($(EXTERNAL_BUILDJDK), false)
1121     product-images: generate-summary
1122   endif
1123 endif
1124 
1125 ifeq ($(call isTargetOs, macosx), true)
1126   product-images: mac-jdk-bundle
1127 
1128   legacy-images: mac-legacy-jre-bundle
1129 endif
1130 
1131 # This target builds the documentation image
1132 docs-image: docs-jdk
1133 
1134 # This target builds the test image
1135 test-image: prepare-test-image test-image-jdk-jtreg-native \
1136     test-image-demos-jdk test-image-libtest-jtreg-native \
1137     test-image-lib-native
1138 
1139 ifneq ($(JVM_TEST_IMAGE_TARGETS), )
1140   # If JVM_TEST_IMAGE_TARGETS is externally defined, use it instead of the
1141   # standard hotspot set of tests.
1142   test-image: $(JVM_TEST_IMAGE_TARGETS)
1143 else
1144   test-image: test-image-hotspot-jtreg-native
1145   ifneq ($(GTEST_FRAMEWORK_SRC), )
1146     test-image: test-image-hotspot-gtest
1147   endif
1148 
1149   ifeq ($(INCLUDE_GRAAL), true)
1150     test-image: test-image-hotspot-jtreg-graal
1151   endif
1152 endif
1153 
1154 ifeq ($(BUILD_FAILURE_HANDLER), true)
1155   test-image: test-image-failure-handler
1156 endif
1157 
1158 ifneq ($(JMH_CORE_JAR), )
1159   test-image: build-microbenchmark
1160 endif
1161 
1162 ################################################################################
1163 
1164 # all-images builds all our deliverables as images.
1165 all-images: product-images test-image docs-image
1166 
1167 # all-bundles packages all our deliverables as tar.gz bundles.
1168 all-bundles: product-bundles test-bundles docs-bundles static-libs-bundles
1169 
1170 ALL_TARGETS += buildtools hotspot hotspot-libs hotspot-gensrc gensrc gendata \
1171     copy java libs static-libs launchers jmods \
1172     jdk.jdwp.agent-gensrc $(ALL_MODULES) demos \
1173     exploded-image-base exploded-image \
1174     create-buildjdk docs-jdk-api docs-javase-api docs-reference-api docs-jdk \
1175     docs-javase docs-reference docs-javadoc mac-bundles product-images legacy-images \
1176     docs-image test-image all-images \
1177     all-bundles
1178 
1179 ################################################################################
1180 
1181 # Traditional targets typically run by users.
1182 # These can be considered aliases for the targets now named by a more
1183 # &quot;modern&quot; naming scheme.
1184 default: $(DEFAULT_MAKE_TARGET)
1185 jdk: exploded-image
1186 images: product-images
1187 docs: docs-image
1188 bundles: all-bundles
1189 all: all-images
1190 
1191 ALL_TARGETS += default jdk images docs bundles all
1192 
1193 # Aliases used for running tests.
1194 
1195 # Let &quot;run-test&quot; be an alias for &quot;test&quot;
1196 $(foreach t, $(ALL_NAMED_TESTS), $(eval run-test-$t: test-$t))
1197 RUN_TEST_TARGETS := $(addprefix run-test-, $(ALL_NAMED_TESTS))
1198 
1199 run-test: test
1200 exploded-run-test: exploded-test
1201 
1202 # &quot;make check&quot; is a common idiom for running basic testing
1203 check: test-tier1
1204 
1205 # Keep some old names as aliases
1206 test-hotspot-jtreg: test-hotspot_all
1207 test-hotspot-jtreg-native: test-hotspot_native_sanity
1208 test-hotspot-gtest: exploded-test-gtest
1209 test-jdk-jtreg-native: test-jdk_native_sanity
1210 
1211 ALL_TARGETS += $(RUN_TEST_TARGETS) run-test exploded-run-test check \
1212     test-hotspot-jtreg test-hotspot-jtreg-native test-hotspot-gtest \
1213     test-jdk-jtreg-native
1214 
1215 ################################################################################
1216 ################################################################################
1217 #
1218 # Clean targets
1219 #
1220 ################################################################################
1221 # Clean targets are automatically run serially by the Makefile calling this
1222 # file.
1223 
1224 CLEAN_DIRS += hotspot jdk bootcycle-build test buildtools support \
1225     images make-support test-make bundles buildjdk test-results test-support \
1226     support/images
1227 CLEAN_DIR_TARGETS := $(addprefix clean-, $(CLEAN_DIRS))
1228 CLEAN_SUPPORT_DIRS += demos
1229 CLEAN_SUPPORT_DIR_TARGETS := $(addprefix clean-, $(CLEAN_SUPPORT_DIRS))
<a name="1" id="anc1"></a><span class="line-modified">1230 CLEAN_TESTS += hotspot-jtreg-native jdk-jtreg-native lib micro</span>
1231 CLEAN_TEST_TARGETS += $(addprefix clean-test-, $(CLEAN_TESTS))
1232 CLEAN_PHASES := gensrc java native include
1233 CLEAN_PHASE_TARGETS := $(addprefix clean-, $(CLEAN_PHASES))
1234 CLEAN_MODULE_TARGETS := $(addprefix clean-, $(ALL_MODULES))
1235 # Construct targets of the form clean-$module-$phase
1236 CLEAN_MODULE_PHASE_TARGETS := $(addprefix clean-, $(foreach m, $(ALL_MODULES), \
1237     $(addprefix $m-, $(CLEAN_PHASES))))
1238 
1239 # Remove everything, except the output from configure.
1240 clean: $(CLEAN_DIR_TARGETS)
1241 	($(CD) $(OUTPUTDIR) &amp;&amp; $(RM) -r build*.log* compile_commands.json)
1242 	$(ECHO) Cleaned all build artifacts.
1243 
1244 clean-docs:
1245 	$(call CleanDocs)
1246 
1247 clean-compile-commands:
1248 	$(call CleanMakeSupportDir,compile-commands)
1249 
1250 $(CLEAN_DIR_TARGETS):
1251 	$(call CleanDir,$(patsubst clean-%, %, $@))
1252 
1253 $(CLEAN_SUPPORT_DIR_TARGETS):
1254 	$(call CleanSupportDir,$(patsubst clean-%, %, $@))
1255 
1256 $(CLEAN_TEST_TARGETS):
1257 	$(call CleanTest,$(patsubst clean-test-%, %, $@))
1258 
1259 $(CLEAN_PHASE_TARGETS):
1260 	$(call Clean-$(patsubst clean-%,%, $@))
1261 
1262 $(CLEAN_MODULE_TARGETS):
1263 	$(call CleanModule,$(patsubst clean-%, %, $@))
1264 
1265 $(CLEAN_MODULE_PHASE_TARGETS):
1266 	$(call Clean-$(word 3, $(subst -,$(SPACE),$@)), \
1267 	    $(word 2, $(subst -,$(SPACE),$@)))
1268 
1269 # When removing the support dir, we must also remove jdk. Building classes has
1270 # the side effect of generating native headers. The headers end up in support
1271 # while classes and touch files end up in jdk.
1272 clean-support: clean-jdk
1273 
1274 clean-test: clean-test-results clean-test-support
1275 
1276 # When cleaning images, also clean the support/images directory.
1277 clean-images: clean-support/images
1278 
1279 # Remove everything, including configure configuration. If the output
1280 # directory was created by configure and now becomes empty, remove it as well.
1281 dist-clean: clean
1282 	($(CD) $(OUTPUTDIR) &amp;&amp; \
1283 	    $(RM) -r *spec.gmk $(CONFIGURESUPPORT_OUTPUTDIR) Makefile compare.sh ide \
1284 	    configure.log* build.log*)
1285 	$(if $(filter $(CONF_NAME),$(notdir $(OUTPUTDIR))), \
1286 	  if test &quot;x`$(LS) $(OUTPUTDIR)`&quot; != x; then \
1287 	    $(ECHO) &quot;Warning: Not removing non-empty configuration directory for &#39;$(CONF_NAME)&#39;&quot; ; \
1288 	  else \
1289 	    ($(CD) $(TOPDIR) &amp;&amp; $(ECHO) &quot;Removing configuration directory for &#39;$(CONF_NAME)&#39;&quot; \
1290 	        &amp;&amp; $(RM) -r $(OUTPUTDIR)) \
1291 	  fi \
1292 	)
1293 	$(ECHO) Cleaned everything, you will have to re-run configure.
1294 
1295 ALL_TARGETS += clean clean-docs clean-compile-commands dist-clean $(CLEAN_DIR_TARGETS) \
1296     $(CLEAN_SUPPORT_DIR_TARGETS) $(CLEAN_TEST_TARGETS) $(CLEAN_PHASE_TARGETS) \
1297     $(CLEAN_MODULE_TARGETS) $(CLEAN_MODULE_PHASE_TARGETS)
1298 
1299 ################################################################################
1300 # Declare *-only targets for each normal target
1301 $(foreach t, $(ALL_TARGETS), $(eval $(t)-only: $(t)))
1302 
1303 ALL_TARGETS += $(addsuffix -only, $(filter-out dist-clean clean%, $(ALL_TARGETS)))
1304 
1305 ################################################################################
1306 
1307 # The following targets are intentionally not added to ALL_TARGETS since they
1308 # are internal only, to support Init.gmk.
1309 
1310 print-targets:
1311 	  @$(ECHO) $(sort $(ALL_TARGETS))
1312 
1313 print-modules:
1314 	  @$(ECHO) $(sort $(ALL_MODULES))
1315 
1316 print-tests:
1317 	  @$(ECHO) $(sort $(ALL_NAMED_TESTS))
1318 
1319 create-main-targets-include:
1320 	  $(call LogInfo, Generating main target list)
1321 	  @$(ECHO) ALL_MAIN_TARGETS := $(sort $(ALL_TARGETS)) &gt; \
1322 	      $(MAKESUPPORT_OUTPUTDIR)/main-targets.gmk
1323 
1324 ################################################################################
1325 # Hook to include the corresponding custom file, if present.
1326 $(eval $(call IncludeCustomExtension, Main-post.gmk))
1327 
1328 .PHONY: $(ALL_TARGETS)
1329 
1330 FRC: # Force target
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>