<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.controls/src/test/java/test/javafx/scene/control/ComboBoxTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
<a name="1" id="anc1"></a><span class="line-added">  28 import com.sun.javafx.scene.control.behavior.FocusTraversalInputMap;</span>
<span class="line-added">  29 import com.sun.javafx.scene.control.behavior.ListViewBehavior;</span>
<span class="line-added">  30 import com.sun.javafx.scene.control.inputmap.InputMap;</span>
<span class="line-added">  31 import com.sun.javafx.scene.control.inputmap.InputMap.KeyMapping;</span>
<span class="line-added">  32 import com.sun.javafx.scene.control.inputmap.KeyBinding;</span>
<span class="line-added">  33 import com.sun.javafx.tk.Toolkit;</span>
<span class="line-added">  34 </span>
<span class="line-added">  35 import test.com.sun.javafx.scene.control.infrastructure.ControlSkinFactory;</span>
  36 import test.com.sun.javafx.scene.control.infrastructure.KeyModifier;
  37 import test.com.sun.javafx.scene.control.infrastructure.MouseEventFirer;
<a name="2" id="anc2"></a>
  38 import javafx.css.PseudoClass;
  39 
  40 import test.com.sun.javafx.scene.control.infrastructure.KeyEventFirer;
  41 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  42 import javafx.scene.control.skin.ComboBoxListViewSkin;
  43 
  44 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertStyleClassContains;
  45 import static org.junit.Assert.*;
  46 import static org.junit.Assert.assertEquals;
  47 
  48 import java.util.*;
  49 import java.util.concurrent.atomic.AtomicInteger;
  50 
  51 import javafx.beans.property.ObjectProperty;
  52 import javafx.beans.property.SimpleObjectProperty;
  53 import javafx.beans.property.SimpleStringProperty;
  54 import javafx.beans.property.StringProperty;
  55 import javafx.collections.FXCollections;
  56 import javafx.collections.ObservableList;
  57 import javafx.event.ActionEvent;
  58 import javafx.event.EventHandler;
  59 import javafx.scene.Node;
  60 import javafx.scene.Scene;
  61 import javafx.scene.control.Button;
  62 import javafx.scene.control.ComboBox;
  63 import javafx.scene.control.ComboBoxShim;
  64 import javafx.scene.control.IndexedCell;
  65 import javafx.scene.control.Label;
  66 import javafx.scene.control.ListCell;
  67 import javafx.scene.control.ListCellShim;
  68 import javafx.scene.control.ListView;
  69 import javafx.scene.control.SelectionModel;
  70 import javafx.scene.control.SelectionModelShim;
  71 import javafx.scene.control.SingleSelectionModel;
  72 import javafx.scene.control.Tab;
  73 import javafx.scene.control.TabPane;
  74 import javafx.scene.control.TextField;
  75 import javafx.scene.control.Tooltip;
  76 import javafx.scene.control.skin.VirtualFlow;
  77 import javafx.scene.input.KeyCode;
  78 import javafx.scene.layout.BorderPane;
  79 import javafx.scene.layout.FlowPane;
  80 import javafx.scene.layout.VBox;
  81 import javafx.scene.paint.Color;
  82 import javafx.scene.shape.Circle;
  83 import javafx.stage.Stage;
  84 import javafx.util.Callback;
  85 import javafx.util.StringConverter;
  86 
  87 import org.junit.After;
  88 import org.junit.Before;
  89 import org.junit.Ignore;
  90 import org.junit.Test;
  91 
  92 public class ComboBoxTest {
  93     private ComboBox&lt;String&gt; comboBox;
  94     private SingleSelectionModel&lt;String&gt; sm;
  95 
  96     /*********************************************************************
  97      *                                                                   *
  98      * Utility methods                                                   *
  99      *                                                                   *
 100      ********************************************************************/
 101 
 102     public ListView getListView() {
 103         return (ListView) ((ComboBoxListViewSkin)comboBox.getSkin()).getPopupContent();
 104     }
 105 
 106     public Node getDisplayNode() {
 107         return ((ComboBoxListViewSkin)comboBox.getSkin()).getDisplayNode();
 108     }
 109 
 110 
 111 
 112     /*********************************************************************
 113      *                                                                   *
 114      * Setup                                                             *
 115      *                                                                   *
 116      ********************************************************************/
 117 
 118     @Before public void setup() {
 119         Thread.currentThread().setUncaughtExceptionHandler((thread, throwable) -&gt; {
 120             if (throwable instanceof RuntimeException) {
 121                 throw (RuntimeException)throwable;
 122             } else {
 123                 Thread.currentThread().getThreadGroup().uncaughtException(thread, throwable);
 124             }
 125         });
 126 
 127         comboBox = new ComboBox&lt;String&gt;();
 128         comboBox.setSkin(new ComboBoxListViewSkin&lt;&gt;(comboBox));
 129         sm = comboBox.getSelectionModel();
 130     }
 131 
 132     @After public void cleanup() {
 133         Thread.currentThread().setUncaughtExceptionHandler(null);
 134     }
 135 
 136     /*********************************************************************
 137      *                                                                   *
 138      * Tests for the constructors                                        *
 139      *                                                                   *
 140      ********************************************************************/
 141 
 142     @Test public void noArgConstructorSetsTheStyleClass() {
 143         assertStyleClassContains(comboBox, &quot;combo-box&quot;);
 144     }
 145 
 146     @Test public void noArgConstructorSetsNonNullSelectionModel() {
 147         assertNotNull(sm);
 148     }
 149 
 150     @Test public void noArgConstructorSetsNonNullItems() {
 151         assertNotNull(comboBox.getItems());
 152     }
 153 
 154     @Test public void noArgConstructor_selectedItemIsNull() {
 155         assertNull(sm.getSelectedItem());
 156     }
 157 
 158     @Test public void noArgConstructor_selectedIndexIsNegativeOne() {
 159         assertEquals(-1, sm.getSelectedIndex());
 160     }
 161 
 162     @Test public void noArgConstructor_valueIsNull() {
 163         assertNull(comboBox.getValue());
 164     }
 165 
 166     @Test public void noArgConstructor_editableIsFalse() {
 167         assertFalse(comboBox.isEditable());
 168     }
 169 
 170     @Test public void noArgConstructor_showingIsFalse() {
 171         assertFalse(comboBox.isShowing());
 172     }
 173 
 174     @Test public void noArgConstructor_promptTextIsEmptyString() {
 175         assertNull(comboBox.getPromptText());
 176     }
 177 
 178     @Test public void noArgConstructor_placeholderIsNull() {
 179         assertNull(comboBox.getPlaceholder());
 180     }
 181 
 182     @Test public void noArgConstructor_armedIsFalse() {
 183         assertFalse(comboBox.isArmed());
 184     }
 185 
 186     @Test public void noArgConstructor_converterIsNotNull() {
 187         assertNotNull(comboBox.getConverter());
 188     }
 189 
 190     @Test public void noArgConstructor_cellFactoryIsNull() {
 191         assertNull(comboBox.getCellFactory());
 192     }
 193 
 194     @Test public void noArgConstructor_visibleRowFactoryIs10() {
 195         assertEquals(10, comboBox.getVisibleRowCount());
 196     }
 197 
 198     @Test public void singleArgConstructorSetsTheStyleClass() {
 199         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 200         assertStyleClassContains(b2, &quot;combo-box&quot;);
 201     }
 202 
 203     @Test public void singleArgConstructorSetsNonNullSelectionModel() {
 204         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 205         assertNotNull(b2.getSelectionModel());
 206     }
 207 
 208     @Test public void singleArgConstructorAllowsNullItems() {
 209         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(null);
 210         assertNull(b2.getItems());
 211     }
 212 
 213     @Test public void singleArgConstructorTakesItems() {
 214         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;Hi&quot;);
 215         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(items);
 216         assertSame(items, b2.getItems());
 217     }
 218 
 219     @Test public void singleArgConstructor_selectedItemIsNull() {
 220         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 221         assertNull(b2.getSelectionModel().getSelectedItem());
 222     }
 223 
 224     @Test public void singleArgConstructor_selectedIndexIsNegativeOne() {
 225         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 226         assertEquals(-1, b2.getSelectionModel().getSelectedIndex());
 227     }
 228 
 229     @Test public void singleArgConstructor_valueIsNull() {
 230         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 231         assertNull(b2.getValue());
 232     }
 233 
 234     @Test public void singleArgConstructor_editableIsFalse() {
 235         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 236         assertFalse(b2.isEditable());
 237     }
 238 
 239     @Test public void singleArgConstructor_showingIsFalse() {
 240         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 241         assertFalse(b2.isShowing());
 242     }
 243 
 244     @Test public void singleArgConstructor_promptTextIsEmptyString() {
 245         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 246         assertNull(b2.getPromptText());
 247     }
 248 
 249     @Test public void singleArgConstructor_placeholderIsNull() {
 250         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 251         assertNull(b2.getPlaceholder());
 252     }
 253 
 254     @Test public void singleArgConstructor_armedIsFalse() {
 255         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 256         assertEquals(false, b2.isArmed());
 257     }
 258 
 259     @Test public void singleArgConstructor_converterIsNotNull() {
 260         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 261         assertNotNull(b2.getConverter());
 262     }
 263 
 264     @Test public void singleArgConstructor_cellFactoryIsNull() {
 265         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 266         assertNull(b2.getCellFactory());
 267     }
 268 
 269     @Test public void singleArgConstructor_visibleRowFactoryIs10() {
 270         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 271         assertEquals(10, b2.getVisibleRowCount());
 272     }
 273 
 274     /*********************************************************************
 275      * Tests for selection model                                         *
 276      ********************************************************************/
 277 
 278     @Test public void selectionModelCanBeNull() {
 279         comboBox.setSelectionModel(null);
 280         assertNull(comboBox.getSelectionModel());
 281     }
 282 
 283     @Test public void selectionModelCanBeBound() {
 284         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 285         ObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt; other = new SimpleObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt;(sm);
 286         comboBox.selectionModelProperty().bind(other);
 287         assertSame(sm, sm);
 288     }
 289 
 290     @Test public void selectionModelCanBeChanged() {
 291         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 292         comboBox.setSelectionModel(sm);
 293         assertSame(sm, sm);
 294     }
 295 
 296     @Test public void canSetSelectedItemToAnItemEvenWhenThereAreNoItems() {
 297         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 298         sm.select(randomString);
 299         assertEquals(-1, sm.getSelectedIndex());
 300         assertSame(randomString, sm.getSelectedItem());
 301     }
 302 
 303     @Test public void canSetSelectedItemToAnItemNotInTheDataModel() {
 304         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 305         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 306         sm.select(randomString);
 307         assertEquals(-1, sm.getSelectedIndex());
 308         assertSame(randomString, sm.getSelectedItem());
 309     }
 310 
 311     @Test public void settingTheSelectedItemToAnItemInItemsResultsInTheCorrectSelectedIndex() {
 312         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 313         sm.select(&quot;Orange&quot;);
 314         assertEquals(1, sm.getSelectedIndex());
 315         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 316     }
 317 
 318     @Test public void settingTheSelectedItemToANonexistantItemAndThenSettingItemsWhichContainsItResultsInCorrectSelectedIndex() {
 319         sm.select(&quot;Orange&quot;);
 320         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 321         assertEquals(1, sm.getSelectedIndex());
 322         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 323     }
 324 
 325     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex0() {
 326         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 327         sm.select(0);
 328         comboBox.getItems().clear();
 329         assertEquals(-1, sm.getSelectedIndex());
 330         assertEquals(null, sm.getSelectedItem());
 331     }
 332 
 333     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex2() {
 334         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 335         sm.select(2);
 336         comboBox.getItems().clear();
 337         assertEquals(-1, sm.getSelectedIndex());
 338         assertEquals(null, sm.getSelectedItem());
 339     }
 340 
 341     @Test public void ensureSelectedItemRemainsAccurateWhenItemsAreCleared() {
 342         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 343         sm.select(2);
 344         comboBox.getItems().clear();
 345         assertNull(sm.getSelectedItem());
 346         assertEquals(-1, sm.getSelectedIndex());
 347 
 348         comboBox.getItems().addAll(&quot;Kiwifruit&quot;, &quot;Mandarin&quot;, &quot;Pineapple&quot;);
 349         sm.select(2);
 350         assertEquals(&quot;Pineapple&quot;, sm.getSelectedItem());
 351     }
 352 
 353     @Test public void ensureSelectionShiftsDownWhenOneNewItemIsAdded() {
 354         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 355         sm.select(1);
 356         assertEquals(1, sm.getSelectedIndex());
 357         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 358 
 359         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 360         assertEquals(2, sm.getSelectedIndex());
 361         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 362     }
 363 
 364     @Test public void ensureSelectionShiftsDownWhenMultipleNewItemAreAdded() {
 365         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 366         sm.select(1);
 367         assertEquals(1, sm.getSelectedIndex());
 368         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 369 
 370         comboBox.getItems().addAll(0, Arrays.asList(&quot;Kiwifruit&quot;, &quot;Pineapple&quot;, &quot;Mandarin&quot;));
 371         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 372         assertEquals(4, sm.getSelectedIndex());
 373     }
 374 
 375     @Test public void ensureSelectionShiftsUpWhenOneItemIsRemoved() {
 376         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 377         sm.select(1);
 378         assertEquals(1, sm.getSelectedIndex());
 379         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 380 
 381         comboBox.getItems().remove(&quot;Apple&quot;);
 382         assertEquals(0, sm.getSelectedIndex());
 383         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 384     }
 385 
 386     @Test public void ensureSelectionShiftsUpWheMultipleItemsAreRemoved() {
 387         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 388         sm.select(2);
 389         assertEquals(2, sm.getSelectedIndex());
 390         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 391 
 392         comboBox.getItems().removeAll(Arrays.asList(&quot;Apple&quot;, &quot;Orange&quot;));
 393         assertEquals(0, sm.getSelectedIndex());
 394         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 395     }
 396 
 397     @Test public void ensureSelectionIsCorrectWhenItemsChange() {
 398         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 1&quot;));
 399         sm.select(0);
 400         assertEquals(&quot;Item 1&quot;, sm.getSelectedItem());
 401 
 402         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 2&quot;));
 403         assertEquals(-1, sm.getSelectedIndex());
 404         assertEquals(null, sm.getSelectedItem());
 405     }
 406 
 407     @Test(expected=NullPointerException.class)
 408     public void selectionModelComboBoxReferenceCanNotBeNull() {
 409         ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(null);
 410     }
 411 
 412     @Test public void ensureGetModelItemOutOfBoundsWorks_1() {
 413         ComboBox cb = new ComboBox(null);
 414         cb.getSelectionModel().select(-1);
 415         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 416     }
 417 
 418     @Test public void ensureGetModelItemOutOfBoundsWorks_2() {
 419         ComboBox cb = new ComboBox(null);
 420         cb.getSelectionModel().select(0);
 421         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 422     }
 423 
 424     @Test public void test_rt15793() {
 425         // ComboBox selectedIndex is 0 although the items list is empty
 426         final ComboBox lv = new ComboBox();
 427         final ObservableList list = FXCollections.observableArrayList();
 428         lv.setItems(list);
 429         list.add(&quot;toto&quot;);
 430         lv.getSelectionModel().select(0);
 431         assertEquals(0, lv.getSelectionModel().getSelectedIndex());
 432         list.remove(0);
 433         assertEquals(-1, lv.getSelectionModel().getSelectedIndex());
 434     }
 435 
 436     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectIndex() {
 437         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 438         assertNull(comboBox.getValue());
 439         sm.select(0);
 440         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 441     }
 442 
 443     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectItem() {
 444         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 445         assertNull(comboBox.getValue());
 446         sm.select(&quot;Apple&quot;);
 447         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 448     }
 449 
 450     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectPrevious() {
 451         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 452         assertNull(comboBox.getValue());
 453         sm.select(2);
 454         sm.selectPrevious();
 455         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 456     }
 457 
 458     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectNext() {
 459         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 460         assertNull(comboBox.getValue());
 461         sm.select(&quot;Apple&quot;);
 462         sm.selectNext();
 463         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 464     }
 465 
 466     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectFirst() {
 467         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 468         assertNull(comboBox.getValue());
 469         sm.selectFirst();
 470         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 471     }
 472 
 473     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectLast() {
 474         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 475         assertNull(comboBox.getValue());
 476         sm.selectLast();
 477         assertEquals(&quot;Banana&quot;, comboBox.getValue());
 478     }
 479 
 480     @Test public void ensureSelectionModelClearsValueProperty() {
 481         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 482         assertNull(comboBox.getValue());
 483         sm.select(0);
 484         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 485 
 486         sm.clearSelection();
 487         assertNull(comboBox.getValue());
 488     }
 489 
 490     @Test public void ensureSelectionModelClearsValuePropertyWhenNegativeOneSelected() {
 491         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 492         assertNull(comboBox.getValue());
 493         sm.select(0);
 494         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 495 
 496         sm.select(-1);
 497         assertNull(&quot;Expected null, actual value: &quot; + comboBox.getValue(), comboBox.getValue());
 498     }
 499 
 500     @Test public void ensureValueIsCorrectWhenItemsIsAddedToWithExistingSelection() {
 501         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 502         sm.select(1);
 503 
 504         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 505 
 506         assertEquals(2, sm.getSelectedIndex());
 507         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 508         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 509     }
 510 
 511     @Test public void ensureValueIsCorrectWhenItemsAreRemovedWithExistingSelection() {
 512         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 513         sm.select(1);
 514 
 515         comboBox.getItems().remove(&quot;Apple&quot;);
 516 
 517         assertEquals(0, sm.getSelectedIndex());
 518         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 519         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 520     }
 521 
 522     @Test public void ensureValueIsUpdatedByCorrectSelectionModelWhenSelectionModelIsChanged() {
 523         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 524         SingleSelectionModel sm1 = sm;
 525         sm1.select(1);
 526         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 527 
 528         SingleSelectionModel sm2 = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 529         comboBox.setSelectionModel(sm2);
 530 
 531         sm1.select(2);  // value should not change as we are using old SM
 532         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 533 
 534         sm2.select(0);  // value should change, as we are using new SM
 535         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 536     }
 537 
 538     @Test public void ensureValueDoesNotChangeWhenBoundAndNoExceptions() {
 539         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 540 
 541         StringProperty sp = new SimpleStringProperty(&quot;empty&quot;);
 542         comboBox.valueProperty().bind(sp);
 543 
 544         sm.select(1);
 545         assertEquals(&quot;empty&quot;, comboBox.getValue());
 546     }
 547 
 548     @Test public void ensureSelectionModelUpdatesWhenValueChanges() {
 549         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 550         assertNull(sm.getSelectedItem());
 551         comboBox.setValue(&quot;Orange&quot;);
 552         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 553     }
 554 
 555     @Test public void ensureSelectionModelUpdatesWhenValueChangesToNull() {
 556         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 557         comboBox.setValue(&quot;Kiwifruit&quot;);
 558         assertEquals(&quot;Kiwifruit&quot;, sm.getSelectedItem());
 559         assertEquals(&quot;Kiwifruit&quot;, comboBox.getValue());
 560         comboBox.setValue(null);
 561         assertEquals(null, sm.getSelectedItem());
 562         assertEquals(-1, sm.getSelectedIndex());
 563         assertEquals(null, comboBox.getValue());
 564     }
 565 
 566     @Test public void ensureValueEqualsSelectedItemWhenNotInItemsList() {
 567         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 568         SelectionModelShim.setSelectedItem(sm, &quot;pineapple&quot;);
 569         assertEquals(&quot;pineapple&quot;, sm.getSelectedItem());
 570         assertEquals(&quot;pineapple&quot;, comboBox.getValue());
 571     }
 572 
 573     /*********************************************************************
 574      * Tests for default values                                         *
 575      ********************************************************************/
 576 
 577     @Test public void checkPromptTextPropertyName() {
 578         assertTrue(comboBox.promptTextProperty().getName().equals(&quot;promptText&quot;));
 579     }
 580 
 581     @Test public void checkPlaceholderPropertyName() {
 582         assertTrue(comboBox.placeholderProperty().getName().equals(&quot;placeholder&quot;));
 583     }
 584 
 585     @Test public void checkValuePropertyName() {
 586         assertTrue(comboBox.valueProperty().getName().equals(&quot;value&quot;));
 587     }
 588 
 589     @Test public void checkItemsPropertyName() {
 590         assertTrue(comboBox.itemsProperty().getName().equals(&quot;items&quot;));
 591     }
 592 
 593     @Test public void checkConverterPropertyName() {
 594         assertTrue(comboBox.converterProperty().getName().equals(&quot;converter&quot;));
 595     }
 596 
 597     @Test public void checkSelectionModelPropertyName() {
 598         assertTrue(comboBox.selectionModelProperty().getName().equals(&quot;selectionModel&quot;));
 599     }
 600 
 601     @Test public void checkVisibleRowCountPropertyName() {
 602         assertTrue(comboBox.visibleRowCountProperty().getName().equals(&quot;visibleRowCount&quot;));
 603     }
 604 
 605     @Test public void checkOnActionPropertyName() {
 606         assertTrue(comboBox.onActionProperty().getName().equals(&quot;onAction&quot;));
 607     }
 608 
 609     @Test public void checkArmedPropertyName() {
 610         assertTrue(comboBox.armedProperty().getName().equals(&quot;armed&quot;));
 611     }
 612 
 613     @Test public void checkShowingPropertyName() {
 614         assertTrue(comboBox.showingProperty().getName().equals(&quot;showing&quot;));
 615     }
 616 
 617     @Test public void checkEditablePropertyName() {
 618         assertTrue(comboBox.editableProperty().getName().equals(&quot;editable&quot;));
 619     }
 620 
 621     @Test public void checkCellFactoryPropertyName() {
 622         assertTrue(comboBox.cellFactoryProperty().getName().equals(&quot;cellFactory&quot;));
 623     }
 624 
 625     @Test public void defaultActionHandlerIsNotDefined() {
 626         assertNull(comboBox.getOnAction());
 627     }
 628 
 629     @Test public void defaultConverterCanHandleStringValues() {
 630         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 631         assertEquals(&quot;input&quot;, sc.fromString(&quot;input&quot;));
 632         assertEquals(&quot;input&quot;, sc.toString(&quot;input&quot;));
 633     }
 634 
 635     @Test public void defaultConverterCanHandleIncorrectType_1() {
 636         ComboBox cb = new ComboBox();
 637         StringConverter sc = cb.getConverter();
 638         assertEquals(&quot;42&quot;, sc.toString(new Integer(42)));
 639     }
 640 
 641     @Test(expected=ClassCastException.class)
 642     public void defaultConverterCanHandleIncorrectType_2() {
 643         ComboBox&lt;Integer&gt; cb = new ComboBox&lt;Integer&gt;();
 644         StringConverter&lt;Integer&gt; sc = cb.getConverter();
 645         Integer value = sc.fromString(&quot;42&quot;);
 646     }
 647 
 648     @Test public void defaultConverterCanHandleNullValues() {
 649         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 650         assertEquals(null, sc.fromString(null));
 651         assertEquals(null, sc.toString(null));
 652     }
 653 
 654     @Test public void ensureImpl_getPseudoClassStateReturnsValidValue() {
 655         Stage stage = new Stage();
 656         Scene scene = new Scene(comboBox);
 657         stage.setScene(scene);
 658 
 659         Set&lt;PseudoClass&gt; pseudoClassStates = comboBox.getPseudoClassStates();
 660         assertFalse(comboBox.isEditable());
 661         assertTrue(pseudoClassStates.size() &gt;= 0);
 662 
 663         comboBox.setEditable(true);
 664         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)));
 665 
 666         comboBox.setEditable(false);
 667         assertFalse(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)));
 668 
 669         comboBox.show();
 670         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)));
 671 
 672         comboBox.hide();
 673         assertFalse(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)));
 674 
 675         comboBox.arm();
 676         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;armed&quot;)));
 677 
 678     }
 679 
 680     /*********************************************************************
 681      * Tests for properties                                              *
 682      ********************************************************************/
 683 
 684     @Test public void ensureAllowsNullConverter() {
 685         comboBox.setConverter(null);
 686         assertNull(comboBox.getConverter());
 687     }
 688 
 689     @Test public void ensureCanSetNonNullCellFactory() {
 690         Callback&lt;ListView&lt;String&gt;, ListCell&lt;String&gt;&gt; cf = p -&gt; null;
 691         comboBox.setCellFactory(cf);
 692         assertEquals(cf, comboBox.getCellFactory());
 693     }
 694 
 695     @Test public void ensureEditorIsNonNullWhenComboBoxIsNotEditable() {
 696         assertNotNull(comboBox.getEditor());
 697     }
 698 
 699     @Test public void ensureEditorIsNonNullWhenComboBoxIsEditable() {
 700         comboBox.setEditable(true);
 701         assertNotNull(comboBox.getEditor());
 702     }
 703 
 704     @Test public void ensureEditorDoesNotChangeWhenEditableToggles() {
 705         comboBox.setEditable(true);
 706         assertNotNull(comboBox.getEditor());
 707         comboBox.setEditable(false);
 708         assertNotNull(comboBox.getEditor());
 709         comboBox.setEditable(true);
 710         assertNotNull(comboBox.getEditor());
 711     }
 712 
 713     @Test public void ensureCanSetValueToNonNullStringAndBackAgain() {
 714         comboBox.setValue(&quot;Test 123&quot;);
 715         assertEquals(&quot;Test 123&quot;, comboBox.getValue());
 716         comboBox.setValue(null);
 717         assertNull(comboBox.getValue());
 718     }
 719 
 720     @Test public void ensureCanToggleEditable() {
 721         comboBox.setEditable(true);
 722         assertTrue(comboBox.isEditable());
 723         comboBox.setEditable(false);
 724         assertFalse(comboBox.isEditable());
 725     }
 726 
 727     @Test public void ensureCanToggleShowing() {
 728         Stage stage = new Stage();
 729         Scene scene = new Scene(comboBox);
 730         stage.setScene(scene);
 731 
 732         comboBox.show();
 733         assertTrue(comboBox.isShowing());
 734         comboBox.hide();
 735         assertFalse(comboBox.isShowing());
 736     }
 737 
 738     @Test public void ensureCanNotToggleShowingWhenDisabled() {
 739         Stage stage = new Stage();
 740         Scene scene = new Scene(comboBox);
 741         stage.setScene(scene);
 742 
 743         comboBox.setDisable(true);
 744         comboBox.show();
 745         assertFalse(comboBox.isShowing());
 746         comboBox.setDisable(false);
 747         comboBox.show();
 748         assertTrue(comboBox.isShowing());
 749     }
 750 
 751     @Test public void ensureCanSetPromptText() {
 752         comboBox.setPromptText(&quot;Test 1 2 3&quot;);
 753         assertEquals(&quot;Test 1 2 3&quot;, comboBox.getPromptText());
 754     }
 755 
 756     @Test public void ensureCanSetPromptTextToNull() {
 757         comboBox.setPromptText(&quot;&quot;);
 758         assertEquals(&quot;&quot;, comboBox.getPromptText());
 759         comboBox.setPromptText(null);
 760         assertEquals(null, comboBox.getPromptText());
 761     }
 762 
 763     @Test public void ensurePromptTextStripsNewlines() {
 764         comboBox.setPromptText(&quot;Test\n1\n2\n3&quot;);
 765         assertEquals(&quot;Test123&quot;, comboBox.getPromptText());
 766     }
 767 
 768     @Test public void ensureCanSetPlaceholder() {
 769         Label label = new javafx.scene.control.Label(&quot;Test 1 2 3&quot;);
 770         comboBox.setPlaceholder(label);
 771         assertEquals(label, comboBox.getPlaceholder());
 772     }
 773 
 774     @Test public void ensureCanToggleArmed() {
 775         assertFalse(comboBox.isArmed());
 776         comboBox.arm();
 777         assertTrue(comboBox.isArmed());
 778         comboBox.disarm();
 779         assertFalse(comboBox.isArmed());
 780     }
 781 
 782     @Test public void ensureCanSetVisibleRowCount() {
 783         comboBox.setVisibleRowCount(13);
 784         assertEquals(13, comboBox.getVisibleRowCount());
 785     }
 786 
 787     @Test public void ensureCanSetVisibleRowCountToNegativeValues() {
 788         comboBox.setVisibleRowCount(-10);
 789         assertEquals(-10, comboBox.getVisibleRowCount());
 790     }
 791 
 792     @Test public void ensureCanSetOnAction() {
 793         EventHandler&lt;ActionEvent&gt; onAction = t -&gt; { };
 794         comboBox.setOnAction(onAction);
 795         assertEquals(onAction, comboBox.getOnAction());
 796     }
 797 
 798     @Test public void ensureOnActionPropertyReferencesBean() {
 799         assertEquals(comboBox, comboBox.onActionProperty().getBean());
 800     }
 801 
 802     /*********************************************************************
 803      * Tests for property binding                                        *
 804      ********************************************************************/
 805     @Test public void checkPromptTextPropertyBind() {
 806         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 807         comboBox.promptTextProperty().bind(strPr);
 808         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;value&quot;));
 809         strPr.setValue(&quot;newvalue&quot;);
 810         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;newvalue&quot;));
 811     }
 812 
 813     @Test public void checkValuePropertyBind() {
 814         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 815         comboBox.valueProperty().bind(strPr);
 816         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;value&quot;));
 817         strPr.setValue(&quot;newvalue&quot;);
 818         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;newvalue&quot;));
 819     }
 820 
 821 
 822 
 823     /*********************************************************************
 824      * Tests for bug reports                                             *
 825      ********************************************************************/
 826 
 827     @Test public void test_rt18972() {
 828         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 829         sm.select(1);
 830         assertTrue(sm.isSelected(1));
 831 
 832         comboBox.setEditable(true);
 833         comboBox.setValue(&quot;New Value&quot;);
 834 
 835         // there should be no selection in the selection model, as &quot;New Value&quot;
 836         // isn&#39;t an item in the list, however, it is a totally valid value for
 837         // the value property
 838         assertFalse(sm.isSelected(1));
 839         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 840         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 841 
 842         comboBox.setEditable(false);
 843         assertEquals(-1, sm.getSelectedIndex());
 844         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 845         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 846     }
 847 
 848     @Test public void test_rt18941() {
 849         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 850         comboBox.setValue(&quot;Orange&quot;);
 851         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 852         assertEquals(&quot;Orange&quot;, comboBox.getSelectionModel().getSelectedItem());
 853         assertTrue(&quot;Selected Index: &quot; + sm.getSelectedIndex(), sm.isSelected(1));
 854     }
 855 
 856     @Test public void test_rt19227() {
 857         comboBox.getItems().addAll(&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;);
 858         comboBox.getSelectionModel().select(2);
 859         assertEquals(&quot;0&quot;, comboBox.getValue());
 860         assertEquals(&quot;0&quot;, comboBox.getSelectionModel().getSelectedItem());
 861         assertTrue(sm.isSelected(2));
 862     }
 863 
 864     @Ignore(&quot;JDK-8091127 Test not working as the heights being returned are not accurate&quot;)
 865     @Test public void test_rt20106() {
 866         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 867 
 868         Stage stage = new Stage();
 869         Scene scene = new Scene(comboBox);
 870         stage.setScene(scene);
 871         comboBox.applyCss();
 872         comboBox.show();
 873 
 874         comboBox.setVisibleRowCount(5);
 875         double initialHeight = getListView().getHeight();
 876         assertFalse(&quot;initialHeight: &quot; + initialHeight, Double.compare(0.0, initialHeight) == 0);
 877 
 878         comboBox.setVisibleRowCount(0);
 879         double smallHeight =    getListView().getHeight();
 880         assertTrue(&quot;smallHeight: &quot; + smallHeight + &quot;, initialHeight: &quot; + initialHeight,
 881                 smallHeight != initialHeight &amp;&amp; smallHeight &lt; initialHeight);
 882 
 883         comboBox.setVisibleRowCount(7);
 884         double biggerHeight = getListView().getHeight();
 885         assertTrue(biggerHeight != smallHeight &amp;&amp; smallHeight &lt; biggerHeight);
 886     }
 887 
 888     private int count = 0;
 889     @Test public void test_rt20103() {
 890         final TextField tf = new TextField();
 891 
 892         comboBox.setOnAction(t -&gt; {
 893             count++;
 894         });
 895 
 896         assertTrue(count == 0);
 897 
 898         comboBox.valueProperty().bind(tf.textProperty());   // count++ here
 899         assertTrue(&quot;count: &quot; + count, count == 1);
 900 
 901         tf.setText(&quot;Text1&quot;);                                // count++ here
 902         assertTrue(&quot;count: &quot; + count, count == 2);
 903 
 904         comboBox.valueProperty().unbind();                  // no count++ here
 905         assertTrue(&quot;count: &quot; + count, count == 2);
 906 
 907         comboBox.valueProperty().bindBidirectional(tf.textProperty());  // count++ here
 908         tf.setText(&quot;Text2&quot;);
 909         assertTrue(&quot;count: &quot; + count, count == 3);
 910     }
 911 
 912     @Ignore(&quot;Test not working as the skin is not being properly instantiated&quot;)
 913     @Test public void test_rt20100() {
 914         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 915 
 916         Stage stage = new Stage();
 917         Scene scene = new Scene(comboBox);
 918         stage.setScene(scene);
 919         comboBox.applyCss();
 920         comboBox.show();
 921 
 922         comboBox.setConverter(new StringConverter() {
 923             int toStringCounter = 0;
 924             int fromStringCounter = 0;
 925 
 926             @Override public String toString(Object t) {
 927                 return &quot;TO_STRING&quot;;
 928             }
 929 
 930             @Override public Object fromString(String string) {
 931                 return &quot;FROM_STRING&quot;;
 932             }
 933         });
 934 
 935         comboBox.getSelectionModel().select(2);
 936         assertEquals(&quot;2&quot;, comboBox.getValue());
 937 
 938         ListView listView = getListView();
 939 //        listView.applyCss();
 940 
 941         assertEquals(&quot;2&quot;, listView.getSelectionModel().getSelectedItem());
 942 
 943         System.out.println(listView.getSkin());
 944 
 945         VirtualFlow flow = (VirtualFlow)listView.lookup(&quot;#virtual-flow&quot;);
 946         assertNotNull(flow);
 947 
 948         IndexedCell cell = flow.getVisibleCell(2);
 949         System.out.println(&quot;cell: &quot; + cell);
 950         assertEquals(&quot;TO_STRING&quot;, cell.getText());
 951     }
 952 
 953     @Test public void test_rt20189() {
 954         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 955 
 956         Stage stage = new Stage();
 957         Scene scene = new Scene(comboBox);
 958         stage.setScene(scene);
 959         comboBox.applyCss();
 960         comboBox.show();
 961 
 962         comboBox.getSelectionModel().select(2);
 963         Object item = sm.getSelectedItem();
 964         assertEquals(&quot;2&quot;, item);
 965         assertEquals(2, sm.getSelectedIndex());
 966 
 967         comboBox.setValue(&quot;test&quot;);
 968         item = sm.getSelectedItem();
 969         assertEquals(&quot;test&quot;,item);
 970         assertEquals(-1, sm.getSelectedIndex());
 971 
 972         comboBox.getSelectionModel().select(2);
 973         item = sm.getSelectedItem();
 974         assertEquals(&quot;2&quot;, item);
 975         assertEquals(2, sm.getSelectedIndex());
 976     }
 977 
 978     @Test public void test_rt27654() {
 979         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 980 
 981         SingleSelectionModel sm = comboBox.getSelectionModel();
 982 
 983         Stage stage = new Stage();
 984         Scene scene = new Scene(comboBox);
 985         stage.setScene(scene);
 986         comboBox.applyCss();
 987         comboBox.show();
 988         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
 989 
 990         sm.select(2);
 991         assertEquals(&quot;2&quot;, sm.getSelectedItem());
 992         assertEquals(&quot;2&quot;, comboBox.getValue());
 993         assertEquals(&quot;2&quot;, buttonCell.getText());
 994         assertEquals(2, sm.getSelectedIndex());
 995 
 996         sm.clearSelection();
 997         assertNull(sm.getSelectedItem());
 998         assertNull(comboBox.getValue());
 999         assertNull(buttonCell.getText());
1000         assertEquals(-1, sm.getSelectedIndex());
1001 
1002         sm.select(2);
1003         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1004         assertEquals(&quot;2&quot;, comboBox.getValue());
1005         assertEquals(&quot;2&quot;, buttonCell.getText());
1006         assertEquals(2, sm.getSelectedIndex());
1007     }
1008 
1009     @Test public void test_rt24412() {
1010         SingleSelectionModel sm = comboBox.getSelectionModel();
1011 
1012         Stage stage = new Stage();
1013         Scene scene = new Scene(comboBox);
1014         stage.setScene(scene);
1015         comboBox.applyCss();
1016         comboBox.show();
1017         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
1018 
1019         comboBox.getItems().setAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
1020 
1021         sm.select(&quot;2&quot;);
1022         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1023         assertEquals(&quot;2&quot;, comboBox.getValue());
1024         assertEquals(&quot;2&quot;, buttonCell.getText());
1025         assertEquals(2, sm.getSelectedIndex());
1026 
1027         sm.clearSelection();
1028         assertNull(sm.getSelectedItem());
1029         assertNull(comboBox.getValue());
1030         assertNull(buttonCell.getText());
1031         assertEquals(-1, sm.getSelectedIndex());
1032 
1033         sm.select(&quot;2&quot;);
1034         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1035         assertEquals(&quot;2&quot;, comboBox.getValue());
1036         assertEquals(&quot;2&quot;, buttonCell.getText());
1037         assertEquals(2, sm.getSelectedIndex());
1038     }
1039 
1040     @Test public void test_rt28245() {
1041         final ObservableList&lt;String&gt; strings = FXCollections.observableArrayList(
1042             &quot;Option 1&quot;, &quot;Option 2&quot;, &quot;Option 3&quot;
1043         );
1044 
1045         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1046         comboBox.setItems(strings);
1047         comboBox.setEditable(true);
1048         comboBox.valueProperty().addListener((ov, t, t1) -&gt; {
1049             if (t == null &amp;&amp; t1.isEmpty()) {
1050                 fail(&quot;Old value is &#39;&quot; + t + &quot;&#39; and new value is &#39;&quot; + t1 + &quot;&#39;.&quot;);
1051             }
1052         });
1053 
1054         StageLoader sl = new StageLoader(comboBox);
1055 
1056         assertNull(comboBox.getValue());
1057         assertTrue(comboBox.getEditor().getText().isEmpty());
1058 
1059         comboBox.requestFocus();
1060 
1061         new KeyEventFirer(comboBox).doKeyPress(KeyCode.ENTER);
1062 
1063         sl.dispose();
1064     }
1065 
1066     @Test public void test_rt31479() {
1067         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1068 
1069         StageLoader sl = new StageLoader(comboBox);
1070 
1071         final double widthBefore = comboBox.getWidth();
1072 
1073         // add item
1074         comboBox.getItems().add(&quot;Option 1&quot;);
1075 
1076         // open and close combobox
1077         comboBox.show();
1078         comboBox.hide();
1079 
1080         // set a placeholder
1081         comboBox.setPlaceholder(new Circle(12, Color.RED));
1082 
1083         // remove item
1084         comboBox.getItems().clear();
1085 
1086         // fire pulse (this allows layout to cause the size to grow)
1087         Toolkit.getToolkit().firePulse();
1088 
1089         // test size
1090         assertEquals(widthBefore, comboBox.getWidth(), 0.00);
1091 
1092         sl.dispose();
1093     }
1094 
1095     @Test public void test_rt32139() {
1096         final ObservableList&lt;String&gt; items =
1097                 FXCollections.observableArrayList(&quot;Good value&quot;, &quot;Bad value&quot;);
1098 
1099         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1100         comboBox.getSelectionModel().select(0);
1101 
1102         comboBox.getSelectionModel().selectedIndexProperty().addListener((ov, oldIdx, newIdx) -&gt; {
1103             if (newIdx.intValue() != 0) {
1104                 comboBox.getSelectionModel().select(0);
1105             }
1106         });
1107 
1108         StageLoader sl = new StageLoader(comboBox);
1109 
1110         try {
1111             comboBox.getSelectionModel().select(1);
1112         } catch (StackOverflowError e) {
1113             fail(&quot;Stack overflow should not happen here&quot;);
1114         }
1115 
1116         sl.dispose();
1117     }
1118 
1119     @Test public void test_rt21186() {
1120         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1121         comboBox.setEditable(true);
1122 
1123         StageLoader sl = new StageLoader(comboBox);
1124 
1125         assertNull(comboBox.getTooltip());
1126         assertNull(comboBox.getEditor().getTooltip());
1127 
1128         Tooltip tooltip = new Tooltip(&quot;Tooltip&quot;);
1129         comboBox.setTooltip(tooltip);
1130         assertEquals(tooltip, comboBox.getTooltip());
1131         assertEquals(tooltip, comboBox.getEditor().getTooltip());
1132 
1133         comboBox.setTooltip(null);
1134         assertNull(comboBox.getTooltip());
1135         assertNull(comboBox.getEditor().getTooltip());
1136 
1137         sl.dispose();
1138     }
1139 
1140     @Test public void test_rt34573() {
1141         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1142 
1143         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1144             @Override public void updateItem(String item, boolean empty) {
1145                 super.updateItem(item, empty);
1146                 setText(item);
1147             }
1148         };
1149         comboBox.setButtonCell(customCell);
1150 
1151         StageLoader sl = new StageLoader(comboBox);
1152 
1153         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1154         comboBox.setValue(&quot;B&quot;);
1155         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1156         assertEquals(1, comboBox.getButtonCell().getIndex());
1157 
1158         comboBox.setItems(FXCollections.observableArrayList(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;));
1159         assertNull(comboBox.getButtonCell().getText());
1160         assertEquals(-1, comboBox.getButtonCell().getIndex());
1161 
1162         sl.dispose();
1163     }
1164 
1165     @Test public void test_rt34566() {
1166         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1167 
1168         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1169             @Override public void updateItem(String item, boolean empty) {
1170                 super.updateItem(item, empty);
1171                 setText(item);
1172             }
1173         };
1174         comboBox.setButtonCell(customCell);
1175 
1176         StageLoader sl = new StageLoader(comboBox);
1177 
1178         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1179 
1180         PseudoClass empty = PseudoClass.getPseudoClass(&quot;empty&quot;);
1181 
1182         comboBox.setValue(&quot;B&quot;);
1183         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1184         assertEquals(1, comboBox.getButtonCell().getIndex());
1185         assertFalse(customCell.getPseudoClassStates().contains(empty));
1186 
1187         comboBox.setValue(null);
1188         Toolkit.getToolkit().firePulse();
1189         assertNull(comboBox.getButtonCell().getText());
1190         assertEquals(-1, comboBox.getButtonCell().getIndex());
1191         assertTrue(customCell.getPseudoClassStates().contains(empty));
1192 
1193         comboBox.setValue(&quot;A&quot;);
1194         assertEquals(&quot;A&quot;, comboBox.getButtonCell().getText());
1195         assertEquals(0, comboBox.getButtonCell().getIndex());
1196         assertFalse(customCell.getPseudoClassStates().contains(empty));
1197 
1198         sl.dispose();
1199     }
1200 
1201     private int test_rt34603_count = 0;
1202     @Test public void test_rt34603() {
1203         assertEquals(0, test_rt34603_count);
1204 
1205         VBox hbox = new VBox(10);
1206 
1207         ComboBox&lt;String&gt; box = new ComboBox&lt;&gt;();
1208         box.getItems().add(&quot;test&quot;);
1209         box.setEditable(true);
1210         box.getSelectionModel().selectFirst();
1211 
1212         Button defaultButton = new Button(&quot;press&quot;);
1213         defaultButton.setOnAction(arg0 -&gt; {
1214             test_rt34603_count++;
1215         });
1216         defaultButton.setDefaultButton(true);
1217 
1218         hbox.getChildren().addAll(box, defaultButton);
1219 
1220         StageLoader sl = new StageLoader(hbox);
1221 
1222         box.getEditor().requestFocus();
1223         KeyEventFirer keyboard = new KeyEventFirer(box);
1224         keyboard.doKeyPress(KeyCode.ENTER);
1225 
1226         assertEquals(1, test_rt34603_count);
1227 
1228         sl.dispose();
1229     }
1230 
1231     private int test_rt35586_count = 0;
1232     @Test public void test_rt35586() {
1233         assertEquals(0, test_rt35586_count);
1234 
1235         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1236         cb.setEditable(true);
1237         cb.setOnAction(event -&gt; {
1238             test_rt35586_count++;
1239             assertEquals(&quot;Test&quot;, cb.getEditor().getText());
1240         });
1241 
1242         StageLoader sl = new StageLoader(cb);
1243 
1244         cb.requestFocus();
1245         cb.getEditor().setText(&quot;Test&quot;);
1246         KeyEventFirer keyboard = new KeyEventFirer(cb);
1247         keyboard.doKeyPress(KeyCode.ENTER);
1248 
1249         assertEquals(1, test_rt35586_count);
1250 
1251         sl.dispose();
1252     }
1253 
1254     @Test public void test_rt35039() {
1255         final List&lt;String&gt; data = new ArrayList&lt;&gt;();
1256         data.add(&quot;aabbaa&quot;);
1257         data.add(&quot;bbc&quot;);
1258 
1259         final ComboBox&lt;String&gt; combo = new ComboBox&lt;&gt;();
1260         combo.setEditable(true);
1261         combo.setItems(FXCollections.observableArrayList(data));
1262 
1263         StageLoader sl = new StageLoader(combo);
1264 
1265         // everything should be null to start with
1266         assertNull(combo.getValue());
1267         assertTrue(combo.getEditor().getText().isEmpty());
1268         assertNull(combo.getSelectionModel().getSelectedItem());
1269 
1270         // select &quot;bbc&quot; and ensure everything is set to that
1271         combo.getSelectionModel().select(1);
1272         assertEquals(&quot;bbc&quot;, combo.getValue());
1273         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1274         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1275 
1276         // change the items list - but retain the same content. We expect
1277         // that &quot;bbc&quot; remains selected as it is still in the list
1278         combo.setItems(FXCollections.observableArrayList(data));
1279         assertEquals(&quot;bbc&quot;, combo.getValue());
1280         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1281         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1282 
1283         sl.dispose();
1284     }
1285 
1286     @Test public void test_rt35840() {
1287         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1288         cb.setEditable(true);
1289         StageLoader sl = new StageLoader(cb);
1290         cb.requestFocus();
1291 
1292         KeyEventFirer keyboard = new KeyEventFirer(cb);
1293         keyboard.doKeyTyped(KeyCode.T);
1294         keyboard.doKeyTyped(KeyCode.E);
1295         keyboard.doKeyTyped(KeyCode.S);
1296         keyboard.doKeyTyped(KeyCode.T);
1297         assertEquals(&quot;TEST&quot;, cb.getEditor().getText());
1298 
1299         assertNull(cb.getValue());
1300         keyboard.doKeyPress(KeyCode.ENTER);
1301         assertEquals(&quot;TEST&quot;, cb.getValue());
1302 
1303         sl.dispose();
1304     }
1305 
1306     @Test public void test_rt36280_nonEditable_F4ShowsPopup() {
1307         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1308         StageLoader sl = new StageLoader(cb);
1309         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1310 
1311         assertFalse(cb.isShowing());
1312         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1313         assertTrue(cb.isShowing());
1314 
1315         sl.dispose();
1316     }
1317 
1318     @Test public void test_rt36280_nonEditable_altUpShowsPopup() {
1319         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1320         StageLoader sl = new StageLoader(cb);
1321         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1322 
1323         assertFalse(cb.isShowing());
1324         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1325         assertTrue(cb.isShowing());
1326 
1327         sl.dispose();
1328     }
1329 
1330     @Test public void test_rt36280_nonEditable_altDownShowsPopup() {
1331         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1332         StageLoader sl = new StageLoader(cb);
1333         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1334 
1335         new StageLoader(cb);
1336 
1337         assertFalse(cb.isShowing());
1338         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1339         assertTrue(cb.isShowing());
1340 
1341         sl.dispose();
1342     }
1343 
1344     @Test public void test_EditorKeyInputsWhenPopupIsShowing() {
1345         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1346         cb.setEditable(true);
1347         StageLoader sl = new StageLoader(cb);
1348         KeyEventFirer keyboard = new KeyEventFirer(cb);
1349 
<a name="3" id="anc3"></a>

1350         // Show the popup
1351         assertFalse(cb.isShowing());
1352         cb.requestFocus();
1353         cb.getEditor().setText(&quot;ABC DEF&quot;);
1354         assertEquals(&quot;ABC DEF&quot;, cb.getEditor().getText());
1355         keyboard.doDownArrowPress(KeyModifier.ALT);
1356         // Sanity
1357         assertTrue(cb.isShowing());
1358         assertEquals(0, cb.getEditor().getCaretPosition());
1359 
1360         // LEFT, RIGHT keys with CTRL, SHIFT modifiers
1361         // Test RIGHT key
1362         keyboard.doRightArrowPress();
1363         assertEquals(1, cb.getEditor().getCaretPosition());
1364 
1365         // Test KP_RIGHT key
1366         keyboard.doKeyPress(KeyCode.KP_RIGHT);
1367         assertEquals(2, cb.getEditor().getCaretPosition());
1368 
1369         // Test LEFT key
1370         keyboard.doLeftArrowPress();
1371         assertEquals(1, cb.getEditor().getCaretPosition());
1372 
1373         // Test KP_LEFT key
1374         keyboard.doKeyPress(KeyCode.KP_LEFT);
1375         assertEquals(0, cb.getEditor().getCaretPosition());
1376 
1377         // Test SHIFT + RIGHT key
1378         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);
1379         assertEquals(&quot;A&quot;, cb.getEditor().getSelectedText());
1380         assertEquals(1, cb.getEditor().getCaretPosition());
1381 
1382         // Test SHIFT + LEFT key
1383         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT);
1384         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1385         assertEquals(0, cb.getEditor().getCaretPosition());
1386 
1387         // Test CTRL + RIGHT key
1388         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.CTRL);
1389         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1390         assertEquals(4, cb.getEditor().getCaretPosition());
1391 
1392         // Test CTRL + LEFT key
1393         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.CTRL);
1394         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1395         assertEquals(0, cb.getEditor().getCaretPosition());
1396 
1397         // Test CTRL + SHIFT + RIGHT key
1398         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.CTRL, KeyModifier.SHIFT);
1399         assertEquals(&quot;ABC &quot;, cb.getEditor().getSelectedText());
1400         assertEquals(4, cb.getEditor().getCaretPosition());
1401 
1402         // Test CTRL + SHIFT + LEFT key
1403         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.CTRL, KeyModifier.SHIFT);
1404         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1405         assertEquals(0, cb.getEditor().getCaretPosition());
1406 
1407         // HOME, END keys with CTRL, SHIFT modifiers
1408         // Test END key
1409         keyboard.doKeyPress(KeyCode.END);
1410         assertEquals(7, cb.getEditor().getCaretPosition());
1411 
1412         // Test HOME key
1413         keyboard.doKeyPress(KeyCode.HOME);
1414         assertEquals(0, cb.getEditor().getCaretPosition());
1415 
1416         // Test SHIFT + END key
1417         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
1418         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());
1419         assertEquals(7, cb.getEditor().getCaretPosition());
1420 
1421         // Test SHIFT + HOME key
1422         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
1423         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1424         assertEquals(0, cb.getEditor().getCaretPosition());
1425 
1426         // Test CTRL + END key
1427         keyboard.doKeyPress(KeyCode.END, KeyModifier.CTRL);
1428         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1429         assertEquals(7, cb.getEditor().getCaretPosition());
1430 
1431         // Test CTRL + HOME key
1432         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.CTRL);
1433         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1434         assertEquals(0, cb.getEditor().getCaretPosition());
1435 
<a name="4" id="anc4"></a>
1436         // Test CTRL + SHIFT + END key
1437         keyboard.doKeyPress(KeyCode.END, KeyModifier.CTRL, KeyModifier.SHIFT);
1438         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());
1439         assertEquals(7, cb.getEditor().getCaretPosition());
1440 
1441         // Test CTRL + SHIFT + HOME key
1442         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.CTRL, KeyModifier.SHIFT);
1443         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1444         assertEquals(0, cb.getEditor().getCaretPosition());
<a name="5" id="anc5"></a>
1445 
1446         // Test CTRL + A key
1447         keyboard.doLeftArrowPress();
1448         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1449         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
1450         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());
1451 
1452         // Sanity
1453         assertTrue(cb.isShowing());
1454 
1455         sl.dispose();
1456     }
1457 
<a name="6" id="anc6"></a><span class="line-added">1458     @Test public void testExcludeKeyMappingsForComboBoxEditor() {</span>
<span class="line-added">1459         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));</span>
<span class="line-added">1460         StageLoader sl = new StageLoader(cb);</span>
<span class="line-added">1461 </span>
<span class="line-added">1462         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();</span>
<span class="line-added">1463         ListViewBehavior lvBehavior = (ListViewBehavior)ControlSkinFactory.getBehavior(listView.getSkin());</span>
<span class="line-added">1464         InputMap&lt;ListView&lt;?&gt;&gt; lvInputMap = lvBehavior.getInputMap();</span>
<span class="line-added">1465         // In ListViewBehavior KeyMappings for vertical orientation are added under 3rd child InputMap</span>
<span class="line-added">1466         InputMap&lt;ListView&lt;?&gt;&gt; verticalInputMap = lvInputMap.getChildInputMaps().get(2);</span>
<span class="line-added">1467 </span>
<span class="line-added">1468         // Verify FocusTraversalInputMap</span>
<span class="line-added">1469         for(InputMap.Mapping&lt;?&gt; mapping : FocusTraversalInputMap.getFocusTraversalMappings()) {</span>
<span class="line-added">1470             assertFalse(lvInputMap.getMappings().contains(mapping));</span>
<span class="line-added">1471         }</span>
<span class="line-added">1472 </span>
<span class="line-added">1473         // Verify default InputMap</span>
<span class="line-added">1474         assertFalse(lvInputMap.getMappings().contains(</span>
<span class="line-added">1475                 new KeyMapping(new KeyBinding(KeyCode.HOME), null)));</span>
<span class="line-added">1476         assertFalse(lvInputMap.getMappings().contains(</span>
<span class="line-added">1477                 new KeyMapping(new KeyBinding(KeyCode.END), null)));</span>
<span class="line-added">1478         assertFalse(lvInputMap.getMappings().contains(</span>
<span class="line-added">1479                 new KeyMapping(new KeyBinding(KeyCode.HOME).shift(), null)));</span>
<span class="line-added">1480         assertFalse(lvInputMap.getMappings().contains(</span>
<span class="line-added">1481                 new KeyMapping(new KeyBinding(KeyCode.END).shift(), null)));</span>
<span class="line-added">1482         assertFalse(lvInputMap.getMappings().contains(</span>
<span class="line-added">1483                 new KeyMapping(new KeyBinding(KeyCode.HOME).shortcut(), null)));</span>
<span class="line-added">1484         assertFalse(lvInputMap.getMappings().contains(</span>
<span class="line-added">1485                 new KeyMapping(new KeyBinding(KeyCode.END).shortcut(), null)));</span>
<span class="line-added">1486         assertFalse(lvInputMap.getMappings().contains(</span>
<span class="line-added">1487                 new KeyMapping(new KeyBinding(KeyCode.A).shortcut(), null)));</span>
<span class="line-added">1488 </span>
<span class="line-added">1489         // Verify vertical child InputMap</span>
<span class="line-added">1490         assertFalse(verticalInputMap.getMappings().contains(</span>
<span class="line-added">1491                 new KeyMapping(new KeyBinding(KeyCode.HOME).shortcut().shift(), null)));</span>
<span class="line-added">1492         assertFalse(verticalInputMap.getMappings().contains(</span>
<span class="line-added">1493                 new KeyMapping(new KeyBinding(KeyCode.END).shortcut().shift(), null)));</span>
<span class="line-added">1494 </span>
<span class="line-added">1495         sl.dispose();</span>
<span class="line-added">1496     }</span>
<span class="line-added">1497 </span>
1498     @Test public void test_rt36280_nonEditable_enterHidesShowingPopup() {
1499         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1500         StageLoader sl = new StageLoader(cb);
1501         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1502 
1503         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1504         assertNotNull(listView);
1505 
1506         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1507 
1508         assertFalse(cb.isShowing());
1509         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1510         assertTrue(cb.isShowing());
1511         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1512         assertFalse(cb.isShowing());
1513 
1514         sl.dispose();
1515     }
1516 
1517     @Test public void test_rt36280_nonEditable_spaceHidesShowingPopup() {
1518         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1519         StageLoader sl = new StageLoader(cb);
1520         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1521 
1522         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1523         assertNotNull(listView);
1524 
1525         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1526 
1527         assertFalse(cb.isShowing());
1528         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1529         assertTrue(cb.isShowing());
1530         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1531         assertFalse(cb.isShowing());
1532 
1533         sl.dispose();
1534     }
1535 
1536     @Test public void test_rt36280_nonEditable_escapeHidesShowingPopup() {
1537         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1538         StageLoader sl = new StageLoader(cb);
1539         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1540 
1541         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1542         assertNotNull(listView);
1543 
1544         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1545 
1546         assertFalse(cb.isShowing());
1547         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1548         assertTrue(cb.isShowing());
1549         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1550         assertFalse(cb.isShowing());
1551 
1552         sl.dispose();
1553     }
1554 
1555     @Test public void test_rt36280_nonEditable_F4HidesShowingPopup() {
1556         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1557         StageLoader sl = new StageLoader(cb);
1558         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1559 
1560         assertFalse(cb.isShowing());
1561         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1562         assertTrue(cb.isShowing());
1563         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1564         assertFalse(cb.isShowing());
1565 
1566         sl.dispose();
1567     }
1568 
1569     @Test public void test_rt36280_nonEditable_arrowKeysChangeSelection() {
1570         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1571         StageLoader sl = new StageLoader(cb);
1572         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1573 
1574         assertFalse(cb.isShowing());
1575         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1576         assertTrue(cb.isShowing());
1577 
1578         assertNull(cb.getSelectionModel().getSelectedItem());
1579 
1580         cbKeyboard.doDownArrowPress();
1581         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1582 
1583         cbKeyboard.doDownArrowPress();
1584         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1585 
1586         cbKeyboard.doUpArrowPress();
1587         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1588 
1589         sl.dispose();
1590     }
1591 
1592     @Test public void test_rt36280_editable_F4ShowsPopup() {
1593         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1594         cb.setEditable(true);
1595         StageLoader sl = new StageLoader(cb);
1596         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1597 
1598         assertFalse(cb.isShowing());
1599         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1600         assertTrue(cb.isShowing());
1601 
1602         sl.dispose();
1603     }
1604 
1605     @Test public void test_rt36280_editable_altUpShowsPopup() {
1606         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1607         cb.setEditable(true);
1608         StageLoader sl = new StageLoader(cb);
1609         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1610 
1611         assertFalse(cb.isShowing());
1612         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1613         assertTrue(cb.isShowing());
1614 
1615         sl.dispose();
1616     }
1617 
1618     @Test public void test_rt36280_editable_altDownShowsPopup_onComboBox() {
1619         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1620         cb.setEditable(true);
1621         StageLoader sl = new StageLoader(cb);
1622         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1623 
1624         assertFalse(cb.isShowing());
1625         assertTrue(cb.getEditor().getText().isEmpty());
1626         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1627         assertTrue(cb.isShowing());
1628         assertTrue(cb.getEditor().getText().isEmpty());
1629 
1630         sl.dispose();
1631     }
1632 
1633     @Test public void test_rt36280_editable_altDownShowsPopup_onTextField() {
1634         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1635         cb.setEditable(true);
1636         StageLoader sl = new StageLoader(cb);
1637 
1638         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1639         assertFalse(cb.isShowing());
1640         assertTrue(cb.getEditor().getText().isEmpty());
1641         tfKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1642         assertTrue(cb.isShowing());
1643         assertTrue(cb.getEditor().getText().isEmpty());
1644 
1645         sl.dispose();
1646     }
1647 
1648     @Test public void test_rt36280_editable_enterHidesShowingPopup() {
1649         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1650         cb.setEditable(true);
1651         StageLoader sl = new StageLoader(cb);
1652         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1653 
1654         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1655         assertNotNull(listView);
1656 
1657         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1658 
1659         assertFalse(cb.isShowing());
1660         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1661         assertTrue(cb.isShowing());
1662         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1663         assertFalse(cb.isShowing());
1664 
1665         sl.dispose();
1666     }
1667 
1668     @Test public void test_rt36280_editable_spaceHidesShowingPopup() {
1669         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1670         cb.setEditable(true);
1671         StageLoader sl = new StageLoader(cb);
1672         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1673 
1674         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1675         assertNotNull(listView);
1676 
1677         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1678 
1679         assertFalse(cb.isShowing());
1680         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1681         assertTrue(cb.isShowing());
1682         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1683         assertFalse(cb.isShowing());
1684 
1685         sl.dispose();
1686     }
1687 
1688     @Test public void test_rt36280_editable_escapeHidesShowingPopup() {
1689         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1690         cb.setEditable(true);
1691         StageLoader sl = new StageLoader(cb);
1692         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1693 
1694         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1695         assertNotNull(listView);
1696 
1697         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1698 
1699         assertFalse(cb.isShowing());
1700         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1701         assertTrue(cb.isShowing());
1702         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1703         assertFalse(cb.isShowing());
1704 
1705         sl.dispose();
1706     }
1707 
1708     @Test public void test_rt36280_editable_F4HidesShowingPopup() {
1709         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1710         cb.setEditable(true);
1711         StageLoader sl = new StageLoader(cb);
1712         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1713 
1714         assertFalse(cb.isShowing());
1715         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1716         assertTrue(cb.isShowing());
1717         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1718         assertFalse(cb.isShowing());
1719 
1720         sl.dispose();
1721     }
1722 
1723     @Test public void test_rt36280_editable_arrowKeysChangeSelection() {
1724         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1725         cb.setEditable(true);
1726         StageLoader sl = new StageLoader(cb);
1727         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1728 
1729         assertFalse(cb.isShowing());
1730         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1731         assertTrue(cb.isShowing());
1732 
1733         assertNull(cb.getSelectionModel().getSelectedItem());
1734 
1735         cbKeyboard.doDownArrowPress();
1736         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1737 
1738         cbKeyboard.doDownArrowPress();
1739         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1740 
1741         cbKeyboard.doUpArrowPress();
1742         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1743 
1744         sl.dispose();
1745     }
1746 
1747     @Test public void test_rt36651() {
1748         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1749         cb.setEditable(true);
1750         StageLoader sl = new StageLoader(cb);
1751 
1752         assertNull(cb.getValue());
1753         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1754         assertNull(cb.getSelectionModel().getSelectedItem());
1755 
1756         sl.getStage().requestFocus();
1757         cb.show();
1758         Toolkit.getToolkit().firePulse();
1759 
1760         // selection should not change just by showing the popup
1761         assertNull(cb.getValue());
1762         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1763         assertNull(cb.getSelectionModel().getSelectedItem());
1764 
1765         sl.dispose();
1766     }
1767 
1768     @Test public void test_rt36717() {
1769         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1770         StageLoader sl = new StageLoader(cb);
1771 
1772         // the stack overflow only occurs when a ComboBox changes from non-editable to editable
1773         cb.setEditable(false);
1774         cb.setEditable(true);
1775         assertNotNull(cb.getEditor());
1776         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1777         tfKeyboard.doKeyPress(KeyCode.ENTER);   // Stack overflow here
1778 
1779         sl.dispose();
1780     }
1781 
1782     @Test public void test_rt36827() {
1783         final Button btn = new Button(&quot;focus owner&quot;);
1784         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1785         VBox vbox = new VBox(btn, cb);
1786 
1787         StageLoader sl = new StageLoader(vbox);
1788         sl.getStage().requestFocus();
1789         btn.requestFocus();
1790         Toolkit.getToolkit().firePulse();
1791         Scene scene = sl.getStage().getScene();
1792 
1793         assertTrue(btn.isFocused());
1794         assertEquals(btn, scene.getFocusOwner());
1795 
1796         MouseEventFirer mouse = new MouseEventFirer(cb);
1797         mouse.fireMousePressAndRelease();
1798 
1799         assertTrue(cb.isShowing());
1800         assertTrue(cb.isFocused());
1801         assertEquals(cb, scene.getFocusOwner());
1802 
1803         sl.dispose();
1804     }
1805 
1806     @Test public void test_rt36902() {
1807         final ComboBox&lt;String&gt; cb1 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1808         final ComboBox&lt;String&gt; cb2 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1809         cb2.setEditable(true);
1810         VBox vbox = new VBox(cb1, cb2);
1811 
1812         // lame - I would rather have one keyboard here but I couldn&#39;t get it to
1813         // work, so watch out for which keyboard is used below
1814         KeyEventFirer cb1Keyboard = new KeyEventFirer(cb1);
1815         KeyEventFirer cb2Keyboard = new KeyEventFirer(cb2);
1816 
1817         StageLoader sl = new StageLoader(vbox);
1818         sl.getStage().requestFocus();
1819         cb1.requestFocus();
1820         Toolkit.getToolkit().firePulse();
1821         Scene scene = sl.getStage().getScene();
1822 
1823         assertTrue(cb1.isFocused());
1824         assertEquals(cb1, scene.getFocusOwner());
1825 
1826         // move focus forward to cb2
1827         cb1Keyboard.doKeyPress(KeyCode.TAB);
1828         assertTrue(cb2.isFocused());
1829         assertEquals(cb2, scene.getFocusOwner());
1830 
1831         // move focus forward again to cb1
1832         cb2Keyboard.doKeyPress(KeyCode.TAB);
1833         assertTrue(cb1.isFocused());
1834         assertEquals(cb1, scene.getFocusOwner());
1835 
1836         // now start going backwards with shift-tab.
1837         // The first half of the bug is here - when we shift-tab into cb2, we
1838         // actually go into the FakeFocusTextField subcomponent, so whilst the
1839         // cb2.isFocused() returns true as expected, the scene focus owner is
1840         // not the ComboBox, but the FakeFocusTextField inside it
1841         cb1Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1842         assertTrue(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1843                 cb2.isFocused());
1844         // Updated with fix for RT-34602: The TextField now never gets
1845         // focus (it&#39;s just faking it).
1846         // assertEquals(&quot;Expect cb2 TextField to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1847         //         cb2.getEditor(), scene.getFocusOwner());
1848         assertEquals(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1849                      cb2, scene.getFocusOwner());
1850 
1851         // This is where the second half of the bug appears, as we are stuck in
1852         // the FakeFocusTextField of cb2, we never make it to cb1
1853         cb2Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1854         assertTrue(cb1.isFocused());
1855         assertEquals(cb1, scene.getFocusOwner());
1856 
1857         sl.dispose();
1858     }
1859 
1860     private int rt_38901_counter;
1861     @Test public void test_rt_38901_selectNull() {
1862         test_rt_38901(true);
1863     }
1864 
1865     @Test public void test_rt_38901_selectNegativeOne() {
1866         test_rt_38901(false);
1867     }
1868 
1869     private void test_rt_38901(boolean selectNull) {
1870         rt_38901_counter = 0;
1871 
1872         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1873         cb.setOnShowing((e) -&gt; {
1874             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_38901_counter++));
1875         });
1876 
1877         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1878         assertNull(cb.getSelectionModel().getSelectedItem());
1879         assertNull(cb.getValue());
1880         assertEquals(0, cb.getItems().size());
1881 
1882         // round one
1883         cb.show();
1884         assertEquals(1, cb.getItems().size());
1885         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1886         cb.hide();
1887 
1888         cb.getSelectionModel().select(0);
1889         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1890         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1891         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1892 
1893         if (selectNull) cb.getSelectionModel().select(null);
1894         else cb.getSelectionModel().select(-1);
1895 
1896         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1897         assertNull(cb.getSelectionModel().getSelectedItem());
1898         assertNull(cb.getValue());
1899 
1900 
1901         // round two
1902         cb.show();
1903         assertEquals(1, cb.getItems().size());
1904         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1905         cb.hide();
1906 
1907         cb.getSelectionModel().select(0);
1908         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1909         assertEquals(&quot;DUMMY 1&quot;, cb.getSelectionModel().getSelectedItem());
1910         assertEquals(&quot;DUMMY 1&quot;, cb.getValue());
1911 
1912         if (selectNull) cb.getSelectionModel().select(null);
1913         else cb.getSelectionModel().select(-1);
1914 
1915         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1916         assertNull(cb.getSelectionModel().getSelectedItem());
1917         assertNull(cb.getValue());
1918     }
1919 
1920     private int rt_22572_counter;
1921     @Test public void test_rt_22572() {
1922         rt_22572_counter = 0;
1923 
1924         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1925         cb.setOnShowing((e) -&gt; {
1926             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22572_counter++));
1927         });
1928 
1929         StageLoader sl = new StageLoader(cb);
1930 
1931         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1932         assertNull(cb.getSelectionModel().getSelectedItem());
1933         assertNull(cb.getValue());
1934         assertEquals(0, cb.getItems().size());
1935 
1936         // round one
1937         cb.show();
1938         assertEquals(1, cb.getItems().size());
1939         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1940         cb.hide();
1941 
1942         cb.getSelectionModel().select(0);
1943         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1944         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1945         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1946 
1947 
1948         // round two - even though the items change, the value should still be
1949         // the old value (even though it doesn&#39;t exist in the items list any longer).
1950         // The selectedIndex and selectedItem do get reset however.
1951         cb.show();
1952         assertEquals(1, cb.getItems().size());
1953         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1954         cb.hide();
1955 
1956         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1957         assertNull(cb.getSelectionModel().getSelectedItem());
1958         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1959 
1960         sl.dispose();
1961     }
1962 
1963     private int rt_22937_counter;
1964     @Test public void test_rt_22937() {
1965         rt_22937_counter = 0;
1966 
1967         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1968         cb.setOnShowing((e) -&gt; {
1969             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22937_counter++));
1970         });
1971 
1972         cb.getItems().add(&quot;Toto&quot;);
1973         cb.setEditable(true);
1974         cb.setValue(&quot;Tata&quot;);
1975 
1976         StageLoader sl = new StageLoader(cb);
1977 
1978         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1979         assertEquals(&quot;Tata&quot;, cb.getSelectionModel().getSelectedItem());
1980         assertEquals(&quot;Tata&quot;, cb.getValue());
1981         assertEquals(1, cb.getItems().size());
1982 
1983         cb.show();
1984         assertEquals(1, cb.getItems().size());
1985         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1986         cb.hide();
1987 
1988         cb.getSelectionModel().select(0);
1989         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1990         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1991         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1992 
1993         sl.dispose();
1994     }
1995 
1996     @Test public void test_rt_39809() {
1997         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1998         comboBox.getItems().setAll(null, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
1999 
2000         StageLoader sl = new StageLoader(comboBox);
2001 
2002         comboBox.getSelectionModel().clearAndSelect(1);
2003         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
2004         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
2005 
2006         comboBox.getSelectionModel().clearAndSelect(0);
2007         assertEquals(null, comboBox.getSelectionModel().getSelectedItem());
2008         assertEquals(0, comboBox.getSelectionModel().getSelectedIndex());
2009 
2010         sl.dispose();
2011     }
2012 
2013     @Test public void test_rt_39908() {
2014         ObservableList&lt;String&gt; model = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
2015         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(model);
2016 
2017         StageLoader sl = new StageLoader(comboBox);
2018 
2019         comboBox.getSelectionModel().clearAndSelect(1);
2020         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
2021         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
2022 
2023         model.set(0, &quot;a&quot;);
2024         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
2025         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
2026 
2027         sl.dispose();
2028     }
2029 
2030     /**
2031      * Bullet 1: selected index must be updated
2032      * Corner case: last selected. Fails for core
2033      */
2034     @Test public void test_rt_40012_selectedAtLastOnDisjointRemoveItemsAbove() {
2035         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2036         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2037         SelectionModel sm = comboBox.getSelectionModel();
2038 
2039         int last = items.size() - 1;
2040 
2041         // selecting item &quot;5&quot;
2042         sm.select(last);
2043 
2044         // disjoint remove of 2 elements above the last selected
2045         // Removing &quot;1&quot; and &quot;3&quot;
2046         items.removeAll(items.get(1), items.get(3));
2047 
2048         // selection should move up two places such that it remains on item &quot;5&quot;,
2049         // but in index (last - 2).
2050         int expected = last - 2;
2051         assertEquals(&quot;5&quot;, sm.getSelectedItem());
2052         assertEquals(&quot;selected index after disjoint removes above&quot;, expected, sm.getSelectedIndex());
2053     }
2054 
2055     /**
2056      * Variant of 1: if selectedIndex is not updated,
2057      * the old index is no longer valid
2058      * for accessing the items.
2059      */
2060     @Test public void test_rt_40012_accessSelectedAtLastOnDisjointRemoveItemsAbove() {
2061         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2062         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2063         SelectionModel sm = comboBox.getSelectionModel();
2064 
2065         int last = items.size() - 1;
2066 
2067         // selecting item &quot;5&quot;
2068         sm.select(last);
2069 
2070         // disjoint remove of 2 elements above the last selected
2071         items.removeAll(items.get(1), items.get(3));
2072         int selected = sm.getSelectedIndex();
2073         if (selected &gt; -1) {
2074             items.get(selected);
2075         }
2076     }
2077 
2078     /**
2079      * Bullet 2: selectedIndex notification count
2080      *
2081      * Note that we don&#39;t use the corner case of having the last index selected
2082      * (which fails already on updating the index)
2083      */
2084     private int rt_40012_count = 0;
2085     @Test public void test_rt_40012_selectedIndexNotificationOnDisjointRemovesAbove() {
2086         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2087         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2088         SelectionModel sm = comboBox.getSelectionModel();
2089 
2090         int last = items.size() - 2;
2091         sm.select(last);
2092         assertEquals(last, sm.getSelectedIndex());
2093 
2094         rt_40012_count = 0;
2095         sm.selectedIndexProperty().addListener(o -&gt; rt_40012_count++);
2096 
2097         // disjoint remove of 2 elements above the last selected
2098         items.removeAll(items.get(1), items.get(3));
2099         assertEquals(&quot;sanity: selectedIndex must be shifted by -2&quot;, last - 2, sm.getSelectedIndex());
2100         assertEquals(&quot;must fire single event on removes above&quot;, 1, rt_40012_count);
2101     }
2102 
2103     /**
2104      * Bullet 3: unchanged selectedItem must not fire change
2105      */
2106     @Test
2107     public void test_rt_40012_selectedItemNotificationOnDisjointRemovesAbove() {
2108         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2109         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2110         SelectionModel sm = comboBox.getSelectionModel();
2111 
2112         int last = items.size() - 2;
2113         Object lastItem = items.get(last);
2114         sm.select(last);
2115         assertEquals(lastItem, sm.getSelectedItem());
2116 
2117         rt_40012_count = 0;
2118         sm.selectedItemProperty().addListener(o -&gt; rt_40012_count++);
2119 
2120         // disjoint remove of 2 elements above the last selected
2121         items.removeAll(items.get(1), items.get(3));
2122         assertEquals(&quot;sanity: selectedItem unchanged&quot;, lastItem, sm.getSelectedItem());
2123         assertEquals(&quot;must not fire on unchanged selected item&quot;, 0, rt_40012_count);
2124     }
2125 
2126     @Test public void test_jdk_8150946_testCommit_valid() {
2127         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2128         comboBox.setEditable(true);
2129         assertEquals(null, comboBox.getValue());
2130         comboBox.getEditor().setText(&quot;ABC&quot;);
2131         comboBox.commitValue();
2132         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2133     }
2134 
2135     @Test public void test_jdk_8150946_testCancel_toNull() {
2136         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2137         comboBox.setEditable(true);
2138         assertNull(comboBox.getValue());
2139         assertEquals(&quot;&quot;, comboBox.getEditor().getText());
2140         comboBox.getEditor().setText(&quot;ABC&quot;);
2141         assertNull(comboBox.getValue());
2142         comboBox.cancelEdit();
2143         assertNull(comboBox.getValue());
2144         assertNull(comboBox.getEditor().getText());
2145     }
2146 
2147     @Test public void test_jdk_8150946_testCancel_toNonNull() {
2148         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2149         comboBox.setEditable(true);
2150         comboBox.getEditor().setText(&quot;ABC&quot;);
2151         comboBox.commitValue();
2152         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2153         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2154         comboBox.getEditor().setText(&quot;DEF&quot;);
2155         assertEquals(&quot;DEF&quot;, comboBox.getEditor().getText());
2156         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2157         comboBox.cancelEdit();
2158         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2159         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2160     }
2161 
2162     @Test public void test_jdk_8160493() {
2163         AtomicInteger count = new AtomicInteger();
2164         comboBox.valueProperty().addListener(o -&gt; count.incrementAndGet());
2165         assertEquals(0, count.get());
2166 
2167         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
2168         sm.select(1);
2169         assertTrue(sm.isSelected(1));
2170         assertEquals(1, count.get());
2171         assertEquals(&quot;Orange&quot;, comboBox.getValue());
2172 
2173         comboBox.setValue(&quot;New Value&quot;);
2174         assertEquals(2, count.get());
2175         assertEquals(&quot;New Value&quot;, comboBox.getValue());
2176     }
2177 
2178     private int skinChangedCount = 0;
2179     @Test public void test_JDK_8185854() {
2180         final FlowPane comboPane = new FlowPane(10, 10);
2181         ComboBox combo = new ComboBox&lt;String&gt;();
2182 
2183         combo.skinProperty().addListener((o, oldSkin, newSkin) -&gt; {
2184             skinChangedCount++;
2185         });
2186 
2187         combo.setDisable(false);
2188         combo.setEditable(false);
2189 
2190         comboPane.getChildren().add(combo);
2191 
2192         TabPane tabPane = new TabPane();
2193         Tab tab = new Tab();
2194         tab.setText(&quot;ComboBox&quot;);
2195         tab.setContent(comboPane);
2196         tabPane.getTabs().add(tab);
2197 
2198         BorderPane p = new BorderPane();
2199         p.setCenter(tabPane);
2200 
2201         Scene scene = new Scene(p);
2202         scene.getStylesheets().add(ComboBoxTest.class.getResource(&quot;JDK_8185854.css&quot;).toExternalForm());
2203 
2204         Toolkit tk = Toolkit.getToolkit();
2205 
2206         Stage stage = new Stage();
2207         stage.setScene(scene);
2208         stage.setWidth(500);
2209         stage.setHeight(400);
2210 
2211         stage.show();
2212 
2213         tk.firePulse();
2214 
2215         assertEquals(&quot;ComboBox skinProperty changed more than once, which is not expected.&quot;, 1, skinChangedCount);
2216     }
2217 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>