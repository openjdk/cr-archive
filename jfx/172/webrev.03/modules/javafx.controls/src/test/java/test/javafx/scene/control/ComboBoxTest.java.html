<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.controls/src/test/java/test/javafx/scene/control/ComboBoxTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
  28 import test.com.sun.javafx.scene.control.infrastructure.KeyModifier;
  29 import test.com.sun.javafx.scene.control.infrastructure.MouseEventFirer;
  30 import com.sun.javafx.tk.Toolkit;
  31 import javafx.css.PseudoClass;
  32 
  33 import test.com.sun.javafx.scene.control.infrastructure.KeyEventFirer;
  34 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  35 import javafx.scene.control.skin.ComboBoxListViewSkin;
  36 
  37 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertStyleClassContains;
  38 import static org.junit.Assert.*;
  39 import static org.junit.Assert.assertEquals;
  40 
  41 import java.util.*;
  42 import java.util.concurrent.atomic.AtomicInteger;
  43 
  44 import javafx.beans.property.ObjectProperty;
  45 import javafx.beans.property.SimpleObjectProperty;
  46 import javafx.beans.property.SimpleStringProperty;
  47 import javafx.beans.property.StringProperty;
  48 import javafx.collections.FXCollections;
  49 import javafx.collections.ObservableList;
  50 import javafx.event.ActionEvent;
  51 import javafx.event.EventHandler;
  52 import javafx.scene.Node;
  53 import javafx.scene.Scene;
  54 import javafx.scene.control.Button;
  55 import javafx.scene.control.ComboBox;
  56 import javafx.scene.control.ComboBoxShim;
  57 import javafx.scene.control.IndexedCell;
  58 import javafx.scene.control.Label;
  59 import javafx.scene.control.ListCell;
  60 import javafx.scene.control.ListCellShim;
  61 import javafx.scene.control.ListView;
  62 import javafx.scene.control.SelectionModel;
  63 import javafx.scene.control.SelectionModelShim;
  64 import javafx.scene.control.SingleSelectionModel;
  65 import javafx.scene.control.Tab;
  66 import javafx.scene.control.TabPane;
  67 import javafx.scene.control.TextField;
  68 import javafx.scene.control.Tooltip;
  69 import javafx.scene.control.skin.VirtualFlow;
  70 import javafx.scene.input.KeyCode;
  71 import javafx.scene.layout.BorderPane;
  72 import javafx.scene.layout.FlowPane;
  73 import javafx.scene.layout.VBox;
  74 import javafx.scene.paint.Color;
  75 import javafx.scene.shape.Circle;
  76 import javafx.stage.Stage;
  77 import javafx.util.Callback;
  78 import javafx.util.StringConverter;
  79 
  80 import org.junit.After;
  81 import org.junit.Before;
  82 import org.junit.Ignore;
  83 import org.junit.Test;
  84 
  85 public class ComboBoxTest {
  86     private ComboBox&lt;String&gt; comboBox;
  87     private SingleSelectionModel&lt;String&gt; sm;
  88 
  89     /*********************************************************************
  90      *                                                                   *
  91      * Utility methods                                                   *
  92      *                                                                   *
  93      ********************************************************************/
  94 
  95     public ListView getListView() {
  96         return (ListView) ((ComboBoxListViewSkin)comboBox.getSkin()).getPopupContent();
  97     }
  98 
  99     public Node getDisplayNode() {
 100         return ((ComboBoxListViewSkin)comboBox.getSkin()).getDisplayNode();
 101     }
 102 
 103 
 104 
 105     /*********************************************************************
 106      *                                                                   *
 107      * Setup                                                             *
 108      *                                                                   *
 109      ********************************************************************/
 110 
 111     @Before public void setup() {
 112         Thread.currentThread().setUncaughtExceptionHandler((thread, throwable) -&gt; {
 113             if (throwable instanceof RuntimeException) {
 114                 throw (RuntimeException)throwable;
 115             } else {
 116                 Thread.currentThread().getThreadGroup().uncaughtException(thread, throwable);
 117             }
 118         });
 119 
 120         comboBox = new ComboBox&lt;String&gt;();
 121         comboBox.setSkin(new ComboBoxListViewSkin&lt;&gt;(comboBox));
 122         sm = comboBox.getSelectionModel();
 123     }
 124 
 125     @After public void cleanup() {
 126         Thread.currentThread().setUncaughtExceptionHandler(null);
 127     }
 128 
 129     /*********************************************************************
 130      *                                                                   *
 131      * Tests for the constructors                                        *
 132      *                                                                   *
 133      ********************************************************************/
 134 
 135     @Test public void noArgConstructorSetsTheStyleClass() {
 136         assertStyleClassContains(comboBox, &quot;combo-box&quot;);
 137     }
 138 
 139     @Test public void noArgConstructorSetsNonNullSelectionModel() {
 140         assertNotNull(sm);
 141     }
 142 
 143     @Test public void noArgConstructorSetsNonNullItems() {
 144         assertNotNull(comboBox.getItems());
 145     }
 146 
 147     @Test public void noArgConstructor_selectedItemIsNull() {
 148         assertNull(sm.getSelectedItem());
 149     }
 150 
 151     @Test public void noArgConstructor_selectedIndexIsNegativeOne() {
 152         assertEquals(-1, sm.getSelectedIndex());
 153     }
 154 
 155     @Test public void noArgConstructor_valueIsNull() {
 156         assertNull(comboBox.getValue());
 157     }
 158 
 159     @Test public void noArgConstructor_editableIsFalse() {
 160         assertFalse(comboBox.isEditable());
 161     }
 162 
 163     @Test public void noArgConstructor_showingIsFalse() {
 164         assertFalse(comboBox.isShowing());
 165     }
 166 
 167     @Test public void noArgConstructor_promptTextIsEmptyString() {
 168         assertNull(comboBox.getPromptText());
 169     }
 170 
 171     @Test public void noArgConstructor_placeholderIsNull() {
 172         assertNull(comboBox.getPlaceholder());
 173     }
 174 
 175     @Test public void noArgConstructor_armedIsFalse() {
 176         assertFalse(comboBox.isArmed());
 177     }
 178 
 179     @Test public void noArgConstructor_converterIsNotNull() {
 180         assertNotNull(comboBox.getConverter());
 181     }
 182 
 183     @Test public void noArgConstructor_cellFactoryIsNull() {
 184         assertNull(comboBox.getCellFactory());
 185     }
 186 
 187     @Test public void noArgConstructor_visibleRowFactoryIs10() {
 188         assertEquals(10, comboBox.getVisibleRowCount());
 189     }
 190 
 191     @Test public void singleArgConstructorSetsTheStyleClass() {
 192         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 193         assertStyleClassContains(b2, &quot;combo-box&quot;);
 194     }
 195 
 196     @Test public void singleArgConstructorSetsNonNullSelectionModel() {
 197         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 198         assertNotNull(b2.getSelectionModel());
 199     }
 200 
 201     @Test public void singleArgConstructorAllowsNullItems() {
 202         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(null);
 203         assertNull(b2.getItems());
 204     }
 205 
 206     @Test public void singleArgConstructorTakesItems() {
 207         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;Hi&quot;);
 208         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(items);
 209         assertSame(items, b2.getItems());
 210     }
 211 
 212     @Test public void singleArgConstructor_selectedItemIsNull() {
 213         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 214         assertNull(b2.getSelectionModel().getSelectedItem());
 215     }
 216 
 217     @Test public void singleArgConstructor_selectedIndexIsNegativeOne() {
 218         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 219         assertEquals(-1, b2.getSelectionModel().getSelectedIndex());
 220     }
 221 
 222     @Test public void singleArgConstructor_valueIsNull() {
 223         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 224         assertNull(b2.getValue());
 225     }
 226 
 227     @Test public void singleArgConstructor_editableIsFalse() {
 228         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 229         assertFalse(b2.isEditable());
 230     }
 231 
 232     @Test public void singleArgConstructor_showingIsFalse() {
 233         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 234         assertFalse(b2.isShowing());
 235     }
 236 
 237     @Test public void singleArgConstructor_promptTextIsEmptyString() {
 238         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 239         assertNull(b2.getPromptText());
 240     }
 241 
 242     @Test public void singleArgConstructor_placeholderIsNull() {
 243         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 244         assertNull(b2.getPlaceholder());
 245     }
 246 
 247     @Test public void singleArgConstructor_armedIsFalse() {
 248         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 249         assertEquals(false, b2.isArmed());
 250     }
 251 
 252     @Test public void singleArgConstructor_converterIsNotNull() {
 253         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 254         assertNotNull(b2.getConverter());
 255     }
 256 
 257     @Test public void singleArgConstructor_cellFactoryIsNull() {
 258         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 259         assertNull(b2.getCellFactory());
 260     }
 261 
 262     @Test public void singleArgConstructor_visibleRowFactoryIs10() {
 263         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 264         assertEquals(10, b2.getVisibleRowCount());
 265     }
 266 
 267     /*********************************************************************
 268      * Tests for selection model                                         *
 269      ********************************************************************/
 270 
 271     @Test public void selectionModelCanBeNull() {
 272         comboBox.setSelectionModel(null);
 273         assertNull(comboBox.getSelectionModel());
 274     }
 275 
 276     @Test public void selectionModelCanBeBound() {
 277         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 278         ObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt; other = new SimpleObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt;(sm);
 279         comboBox.selectionModelProperty().bind(other);
 280         assertSame(sm, sm);
 281     }
 282 
 283     @Test public void selectionModelCanBeChanged() {
 284         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 285         comboBox.setSelectionModel(sm);
 286         assertSame(sm, sm);
 287     }
 288 
 289     @Test public void canSetSelectedItemToAnItemEvenWhenThereAreNoItems() {
 290         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 291         sm.select(randomString);
 292         assertEquals(-1, sm.getSelectedIndex());
 293         assertSame(randomString, sm.getSelectedItem());
 294     }
 295 
 296     @Test public void canSetSelectedItemToAnItemNotInTheDataModel() {
 297         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 298         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 299         sm.select(randomString);
 300         assertEquals(-1, sm.getSelectedIndex());
 301         assertSame(randomString, sm.getSelectedItem());
 302     }
 303 
 304     @Test public void settingTheSelectedItemToAnItemInItemsResultsInTheCorrectSelectedIndex() {
 305         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 306         sm.select(&quot;Orange&quot;);
 307         assertEquals(1, sm.getSelectedIndex());
 308         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 309     }
 310 
 311     @Test public void settingTheSelectedItemToANonexistantItemAndThenSettingItemsWhichContainsItResultsInCorrectSelectedIndex() {
 312         sm.select(&quot;Orange&quot;);
 313         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 314         assertEquals(1, sm.getSelectedIndex());
 315         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 316     }
 317 
 318     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex0() {
 319         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 320         sm.select(0);
 321         comboBox.getItems().clear();
 322         assertEquals(-1, sm.getSelectedIndex());
 323         assertEquals(null, sm.getSelectedItem());
 324     }
 325 
 326     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex2() {
 327         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 328         sm.select(2);
 329         comboBox.getItems().clear();
 330         assertEquals(-1, sm.getSelectedIndex());
 331         assertEquals(null, sm.getSelectedItem());
 332     }
 333 
 334     @Test public void ensureSelectedItemRemainsAccurateWhenItemsAreCleared() {
 335         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 336         sm.select(2);
 337         comboBox.getItems().clear();
 338         assertNull(sm.getSelectedItem());
 339         assertEquals(-1, sm.getSelectedIndex());
 340 
 341         comboBox.getItems().addAll(&quot;Kiwifruit&quot;, &quot;Mandarin&quot;, &quot;Pineapple&quot;);
 342         sm.select(2);
 343         assertEquals(&quot;Pineapple&quot;, sm.getSelectedItem());
 344     }
 345 
 346     @Test public void ensureSelectionShiftsDownWhenOneNewItemIsAdded() {
 347         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 348         sm.select(1);
 349         assertEquals(1, sm.getSelectedIndex());
 350         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 351 
 352         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 353         assertEquals(2, sm.getSelectedIndex());
 354         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 355     }
 356 
 357     @Test public void ensureSelectionShiftsDownWhenMultipleNewItemAreAdded() {
 358         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 359         sm.select(1);
 360         assertEquals(1, sm.getSelectedIndex());
 361         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 362 
 363         comboBox.getItems().addAll(0, Arrays.asList(&quot;Kiwifruit&quot;, &quot;Pineapple&quot;, &quot;Mandarin&quot;));
 364         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 365         assertEquals(4, sm.getSelectedIndex());
 366     }
 367 
 368     @Test public void ensureSelectionShiftsUpWhenOneItemIsRemoved() {
 369         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 370         sm.select(1);
 371         assertEquals(1, sm.getSelectedIndex());
 372         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 373 
 374         comboBox.getItems().remove(&quot;Apple&quot;);
 375         assertEquals(0, sm.getSelectedIndex());
 376         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 377     }
 378 
 379     @Test public void ensureSelectionShiftsUpWheMultipleItemsAreRemoved() {
 380         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 381         sm.select(2);
 382         assertEquals(2, sm.getSelectedIndex());
 383         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 384 
 385         comboBox.getItems().removeAll(Arrays.asList(&quot;Apple&quot;, &quot;Orange&quot;));
 386         assertEquals(0, sm.getSelectedIndex());
 387         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 388     }
 389 
 390     @Test public void ensureSelectionIsCorrectWhenItemsChange() {
 391         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 1&quot;));
 392         sm.select(0);
 393         assertEquals(&quot;Item 1&quot;, sm.getSelectedItem());
 394 
 395         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 2&quot;));
 396         assertEquals(-1, sm.getSelectedIndex());
 397         assertEquals(null, sm.getSelectedItem());
 398     }
 399 
 400     @Test(expected=NullPointerException.class)
 401     public void selectionModelComboBoxReferenceCanNotBeNull() {
 402         ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(null);
 403     }
 404 
 405     @Test public void ensureGetModelItemOutOfBoundsWorks_1() {
 406         ComboBox cb = new ComboBox(null);
 407         cb.getSelectionModel().select(-1);
 408         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 409     }
 410 
 411     @Test public void ensureGetModelItemOutOfBoundsWorks_2() {
 412         ComboBox cb = new ComboBox(null);
 413         cb.getSelectionModel().select(0);
 414         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 415     }
 416 
 417     @Test public void test_rt15793() {
 418         // ComboBox selectedIndex is 0 although the items list is empty
 419         final ComboBox lv = new ComboBox();
 420         final ObservableList list = FXCollections.observableArrayList();
 421         lv.setItems(list);
 422         list.add(&quot;toto&quot;);
 423         lv.getSelectionModel().select(0);
 424         assertEquals(0, lv.getSelectionModel().getSelectedIndex());
 425         list.remove(0);
 426         assertEquals(-1, lv.getSelectionModel().getSelectedIndex());
 427     }
 428 
 429     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectIndex() {
 430         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 431         assertNull(comboBox.getValue());
 432         sm.select(0);
 433         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 434     }
 435 
 436     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectItem() {
 437         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 438         assertNull(comboBox.getValue());
 439         sm.select(&quot;Apple&quot;);
 440         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 441     }
 442 
 443     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectPrevious() {
 444         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 445         assertNull(comboBox.getValue());
 446         sm.select(2);
 447         sm.selectPrevious();
 448         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 449     }
 450 
 451     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectNext() {
 452         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 453         assertNull(comboBox.getValue());
 454         sm.select(&quot;Apple&quot;);
 455         sm.selectNext();
 456         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 457     }
 458 
 459     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectFirst() {
 460         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 461         assertNull(comboBox.getValue());
 462         sm.selectFirst();
 463         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 464     }
 465 
 466     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectLast() {
 467         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 468         assertNull(comboBox.getValue());
 469         sm.selectLast();
 470         assertEquals(&quot;Banana&quot;, comboBox.getValue());
 471     }
 472 
 473     @Test public void ensureSelectionModelClearsValueProperty() {
 474         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 475         assertNull(comboBox.getValue());
 476         sm.select(0);
 477         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 478 
 479         sm.clearSelection();
 480         assertNull(comboBox.getValue());
 481     }
 482 
 483     @Test public void ensureSelectionModelClearsValuePropertyWhenNegativeOneSelected() {
 484         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 485         assertNull(comboBox.getValue());
 486         sm.select(0);
 487         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 488 
 489         sm.select(-1);
 490         assertNull(&quot;Expected null, actual value: &quot; + comboBox.getValue(), comboBox.getValue());
 491     }
 492 
 493     @Test public void ensureValueIsCorrectWhenItemsIsAddedToWithExistingSelection() {
 494         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 495         sm.select(1);
 496 
 497         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 498 
 499         assertEquals(2, sm.getSelectedIndex());
 500         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 501         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 502     }
 503 
 504     @Test public void ensureValueIsCorrectWhenItemsAreRemovedWithExistingSelection() {
 505         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 506         sm.select(1);
 507 
 508         comboBox.getItems().remove(&quot;Apple&quot;);
 509 
 510         assertEquals(0, sm.getSelectedIndex());
 511         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 512         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 513     }
 514 
 515     @Test public void ensureValueIsUpdatedByCorrectSelectionModelWhenSelectionModelIsChanged() {
 516         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 517         SingleSelectionModel sm1 = sm;
 518         sm1.select(1);
 519         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 520 
 521         SingleSelectionModel sm2 = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 522         comboBox.setSelectionModel(sm2);
 523 
 524         sm1.select(2);  // value should not change as we are using old SM
 525         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 526 
 527         sm2.select(0);  // value should change, as we are using new SM
 528         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 529     }
 530 
 531     @Test public void ensureValueDoesNotChangeWhenBoundAndNoExceptions() {
 532         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 533 
 534         StringProperty sp = new SimpleStringProperty(&quot;empty&quot;);
 535         comboBox.valueProperty().bind(sp);
 536 
 537         sm.select(1);
 538         assertEquals(&quot;empty&quot;, comboBox.getValue());
 539     }
 540 
 541     @Test public void ensureSelectionModelUpdatesWhenValueChanges() {
 542         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 543         assertNull(sm.getSelectedItem());
 544         comboBox.setValue(&quot;Orange&quot;);
 545         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 546     }
 547 
 548     @Test public void ensureSelectionModelUpdatesWhenValueChangesToNull() {
 549         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 550         comboBox.setValue(&quot;Kiwifruit&quot;);
 551         assertEquals(&quot;Kiwifruit&quot;, sm.getSelectedItem());
 552         assertEquals(&quot;Kiwifruit&quot;, comboBox.getValue());
 553         comboBox.setValue(null);
 554         assertEquals(null, sm.getSelectedItem());
 555         assertEquals(-1, sm.getSelectedIndex());
 556         assertEquals(null, comboBox.getValue());
 557     }
 558 
 559     @Test public void ensureValueEqualsSelectedItemWhenNotInItemsList() {
 560         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 561         SelectionModelShim.setSelectedItem(sm, &quot;pineapple&quot;);
 562         assertEquals(&quot;pineapple&quot;, sm.getSelectedItem());
 563         assertEquals(&quot;pineapple&quot;, comboBox.getValue());
 564     }
 565 
 566     /*********************************************************************
 567      * Tests for default values                                         *
 568      ********************************************************************/
 569 
 570     @Test public void checkPromptTextPropertyName() {
 571         assertTrue(comboBox.promptTextProperty().getName().equals(&quot;promptText&quot;));
 572     }
 573 
 574     @Test public void checkPlaceholderPropertyName() {
 575         assertTrue(comboBox.placeholderProperty().getName().equals(&quot;placeholder&quot;));
 576     }
 577 
 578     @Test public void checkValuePropertyName() {
 579         assertTrue(comboBox.valueProperty().getName().equals(&quot;value&quot;));
 580     }
 581 
 582     @Test public void checkItemsPropertyName() {
 583         assertTrue(comboBox.itemsProperty().getName().equals(&quot;items&quot;));
 584     }
 585 
 586     @Test public void checkConverterPropertyName() {
 587         assertTrue(comboBox.converterProperty().getName().equals(&quot;converter&quot;));
 588     }
 589 
 590     @Test public void checkSelectionModelPropertyName() {
 591         assertTrue(comboBox.selectionModelProperty().getName().equals(&quot;selectionModel&quot;));
 592     }
 593 
 594     @Test public void checkVisibleRowCountPropertyName() {
 595         assertTrue(comboBox.visibleRowCountProperty().getName().equals(&quot;visibleRowCount&quot;));
 596     }
 597 
 598     @Test public void checkOnActionPropertyName() {
 599         assertTrue(comboBox.onActionProperty().getName().equals(&quot;onAction&quot;));
 600     }
 601 
 602     @Test public void checkArmedPropertyName() {
 603         assertTrue(comboBox.armedProperty().getName().equals(&quot;armed&quot;));
 604     }
 605 
 606     @Test public void checkShowingPropertyName() {
 607         assertTrue(comboBox.showingProperty().getName().equals(&quot;showing&quot;));
 608     }
 609 
 610     @Test public void checkEditablePropertyName() {
 611         assertTrue(comboBox.editableProperty().getName().equals(&quot;editable&quot;));
 612     }
 613 
 614     @Test public void checkCellFactoryPropertyName() {
 615         assertTrue(comboBox.cellFactoryProperty().getName().equals(&quot;cellFactory&quot;));
 616     }
 617 
 618     @Test public void defaultActionHandlerIsNotDefined() {
 619         assertNull(comboBox.getOnAction());
 620     }
 621 
 622     @Test public void defaultConverterCanHandleStringValues() {
 623         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 624         assertEquals(&quot;input&quot;, sc.fromString(&quot;input&quot;));
 625         assertEquals(&quot;input&quot;, sc.toString(&quot;input&quot;));
 626     }
 627 
 628     @Test public void defaultConverterCanHandleIncorrectType_1() {
 629         ComboBox cb = new ComboBox();
 630         StringConverter sc = cb.getConverter();
 631         assertEquals(&quot;42&quot;, sc.toString(new Integer(42)));
 632     }
 633 
 634     @Test(expected=ClassCastException.class)
 635     public void defaultConverterCanHandleIncorrectType_2() {
 636         ComboBox&lt;Integer&gt; cb = new ComboBox&lt;Integer&gt;();
 637         StringConverter&lt;Integer&gt; sc = cb.getConverter();
 638         Integer value = sc.fromString(&quot;42&quot;);
 639     }
 640 
 641     @Test public void defaultConverterCanHandleNullValues() {
 642         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 643         assertEquals(null, sc.fromString(null));
 644         assertEquals(null, sc.toString(null));
 645     }
 646 
 647     @Test public void ensureImpl_getPseudoClassStateReturnsValidValue() {
 648         Stage stage = new Stage();
 649         Scene scene = new Scene(comboBox);
 650         stage.setScene(scene);
 651 
 652         Set&lt;PseudoClass&gt; pseudoClassStates = comboBox.getPseudoClassStates();
 653         assertFalse(comboBox.isEditable());
 654         assertTrue(pseudoClassStates.size() &gt;= 0);
 655 
 656         comboBox.setEditable(true);
 657         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)));
 658 
 659         comboBox.setEditable(false);
 660         assertFalse(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)));
 661 
 662         comboBox.show();
 663         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)));
 664 
 665         comboBox.hide();
 666         assertFalse(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)));
 667 
 668         comboBox.arm();
 669         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;armed&quot;)));
 670 
 671     }
 672 
 673     /*********************************************************************
 674      * Tests for properties                                              *
 675      ********************************************************************/
 676 
 677     @Test public void ensureAllowsNullConverter() {
 678         comboBox.setConverter(null);
 679         assertNull(comboBox.getConverter());
 680     }
 681 
 682     @Test public void ensureCanSetNonNullCellFactory() {
 683         Callback&lt;ListView&lt;String&gt;, ListCell&lt;String&gt;&gt; cf = p -&gt; null;
 684         comboBox.setCellFactory(cf);
 685         assertEquals(cf, comboBox.getCellFactory());
 686     }
 687 
 688     @Test public void ensureEditorIsNonNullWhenComboBoxIsNotEditable() {
 689         assertNotNull(comboBox.getEditor());
 690     }
 691 
 692     @Test public void ensureEditorIsNonNullWhenComboBoxIsEditable() {
 693         comboBox.setEditable(true);
 694         assertNotNull(comboBox.getEditor());
 695     }
 696 
 697     @Test public void ensureEditorDoesNotChangeWhenEditableToggles() {
 698         comboBox.setEditable(true);
 699         assertNotNull(comboBox.getEditor());
 700         comboBox.setEditable(false);
 701         assertNotNull(comboBox.getEditor());
 702         comboBox.setEditable(true);
 703         assertNotNull(comboBox.getEditor());
 704     }
 705 
 706     @Test public void ensureCanSetValueToNonNullStringAndBackAgain() {
 707         comboBox.setValue(&quot;Test 123&quot;);
 708         assertEquals(&quot;Test 123&quot;, comboBox.getValue());
 709         comboBox.setValue(null);
 710         assertNull(comboBox.getValue());
 711     }
 712 
 713     @Test public void ensureCanToggleEditable() {
 714         comboBox.setEditable(true);
 715         assertTrue(comboBox.isEditable());
 716         comboBox.setEditable(false);
 717         assertFalse(comboBox.isEditable());
 718     }
 719 
 720     @Test public void ensureCanToggleShowing() {
 721         Stage stage = new Stage();
 722         Scene scene = new Scene(comboBox);
 723         stage.setScene(scene);
 724 
 725         comboBox.show();
 726         assertTrue(comboBox.isShowing());
 727         comboBox.hide();
 728         assertFalse(comboBox.isShowing());
 729     }
 730 
 731     @Test public void ensureCanNotToggleShowingWhenDisabled() {
 732         Stage stage = new Stage();
 733         Scene scene = new Scene(comboBox);
 734         stage.setScene(scene);
 735 
 736         comboBox.setDisable(true);
 737         comboBox.show();
 738         assertFalse(comboBox.isShowing());
 739         comboBox.setDisable(false);
 740         comboBox.show();
 741         assertTrue(comboBox.isShowing());
 742     }
 743 
 744     @Test public void ensureCanSetPromptText() {
 745         comboBox.setPromptText(&quot;Test 1 2 3&quot;);
 746         assertEquals(&quot;Test 1 2 3&quot;, comboBox.getPromptText());
 747     }
 748 
 749     @Test public void ensureCanSetPromptTextToNull() {
 750         comboBox.setPromptText(&quot;&quot;);
 751         assertEquals(&quot;&quot;, comboBox.getPromptText());
 752         comboBox.setPromptText(null);
 753         assertEquals(null, comboBox.getPromptText());
 754     }
 755 
 756     @Test public void ensurePromptTextStripsNewlines() {
 757         comboBox.setPromptText(&quot;Test\n1\n2\n3&quot;);
 758         assertEquals(&quot;Test123&quot;, comboBox.getPromptText());
 759     }
 760 
 761     @Test public void ensureCanSetPlaceholder() {
 762         Label label = new javafx.scene.control.Label(&quot;Test 1 2 3&quot;);
 763         comboBox.setPlaceholder(label);
 764         assertEquals(label, comboBox.getPlaceholder());
 765     }
 766 
 767     @Test public void ensureCanToggleArmed() {
 768         assertFalse(comboBox.isArmed());
 769         comboBox.arm();
 770         assertTrue(comboBox.isArmed());
 771         comboBox.disarm();
 772         assertFalse(comboBox.isArmed());
 773     }
 774 
 775     @Test public void ensureCanSetVisibleRowCount() {
 776         comboBox.setVisibleRowCount(13);
 777         assertEquals(13, comboBox.getVisibleRowCount());
 778     }
 779 
 780     @Test public void ensureCanSetVisibleRowCountToNegativeValues() {
 781         comboBox.setVisibleRowCount(-10);
 782         assertEquals(-10, comboBox.getVisibleRowCount());
 783     }
 784 
 785     @Test public void ensureCanSetOnAction() {
 786         EventHandler&lt;ActionEvent&gt; onAction = t -&gt; { };
 787         comboBox.setOnAction(onAction);
 788         assertEquals(onAction, comboBox.getOnAction());
 789     }
 790 
 791     @Test public void ensureOnActionPropertyReferencesBean() {
 792         assertEquals(comboBox, comboBox.onActionProperty().getBean());
 793     }
 794 
 795     /*********************************************************************
 796      * Tests for property binding                                        *
 797      ********************************************************************/
 798     @Test public void checkPromptTextPropertyBind() {
 799         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 800         comboBox.promptTextProperty().bind(strPr);
 801         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;value&quot;));
 802         strPr.setValue(&quot;newvalue&quot;);
 803         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;newvalue&quot;));
 804     }
 805 
 806     @Test public void checkValuePropertyBind() {
 807         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 808         comboBox.valueProperty().bind(strPr);
 809         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;value&quot;));
 810         strPr.setValue(&quot;newvalue&quot;);
 811         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;newvalue&quot;));
 812     }
 813 
 814 
 815 
 816     /*********************************************************************
 817      * Tests for bug reports                                             *
 818      ********************************************************************/
 819 
 820     @Test public void test_rt18972() {
 821         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 822         sm.select(1);
 823         assertTrue(sm.isSelected(1));
 824 
 825         comboBox.setEditable(true);
 826         comboBox.setValue(&quot;New Value&quot;);
 827 
 828         // there should be no selection in the selection model, as &quot;New Value&quot;
 829         // isn&#39;t an item in the list, however, it is a totally valid value for
 830         // the value property
 831         assertFalse(sm.isSelected(1));
 832         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 833         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 834 
 835         comboBox.setEditable(false);
 836         assertEquals(-1, sm.getSelectedIndex());
 837         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 838         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 839     }
 840 
 841     @Test public void test_rt18941() {
 842         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 843         comboBox.setValue(&quot;Orange&quot;);
 844         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 845         assertEquals(&quot;Orange&quot;, comboBox.getSelectionModel().getSelectedItem());
 846         assertTrue(&quot;Selected Index: &quot; + sm.getSelectedIndex(), sm.isSelected(1));
 847     }
 848 
 849     @Test public void test_rt19227() {
 850         comboBox.getItems().addAll(&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;);
 851         comboBox.getSelectionModel().select(2);
 852         assertEquals(&quot;0&quot;, comboBox.getValue());
 853         assertEquals(&quot;0&quot;, comboBox.getSelectionModel().getSelectedItem());
 854         assertTrue(sm.isSelected(2));
 855     }
 856 
 857     @Ignore(&quot;JDK-8091127 Test not working as the heights being returned are not accurate&quot;)
 858     @Test public void test_rt20106() {
 859         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 860 
 861         Stage stage = new Stage();
 862         Scene scene = new Scene(comboBox);
 863         stage.setScene(scene);
 864         comboBox.applyCss();
 865         comboBox.show();
 866 
 867         comboBox.setVisibleRowCount(5);
 868         double initialHeight = getListView().getHeight();
 869         assertFalse(&quot;initialHeight: &quot; + initialHeight, Double.compare(0.0, initialHeight) == 0);
 870 
 871         comboBox.setVisibleRowCount(0);
 872         double smallHeight =    getListView().getHeight();
 873         assertTrue(&quot;smallHeight: &quot; + smallHeight + &quot;, initialHeight: &quot; + initialHeight,
 874                 smallHeight != initialHeight &amp;&amp; smallHeight &lt; initialHeight);
 875 
 876         comboBox.setVisibleRowCount(7);
 877         double biggerHeight = getListView().getHeight();
 878         assertTrue(biggerHeight != smallHeight &amp;&amp; smallHeight &lt; biggerHeight);
 879     }
 880 
 881     private int count = 0;
 882     @Test public void test_rt20103() {
 883         final TextField tf = new TextField();
 884 
 885         comboBox.setOnAction(t -&gt; {
 886             count++;
 887         });
 888 
 889         assertTrue(count == 0);
 890 
 891         comboBox.valueProperty().bind(tf.textProperty());   // count++ here
 892         assertTrue(&quot;count: &quot; + count, count == 1);
 893 
 894         tf.setText(&quot;Text1&quot;);                                // count++ here
 895         assertTrue(&quot;count: &quot; + count, count == 2);
 896 
 897         comboBox.valueProperty().unbind();                  // no count++ here
 898         assertTrue(&quot;count: &quot; + count, count == 2);
 899 
 900         comboBox.valueProperty().bindBidirectional(tf.textProperty());  // count++ here
 901         tf.setText(&quot;Text2&quot;);
 902         assertTrue(&quot;count: &quot; + count, count == 3);
 903     }
 904 
 905     @Ignore(&quot;Test not working as the skin is not being properly instantiated&quot;)
 906     @Test public void test_rt20100() {
 907         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 908 
 909         Stage stage = new Stage();
 910         Scene scene = new Scene(comboBox);
 911         stage.setScene(scene);
 912         comboBox.applyCss();
 913         comboBox.show();
 914 
 915         comboBox.setConverter(new StringConverter() {
 916             int toStringCounter = 0;
 917             int fromStringCounter = 0;
 918 
 919             @Override public String toString(Object t) {
 920                 return &quot;TO_STRING&quot;;
 921             }
 922 
 923             @Override public Object fromString(String string) {
 924                 return &quot;FROM_STRING&quot;;
 925             }
 926         });
 927 
 928         comboBox.getSelectionModel().select(2);
 929         assertEquals(&quot;2&quot;, comboBox.getValue());
 930 
 931         ListView listView = getListView();
 932 //        listView.applyCss();
 933 
 934         assertEquals(&quot;2&quot;, listView.getSelectionModel().getSelectedItem());
 935 
 936         System.out.println(listView.getSkin());
 937 
 938         VirtualFlow flow = (VirtualFlow)listView.lookup(&quot;#virtual-flow&quot;);
 939         assertNotNull(flow);
 940 
 941         IndexedCell cell = flow.getVisibleCell(2);
 942         System.out.println(&quot;cell: &quot; + cell);
 943         assertEquals(&quot;TO_STRING&quot;, cell.getText());
 944     }
 945 
 946     @Test public void test_rt20189() {
 947         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 948 
 949         Stage stage = new Stage();
 950         Scene scene = new Scene(comboBox);
 951         stage.setScene(scene);
 952         comboBox.applyCss();
 953         comboBox.show();
 954 
 955         comboBox.getSelectionModel().select(2);
 956         Object item = sm.getSelectedItem();
 957         assertEquals(&quot;2&quot;, item);
 958         assertEquals(2, sm.getSelectedIndex());
 959 
 960         comboBox.setValue(&quot;test&quot;);
 961         item = sm.getSelectedItem();
 962         assertEquals(&quot;test&quot;,item);
 963         assertEquals(-1, sm.getSelectedIndex());
 964 
 965         comboBox.getSelectionModel().select(2);
 966         item = sm.getSelectedItem();
 967         assertEquals(&quot;2&quot;, item);
 968         assertEquals(2, sm.getSelectedIndex());
 969     }
 970 
 971     @Test public void test_rt27654() {
 972         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 973 
 974         SingleSelectionModel sm = comboBox.getSelectionModel();
 975 
 976         Stage stage = new Stage();
 977         Scene scene = new Scene(comboBox);
 978         stage.setScene(scene);
 979         comboBox.applyCss();
 980         comboBox.show();
 981         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
 982 
 983         sm.select(2);
 984         assertEquals(&quot;2&quot;, sm.getSelectedItem());
 985         assertEquals(&quot;2&quot;, comboBox.getValue());
 986         assertEquals(&quot;2&quot;, buttonCell.getText());
 987         assertEquals(2, sm.getSelectedIndex());
 988 
 989         sm.clearSelection();
 990         assertNull(sm.getSelectedItem());
 991         assertNull(comboBox.getValue());
 992         assertNull(buttonCell.getText());
 993         assertEquals(-1, sm.getSelectedIndex());
 994 
 995         sm.select(2);
 996         assertEquals(&quot;2&quot;, sm.getSelectedItem());
 997         assertEquals(&quot;2&quot;, comboBox.getValue());
 998         assertEquals(&quot;2&quot;, buttonCell.getText());
 999         assertEquals(2, sm.getSelectedIndex());
1000     }
1001 
1002     @Test public void test_rt24412() {
1003         SingleSelectionModel sm = comboBox.getSelectionModel();
1004 
1005         Stage stage = new Stage();
1006         Scene scene = new Scene(comboBox);
1007         stage.setScene(scene);
1008         comboBox.applyCss();
1009         comboBox.show();
1010         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
1011 
1012         comboBox.getItems().setAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
1013 
1014         sm.select(&quot;2&quot;);
1015         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1016         assertEquals(&quot;2&quot;, comboBox.getValue());
1017         assertEquals(&quot;2&quot;, buttonCell.getText());
1018         assertEquals(2, sm.getSelectedIndex());
1019 
1020         sm.clearSelection();
1021         assertNull(sm.getSelectedItem());
1022         assertNull(comboBox.getValue());
1023         assertNull(buttonCell.getText());
1024         assertEquals(-1, sm.getSelectedIndex());
1025 
1026         sm.select(&quot;2&quot;);
1027         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1028         assertEquals(&quot;2&quot;, comboBox.getValue());
1029         assertEquals(&quot;2&quot;, buttonCell.getText());
1030         assertEquals(2, sm.getSelectedIndex());
1031     }
1032 
1033     @Test public void test_rt28245() {
1034         final ObservableList&lt;String&gt; strings = FXCollections.observableArrayList(
1035             &quot;Option 1&quot;, &quot;Option 2&quot;, &quot;Option 3&quot;
1036         );
1037 
1038         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1039         comboBox.setItems(strings);
1040         comboBox.setEditable(true);
1041         comboBox.valueProperty().addListener((ov, t, t1) -&gt; {
1042             if (t == null &amp;&amp; t1.isEmpty()) {
1043                 fail(&quot;Old value is &#39;&quot; + t + &quot;&#39; and new value is &#39;&quot; + t1 + &quot;&#39;.&quot;);
1044             }
1045         });
1046 
1047         StageLoader sl = new StageLoader(comboBox);
1048 
1049         assertNull(comboBox.getValue());
1050         assertTrue(comboBox.getEditor().getText().isEmpty());
1051 
1052         comboBox.requestFocus();
1053 
1054         new KeyEventFirer(comboBox).doKeyPress(KeyCode.ENTER);
1055 
1056         sl.dispose();
1057     }
1058 
1059     @Test public void test_rt31479() {
1060         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1061 
1062         StageLoader sl = new StageLoader(comboBox);
1063 
1064         final double widthBefore = comboBox.getWidth();
1065 
1066         // add item
1067         comboBox.getItems().add(&quot;Option 1&quot;);
1068 
1069         // open and close combobox
1070         comboBox.show();
1071         comboBox.hide();
1072 
1073         // set a placeholder
1074         comboBox.setPlaceholder(new Circle(12, Color.RED));
1075 
1076         // remove item
1077         comboBox.getItems().clear();
1078 
1079         // fire pulse (this allows layout to cause the size to grow)
1080         Toolkit.getToolkit().firePulse();
1081 
1082         // test size
1083         assertEquals(widthBefore, comboBox.getWidth(), 0.00);
1084 
1085         sl.dispose();
1086     }
1087 
1088     @Test public void test_rt32139() {
1089         final ObservableList&lt;String&gt; items =
1090                 FXCollections.observableArrayList(&quot;Good value&quot;, &quot;Bad value&quot;);
1091 
1092         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1093         comboBox.getSelectionModel().select(0);
1094 
1095         comboBox.getSelectionModel().selectedIndexProperty().addListener((ov, oldIdx, newIdx) -&gt; {
1096             if (newIdx.intValue() != 0) {
1097                 comboBox.getSelectionModel().select(0);
1098             }
1099         });
1100 
1101         StageLoader sl = new StageLoader(comboBox);
1102 
1103         try {
1104             comboBox.getSelectionModel().select(1);
1105         } catch (StackOverflowError e) {
1106             fail(&quot;Stack overflow should not happen here&quot;);
1107         }
1108 
1109         sl.dispose();
1110     }
1111 
1112     @Test public void test_rt21186() {
1113         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1114         comboBox.setEditable(true);
1115 
1116         StageLoader sl = new StageLoader(comboBox);
1117 
1118         assertNull(comboBox.getTooltip());
1119         assertNull(comboBox.getEditor().getTooltip());
1120 
1121         Tooltip tooltip = new Tooltip(&quot;Tooltip&quot;);
1122         comboBox.setTooltip(tooltip);
1123         assertEquals(tooltip, comboBox.getTooltip());
1124         assertEquals(tooltip, comboBox.getEditor().getTooltip());
1125 
1126         comboBox.setTooltip(null);
1127         assertNull(comboBox.getTooltip());
1128         assertNull(comboBox.getEditor().getTooltip());
1129 
1130         sl.dispose();
1131     }
1132 
1133     @Test public void test_rt34573() {
1134         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1135 
1136         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1137             @Override public void updateItem(String item, boolean empty) {
1138                 super.updateItem(item, empty);
1139                 setText(item);
1140             }
1141         };
1142         comboBox.setButtonCell(customCell);
1143 
1144         StageLoader sl = new StageLoader(comboBox);
1145 
1146         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1147         comboBox.setValue(&quot;B&quot;);
1148         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1149         assertEquals(1, comboBox.getButtonCell().getIndex());
1150 
1151         comboBox.setItems(FXCollections.observableArrayList(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;));
1152         assertNull(comboBox.getButtonCell().getText());
1153         assertEquals(-1, comboBox.getButtonCell().getIndex());
1154 
1155         sl.dispose();
1156     }
1157 
1158     @Test public void test_rt34566() {
1159         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1160 
1161         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1162             @Override public void updateItem(String item, boolean empty) {
1163                 super.updateItem(item, empty);
1164                 setText(item);
1165             }
1166         };
1167         comboBox.setButtonCell(customCell);
1168 
1169         StageLoader sl = new StageLoader(comboBox);
1170 
1171         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1172 
1173         PseudoClass empty = PseudoClass.getPseudoClass(&quot;empty&quot;);
1174 
1175         comboBox.setValue(&quot;B&quot;);
1176         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1177         assertEquals(1, comboBox.getButtonCell().getIndex());
1178         assertFalse(customCell.getPseudoClassStates().contains(empty));
1179 
1180         comboBox.setValue(null);
1181         Toolkit.getToolkit().firePulse();
1182         assertNull(comboBox.getButtonCell().getText());
1183         assertEquals(-1, comboBox.getButtonCell().getIndex());
1184         assertTrue(customCell.getPseudoClassStates().contains(empty));
1185 
1186         comboBox.setValue(&quot;A&quot;);
1187         assertEquals(&quot;A&quot;, comboBox.getButtonCell().getText());
1188         assertEquals(0, comboBox.getButtonCell().getIndex());
1189         assertFalse(customCell.getPseudoClassStates().contains(empty));
1190 
1191         sl.dispose();
1192     }
1193 
1194     private int test_rt34603_count = 0;
1195     @Test public void test_rt34603() {
1196         assertEquals(0, test_rt34603_count);
1197 
1198         VBox hbox = new VBox(10);
1199 
1200         ComboBox&lt;String&gt; box = new ComboBox&lt;&gt;();
1201         box.getItems().add(&quot;test&quot;);
1202         box.setEditable(true);
1203         box.getSelectionModel().selectFirst();
1204 
1205         Button defaultButton = new Button(&quot;press&quot;);
1206         defaultButton.setOnAction(arg0 -&gt; {
1207             test_rt34603_count++;
1208         });
1209         defaultButton.setDefaultButton(true);
1210 
1211         hbox.getChildren().addAll(box, defaultButton);
1212 
1213         StageLoader sl = new StageLoader(hbox);
1214 
1215         box.getEditor().requestFocus();
1216         KeyEventFirer keyboard = new KeyEventFirer(box);
1217         keyboard.doKeyPress(KeyCode.ENTER);
1218 
1219         assertEquals(1, test_rt34603_count);
1220 
1221         sl.dispose();
1222     }
1223 
1224     private int test_rt35586_count = 0;
1225     @Test public void test_rt35586() {
1226         assertEquals(0, test_rt35586_count);
1227 
1228         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1229         cb.setEditable(true);
1230         cb.setOnAction(event -&gt; {
1231             test_rt35586_count++;
1232             assertEquals(&quot;Test&quot;, cb.getEditor().getText());
1233         });
1234 
1235         StageLoader sl = new StageLoader(cb);
1236 
1237         cb.requestFocus();
1238         cb.getEditor().setText(&quot;Test&quot;);
1239         KeyEventFirer keyboard = new KeyEventFirer(cb);
1240         keyboard.doKeyPress(KeyCode.ENTER);
1241 
1242         assertEquals(1, test_rt35586_count);
1243 
1244         sl.dispose();
1245     }
1246 
1247     @Test public void test_rt35039() {
1248         final List&lt;String&gt; data = new ArrayList&lt;&gt;();
1249         data.add(&quot;aabbaa&quot;);
1250         data.add(&quot;bbc&quot;);
1251 
1252         final ComboBox&lt;String&gt; combo = new ComboBox&lt;&gt;();
1253         combo.setEditable(true);
1254         combo.setItems(FXCollections.observableArrayList(data));
1255 
1256         StageLoader sl = new StageLoader(combo);
1257 
1258         // everything should be null to start with
1259         assertNull(combo.getValue());
1260         assertTrue(combo.getEditor().getText().isEmpty());
1261         assertNull(combo.getSelectionModel().getSelectedItem());
1262 
1263         // select &quot;bbc&quot; and ensure everything is set to that
1264         combo.getSelectionModel().select(1);
1265         assertEquals(&quot;bbc&quot;, combo.getValue());
1266         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1267         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1268 
1269         // change the items list - but retain the same content. We expect
1270         // that &quot;bbc&quot; remains selected as it is still in the list
1271         combo.setItems(FXCollections.observableArrayList(data));
1272         assertEquals(&quot;bbc&quot;, combo.getValue());
1273         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1274         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1275 
1276         sl.dispose();
1277     }
1278 
1279     @Test public void test_rt35840() {
1280         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1281         cb.setEditable(true);
1282         StageLoader sl = new StageLoader(cb);
1283         cb.requestFocus();
1284 
1285         KeyEventFirer keyboard = new KeyEventFirer(cb);
1286         keyboard.doKeyTyped(KeyCode.T);
1287         keyboard.doKeyTyped(KeyCode.E);
1288         keyboard.doKeyTyped(KeyCode.S);
1289         keyboard.doKeyTyped(KeyCode.T);
1290         assertEquals(&quot;TEST&quot;, cb.getEditor().getText());
1291 
1292         assertNull(cb.getValue());
1293         keyboard.doKeyPress(KeyCode.ENTER);
1294         assertEquals(&quot;TEST&quot;, cb.getValue());
1295 
1296         sl.dispose();
1297     }
1298 
1299     @Test public void test_rt36280_nonEditable_F4ShowsPopup() {
1300         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1301         StageLoader sl = new StageLoader(cb);
1302         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1303 
1304         assertFalse(cb.isShowing());
1305         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1306         assertTrue(cb.isShowing());
1307 
1308         sl.dispose();
1309     }
1310 
1311     @Test public void test_rt36280_nonEditable_altUpShowsPopup() {
1312         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1313         StageLoader sl = new StageLoader(cb);
1314         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1315 
1316         assertFalse(cb.isShowing());
1317         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1318         assertTrue(cb.isShowing());
1319 
1320         sl.dispose();
1321     }
1322 
1323     @Test public void test_rt36280_nonEditable_altDownShowsPopup() {
1324         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1325         StageLoader sl = new StageLoader(cb);
1326         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1327 
1328         new StageLoader(cb);
1329 
1330         assertFalse(cb.isShowing());
1331         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1332         assertTrue(cb.isShowing());
1333 
1334         sl.dispose();
1335     }
1336 
1337     @Test public void test_EditorKeyInputsWhenPopupIsShowing() {
1338         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1339         cb.setEditable(true);
1340         StageLoader sl = new StageLoader(cb);
1341         KeyEventFirer keyboard = new KeyEventFirer(cb);
1342 
1343         new StageLoader(cb);
1344 
1345         // Show the popup
1346         assertFalse(cb.isShowing());
1347         cb.requestFocus();
1348         cb.getEditor().setText(&quot;ABC DEF&quot;);
1349         assertEquals(&quot;ABC DEF&quot;, cb.getEditor().getText());
1350         keyboard.doDownArrowPress(KeyModifier.ALT);
1351         // Sanity
1352         assertTrue(cb.isShowing());
1353         assertEquals(0, cb.getEditor().getCaretPosition());
1354 
1355         // LEFT, RIGHT keys with CTRL, SHIFT modifiers
1356         // Test RIGHT key
1357         keyboard.doRightArrowPress();
1358         assertEquals(1, cb.getEditor().getCaretPosition());
1359 
1360         // Test KP_RIGHT key
1361         keyboard.doKeyPress(KeyCode.KP_RIGHT);
1362         assertEquals(2, cb.getEditor().getCaretPosition());
1363 
1364         // Test LEFT key
1365         keyboard.doLeftArrowPress();
1366         assertEquals(1, cb.getEditor().getCaretPosition());
1367 
1368         // Test KP_LEFT key
1369         keyboard.doKeyPress(KeyCode.KP_LEFT);
1370         assertEquals(0, cb.getEditor().getCaretPosition());
1371 
1372         // Test SHIFT + RIGHT key
1373         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);
1374         assertEquals(&quot;A&quot;, cb.getEditor().getSelectedText());
1375         assertEquals(1, cb.getEditor().getCaretPosition());
1376 
1377         // Test SHIFT + LEFT key
1378         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT);
1379         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1380         assertEquals(0, cb.getEditor().getCaretPosition());
1381 
1382         // Test CTRL + RIGHT key
1383         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.CTRL);
1384         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1385         assertEquals(4, cb.getEditor().getCaretPosition());
1386 
1387         // Test CTRL + LEFT key
1388         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.CTRL);
1389         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1390         assertEquals(0, cb.getEditor().getCaretPosition());
1391 
1392         // Test CTRL + SHIFT + RIGHT key
1393         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.CTRL, KeyModifier.SHIFT);
1394         assertEquals(&quot;ABC &quot;, cb.getEditor().getSelectedText());
1395         assertEquals(4, cb.getEditor().getCaretPosition());
1396 
1397         // Test CTRL + SHIFT + LEFT key
1398         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.CTRL, KeyModifier.SHIFT);
1399         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1400         assertEquals(0, cb.getEditor().getCaretPosition());
1401 
1402         // HOME, END keys with CTRL, SHIFT modifiers
1403         // Test END key
1404         keyboard.doKeyPress(KeyCode.END);
1405         assertEquals(7, cb.getEditor().getCaretPosition());
1406 
1407         // Test HOME key
1408         keyboard.doKeyPress(KeyCode.HOME);
1409         assertEquals(0, cb.getEditor().getCaretPosition());
1410 
1411         // Test SHIFT + END key
1412         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
1413         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());
1414         assertEquals(7, cb.getEditor().getCaretPosition());
1415 
1416         // Test SHIFT + HOME key
1417         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
1418         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1419         assertEquals(0, cb.getEditor().getCaretPosition());
1420 
1421         // Test CTRL + END key
1422         keyboard.doKeyPress(KeyCode.END, KeyModifier.CTRL);
1423         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1424         assertEquals(7, cb.getEditor().getCaretPosition());
1425 
1426         // Test CTRL + HOME key
1427         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.CTRL);
1428         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1429         assertEquals(0, cb.getEditor().getCaretPosition());
1430 
1431         /* @Ignore(JBS-8250807)
1432         // Test CTRL + SHIFT + END key
1433         keyboard.doKeyPress(KeyCode.END, KeyModifier.CTRL, KeyModifier.SHIFT);
1434         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());
1435         assertEquals(7, cb.getEditor().getCaretPosition());
1436 
1437         // Test CTRL + SHIFT + HOME key
1438         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.CTRL, KeyModifier.SHIFT);
1439         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1440         assertEquals(0, cb.getEditor().getCaretPosition());
1441          */
1442 
1443         // Test CTRL + A key
1444         keyboard.doLeftArrowPress();
1445         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());
1446         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
1447         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());
1448 
1449         // Sanity
1450         assertTrue(cb.isShowing());
1451 
1452         sl.dispose();
1453     }
1454 
1455     @Test public void test_rt36280_nonEditable_enterHidesShowingPopup() {
1456         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1457         StageLoader sl = new StageLoader(cb);
1458         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1459 
1460         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1461         assertNotNull(listView);
1462 
1463         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1464 
1465         assertFalse(cb.isShowing());
1466         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1467         assertTrue(cb.isShowing());
1468         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1469         assertFalse(cb.isShowing());
1470 
1471         sl.dispose();
1472     }
1473 
1474     @Test public void test_rt36280_nonEditable_spaceHidesShowingPopup() {
1475         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1476         StageLoader sl = new StageLoader(cb);
1477         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1478 
1479         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1480         assertNotNull(listView);
1481 
1482         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1483 
1484         assertFalse(cb.isShowing());
1485         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1486         assertTrue(cb.isShowing());
1487         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1488         assertFalse(cb.isShowing());
1489 
1490         sl.dispose();
1491     }
1492 
1493     @Test public void test_rt36280_nonEditable_escapeHidesShowingPopup() {
1494         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1495         StageLoader sl = new StageLoader(cb);
1496         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1497 
1498         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1499         assertNotNull(listView);
1500 
1501         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1502 
1503         assertFalse(cb.isShowing());
1504         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1505         assertTrue(cb.isShowing());
1506         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1507         assertFalse(cb.isShowing());
1508 
1509         sl.dispose();
1510     }
1511 
1512     @Test public void test_rt36280_nonEditable_F4HidesShowingPopup() {
1513         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1514         StageLoader sl = new StageLoader(cb);
1515         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1516 
1517         assertFalse(cb.isShowing());
1518         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1519         assertTrue(cb.isShowing());
1520         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1521         assertFalse(cb.isShowing());
1522 
1523         sl.dispose();
1524     }
1525 
1526     @Test public void test_rt36280_nonEditable_arrowKeysChangeSelection() {
1527         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1528         StageLoader sl = new StageLoader(cb);
1529         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1530 
1531         assertFalse(cb.isShowing());
1532         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1533         assertTrue(cb.isShowing());
1534 
1535         assertNull(cb.getSelectionModel().getSelectedItem());
1536 
1537         cbKeyboard.doDownArrowPress();
1538         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1539 
1540         cbKeyboard.doDownArrowPress();
1541         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1542 
1543         cbKeyboard.doUpArrowPress();
1544         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1545 
1546         sl.dispose();
1547     }
1548 
1549     @Test public void test_rt36280_editable_F4ShowsPopup() {
1550         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1551         cb.setEditable(true);
1552         StageLoader sl = new StageLoader(cb);
1553         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1554 
1555         assertFalse(cb.isShowing());
1556         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1557         assertTrue(cb.isShowing());
1558 
1559         sl.dispose();
1560     }
1561 
1562     @Test public void test_rt36280_editable_altUpShowsPopup() {
1563         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1564         cb.setEditable(true);
1565         StageLoader sl = new StageLoader(cb);
1566         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1567 
1568         assertFalse(cb.isShowing());
1569         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1570         assertTrue(cb.isShowing());
1571 
1572         sl.dispose();
1573     }
1574 
1575     @Test public void test_rt36280_editable_altDownShowsPopup_onComboBox() {
1576         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1577         cb.setEditable(true);
1578         StageLoader sl = new StageLoader(cb);
1579         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1580 
1581         assertFalse(cb.isShowing());
1582         assertTrue(cb.getEditor().getText().isEmpty());
1583         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1584         assertTrue(cb.isShowing());
1585         assertTrue(cb.getEditor().getText().isEmpty());
1586 
1587         sl.dispose();
1588     }
1589 
1590     @Test public void test_rt36280_editable_altDownShowsPopup_onTextField() {
1591         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1592         cb.setEditable(true);
1593         StageLoader sl = new StageLoader(cb);
1594 
1595         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1596         assertFalse(cb.isShowing());
1597         assertTrue(cb.getEditor().getText().isEmpty());
1598         tfKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1599         assertTrue(cb.isShowing());
1600         assertTrue(cb.getEditor().getText().isEmpty());
1601 
1602         sl.dispose();
1603     }
1604 
1605     @Test public void test_rt36280_editable_enterHidesShowingPopup() {
1606         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1607         cb.setEditable(true);
1608         StageLoader sl = new StageLoader(cb);
1609         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1610 
1611         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1612         assertNotNull(listView);
1613 
1614         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1615 
1616         assertFalse(cb.isShowing());
1617         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1618         assertTrue(cb.isShowing());
1619         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1620         assertFalse(cb.isShowing());
1621 
1622         sl.dispose();
1623     }
1624 
1625     @Test public void test_rt36280_editable_spaceHidesShowingPopup() {
1626         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1627         cb.setEditable(true);
1628         StageLoader sl = new StageLoader(cb);
1629         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1630 
1631         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1632         assertNotNull(listView);
1633 
1634         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1635 
1636         assertFalse(cb.isShowing());
1637         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1638         assertTrue(cb.isShowing());
1639         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1640         assertFalse(cb.isShowing());
1641 
1642         sl.dispose();
1643     }
1644 
1645     @Test public void test_rt36280_editable_escapeHidesShowingPopup() {
1646         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1647         cb.setEditable(true);
1648         StageLoader sl = new StageLoader(cb);
1649         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1650 
1651         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1652         assertNotNull(listView);
1653 
1654         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1655 
1656         assertFalse(cb.isShowing());
1657         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1658         assertTrue(cb.isShowing());
1659         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1660         assertFalse(cb.isShowing());
1661 
1662         sl.dispose();
1663     }
1664 
1665     @Test public void test_rt36280_editable_F4HidesShowingPopup() {
1666         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1667         cb.setEditable(true);
1668         StageLoader sl = new StageLoader(cb);
1669         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1670 
1671         assertFalse(cb.isShowing());
1672         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1673         assertTrue(cb.isShowing());
1674         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1675         assertFalse(cb.isShowing());
1676 
1677         sl.dispose();
1678     }
1679 
1680     @Test public void test_rt36280_editable_arrowKeysChangeSelection() {
1681         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1682         cb.setEditable(true);
1683         StageLoader sl = new StageLoader(cb);
1684         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1685 
1686         assertFalse(cb.isShowing());
1687         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1688         assertTrue(cb.isShowing());
1689 
1690         assertNull(cb.getSelectionModel().getSelectedItem());
1691 
1692         cbKeyboard.doDownArrowPress();
1693         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1694 
1695         cbKeyboard.doDownArrowPress();
1696         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1697 
1698         cbKeyboard.doUpArrowPress();
1699         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1700 
1701         sl.dispose();
1702     }
1703 
1704     @Test public void test_rt36651() {
1705         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1706         cb.setEditable(true);
1707         StageLoader sl = new StageLoader(cb);
1708 
1709         assertNull(cb.getValue());
1710         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1711         assertNull(cb.getSelectionModel().getSelectedItem());
1712 
1713         sl.getStage().requestFocus();
1714         cb.show();
1715         Toolkit.getToolkit().firePulse();
1716 
1717         // selection should not change just by showing the popup
1718         assertNull(cb.getValue());
1719         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1720         assertNull(cb.getSelectionModel().getSelectedItem());
1721 
1722         sl.dispose();
1723     }
1724 
1725     @Test public void test_rt36717() {
1726         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1727         StageLoader sl = new StageLoader(cb);
1728 
1729         // the stack overflow only occurs when a ComboBox changes from non-editable to editable
1730         cb.setEditable(false);
1731         cb.setEditable(true);
1732         assertNotNull(cb.getEditor());
1733         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1734         tfKeyboard.doKeyPress(KeyCode.ENTER);   // Stack overflow here
1735 
1736         sl.dispose();
1737     }
1738 
1739     @Test public void test_rt36827() {
1740         final Button btn = new Button(&quot;focus owner&quot;);
1741         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1742         VBox vbox = new VBox(btn, cb);
1743 
1744         StageLoader sl = new StageLoader(vbox);
1745         sl.getStage().requestFocus();
1746         btn.requestFocus();
1747         Toolkit.getToolkit().firePulse();
1748         Scene scene = sl.getStage().getScene();
1749 
1750         assertTrue(btn.isFocused());
1751         assertEquals(btn, scene.getFocusOwner());
1752 
1753         MouseEventFirer mouse = new MouseEventFirer(cb);
1754         mouse.fireMousePressAndRelease();
1755 
1756         assertTrue(cb.isShowing());
1757         assertTrue(cb.isFocused());
1758         assertEquals(cb, scene.getFocusOwner());
1759 
1760         sl.dispose();
1761     }
1762 
1763     @Test public void test_rt36902() {
1764         final ComboBox&lt;String&gt; cb1 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1765         final ComboBox&lt;String&gt; cb2 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1766         cb2.setEditable(true);
1767         VBox vbox = new VBox(cb1, cb2);
1768 
1769         // lame - I would rather have one keyboard here but I couldn&#39;t get it to
1770         // work, so watch out for which keyboard is used below
1771         KeyEventFirer cb1Keyboard = new KeyEventFirer(cb1);
1772         KeyEventFirer cb2Keyboard = new KeyEventFirer(cb2);
1773 
1774         StageLoader sl = new StageLoader(vbox);
1775         sl.getStage().requestFocus();
1776         cb1.requestFocus();
1777         Toolkit.getToolkit().firePulse();
1778         Scene scene = sl.getStage().getScene();
1779 
1780         assertTrue(cb1.isFocused());
1781         assertEquals(cb1, scene.getFocusOwner());
1782 
1783         // move focus forward to cb2
1784         cb1Keyboard.doKeyPress(KeyCode.TAB);
1785         assertTrue(cb2.isFocused());
1786         assertEquals(cb2, scene.getFocusOwner());
1787 
1788         // move focus forward again to cb1
1789         cb2Keyboard.doKeyPress(KeyCode.TAB);
1790         assertTrue(cb1.isFocused());
1791         assertEquals(cb1, scene.getFocusOwner());
1792 
1793         // now start going backwards with shift-tab.
1794         // The first half of the bug is here - when we shift-tab into cb2, we
1795         // actually go into the FakeFocusTextField subcomponent, so whilst the
1796         // cb2.isFocused() returns true as expected, the scene focus owner is
1797         // not the ComboBox, but the FakeFocusTextField inside it
1798         cb1Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1799         assertTrue(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1800                 cb2.isFocused());
1801         // Updated with fix for RT-34602: The TextField now never gets
1802         // focus (it&#39;s just faking it).
1803         // assertEquals(&quot;Expect cb2 TextField to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1804         //         cb2.getEditor(), scene.getFocusOwner());
1805         assertEquals(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1806                      cb2, scene.getFocusOwner());
1807 
1808         // This is where the second half of the bug appears, as we are stuck in
1809         // the FakeFocusTextField of cb2, we never make it to cb1
1810         cb2Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1811         assertTrue(cb1.isFocused());
1812         assertEquals(cb1, scene.getFocusOwner());
1813 
1814         sl.dispose();
1815     }
1816 
1817     private int rt_38901_counter;
1818     @Test public void test_rt_38901_selectNull() {
1819         test_rt_38901(true);
1820     }
1821 
1822     @Test public void test_rt_38901_selectNegativeOne() {
1823         test_rt_38901(false);
1824     }
1825 
1826     private void test_rt_38901(boolean selectNull) {
1827         rt_38901_counter = 0;
1828 
1829         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1830         cb.setOnShowing((e) -&gt; {
1831             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_38901_counter++));
1832         });
1833 
1834         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1835         assertNull(cb.getSelectionModel().getSelectedItem());
1836         assertNull(cb.getValue());
1837         assertEquals(0, cb.getItems().size());
1838 
1839         // round one
1840         cb.show();
1841         assertEquals(1, cb.getItems().size());
1842         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1843         cb.hide();
1844 
1845         cb.getSelectionModel().select(0);
1846         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1847         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1848         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1849 
1850         if (selectNull) cb.getSelectionModel().select(null);
1851         else cb.getSelectionModel().select(-1);
1852 
1853         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1854         assertNull(cb.getSelectionModel().getSelectedItem());
1855         assertNull(cb.getValue());
1856 
1857 
1858         // round two
1859         cb.show();
1860         assertEquals(1, cb.getItems().size());
1861         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1862         cb.hide();
1863 
1864         cb.getSelectionModel().select(0);
1865         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1866         assertEquals(&quot;DUMMY 1&quot;, cb.getSelectionModel().getSelectedItem());
1867         assertEquals(&quot;DUMMY 1&quot;, cb.getValue());
1868 
1869         if (selectNull) cb.getSelectionModel().select(null);
1870         else cb.getSelectionModel().select(-1);
1871 
1872         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1873         assertNull(cb.getSelectionModel().getSelectedItem());
1874         assertNull(cb.getValue());
1875     }
1876 
1877     private int rt_22572_counter;
1878     @Test public void test_rt_22572() {
1879         rt_22572_counter = 0;
1880 
1881         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1882         cb.setOnShowing((e) -&gt; {
1883             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22572_counter++));
1884         });
1885 
1886         StageLoader sl = new StageLoader(cb);
1887 
1888         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1889         assertNull(cb.getSelectionModel().getSelectedItem());
1890         assertNull(cb.getValue());
1891         assertEquals(0, cb.getItems().size());
1892 
1893         // round one
1894         cb.show();
1895         assertEquals(1, cb.getItems().size());
1896         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1897         cb.hide();
1898 
1899         cb.getSelectionModel().select(0);
1900         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1901         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1902         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1903 
1904 
1905         // round two - even though the items change, the value should still be
1906         // the old value (even though it doesn&#39;t exist in the items list any longer).
1907         // The selectedIndex and selectedItem do get reset however.
1908         cb.show();
1909         assertEquals(1, cb.getItems().size());
1910         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1911         cb.hide();
1912 
1913         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1914         assertNull(cb.getSelectionModel().getSelectedItem());
1915         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1916 
1917         sl.dispose();
1918     }
1919 
1920     private int rt_22937_counter;
1921     @Test public void test_rt_22937() {
1922         rt_22937_counter = 0;
1923 
1924         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1925         cb.setOnShowing((e) -&gt; {
1926             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22937_counter++));
1927         });
1928 
1929         cb.getItems().add(&quot;Toto&quot;);
1930         cb.setEditable(true);
1931         cb.setValue(&quot;Tata&quot;);
1932 
1933         StageLoader sl = new StageLoader(cb);
1934 
1935         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1936         assertEquals(&quot;Tata&quot;, cb.getSelectionModel().getSelectedItem());
1937         assertEquals(&quot;Tata&quot;, cb.getValue());
1938         assertEquals(1, cb.getItems().size());
1939 
1940         cb.show();
1941         assertEquals(1, cb.getItems().size());
1942         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1943         cb.hide();
1944 
1945         cb.getSelectionModel().select(0);
1946         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1947         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1948         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1949 
1950         sl.dispose();
1951     }
1952 
1953     @Test public void test_rt_39809() {
1954         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1955         comboBox.getItems().setAll(null, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
1956 
1957         StageLoader sl = new StageLoader(comboBox);
1958 
1959         comboBox.getSelectionModel().clearAndSelect(1);
1960         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1961         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1962 
1963         comboBox.getSelectionModel().clearAndSelect(0);
1964         assertEquals(null, comboBox.getSelectionModel().getSelectedItem());
1965         assertEquals(0, comboBox.getSelectionModel().getSelectedIndex());
1966 
1967         sl.dispose();
1968     }
1969 
1970     @Test public void test_rt_39908() {
1971         ObservableList&lt;String&gt; model = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
1972         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(model);
1973 
1974         StageLoader sl = new StageLoader(comboBox);
1975 
1976         comboBox.getSelectionModel().clearAndSelect(1);
1977         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1978         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1979 
1980         model.set(0, &quot;a&quot;);
1981         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
1982         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
1983 
1984         sl.dispose();
1985     }
1986 
1987     /**
1988      * Bullet 1: selected index must be updated
1989      * Corner case: last selected. Fails for core
1990      */
1991     @Test public void test_rt_40012_selectedAtLastOnDisjointRemoveItemsAbove() {
1992         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1993         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1994         SelectionModel sm = comboBox.getSelectionModel();
1995 
1996         int last = items.size() - 1;
1997 
1998         // selecting item &quot;5&quot;
1999         sm.select(last);
2000 
2001         // disjoint remove of 2 elements above the last selected
2002         // Removing &quot;1&quot; and &quot;3&quot;
2003         items.removeAll(items.get(1), items.get(3));
2004 
2005         // selection should move up two places such that it remains on item &quot;5&quot;,
2006         // but in index (last - 2).
2007         int expected = last - 2;
2008         assertEquals(&quot;5&quot;, sm.getSelectedItem());
2009         assertEquals(&quot;selected index after disjoint removes above&quot;, expected, sm.getSelectedIndex());
2010     }
2011 
2012     /**
2013      * Variant of 1: if selectedIndex is not updated,
2014      * the old index is no longer valid
2015      * for accessing the items.
2016      */
2017     @Test public void test_rt_40012_accessSelectedAtLastOnDisjointRemoveItemsAbove() {
2018         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2019         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2020         SelectionModel sm = comboBox.getSelectionModel();
2021 
2022         int last = items.size() - 1;
2023 
2024         // selecting item &quot;5&quot;
2025         sm.select(last);
2026 
2027         // disjoint remove of 2 elements above the last selected
2028         items.removeAll(items.get(1), items.get(3));
2029         int selected = sm.getSelectedIndex();
2030         if (selected &gt; -1) {
2031             items.get(selected);
2032         }
2033     }
2034 
2035     /**
2036      * Bullet 2: selectedIndex notification count
2037      *
2038      * Note that we don&#39;t use the corner case of having the last index selected
2039      * (which fails already on updating the index)
2040      */
2041     private int rt_40012_count = 0;
2042     @Test public void test_rt_40012_selectedIndexNotificationOnDisjointRemovesAbove() {
2043         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2044         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2045         SelectionModel sm = comboBox.getSelectionModel();
2046 
2047         int last = items.size() - 2;
2048         sm.select(last);
2049         assertEquals(last, sm.getSelectedIndex());
2050 
2051         rt_40012_count = 0;
2052         sm.selectedIndexProperty().addListener(o -&gt; rt_40012_count++);
2053 
2054         // disjoint remove of 2 elements above the last selected
2055         items.removeAll(items.get(1), items.get(3));
2056         assertEquals(&quot;sanity: selectedIndex must be shifted by -2&quot;, last - 2, sm.getSelectedIndex());
2057         assertEquals(&quot;must fire single event on removes above&quot;, 1, rt_40012_count);
2058     }
2059 
2060     /**
2061      * Bullet 3: unchanged selectedItem must not fire change
2062      */
2063     @Test
2064     public void test_rt_40012_selectedItemNotificationOnDisjointRemovesAbove() {
2065         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2066         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2067         SelectionModel sm = comboBox.getSelectionModel();
2068 
2069         int last = items.size() - 2;
2070         Object lastItem = items.get(last);
2071         sm.select(last);
2072         assertEquals(lastItem, sm.getSelectedItem());
2073 
2074         rt_40012_count = 0;
2075         sm.selectedItemProperty().addListener(o -&gt; rt_40012_count++);
2076 
2077         // disjoint remove of 2 elements above the last selected
2078         items.removeAll(items.get(1), items.get(3));
2079         assertEquals(&quot;sanity: selectedItem unchanged&quot;, lastItem, sm.getSelectedItem());
2080         assertEquals(&quot;must not fire on unchanged selected item&quot;, 0, rt_40012_count);
2081     }
2082 
2083     @Test public void test_jdk_8150946_testCommit_valid() {
2084         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2085         comboBox.setEditable(true);
2086         assertEquals(null, comboBox.getValue());
2087         comboBox.getEditor().setText(&quot;ABC&quot;);
2088         comboBox.commitValue();
2089         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2090     }
2091 
2092     @Test public void test_jdk_8150946_testCancel_toNull() {
2093         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2094         comboBox.setEditable(true);
2095         assertNull(comboBox.getValue());
2096         assertEquals(&quot;&quot;, comboBox.getEditor().getText());
2097         comboBox.getEditor().setText(&quot;ABC&quot;);
2098         assertNull(comboBox.getValue());
2099         comboBox.cancelEdit();
2100         assertNull(comboBox.getValue());
2101         assertNull(comboBox.getEditor().getText());
2102     }
2103 
2104     @Test public void test_jdk_8150946_testCancel_toNonNull() {
2105         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2106         comboBox.setEditable(true);
2107         comboBox.getEditor().setText(&quot;ABC&quot;);
2108         comboBox.commitValue();
2109         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2110         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2111         comboBox.getEditor().setText(&quot;DEF&quot;);
2112         assertEquals(&quot;DEF&quot;, comboBox.getEditor().getText());
2113         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2114         comboBox.cancelEdit();
2115         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2116         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2117     }
2118 
2119     @Test public void test_jdk_8160493() {
2120         AtomicInteger count = new AtomicInteger();
2121         comboBox.valueProperty().addListener(o -&gt; count.incrementAndGet());
2122         assertEquals(0, count.get());
2123 
2124         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
2125         sm.select(1);
2126         assertTrue(sm.isSelected(1));
2127         assertEquals(1, count.get());
2128         assertEquals(&quot;Orange&quot;, comboBox.getValue());
2129 
2130         comboBox.setValue(&quot;New Value&quot;);
2131         assertEquals(2, count.get());
2132         assertEquals(&quot;New Value&quot;, comboBox.getValue());
2133     }
2134 
2135     private int skinChangedCount = 0;
2136     @Test public void test_JDK_8185854() {
2137         final FlowPane comboPane = new FlowPane(10, 10);
2138         ComboBox combo = new ComboBox&lt;String&gt;();
2139 
2140         combo.skinProperty().addListener((o, oldSkin, newSkin) -&gt; {
2141             skinChangedCount++;
2142         });
2143 
2144         combo.setDisable(false);
2145         combo.setEditable(false);
2146 
2147         comboPane.getChildren().add(combo);
2148 
2149         TabPane tabPane = new TabPane();
2150         Tab tab = new Tab();
2151         tab.setText(&quot;ComboBox&quot;);
2152         tab.setContent(comboPane);
2153         tabPane.getTabs().add(tab);
2154 
2155         BorderPane p = new BorderPane();
2156         p.setCenter(tabPane);
2157 
2158         Scene scene = new Scene(p);
2159         scene.getStylesheets().add(ComboBoxTest.class.getResource(&quot;JDK_8185854.css&quot;).toExternalForm());
2160 
2161         Toolkit tk = Toolkit.getToolkit();
2162 
2163         Stage stage = new Stage();
2164         stage.setScene(scene);
2165         stage.setWidth(500);
2166         stage.setHeight(400);
2167 
2168         stage.show();
2169 
2170         tk.firePulse();
2171 
2172         assertEquals(&quot;ComboBox skinProperty changed more than once, which is not expected.&quot;, 1, skinChangedCount);
2173     }
2174 }
    </pre>
  </body>
</html>