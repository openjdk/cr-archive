<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.controls/src/test/java/test/javafx/scene/control/ComboBoxTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
<a name="1" id="anc1"></a><span class="line-added">  28 import com.sun.javafx.scene.control.behavior.FocusTraversalInputMap;</span>
<span class="line-added">  29 import com.sun.javafx.scene.control.behavior.ListViewBehavior;</span>
<span class="line-added">  30 import com.sun.javafx.scene.control.inputmap.InputMap;</span>
<span class="line-added">  31 import com.sun.javafx.scene.control.inputmap.InputMap.KeyMapping;</span>
<span class="line-added">  32 import com.sun.javafx.scene.control.inputmap.KeyBinding;</span>
<span class="line-added">  33 import com.sun.javafx.tk.Toolkit;</span>
<span class="line-added">  34 </span>
<span class="line-added">  35 import test.com.sun.javafx.scene.control.infrastructure.ControlSkinFactory;</span>
  36 import test.com.sun.javafx.scene.control.infrastructure.KeyModifier;
  37 import test.com.sun.javafx.scene.control.infrastructure.MouseEventFirer;
<a name="2" id="anc2"></a>
  38 import javafx.css.PseudoClass;
  39 
  40 import test.com.sun.javafx.scene.control.infrastructure.KeyEventFirer;
  41 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  42 import javafx.scene.control.skin.ComboBoxListViewSkin;
  43 
  44 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertStyleClassContains;
  45 import static org.junit.Assert.*;
  46 import static org.junit.Assert.assertEquals;
  47 
  48 import java.util.*;
  49 import java.util.concurrent.atomic.AtomicInteger;
  50 
  51 import javafx.beans.property.ObjectProperty;
  52 import javafx.beans.property.SimpleObjectProperty;
  53 import javafx.beans.property.SimpleStringProperty;
  54 import javafx.beans.property.StringProperty;
  55 import javafx.collections.FXCollections;
  56 import javafx.collections.ObservableList;
  57 import javafx.event.ActionEvent;
  58 import javafx.event.EventHandler;
  59 import javafx.scene.Node;
  60 import javafx.scene.Scene;
  61 import javafx.scene.control.Button;
  62 import javafx.scene.control.ComboBox;
  63 import javafx.scene.control.ComboBoxShim;
  64 import javafx.scene.control.IndexedCell;
  65 import javafx.scene.control.Label;
  66 import javafx.scene.control.ListCell;
  67 import javafx.scene.control.ListCellShim;
  68 import javafx.scene.control.ListView;
  69 import javafx.scene.control.SelectionModel;
  70 import javafx.scene.control.SelectionModelShim;
  71 import javafx.scene.control.SingleSelectionModel;
  72 import javafx.scene.control.Tab;
  73 import javafx.scene.control.TabPane;
  74 import javafx.scene.control.TextField;
  75 import javafx.scene.control.Tooltip;
  76 import javafx.scene.control.skin.VirtualFlow;
  77 import javafx.scene.input.KeyCode;
  78 import javafx.scene.layout.BorderPane;
  79 import javafx.scene.layout.FlowPane;
  80 import javafx.scene.layout.VBox;
  81 import javafx.scene.paint.Color;
  82 import javafx.scene.shape.Circle;
  83 import javafx.stage.Stage;
  84 import javafx.util.Callback;
  85 import javafx.util.StringConverter;
  86 
  87 import org.junit.After;
  88 import org.junit.Before;
  89 import org.junit.Ignore;
  90 import org.junit.Test;
  91 
  92 public class ComboBoxTest {
  93     private ComboBox&lt;String&gt; comboBox;
  94     private SingleSelectionModel&lt;String&gt; sm;
  95 
  96     /*********************************************************************
  97      *                                                                   *
  98      * Utility methods                                                   *
  99      *                                                                   *
 100      ********************************************************************/
 101 
 102     public ListView getListView() {
 103         return (ListView) ((ComboBoxListViewSkin)comboBox.getSkin()).getPopupContent();
 104     }
 105 
 106     public Node getDisplayNode() {
 107         return ((ComboBoxListViewSkin)comboBox.getSkin()).getDisplayNode();
 108     }
 109 
 110 
 111 
 112     /*********************************************************************
 113      *                                                                   *
 114      * Setup                                                             *
 115      *                                                                   *
 116      ********************************************************************/
 117 
 118     @Before public void setup() {
 119         Thread.currentThread().setUncaughtExceptionHandler((thread, throwable) -&gt; {
 120             if (throwable instanceof RuntimeException) {
 121                 throw (RuntimeException)throwable;
 122             } else {
 123                 Thread.currentThread().getThreadGroup().uncaughtException(thread, throwable);
 124             }
 125         });
 126 
 127         comboBox = new ComboBox&lt;String&gt;();
 128         comboBox.setSkin(new ComboBoxListViewSkin&lt;&gt;(comboBox));
 129         sm = comboBox.getSelectionModel();
 130     }
 131 
 132     @After public void cleanup() {
 133         Thread.currentThread().setUncaughtExceptionHandler(null);
 134     }
 135 
 136     /*********************************************************************
 137      *                                                                   *
 138      * Tests for the constructors                                        *
 139      *                                                                   *
 140      ********************************************************************/
 141 
 142     @Test public void noArgConstructorSetsTheStyleClass() {
 143         assertStyleClassContains(comboBox, &quot;combo-box&quot;);
 144     }
 145 
 146     @Test public void noArgConstructorSetsNonNullSelectionModel() {
 147         assertNotNull(sm);
 148     }
 149 
 150     @Test public void noArgConstructorSetsNonNullItems() {
 151         assertNotNull(comboBox.getItems());
 152     }
 153 
 154     @Test public void noArgConstructor_selectedItemIsNull() {
 155         assertNull(sm.getSelectedItem());
 156     }
 157 
 158     @Test public void noArgConstructor_selectedIndexIsNegativeOne() {
 159         assertEquals(-1, sm.getSelectedIndex());
 160     }
 161 
 162     @Test public void noArgConstructor_valueIsNull() {
 163         assertNull(comboBox.getValue());
 164     }
 165 
 166     @Test public void noArgConstructor_editableIsFalse() {
 167         assertFalse(comboBox.isEditable());
 168     }
 169 
 170     @Test public void noArgConstructor_showingIsFalse() {
 171         assertFalse(comboBox.isShowing());
 172     }
 173 
 174     @Test public void noArgConstructor_promptTextIsEmptyString() {
 175         assertNull(comboBox.getPromptText());
 176     }
 177 
 178     @Test public void noArgConstructor_placeholderIsNull() {
 179         assertNull(comboBox.getPlaceholder());
 180     }
 181 
 182     @Test public void noArgConstructor_armedIsFalse() {
 183         assertFalse(comboBox.isArmed());
 184     }
 185 
 186     @Test public void noArgConstructor_converterIsNotNull() {
 187         assertNotNull(comboBox.getConverter());
 188     }
 189 
 190     @Test public void noArgConstructor_cellFactoryIsNull() {
 191         assertNull(comboBox.getCellFactory());
 192     }
 193 
 194     @Test public void noArgConstructor_visibleRowFactoryIs10() {
 195         assertEquals(10, comboBox.getVisibleRowCount());
 196     }
 197 
 198     @Test public void singleArgConstructorSetsTheStyleClass() {
 199         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 200         assertStyleClassContains(b2, &quot;combo-box&quot;);
 201     }
 202 
 203     @Test public void singleArgConstructorSetsNonNullSelectionModel() {
 204         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 205         assertNotNull(b2.getSelectionModel());
 206     }
 207 
 208     @Test public void singleArgConstructorAllowsNullItems() {
 209         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(null);
 210         assertNull(b2.getItems());
 211     }
 212 
 213     @Test public void singleArgConstructorTakesItems() {
 214         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;Hi&quot;);
 215         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(items);
 216         assertSame(items, b2.getItems());
 217     }
 218 
 219     @Test public void singleArgConstructor_selectedItemIsNull() {
 220         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 221         assertNull(b2.getSelectionModel().getSelectedItem());
 222     }
 223 
 224     @Test public void singleArgConstructor_selectedIndexIsNegativeOne() {
 225         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 226         assertEquals(-1, b2.getSelectionModel().getSelectedIndex());
 227     }
 228 
 229     @Test public void singleArgConstructor_valueIsNull() {
 230         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 231         assertNull(b2.getValue());
 232     }
 233 
 234     @Test public void singleArgConstructor_editableIsFalse() {
 235         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 236         assertFalse(b2.isEditable());
 237     }
 238 
 239     @Test public void singleArgConstructor_showingIsFalse() {
 240         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 241         assertFalse(b2.isShowing());
 242     }
 243 
 244     @Test public void singleArgConstructor_promptTextIsEmptyString() {
 245         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 246         assertNull(b2.getPromptText());
 247     }
 248 
 249     @Test public void singleArgConstructor_placeholderIsNull() {
 250         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 251         assertNull(b2.getPlaceholder());
 252     }
 253 
 254     @Test public void singleArgConstructor_armedIsFalse() {
 255         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 256         assertEquals(false, b2.isArmed());
 257     }
 258 
 259     @Test public void singleArgConstructor_converterIsNotNull() {
 260         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 261         assertNotNull(b2.getConverter());
 262     }
 263 
 264     @Test public void singleArgConstructor_cellFactoryIsNull() {
 265         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 266         assertNull(b2.getCellFactory());
 267     }
 268 
 269     @Test public void singleArgConstructor_visibleRowFactoryIs10() {
 270         final ComboBox&lt;String&gt; b2 = new ComboBox&lt;String&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 271         assertEquals(10, b2.getVisibleRowCount());
 272     }
 273 
 274     /*********************************************************************
 275      * Tests for selection model                                         *
 276      ********************************************************************/
 277 
 278     @Test public void selectionModelCanBeNull() {
 279         comboBox.setSelectionModel(null);
 280         assertNull(comboBox.getSelectionModel());
 281     }
 282 
 283     @Test public void selectionModelCanBeBound() {
 284         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 285         ObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt; other = new SimpleObjectProperty&lt;SingleSelectionModel&lt;String&gt;&gt;(sm);
 286         comboBox.selectionModelProperty().bind(other);
 287         assertSame(sm, sm);
 288     }
 289 
 290     @Test public void selectionModelCanBeChanged() {
 291         SingleSelectionModel&lt;String&gt; sm = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 292         comboBox.setSelectionModel(sm);
 293         assertSame(sm, sm);
 294     }
 295 
 296     @Test public void canSetSelectedItemToAnItemEvenWhenThereAreNoItems() {
 297         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 298         sm.select(randomString);
 299         assertEquals(-1, sm.getSelectedIndex());
 300         assertSame(randomString, sm.getSelectedItem());
 301     }
 302 
 303     @Test public void canSetSelectedItemToAnItemNotInTheDataModel() {
 304         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 305         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 306         sm.select(randomString);
 307         assertEquals(-1, sm.getSelectedIndex());
 308         assertSame(randomString, sm.getSelectedItem());
 309     }
 310 
 311     @Test public void settingTheSelectedItemToAnItemInItemsResultsInTheCorrectSelectedIndex() {
 312         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 313         sm.select(&quot;Orange&quot;);
 314         assertEquals(1, sm.getSelectedIndex());
 315         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 316     }
 317 
 318     @Test public void settingTheSelectedItemToANonexistantItemAndThenSettingItemsWhichContainsItResultsInCorrectSelectedIndex() {
 319         sm.select(&quot;Orange&quot;);
 320         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 321         assertEquals(1, sm.getSelectedIndex());
 322         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 323     }
 324 
 325     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex0() {
 326         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 327         sm.select(0);
 328         comboBox.getItems().clear();
 329         assertEquals(-1, sm.getSelectedIndex());
 330         assertEquals(null, sm.getSelectedItem());
 331     }
 332 
 333     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex2() {
 334         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 335         sm.select(2);
 336         comboBox.getItems().clear();
 337         assertEquals(-1, sm.getSelectedIndex());
 338         assertEquals(null, sm.getSelectedItem());
 339     }
 340 
 341     @Test public void ensureSelectedItemRemainsAccurateWhenItemsAreCleared() {
 342         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 343         sm.select(2);
 344         comboBox.getItems().clear();
 345         assertNull(sm.getSelectedItem());
 346         assertEquals(-1, sm.getSelectedIndex());
 347 
 348         comboBox.getItems().addAll(&quot;Kiwifruit&quot;, &quot;Mandarin&quot;, &quot;Pineapple&quot;);
 349         sm.select(2);
 350         assertEquals(&quot;Pineapple&quot;, sm.getSelectedItem());
 351     }
 352 
 353     @Test public void ensureSelectionShiftsDownWhenOneNewItemIsAdded() {
 354         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 355         sm.select(1);
 356         assertEquals(1, sm.getSelectedIndex());
 357         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 358 
 359         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 360         assertEquals(2, sm.getSelectedIndex());
 361         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 362     }
 363 
 364     @Test public void ensureSelectionShiftsDownWhenMultipleNewItemAreAdded() {
 365         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 366         sm.select(1);
 367         assertEquals(1, sm.getSelectedIndex());
 368         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 369 
 370         comboBox.getItems().addAll(0, Arrays.asList(&quot;Kiwifruit&quot;, &quot;Pineapple&quot;, &quot;Mandarin&quot;));
 371         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 372         assertEquals(4, sm.getSelectedIndex());
 373     }
 374 
 375     @Test public void ensureSelectionShiftsUpWhenOneItemIsRemoved() {
 376         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 377         sm.select(1);
 378         assertEquals(1, sm.getSelectedIndex());
 379         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 380 
 381         comboBox.getItems().remove(&quot;Apple&quot;);
 382         assertEquals(0, sm.getSelectedIndex());
 383         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 384     }
 385 
 386     @Test public void ensureSelectionShiftsUpWheMultipleItemsAreRemoved() {
 387         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 388         sm.select(2);
 389         assertEquals(2, sm.getSelectedIndex());
 390         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 391 
 392         comboBox.getItems().removeAll(Arrays.asList(&quot;Apple&quot;, &quot;Orange&quot;));
 393         assertEquals(0, sm.getSelectedIndex());
 394         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 395     }
 396 
 397     @Test public void ensureSelectionIsCorrectWhenItemsChange() {
 398         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 1&quot;));
 399         sm.select(0);
 400         assertEquals(&quot;Item 1&quot;, sm.getSelectedItem());
 401 
 402         comboBox.setItems(FXCollections.observableArrayList(&quot;Item 2&quot;));
 403         assertEquals(-1, sm.getSelectedIndex());
 404         assertEquals(null, sm.getSelectedItem());
 405     }
 406 
 407     @Test(expected=NullPointerException.class)
 408     public void selectionModelComboBoxReferenceCanNotBeNull() {
 409         ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(null);
 410     }
 411 
 412     @Test public void ensureGetModelItemOutOfBoundsWorks_1() {
 413         ComboBox cb = new ComboBox(null);
 414         cb.getSelectionModel().select(-1);
 415         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 416     }
 417 
 418     @Test public void ensureGetModelItemOutOfBoundsWorks_2() {
 419         ComboBox cb = new ComboBox(null);
 420         cb.getSelectionModel().select(0);
 421         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
 422     }
 423 
 424     @Test public void test_rt15793() {
 425         // ComboBox selectedIndex is 0 although the items list is empty
 426         final ComboBox lv = new ComboBox();
 427         final ObservableList list = FXCollections.observableArrayList();
 428         lv.setItems(list);
 429         list.add(&quot;toto&quot;);
 430         lv.getSelectionModel().select(0);
 431         assertEquals(0, lv.getSelectionModel().getSelectedIndex());
 432         list.remove(0);
 433         assertEquals(-1, lv.getSelectionModel().getSelectedIndex());
 434     }
 435 
 436     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectIndex() {
 437         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 438         assertNull(comboBox.getValue());
 439         sm.select(0);
 440         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 441     }
 442 
 443     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectItem() {
 444         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 445         assertNull(comboBox.getValue());
 446         sm.select(&quot;Apple&quot;);
 447         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 448     }
 449 
 450     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectPrevious() {
 451         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 452         assertNull(comboBox.getValue());
 453         sm.select(2);
 454         sm.selectPrevious();
 455         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 456     }
 457 
 458     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectNext() {
 459         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 460         assertNull(comboBox.getValue());
 461         sm.select(&quot;Apple&quot;);
 462         sm.selectNext();
 463         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 464     }
 465 
 466     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectFirst() {
 467         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 468         assertNull(comboBox.getValue());
 469         sm.selectFirst();
 470         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 471     }
 472 
 473     @Test public void ensureSelectionModelUpdatesValueProperty_withSelectLast() {
 474         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 475         assertNull(comboBox.getValue());
 476         sm.selectLast();
 477         assertEquals(&quot;Banana&quot;, comboBox.getValue());
 478     }
 479 
 480     @Test public void ensureSelectionModelClearsValueProperty() {
 481         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 482         assertNull(comboBox.getValue());
 483         sm.select(0);
 484         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 485 
 486         sm.clearSelection();
 487         assertNull(comboBox.getValue());
 488     }
 489 
 490     @Test public void ensureSelectionModelClearsValuePropertyWhenNegativeOneSelected() {
 491         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 492         assertNull(comboBox.getValue());
 493         sm.select(0);
 494         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 495 
 496         sm.select(-1);
 497         assertNull(&quot;Expected null, actual value: &quot; + comboBox.getValue(), comboBox.getValue());
 498     }
 499 
 500     @Test public void ensureValueIsCorrectWhenItemsIsAddedToWithExistingSelection() {
 501         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 502         sm.select(1);
 503 
 504         comboBox.getItems().add(0, &quot;Kiwifruit&quot;);
 505 
 506         assertEquals(2, sm.getSelectedIndex());
 507         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 508         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 509     }
 510 
 511     @Test public void ensureValueIsCorrectWhenItemsAreRemovedWithExistingSelection() {
 512         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 513         sm.select(1);
 514 
 515         comboBox.getItems().remove(&quot;Apple&quot;);
 516 
 517         assertEquals(0, sm.getSelectedIndex());
 518         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 519         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 520     }
 521 
 522     @Test public void ensureValueIsUpdatedByCorrectSelectionModelWhenSelectionModelIsChanged() {
 523         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 524         SingleSelectionModel sm1 = sm;
 525         sm1.select(1);
 526         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 527 
 528         SingleSelectionModel sm2 = ComboBoxShim.&lt;String&gt;get_ComboBoxSelectionModel(comboBox);
 529         comboBox.setSelectionModel(sm2);
 530 
 531         sm1.select(2);  // value should not change as we are using old SM
 532         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 533 
 534         sm2.select(0);  // value should change, as we are using new SM
 535         assertEquals(&quot;Apple&quot;, comboBox.getValue());
 536     }
 537 
 538     @Test public void ensureValueDoesNotChangeWhenBoundAndNoExceptions() {
 539         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 540 
 541         StringProperty sp = new SimpleStringProperty(&quot;empty&quot;);
 542         comboBox.valueProperty().bind(sp);
 543 
 544         sm.select(1);
 545         assertEquals(&quot;empty&quot;, comboBox.getValue());
 546     }
 547 
 548     @Test public void ensureSelectionModelUpdatesWhenValueChanges() {
 549         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 550         assertNull(sm.getSelectedItem());
 551         comboBox.setValue(&quot;Orange&quot;);
 552         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 553     }
 554 
 555     @Test public void ensureSelectionModelUpdatesWhenValueChangesToNull() {
 556         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 557         comboBox.setValue(&quot;Kiwifruit&quot;);
 558         assertEquals(&quot;Kiwifruit&quot;, sm.getSelectedItem());
 559         assertEquals(&quot;Kiwifruit&quot;, comboBox.getValue());
 560         comboBox.setValue(null);
 561         assertEquals(null, sm.getSelectedItem());
 562         assertEquals(-1, sm.getSelectedIndex());
 563         assertEquals(null, comboBox.getValue());
 564     }
 565 
 566     @Test public void ensureValueEqualsSelectedItemWhenNotInItemsList() {
 567         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 568         SelectionModelShim.setSelectedItem(sm, &quot;pineapple&quot;);
 569         assertEquals(&quot;pineapple&quot;, sm.getSelectedItem());
 570         assertEquals(&quot;pineapple&quot;, comboBox.getValue());
 571     }
 572 
 573     /*********************************************************************
 574      * Tests for default values                                         *
 575      ********************************************************************/
 576 
 577     @Test public void checkPromptTextPropertyName() {
 578         assertTrue(comboBox.promptTextProperty().getName().equals(&quot;promptText&quot;));
 579     }
 580 
 581     @Test public void checkPlaceholderPropertyName() {
 582         assertTrue(comboBox.placeholderProperty().getName().equals(&quot;placeholder&quot;));
 583     }
 584 
 585     @Test public void checkValuePropertyName() {
 586         assertTrue(comboBox.valueProperty().getName().equals(&quot;value&quot;));
 587     }
 588 
 589     @Test public void checkItemsPropertyName() {
 590         assertTrue(comboBox.itemsProperty().getName().equals(&quot;items&quot;));
 591     }
 592 
 593     @Test public void checkConverterPropertyName() {
 594         assertTrue(comboBox.converterProperty().getName().equals(&quot;converter&quot;));
 595     }
 596 
 597     @Test public void checkSelectionModelPropertyName() {
 598         assertTrue(comboBox.selectionModelProperty().getName().equals(&quot;selectionModel&quot;));
 599     }
 600 
 601     @Test public void checkVisibleRowCountPropertyName() {
 602         assertTrue(comboBox.visibleRowCountProperty().getName().equals(&quot;visibleRowCount&quot;));
 603     }
 604 
 605     @Test public void checkOnActionPropertyName() {
 606         assertTrue(comboBox.onActionProperty().getName().equals(&quot;onAction&quot;));
 607     }
 608 
 609     @Test public void checkArmedPropertyName() {
 610         assertTrue(comboBox.armedProperty().getName().equals(&quot;armed&quot;));
 611     }
 612 
 613     @Test public void checkShowingPropertyName() {
 614         assertTrue(comboBox.showingProperty().getName().equals(&quot;showing&quot;));
 615     }
 616 
 617     @Test public void checkEditablePropertyName() {
 618         assertTrue(comboBox.editableProperty().getName().equals(&quot;editable&quot;));
 619     }
 620 
 621     @Test public void checkCellFactoryPropertyName() {
 622         assertTrue(comboBox.cellFactoryProperty().getName().equals(&quot;cellFactory&quot;));
 623     }
 624 
 625     @Test public void defaultActionHandlerIsNotDefined() {
 626         assertNull(comboBox.getOnAction());
 627     }
 628 
 629     @Test public void defaultConverterCanHandleStringValues() {
 630         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 631         assertEquals(&quot;input&quot;, sc.fromString(&quot;input&quot;));
 632         assertEquals(&quot;input&quot;, sc.toString(&quot;input&quot;));
 633     }
 634 
 635     @Test public void defaultConverterCanHandleIncorrectType_1() {
 636         ComboBox cb = new ComboBox();
 637         StringConverter sc = cb.getConverter();
 638         assertEquals(&quot;42&quot;, sc.toString(new Integer(42)));
 639     }
 640 
 641     @Test(expected=ClassCastException.class)
 642     public void defaultConverterCanHandleIncorrectType_2() {
 643         ComboBox&lt;Integer&gt; cb = new ComboBox&lt;Integer&gt;();
 644         StringConverter&lt;Integer&gt; sc = cb.getConverter();
 645         Integer value = sc.fromString(&quot;42&quot;);
 646     }
 647 
 648     @Test public void defaultConverterCanHandleNullValues() {
 649         StringConverter&lt;String&gt; sc = comboBox.getConverter();
 650         assertEquals(null, sc.fromString(null));
 651         assertEquals(null, sc.toString(null));
 652     }
 653 
 654     @Test public void ensureImpl_getPseudoClassStateReturnsValidValue() {
 655         Stage stage = new Stage();
 656         Scene scene = new Scene(comboBox);
 657         stage.setScene(scene);
 658 
 659         Set&lt;PseudoClass&gt; pseudoClassStates = comboBox.getPseudoClassStates();
 660         assertFalse(comboBox.isEditable());
 661         assertTrue(pseudoClassStates.size() &gt;= 0);
 662 
 663         comboBox.setEditable(true);
 664         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)));
 665 
 666         comboBox.setEditable(false);
 667         assertFalse(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;editable&quot;)));
 668 
 669         comboBox.show();
 670         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)));
 671 
 672         comboBox.hide();
 673         assertFalse(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;showing&quot;)));
 674 
 675         comboBox.arm();
 676         assertTrue(pseudoClassStates.contains(PseudoClass.getPseudoClass(&quot;armed&quot;)));
 677 
 678     }
 679 
 680     /*********************************************************************
 681      * Tests for properties                                              *
 682      ********************************************************************/
 683 
 684     @Test public void ensureAllowsNullConverter() {
 685         comboBox.setConverter(null);
 686         assertNull(comboBox.getConverter());
 687     }
 688 
 689     @Test public void ensureCanSetNonNullCellFactory() {
 690         Callback&lt;ListView&lt;String&gt;, ListCell&lt;String&gt;&gt; cf = p -&gt; null;
 691         comboBox.setCellFactory(cf);
 692         assertEquals(cf, comboBox.getCellFactory());
 693     }
 694 
 695     @Test public void ensureEditorIsNonNullWhenComboBoxIsNotEditable() {
 696         assertNotNull(comboBox.getEditor());
 697     }
 698 
 699     @Test public void ensureEditorIsNonNullWhenComboBoxIsEditable() {
 700         comboBox.setEditable(true);
 701         assertNotNull(comboBox.getEditor());
 702     }
 703 
 704     @Test public void ensureEditorDoesNotChangeWhenEditableToggles() {
 705         comboBox.setEditable(true);
 706         assertNotNull(comboBox.getEditor());
 707         comboBox.setEditable(false);
 708         assertNotNull(comboBox.getEditor());
 709         comboBox.setEditable(true);
 710         assertNotNull(comboBox.getEditor());
 711     }
 712 
 713     @Test public void ensureCanSetValueToNonNullStringAndBackAgain() {
 714         comboBox.setValue(&quot;Test 123&quot;);
 715         assertEquals(&quot;Test 123&quot;, comboBox.getValue());
 716         comboBox.setValue(null);
 717         assertNull(comboBox.getValue());
 718     }
 719 
 720     @Test public void ensureCanToggleEditable() {
 721         comboBox.setEditable(true);
 722         assertTrue(comboBox.isEditable());
 723         comboBox.setEditable(false);
 724         assertFalse(comboBox.isEditable());
 725     }
 726 
 727     @Test public void ensureCanToggleShowing() {
 728         Stage stage = new Stage();
 729         Scene scene = new Scene(comboBox);
 730         stage.setScene(scene);
 731 
 732         comboBox.show();
 733         assertTrue(comboBox.isShowing());
 734         comboBox.hide();
 735         assertFalse(comboBox.isShowing());
 736     }
 737 
 738     @Test public void ensureCanNotToggleShowingWhenDisabled() {
 739         Stage stage = new Stage();
 740         Scene scene = new Scene(comboBox);
 741         stage.setScene(scene);
 742 
 743         comboBox.setDisable(true);
 744         comboBox.show();
 745         assertFalse(comboBox.isShowing());
 746         comboBox.setDisable(false);
 747         comboBox.show();
 748         assertTrue(comboBox.isShowing());
 749     }
 750 
 751     @Test public void ensureCanSetPromptText() {
 752         comboBox.setPromptText(&quot;Test 1 2 3&quot;);
 753         assertEquals(&quot;Test 1 2 3&quot;, comboBox.getPromptText());
 754     }
 755 
 756     @Test public void ensureCanSetPromptTextToNull() {
 757         comboBox.setPromptText(&quot;&quot;);
 758         assertEquals(&quot;&quot;, comboBox.getPromptText());
 759         comboBox.setPromptText(null);
 760         assertEquals(null, comboBox.getPromptText());
 761     }
 762 
 763     @Test public void ensurePromptTextStripsNewlines() {
 764         comboBox.setPromptText(&quot;Test\n1\n2\n3&quot;);
 765         assertEquals(&quot;Test123&quot;, comboBox.getPromptText());
 766     }
 767 
 768     @Test public void ensureCanSetPlaceholder() {
 769         Label label = new javafx.scene.control.Label(&quot;Test 1 2 3&quot;);
 770         comboBox.setPlaceholder(label);
 771         assertEquals(label, comboBox.getPlaceholder());
 772     }
 773 
 774     @Test public void ensureCanToggleArmed() {
 775         assertFalse(comboBox.isArmed());
 776         comboBox.arm();
 777         assertTrue(comboBox.isArmed());
 778         comboBox.disarm();
 779         assertFalse(comboBox.isArmed());
 780     }
 781 
 782     @Test public void ensureCanSetVisibleRowCount() {
 783         comboBox.setVisibleRowCount(13);
 784         assertEquals(13, comboBox.getVisibleRowCount());
 785     }
 786 
 787     @Test public void ensureCanSetVisibleRowCountToNegativeValues() {
 788         comboBox.setVisibleRowCount(-10);
 789         assertEquals(-10, comboBox.getVisibleRowCount());
 790     }
 791 
 792     @Test public void ensureCanSetOnAction() {
 793         EventHandler&lt;ActionEvent&gt; onAction = t -&gt; { };
 794         comboBox.setOnAction(onAction);
 795         assertEquals(onAction, comboBox.getOnAction());
 796     }
 797 
 798     @Test public void ensureOnActionPropertyReferencesBean() {
 799         assertEquals(comboBox, comboBox.onActionProperty().getBean());
 800     }
 801 
 802     /*********************************************************************
 803      * Tests for property binding                                        *
 804      ********************************************************************/
 805     @Test public void checkPromptTextPropertyBind() {
 806         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 807         comboBox.promptTextProperty().bind(strPr);
 808         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;value&quot;));
 809         strPr.setValue(&quot;newvalue&quot;);
 810         assertTrue(&quot;PromptText cannot be bound&quot;, comboBox.getPromptText().equals(&quot;newvalue&quot;));
 811     }
 812 
 813     @Test public void checkValuePropertyBind() {
 814         StringProperty strPr = new SimpleStringProperty(&quot;value&quot;);
 815         comboBox.valueProperty().bind(strPr);
 816         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;value&quot;));
 817         strPr.setValue(&quot;newvalue&quot;);
 818         assertTrue(&quot;value cannot be bound&quot;, comboBox.getValue().equals(&quot;newvalue&quot;));
 819     }
 820 
 821 
 822 
 823     /*********************************************************************
 824      * Tests for bug reports                                             *
 825      ********************************************************************/
 826 
 827     @Test public void test_rt18972() {
 828         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 829         sm.select(1);
 830         assertTrue(sm.isSelected(1));
 831 
 832         comboBox.setEditable(true);
 833         comboBox.setValue(&quot;New Value&quot;);
 834 
 835         // there should be no selection in the selection model, as &quot;New Value&quot;
 836         // isn&#39;t an item in the list, however, it is a totally valid value for
 837         // the value property
 838         assertFalse(sm.isSelected(1));
 839         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 840         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 841 
 842         comboBox.setEditable(false);
 843         assertEquals(-1, sm.getSelectedIndex());
 844         assertEquals(&quot;New Value&quot;, sm.getSelectedItem());
 845         assertEquals(&quot;New Value&quot;, comboBox.getValue());
 846     }
 847 
 848     @Test public void test_rt18941() {
 849         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 850         comboBox.setValue(&quot;Orange&quot;);
 851         assertEquals(&quot;Orange&quot;, comboBox.getValue());
 852         assertEquals(&quot;Orange&quot;, comboBox.getSelectionModel().getSelectedItem());
 853         assertTrue(&quot;Selected Index: &quot; + sm.getSelectedIndex(), sm.isSelected(1));
 854     }
 855 
 856     @Test public void test_rt19227() {
 857         comboBox.getItems().addAll(&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;);
 858         comboBox.getSelectionModel().select(2);
 859         assertEquals(&quot;0&quot;, comboBox.getValue());
 860         assertEquals(&quot;0&quot;, comboBox.getSelectionModel().getSelectedItem());
 861         assertTrue(sm.isSelected(2));
 862     }
 863 
 864     @Ignore(&quot;JDK-8091127 Test not working as the heights being returned are not accurate&quot;)
 865     @Test public void test_rt20106() {
 866         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 867 
 868         Stage stage = new Stage();
 869         Scene scene = new Scene(comboBox);
 870         stage.setScene(scene);
 871         comboBox.applyCss();
 872         comboBox.show();
 873 
 874         comboBox.setVisibleRowCount(5);
 875         double initialHeight = getListView().getHeight();
 876         assertFalse(&quot;initialHeight: &quot; + initialHeight, Double.compare(0.0, initialHeight) == 0);
 877 
 878         comboBox.setVisibleRowCount(0);
 879         double smallHeight =    getListView().getHeight();
 880         assertTrue(&quot;smallHeight: &quot; + smallHeight + &quot;, initialHeight: &quot; + initialHeight,
 881                 smallHeight != initialHeight &amp;&amp; smallHeight &lt; initialHeight);
 882 
 883         comboBox.setVisibleRowCount(7);
 884         double biggerHeight = getListView().getHeight();
 885         assertTrue(biggerHeight != smallHeight &amp;&amp; smallHeight &lt; biggerHeight);
 886     }
 887 
 888     private int count = 0;
 889     @Test public void test_rt20103() {
 890         final TextField tf = new TextField();
 891 
 892         comboBox.setOnAction(t -&gt; {
 893             count++;
 894         });
 895 
 896         assertTrue(count == 0);
 897 
 898         comboBox.valueProperty().bind(tf.textProperty());   // count++ here
 899         assertTrue(&quot;count: &quot; + count, count == 1);
 900 
 901         tf.setText(&quot;Text1&quot;);                                // count++ here
 902         assertTrue(&quot;count: &quot; + count, count == 2);
 903 
 904         comboBox.valueProperty().unbind();                  // no count++ here
 905         assertTrue(&quot;count: &quot; + count, count == 2);
 906 
 907         comboBox.valueProperty().bindBidirectional(tf.textProperty());  // count++ here
 908         tf.setText(&quot;Text2&quot;);
 909         assertTrue(&quot;count: &quot; + count, count == 3);
 910     }
 911 
 912     @Ignore(&quot;Test not working as the skin is not being properly instantiated&quot;)
 913     @Test public void test_rt20100() {
 914         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 915 
 916         Stage stage = new Stage();
 917         Scene scene = new Scene(comboBox);
 918         stage.setScene(scene);
 919         comboBox.applyCss();
 920         comboBox.show();
 921 
 922         comboBox.setConverter(new StringConverter() {
 923             int toStringCounter = 0;
 924             int fromStringCounter = 0;
 925 
 926             @Override public String toString(Object t) {
 927                 return &quot;TO_STRING&quot;;
 928             }
 929 
 930             @Override public Object fromString(String string) {
 931                 return &quot;FROM_STRING&quot;;
 932             }
 933         });
 934 
 935         comboBox.getSelectionModel().select(2);
 936         assertEquals(&quot;2&quot;, comboBox.getValue());
 937 
 938         ListView listView = getListView();
 939 //        listView.applyCss();
 940 
 941         assertEquals(&quot;2&quot;, listView.getSelectionModel().getSelectedItem());
 942 
 943         System.out.println(listView.getSkin());
 944 
 945         VirtualFlow flow = (VirtualFlow)listView.lookup(&quot;#virtual-flow&quot;);
 946         assertNotNull(flow);
 947 
 948         IndexedCell cell = flow.getVisibleCell(2);
 949         System.out.println(&quot;cell: &quot; + cell);
 950         assertEquals(&quot;TO_STRING&quot;, cell.getText());
 951     }
 952 
 953     @Test public void test_rt20189() {
 954         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 955 
 956         Stage stage = new Stage();
 957         Scene scene = new Scene(comboBox);
 958         stage.setScene(scene);
 959         comboBox.applyCss();
 960         comboBox.show();
 961 
 962         comboBox.getSelectionModel().select(2);
 963         Object item = sm.getSelectedItem();
 964         assertEquals(&quot;2&quot;, item);
 965         assertEquals(2, sm.getSelectedIndex());
 966 
 967         comboBox.setValue(&quot;test&quot;);
 968         item = sm.getSelectedItem();
 969         assertEquals(&quot;test&quot;,item);
 970         assertEquals(-1, sm.getSelectedIndex());
 971 
 972         comboBox.getSelectionModel().select(2);
 973         item = sm.getSelectedItem();
 974         assertEquals(&quot;2&quot;, item);
 975         assertEquals(2, sm.getSelectedIndex());
 976     }
 977 
 978     @Test public void test_rt27654() {
 979         comboBox.getItems().addAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
 980 
 981         SingleSelectionModel sm = comboBox.getSelectionModel();
 982 
 983         Stage stage = new Stage();
 984         Scene scene = new Scene(comboBox);
 985         stage.setScene(scene);
 986         comboBox.applyCss();
 987         comboBox.show();
 988         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
 989 
 990         sm.select(2);
 991         assertEquals(&quot;2&quot;, sm.getSelectedItem());
 992         assertEquals(&quot;2&quot;, comboBox.getValue());
 993         assertEquals(&quot;2&quot;, buttonCell.getText());
 994         assertEquals(2, sm.getSelectedIndex());
 995 
 996         sm.clearSelection();
 997         assertNull(sm.getSelectedItem());
 998         assertNull(comboBox.getValue());
 999         assertNull(buttonCell.getText());
1000         assertEquals(-1, sm.getSelectedIndex());
1001 
1002         sm.select(2);
1003         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1004         assertEquals(&quot;2&quot;, comboBox.getValue());
1005         assertEquals(&quot;2&quot;, buttonCell.getText());
1006         assertEquals(2, sm.getSelectedIndex());
1007     }
1008 
1009     @Test public void test_rt24412() {
1010         SingleSelectionModel sm = comboBox.getSelectionModel();
1011 
1012         Stage stage = new Stage();
1013         Scene scene = new Scene(comboBox);
1014         stage.setScene(scene);
1015         comboBox.applyCss();
1016         comboBox.show();
1017         ListCell&lt;String&gt; buttonCell = (ListCell&lt;String&gt;) getDisplayNode();
1018 
1019         comboBox.getItems().setAll(&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;);
1020 
1021         sm.select(&quot;2&quot;);
1022         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1023         assertEquals(&quot;2&quot;, comboBox.getValue());
1024         assertEquals(&quot;2&quot;, buttonCell.getText());
1025         assertEquals(2, sm.getSelectedIndex());
1026 
1027         sm.clearSelection();
1028         assertNull(sm.getSelectedItem());
1029         assertNull(comboBox.getValue());
1030         assertNull(buttonCell.getText());
1031         assertEquals(-1, sm.getSelectedIndex());
1032 
1033         sm.select(&quot;2&quot;);
1034         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1035         assertEquals(&quot;2&quot;, comboBox.getValue());
1036         assertEquals(&quot;2&quot;, buttonCell.getText());
1037         assertEquals(2, sm.getSelectedIndex());
1038     }
1039 
1040     @Test public void test_rt28245() {
1041         final ObservableList&lt;String&gt; strings = FXCollections.observableArrayList(
1042             &quot;Option 1&quot;, &quot;Option 2&quot;, &quot;Option 3&quot;
1043         );
1044 
1045         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1046         comboBox.setItems(strings);
1047         comboBox.setEditable(true);
1048         comboBox.valueProperty().addListener((ov, t, t1) -&gt; {
1049             if (t == null &amp;&amp; t1.isEmpty()) {
1050                 fail(&quot;Old value is &#39;&quot; + t + &quot;&#39; and new value is &#39;&quot; + t1 + &quot;&#39;.&quot;);
1051             }
1052         });
1053 
1054         StageLoader sl = new StageLoader(comboBox);
1055 
1056         assertNull(comboBox.getValue());
1057         assertTrue(comboBox.getEditor().getText().isEmpty());
1058 
1059         comboBox.requestFocus();
1060 
1061         new KeyEventFirer(comboBox).doKeyPress(KeyCode.ENTER);
1062 
1063         sl.dispose();
1064     }
1065 
1066     @Test public void test_rt31479() {
1067         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;String&gt;();
1068 
1069         StageLoader sl = new StageLoader(comboBox);
1070 
1071         final double widthBefore = comboBox.getWidth();
1072 
1073         // add item
1074         comboBox.getItems().add(&quot;Option 1&quot;);
1075 
1076         // open and close combobox
1077         comboBox.show();
1078         comboBox.hide();
1079 
1080         // set a placeholder
1081         comboBox.setPlaceholder(new Circle(12, Color.RED));
1082 
1083         // remove item
1084         comboBox.getItems().clear();
1085 
1086         // fire pulse (this allows layout to cause the size to grow)
1087         Toolkit.getToolkit().firePulse();
1088 
1089         // test size
1090         assertEquals(widthBefore, comboBox.getWidth(), 0.00);
1091 
1092         sl.dispose();
1093     }
1094 
1095     @Test public void test_rt32139() {
1096         final ObservableList&lt;String&gt; items =
1097                 FXCollections.observableArrayList(&quot;Good value&quot;, &quot;Bad value&quot;);
1098 
1099         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
1100         comboBox.getSelectionModel().select(0);
1101 
1102         comboBox.getSelectionModel().selectedIndexProperty().addListener((ov, oldIdx, newIdx) -&gt; {
1103             if (newIdx.intValue() != 0) {
1104                 comboBox.getSelectionModel().select(0);
1105             }
1106         });
1107 
1108         StageLoader sl = new StageLoader(comboBox);
1109 
1110         try {
1111             comboBox.getSelectionModel().select(1);
1112         } catch (StackOverflowError e) {
1113             fail(&quot;Stack overflow should not happen here&quot;);
1114         }
1115 
1116         sl.dispose();
1117     }
1118 
1119     @Test public void test_rt21186() {
1120         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1121         comboBox.setEditable(true);
1122 
1123         StageLoader sl = new StageLoader(comboBox);
1124 
1125         assertNull(comboBox.getTooltip());
1126         assertNull(comboBox.getEditor().getTooltip());
1127 
1128         Tooltip tooltip = new Tooltip(&quot;Tooltip&quot;);
1129         comboBox.setTooltip(tooltip);
1130         assertEquals(tooltip, comboBox.getTooltip());
1131         assertEquals(tooltip, comboBox.getEditor().getTooltip());
1132 
1133         comboBox.setTooltip(null);
1134         assertNull(comboBox.getTooltip());
1135         assertNull(comboBox.getEditor().getTooltip());
1136 
1137         sl.dispose();
1138     }
1139 
1140     @Test public void test_rt34573() {
1141         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1142 
1143         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1144             @Override public void updateItem(String item, boolean empty) {
1145                 super.updateItem(item, empty);
1146                 setText(item);
1147             }
1148         };
1149         comboBox.setButtonCell(customCell);
1150 
1151         StageLoader sl = new StageLoader(comboBox);
1152 
1153         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1154         comboBox.setValue(&quot;B&quot;);
1155         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1156         assertEquals(1, comboBox.getButtonCell().getIndex());
1157 
1158         comboBox.setItems(FXCollections.observableArrayList(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;));
1159         assertNull(comboBox.getButtonCell().getText());
1160         assertEquals(-1, comboBox.getButtonCell().getIndex());
1161 
1162         sl.dispose();
1163     }
1164 
1165     @Test public void test_rt34566() {
1166         final ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
1167 
1168         final ListCell&lt;String&gt; customCell = new ListCellShim&lt;String&gt;() {
1169             @Override public void updateItem(String item, boolean empty) {
1170                 super.updateItem(item, empty);
1171                 setText(item);
1172             }
1173         };
1174         comboBox.setButtonCell(customCell);
1175 
1176         StageLoader sl = new StageLoader(comboBox);
1177 
1178         comboBox.setItems(FXCollections.observableArrayList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;));
1179 
1180         PseudoClass empty = PseudoClass.getPseudoClass(&quot;empty&quot;);
1181 
1182         comboBox.setValue(&quot;B&quot;);
1183         assertEquals(&quot;B&quot;, comboBox.getButtonCell().getText());
1184         assertEquals(1, comboBox.getButtonCell().getIndex());
1185         assertFalse(customCell.getPseudoClassStates().contains(empty));
1186 
1187         comboBox.setValue(null);
1188         Toolkit.getToolkit().firePulse();
1189         assertNull(comboBox.getButtonCell().getText());
1190         assertEquals(-1, comboBox.getButtonCell().getIndex());
1191         assertTrue(customCell.getPseudoClassStates().contains(empty));
1192 
1193         comboBox.setValue(&quot;A&quot;);
1194         assertEquals(&quot;A&quot;, comboBox.getButtonCell().getText());
1195         assertEquals(0, comboBox.getButtonCell().getIndex());
1196         assertFalse(customCell.getPseudoClassStates().contains(empty));
1197 
1198         sl.dispose();
1199     }
1200 
1201     private int test_rt34603_count = 0;
1202     @Test public void test_rt34603() {
1203         assertEquals(0, test_rt34603_count);
1204 
1205         VBox hbox = new VBox(10);
1206 
1207         ComboBox&lt;String&gt; box = new ComboBox&lt;&gt;();
1208         box.getItems().add(&quot;test&quot;);
1209         box.setEditable(true);
1210         box.getSelectionModel().selectFirst();
1211 
1212         Button defaultButton = new Button(&quot;press&quot;);
1213         defaultButton.setOnAction(arg0 -&gt; {
1214             test_rt34603_count++;
1215         });
1216         defaultButton.setDefaultButton(true);
1217 
1218         hbox.getChildren().addAll(box, defaultButton);
1219 
1220         StageLoader sl = new StageLoader(hbox);
1221 
1222         box.getEditor().requestFocus();
1223         KeyEventFirer keyboard = new KeyEventFirer(box);
1224         keyboard.doKeyPress(KeyCode.ENTER);
1225 
1226         assertEquals(1, test_rt34603_count);
1227 
1228         sl.dispose();
1229     }
1230 
1231     private int test_rt35586_count = 0;
1232     @Test public void test_rt35586() {
1233         assertEquals(0, test_rt35586_count);
1234 
1235         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1236         cb.setEditable(true);
1237         cb.setOnAction(event -&gt; {
1238             test_rt35586_count++;
1239             assertEquals(&quot;Test&quot;, cb.getEditor().getText());
1240         });
1241 
1242         StageLoader sl = new StageLoader(cb);
1243 
1244         cb.requestFocus();
1245         cb.getEditor().setText(&quot;Test&quot;);
1246         KeyEventFirer keyboard = new KeyEventFirer(cb);
1247         keyboard.doKeyPress(KeyCode.ENTER);
1248 
1249         assertEquals(1, test_rt35586_count);
1250 
1251         sl.dispose();
1252     }
1253 
1254     @Test public void test_rt35039() {
1255         final List&lt;String&gt; data = new ArrayList&lt;&gt;();
1256         data.add(&quot;aabbaa&quot;);
1257         data.add(&quot;bbc&quot;);
1258 
1259         final ComboBox&lt;String&gt; combo = new ComboBox&lt;&gt;();
1260         combo.setEditable(true);
1261         combo.setItems(FXCollections.observableArrayList(data));
1262 
1263         StageLoader sl = new StageLoader(combo);
1264 
1265         // everything should be null to start with
1266         assertNull(combo.getValue());
1267         assertTrue(combo.getEditor().getText().isEmpty());
1268         assertNull(combo.getSelectionModel().getSelectedItem());
1269 
1270         // select &quot;bbc&quot; and ensure everything is set to that
1271         combo.getSelectionModel().select(1);
1272         assertEquals(&quot;bbc&quot;, combo.getValue());
1273         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1274         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1275 
1276         // change the items list - but retain the same content. We expect
1277         // that &quot;bbc&quot; remains selected as it is still in the list
1278         combo.setItems(FXCollections.observableArrayList(data));
1279         assertEquals(&quot;bbc&quot;, combo.getValue());
1280         assertEquals(&quot;bbc&quot;, combo.getEditor().getText());
1281         assertEquals(&quot;bbc&quot;, combo.getSelectionModel().getSelectedItem());
1282 
1283         sl.dispose();
1284     }
1285 
1286     @Test public void test_rt35840() {
1287         final ComboBox&lt;String&gt; cb = new ComboBox&lt;String&gt;();
1288         cb.setEditable(true);
1289         StageLoader sl = new StageLoader(cb);
1290         cb.requestFocus();
1291 
1292         KeyEventFirer keyboard = new KeyEventFirer(cb);
1293         keyboard.doKeyTyped(KeyCode.T);
1294         keyboard.doKeyTyped(KeyCode.E);
1295         keyboard.doKeyTyped(KeyCode.S);
1296         keyboard.doKeyTyped(KeyCode.T);
1297         assertEquals(&quot;TEST&quot;, cb.getEditor().getText());
1298 
1299         assertNull(cb.getValue());
1300         keyboard.doKeyPress(KeyCode.ENTER);
1301         assertEquals(&quot;TEST&quot;, cb.getValue());
1302 
1303         sl.dispose();
1304     }
1305 
1306     @Test public void test_rt36280_nonEditable_F4ShowsPopup() {
1307         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1308         StageLoader sl = new StageLoader(cb);
1309         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1310 
1311         assertFalse(cb.isShowing());
1312         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1313         assertTrue(cb.isShowing());
1314 
1315         sl.dispose();
1316     }
1317 
1318     @Test public void test_rt36280_nonEditable_altUpShowsPopup() {
1319         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1320         StageLoader sl = new StageLoader(cb);
1321         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1322 
1323         assertFalse(cb.isShowing());
1324         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1325         assertTrue(cb.isShowing());
1326 
1327         sl.dispose();
1328     }
1329 
1330     @Test public void test_rt36280_nonEditable_altDownShowsPopup() {
1331         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1332         StageLoader sl = new StageLoader(cb);
1333         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1334 
1335         new StageLoader(cb);
1336 
1337         assertFalse(cb.isShowing());
1338         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1339         assertTrue(cb.isShowing());
1340 
1341         sl.dispose();
1342     }
1343 
<a name="3" id="anc3"></a><span class="line-added">1344     @Test public void testEditorKeyInputsWhenPopupIsShowing() {</span>
<span class="line-added">1345         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));</span>
<span class="line-added">1346         cb.setEditable(true);</span>
<span class="line-added">1347         StageLoader sl = new StageLoader(cb);</span>
<span class="line-added">1348         KeyEventFirer keyboard = new KeyEventFirer(cb);</span>
<span class="line-added">1349 </span>
<span class="line-added">1350         // Show the popup</span>
<span class="line-added">1351         assertFalse(cb.isShowing());</span>
<span class="line-added">1352         cb.requestFocus();</span>
<span class="line-added">1353         cb.getEditor().setText(&quot;ABC DEF&quot;);</span>
<span class="line-added">1354         assertEquals(&quot;ABC DEF&quot;, cb.getEditor().getText());</span>
<span class="line-added">1355         keyboard.doDownArrowPress(KeyModifier.ALT);</span>
<span class="line-added">1356         // Sanity</span>
<span class="line-added">1357         assertTrue(cb.isShowing());</span>
<span class="line-added">1358         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1359 </span>
<span class="line-added">1360         // LEFT, RIGHT keys with CTRL, SHIFT modifiers</span>
<span class="line-added">1361         // Test RIGHT key</span>
<span class="line-added">1362         keyboard.doRightArrowPress();</span>
<span class="line-added">1363         assertEquals(1, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1364 </span>
<span class="line-added">1365         // Test KP_RIGHT key</span>
<span class="line-added">1366         keyboard.doKeyPress(KeyCode.KP_RIGHT);</span>
<span class="line-added">1367         assertEquals(2, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1368 </span>
<span class="line-added">1369         // Test LEFT key</span>
<span class="line-added">1370         keyboard.doLeftArrowPress();</span>
<span class="line-added">1371         assertEquals(1, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1372 </span>
<span class="line-added">1373         // Test KP_LEFT key</span>
<span class="line-added">1374         keyboard.doKeyPress(KeyCode.KP_LEFT);</span>
<span class="line-added">1375         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1376 </span>
<span class="line-added">1377         // Test SHIFT + RIGHT key</span>
<span class="line-added">1378         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);</span>
<span class="line-added">1379         assertEquals(&quot;A&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1380         assertEquals(1, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1381 </span>
<span class="line-added">1382         // Test SHIFT + LEFT key</span>
<span class="line-added">1383         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT);</span>
<span class="line-added">1384         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1385         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1386 </span>
<span class="line-added">1387         // Test CTRL + RIGHT key</span>
<span class="line-added">1388         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.CTRL);</span>
<span class="line-added">1389         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1390         assertEquals(4, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1391 </span>
<span class="line-added">1392         // Test CTRL + LEFT key</span>
<span class="line-added">1393         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.CTRL);</span>
<span class="line-added">1394         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1395         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1396 </span>
<span class="line-added">1397         // Test CTRL + SHIFT + RIGHT key</span>
<span class="line-added">1398         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.CTRL, KeyModifier.SHIFT);</span>
<span class="line-added">1399         assertEquals(&quot;ABC &quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1400         assertEquals(4, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1401 </span>
<span class="line-added">1402         // Test CTRL + SHIFT + LEFT key</span>
<span class="line-added">1403         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.CTRL, KeyModifier.SHIFT);</span>
<span class="line-added">1404         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1405         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1406 </span>
<span class="line-added">1407         // HOME, END keys with CTRL, SHIFT modifiers</span>
<span class="line-added">1408         // Test END key</span>
<span class="line-added">1409         keyboard.doKeyPress(KeyCode.END);</span>
<span class="line-added">1410         assertEquals(7, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1411 </span>
<span class="line-added">1412         // Test HOME key</span>
<span class="line-added">1413         keyboard.doKeyPress(KeyCode.HOME);</span>
<span class="line-added">1414         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1415 </span>
<span class="line-added">1416         // Test SHIFT + END key</span>
<span class="line-added">1417         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);</span>
<span class="line-added">1418         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());</span>
<span class="line-added">1419         assertEquals(7, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1420 </span>
<span class="line-added">1421         // Test SHIFT + HOME key</span>
<span class="line-added">1422         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);</span>
<span class="line-added">1423         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1424         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1425 </span>
<span class="line-added">1426         // Test CTRL + END key</span>
<span class="line-added">1427         keyboard.doKeyPress(KeyCode.END, KeyModifier.CTRL);</span>
<span class="line-added">1428         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1429         assertEquals(7, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1430 </span>
<span class="line-added">1431         // Test CTRL + HOME key</span>
<span class="line-added">1432         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.CTRL);</span>
<span class="line-added">1433         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1434         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1435 </span>
<span class="line-added">1436         // Test CTRL + SHIFT + END key</span>
<span class="line-added">1437         keyboard.doKeyPress(KeyCode.END, KeyModifier.CTRL, KeyModifier.SHIFT);</span>
<span class="line-added">1438         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());</span>
<span class="line-added">1439         assertEquals(7, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1440 </span>
<span class="line-added">1441         // Test CTRL + SHIFT + HOME key</span>
<span class="line-added">1442         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.CTRL, KeyModifier.SHIFT);</span>
<span class="line-added">1443         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1444         assertEquals(0, cb.getEditor().getCaretPosition());</span>
<span class="line-added">1445 </span>
<span class="line-added">1446         // Test CTRL + A key</span>
<span class="line-added">1447         keyboard.doLeftArrowPress();</span>
<span class="line-added">1448         assertEquals(&quot;&quot;, cb.getEditor().getSelectedText());</span>
<span class="line-added">1449         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());</span>
<span class="line-added">1450         assertEquals(cb.getEditor().getText(), cb.getEditor().getSelectedText());</span>
<span class="line-added">1451 </span>
<span class="line-added">1452         // Sanity</span>
<span class="line-added">1453         assertTrue(cb.isShowing());</span>
<span class="line-added">1454 </span>
<span class="line-added">1455         sl.dispose();</span>
<span class="line-added">1456     }</span>
<span class="line-added">1457 </span>
<span class="line-added">1458     @Test public void testExcludeKeyMappingsForComboBoxEditor() {</span>
<span class="line-added">1459         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));</span>
<span class="line-added">1460         StageLoader sl = new StageLoader(cb);</span>
<span class="line-added">1461 </span>
<span class="line-added">1462         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();</span>
<span class="line-added">1463         ListViewBehavior lvBehavior = (ListViewBehavior)ControlSkinFactory.getBehavior(listView.getSkin());</span>
<span class="line-added">1464         InputMap&lt;ListView&lt;?&gt;&gt; lvInputMap = lvBehavior.getInputMap();</span>
<span class="line-added">1465         ObservableList&lt;?&gt; inputMappings = lvInputMap.getMappings();</span>
<span class="line-added">1466         // In ListViewBehavior KeyMappings for vertical orientation are added under 3rd child InputMap</span>
<span class="line-added">1467         InputMap&lt;ListView&lt;?&gt;&gt; verticalInputMap = lvInputMap.getChildInputMaps().get(2);</span>
<span class="line-added">1468         ObservableList&lt;?&gt; verticalInputMappings = verticalInputMap.getMappings();</span>
<span class="line-added">1469 </span>
<span class="line-added">1470         cb.setEditable(true);</span>
<span class="line-added">1471         testKeyMappingsForEditableCB(inputMappings);</span>
<span class="line-added">1472         testCommonKeyMappings(inputMappings, verticalInputMappings);</span>
<span class="line-added">1473 </span>
<span class="line-added">1474         cb.setEditable(false);</span>
<span class="line-added">1475         testKeyMappingsForNonEditableCB(inputMappings);</span>
<span class="line-added">1476         testCommonKeyMappings(inputMappings, verticalInputMappings);</span>
<span class="line-added">1477 </span>
<span class="line-added">1478         sl.dispose();</span>
<span class="line-added">1479     }</span>
<span class="line-added">1480 </span>
<span class="line-added">1481     private void testKeyMappingsForEditableCB(ObservableList&lt;?&gt; inputMappings) {</span>
<span class="line-added">1482         assertFalse(inputMappings.contains(</span>
<span class="line-added">1483                 new KeyMapping(new KeyBinding(KeyCode.HOME), null)));</span>
<span class="line-added">1484         assertFalse(inputMappings.contains(</span>
<span class="line-added">1485                 new KeyMapping(new KeyBinding(KeyCode.END), null)));</span>
<span class="line-added">1486     }</span>
<span class="line-added">1487 </span>
<span class="line-added">1488     private void testKeyMappingsForNonEditableCB(ObservableList&lt;?&gt; inputMappings) {</span>
<span class="line-added">1489         assertTrue(inputMappings.contains(</span>
<span class="line-added">1490                 new KeyMapping(new KeyBinding(KeyCode.HOME), null)));</span>
<span class="line-added">1491         assertTrue(inputMappings.contains(</span>
<span class="line-added">1492                 new KeyMapping(new KeyBinding(KeyCode.END), null)));</span>
<span class="line-added">1493     }</span>
<span class="line-added">1494 </span>
<span class="line-added">1495     private void testCommonKeyMappings(ObservableList&lt;?&gt; inputMappings,</span>
<span class="line-added">1496                                        ObservableList&lt;?&gt; verticalInputMappings) {</span>
<span class="line-added">1497         // Verify FocusTraversalInputMap</span>
<span class="line-added">1498         for(InputMap.Mapping&lt;?&gt; mapping : FocusTraversalInputMap.getFocusTraversalMappings()) {</span>
<span class="line-added">1499             assertFalse(inputMappings.contains(mapping));</span>
<span class="line-added">1500         }</span>
<span class="line-added">1501 </span>
<span class="line-added">1502         // Verify default InputMap</span>
<span class="line-added">1503         assertFalse(inputMappings.contains(</span>
<span class="line-added">1504                 new KeyMapping(new KeyBinding(KeyCode.HOME).shift(), null)));</span>
<span class="line-added">1505         assertFalse(inputMappings.contains(</span>
<span class="line-added">1506                 new KeyMapping(new KeyBinding(KeyCode.END).shift(), null)));</span>
<span class="line-added">1507         assertFalse(inputMappings.contains(</span>
<span class="line-added">1508                 new KeyMapping(new KeyBinding(KeyCode.HOME).shortcut(), null)));</span>
<span class="line-added">1509         assertFalse(inputMappings.contains(</span>
<span class="line-added">1510                 new KeyMapping(new KeyBinding(KeyCode.END).shortcut(), null)));</span>
<span class="line-added">1511         assertFalse(inputMappings.contains(</span>
<span class="line-added">1512                 new KeyMapping(new KeyBinding(KeyCode.A).shortcut(), null)));</span>
<span class="line-added">1513 </span>
<span class="line-added">1514         // Verify vertical child InputMap</span>
<span class="line-added">1515         assertFalse(verticalInputMappings.contains(</span>
<span class="line-added">1516                 new KeyMapping(new KeyBinding(KeyCode.HOME).shortcut().shift(), null)));</span>
<span class="line-added">1517         assertFalse(verticalInputMappings.contains(</span>
<span class="line-added">1518                 new KeyMapping(new KeyBinding(KeyCode.END).shortcut().shift(), null)));</span>
<span class="line-added">1519     }</span>
<span class="line-added">1520 </span>
1521     @Test public void test_rt36280_nonEditable_enterHidesShowingPopup() {
1522         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1523         StageLoader sl = new StageLoader(cb);
1524         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1525 
1526         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1527         assertNotNull(listView);
1528 
1529         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1530 
1531         assertFalse(cb.isShowing());
1532         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1533         assertTrue(cb.isShowing());
1534         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1535         assertFalse(cb.isShowing());
1536 
1537         sl.dispose();
1538     }
1539 
1540     @Test public void test_rt36280_nonEditable_spaceHidesShowingPopup() {
1541         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1542         StageLoader sl = new StageLoader(cb);
1543         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1544 
1545         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1546         assertNotNull(listView);
1547 
1548         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1549 
1550         assertFalse(cb.isShowing());
1551         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1552         assertTrue(cb.isShowing());
1553         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1554         assertFalse(cb.isShowing());
1555 
1556         sl.dispose();
1557     }
1558 
1559     @Test public void test_rt36280_nonEditable_escapeHidesShowingPopup() {
1560         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1561         StageLoader sl = new StageLoader(cb);
1562         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1563 
1564         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1565         assertNotNull(listView);
1566 
1567         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1568 
1569         assertFalse(cb.isShowing());
1570         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1571         assertTrue(cb.isShowing());
1572         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1573         assertFalse(cb.isShowing());
1574 
1575         sl.dispose();
1576     }
1577 
1578     @Test public void test_rt36280_nonEditable_F4HidesShowingPopup() {
1579         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1580         StageLoader sl = new StageLoader(cb);
1581         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1582 
1583         assertFalse(cb.isShowing());
1584         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1585         assertTrue(cb.isShowing());
1586         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1587         assertFalse(cb.isShowing());
1588 
1589         sl.dispose();
1590     }
1591 
1592     @Test public void test_rt36280_nonEditable_arrowKeysChangeSelection() {
1593         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1594         StageLoader sl = new StageLoader(cb);
1595         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1596 
1597         assertFalse(cb.isShowing());
1598         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1599         assertTrue(cb.isShowing());
1600 
1601         assertNull(cb.getSelectionModel().getSelectedItem());
1602 
1603         cbKeyboard.doDownArrowPress();
1604         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1605 
1606         cbKeyboard.doDownArrowPress();
1607         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1608 
1609         cbKeyboard.doUpArrowPress();
1610         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1611 
1612         sl.dispose();
1613     }
1614 
1615     @Test public void test_rt36280_editable_F4ShowsPopup() {
1616         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1617         cb.setEditable(true);
1618         StageLoader sl = new StageLoader(cb);
1619         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1620 
1621         assertFalse(cb.isShowing());
1622         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1623         assertTrue(cb.isShowing());
1624 
1625         sl.dispose();
1626     }
1627 
1628     @Test public void test_rt36280_editable_altUpShowsPopup() {
1629         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1630         cb.setEditable(true);
1631         StageLoader sl = new StageLoader(cb);
1632         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1633 
1634         assertFalse(cb.isShowing());
1635         cbKeyboard.doKeyPress(KeyCode.UP, KeyModifier.ALT);  // show the popup
1636         assertTrue(cb.isShowing());
1637 
1638         sl.dispose();
1639     }
1640 
1641     @Test public void test_rt36280_editable_altDownShowsPopup_onComboBox() {
1642         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1643         cb.setEditable(true);
1644         StageLoader sl = new StageLoader(cb);
1645         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1646 
1647         assertFalse(cb.isShowing());
1648         assertTrue(cb.getEditor().getText().isEmpty());
1649         cbKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1650         assertTrue(cb.isShowing());
1651         assertTrue(cb.getEditor().getText().isEmpty());
1652 
1653         sl.dispose();
1654     }
1655 
1656     @Test public void test_rt36280_editable_altDownShowsPopup_onTextField() {
1657         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1658         cb.setEditable(true);
1659         StageLoader sl = new StageLoader(cb);
1660 
1661         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1662         assertFalse(cb.isShowing());
1663         assertTrue(cb.getEditor().getText().isEmpty());
1664         tfKeyboard.doKeyPress(KeyCode.DOWN, KeyModifier.ALT);  // show the popup
1665         assertTrue(cb.isShowing());
1666         assertTrue(cb.getEditor().getText().isEmpty());
1667 
1668         sl.dispose();
1669     }
1670 
1671     @Test public void test_rt36280_editable_enterHidesShowingPopup() {
1672         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1673         cb.setEditable(true);
1674         StageLoader sl = new StageLoader(cb);
1675         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1676 
1677         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1678         assertNotNull(listView);
1679 
1680         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1681 
1682         assertFalse(cb.isShowing());
1683         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1684         assertTrue(cb.isShowing());
1685         lvKeyboard.doKeyPress(KeyCode.ENTER);  // hide the popup
1686         assertFalse(cb.isShowing());
1687 
1688         sl.dispose();
1689     }
1690 
1691     @Test public void test_rt36280_editable_spaceHidesShowingPopup() {
1692         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1693         cb.setEditable(true);
1694         StageLoader sl = new StageLoader(cb);
1695         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1696 
1697         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1698         assertNotNull(listView);
1699 
1700         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1701 
1702         assertFalse(cb.isShowing());
1703         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1704         assertTrue(cb.isShowing());
1705         lvKeyboard.doKeyPress(KeyCode.SPACE);  // hide the popup
1706         assertFalse(cb.isShowing());
1707 
1708         sl.dispose();
1709     }
1710 
1711     @Test public void test_rt36280_editable_escapeHidesShowingPopup() {
1712         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1713         cb.setEditable(true);
1714         StageLoader sl = new StageLoader(cb);
1715         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1716 
1717         ListView listView = (ListView) ((ComboBoxListViewSkin)cb.getSkin()).getPopupContent();
1718         assertNotNull(listView);
1719 
1720         KeyEventFirer lvKeyboard = new KeyEventFirer(listView);
1721 
1722         assertFalse(cb.isShowing());
1723         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1724         assertTrue(cb.isShowing());
1725         lvKeyboard.doKeyPress(KeyCode.ESCAPE);  // hide the popup
1726         assertFalse(cb.isShowing());
1727 
1728         sl.dispose();
1729     }
1730 
1731     @Test public void test_rt36280_editable_F4HidesShowingPopup() {
1732         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1733         cb.setEditable(true);
1734         StageLoader sl = new StageLoader(cb);
1735         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1736 
1737         assertFalse(cb.isShowing());
1738         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1739         assertTrue(cb.isShowing());
1740         cbKeyboard.doKeyPress(KeyCode.F4);  // hide the popup
1741         assertFalse(cb.isShowing());
1742 
1743         sl.dispose();
1744     }
1745 
1746     @Test public void test_rt36280_editable_arrowKeysChangeSelection() {
1747         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1748         cb.setEditable(true);
1749         StageLoader sl = new StageLoader(cb);
1750         KeyEventFirer cbKeyboard = new KeyEventFirer(cb);
1751 
1752         assertFalse(cb.isShowing());
1753         cbKeyboard.doKeyPress(KeyCode.F4);  // show the popup
1754         assertTrue(cb.isShowing());
1755 
1756         assertNull(cb.getSelectionModel().getSelectedItem());
1757 
1758         cbKeyboard.doDownArrowPress();
1759         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1760 
1761         cbKeyboard.doDownArrowPress();
1762         assertEquals(&quot;b&quot;, cb.getSelectionModel().getSelectedItem());
1763 
1764         cbKeyboard.doUpArrowPress();
1765         assertEquals(&quot;a&quot;, cb.getSelectionModel().getSelectedItem());
1766 
1767         sl.dispose();
1768     }
1769 
1770     @Test public void test_rt36651() {
1771         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1772         cb.setEditable(true);
1773         StageLoader sl = new StageLoader(cb);
1774 
1775         assertNull(cb.getValue());
1776         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1777         assertNull(cb.getSelectionModel().getSelectedItem());
1778 
1779         sl.getStage().requestFocus();
1780         cb.show();
1781         Toolkit.getToolkit().firePulse();
1782 
1783         // selection should not change just by showing the popup
1784         assertNull(cb.getValue());
1785         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1786         assertNull(cb.getSelectionModel().getSelectedItem());
1787 
1788         sl.dispose();
1789     }
1790 
1791     @Test public void test_rt36717() {
1792         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1793         StageLoader sl = new StageLoader(cb);
1794 
1795         // the stack overflow only occurs when a ComboBox changes from non-editable to editable
1796         cb.setEditable(false);
1797         cb.setEditable(true);
1798         assertNotNull(cb.getEditor());
1799         KeyEventFirer tfKeyboard = new KeyEventFirer(cb.getEditor());
1800         tfKeyboard.doKeyPress(KeyCode.ENTER);   // Stack overflow here
1801 
1802         sl.dispose();
1803     }
1804 
1805     @Test public void test_rt36827() {
1806         final Button btn = new Button(&quot;focus owner&quot;);
1807         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1808         VBox vbox = new VBox(btn, cb);
1809 
1810         StageLoader sl = new StageLoader(vbox);
1811         sl.getStage().requestFocus();
1812         btn.requestFocus();
1813         Toolkit.getToolkit().firePulse();
1814         Scene scene = sl.getStage().getScene();
1815 
1816         assertTrue(btn.isFocused());
1817         assertEquals(btn, scene.getFocusOwner());
1818 
1819         MouseEventFirer mouse = new MouseEventFirer(cb);
1820         mouse.fireMousePressAndRelease();
1821 
1822         assertTrue(cb.isShowing());
1823         assertTrue(cb.isFocused());
1824         assertEquals(cb, scene.getFocusOwner());
1825 
1826         sl.dispose();
1827     }
1828 
1829     @Test public void test_rt36902() {
1830         final ComboBox&lt;String&gt; cb1 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1831         final ComboBox&lt;String&gt; cb2 = new ComboBox&lt;&gt;(FXCollections.observableArrayList(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;));
1832         cb2.setEditable(true);
1833         VBox vbox = new VBox(cb1, cb2);
1834 
1835         // lame - I would rather have one keyboard here but I couldn&#39;t get it to
1836         // work, so watch out for which keyboard is used below
1837         KeyEventFirer cb1Keyboard = new KeyEventFirer(cb1);
1838         KeyEventFirer cb2Keyboard = new KeyEventFirer(cb2);
1839 
1840         StageLoader sl = new StageLoader(vbox);
1841         sl.getStage().requestFocus();
1842         cb1.requestFocus();
1843         Toolkit.getToolkit().firePulse();
1844         Scene scene = sl.getStage().getScene();
1845 
1846         assertTrue(cb1.isFocused());
1847         assertEquals(cb1, scene.getFocusOwner());
1848 
1849         // move focus forward to cb2
1850         cb1Keyboard.doKeyPress(KeyCode.TAB);
1851         assertTrue(cb2.isFocused());
1852         assertEquals(cb2, scene.getFocusOwner());
1853 
1854         // move focus forward again to cb1
1855         cb2Keyboard.doKeyPress(KeyCode.TAB);
1856         assertTrue(cb1.isFocused());
1857         assertEquals(cb1, scene.getFocusOwner());
1858 
1859         // now start going backwards with shift-tab.
1860         // The first half of the bug is here - when we shift-tab into cb2, we
1861         // actually go into the FakeFocusTextField subcomponent, so whilst the
1862         // cb2.isFocused() returns true as expected, the scene focus owner is
1863         // not the ComboBox, but the FakeFocusTextField inside it
1864         cb1Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1865         assertTrue(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1866                 cb2.isFocused());
1867         // Updated with fix for RT-34602: The TextField now never gets
1868         // focus (it&#39;s just faking it).
1869         // assertEquals(&quot;Expect cb2 TextField to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1870         //         cb2.getEditor(), scene.getFocusOwner());
1871         assertEquals(&quot;Expect cb2 to be focused, but actual focus owner is: &quot; + scene.getFocusOwner(),
1872                      cb2, scene.getFocusOwner());
1873 
1874         // This is where the second half of the bug appears, as we are stuck in
1875         // the FakeFocusTextField of cb2, we never make it to cb1
1876         cb2Keyboard.doKeyPress(KeyCode.TAB, KeyModifier.SHIFT);
1877         assertTrue(cb1.isFocused());
1878         assertEquals(cb1, scene.getFocusOwner());
1879 
1880         sl.dispose();
1881     }
1882 
1883     private int rt_38901_counter;
1884     @Test public void test_rt_38901_selectNull() {
1885         test_rt_38901(true);
1886     }
1887 
1888     @Test public void test_rt_38901_selectNegativeOne() {
1889         test_rt_38901(false);
1890     }
1891 
1892     private void test_rt_38901(boolean selectNull) {
1893         rt_38901_counter = 0;
1894 
1895         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1896         cb.setOnShowing((e) -&gt; {
1897             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_38901_counter++));
1898         });
1899 
1900         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1901         assertNull(cb.getSelectionModel().getSelectedItem());
1902         assertNull(cb.getValue());
1903         assertEquals(0, cb.getItems().size());
1904 
1905         // round one
1906         cb.show();
1907         assertEquals(1, cb.getItems().size());
1908         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1909         cb.hide();
1910 
1911         cb.getSelectionModel().select(0);
1912         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1913         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1914         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1915 
1916         if (selectNull) cb.getSelectionModel().select(null);
1917         else cb.getSelectionModel().select(-1);
1918 
1919         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1920         assertNull(cb.getSelectionModel().getSelectedItem());
1921         assertNull(cb.getValue());
1922 
1923 
1924         // round two
1925         cb.show();
1926         assertEquals(1, cb.getItems().size());
1927         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1928         cb.hide();
1929 
1930         cb.getSelectionModel().select(0);
1931         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1932         assertEquals(&quot;DUMMY 1&quot;, cb.getSelectionModel().getSelectedItem());
1933         assertEquals(&quot;DUMMY 1&quot;, cb.getValue());
1934 
1935         if (selectNull) cb.getSelectionModel().select(null);
1936         else cb.getSelectionModel().select(-1);
1937 
1938         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1939         assertNull(cb.getSelectionModel().getSelectedItem());
1940         assertNull(cb.getValue());
1941     }
1942 
1943     private int rt_22572_counter;
1944     @Test public void test_rt_22572() {
1945         rt_22572_counter = 0;
1946 
1947         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1948         cb.setOnShowing((e) -&gt; {
1949             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22572_counter++));
1950         });
1951 
1952         StageLoader sl = new StageLoader(cb);
1953 
1954         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1955         assertNull(cb.getSelectionModel().getSelectedItem());
1956         assertNull(cb.getValue());
1957         assertEquals(0, cb.getItems().size());
1958 
1959         // round one
1960         cb.show();
1961         assertEquals(1, cb.getItems().size());
1962         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
1963         cb.hide();
1964 
1965         cb.getSelectionModel().select(0);
1966         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
1967         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
1968         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1969 
1970 
1971         // round two - even though the items change, the value should still be
1972         // the old value (even though it doesn&#39;t exist in the items list any longer).
1973         // The selectedIndex and selectedItem do get reset however.
1974         cb.show();
1975         assertEquals(1, cb.getItems().size());
1976         assertEquals(&quot;DUMMY 1&quot;, cb.getItems().get(0));
1977         cb.hide();
1978 
1979         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
1980         assertNull(cb.getSelectionModel().getSelectedItem());
1981         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
1982 
1983         sl.dispose();
1984     }
1985 
1986     private int rt_22937_counter;
1987     @Test public void test_rt_22937() {
1988         rt_22937_counter = 0;
1989 
1990         final ComboBox&lt;String&gt; cb = new ComboBox&lt;&gt;();
1991         cb.setOnShowing((e) -&gt; {
1992             cb.getItems().setAll(&quot;DUMMY &quot; + (rt_22937_counter++));
1993         });
1994 
1995         cb.getItems().add(&quot;Toto&quot;);
1996         cb.setEditable(true);
1997         cb.setValue(&quot;Tata&quot;);
1998 
1999         StageLoader sl = new StageLoader(cb);
2000 
2001         assertEquals(-1, cb.getSelectionModel().getSelectedIndex());
2002         assertEquals(&quot;Tata&quot;, cb.getSelectionModel().getSelectedItem());
2003         assertEquals(&quot;Tata&quot;, cb.getValue());
2004         assertEquals(1, cb.getItems().size());
2005 
2006         cb.show();
2007         assertEquals(1, cb.getItems().size());
2008         assertEquals(&quot;DUMMY 0&quot;, cb.getItems().get(0));
2009         cb.hide();
2010 
2011         cb.getSelectionModel().select(0);
2012         assertEquals(0, cb.getSelectionModel().getSelectedIndex());
2013         assertEquals(&quot;DUMMY 0&quot;, cb.getSelectionModel().getSelectedItem());
2014         assertEquals(&quot;DUMMY 0&quot;, cb.getValue());
2015 
2016         sl.dispose();
2017     }
2018 
2019     @Test public void test_rt_39809() {
2020         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2021         comboBox.getItems().setAll(null, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
2022 
2023         StageLoader sl = new StageLoader(comboBox);
2024 
2025         comboBox.getSelectionModel().clearAndSelect(1);
2026         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
2027         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
2028 
2029         comboBox.getSelectionModel().clearAndSelect(0);
2030         assertEquals(null, comboBox.getSelectionModel().getSelectedItem());
2031         assertEquals(0, comboBox.getSelectionModel().getSelectedIndex());
2032 
2033         sl.dispose();
2034     }
2035 
2036     @Test public void test_rt_39908() {
2037         ObservableList&lt;String&gt; model = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);
2038         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(model);
2039 
2040         StageLoader sl = new StageLoader(comboBox);
2041 
2042         comboBox.getSelectionModel().clearAndSelect(1);
2043         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
2044         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
2045 
2046         model.set(0, &quot;a&quot;);
2047         assertEquals(&quot;1&quot;, comboBox.getSelectionModel().getSelectedItem());
2048         assertEquals(1, comboBox.getSelectionModel().getSelectedIndex());
2049 
2050         sl.dispose();
2051     }
2052 
2053     /**
2054      * Bullet 1: selected index must be updated
2055      * Corner case: last selected. Fails for core
2056      */
2057     @Test public void test_rt_40012_selectedAtLastOnDisjointRemoveItemsAbove() {
2058         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2059         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2060         SelectionModel sm = comboBox.getSelectionModel();
2061 
2062         int last = items.size() - 1;
2063 
2064         // selecting item &quot;5&quot;
2065         sm.select(last);
2066 
2067         // disjoint remove of 2 elements above the last selected
2068         // Removing &quot;1&quot; and &quot;3&quot;
2069         items.removeAll(items.get(1), items.get(3));
2070 
2071         // selection should move up two places such that it remains on item &quot;5&quot;,
2072         // but in index (last - 2).
2073         int expected = last - 2;
2074         assertEquals(&quot;5&quot;, sm.getSelectedItem());
2075         assertEquals(&quot;selected index after disjoint removes above&quot;, expected, sm.getSelectedIndex());
2076     }
2077 
2078     /**
2079      * Variant of 1: if selectedIndex is not updated,
2080      * the old index is no longer valid
2081      * for accessing the items.
2082      */
2083     @Test public void test_rt_40012_accessSelectedAtLastOnDisjointRemoveItemsAbove() {
2084         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2085         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2086         SelectionModel sm = comboBox.getSelectionModel();
2087 
2088         int last = items.size() - 1;
2089 
2090         // selecting item &quot;5&quot;
2091         sm.select(last);
2092 
2093         // disjoint remove of 2 elements above the last selected
2094         items.removeAll(items.get(1), items.get(3));
2095         int selected = sm.getSelectedIndex();
2096         if (selected &gt; -1) {
2097             items.get(selected);
2098         }
2099     }
2100 
2101     /**
2102      * Bullet 2: selectedIndex notification count
2103      *
2104      * Note that we don&#39;t use the corner case of having the last index selected
2105      * (which fails already on updating the index)
2106      */
2107     private int rt_40012_count = 0;
2108     @Test public void test_rt_40012_selectedIndexNotificationOnDisjointRemovesAbove() {
2109         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2110         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2111         SelectionModel sm = comboBox.getSelectionModel();
2112 
2113         int last = items.size() - 2;
2114         sm.select(last);
2115         assertEquals(last, sm.getSelectedIndex());
2116 
2117         rt_40012_count = 0;
2118         sm.selectedIndexProperty().addListener(o -&gt; rt_40012_count++);
2119 
2120         // disjoint remove of 2 elements above the last selected
2121         items.removeAll(items.get(1), items.get(3));
2122         assertEquals(&quot;sanity: selectedIndex must be shifted by -2&quot;, last - 2, sm.getSelectedIndex());
2123         assertEquals(&quot;must fire single event on removes above&quot;, 1, rt_40012_count);
2124     }
2125 
2126     /**
2127      * Bullet 3: unchanged selectedItem must not fire change
2128      */
2129     @Test
2130     public void test_rt_40012_selectedItemNotificationOnDisjointRemovesAbove() {
2131         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
2132         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;(items);
2133         SelectionModel sm = comboBox.getSelectionModel();
2134 
2135         int last = items.size() - 2;
2136         Object lastItem = items.get(last);
2137         sm.select(last);
2138         assertEquals(lastItem, sm.getSelectedItem());
2139 
2140         rt_40012_count = 0;
2141         sm.selectedItemProperty().addListener(o -&gt; rt_40012_count++);
2142 
2143         // disjoint remove of 2 elements above the last selected
2144         items.removeAll(items.get(1), items.get(3));
2145         assertEquals(&quot;sanity: selectedItem unchanged&quot;, lastItem, sm.getSelectedItem());
2146         assertEquals(&quot;must not fire on unchanged selected item&quot;, 0, rt_40012_count);
2147     }
2148 
2149     @Test public void test_jdk_8150946_testCommit_valid() {
2150         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2151         comboBox.setEditable(true);
2152         assertEquals(null, comboBox.getValue());
2153         comboBox.getEditor().setText(&quot;ABC&quot;);
2154         comboBox.commitValue();
2155         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2156     }
2157 
2158     @Test public void test_jdk_8150946_testCancel_toNull() {
2159         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2160         comboBox.setEditable(true);
2161         assertNull(comboBox.getValue());
2162         assertEquals(&quot;&quot;, comboBox.getEditor().getText());
2163         comboBox.getEditor().setText(&quot;ABC&quot;);
2164         assertNull(comboBox.getValue());
2165         comboBox.cancelEdit();
2166         assertNull(comboBox.getValue());
2167         assertNull(comboBox.getEditor().getText());
2168     }
2169 
2170     @Test public void test_jdk_8150946_testCancel_toNonNull() {
2171         ComboBox&lt;String&gt; comboBox = new ComboBox&lt;&gt;();
2172         comboBox.setEditable(true);
2173         comboBox.getEditor().setText(&quot;ABC&quot;);
2174         comboBox.commitValue();
2175         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2176         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2177         comboBox.getEditor().setText(&quot;DEF&quot;);
2178         assertEquals(&quot;DEF&quot;, comboBox.getEditor().getText());
2179         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2180         comboBox.cancelEdit();
2181         assertEquals(&quot;ABC&quot;, comboBox.getValue());
2182         assertEquals(&quot;ABC&quot;, comboBox.getEditor().getText());
2183     }
2184 
2185     @Test public void test_jdk_8160493() {
2186         AtomicInteger count = new AtomicInteger();
2187         comboBox.valueProperty().addListener(o -&gt; count.incrementAndGet());
2188         assertEquals(0, count.get());
2189 
2190         comboBox.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
2191         sm.select(1);
2192         assertTrue(sm.isSelected(1));
2193         assertEquals(1, count.get());
2194         assertEquals(&quot;Orange&quot;, comboBox.getValue());
2195 
2196         comboBox.setValue(&quot;New Value&quot;);
2197         assertEquals(2, count.get());
2198         assertEquals(&quot;New Value&quot;, comboBox.getValue());
2199     }
2200 
2201     private int skinChangedCount = 0;
2202     @Test public void test_JDK_8185854() {
2203         final FlowPane comboPane = new FlowPane(10, 10);
2204         ComboBox combo = new ComboBox&lt;String&gt;();
2205 
2206         combo.skinProperty().addListener((o, oldSkin, newSkin) -&gt; {
2207             skinChangedCount++;
2208         });
2209 
2210         combo.setDisable(false);
2211         combo.setEditable(false);
2212 
2213         comboPane.getChildren().add(combo);
2214 
2215         TabPane tabPane = new TabPane();
2216         Tab tab = new Tab();
2217         tab.setText(&quot;ComboBox&quot;);
2218         tab.setContent(comboPane);
2219         tabPane.getTabs().add(tab);
2220 
2221         BorderPane p = new BorderPane();
2222         p.setCenter(tabPane);
2223 
2224         Scene scene = new Scene(p);
2225         scene.getStylesheets().add(ComboBoxTest.class.getResource(&quot;JDK_8185854.css&quot;).toExternalForm());
2226 
2227         Toolkit tk = Toolkit.getToolkit();
2228 
2229         Stage stage = new Stage();
2230         stage.setScene(scene);
2231         stage.setWidth(500);
2232         stage.setHeight(400);
2233 
2234         stage.show();
2235 
2236         tk.firePulse();
2237 
2238         assertEquals(&quot;ComboBox skinProperty changed more than once, which is not expected.&quot;, 1, skinChangedCount);
2239     }
2240 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>