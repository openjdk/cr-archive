<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/oops/instanceKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/classFileParser.hpp&quot;
  29 #include &quot;classfile/classFileStream.hpp&quot;
  30 #include &quot;classfile/classLoader.hpp&quot;
  31 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  32 #include &quot;classfile/javaClasses.hpp&quot;
  33 #include &quot;classfile/moduleEntry.hpp&quot;
  34 #include &quot;classfile/resolutionErrors.hpp&quot;
  35 #include &quot;classfile/symbolTable.hpp&quot;
  36 #include &quot;classfile/systemDictionary.hpp&quot;
  37 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  38 #include &quot;classfile/verifier.hpp&quot;
  39 #include &quot;classfile/vmSymbols.hpp&quot;
  40 #include &quot;code/dependencyContext.hpp&quot;
  41 #include &quot;compiler/compileBroker.hpp&quot;
  42 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  43 #include &quot;interpreter/oopMapCache.hpp&quot;
  44 #include &quot;interpreter/rewriter.hpp&quot;
  45 #include &quot;jvmtifiles/jvmti.h&quot;
  46 #include &quot;logging/log.hpp&quot;
  47 #include &quot;logging/logMessage.hpp&quot;
  48 #include &quot;logging/logStream.hpp&quot;
  49 #include &quot;memory/allocation.inline.hpp&quot;
  50 #include &quot;memory/iterator.inline.hpp&quot;
  51 #include &quot;memory/metadataFactory.hpp&quot;
  52 #include &quot;memory/metaspaceClosure.hpp&quot;
  53 #include &quot;memory/metaspaceShared.hpp&quot;
  54 #include &quot;memory/oopFactory.hpp&quot;
  55 #include &quot;memory/resourceArea.hpp&quot;
  56 #include &quot;memory/universe.hpp&quot;
  57 #include &quot;oops/fieldStreams.inline.hpp&quot;
  58 #include &quot;oops/constantPool.hpp&quot;
  59 #include &quot;oops/instanceClassLoaderKlass.hpp&quot;
  60 #include &quot;oops/instanceKlass.inline.hpp&quot;
  61 #include &quot;oops/instanceMirrorKlass.hpp&quot;
  62 #include &quot;oops/instanceOop.hpp&quot;
  63 #include &quot;oops/klass.inline.hpp&quot;
  64 #include &quot;oops/method.hpp&quot;
  65 #include &quot;oops/oop.inline.hpp&quot;
  66 #include &quot;oops/recordComponent.hpp&quot;
  67 #include &quot;oops/symbol.hpp&quot;
  68 #include &quot;oops/inlineKlass.hpp&quot;
  69 #include &quot;prims/jvmtiExport.hpp&quot;
  70 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  71 #include &quot;prims/jvmtiThreadState.hpp&quot;
  72 #include &quot;prims/methodComparator.hpp&quot;
  73 #include &quot;runtime/atomic.hpp&quot;
  74 #include &quot;runtime/biasedLocking.hpp&quot;
  75 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  76 #include &quot;runtime/handles.inline.hpp&quot;
  77 #include &quot;runtime/javaCalls.hpp&quot;
  78 #include &quot;runtime/mutexLocker.hpp&quot;
  79 #include &quot;runtime/orderAccess.hpp&quot;
  80 #include &quot;runtime/thread.inline.hpp&quot;
  81 #include &quot;services/classLoadingService.hpp&quot;
  82 #include &quot;services/threadService.hpp&quot;
  83 #include &quot;utilities/dtrace.hpp&quot;
  84 #include &quot;utilities/events.hpp&quot;
  85 #include &quot;utilities/macros.hpp&quot;
  86 #include &quot;utilities/stringUtils.hpp&quot;
  87 #ifdef COMPILER1
  88 #include &quot;c1/c1_Compiler.hpp&quot;
  89 #endif
  90 #if INCLUDE_JFR
  91 #include &quot;jfr/jfrEvents.hpp&quot;
  92 #endif
  93 
  94 
  95 #ifdef DTRACE_ENABLED
  96 
  97 
  98 #define HOTSPOT_CLASS_INITIALIZATION_required HOTSPOT_CLASS_INITIALIZATION_REQUIRED
  99 #define HOTSPOT_CLASS_INITIALIZATION_recursive HOTSPOT_CLASS_INITIALIZATION_RECURSIVE
 100 #define HOTSPOT_CLASS_INITIALIZATION_concurrent HOTSPOT_CLASS_INITIALIZATION_CONCURRENT
 101 #define HOTSPOT_CLASS_INITIALIZATION_erroneous HOTSPOT_CLASS_INITIALIZATION_ERRONEOUS
 102 #define HOTSPOT_CLASS_INITIALIZATION_super__failed HOTSPOT_CLASS_INITIALIZATION_SUPER_FAILED
 103 #define HOTSPOT_CLASS_INITIALIZATION_clinit HOTSPOT_CLASS_INITIALIZATION_CLINIT
 104 #define HOTSPOT_CLASS_INITIALIZATION_error HOTSPOT_CLASS_INITIALIZATION_ERROR
 105 #define HOTSPOT_CLASS_INITIALIZATION_end HOTSPOT_CLASS_INITIALIZATION_END
 106 #define DTRACE_CLASSINIT_PROBE(type, thread_type)                \
 107   {                                                              \
 108     char* data = NULL;                                           \
 109     int len = 0;                                                 \
 110     Symbol* clss_name = name();                                  \
 111     if (clss_name != NULL) {                                     \
 112       data = (char*)clss_name-&gt;bytes();                          \
 113       len = clss_name-&gt;utf8_length();                            \
 114     }                                                            \
 115     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 116       data, len, (void*)class_loader(), thread_type);            \
 117   }
 118 
 119 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)     \
 120   {                                                              \
 121     char* data = NULL;                                           \
 122     int len = 0;                                                 \
 123     Symbol* clss_name = name();                                  \
 124     if (clss_name != NULL) {                                     \
 125       data = (char*)clss_name-&gt;bytes();                          \
 126       len = clss_name-&gt;utf8_length();                            \
 127     }                                                            \
 128     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 129       data, len, (void*)class_loader(), thread_type, wait);      \
 130   }
 131 
 132 #else //  ndef DTRACE_ENABLED
 133 
 134 #define DTRACE_CLASSINIT_PROBE(type, thread_type)
 135 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)
 136 
 137 #endif //  ndef DTRACE_ENABLED
 138 
 139 
 140 static inline bool is_class_loader(const Symbol* class_name,
 141                                    const ClassFileParser&amp; parser) {
 142   assert(class_name != NULL, &quot;invariant&quot;);
 143 
 144   if (class_name == vmSymbols::java_lang_ClassLoader()) {
 145     return true;
 146   }
 147 
 148   if (SystemDictionary::ClassLoader_klass_loaded()) {
 149     const Klass* const super_klass = parser.super_klass();
 150     if (super_klass != NULL) {
 151       if (super_klass-&gt;is_subtype_of(SystemDictionary::ClassLoader_klass())) {
 152         return true;
 153       }
 154     }
 155   }
 156   return false;
 157 }
 158 
 159 bool InstanceKlass::field_is_inline_type(int index) const { return Signature::basic_type(field(index)-&gt;signature(constants())) == T_INLINE_TYPE; }
 160 
 161 // private: called to verify that k is a static member of this nest.
 162 // We know that k is an instance class in the same package and hence the
 163 // same classloader.
 164 bool InstanceKlass::has_nest_member(InstanceKlass* k, TRAPS) const {
 165   assert(!is_hidden(), &quot;unexpected hidden class&quot;);
 166   if (_nest_members == NULL || _nest_members == Universe::the_empty_short_array()) {
 167     if (log_is_enabled(Trace, class, nestmates)) {
 168       ResourceMark rm(THREAD);
 169       log_trace(class, nestmates)(&quot;Checked nest membership of %s in non-nest-host class %s&quot;,
 170                                   k-&gt;external_name(), this-&gt;external_name());
 171     }
 172     return false;
 173   }
 174 
 175   if (log_is_enabled(Trace, class, nestmates)) {
 176     ResourceMark rm(THREAD);
 177     log_trace(class, nestmates)(&quot;Checking nest membership of %s in %s&quot;,
 178                                 k-&gt;external_name(), this-&gt;external_name());
 179   }
 180 
 181   // Check for a resolved cp entry , else fall back to a name check.
 182   // We don&#39;t want to resolve any class other than the one being checked.
 183   for (int i = 0; i &lt; _nest_members-&gt;length(); i++) {
 184     int cp_index = _nest_members-&gt;at(i);
 185     if (_constants-&gt;tag_at(cp_index).is_klass()) {
 186       Klass* k2 = _constants-&gt;klass_at(cp_index, THREAD);
 187       assert(!HAS_PENDING_EXCEPTION || PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass()),
 188              &quot;Exceptions should not be possible here&quot;);
 189       if (k2 == k) {
 190         log_trace(class, nestmates)(&quot;- class is listed at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 191         return true;
 192       }
 193     }
 194     else {
 195       Symbol* name = _constants-&gt;klass_name_at(cp_index);
 196       if (name == k-&gt;name()) {
 197         log_trace(class, nestmates)(&quot;- Found it at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 198 
 199         // Names match so check actual klass. This may trigger class loading if
 200         // it doesn&#39;t match though that should be impossible as it means one classloader
 201         // has defined two different classes with the same name! A compiler thread won&#39;t be
 202         // able to perform that loading but we can&#39;t exclude the compiler threads from
 203         // executing this logic. But it should actually be impossible to trigger loading here.
 204         Klass* k2 = _constants-&gt;klass_at(cp_index, THREAD);
 205         assert(!HAS_PENDING_EXCEPTION || PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass()),
 206                &quot;Exceptions should not be possible here&quot;);
 207         if (k2 == k) {
 208           log_trace(class, nestmates)(&quot;- class is listed as a nest member&quot;);
 209           return true;
 210         }
 211         else {
 212           // same name but different klass!
 213           log_trace(class, nestmates)(&quot; - klass comparison failed!&quot;);
 214           // can&#39;t have two names the same, so we&#39;re done
 215           return false;
 216         }
 217       }
 218     }
 219   }
 220   log_trace(class, nestmates)(&quot;- class is NOT a nest member!&quot;);
 221   return false;
 222 }
 223 
 224 // Called to verify that k is a permitted subclass of this class
 225 bool InstanceKlass::has_as_permitted_subclass(const InstanceKlass* k) const {
 226   Thread* THREAD = Thread::current();
 227   assert(k != NULL, &quot;sanity check&quot;);
 228   assert(_permitted_subclasses != NULL &amp;&amp; _permitted_subclasses != Universe::the_empty_short_array(),
 229          &quot;unexpected empty _permitted_subclasses array&quot;);
 230 
 231   if (log_is_enabled(Trace, class, sealed)) {
 232     ResourceMark rm(THREAD);
 233     log_trace(class, sealed)(&quot;Checking for permitted subclass of %s in %s&quot;,
 234                              k-&gt;external_name(), this-&gt;external_name());
 235   }
 236 
 237   // Check that the class and its super are in the same module.
 238   if (k-&gt;module() != this-&gt;module()) {
 239     ResourceMark rm(THREAD);
 240     log_trace(class, sealed)(&quot;Check failed for same module of permitted subclass %s and sealed class %s&quot;,
 241                              k-&gt;external_name(), this-&gt;external_name());
 242     return false;
 243   }
 244 
 245   if (!k-&gt;is_public() &amp;&amp; !is_same_class_package(k)) {
 246     ResourceMark rm(THREAD);
 247     log_trace(class, sealed)(&quot;Check failed, subclass %s not public and not in the same package as sealed class %s&quot;,
 248                              k-&gt;external_name(), this-&gt;external_name());
 249     return false;
 250   }
 251 
 252   // Check for a resolved cp entry, else fall back to a name check.
 253   // We don&#39;t want to resolve any class other than the one being checked.
 254   for (int i = 0; i &lt; _permitted_subclasses-&gt;length(); i++) {
 255     int cp_index = _permitted_subclasses-&gt;at(i);
 256     if (_constants-&gt;tag_at(cp_index).is_klass()) {
 257       Klass* k2 = _constants-&gt;klass_at(cp_index, THREAD);
 258       assert(!HAS_PENDING_EXCEPTION, &quot;Unexpected exception&quot;);
 259       if (k2 == k) {
 260         log_trace(class, sealed)(&quot;- class is listed at permitted_subclasses[%d] =&gt; cp[%d]&quot;, i, cp_index);
 261         return true;
 262       }
 263     } else {
 264       Symbol* name = _constants-&gt;klass_name_at(cp_index);
 265       if (name == k-&gt;name()) {
 266         log_trace(class, sealed)(&quot;- Found it at permitted_subclasses[%d] =&gt; cp[%d]&quot;, i, cp_index);
 267         return true;
 268       }
 269     }
 270   }
 271   log_trace(class, sealed)(&quot;- class is NOT a permitted subclass!&quot;);
 272   return false;
 273 }
 274 
 275 // Return nest-host class, resolving, validating and saving it if needed.
 276 // In cases where this is called from a thread that cannot do classloading
 277 // (such as a native JIT thread) then we simply return NULL, which in turn
 278 // causes the access check to return false. Such code will retry the access
 279 // from a more suitable environment later. Otherwise the _nest_host is always
 280 // set once this method returns.
 281 // Any errors from nest-host resolution must be preserved so they can be queried
 282 // from higher-level access checking code, and reported as part of access checking
 283 // exceptions.
 284 // VirtualMachineErrors are propagated with a NULL return.
 285 // Under any conditions where the _nest_host can be set to non-NULL the resulting
 286 // value of it and, if applicable, the nest host resolution/validation error,
 287 // are idempotent.
 288 InstanceKlass* InstanceKlass::nest_host(TRAPS) {
 289   InstanceKlass* nest_host_k = _nest_host;
 290   if (nest_host_k != NULL) {
 291     return nest_host_k;
 292   }
 293 
 294   ResourceMark rm(THREAD);
 295 
 296   // need to resolve and save our nest-host class.
 297   if (_nest_host_index != 0) { // we have a real nest_host
 298     // Before trying to resolve check if we&#39;re in a suitable context
 299     if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(_nest_host_index).is_klass()) {
 300       log_trace(class, nestmates)(&quot;Rejected resolution of nest-host of %s in unsuitable thread&quot;,
 301                                   this-&gt;external_name());
 302       return NULL; // sentinel to say &quot;try again from a different context&quot;
 303     }
 304 
 305     log_trace(class, nestmates)(&quot;Resolving nest-host of %s using cp entry for %s&quot;,
 306                                 this-&gt;external_name(),
 307                                 _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string());
 308 
 309     Klass* k = _constants-&gt;klass_at(_nest_host_index, THREAD);
 310     if (HAS_PENDING_EXCEPTION) {
 311       if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass())) {
 312         return NULL; // propagate VMEs
 313       }
 314       stringStream ss;
 315       char* target_host_class = _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string();
 316       ss.print(&quot;Nest host resolution of %s with host %s failed: &quot;,
 317                this-&gt;external_name(), target_host_class);
 318       java_lang_Throwable::print(PENDING_EXCEPTION, &amp;ss);
 319       const char* msg = ss.as_string(true /* on C-heap */);
 320       constantPoolHandle cph(THREAD, constants());
 321       SystemDictionary::add_nest_host_error(cph, _nest_host_index, msg);
 322       CLEAR_PENDING_EXCEPTION;
 323 
 324       log_trace(class, nestmates)(&quot;%s&quot;, msg);
 325     } else {
 326       // A valid nest-host is an instance class in the current package that lists this
 327       // class as a nest member. If any of these conditions are not met the class is
 328       // its own nest-host.
 329       const char* error = NULL;
 330 
 331       // JVMS 5.4.4 indicates package check comes first
 332       if (is_same_class_package(k)) {
 333         // Now check actual membership. We can&#39;t be a member if our &quot;host&quot; is
 334         // not an instance class.
 335         if (k-&gt;is_instance_klass()) {
 336           nest_host_k = InstanceKlass::cast(k);
 337           bool is_member = nest_host_k-&gt;has_nest_member(this, THREAD);
 338           // exception is rare, perhaps impossible
 339           if (!HAS_PENDING_EXCEPTION) {
 340             if (is_member) {
 341               _nest_host = nest_host_k; // save resolved nest-host value
 342 
 343               log_trace(class, nestmates)(&quot;Resolved nest-host of %s to %s&quot;,
 344                                           this-&gt;external_name(), k-&gt;external_name());
 345               return nest_host_k;
 346             } else {
 347               error = &quot;current type is not listed as a nest member&quot;;
 348             }
 349           } else {
 350             if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::VirtualMachineError_klass())) {
 351               return NULL; // propagate VMEs
 352             }
 353             stringStream ss;
 354             ss.print(&quot;exception on member check: &quot;);
 355             java_lang_Throwable::print(PENDING_EXCEPTION, &amp;ss);
 356             error = ss.as_string();
 357           }
 358         } else {
 359           error = &quot;host is not an instance class&quot;;
 360         }
 361       } else {
 362         error = &quot;types are in different packages&quot;;
 363       }
 364 
 365       // something went wrong, so record what and log it
 366       {
 367         stringStream ss;
 368         ss.print(&quot;Type %s (loader: %s) is not a nest member of type %s (loader: %s): %s&quot;,
 369                  this-&gt;external_name(),
 370                  this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 371                  k-&gt;external_name(),
 372                  k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 373                  error);
 374         const char* msg = ss.as_string(true /* on C-heap */);
 375         constantPoolHandle cph(THREAD, constants());
 376         SystemDictionary::add_nest_host_error(cph, _nest_host_index, msg);
 377         log_trace(class, nestmates)(&quot;%s&quot;, msg);
 378       }
 379     }
 380   } else {
 381     log_trace(class, nestmates)(&quot;Type %s is not part of a nest: setting nest-host to self&quot;,
 382                                 this-&gt;external_name());
 383   }
 384 
 385   // Either not in an explicit nest, or else an error occurred, so
 386   // the nest-host is set to `this`. Any thread that sees this assignment
 387   // will also see any setting of nest_host_error(), if applicable.
 388   return (_nest_host = this);
 389 }
 390 
 391 // Dynamic nest member support: set this class&#39;s nest host to the given class.
 392 // This occurs as part of the class definition, as soon as the instanceKlass
 393 // has been created and doesn&#39;t require further resolution. The code:
 394 //    lookup().defineHiddenClass(bytes_for_X, NESTMATE);
 395 // results in:
 396 //    class_of_X.set_nest_host(lookup().lookupClass().getNestHost())
 397 // If it has an explicit _nest_host_index or _nest_members, these will be ignored.
 398 // We also know the &quot;host&quot; is a valid nest-host in the same package so we can
 399 // assert some of those facts.
 400 void InstanceKlass::set_nest_host(InstanceKlass* host, TRAPS) {
 401   assert(is_hidden(), &quot;must be a hidden class&quot;);
 402   assert(host != NULL, &quot;NULL nest host specified&quot;);
 403   assert(_nest_host == NULL, &quot;current class has resolved nest-host&quot;);
 404   assert(nest_host_error(THREAD) == NULL, &quot;unexpected nest host resolution error exists: %s&quot;,
 405          nest_host_error(THREAD));
 406   assert((host-&gt;_nest_host == NULL &amp;&amp; host-&gt;_nest_host_index == 0) ||
 407          (host-&gt;_nest_host == host), &quot;proposed host is not a valid nest-host&quot;);
 408   // Can&#39;t assert this as package is not set yet:
 409   // assert(is_same_class_package(host), &quot;proposed host is in wrong package&quot;);
 410 
 411   if (log_is_enabled(Trace, class, nestmates)) {
 412     ResourceMark rm(THREAD);
 413     const char* msg = &quot;&quot;;
 414     // a hidden class does not expect a statically defined nest-host
 415     if (_nest_host_index &gt; 0) {
 416       msg = &quot;(the NestHost attribute in the current class is ignored)&quot;;
 417     } else if (_nest_members != NULL &amp;&amp; _nest_members != Universe::the_empty_short_array()) {
 418       msg = &quot;(the NestMembers attribute in the current class is ignored)&quot;;
 419     }
 420     log_trace(class, nestmates)(&quot;Injected type %s into the nest of %s %s&quot;,
 421                                 this-&gt;external_name(),
 422                                 host-&gt;external_name(),
 423                                 msg);
 424   }
 425   // set dynamic nest host
 426   _nest_host = host;
 427   // Record dependency to keep nest host from being unloaded before this class.
 428   ClassLoaderData* this_key = class_loader_data();
 429   this_key-&gt;record_dependency(host);
 430 }
 431 
 432 // check if &#39;this&#39; and k are nestmates (same nest_host), or k is our nest_host,
 433 // or we are k&#39;s nest_host - all of which is covered by comparing the two
 434 // resolved_nest_hosts.
 435 // Any exceptions (i.e. VMEs) are propagated.
 436 bool InstanceKlass::has_nestmate_access_to(InstanceKlass* k, TRAPS) {
 437 
 438   assert(this != k, &quot;this should be handled by higher-level code&quot;);
 439 
 440   // Per JVMS 5.4.4 we first resolve and validate the current class, then
 441   // the target class k.
 442 
 443   InstanceKlass* cur_host = nest_host(CHECK_false);
 444   if (cur_host == NULL) {
 445     return false;
 446   }
 447 
 448   Klass* k_nest_host = k-&gt;nest_host(CHECK_false);
 449   if (k_nest_host == NULL) {
 450     return false;
 451   }
 452 
 453   bool access = (cur_host == k_nest_host);
 454 
 455   ResourceMark rm(THREAD);
 456   log_trace(class, nestmates)(&quot;Class %s does %shave nestmate access to %s&quot;,
 457                               this-&gt;external_name(),
 458                               access ? &quot;&quot; : &quot;NOT &quot;,
 459                               k-&gt;external_name());
 460   return access;
 461 }
 462 
 463 const char* InstanceKlass::nest_host_error(TRAPS) {
 464   if (_nest_host_index == 0) {
 465     return NULL;
 466   } else {
 467     constantPoolHandle cph(THREAD, constants());
 468     return SystemDictionary::find_nest_host_error(cph, (int)_nest_host_index);
 469   }
 470 }
 471 
 472 InstanceKlass* InstanceKlass::allocate_instance_klass(const ClassFileParser&amp; parser, TRAPS) {
 473   bool is_hidden_or_anonymous = parser.is_hidden() || parser.is_unsafe_anonymous();
 474   const int size = InstanceKlass::size(parser.vtable_size(),
 475                                        parser.itable_size(),
 476                                        nonstatic_oop_map_size(parser.total_oop_map_count()),
 477                                        parser.is_interface(),
 478                                        parser.is_unsafe_anonymous(),
 479                                        should_store_fingerprint(is_hidden_or_anonymous),
 480                                        parser.has_inline_fields() ? parser.java_fields_count() : 0,
 481                                        parser.is_inline_type());
 482 
 483   const Symbol* const class_name = parser.class_name();
 484   assert(class_name != NULL, &quot;invariant&quot;);
 485   ClassLoaderData* loader_data = parser.loader_data();
 486   assert(loader_data != NULL, &quot;invariant&quot;);
 487 
 488   InstanceKlass* ik;
 489 
 490   // Allocation
 491   if (REF_NONE == parser.reference_type()) {
 492     if (class_name == vmSymbols::java_lang_Class()) {
 493       // mirror
 494       ik = new (loader_data, size, THREAD) InstanceMirrorKlass(parser);
 495     } else if (is_class_loader(class_name, parser)) {
 496       // class loader
 497       ik = new (loader_data, size, THREAD) InstanceClassLoaderKlass(parser);
 498     } else if (parser.is_inline_type()) {
 499       // inline type
 500       ik = new (loader_data, size, THREAD) InlineKlass(parser);
 501     } else {
 502       // normal
 503       ik = new (loader_data, size, THREAD) InstanceKlass(parser, InstanceKlass::_kind_other);
 504     }
 505   } else {
 506     // reference
 507     ik = new (loader_data, size, THREAD) InstanceRefKlass(parser);
 508   }
 509 
 510   // Check for pending exception before adding to the loader data and incrementing
 511   // class count.  Can get OOM here.
 512   if (HAS_PENDING_EXCEPTION) {
 513     return NULL;
 514   }
 515 
 516 #ifdef ASSERT
 517   assert(ik-&gt;size() == size, &quot;&quot;);
 518   ik-&gt;bounds_check((address) ik-&gt;start_of_vtable(), false, size);
 519   ik-&gt;bounds_check((address) ik-&gt;start_of_itable(), false, size);
 520   ik-&gt;bounds_check((address) ik-&gt;end_of_itable(), true, size);
 521   ik-&gt;bounds_check((address) ik-&gt;end_of_nonstatic_oop_maps(), true, size);
 522 #endif //ASSERT
 523   return ik;
 524 }
 525 
 526 #ifndef PRODUCT
 527 bool InstanceKlass::bounds_check(address addr, bool edge_ok, intptr_t size_in_bytes) const {
 528   const char* bad = NULL;
 529   address end = NULL;
 530   if (addr &lt; (address)this) {
 531     bad = &quot;before&quot;;
 532   } else if (addr == (address)this) {
 533     if (edge_ok)  return true;
 534     bad = &quot;just before&quot;;
 535   } else if (addr == (end = (address)this + sizeof(intptr_t) * (size_in_bytes &lt; 0 ? size() : size_in_bytes))) {
 536     if (edge_ok)  return true;
 537     bad = &quot;just after&quot;;
 538   } else if (addr &gt; end) {
 539     bad = &quot;after&quot;;
 540   } else {
 541     return true;
 542   }
 543   tty-&gt;print_cr(&quot;%s object bounds: &quot; INTPTR_FORMAT &quot; [&quot; INTPTR_FORMAT &quot;..&quot; INTPTR_FORMAT &quot;]&quot;,
 544       bad, (intptr_t)addr, (intptr_t)this, (intptr_t)end);
 545   Verbose = WizardMode = true; this-&gt;print(); //@@
 546   return false;
 547 }
 548 #endif //PRODUCT
 549 
 550 // copy method ordering from resource area to Metaspace
 551 void InstanceKlass::copy_method_ordering(const intArray* m, TRAPS) {
 552   if (m != NULL) {
 553     // allocate a new array and copy contents (memcpy?)
 554     _method_ordering = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), m-&gt;length(), CHECK);
 555     for (int i = 0; i &lt; m-&gt;length(); i++) {
 556       _method_ordering-&gt;at_put(i, m-&gt;at(i));
 557     }
 558   } else {
 559     _method_ordering = Universe::the_empty_int_array();
 560   }
 561 }
 562 
 563 // create a new array of vtable_indices for default methods
 564 Array&lt;int&gt;* InstanceKlass::create_new_default_vtable_indices(int len, TRAPS) {
 565   Array&lt;int&gt;* vtable_indices = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), len, CHECK_NULL);
 566   assert(default_vtable_indices() == NULL, &quot;only create once&quot;);
 567   set_default_vtable_indices(vtable_indices);
 568   return vtable_indices;
 569 }
 570 
 571 InstanceKlass::InstanceKlass(const ClassFileParser&amp; parser, unsigned kind, KlassID id) :
 572   Klass(id),
 573   _nest_members(NULL),
 574   _nest_host(NULL),
 575   _permitted_subclasses(NULL),
 576   _record_components(NULL),
 577   _static_field_size(parser.static_field_size()),
 578   _nonstatic_oop_map_size(nonstatic_oop_map_size(parser.total_oop_map_count())),
 579   _itable_len(parser.itable_size()),
 580   _nest_host_index(0),
 581   _init_state(allocated),
 582   _reference_type(parser.reference_type()),
 583   _init_thread(NULL),
 584   _inline_type_field_klasses(NULL),
 585   _adr_inlineklass_fixed_block(NULL)
 586 {
 587   set_vtable_length(parser.vtable_size());
 588   set_kind(kind);
 589   set_access_flags(parser.access_flags());
 590   if (parser.is_hidden()) set_is_hidden();
 591   set_is_unsafe_anonymous(parser.is_unsafe_anonymous());
 592   set_layout_helper(Klass::instance_layout_helper(parser.layout_size(),
 593                                                     false));
 594     if (parser.has_inline_fields()) {
 595       set_has_inline_type_fields();
 596     }
 597     _java_fields_count = parser.java_fields_count();
 598 
 599     assert(NULL == _methods, &quot;underlying memory not zeroed?&quot;);
 600     assert(is_instance_klass(), &quot;is layout incorrect?&quot;);
 601     assert(size_helper() == parser.layout_size(), &quot;incorrect size_helper?&quot;);
 602 
 603   // Set biased locking bit for all instances of this class; it will be
 604   // cleared if revocation occurs too often for this type
 605   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
 606     set_prototype_header(markWord::biased_locking_prototype());
 607   }
 608   if (has_inline_type_fields()) {
 609     _inline_type_field_klasses = (const Klass**) adr_inline_type_field_klasses();
 610   }
 611 }
 612 
 613 void InstanceKlass::deallocate_methods(ClassLoaderData* loader_data,
 614                                        Array&lt;Method*&gt;* methods) {
 615   if (methods != NULL &amp;&amp; methods != Universe::the_empty_method_array() &amp;&amp;
 616       !methods-&gt;is_shared()) {
 617     for (int i = 0; i &lt; methods-&gt;length(); i++) {
 618       Method* method = methods-&gt;at(i);
 619       if (method == NULL) continue;  // maybe null if error processing
 620       // Only want to delete methods that are not executing for RedefineClasses.
 621       // The previous version will point to them so they&#39;re not totally dangling
 622       assert (!method-&gt;on_stack(), &quot;shouldn&#39;t be called with methods on stack&quot;);
 623       MetadataFactory::free_metadata(loader_data, method);
 624     }
 625     MetadataFactory::free_array&lt;Method*&gt;(loader_data, methods);
 626   }
 627 }
 628 
 629 void InstanceKlass::deallocate_interfaces(ClassLoaderData* loader_data,
 630                                           const Klass* super_klass,
 631                                           Array&lt;InstanceKlass*&gt;* local_interfaces,
 632                                           Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
 633   // Only deallocate transitive interfaces if not empty, same as super class
 634   // or same as local interfaces.  See code in parseClassFile.
 635   Array&lt;InstanceKlass*&gt;* ti = transitive_interfaces;
 636   if (ti != Universe::the_empty_instance_klass_array() &amp;&amp; ti != local_interfaces) {
 637     // check that the interfaces don&#39;t come from super class
 638     Array&lt;InstanceKlass*&gt;* sti = (super_klass == NULL) ? NULL :
 639                     InstanceKlass::cast(super_klass)-&gt;transitive_interfaces();
 640     if (ti != sti &amp;&amp; ti != NULL &amp;&amp; !ti-&gt;is_shared() &amp;&amp;
 641         ti != Universe::the_single_IdentityObject_klass_array()) {
 642       MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, ti);
 643     }
 644   }
 645 
 646   // local interfaces can be empty
 647   if (local_interfaces != Universe::the_empty_instance_klass_array() &amp;&amp;
 648       local_interfaces != NULL &amp;&amp; !local_interfaces-&gt;is_shared() &amp;&amp;
 649       local_interfaces != Universe::the_single_IdentityObject_klass_array()) {
 650     MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, local_interfaces);
 651   }
 652 }
 653 
 654 void InstanceKlass::deallocate_record_components(ClassLoaderData* loader_data,
 655                                                  Array&lt;RecordComponent*&gt;* record_components) {
 656   if (record_components != NULL &amp;&amp; !record_components-&gt;is_shared()) {
 657     for (int i = 0; i &lt; record_components-&gt;length(); i++) {
 658       RecordComponent* record_component = record_components-&gt;at(i);
 659       MetadataFactory::free_metadata(loader_data, record_component);
 660     }
 661     MetadataFactory::free_array&lt;RecordComponent*&gt;(loader_data, record_components);
 662   }
 663 }
 664 
 665 // This function deallocates the metadata and C heap pointers that the
 666 // InstanceKlass points to.
 667 void InstanceKlass::deallocate_contents(ClassLoaderData* loader_data) {
 668 
 669   // Orphan the mirror first, CMS thinks it&#39;s still live.
 670   if (java_mirror() != NULL) {
 671     java_lang_Class::set_klass(java_mirror(), NULL);
 672   }
 673 
 674   // Also remove mirror from handles
 675   loader_data-&gt;remove_handle(_java_mirror);
 676 
 677   // Need to take this class off the class loader data list.
 678   loader_data-&gt;remove_class(this);
 679 
 680   // The array_klass for this class is created later, after error handling.
 681   // For class redefinition, we keep the original class so this scratch class
 682   // doesn&#39;t have an array class.  Either way, assert that there is nothing
 683   // to deallocate.
 684   assert(array_klasses() == NULL, &quot;array classes shouldn&#39;t be created for this class yet&quot;);
 685 
 686   // Release C heap allocated data that this points to, which includes
 687   // reference counting symbol names.
 688   release_C_heap_structures_internal();
 689 
 690   deallocate_methods(loader_data, methods());
 691   set_methods(NULL);
 692 
 693   deallocate_record_components(loader_data, record_components());
 694   set_record_components(NULL);
 695 
 696   if (method_ordering() != NULL &amp;&amp;
 697       method_ordering() != Universe::the_empty_int_array() &amp;&amp;
 698       !method_ordering()-&gt;is_shared()) {
 699     MetadataFactory::free_array&lt;int&gt;(loader_data, method_ordering());
 700   }
 701   set_method_ordering(NULL);
 702 
 703   // default methods can be empty
 704   if (default_methods() != NULL &amp;&amp;
 705       default_methods() != Universe::the_empty_method_array() &amp;&amp;
 706       !default_methods()-&gt;is_shared()) {
 707     MetadataFactory::free_array&lt;Method*&gt;(loader_data, default_methods());
 708   }
 709   // Do NOT deallocate the default methods, they are owned by superinterfaces.
 710   set_default_methods(NULL);
 711 
 712   // default methods vtable indices can be empty
 713   if (default_vtable_indices() != NULL &amp;&amp;
 714       !default_vtable_indices()-&gt;is_shared()) {
 715     MetadataFactory::free_array&lt;int&gt;(loader_data, default_vtable_indices());
 716   }
 717   set_default_vtable_indices(NULL);
 718 
 719 
 720   // This array is in Klass, but remove it with the InstanceKlass since
 721   // this place would be the only caller and it can share memory with transitive
 722   // interfaces.
 723   if (secondary_supers() != NULL &amp;&amp;
 724       secondary_supers() != Universe::the_empty_klass_array() &amp;&amp;
 725       // see comments in compute_secondary_supers about the following cast
 726       (address)(secondary_supers()) != (address)(transitive_interfaces()) &amp;&amp;
 727       !secondary_supers()-&gt;is_shared()) {
 728     MetadataFactory::free_array&lt;Klass*&gt;(loader_data, secondary_supers());
 729   }
 730   set_secondary_supers(NULL);
 731 
 732   deallocate_interfaces(loader_data, super(), local_interfaces(), transitive_interfaces());
 733   set_transitive_interfaces(NULL);
 734   set_local_interfaces(NULL);
 735 
 736   if (fields() != NULL &amp;&amp; !fields()-&gt;is_shared()) {
 737     MetadataFactory::free_array&lt;jushort&gt;(loader_data, fields());
 738   }
 739   set_fields(NULL, 0);
 740 
 741   // If a method from a redefined class is using this constant pool, don&#39;t
 742   // delete it, yet.  The new class&#39;s previous version will point to this.
 743   if (constants() != NULL) {
 744     assert (!constants()-&gt;on_stack(), &quot;shouldn&#39;t be called if anything is onstack&quot;);
 745     if (!constants()-&gt;is_shared()) {
 746       MetadataFactory::free_metadata(loader_data, constants());
 747     }
 748     // Delete any cached resolution errors for the constant pool
 749     SystemDictionary::delete_resolution_error(constants());
 750 
 751     set_constants(NULL);
 752   }
 753 
 754   if (inner_classes() != NULL &amp;&amp;
 755       inner_classes() != Universe::the_empty_short_array() &amp;&amp;
 756       !inner_classes()-&gt;is_shared()) {
 757     MetadataFactory::free_array&lt;jushort&gt;(loader_data, inner_classes());
 758   }
 759   set_inner_classes(NULL);
 760 
 761   if (nest_members() != NULL &amp;&amp;
 762       nest_members() != Universe::the_empty_short_array() &amp;&amp;
 763       !nest_members()-&gt;is_shared()) {
 764     MetadataFactory::free_array&lt;jushort&gt;(loader_data, nest_members());
 765   }
 766   set_nest_members(NULL);
 767 
 768   if (permitted_subclasses() != NULL &amp;&amp;
 769       permitted_subclasses() != Universe::the_empty_short_array() &amp;&amp;
 770       !permitted_subclasses()-&gt;is_shared()) {
 771     MetadataFactory::free_array&lt;jushort&gt;(loader_data, permitted_subclasses());
 772   }
 773   set_permitted_subclasses(NULL);
 774 
 775   // We should deallocate the Annotations instance if it&#39;s not in shared spaces.
 776   if (annotations() != NULL &amp;&amp; !annotations()-&gt;is_shared()) {
 777     MetadataFactory::free_metadata(loader_data, annotations());
 778   }
 779   set_annotations(NULL);
 780 
 781   if (Arguments::is_dumping_archive()) {
 782     SystemDictionaryShared::remove_dumptime_info(this);
 783   }
 784 }
 785 
 786 bool InstanceKlass::is_sealed() const {
 787   return _permitted_subclasses != NULL &amp;&amp;
 788          _permitted_subclasses != Universe::the_empty_short_array() &amp;&amp;
 789          _permitted_subclasses-&gt;length() &gt; 0;
 790 }
 791 
 792 bool InstanceKlass::should_be_initialized() const {
 793   return !is_initialized();
 794 }
 795 
 796 klassItable InstanceKlass::itable() const {
 797   return klassItable(const_cast&lt;InstanceKlass*&gt;(this));
 798 }
 799 
 800 void InstanceKlass::eager_initialize(Thread *thread) {
 801   if (!EagerInitialization) return;
 802 
 803   if (this-&gt;is_not_initialized()) {
 804     // abort if the the class has a class initializer
 805     if (this-&gt;class_initializer() != NULL) return;
 806 
 807     // abort if it is java.lang.Object (initialization is handled in genesis)
 808     Klass* super_klass = super();
 809     if (super_klass == NULL) return;
 810 
 811     // abort if the super class should be initialized
 812     if (!InstanceKlass::cast(super_klass)-&gt;is_initialized()) return;
 813 
 814     // call body to expose the this pointer
 815     eager_initialize_impl();
 816   }
 817 }
 818 
 819 // JVMTI spec thinks there are signers and protection domain in the
 820 // instanceKlass.  These accessors pretend these fields are there.
 821 // The hprof specification also thinks these fields are in InstanceKlass.
 822 oop InstanceKlass::protection_domain() const {
 823   // return the protection_domain from the mirror
 824   return java_lang_Class::protection_domain(java_mirror());
 825 }
 826 
 827 // To remove these from requires an incompatible change and CCC request.
 828 objArrayOop InstanceKlass::signers() const {
 829   // return the signers from the mirror
 830   return java_lang_Class::signers(java_mirror());
 831 }
 832 
 833 oop InstanceKlass::init_lock() const {
 834   // return the init lock from the mirror
 835   oop lock = java_lang_Class::init_lock(java_mirror());
 836   // Prevent reordering with any access of initialization state
 837   OrderAccess::loadload();
 838   assert((oop)lock != NULL || !is_not_initialized(), // initialized or in_error state
 839          &quot;only fully initialized state can have a null lock&quot;);
 840   return lock;
 841 }
 842 
 843 // Set the initialization lock to null so the object can be GC&#39;ed.  Any racing
 844 // threads to get this lock will see a null lock and will not lock.
 845 // That&#39;s okay because they all check for initialized state after getting
 846 // the lock and return.
 847 void InstanceKlass::fence_and_clear_init_lock() {
 848   // make sure previous stores are all done, notably the init_state.
 849   OrderAccess::storestore();
 850   java_lang_Class::clear_init_lock(java_mirror());
 851   assert(!is_not_initialized(), &quot;class must be initialized now&quot;);
 852 }
 853 
 854 void InstanceKlass::eager_initialize_impl() {
 855   EXCEPTION_MARK;
 856   HandleMark hm(THREAD);
 857   Handle h_init_lock(THREAD, init_lock());
 858   ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 859 
 860   // abort if someone beat us to the initialization
 861   if (!is_not_initialized()) return;  // note: not equivalent to is_initialized()
 862 
 863   ClassState old_state = init_state();
 864   link_class_impl(THREAD);
 865   if (HAS_PENDING_EXCEPTION) {
 866     CLEAR_PENDING_EXCEPTION;
 867     // Abort if linking the class throws an exception.
 868 
 869     // Use a test to avoid redundantly resetting the state if there&#39;s
 870     // no change.  Set_init_state() asserts that state changes make
 871     // progress, whereas here we might just be spinning in place.
 872     if (old_state != _init_state)
 873       set_init_state(old_state);
 874   } else {
 875     // linking successfull, mark class as initialized
 876     set_init_state(fully_initialized);
 877     fence_and_clear_init_lock();
 878     // trace
 879     if (log_is_enabled(Info, class, init)) {
 880       ResourceMark rm(THREAD);
 881       log_info(class, init)(&quot;[Initialized %s without side effects]&quot;, external_name());
 882     }
 883   }
 884 }
 885 
 886 
 887 // See &quot;The Virtual Machine Specification&quot; section 2.16.5 for a detailed explanation of the class initialization
 888 // process. The step comments refers to the procedure described in that section.
 889 // Note: implementation moved to static method to expose the this pointer.
 890 void InstanceKlass::initialize(TRAPS) {
 891   if (this-&gt;should_be_initialized()) {
 892     initialize_impl(CHECK);
 893     // Note: at this point the class may be initialized
 894     //       OR it may be in the state of being initialized
 895     //       in case of recursive initialization!
 896   } else {
 897     assert(is_initialized(), &quot;sanity check&quot;);
 898   }
 899 }
 900 
 901 
 902 bool InstanceKlass::verify_code(TRAPS) {
 903   // 1) Verify the bytecodes
 904   return Verifier::verify(this, should_verify_class(), THREAD);
 905 }
 906 
 907 void InstanceKlass::link_class(TRAPS) {
 908   assert(is_loaded(), &quot;must be loaded&quot;);
 909   if (!is_linked()) {
 910     link_class_impl(CHECK);
 911   }
 912 }
 913 
 914 // Called to verify that a class can link during initialization, without
 915 // throwing a VerifyError.
 916 bool InstanceKlass::link_class_or_fail(TRAPS) {
 917   assert(is_loaded(), &quot;must be loaded&quot;);
 918   if (!is_linked()) {
 919     link_class_impl(CHECK_false);
 920   }
 921   return is_linked();
 922 }
 923 
 924 bool InstanceKlass::link_class_impl(TRAPS) {
 925   if (DumpSharedSpaces &amp;&amp; SystemDictionaryShared::has_class_failed_verification(this)) {
 926     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 927     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 928     // a convenient way to stop repeat attempts to verify the same (bad) class.
 929     //
 930     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 931     // if we are executing Java code. This is not a problem for CDS dumping phase since
 932     // it doesn&#39;t execute any Java code.
 933     ResourceMark rm(THREAD);
 934     Exceptions::fthrow(THREAD_AND_LOCATION,
 935                        vmSymbols::java_lang_NoClassDefFoundError(),
 936                        &quot;Class %s, or one of its supertypes, failed class initialization&quot;,
 937                        external_name());
 938     return false;
 939   }
 940   // return if already verified
 941   if (is_linked()) {
 942     return true;
 943   }
 944 
 945   // Timing
 946   // timer handles recursion
 947   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in link_class_impl&quot;);
 948   JavaThread* jt = (JavaThread*)THREAD;
 949 
 950   // link super class before linking this class
 951   Klass* super_klass = super();
 952   if (super_klass != NULL) {
 953     if (super_klass-&gt;is_interface()) {  // check if super class is an interface
 954       ResourceMark rm(THREAD);
 955       Exceptions::fthrow(
 956         THREAD_AND_LOCATION,
 957         vmSymbols::java_lang_IncompatibleClassChangeError(),
 958         &quot;class %s has interface %s as super class&quot;,
 959         external_name(),
 960         super_klass-&gt;external_name()
 961       );
 962       return false;
 963     }
 964 
 965     InstanceKlass* ik_super = InstanceKlass::cast(super_klass);
 966     ik_super-&gt;link_class_impl(CHECK_false);
 967   }
 968 
 969   // link all interfaces implemented by this class before linking this class
 970   Array&lt;InstanceKlass*&gt;* interfaces = local_interfaces();
 971   int num_interfaces = interfaces-&gt;length();
 972   for (int index = 0; index &lt; num_interfaces; index++) {
 973     InstanceKlass* interk = interfaces-&gt;at(index);
 974     interk-&gt;link_class_impl(CHECK_false);
 975   }
 976 
 977 
 978   // If a class declares a method that uses an inline class as an argument
 979   // type or return inline type, this inline class must be loaded during the
 980   // linking of this class because size and properties of the inline class
 981   // must be known in order to be able to perform inline type optimizations.
 982   // The implementation below is an approximation of this rule, the code
 983   // iterates over all methods of the current class (including overridden
 984   // methods), not only the methods declared by this class. This
 985   // approximation makes the code simpler, and doesn&#39;t change the semantic
 986   // because classes declaring methods overridden by the current class are
 987   // linked (and have performed their own pre-loading) before the linking
 988   // of the current class.
 989 
 990 
 991   // Note:
 992   // Inline class types are loaded during
 993   // the loading phase (see ClassFileParser::post_process_parsed_stream()).
 994   // Inline class types used as element types for array creation
 995   // are not pre-loaded. Their loading is triggered by either anewarray
 996   // or multianewarray bytecodes.
 997 
 998   // Could it be possible to do the following processing only if the
 999   // class uses inline types?
1000   {
1001     ResourceMark rm(THREAD);
1002     for (int i = 0; i &lt; methods()-&gt;length(); i++) {
1003       Method* m = methods()-&gt;at(i);
1004       for (SignatureStream ss(m-&gt;signature()); !ss.is_done(); ss.next()) {
1005         if (ss.is_reference()) {
1006           if (ss.is_array()) {
1007             ss.skip_array_prefix();
1008           }
1009           if (ss.type() == T_INLINE_TYPE) {
1010             Symbol* symb = ss.as_symbol();
1011 
1012             oop loader = class_loader();
1013             oop protection_domain = this-&gt;protection_domain();
1014             Klass* klass = SystemDictionary::resolve_or_fail(symb,
1015                                                              Handle(THREAD, loader), Handle(THREAD, protection_domain), true,
1016                                                              CHECK_false);
1017             if (klass == NULL) {
1018               THROW_(vmSymbols::java_lang_LinkageError(), false);
1019             }
1020             if (!klass-&gt;is_inline_klass()) {
1021               Exceptions::fthrow(
1022                 THREAD_AND_LOCATION,
1023                 vmSymbols::java_lang_IncompatibleClassChangeError(),
1024                 &quot;class %s is not an inline type&quot;,
1025                 klass-&gt;external_name());
1026             }
1027           }
1028         }
1029       }
1030     }
1031   }
1032 
1033   // in case the class is linked in the process of linking its superclasses
1034   if (is_linked()) {
1035     return true;
1036   }
1037 
1038   // trace only the link time for this klass that includes
1039   // the verification time
1040   PerfClassTraceTime vmtimer(ClassLoader::perf_class_link_time(),
1041                              ClassLoader::perf_class_link_selftime(),
1042                              ClassLoader::perf_classes_linked(),
1043                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
1044                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
1045                              PerfClassTraceTime::CLASS_LINK);
1046 
1047   // verification &amp; rewriting
1048   {
1049     HandleMark hm(THREAD);
1050     Handle h_init_lock(THREAD, init_lock());
1051     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
1052     // rewritten will have been set if loader constraint error found
1053     // on an earlier link attempt
1054     // don&#39;t verify or rewrite if already rewritten
1055     //
1056 
1057     if (!is_linked()) {
1058       if (!is_rewritten()) {
1059         {
1060           bool verify_ok = verify_code(THREAD);
1061           if (!verify_ok) {
1062             return false;
1063           }
1064         }
1065 
1066         // Just in case a side-effect of verify linked this class already
1067         // (which can sometimes happen since the verifier loads classes
1068         // using custom class loaders, which are free to initialize things)
1069         if (is_linked()) {
1070           return true;
1071         }
1072 
1073         // also sets rewritten
1074         rewrite_class(CHECK_false);
1075       } else if (is_shared()) {
1076         SystemDictionaryShared::check_verification_constraints(this, CHECK_false);
1077       }
1078 
1079       // relocate jsrs and link methods after they are all rewritten
1080       link_methods(CHECK_false);
1081 
1082       // Initialize the vtable and interface table after
1083       // methods have been rewritten since rewrite may
1084       // fabricate new Method*s.
1085       // also does loader constraint checking
1086       //
1087       // initialize_vtable and initialize_itable need to be rerun
1088       // for a shared class if
1089       // 1) the class is loaded by custom class loader or
1090       // 2) the class is loaded by built-in class loader but failed to add archived loader constraints
1091       bool need_init_table = true;
1092       if (is_shared() &amp;&amp; SystemDictionaryShared::check_linking_constraints(this, THREAD)) {
1093         need_init_table = false;
1094       }
1095       if (need_init_table) {
1096         vtable().initialize_vtable(true, CHECK_false);
1097         itable().initialize_itable(true, CHECK_false);
1098       }
1099 #ifdef ASSERT
1100       vtable().verify(tty, true);
1101       // In case itable verification is ever added.
1102       // itable().verify(tty, true);
1103 #endif
1104 
1105       set_init_state(linked);
1106       if (JvmtiExport::should_post_class_prepare()) {
1107         Thread *thread = THREAD;
1108         assert(thread-&gt;is_Java_thread(), &quot;thread-&gt;is_Java_thread()&quot;);
1109         JvmtiExport::post_class_prepare((JavaThread *) thread, this);
1110       }
1111     }
1112   }
1113   return true;
1114 }
1115 
1116 // Rewrite the byte codes of all of the methods of a class.
1117 // The rewriter must be called exactly once. Rewriting must happen after
1118 // verification but before the first method of the class is executed.
1119 void InstanceKlass::rewrite_class(TRAPS) {
1120   assert(is_loaded(), &quot;must be loaded&quot;);
1121   if (is_rewritten()) {
1122     assert(is_shared(), &quot;rewriting an unshared class?&quot;);
1123     return;
1124   }
1125   Rewriter::rewrite(this, CHECK);
1126   set_rewritten();
1127 }
1128 
1129 // Now relocate and link method entry points after class is rewritten.
1130 // This is outside is_rewritten flag. In case of an exception, it can be
1131 // executed more than once.
1132 void InstanceKlass::link_methods(TRAPS) {
1133   int len = methods()-&gt;length();
1134   for (int i = len-1; i &gt;= 0; i--) {
1135     methodHandle m(THREAD, methods()-&gt;at(i));
1136 
1137     // Set up method entry points for compiler and interpreter    .
1138     m-&gt;link_method(m, CHECK);
1139   }
1140 }
1141 
1142 // Eagerly initialize superinterfaces that declare default methods (concrete instance: any access)
1143 void InstanceKlass::initialize_super_interfaces(TRAPS) {
1144   assert (has_nonstatic_concrete_methods(), &quot;caller should have checked this&quot;);
1145   for (int i = 0; i &lt; local_interfaces()-&gt;length(); ++i) {
1146     InstanceKlass* ik = local_interfaces()-&gt;at(i);
1147 
1148     // Initialization is depth first search ie. we start with top of the inheritance tree
1149     // has_nonstatic_concrete_methods drives searching superinterfaces since it
1150     // means has_nonstatic_concrete_methods in its superinterface hierarchy
1151     if (ik-&gt;has_nonstatic_concrete_methods()) {
1152       ik-&gt;initialize_super_interfaces(CHECK);
1153     }
1154 
1155     // Only initialize() interfaces that &quot;declare&quot; concrete methods.
1156     if (ik-&gt;should_be_initialized() &amp;&amp; ik-&gt;declares_nonstatic_concrete_methods()) {
1157       ik-&gt;initialize(CHECK);
1158     }
1159   }
1160 }
1161 
1162 void InstanceKlass::initialize_impl(TRAPS) {
1163   HandleMark hm(THREAD);
1164 
1165   // Make sure klass is linked (verified) before initialization
1166   // A class could already be verified, since it has been reflected upon.
1167   link_class(CHECK);
1168 
1169   DTRACE_CLASSINIT_PROBE(required, -1);
1170 
1171   bool wait = false;
1172 
1173   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in initialize_impl&quot;);
1174   JavaThread* jt = (JavaThread*)THREAD;
1175 
1176   // refer to the JVM book page 47 for description of steps
1177   // Step 1
1178   {
1179     Handle h_init_lock(THREAD, init_lock());
1180     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
1181 
1182     // Step 2
1183     // If we were to use wait() instead of waitInterruptibly() then
1184     // we might end up throwing IE from link/symbol resolution sites
1185     // that aren&#39;t expected to throw.  This would wreak havoc.  See 6320309.
1186     while (is_being_initialized() &amp;&amp; !is_reentrant_initialization(jt)) {
1187       wait = true;
1188       jt-&gt;set_class_to_be_initialized(this);
1189       ol.wait_uninterruptibly(jt);
1190       jt-&gt;set_class_to_be_initialized(NULL);
1191     }
1192 
1193     // Step 3
1194     if (is_being_initialized() &amp;&amp; is_reentrant_initialization(jt)) {
1195       DTRACE_CLASSINIT_PROBE_WAIT(recursive, -1, wait);
1196       return;
1197     }
1198 
1199     // Step 4
1200     if (is_initialized()) {
1201       DTRACE_CLASSINIT_PROBE_WAIT(concurrent, -1, wait);
1202       return;
1203     }
1204 
1205     // Step 5
1206     if (is_in_error_state()) {
1207       DTRACE_CLASSINIT_PROBE_WAIT(erroneous, -1, wait);
1208       ResourceMark rm(THREAD);
1209       const char* desc = &quot;Could not initialize class &quot;;
1210       const char* className = external_name();
1211       size_t msglen = strlen(desc) + strlen(className) + 1;
1212       char* message = NEW_RESOURCE_ARRAY(char, msglen);
1213       if (NULL == message) {
1214         // Out of memory: can&#39;t create detailed error message
1215           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);
1216       } else {
1217         jio_snprintf(message, msglen, &quot;%s%s&quot;, desc, className);
1218           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);
1219       }
1220     }
1221 
1222     // Step 6
1223     set_init_state(being_initialized);
1224     set_init_thread(jt);
1225   }
1226 
1227   // Step 7
1228   // Next, if C is a class rather than an interface, initialize it&#39;s super class and super
1229   // interfaces.
1230   if (!is_interface()) {
1231     Klass* super_klass = super();
1232     if (super_klass != NULL &amp;&amp; super_klass-&gt;should_be_initialized()) {
1233       super_klass-&gt;initialize(THREAD);
1234     }
1235     // If C implements any interface that declares a non-static, concrete method,
1236     // the initialization of C triggers initialization of its super interfaces.
1237     // Only need to recurse if has_nonstatic_concrete_methods which includes declaring and
1238     // having a superinterface that declares, non-static, concrete methods
1239     if (!HAS_PENDING_EXCEPTION &amp;&amp; has_nonstatic_concrete_methods()) {
1240       initialize_super_interfaces(THREAD);
1241     }
1242 
1243     // If any exceptions, complete abruptly, throwing the same exception as above.
1244     if (HAS_PENDING_EXCEPTION) {
1245       Handle e(THREAD, PENDING_EXCEPTION);
1246       CLEAR_PENDING_EXCEPTION;
1247       {
1248         EXCEPTION_MARK;
1249         // Locks object, set state, and notify all waiting threads
1250         set_initialization_state_and_notify(initialization_error, THREAD);
1251         CLEAR_PENDING_EXCEPTION;
1252       }
1253       DTRACE_CLASSINIT_PROBE_WAIT(super__failed, -1, wait);
1254       THROW_OOP(e());
1255     }
1256   }
1257 
1258   // Step 8
1259   // Initialize classes of inline fields
1260   {
1261     for (AllFieldStream fs(this); !fs.done(); fs.next()) {
1262       if (Signature::basic_type(fs.signature()) == T_INLINE_TYPE) {
1263         Klass* klass = get_inline_type_field_klass_or_null(fs.index());
1264         if (fs.access_flags().is_static() &amp;&amp; klass == NULL) {
1265           klass = SystemDictionary::resolve_or_fail(field_signature(fs.index())-&gt;fundamental_name(THREAD),
1266               Handle(THREAD, class_loader()),
1267               Handle(THREAD, protection_domain()),
1268               true, CHECK);
1269           if (klass == NULL) {
1270             THROW(vmSymbols::java_lang_NoClassDefFoundError());
1271           }
1272           if (!klass-&gt;is_inline_klass()) {
1273             THROW(vmSymbols::java_lang_IncompatibleClassChangeError());
1274           }
1275           set_inline_type_field_klass(fs.index(), klass);
1276         }
1277         InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1278         if (fs.access_flags().is_static()) {
1279           if (java_mirror()-&gt;obj_field(fs.offset()) == NULL) {
1280             java_mirror()-&gt;obj_field_put(fs.offset(), InlineKlass::cast(klass)-&gt;default_value());
1281           }
1282         }
1283       }
1284     }
1285   }
1286 
1287 
1288   // Look for aot compiled methods for this klass, including class initializer.
1289   AOTLoader::load_for_klass(this, THREAD);
1290 
1291   // Step 9
1292   {
1293     DTRACE_CLASSINIT_PROBE_WAIT(clinit, -1, wait);
1294     if (class_initializer() != NULL) {
1295       // Timer includes any side effects of class initialization (resolution,
1296       // etc), but not recursive entry into call_class_initializer().
1297       PerfClassTraceTime timer(ClassLoader::perf_class_init_time(),
1298                                ClassLoader::perf_class_init_selftime(),
1299                                ClassLoader::perf_classes_inited(),
1300                                jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
1301                                jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
1302                                PerfClassTraceTime::CLASS_CLINIT);
1303       call_class_initializer(THREAD);
1304     } else {
1305       // The elapsed time is so small it&#39;s not worth counting.
1306       if (UsePerfData) {
1307         ClassLoader::perf_classes_inited()-&gt;inc();
1308       }
1309       call_class_initializer(THREAD);
1310     }
1311   }
1312 
1313   // Step 10
1314   if (!HAS_PENDING_EXCEPTION) {
1315     set_initialization_state_and_notify(fully_initialized, CHECK);
1316     {
1317       debug_only(vtable().verify(tty, true);)
1318     }
1319   }
1320   else {
1321     // Step 11 and 12
1322     Handle e(THREAD, PENDING_EXCEPTION);
1323     CLEAR_PENDING_EXCEPTION;
1324     // JVMTI has already reported the pending exception
1325     // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1326     JvmtiExport::clear_detected_exception(jt);
1327     {
1328       EXCEPTION_MARK;
1329       set_initialization_state_and_notify(initialization_error, THREAD);
1330       CLEAR_PENDING_EXCEPTION;   // ignore any exception thrown, class initialization error is thrown below
1331       // JVMTI has already reported the pending exception
1332       // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1333       JvmtiExport::clear_detected_exception(jt);
1334     }
1335     DTRACE_CLASSINIT_PROBE_WAIT(error, -1, wait);
1336     if (e-&gt;is_a(SystemDictionary::Error_klass())) {
1337       THROW_OOP(e());
1338     } else {
1339       JavaCallArguments args(e);
1340       THROW_ARG(vmSymbols::java_lang_ExceptionInInitializerError(),
1341                 vmSymbols::throwable_void_signature(),
1342                 &amp;args);
1343     }
1344   }
1345   DTRACE_CLASSINIT_PROBE_WAIT(end, -1, wait);
1346 }
1347 
1348 
1349 void InstanceKlass::set_initialization_state_and_notify(ClassState state, TRAPS) {
1350   Handle h_init_lock(THREAD, init_lock());
1351   if (h_init_lock() != NULL) {
1352     ObjectLocker ol(h_init_lock, THREAD);
1353     set_init_thread(NULL); // reset _init_thread before changing _init_state
1354     set_init_state(state);
1355     fence_and_clear_init_lock();
1356     ol.notify_all(CHECK);
1357   } else {
1358     assert(h_init_lock() != NULL, &quot;The initialization state should never be set twice&quot;);
1359     set_init_thread(NULL); // reset _init_thread before changing _init_state
1360     set_init_state(state);
1361   }
1362 }
1363 
1364 Klass* InstanceKlass::implementor() const {
1365   Klass* volatile* k = adr_implementor();
1366   if (k == NULL) {
1367     return NULL;
1368   } else {
1369     // This load races with inserts, and therefore needs acquire.
1370     Klass* kls = Atomic::load_acquire(k);
1371     if (kls != NULL &amp;&amp; !kls-&gt;is_loader_alive()) {
1372       return NULL;  // don&#39;t return unloaded class
1373     } else {
1374       return kls;
1375     }
1376   }
1377 }
1378 
1379 
1380 void InstanceKlass::set_implementor(Klass* k) {
1381   assert_locked_or_safepoint(Compile_lock);
1382   assert(is_interface(), &quot;not interface&quot;);
1383   Klass* volatile* addr = adr_implementor();
1384   assert(addr != NULL, &quot;null addr&quot;);
1385   if (addr != NULL) {
1386     Atomic::release_store(addr, k);
1387   }
1388 }
1389 
1390 int  InstanceKlass::nof_implementors() const {
1391   Klass* k = implementor();
1392   if (k == NULL) {
1393     return 0;
1394   } else if (k != this) {
1395     return 1;
1396   } else {
1397     return 2;
1398   }
1399 }
1400 
1401 // The embedded _implementor field can only record one implementor.
1402 // When there are more than one implementors, the _implementor field
1403 // is set to the interface Klass* itself. Following are the possible
1404 // values for the _implementor field:
1405 //   NULL                  - no implementor
1406 //   implementor Klass*    - one implementor
1407 //   self                  - more than one implementor
1408 //
1409 // The _implementor field only exists for interfaces.
1410 void InstanceKlass::add_implementor(Klass* k) {
1411   if (Universe::is_fully_initialized()) {
1412     assert_lock_strong(Compile_lock);
1413   }
1414   assert(is_interface(), &quot;not interface&quot;);
1415   // Filter out my subinterfaces.
1416   // (Note: Interfaces are never on the subklass list.)
1417   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1418 
1419   // Filter out subclasses whose supers already implement me.
1420   // (Note: CHA must walk subclasses of direct implementors
1421   // in order to locate indirect implementors.)
1422   Klass* sk = k-&gt;super();
1423   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1424     // We only need to check one immediate superclass, since the
1425     // implements_interface query looks at transitive_interfaces.
1426     // Any supers of the super have the same (or fewer) transitive_interfaces.
1427     return;
1428 
1429   Klass* ik = implementor();
1430   if (ik == NULL) {
1431     set_implementor(k);
1432   } else if (ik != this &amp;&amp; ik != k) {
1433     // There is already an implementor. Use itself as an indicator of
1434     // more than one implementors.
1435     set_implementor(this);
1436   }
1437 
1438   // The implementor also implements the transitive_interfaces
1439   for (int index = 0; index &lt; local_interfaces()-&gt;length(); index++) {
1440     InstanceKlass::cast(local_interfaces()-&gt;at(index))-&gt;add_implementor(k);
1441   }
1442 }
1443 
1444 void InstanceKlass::init_implementor() {
1445   if (is_interface()) {
1446     set_implementor(NULL);
1447   }
1448 }
1449 
1450 
1451 void InstanceKlass::process_interfaces(Thread *thread) {
1452   // link this class into the implementors list of every interface it implements
1453   for (int i = local_interfaces()-&gt;length() - 1; i &gt;= 0; i--) {
1454     assert(local_interfaces()-&gt;at(i)-&gt;is_klass(), &quot;must be a klass&quot;);
1455     InstanceKlass* interf = InstanceKlass::cast(local_interfaces()-&gt;at(i));
1456     assert(interf-&gt;is_interface(), &quot;expected interface&quot;);
1457     interf-&gt;add_implementor(this);
1458   }
1459 }
1460 
1461 bool InstanceKlass::can_be_primary_super_slow() const {
1462   if (is_interface())
1463     return false;
1464   else
1465     return Klass::can_be_primary_super_slow();
1466 }
1467 
1468 GrowableArray&lt;Klass*&gt;* InstanceKlass::compute_secondary_supers(int num_extra_slots,
1469                                                                Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
1470   // The secondaries are the implemented interfaces.
1471   Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces;
1472   int num_secondaries = num_extra_slots + interfaces-&gt;length();
1473   if (num_secondaries == 0) {
1474     // Must share this for correct bootstrapping!
1475     set_secondary_supers(Universe::the_empty_klass_array());
1476     return NULL;
1477   } else if (num_extra_slots == 0) {
1478     // The secondary super list is exactly the same as the transitive interfaces, so
1479     // let&#39;s use it instead of making a copy.
1480     // Redefine classes has to be careful not to delete this!
1481     // We need the cast because Array&lt;Klass*&gt; is NOT a supertype of Array&lt;InstanceKlass*&gt;,
1482     // (but it&#39;s safe to do here because we won&#39;t write into _secondary_supers from this point on).
1483     set_secondary_supers((Array&lt;Klass*&gt;*)(address)interfaces);
1484     return NULL;
1485   } else {
1486     // Copy transitive interfaces to a temporary growable array to be constructed
1487     // into the secondary super list with extra slots.
1488     GrowableArray&lt;Klass*&gt;* secondaries = new GrowableArray&lt;Klass*&gt;(interfaces-&gt;length());
1489     for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
1490       secondaries-&gt;push(interfaces-&gt;at(i));
1491     }
1492     return secondaries;
1493   }
1494 }
1495 
1496 bool InstanceKlass::implements_interface(Klass* k) const {
1497   if (this == k) return true;
1498   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1499   for (int i = 0; i &lt; transitive_interfaces()-&gt;length(); i++) {
1500     if (transitive_interfaces()-&gt;at(i) == k) {
1501       return true;
1502     }
1503   }
1504   return false;
1505 }
1506 
1507 bool InstanceKlass::is_same_or_direct_interface(Klass *k) const {
1508   // Verify direct super interface
1509   if (this == k) return true;
1510   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1511   for (int i = 0; i &lt; local_interfaces()-&gt;length(); i++) {
1512     if (local_interfaces()-&gt;at(i) == k) {
1513       return true;
1514     }
1515   }
1516   return false;
1517 }
1518 
1519 objArrayOop InstanceKlass::allocate_objArray(int n, int length, TRAPS) {
1520   check_array_allocation_length(length, arrayOopDesc::max_array_length(T_OBJECT), CHECK_NULL);
1521   int size = objArrayOopDesc::object_size(length);
1522   Klass* ak = array_klass(n, CHECK_NULL);
1523   objArrayOop o = (objArrayOop)Universe::heap()-&gt;array_allocate(ak, size, length,
1524                                                                 /* do_zero */ true, CHECK_NULL);
1525   return o;
1526 }
1527 
1528 instanceOop InstanceKlass::register_finalizer(instanceOop i, TRAPS) {
1529   if (TraceFinalizerRegistration) {
1530     tty-&gt;print(&quot;Registered &quot;);
1531     i-&gt;print_value_on(tty);
1532     tty-&gt;print_cr(&quot; (&quot; INTPTR_FORMAT &quot;) as finalizable&quot;, p2i(i));
1533   }
1534   instanceHandle h_i(THREAD, i);
1535   // Pass the handle as argument, JavaCalls::call expects oop as jobjects
1536   JavaValue result(T_VOID);
1537   JavaCallArguments args(h_i);
1538   methodHandle mh (THREAD, Universe::finalizer_register_method());
1539   JavaCalls::call(&amp;result, mh, &amp;args, CHECK_NULL);
1540   return h_i();
1541 }
1542 
1543 instanceOop InstanceKlass::allocate_instance(TRAPS) {
1544   bool has_finalizer_flag = has_finalizer(); // Query before possible GC
1545   int size = size_helper();  // Query before forming handle.
1546 
1547   instanceOop i;
1548 
1549   i = (instanceOop)Universe::heap()-&gt;obj_allocate(this, size, CHECK_NULL);
1550   if (has_finalizer_flag &amp;&amp; !RegisterFinalizersAtInit) {
1551     i = register_finalizer(i, CHECK_NULL);
1552   }
1553   return i;
1554 }
1555 
1556 instanceHandle InstanceKlass::allocate_instance_handle(TRAPS) {
1557   return instanceHandle(THREAD, allocate_instance(THREAD));
1558 }
1559 
1560 void InstanceKlass::check_valid_for_instantiation(bool throwError, TRAPS) {
1561   if (is_interface() || is_abstract()) {
1562     ResourceMark rm(THREAD);
1563     THROW_MSG(throwError ? vmSymbols::java_lang_InstantiationError()
1564               : vmSymbols::java_lang_InstantiationException(), external_name());
1565   }
1566   if (this == SystemDictionary::Class_klass()) {
1567     ResourceMark rm(THREAD);
1568     THROW_MSG(throwError ? vmSymbols::java_lang_IllegalAccessError()
1569               : vmSymbols::java_lang_IllegalAccessException(), external_name());
1570   }
1571 }
1572 
1573 Klass* InstanceKlass::array_klass_impl(bool or_null, int n, TRAPS) {
1574   // Need load-acquire for lock-free read
1575   if (array_klasses_acquire() == NULL) {
1576     if (or_null) return NULL;
1577 
1578     ResourceMark rm(THREAD);
1579     JavaThread *jt = (JavaThread *)THREAD;
1580     {
1581       // Atomic creation of array_klasses
1582       MutexLocker ma(THREAD, MultiArray_lock);
1583 
1584       // Check if update has already taken place
1585       if (array_klasses() == NULL) {
1586         ObjArrayKlass* k = ObjArrayKlass::allocate_objArray_klass(class_loader_data(), 1, this, CHECK_NULL);
1587         // use &#39;release&#39; to pair with lock-free load
1588         release_set_array_klasses(k);
1589       }
1590     }
1591   }
1592   // _this will always be set at this point
1593   ObjArrayKlass* oak = array_klasses();
1594   if (or_null) {
1595     return oak-&gt;array_klass_or_null(n);
1596   }
1597   return oak-&gt;array_klass(n, THREAD);
1598 }
1599 
1600 Klass* InstanceKlass::array_klass_impl(bool or_null, TRAPS) {
1601   return array_klass_impl(or_null, 1, THREAD);
1602 }
1603 
1604 static int call_class_initializer_counter = 0;   // for debugging
1605 
1606 Method* InstanceKlass::class_initializer() const {
1607   Method* clinit = find_method(
1608       vmSymbols::class_initializer_name(), vmSymbols::void_method_signature());
1609   if (clinit != NULL &amp;&amp; clinit-&gt;is_class_initializer()) {
1610     return clinit;
1611   }
1612   return NULL;
1613 }
1614 
1615 void InstanceKlass::call_class_initializer(TRAPS) {
1616   if (ReplayCompiles &amp;&amp;
1617       (ReplaySuppressInitializers == 1 ||
1618        (ReplaySuppressInitializers &gt;= 2 &amp;&amp; class_loader() != NULL))) {
1619     // Hide the existence of the initializer for the purpose of replaying the compile
1620     return;
1621   }
1622 
1623   methodHandle h_method(THREAD, class_initializer());
1624   assert(!is_initialized(), &quot;we cannot initialize twice&quot;);
1625   LogTarget(Info, class, init) lt;
1626   if (lt.is_enabled()) {
1627     ResourceMark rm(THREAD);
1628     LogStream ls(lt);
1629     ls.print(&quot;%d Initializing &quot;, call_class_initializer_counter++);
1630     name()-&gt;print_value_on(&amp;ls);
1631     ls.print_cr(&quot;%s (&quot; INTPTR_FORMAT &quot;)&quot;, h_method() == NULL ? &quot;(no method)&quot; : &quot;&quot;, p2i(this));
1632   }
1633   if (h_method() != NULL) {
1634     JavaCallArguments args; // No arguments
1635     JavaValue result(T_VOID);
1636     JavaCalls::call(&amp;result, h_method, &amp;args, CHECK); // Static call (no args)
1637   }
1638 }
1639 
1640 
1641 void InstanceKlass::mask_for(const methodHandle&amp; method, int bci,
1642   InterpreterOopMap* entry_for) {
1643   // Lazily create the _oop_map_cache at first request
1644   // Lock-free access requires load_acquire.
1645   OopMapCache* oop_map_cache = Atomic::load_acquire(&amp;_oop_map_cache);
1646   if (oop_map_cache == NULL) {
1647     MutexLocker x(OopMapCacheAlloc_lock,  Mutex::_no_safepoint_check_flag);
1648     // Check if _oop_map_cache was allocated while we were waiting for this lock
1649     if ((oop_map_cache = _oop_map_cache) == NULL) {
1650       oop_map_cache = new OopMapCache();
1651       // Ensure _oop_map_cache is stable, since it is examined without a lock
1652       Atomic::release_store(&amp;_oop_map_cache, oop_map_cache);
1653     }
1654   }
1655   // _oop_map_cache is constant after init; lookup below does its own locking.
1656   oop_map_cache-&gt;lookup(method, bci, entry_for);
1657 }
1658 
1659 bool InstanceKlass::find_local_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1660   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1661     Symbol* f_name = fs.name();
1662     Symbol* f_sig  = fs.signature();
1663     if (f_name == name &amp;&amp; f_sig == sig) {
1664       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1665       return true;
1666     }
1667   }
1668   return false;
1669 }
1670 
1671 
1672 Klass* InstanceKlass::find_interface_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1673   const int n = local_interfaces()-&gt;length();
1674   for (int i = 0; i &lt; n; i++) {
1675     Klass* intf1 = local_interfaces()-&gt;at(i);
1676     assert(intf1-&gt;is_interface(), &quot;just checking type&quot;);
1677     // search for field in current interface
1678     if (InstanceKlass::cast(intf1)-&gt;find_local_field(name, sig, fd)) {
1679       assert(fd-&gt;is_static(), &quot;interface field must be static&quot;);
1680       return intf1;
1681     }
1682     // search for field in direct superinterfaces
1683     Klass* intf2 = InstanceKlass::cast(intf1)-&gt;find_interface_field(name, sig, fd);
1684     if (intf2 != NULL) return intf2;
1685   }
1686   // otherwise field lookup fails
1687   return NULL;
1688 }
1689 
1690 
1691 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1692   // search order according to newest JVM spec (5.4.3.2, p.167).
1693   // 1) search for field in current klass
1694   if (find_local_field(name, sig, fd)) {
1695     return const_cast&lt;InstanceKlass*&gt;(this);
1696   }
1697   // 2) search for field recursively in direct superinterfaces
1698   { Klass* intf = find_interface_field(name, sig, fd);
1699     if (intf != NULL) return intf;
1700   }
1701   // 3) apply field lookup recursively if superclass exists
1702   { Klass* supr = super();
1703     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, fd);
1704   }
1705   // 4) otherwise field lookup fails
1706   return NULL;
1707 }
1708 
1709 
1710 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, bool is_static, fieldDescriptor* fd) const {
1711   // search order according to newest JVM spec (5.4.3.2, p.167).
1712   // 1) search for field in current klass
1713   if (find_local_field(name, sig, fd)) {
1714     if (fd-&gt;is_static() == is_static) return const_cast&lt;InstanceKlass*&gt;(this);
1715   }
1716   // 2) search for field recursively in direct superinterfaces
1717   if (is_static) {
1718     Klass* intf = find_interface_field(name, sig, fd);
1719     if (intf != NULL) return intf;
1720   }
1721   // 3) apply field lookup recursively if superclass exists
1722   { Klass* supr = super();
1723     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, is_static, fd);
1724   }
1725   // 4) otherwise field lookup fails
1726   return NULL;
1727 }
1728 
1729 bool InstanceKlass::contains_field_offset(int offset) {
1730   if (this-&gt;is_inline_klass()) {
1731     InlineKlass* vk = InlineKlass::cast(this);
1732     return offset &gt;= vk-&gt;first_field_offset() &amp;&amp; offset &lt; (vk-&gt;first_field_offset() + vk-&gt;get_exact_size_in_bytes());
1733   } else {
1734     fieldDescriptor fd;
1735     return find_field_from_offset(offset, false, &amp;fd);
1736   }
1737 }
1738 
1739 bool InstanceKlass::find_local_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1740   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1741     if (fs.offset() == offset) {
1742       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1743       if (fd-&gt;is_static() == is_static) return true;
1744     }
1745   }
1746   return false;
1747 }
1748 
1749 
1750 bool InstanceKlass::find_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1751   Klass* klass = const_cast&lt;InstanceKlass*&gt;(this);
1752   while (klass != NULL) {
1753     if (InstanceKlass::cast(klass)-&gt;find_local_field_from_offset(offset, is_static, fd)) {
1754       return true;
1755     }
1756     klass = klass-&gt;super();
1757   }
1758   return false;
1759 }
1760 
1761 
1762 void InstanceKlass::methods_do(void f(Method* method)) {
1763   // Methods aren&#39;t stable until they are loaded.  This can be read outside
1764   // a lock through the ClassLoaderData for profiling
1765   if (!is_loaded()) {
1766     return;
1767   }
1768 
1769   int len = methods()-&gt;length();
1770   for (int index = 0; index &lt; len; index++) {
1771     Method* m = methods()-&gt;at(index);
1772     assert(m-&gt;is_method(), &quot;must be method&quot;);
1773     f(m);
1774   }
1775 }
1776 
1777 
1778 void InstanceKlass::do_local_static_fields(FieldClosure* cl) {
1779   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1780     if (fs.access_flags().is_static()) {
1781       fieldDescriptor&amp; fd = fs.field_descriptor();
1782       cl-&gt;do_field(&amp;fd);
1783     }
1784   }
1785 }
1786 
1787 
1788 void InstanceKlass::do_local_static_fields(void f(fieldDescriptor*, Handle, TRAPS), Handle mirror, TRAPS) {
1789   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1790     if (fs.access_flags().is_static()) {
1791       fieldDescriptor&amp; fd = fs.field_descriptor();
1792       f(&amp;fd, mirror, CHECK);
1793     }
1794   }
1795 }
1796 
1797 
1798 static int compare_fields_by_offset(int* a, int* b) {
1799   return a[0] - b[0];
1800 }
1801 
1802 void InstanceKlass::do_nonstatic_fields(FieldClosure* cl) {
1803   InstanceKlass* super = superklass();
1804   if (super != NULL) {
1805     super-&gt;do_nonstatic_fields(cl);
1806   }
1807   fieldDescriptor fd;
1808   int length = java_fields_count();
1809   // In DebugInfo nonstatic fields are sorted by offset.
1810   int* fields_sorted = NEW_C_HEAP_ARRAY(int, 2*(length+1), mtClass);
1811   int j = 0;
1812   for (int i = 0; i &lt; length; i += 1) {
1813     fd.reinitialize(this, i);
1814     if (!fd.is_static()) {
1815       fields_sorted[j + 0] = fd.offset();
1816       fields_sorted[j + 1] = i;
1817       j += 2;
1818     }
1819   }
1820   if (j &gt; 0) {
1821     length = j;
1822     // _sort_Fn is defined in growableArray.hpp.
1823     qsort(fields_sorted, length/2, 2*sizeof(int), (_sort_Fn)compare_fields_by_offset);
1824     for (int i = 0; i &lt; length; i += 2) {
1825       fd.reinitialize(this, fields_sorted[i + 1]);
1826       assert(!fd.is_static() &amp;&amp; fd.offset() == fields_sorted[i], &quot;only nonstatic fields&quot;);
1827       cl-&gt;do_field(&amp;fd);
1828     }
1829   }
1830   FREE_C_HEAP_ARRAY(int, fields_sorted);
1831 }
1832 
1833 
1834 void InstanceKlass::array_klasses_do(void f(Klass* k, TRAPS), TRAPS) {
1835   if (array_klasses() != NULL)
1836     array_klasses()-&gt;array_klasses_do(f, THREAD);
1837 }
1838 
1839 void InstanceKlass::array_klasses_do(void f(Klass* k)) {
1840   if (array_klasses() != NULL)
1841     array_klasses()-&gt;array_klasses_do(f);
1842 }
1843 
1844 #ifdef ASSERT
1845 static int linear_search(const Array&lt;Method*&gt;* methods,
1846                          const Symbol* name,
1847                          const Symbol* signature) {
1848   const int len = methods-&gt;length();
1849   for (int index = 0; index &lt; len; index++) {
1850     const Method* const m = methods-&gt;at(index);
1851     assert(m-&gt;is_method(), &quot;must be method&quot;);
1852     if (m-&gt;signature() == signature &amp;&amp; m-&gt;name() == name) {
1853        return index;
1854     }
1855   }
1856   return -1;
1857 }
1858 #endif
1859 
1860 bool InstanceKlass::_disable_method_binary_search = false;
1861 
1862 NOINLINE int linear_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1863   int len = methods-&gt;length();
1864   int l = 0;
1865   int h = len - 1;
1866   while (l &lt;= h) {
1867     Method* m = methods-&gt;at(l);
1868     if (m-&gt;name() == name) {
1869       return l;
1870     }
1871     l++;
1872   }
1873   return -1;
1874 }
1875 
1876 inline int InstanceKlass::quick_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1877   if (_disable_method_binary_search) {
1878     assert(DynamicDumpSharedSpaces, &quot;must be&quot;);
1879     // At the final stage of dynamic dumping, the methods array may not be sorted
1880     // by ascending addresses of their names, so we can&#39;t use binary search anymore.
1881     // However, methods with the same name are still laid out consecutively inside the
1882     // methods array, so let&#39;s look for the first one that matches.
1883     return linear_search(methods, name);
1884   }
1885 
1886   int len = methods-&gt;length();
1887   int l = 0;
1888   int h = len - 1;
1889 
1890   // methods are sorted by ascending addresses of their names, so do binary search
1891   while (l &lt;= h) {
1892     int mid = (l + h) &gt;&gt; 1;
1893     Method* m = methods-&gt;at(mid);
1894     assert(m-&gt;is_method(), &quot;must be method&quot;);
1895     int res = m-&gt;name()-&gt;fast_compare(name);
1896     if (res == 0) {
1897       return mid;
1898     } else if (res &lt; 0) {
1899       l = mid + 1;
1900     } else {
1901       h = mid - 1;
1902     }
1903   }
1904   return -1;
1905 }
1906 
1907 // find_method looks up the name/signature in the local methods array
1908 Method* InstanceKlass::find_method(const Symbol* name,
1909                                    const Symbol* signature) const {
1910   return find_method_impl(name, signature, find_overpass, find_static, find_private);
1911 }
1912 
1913 Method* InstanceKlass::find_method_impl(const Symbol* name,
1914                                         const Symbol* signature,
1915                                         OverpassLookupMode overpass_mode,
1916                                         StaticLookupMode static_mode,
1917                                         PrivateLookupMode private_mode) const {
1918   return InstanceKlass::find_method_impl(methods(),
1919                                          name,
1920                                          signature,
1921                                          overpass_mode,
1922                                          static_mode,
1923                                          private_mode);
1924 }
1925 
1926 // find_instance_method looks up the name/signature in the local methods array
1927 // and skips over static methods
1928 Method* InstanceKlass::find_instance_method(const Array&lt;Method*&gt;* methods,
1929                                             const Symbol* name,
1930                                             const Symbol* signature,
1931                                             PrivateLookupMode private_mode) {
1932   Method* const meth = InstanceKlass::find_method_impl(methods,
1933                                                  name,
1934                                                  signature,
1935                                                  find_overpass,
1936                                                  skip_static,
1937                                                  private_mode);
1938   assert(((meth == NULL) || !meth-&gt;is_static()),
1939     &quot;find_instance_method should have skipped statics&quot;);
1940   return meth;
1941 }
1942 
1943 // find_instance_method looks up the name/signature in the local methods array
1944 // and skips over static methods
1945 Method* InstanceKlass::find_instance_method(const Symbol* name,
1946                                             const Symbol* signature,
1947                                             PrivateLookupMode private_mode) const {
1948   return InstanceKlass::find_instance_method(methods(), name, signature, private_mode);
1949 }
1950 
1951 // Find looks up the name/signature in the local methods array
1952 // and filters on the overpass, static and private flags
1953 // This returns the first one found
1954 // note that the local methods array can have up to one overpass, one static
1955 // and one instance (private or not) with the same name/signature
1956 Method* InstanceKlass::find_local_method(const Symbol* name,
1957                                          const Symbol* signature,
1958                                          OverpassLookupMode overpass_mode,
1959                                          StaticLookupMode static_mode,
1960                                          PrivateLookupMode private_mode) const {
1961   return InstanceKlass::find_method_impl(methods(),
1962                                          name,
1963                                          signature,
1964                                          overpass_mode,
1965                                          static_mode,
1966                                          private_mode);
1967 }
1968 
1969 // Find looks up the name/signature in the local methods array
1970 // and filters on the overpass, static and private flags
1971 // This returns the first one found
1972 // note that the local methods array can have up to one overpass, one static
1973 // and one instance (private or not) with the same name/signature
1974 Method* InstanceKlass::find_local_method(const Array&lt;Method*&gt;* methods,
1975                                          const Symbol* name,
1976                                          const Symbol* signature,
1977                                          OverpassLookupMode overpass_mode,
1978                                          StaticLookupMode static_mode,
1979                                          PrivateLookupMode private_mode) {
1980   return InstanceKlass::find_method_impl(methods,
1981                                          name,
1982                                          signature,
1983                                          overpass_mode,
1984                                          static_mode,
1985                                          private_mode);
1986 }
1987 
1988 Method* InstanceKlass::find_method(const Array&lt;Method*&gt;* methods,
1989                                    const Symbol* name,
1990                                    const Symbol* signature) {
1991   return InstanceKlass::find_method_impl(methods,
1992                                          name,
1993                                          signature,
1994                                          find_overpass,
1995                                          find_static,
1996                                          find_private);
1997 }
1998 
1999 Method* InstanceKlass::find_method_impl(const Array&lt;Method*&gt;* methods,
2000                                         const Symbol* name,
2001                                         const Symbol* signature,
2002                                         OverpassLookupMode overpass_mode,
2003                                         StaticLookupMode static_mode,
2004                                         PrivateLookupMode private_mode) {
2005   int hit = find_method_index(methods, name, signature, overpass_mode, static_mode, private_mode);
2006   return hit &gt;= 0 ? methods-&gt;at(hit): NULL;
2007 }
2008 
2009 // true if method matches signature and conforms to skipping_X conditions.
2010 static bool method_matches(const Method* m,
2011                            const Symbol* signature,
2012                            bool skipping_overpass,
2013                            bool skipping_static,
2014                            bool skipping_private) {
2015   return ((m-&gt;signature() == signature) &amp;&amp;
2016     (!skipping_overpass || !m-&gt;is_overpass()) &amp;&amp;
2017     (!skipping_static || !m-&gt;is_static()) &amp;&amp;
2018     (!skipping_private || !m-&gt;is_private()));
2019 }
2020 
2021 // Used directly for default_methods to find the index into the
2022 // default_vtable_indices, and indirectly by find_method
2023 // find_method_index looks in the local methods array to return the index
2024 // of the matching name/signature. If, overpass methods are being ignored,
2025 // the search continues to find a potential non-overpass match.  This capability
2026 // is important during method resolution to prefer a static method, for example,
2027 // over an overpass method.
2028 // There is the possibility in any _method&#39;s array to have the same name/signature
2029 // for a static method, an overpass method and a local instance method
2030 // To correctly catch a given method, the search criteria may need
2031 // to explicitly skip the other two. For local instance methods, it
2032 // is often necessary to skip private methods
2033 int InstanceKlass::find_method_index(const Array&lt;Method*&gt;* methods,
2034                                      const Symbol* name,
2035                                      const Symbol* signature,
2036                                      OverpassLookupMode overpass_mode,
2037                                      StaticLookupMode static_mode,
2038                                      PrivateLookupMode private_mode) {
2039   const bool skipping_overpass = (overpass_mode == skip_overpass);
2040   const bool skipping_static = (static_mode == skip_static);
2041   const bool skipping_private = (private_mode == skip_private);
2042   const int hit = quick_search(methods, name);
2043   if (hit != -1) {
2044     const Method* const m = methods-&gt;at(hit);
2045 
2046     // Do linear search to find matching signature.  First, quick check
2047     // for common case, ignoring overpasses if requested.
2048     if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
2049       return hit;
2050     }
2051 
2052     // search downwards through overloaded methods
2053     int i;
2054     for (i = hit - 1; i &gt;= 0; --i) {
2055         const Method* const m = methods-&gt;at(i);
2056         assert(m-&gt;is_method(), &quot;must be method&quot;);
2057         if (m-&gt;name() != name) {
2058           break;
2059         }
2060         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
2061           return i;
2062         }
2063     }
2064     // search upwards
2065     for (i = hit + 1; i &lt; methods-&gt;length(); ++i) {
2066         const Method* const m = methods-&gt;at(i);
2067         assert(m-&gt;is_method(), &quot;must be method&quot;);
2068         if (m-&gt;name() != name) {
2069           break;
2070         }
2071         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
2072           return i;
2073         }
2074     }
2075     // not found
2076 #ifdef ASSERT
2077     const int index = (skipping_overpass || skipping_static || skipping_private) ? -1 :
2078       linear_search(methods, name, signature);
2079     assert(-1 == index, &quot;binary search should have found entry %d&quot;, index);
2080 #endif
2081   }
2082   return -1;
2083 }
2084 
2085 int InstanceKlass::find_method_by_name(const Symbol* name, int* end) const {
2086   return find_method_by_name(methods(), name, end);
2087 }
2088 
2089 int InstanceKlass::find_method_by_name(const Array&lt;Method*&gt;* methods,
2090                                        const Symbol* name,
2091                                        int* end_ptr) {
2092   assert(end_ptr != NULL, &quot;just checking&quot;);
2093   int start = quick_search(methods, name);
2094   int end = start + 1;
2095   if (start != -1) {
2096     while (start - 1 &gt;= 0 &amp;&amp; (methods-&gt;at(start - 1))-&gt;name() == name) --start;
2097     while (end &lt; methods-&gt;length() &amp;&amp; (methods-&gt;at(end))-&gt;name() == name) ++end;
2098     *end_ptr = end;
2099     return start;
2100   }
2101   return -1;
2102 }
2103 
2104 // uncached_lookup_method searches both the local class methods array and all
2105 // superclasses methods arrays, skipping any overpass methods in superclasses,
2106 // and possibly skipping private methods.
2107 Method* InstanceKlass::uncached_lookup_method(const Symbol* name,
2108                                               const Symbol* signature,
2109                                               OverpassLookupMode overpass_mode,
2110                                               PrivateLookupMode private_mode) const {
2111   OverpassLookupMode overpass_local_mode = overpass_mode;
2112   const Klass* klass = this;
2113   while (klass != NULL) {
2114     Method* const method = InstanceKlass::cast(klass)-&gt;find_method_impl(name,
2115                                                                         signature,
2116                                                                         overpass_local_mode,
2117                                                                         find_static,
2118                                                                         private_mode);
2119     if (method != NULL) {
2120       return method;
2121     }
2122     if (name == vmSymbols::object_initializer_name()) {
2123       break;  // &lt;init&gt; is never inherited, not even as a static factory
2124     }
2125     klass = klass-&gt;super();
2126     overpass_local_mode = skip_overpass;   // Always ignore overpass methods in superclasses
2127   }
2128   return NULL;
2129 }
2130 
2131 #ifdef ASSERT
2132 // search through class hierarchy and return true if this class or
2133 // one of the superclasses was redefined
2134 bool InstanceKlass::has_redefined_this_or_super() const {
2135   const Klass* klass = this;
2136   while (klass != NULL) {
2137     if (InstanceKlass::cast(klass)-&gt;has_been_redefined()) {
2138       return true;
2139     }
2140     klass = klass-&gt;super();
2141   }
2142   return false;
2143 }
2144 #endif
2145 
2146 // lookup a method in the default methods list then in all transitive interfaces
2147 // Do NOT return private or static methods
2148 Method* InstanceKlass::lookup_method_in_ordered_interfaces(Symbol* name,
2149                                                          Symbol* signature) const {
2150   Method* m = NULL;
2151   if (default_methods() != NULL) {
2152     m = find_method(default_methods(), name, signature);
2153   }
2154   // Look up interfaces
2155   if (m == NULL) {
2156     m = lookup_method_in_all_interfaces(name, signature, find_defaults);
2157   }
2158   return m;
2159 }
2160 
2161 // lookup a method in all the interfaces that this class implements
2162 // Do NOT return private or static methods, new in JDK8 which are not externally visible
2163 // They should only be found in the initial InterfaceMethodRef
2164 Method* InstanceKlass::lookup_method_in_all_interfaces(Symbol* name,
2165                                                        Symbol* signature,
2166                                                        DefaultsLookupMode defaults_mode) const {
2167   Array&lt;InstanceKlass*&gt;* all_ifs = transitive_interfaces();
2168   int num_ifs = all_ifs-&gt;length();
2169   InstanceKlass *ik = NULL;
2170   for (int i = 0; i &lt; num_ifs; i++) {
2171     ik = all_ifs-&gt;at(i);
2172     Method* m = ik-&gt;lookup_method(name, signature);
2173     if (m != NULL &amp;&amp; m-&gt;is_public() &amp;&amp; !m-&gt;is_static() &amp;&amp;
2174         ((defaults_mode != skip_defaults) || !m-&gt;is_default_method())) {
2175       return m;
2176     }
2177   }
2178   return NULL;
2179 }
2180 
2181 /* jni_id_for_impl for jfieldIds only */
2182 JNIid* InstanceKlass::jni_id_for_impl(int offset) {
2183   MutexLocker ml(JfieldIdCreation_lock);
2184   // Retry lookup after we got the lock
2185   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
2186   if (probe == NULL) {
2187     // Slow case, allocate new static field identifier
2188     probe = new JNIid(this, offset, jni_ids());
2189     set_jni_ids(probe);
2190   }
2191   return probe;
2192 }
2193 
2194 
2195 /* jni_id_for for jfieldIds only */
2196 JNIid* InstanceKlass::jni_id_for(int offset) {
2197   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
2198   if (probe == NULL) {
2199     probe = jni_id_for_impl(offset);
2200   }
2201   return probe;
2202 }
2203 
2204 u2 InstanceKlass::enclosing_method_data(int offset) const {
2205   const Array&lt;jushort&gt;* const inner_class_list = inner_classes();
2206   if (inner_class_list == NULL) {
2207     return 0;
2208   }
2209   const int length = inner_class_list-&gt;length();
2210   if (length % inner_class_next_offset == 0) {
2211     return 0;
2212   }
2213   const int index = length - enclosing_method_attribute_size;
2214   assert(offset &lt; enclosing_method_attribute_size, &quot;invalid offset&quot;);
2215   return inner_class_list-&gt;at(index + offset);
2216 }
2217 
2218 void InstanceKlass::set_enclosing_method_indices(u2 class_index,
2219                                                  u2 method_index) {
2220   Array&lt;jushort&gt;* inner_class_list = inner_classes();
2221   assert (inner_class_list != NULL, &quot;_inner_classes list is not set up&quot;);
2222   int length = inner_class_list-&gt;length();
2223   if (length % inner_class_next_offset == enclosing_method_attribute_size) {
2224     int index = length - enclosing_method_attribute_size;
2225     inner_class_list-&gt;at_put(
2226       index + enclosing_method_class_index_offset, class_index);
2227     inner_class_list-&gt;at_put(
2228       index + enclosing_method_method_index_offset, method_index);
2229   }
2230 }
2231 
2232 // Lookup or create a jmethodID.
2233 // This code is called by the VMThread and JavaThreads so the
2234 // locking has to be done very carefully to avoid deadlocks
2235 // and/or other cache consistency problems.
2236 //
2237 jmethodID InstanceKlass::get_jmethod_id(const methodHandle&amp; method_h) {
2238   size_t idnum = (size_t)method_h-&gt;method_idnum();
2239   jmethodID* jmeths = methods_jmethod_ids_acquire();
2240   size_t length = 0;
2241   jmethodID id = NULL;
2242 
2243   // We use a double-check locking idiom here because this cache is
2244   // performance sensitive. In the normal system, this cache only
2245   // transitions from NULL to non-NULL which is safe because we use
2246   // release_set_methods_jmethod_ids() to advertise the new cache.
2247   // A partially constructed cache should never be seen by a racing
2248   // thread. We also use release_store() to save a new jmethodID
2249   // in the cache so a partially constructed jmethodID should never be
2250   // seen either. Cache reads of existing jmethodIDs proceed without a
2251   // lock, but cache writes of a new jmethodID requires uniqueness and
2252   // creation of the cache itself requires no leaks so a lock is
2253   // generally acquired in those two cases.
2254   //
2255   // If the RedefineClasses() API has been used, then this cache can
2256   // grow and we&#39;ll have transitions from non-NULL to bigger non-NULL.
2257   // Cache creation requires no leaks and we require safety between all
2258   // cache accesses and freeing of the old cache so a lock is generally
2259   // acquired when the RedefineClasses() API has been used.
2260 
2261   if (jmeths != NULL) {
2262     // the cache already exists
2263     if (!idnum_can_increment()) {
2264       // the cache can&#39;t grow so we can just get the current values
2265       get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2266     } else {
2267       // cache can grow so we have to be more careful
2268       if (Threads::number_of_threads() == 0 ||
2269           SafepointSynchronize::is_at_safepoint()) {
2270         // we&#39;re single threaded or at a safepoint - no locking needed
2271         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2272       } else {
2273         MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2274         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2275       }
2276     }
2277   }
2278   // implied else:
2279   // we need to allocate a cache so default length and id values are good
2280 
2281   if (jmeths == NULL ||   // no cache yet
2282       length &lt;= idnum ||  // cache is too short
2283       id == NULL) {       // cache doesn&#39;t contain entry
2284 
2285     // This function can be called by the VMThread so we have to do all
2286     // things that might block on a safepoint before grabbing the lock.
2287     // Otherwise, we can deadlock with the VMThread or have a cache
2288     // consistency issue. These vars keep track of what we might have
2289     // to free after the lock is dropped.
2290     jmethodID  to_dealloc_id     = NULL;
2291     jmethodID* to_dealloc_jmeths = NULL;
2292 
2293     // may not allocate new_jmeths or use it if we allocate it
2294     jmethodID* new_jmeths = NULL;
2295     if (length &lt;= idnum) {
2296       // allocate a new cache that might be used
2297       size_t size = MAX2(idnum+1, (size_t)idnum_allocated_count());
2298       new_jmeths = NEW_C_HEAP_ARRAY(jmethodID, size+1, mtClass);
2299       memset(new_jmeths, 0, (size+1)*sizeof(jmethodID));
2300       // cache size is stored in element[0], other elements offset by one
2301       new_jmeths[0] = (jmethodID)size;
2302     }
2303 
2304     // allocate a new jmethodID that might be used
2305     jmethodID new_id = NULL;
2306     if (method_h-&gt;is_old() &amp;&amp; !method_h-&gt;is_obsolete()) {
2307       // The method passed in is old (but not obsolete), we need to use the current version
2308       Method* current_method = method_with_idnum((int)idnum);
2309       assert(current_method != NULL, &quot;old and but not obsolete, so should exist&quot;);
2310       new_id = Method::make_jmethod_id(class_loader_data(), current_method);
2311     } else {
2312       // It is the current version of the method or an obsolete method,
2313       // use the version passed in
2314       new_id = Method::make_jmethod_id(class_loader_data(), method_h());
2315     }
2316 
2317     if (Threads::number_of_threads() == 0 ||
2318         SafepointSynchronize::is_at_safepoint()) {
2319       // we&#39;re single threaded or at a safepoint - no locking needed
2320       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2321                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2322     } else {
2323       MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2324       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2325                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2326     }
2327 
2328     // The lock has been dropped so we can free resources.
2329     // Free up either the old cache or the new cache if we allocated one.
2330     if (to_dealloc_jmeths != NULL) {
2331       FreeHeap(to_dealloc_jmeths);
2332     }
2333     // free up the new ID since it wasn&#39;t needed
2334     if (to_dealloc_id != NULL) {
2335       Method::destroy_jmethod_id(class_loader_data(), to_dealloc_id);
2336     }
2337   }
2338   return id;
2339 }
2340 
2341 // Figure out how many jmethodIDs haven&#39;t been allocated, and make
2342 // sure space for them is pre-allocated.  This makes getting all
2343 // method ids much, much faster with classes with more than 8
2344 // methods, and has a *substantial* effect on performance with jvmti
2345 // code that loads all jmethodIDs for all classes.
2346 void InstanceKlass::ensure_space_for_methodids(int start_offset) {
2347   int new_jmeths = 0;
2348   int length = methods()-&gt;length();
2349   for (int index = start_offset; index &lt; length; index++) {
2350     Method* m = methods()-&gt;at(index);
2351     jmethodID id = m-&gt;find_jmethod_id_or_null();
2352     if (id == NULL) {
2353       new_jmeths++;
2354     }
2355   }
2356   if (new_jmeths != 0) {
2357     Method::ensure_jmethod_ids(class_loader_data(), new_jmeths);
2358   }
2359 }
2360 
2361 // Common code to fetch the jmethodID from the cache or update the
2362 // cache with the new jmethodID. This function should never do anything
2363 // that causes the caller to go to a safepoint or we can deadlock with
2364 // the VMThread or have cache consistency issues.
2365 //
2366 jmethodID InstanceKlass::get_jmethod_id_fetch_or_update(
2367             size_t idnum, jmethodID new_id,
2368             jmethodID* new_jmeths, jmethodID* to_dealloc_id_p,
2369             jmethodID** to_dealloc_jmeths_p) {
2370   assert(new_id != NULL, &quot;sanity check&quot;);
2371   assert(to_dealloc_id_p != NULL, &quot;sanity check&quot;);
2372   assert(to_dealloc_jmeths_p != NULL, &quot;sanity check&quot;);
2373   assert(Threads::number_of_threads() == 0 ||
2374          SafepointSynchronize::is_at_safepoint() ||
2375          JmethodIdCreation_lock-&gt;owned_by_self(), &quot;sanity check&quot;);
2376 
2377   // reacquire the cache - we are locked, single threaded or at a safepoint
2378   jmethodID* jmeths = methods_jmethod_ids_acquire();
2379   jmethodID  id     = NULL;
2380   size_t     length = 0;
2381 
2382   if (jmeths == NULL ||                         // no cache yet
2383       (length = (size_t)jmeths[0]) &lt;= idnum) {  // cache is too short
2384     if (jmeths != NULL) {
2385       // copy any existing entries from the old cache
2386       for (size_t index = 0; index &lt; length; index++) {
2387         new_jmeths[index+1] = jmeths[index+1];
2388       }
2389       *to_dealloc_jmeths_p = jmeths;  // save old cache for later delete
2390     }
2391     release_set_methods_jmethod_ids(jmeths = new_jmeths);
2392   } else {
2393     // fetch jmethodID (if any) from the existing cache
2394     id = jmeths[idnum+1];
2395     *to_dealloc_jmeths_p = new_jmeths;  // save new cache for later delete
2396   }
2397   if (id == NULL) {
2398     // No matching jmethodID in the existing cache or we have a new
2399     // cache or we just grew the cache. This cache write is done here
2400     // by the first thread to win the foot race because a jmethodID
2401     // needs to be unique once it is generally available.
2402     id = new_id;
2403 
2404     // The jmethodID cache can be read while unlocked so we have to
2405     // make sure the new jmethodID is complete before installing it
2406     // in the cache.
2407     Atomic::release_store(&amp;jmeths[idnum+1], id);
2408   } else {
2409     *to_dealloc_id_p = new_id; // save new id for later delete
2410   }
2411   return id;
2412 }
2413 
2414 
2415 // Common code to get the jmethodID cache length and the jmethodID
2416 // value at index idnum if there is one.
2417 //
2418 void InstanceKlass::get_jmethod_id_length_value(jmethodID* cache,
2419        size_t idnum, size_t *length_p, jmethodID* id_p) {
2420   assert(cache != NULL, &quot;sanity check&quot;);
2421   assert(length_p != NULL, &quot;sanity check&quot;);
2422   assert(id_p != NULL, &quot;sanity check&quot;);
2423 
2424   // cache size is stored in element[0], other elements offset by one
2425   *length_p = (size_t)cache[0];
2426   if (*length_p &lt;= idnum) {  // cache is too short
2427     *id_p = NULL;
2428   } else {
2429     *id_p = cache[idnum+1];  // fetch jmethodID (if any)
2430   }
2431 }
2432 
2433 
2434 // Lookup a jmethodID, NULL if not found.  Do no blocking, no allocations, no handles
2435 jmethodID InstanceKlass::jmethod_id_or_null(Method* method) {
2436   size_t idnum = (size_t)method-&gt;method_idnum();
2437   jmethodID* jmeths = methods_jmethod_ids_acquire();
2438   size_t length;                                // length assigned as debugging crumb
2439   jmethodID id = NULL;
2440   if (jmeths != NULL &amp;&amp;                         // If there is a cache
2441       (length = (size_t)jmeths[0]) &gt; idnum) {   // and if it is long enough,
2442     id = jmeths[idnum+1];                       // Look up the id (may be NULL)
2443   }
2444   return id;
2445 }
2446 
2447 inline DependencyContext InstanceKlass::dependencies() {
2448   DependencyContext dep_context(&amp;_dep_context, &amp;_dep_context_last_cleaned);
2449   return dep_context;
2450 }
2451 
2452 int InstanceKlass::mark_dependent_nmethods(KlassDepChange&amp; changes) {
2453   return dependencies().mark_dependent_nmethods(changes);
2454 }
2455 
2456 void InstanceKlass::add_dependent_nmethod(nmethod* nm) {
2457   dependencies().add_dependent_nmethod(nm);
2458 }
2459 
2460 void InstanceKlass::remove_dependent_nmethod(nmethod* nm) {
2461   dependencies().remove_dependent_nmethod(nm);
2462 }
2463 
2464 void InstanceKlass::clean_dependency_context() {
2465   dependencies().clean_unloading_dependents();
2466 }
2467 
2468 #ifndef PRODUCT
2469 void InstanceKlass::print_dependent_nmethods(bool verbose) {
2470   dependencies().print_dependent_nmethods(verbose);
2471 }
2472 
2473 bool InstanceKlass::is_dependent_nmethod(nmethod* nm) {
2474   return dependencies().is_dependent_nmethod(nm);
2475 }
2476 #endif //PRODUCT
2477 
2478 void InstanceKlass::clean_weak_instanceklass_links() {
2479   clean_implementors_list();
2480   clean_method_data();
2481 }
2482 
2483 void InstanceKlass::clean_implementors_list() {
2484   assert(is_loader_alive(), &quot;this klass should be live&quot;);
2485   if (is_interface()) {
2486     assert (ClassUnloading, &quot;only called for ClassUnloading&quot;);
2487     for (;;) {
2488       // Use load_acquire due to competing with inserts
2489       Klass* impl = Atomic::load_acquire(adr_implementor());
2490       if (impl != NULL &amp;&amp; !impl-&gt;is_loader_alive()) {
2491         // NULL this field, might be an unloaded klass or NULL
2492         Klass* volatile* klass = adr_implementor();
2493         if (Atomic::cmpxchg(klass, impl, (Klass*)NULL) == impl) {
2494           // Successfully unlinking implementor.
2495           if (log_is_enabled(Trace, class, unload)) {
2496             ResourceMark rm;
2497             log_trace(class, unload)(&quot;unlinking class (implementor): %s&quot;, impl-&gt;external_name());
2498           }
2499           return;
2500         }
2501       } else {
2502         return;
2503       }
2504     }
2505   }
2506 }
2507 
2508 void InstanceKlass::clean_method_data() {
2509   for (int m = 0; m &lt; methods()-&gt;length(); m++) {
2510     MethodData* mdo = methods()-&gt;at(m)-&gt;method_data();
2511     if (mdo != NULL) {
2512       MutexLocker ml(SafepointSynchronize::is_at_safepoint() ? NULL : mdo-&gt;extra_data_lock());
2513       mdo-&gt;clean_method_data(/*always_clean*/false);
2514     }
2515   }
2516 }
2517 
2518 bool InstanceKlass::supers_have_passed_fingerprint_checks() {
2519   if (java_super() != NULL &amp;&amp; !java_super()-&gt;has_passed_fingerprint_check()) {
2520     ResourceMark rm;
2521     log_trace(class, fingerprint)(&quot;%s : super %s not fingerprinted&quot;, external_name(), java_super()-&gt;external_name());
2522     return false;
2523   }
2524 
2525   Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
2526   if (local_interfaces != NULL) {
2527     int length = local_interfaces-&gt;length();
2528     for (int i = 0; i &lt; length; i++) {
2529       InstanceKlass* intf = local_interfaces-&gt;at(i);
2530       if (!intf-&gt;has_passed_fingerprint_check()) {
2531         ResourceMark rm;
2532         log_trace(class, fingerprint)(&quot;%s : interface %s not fingerprinted&quot;, external_name(), intf-&gt;external_name());
2533         return false;
2534       }
2535     }
2536   }
2537 
2538   return true;
2539 }
2540 
2541 bool InstanceKlass::should_store_fingerprint(bool is_hidden_or_anonymous) {
2542 #if INCLUDE_AOT
2543   // We store the fingerprint into the InstanceKlass only in the following 2 cases:
2544   if (CalculateClassFingerprint) {
2545     // (1) We are running AOT to generate a shared library.
2546     return true;
2547   }
2548   if (Arguments::is_dumping_archive()) {
2549     // (2) We are running -Xshare:dump or -XX:ArchiveClassesAtExit to create a shared archive
2550     return true;
2551   }
2552   if (UseAOT &amp;&amp; is_hidden_or_anonymous) {
2553     // (3) We are using AOT code from a shared library and see a hidden or unsafe anonymous class
2554     return true;
2555   }
2556 #endif
2557 
2558   // In all other cases we might set the _misc_has_passed_fingerprint_check bit,
2559   // but do not store the 64-bit fingerprint to save space.
2560   return false;
2561 }
2562 
2563 bool InstanceKlass::has_stored_fingerprint() const {
2564 #if INCLUDE_AOT
2565   return should_store_fingerprint() || is_shared();
2566 #else
2567   return false;
2568 #endif
2569 }
2570 
2571 uint64_t InstanceKlass::get_stored_fingerprint() const {
2572   address adr = adr_fingerprint();
2573   if (adr != NULL) {
2574     return (uint64_t)Bytes::get_native_u8(adr); // adr may not be 64-bit aligned
2575   }
2576   return 0;
2577 }
2578 
2579 void InstanceKlass::store_fingerprint(uint64_t fingerprint) {
2580   address adr = adr_fingerprint();
2581   if (adr != NULL) {
2582     Bytes::put_native_u8(adr, (u8)fingerprint); // adr may not be 64-bit aligned
2583 
2584     ResourceMark rm;
2585     log_trace(class, fingerprint)(&quot;stored as &quot; PTR64_FORMAT &quot; for class %s&quot;, fingerprint, external_name());
2586   }
2587 }
2588 
2589 void InstanceKlass::metaspace_pointers_do(MetaspaceClosure* it) {
2590   Klass::metaspace_pointers_do(it);
2591 
2592   if (log_is_enabled(Trace, cds)) {
2593     ResourceMark rm;
2594     log_trace(cds)(&quot;Iter(InstanceKlass): %p (%s)&quot;, this, external_name());
2595   }
2596 
2597   it-&gt;push(&amp;_annotations);
2598   it-&gt;push((Klass**)&amp;_array_klasses);
2599   it-&gt;push(&amp;_constants);
2600   it-&gt;push(&amp;_inner_classes);
2601 #if INCLUDE_JVMTI
2602   it-&gt;push(&amp;_previous_versions);
2603 #endif
2604   it-&gt;push(&amp;_methods);
2605   it-&gt;push(&amp;_default_methods);
2606   it-&gt;push(&amp;_local_interfaces);
2607   it-&gt;push(&amp;_transitive_interfaces);
2608   it-&gt;push(&amp;_method_ordering);
2609   it-&gt;push(&amp;_default_vtable_indices);
2610   it-&gt;push(&amp;_fields);
2611 
2612   if (itable_length() &gt; 0) {
2613     itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2614     int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2615     int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2616                          / itableOffsetEntry::size();
2617 
2618     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2619       if (ioe-&gt;interface_klass() != NULL) {
2620         it-&gt;push(ioe-&gt;interface_klass_addr());
2621         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2622         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2623         for (int index = 0; index &lt; n; index ++) {
2624           it-&gt;push(ime[index].method_addr());
2625         }
2626       }
2627     }
2628   }
2629 
2630   it-&gt;push(&amp;_nest_members);
2631   it-&gt;push(&amp;_permitted_subclasses);
2632   it-&gt;push(&amp;_record_components);
2633 
2634   if (has_inline_type_fields()) {
2635     for (int i = 0; i &lt; java_fields_count(); i++) {
2636       it-&gt;push(&amp;((Klass**)adr_inline_type_field_klasses())[i]);
2637     }
2638   }
2639 }
2640 
2641 void InstanceKlass::remove_unshareable_info() {
2642   Klass::remove_unshareable_info();
2643 
2644   if (SystemDictionaryShared::has_class_failed_verification(this)) {
2645     // Classes are attempted to link during dumping and may fail,
2646     // but these classes are still in the dictionary and class list in CLD.
2647     // If the class has failed verification, there is nothing else to remove.
2648     return;
2649   }
2650 
2651   // Reset to the &#39;allocated&#39; state to prevent any premature accessing to
2652   // a shared class at runtime while the class is still being loaded and
2653   // restored. A class&#39; init_state is set to &#39;loaded&#39; at runtime when it&#39;s
2654   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2655   _init_state = allocated;
2656 
2657   { // Otherwise this needs to take out the Compile_lock.
2658     assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
2659     init_implementor();
2660   }
2661 
2662   constants()-&gt;remove_unshareable_info();
2663 
2664   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2665     Method* m = methods()-&gt;at(i);
2666     m-&gt;remove_unshareable_info();
2667   }
2668 
2669   // do array classes also.
2670   if (array_klasses() != NULL) {
2671     array_klasses()-&gt;remove_unshareable_info();
2672   }
2673 
2674   if (has_inline_type_fields()) {
2675     for (AllFieldStream fs(fields(), constants()); !fs.done(); fs.next()) {
2676       if (Signature::basic_type(fs.signature()) == T_INLINE_TYPE) {
2677         reset_inline_type_field_klass(fs.index());
2678       }
2679     }
2680   }
2681 
2682   // These are not allocated from metaspace. They are safe to set to NULL.
2683   _source_debug_extension = NULL;
2684   _dep_context = NULL;
2685   _osr_nmethods_head = NULL;
2686 #if INCLUDE_JVMTI
2687   _breakpoints = NULL;
2688   _previous_versions = NULL;
2689   _cached_class_file = NULL;
2690   _jvmti_cached_class_field_map = NULL;
2691 #endif
2692 
2693   _init_thread = NULL;
2694   _methods_jmethod_ids = NULL;
2695   _jni_ids = NULL;
2696   _oop_map_cache = NULL;
2697   // clear _nest_host to ensure re-load at runtime
2698   _nest_host = NULL;
2699   _package_entry = NULL;
2700   _dep_context_last_cleaned = 0;
2701 }
2702 
2703 void InstanceKlass::remove_java_mirror() {
2704   Klass::remove_java_mirror();
2705 
2706   // do array classes also.
2707   if (array_klasses() != NULL) {
2708     array_klasses()-&gt;remove_java_mirror();
2709   }
2710 }
2711 
2712 void InstanceKlass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain,
2713                                              PackageEntry* pkg_entry, TRAPS) {
2714   // SystemDictionary::add_to_hierarchy() sets the init_state to loaded
2715   // before the InstanceKlass is added to the SystemDictionary. Make
2716   // sure the current state is &lt;loaded.
2717   assert(!is_loaded(), &quot;invalid init state&quot;);
2718   set_package(loader_data, pkg_entry, CHECK);
2719   Klass::restore_unshareable_info(loader_data, protection_domain, CHECK);
2720 
2721   if (is_inline_klass()) {
2722     InlineKlass::cast(this)-&gt;initialize_calling_convention(CHECK);
2723   }
2724 
2725   Array&lt;Method*&gt;* methods = this-&gt;methods();
2726   int num_methods = methods-&gt;length();
2727   for (int index = 0; index &lt; num_methods; ++index) {
2728     methods-&gt;at(index)-&gt;restore_unshareable_info(CHECK);
2729   }
2730   if (JvmtiExport::has_redefined_a_class()) {
2731     // Reinitialize vtable because RedefineClasses may have changed some
2732     // entries in this vtable for super classes so the CDS vtable might
2733     // point to old or obsolete entries.  RedefineClasses doesn&#39;t fix up
2734     // vtables in the shared system dictionary, only the main one.
2735     // It also redefines the itable too so fix that too.
2736     vtable().initialize_vtable(false, CHECK);
2737     itable().initialize_itable(false, CHECK);
2738   }
2739 
2740   // restore constant pool resolved references
2741   constants()-&gt;restore_unshareable_info(CHECK);
2742 
2743   if (array_klasses() != NULL) {
2744     // Array classes have null protection domain.
2745     // --&gt; see ArrayKlass::complete_create_array_klass()
2746     array_klasses()-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2747   }
2748 
2749   // Initialize current biased locking state.
2750   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled() &amp;&amp; !is_inline_klass()) {
2751     set_prototype_header(markWord::biased_locking_prototype());
2752   }
2753 }
2754 
2755 void InstanceKlass::set_shared_class_loader_type(s2 loader_type) {
2756   switch (loader_type) {
2757   case ClassLoader::BOOT_LOADER:
2758     _misc_flags |= _misc_is_shared_boot_class;
2759     break;
2760   case ClassLoader::PLATFORM_LOADER:
2761     _misc_flags |= _misc_is_shared_platform_class;
2762     break;
2763   case ClassLoader::APP_LOADER:
2764     _misc_flags |= _misc_is_shared_app_class;
2765     break;
2766   default:
2767     ShouldNotReachHere();
2768     break;
2769   }
2770 }
2771 
2772 void InstanceKlass::assign_class_loader_type() {
2773   ClassLoaderData *cld = class_loader_data();
2774   if (cld-&gt;is_boot_class_loader_data()) {
2775     set_shared_class_loader_type(ClassLoader::BOOT_LOADER);
2776   }
2777   else if (cld-&gt;is_platform_class_loader_data()) {
2778     set_shared_class_loader_type(ClassLoader::PLATFORM_LOADER);
2779   }
2780   else if (cld-&gt;is_system_class_loader_data()) {
2781     set_shared_class_loader_type(ClassLoader::APP_LOADER);
2782   }
2783 }
2784 
2785 #if INCLUDE_JVMTI
2786 static void clear_all_breakpoints(Method* m) {
2787   m-&gt;clear_all_breakpoints();
2788 }
2789 #endif
2790 
2791 void InstanceKlass::unload_class(InstanceKlass* ik) {
2792   // Release dependencies.
2793   ik-&gt;dependencies().remove_all_dependents();
2794 
2795   // notify the debugger
2796   if (JvmtiExport::should_post_class_unload()) {
2797     JvmtiExport::post_class_unload(ik);
2798   }
2799 
2800   // notify ClassLoadingService of class unload
2801   ClassLoadingService::notify_class_unloaded(ik);
2802 
2803   if (Arguments::is_dumping_archive()) {
2804     SystemDictionaryShared::remove_dumptime_info(ik);
2805   }
2806 
2807   if (log_is_enabled(Info, class, unload)) {
2808     ResourceMark rm;
2809     log_info(class, unload)(&quot;unloading class %s &quot; INTPTR_FORMAT, ik-&gt;external_name(), p2i(ik));
2810   }
2811 
2812   Events::log_class_unloading(Thread::current(), ik);
2813 
2814 #if INCLUDE_JFR
2815   assert(ik != NULL, &quot;invariant&quot;);
2816   EventClassUnload event;
2817   event.set_unloadedClass(ik);
2818   event.set_definingClassLoader(ik-&gt;class_loader_data());
2819   event.commit();
2820 #endif
2821 }
2822 
2823 static void method_release_C_heap_structures(Method* m) {
2824   m-&gt;release_C_heap_structures();
2825 }
2826 
2827 void InstanceKlass::release_C_heap_structures() {
2828 
2829   // Clean up C heap
2830   release_C_heap_structures_internal();
2831   constants()-&gt;release_C_heap_structures();
2832 
2833   // Deallocate and call destructors for MDO mutexes
2834   methods_do(method_release_C_heap_structures);
2835 }
2836 
2837 void InstanceKlass::release_C_heap_structures_internal() {
2838   Klass::release_C_heap_structures();
2839 
2840   // Can&#39;t release the constant pool here because the constant pool can be
2841   // deallocated separately from the InstanceKlass for default methods and
2842   // redefine classes.
2843 
2844   // Deallocate oop map cache
2845   if (_oop_map_cache != NULL) {
2846     delete _oop_map_cache;
2847     _oop_map_cache = NULL;
2848   }
2849 
2850   // Deallocate JNI identifiers for jfieldIDs
2851   JNIid::deallocate(jni_ids());
2852   set_jni_ids(NULL);
2853 
2854   jmethodID* jmeths = methods_jmethod_ids_acquire();
2855   if (jmeths != (jmethodID*)NULL) {
2856     release_set_methods_jmethod_ids(NULL);
2857     FreeHeap(jmeths);
2858   }
2859 
2860   assert(_dep_context == NULL,
2861          &quot;dependencies should already be cleaned&quot;);
2862 
2863 #if INCLUDE_JVMTI
2864   // Deallocate breakpoint records
2865   if (breakpoints() != 0x0) {
2866     methods_do(clear_all_breakpoints);
2867     assert(breakpoints() == 0x0, &quot;should have cleared breakpoints&quot;);
2868   }
2869 
2870   // deallocate the cached class file
2871   if (_cached_class_file != NULL) {
2872     os::free(_cached_class_file);
2873     _cached_class_file = NULL;
2874   }
2875 #endif
2876 
2877   FREE_C_HEAP_ARRAY(char, _source_debug_extension);
2878 }
2879 
2880 void InstanceKlass::set_source_debug_extension(const char* array, int length) {
2881   if (array == NULL) {
2882     _source_debug_extension = NULL;
2883   } else {
2884     // Adding one to the attribute length in order to store a null terminator
2885     // character could cause an overflow because the attribute length is
2886     // already coded with an u4 in the classfile, but in practice, it&#39;s
2887     // unlikely to happen.
2888     assert((length+1) &gt; length, &quot;Overflow checking&quot;);
2889     char* sde = NEW_C_HEAP_ARRAY(char, (length + 1), mtClass);
2890     for (int i = 0; i &lt; length; i++) {
2891       sde[i] = array[i];
2892     }
2893     sde[length] = &#39;\0&#39;;
2894     _source_debug_extension = sde;
2895   }
2896 }
2897 
2898 const char* InstanceKlass::signature_name() const {
2899   int hash_len = 0;
2900   char hash_buf[40];
2901 
2902   // If this is an unsafe anonymous class, append a hash to make the name unique
2903   if (is_unsafe_anonymous()) {
2904     intptr_t hash = (java_mirror() != NULL) ? java_mirror()-&gt;identity_hash() : 0;
2905     jio_snprintf(hash_buf, sizeof(hash_buf), &quot;/&quot; UINTX_FORMAT, (uintx)hash);
2906     hash_len = (int)strlen(hash_buf);
2907   }
2908 
2909   // Get the internal name as a c string
2910   const char* src = (const char*) (name()-&gt;as_C_string());
2911   const int src_length = (int)strlen(src);
2912 
2913   char* dest = NEW_RESOURCE_ARRAY(char, src_length + hash_len + 3);
2914 
2915   // Add L or Q as type indicator
2916   int dest_index = 0;
2917   dest[dest_index++] = is_inline_klass() ? JVM_SIGNATURE_INLINE_TYPE : JVM_SIGNATURE_CLASS;
2918 
2919   // Add the actual class name
2920   for (int src_index = 0; src_index &lt; src_length; ) {
2921     dest[dest_index++] = src[src_index++];
2922   }
2923 
2924   if (is_hidden()) { // Replace the last &#39;+&#39; with a &#39;.&#39;.
2925     for (int index = (int)src_length; index &gt; 0; index--) {
2926       if (dest[index] == &#39;+&#39;) {
2927         dest[index] = JVM_SIGNATURE_DOT;
2928         break;
2929       }
2930     }
2931   }
2932 
2933   // If we have a hash, append it
2934   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2935     dest[dest_index++] = hash_buf[hash_index++];
2936   }
2937 
2938   // Add the semicolon and the NULL
2939   dest[dest_index++] = JVM_SIGNATURE_ENDCLASS;
2940   dest[dest_index] = &#39;\0&#39;;
2941   return dest;
2942 }
2943 
2944 ModuleEntry* InstanceKlass::module() const {
2945   // For an unsafe anonymous class return the host class&#39; module
2946   if (is_unsafe_anonymous()) {
2947     assert(unsafe_anonymous_host() != NULL, &quot;unsafe anonymous class must have a host class&quot;);
2948     return unsafe_anonymous_host()-&gt;module();
2949   }
2950 
2951   if (is_hidden() &amp;&amp;
2952       in_unnamed_package() &amp;&amp;
2953       class_loader_data()-&gt;has_class_mirror_holder()) {
2954     // For a non-strong hidden class defined to an unnamed package,
2955     // its (class held) CLD will not have an unnamed module created for it.
2956     // Two choices to find the correct ModuleEntry:
2957     // 1. If hidden class is within a nest, use nest host&#39;s module
2958     // 2. Find the unnamed module off from the class loader
2959     // For now option #2 is used since a nest host is not set until
2960     // after the instance class is created in jvm_lookup_define_class().
2961     if (class_loader_data()-&gt;is_boot_class_loader_data()) {
2962       return ClassLoaderData::the_null_class_loader_data()-&gt;unnamed_module();
2963     } else {
2964       oop module = java_lang_ClassLoader::unnamedModule(class_loader_data()-&gt;class_loader());
2965       assert(java_lang_Module::is_instance(module), &quot;Not an instance of java.lang.Module&quot;);
2966       return java_lang_Module::module_entry(module);
2967     }
2968   }
2969 
2970   // Class is in a named package
2971   if (!in_unnamed_package()) {
2972     return _package_entry-&gt;module();
2973   }
2974 
2975   // Class is in an unnamed package, return its loader&#39;s unnamed module
2976   return class_loader_data()-&gt;unnamed_module();
2977 }
2978 
2979 void InstanceKlass::set_package(ClassLoaderData* loader_data, PackageEntry* pkg_entry, TRAPS) {
2980 
2981   // ensure java/ packages only loaded by boot or platform builtin loaders
2982   // not needed for shared class since CDS does not archive prohibited classes.
2983   if (!is_shared()) {
2984     check_prohibited_package(name(), loader_data, CHECK);
2985   }
2986 
2987   // ClassLoader::package_from_class_name has already incremented the refcount of the symbol
2988   // it returns, so we need to decrement it when the current function exits.
2989   TempNewSymbol from_class_name =
2990       (pkg_entry != NULL) ? NULL : ClassLoader::package_from_class_name(name());
2991 
2992   Symbol* pkg_name;
2993   if (pkg_entry != NULL) {
2994     pkg_name = pkg_entry-&gt;name();
2995   } else {
2996     pkg_name = from_class_name;
2997   }
2998 
2999   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
3000 
3001     // Find in class loader&#39;s package entry table.
3002     _package_entry = pkg_entry != NULL ? pkg_entry : loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
3003 
3004     // If the package name is not found in the loader&#39;s package
3005     // entry table, it is an indication that the package has not
3006     // been defined. Consider it defined within the unnamed module.
3007     if (_package_entry == NULL) {
3008 
3009       if (!ModuleEntryTable::javabase_defined()) {
3010         // Before java.base is defined during bootstrapping, define all packages in
3011         // the java.base module.  If a non-java.base package is erroneously placed
3012         // in the java.base module it will be caught later when java.base
3013         // is defined by ModuleEntryTable::verify_javabase_packages check.
3014         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME &quot; module is NULL&quot;);
3015         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
3016       } else {
3017         assert(loader_data-&gt;unnamed_module() != NULL, &quot;unnamed module is NULL&quot;);
3018         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name,
3019                                                          loader_data-&gt;unnamed_module());
3020       }
3021 
3022       // A package should have been successfully created
3023       DEBUG_ONLY(ResourceMark rm(THREAD));
3024       assert(_package_entry != NULL, &quot;Package entry for class %s not found, loader %s&quot;,
3025              name()-&gt;as_C_string(), loader_data-&gt;loader_name_and_id());
3026     }
3027 
3028     if (log_is_enabled(Debug, module)) {
3029       ResourceMark rm(THREAD);
3030       ModuleEntry* m = _package_entry-&gt;module();
3031       log_trace(module)(&quot;Setting package: class: %s, package: %s, loader: %s, module: %s&quot;,
3032                         external_name(),
3033                         pkg_name-&gt;as_C_string(),
3034                         loader_data-&gt;loader_name_and_id(),
3035                         (m-&gt;is_named() ? m-&gt;name()-&gt;as_C_string() : UNNAMED_MODULE));
3036     }
3037   } else {
3038     ResourceMark rm(THREAD);
3039     log_trace(module)(&quot;Setting package: class: %s, package: unnamed, loader: %s, module: %s&quot;,
3040                       external_name(),
3041                       (loader_data != NULL) ? loader_data-&gt;loader_name_and_id() : &quot;NULL&quot;,
3042                       UNNAMED_MODULE);
3043   }
3044 }
3045 
3046 // Function set_classpath_index checks if the package of the InstanceKlass is in the
3047 // boot loader&#39;s package entry table.  If so, then it sets the classpath_index
3048 // in the package entry record.
3049 //
3050 // The classpath_index field is used to find the entry on the boot loader class
3051 // path for packages with classes loaded by the boot loader from -Xbootclasspath/a
3052 // in an unnamed module.  It is also used to indicate (for all packages whose
3053 // classes are loaded by the boot loader) that at least one of the package&#39;s
3054 // classes has been loaded.
3055 void InstanceKlass::set_classpath_index(s2 path_index, TRAPS) {
3056   if (_package_entry != NULL) {
3057     DEBUG_ONLY(PackageEntryTable* pkg_entry_tbl = ClassLoaderData::the_null_class_loader_data()-&gt;packages();)
3058     assert(pkg_entry_tbl-&gt;lookup_only(_package_entry-&gt;name()) == _package_entry, &quot;Should be same&quot;);
3059     assert(path_index != -1, &quot;Unexpected classpath_index&quot;);
3060     _package_entry-&gt;set_classpath_index(path_index);
3061   }
3062 }
3063 
3064 // different versions of is_same_class_package
3065 
3066 bool InstanceKlass::is_same_class_package(const Klass* class2) const {
3067   oop classloader1 = this-&gt;class_loader();
3068   PackageEntry* classpkg1 = this-&gt;package();
3069   if (class2-&gt;is_objArray_klass()) {
3070     class2 = ObjArrayKlass::cast(class2)-&gt;bottom_klass();
3071   }
3072 
3073   oop classloader2;
3074   PackageEntry* classpkg2;
3075   if (class2-&gt;is_instance_klass()) {
3076     classloader2 = class2-&gt;class_loader();
3077     classpkg2 = class2-&gt;package();
3078   } else {
3079     assert(class2-&gt;is_typeArray_klass(), &quot;should be type array&quot;);
3080     classloader2 = NULL;
3081     classpkg2 = NULL;
3082   }
3083 
3084   // Same package is determined by comparing class loader
3085   // and package entries. Both must be the same. This rule
3086   // applies even to classes that are defined in the unnamed
3087   // package, they still must have the same class loader.
3088   if ((classloader1 == classloader2) &amp;&amp; (classpkg1 == classpkg2)) {
3089     return true;
3090   }
3091 
3092   return false;
3093 }
3094 
3095 // return true if this class and other_class are in the same package. Classloader
3096 // and classname information is enough to determine a class&#39;s package
3097 bool InstanceKlass::is_same_class_package(oop other_class_loader,
3098                                           const Symbol* other_class_name) const {
3099   if (class_loader() != other_class_loader) {
3100     return false;
3101   }
3102   if (name()-&gt;fast_compare(other_class_name) == 0) {
3103      return true;
3104   }
3105 
3106   {
3107     ResourceMark rm;
3108 
3109     bool bad_class_name = false;
3110     TempNewSymbol other_pkg = ClassLoader::package_from_class_name(other_class_name, &amp;bad_class_name);
3111     if (bad_class_name) {
3112       return false;
3113     }
3114     // Check that package_from_class_name() returns NULL, not &quot;&quot;, if there is no package.
3115     assert(other_pkg == NULL || other_pkg-&gt;utf8_length() &gt; 0, &quot;package name is empty string&quot;);
3116 
3117     const Symbol* const this_package_name =
3118       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
3119 
3120     if (this_package_name == NULL || other_pkg == NULL) {
3121       // One of the two doesn&#39;t have a package.  Only return true if the other
3122       // one also doesn&#39;t have a package.
3123       return this_package_name == other_pkg;
3124     }
3125 
3126     // Check if package is identical
3127     return this_package_name-&gt;fast_compare(other_pkg) == 0;
3128   }
3129 }
3130 
3131 // Returns true iff super_method can be overridden by a method in targetclassname
3132 // See JLS 3rd edition 8.4.6.1
3133 // Assumes name-signature match
3134 // &quot;this&quot; is InstanceKlass of super_method which must exist
3135 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
3136 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
3137    // Private methods can not be overridden
3138    if (super_method-&gt;is_private()) {
3139      return false;
3140    }
3141    // If super method is accessible, then override
3142    if ((super_method-&gt;is_protected()) ||
3143        (super_method-&gt;is_public())) {
3144      return true;
3145    }
3146    // Package-private methods are not inherited outside of package
3147    assert(super_method-&gt;is_package_private(), &quot;must be package private&quot;);
3148    return(is_same_class_package(targetclassloader(), targetclassname));
3149 }
3150 
3151 // Only boot and platform class loaders can define classes in &quot;java/&quot; packages.
3152 void InstanceKlass::check_prohibited_package(Symbol* class_name,
3153                                              ClassLoaderData* loader_data,
3154                                              TRAPS) {
3155   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
3156       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
3157       class_name != NULL) {
3158     ResourceMark rm(THREAD);
3159     char* name = class_name-&gt;as_C_string();
3160     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == &#39;/&#39;) {
3161       TempNewSymbol pkg_name = ClassLoader::package_from_class_name(class_name);
3162       assert(pkg_name != NULL, &quot;Error in parsing package name starting with &#39;java/&#39;&quot;);
3163       name = pkg_name-&gt;as_C_string();
3164       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
3165       StringUtils::replace_no_expand(name, &quot;/&quot;, &quot;.&quot;);
3166       const char* msg_text1 = &quot;Class loader (instance of): &quot;;
3167       const char* msg_text2 = &quot; tried to load prohibited package name: &quot;;
3168       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
3169       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
3170       jio_snprintf(message, len, &quot;%s%s%s%s&quot;, msg_text1, class_loader_name, msg_text2, name);
3171       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
3172     }
3173   }
3174   return;
3175 }
3176 
3177 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
3178   constantPoolHandle i_cp(THREAD, constants());
3179   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
3180     int ioff = iter.inner_class_info_index();
3181     if (ioff != 0) {
3182       // Check to see if the name matches the class we&#39;re looking for
3183       // before attempting to find the class.
3184       if (i_cp-&gt;klass_name_at_matches(this, ioff)) {
3185         Klass* inner_klass = i_cp-&gt;klass_at(ioff, CHECK_false);
3186         if (this == inner_klass) {
3187           *ooff = iter.outer_class_info_index();
3188           *noff = iter.inner_name_index();
3189           return true;
3190         }
3191       }
3192     }
3193   }
3194   return false;
3195 }
3196 
3197 InstanceKlass* InstanceKlass::compute_enclosing_class(bool* inner_is_member, TRAPS) const {
3198   InstanceKlass* outer_klass = NULL;
3199   *inner_is_member = false;
3200   int ooff = 0, noff = 0;
3201   bool has_inner_classes_attr = find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD);
3202   if (has_inner_classes_attr) {
3203     constantPoolHandle i_cp(THREAD, constants());
3204     if (ooff != 0) {
3205       Klass* ok = i_cp-&gt;klass_at(ooff, CHECK_NULL);
3206       outer_klass = InstanceKlass::cast(ok);
3207       *inner_is_member = true;
3208     }
3209     if (NULL == outer_klass) {
3210       // It may be a local or anonymous class; try for that.
3211       int encl_method_class_idx = enclosing_method_class_index();
3212       if (encl_method_class_idx != 0) {
3213         Klass* ok = i_cp-&gt;klass_at(encl_method_class_idx, CHECK_NULL);
3214         outer_klass = InstanceKlass::cast(ok);
3215         *inner_is_member = false;
3216       }
3217     }
3218   }
3219 
3220   // If no inner class attribute found for this class.
3221   if (NULL == outer_klass) return NULL;
3222 
3223   // Throws an exception if outer klass has not declared k as an inner klass
3224   // We need evidence that each klass knows about the other, or else
3225   // the system could allow a spoof of an inner class to gain access rights.
3226   Reflection::check_for_inner_class(outer_klass, this, *inner_is_member, CHECK_NULL);
3227   return outer_klass;
3228 }
3229 
3230 jint InstanceKlass::compute_modifier_flags(TRAPS) const {
3231   jint access = access_flags().as_int();
3232 
3233   // But check if it happens to be member class.
3234   InnerClassesIterator iter(this);
3235   for (; !iter.done(); iter.next()) {
3236     int ioff = iter.inner_class_info_index();
3237     // Inner class attribute can be zero, skip it.
3238     // Strange but true:  JVM spec. allows null inner class refs.
3239     if (ioff == 0) continue;
3240 
3241     // only look at classes that are already loaded
3242     // since we are looking for the flags for our self.
3243     Symbol* inner_name = constants()-&gt;klass_name_at(ioff);
3244     if (name() == inner_name) {
3245       // This is really a member class.
3246       access = iter.inner_access_flags();
3247       break;
3248     }
3249   }
3250   // Remember to strip ACC_SUPER bit
3251   return (access &amp; (~JVM_ACC_SUPER)) &amp; JVM_ACC_WRITTEN_FLAGS;
3252 }
3253 
3254 jint InstanceKlass::jvmti_class_status() const {
3255   jint result = 0;
3256 
3257   if (is_linked()) {
3258     result |= JVMTI_CLASS_STATUS_VERIFIED | JVMTI_CLASS_STATUS_PREPARED;
3259   }
3260 
3261   if (is_initialized()) {
3262     assert(is_linked(), &quot;Class status is not consistent&quot;);
3263     result |= JVMTI_CLASS_STATUS_INITIALIZED;
3264   }
3265   if (is_in_error_state()) {
3266     result |= JVMTI_CLASS_STATUS_ERROR;
3267   }
3268   return result;
3269 }
3270 
3271 Method* InstanceKlass::method_at_itable(Klass* holder, int index, TRAPS) {
3272   itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
3273   int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
3274   int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
3275                        / itableOffsetEntry::size();
3276 
3277   for (int cnt = 0 ; ; cnt ++, ioe ++) {
3278     // If the interface isn&#39;t implemented by the receiver class,
3279     // the VM should throw IncompatibleClassChangeError.
3280     if (cnt &gt;= nof_interfaces) {
3281       ResourceMark rm(THREAD);
3282       stringStream ss;
3283       bool same_module = (module() == holder-&gt;module());
3284       ss.print(&quot;Receiver class %s does not implement &quot;
3285                &quot;the interface %s defining the method to be called &quot;
3286                &quot;(%s%s%s)&quot;,
3287                external_name(), holder-&gt;external_name(),
3288                (same_module) ? joint_in_module_of_loader(holder) : class_in_module_of_loader(),
3289                (same_module) ? &quot;&quot; : &quot;; &quot;,
3290                (same_module) ? &quot;&quot; : holder-&gt;class_in_module_of_loader());
3291       THROW_MSG_NULL(vmSymbols::java_lang_IncompatibleClassChangeError(), ss.as_string());
3292     }
3293 
3294     Klass* ik = ioe-&gt;interface_klass();
3295     if (ik == holder) break;
3296   }
3297 
3298   itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
3299   Method* m = ime[index].method();
3300   if (m == NULL) {
3301     THROW_NULL(vmSymbols::java_lang_AbstractMethodError());
3302   }
3303   return m;
3304 }
3305 
3306 
3307 #if INCLUDE_JVMTI
3308 // update default_methods for redefineclasses for methods that are
3309 // not yet in the vtable due to concurrent subclass define and superinterface
3310 // redefinition
3311 // Note: those in the vtable, should have been updated via adjust_method_entries
3312 void InstanceKlass::adjust_default_methods(bool* trace_name_printed) {
3313   // search the default_methods for uses of either obsolete or EMCP methods
3314   if (default_methods() != NULL) {
3315     for (int index = 0; index &lt; default_methods()-&gt;length(); index ++) {
3316       Method* old_method = default_methods()-&gt;at(index);
3317       if (old_method == NULL || !old_method-&gt;is_old()) {
3318         continue; // skip uninteresting entries
3319       }
3320       assert(!old_method-&gt;is_deleted(), &quot;default methods may not be deleted&quot;);
3321       Method* new_method = old_method-&gt;get_new_method();
3322       default_methods()-&gt;at_put(index, new_method);
3323 
3324       if (log_is_enabled(Info, redefine, class, update)) {
3325         ResourceMark rm;
3326         if (!(*trace_name_printed)) {
3327           log_info(redefine, class, update)
3328             (&quot;adjust: klassname=%s default methods from name=%s&quot;,
3329              external_name(), old_method-&gt;method_holder()-&gt;external_name());
3330           *trace_name_printed = true;
3331         }
3332         log_debug(redefine, class, update, vtables)
3333           (&quot;default method update: %s(%s) &quot;,
3334            new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string());
3335       }
3336     }
3337   }
3338 }
3339 #endif // INCLUDE_JVMTI
3340 
3341 // On-stack replacement stuff
3342 void InstanceKlass::add_osr_nmethod(nmethod* n) {
3343   assert_lock_strong(CompiledMethod_lock);
3344 #ifndef PRODUCT
3345   if (TieredCompilation) {
3346     nmethod* prev = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), n-&gt;comp_level(), true);
3347     assert(prev == NULL || !prev-&gt;is_in_use() COMPILER2_PRESENT(|| StressRecompilation),
3348            &quot;redundant OSR recompilation detected. memory leak in CodeCache!&quot;);
3349   }
3350 #endif
3351   // only one compilation can be active
3352   {
3353     assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3354     n-&gt;set_osr_link(osr_nmethods_head());
3355     set_osr_nmethods_head(n);
3356     // Raise the highest osr level if necessary
3357     if (TieredCompilation) {
3358       Method* m = n-&gt;method();
3359       m-&gt;set_highest_osr_comp_level(MAX2(m-&gt;highest_osr_comp_level(), n-&gt;comp_level()));
3360     }
3361   }
3362 
3363   // Get rid of the osr methods for the same bci that have lower levels.
3364   if (TieredCompilation) {
3365     for (int l = CompLevel_limited_profile; l &lt; n-&gt;comp_level(); l++) {
3366       nmethod *inv = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), l, true);
3367       if (inv != NULL &amp;&amp; inv-&gt;is_in_use()) {
3368         inv-&gt;make_not_entrant();
3369       }
3370     }
3371   }
3372 }
3373 
3374 // Remove osr nmethod from the list. Return true if found and removed.
3375 bool InstanceKlass::remove_osr_nmethod(nmethod* n) {
3376   // This is a short non-blocking critical region, so the no safepoint check is ok.
3377   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock
3378                  , Mutex::_no_safepoint_check_flag);
3379   assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3380   nmethod* last = NULL;
3381   nmethod* cur  = osr_nmethods_head();
3382   int max_level = CompLevel_none;  // Find the max comp level excluding n
3383   Method* m = n-&gt;method();
3384   // Search for match
3385   bool found = false;
3386   while(cur != NULL &amp;&amp; cur != n) {
3387     if (TieredCompilation &amp;&amp; m == cur-&gt;method()) {
3388       // Find max level before n
3389       max_level = MAX2(max_level, cur-&gt;comp_level());
3390     }
3391     last = cur;
3392     cur = cur-&gt;osr_link();
3393   }
3394   nmethod* next = NULL;
3395   if (cur == n) {
3396     found = true;
3397     next = cur-&gt;osr_link();
3398     if (last == NULL) {
3399       // Remove first element
3400       set_osr_nmethods_head(next);
3401     } else {
3402       last-&gt;set_osr_link(next);
3403     }
3404   }
3405   n-&gt;set_osr_link(NULL);
3406   if (TieredCompilation) {
3407     cur = next;
3408     while (cur != NULL) {
3409       // Find max level after n
3410       if (m == cur-&gt;method()) {
3411         max_level = MAX2(max_level, cur-&gt;comp_level());
3412       }
3413       cur = cur-&gt;osr_link();
3414     }
3415     m-&gt;set_highest_osr_comp_level(max_level);
3416   }
3417   return found;
3418 }
3419 
3420 int InstanceKlass::mark_osr_nmethods(const Method* m) {
3421   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3422                  Mutex::_no_safepoint_check_flag);
3423   nmethod* osr = osr_nmethods_head();
3424   int found = 0;
3425   while (osr != NULL) {
3426     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3427     if (osr-&gt;method() == m) {
3428       osr-&gt;mark_for_deoptimization();
3429       found++;
3430     }
3431     osr = osr-&gt;osr_link();
3432   }
3433   return found;
3434 }
3435 
3436 nmethod* InstanceKlass::lookup_osr_nmethod(const Method* m, int bci, int comp_level, bool match_level) const {
3437   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3438                  Mutex::_no_safepoint_check_flag);
3439   nmethod* osr = osr_nmethods_head();
3440   nmethod* best = NULL;
3441   while (osr != NULL) {
3442     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3443     // There can be a time when a c1 osr method exists but we are waiting
3444     // for a c2 version. When c2 completes its osr nmethod we will trash
3445     // the c1 version and only be able to find the c2 version. However
3446     // while we overflow in the c1 code at back branches we don&#39;t want to
3447     // try and switch to the same code as we are already running
3448 
3449     if (osr-&gt;method() == m &amp;&amp;
3450         (bci == InvocationEntryBci || osr-&gt;osr_entry_bci() == bci)) {
3451       if (match_level) {
3452         if (osr-&gt;comp_level() == comp_level) {
3453           // Found a match - return it.
3454           return osr;
3455         }
3456       } else {
3457         if (best == NULL || (osr-&gt;comp_level() &gt; best-&gt;comp_level())) {
3458           if (osr-&gt;comp_level() == CompLevel_highest_tier) {
3459             // Found the best possible - return it.
3460             return osr;
3461           }
3462           best = osr;
3463         }
3464       }
3465     }
3466     osr = osr-&gt;osr_link();
3467   }
3468 
3469   assert(match_level == false || best == NULL, &quot;shouldn&#39;t pick up anything if match_level is set&quot;);
3470   if (best != NULL &amp;&amp; best-&gt;comp_level() &gt;= comp_level) {
3471     return best;
3472   }
3473   return NULL;
3474 }
3475 
3476 // -----------------------------------------------------------------------------------------------------
3477 // Printing
3478 
3479 #ifndef PRODUCT
3480 
3481 #define BULLET  &quot; - &quot;
3482 
3483 static const char* state_names[] = {
3484   &quot;allocated&quot;, &quot;loaded&quot;, &quot;linked&quot;, &quot;being_initialized&quot;, &quot;fully_initialized&quot;, &quot;initialization_error&quot;
3485 };
3486 
3487 static void print_vtable(address self, intptr_t* start, int len, outputStream* st) {
3488   ResourceMark rm;
3489   int* forward_refs = NEW_RESOURCE_ARRAY(int, len);
3490   for (int i = 0; i &lt; len; i++)  forward_refs[i] = 0;
3491   for (int i = 0; i &lt; len; i++) {
3492     intptr_t e = start[i];
3493     st-&gt;print(&quot;%d : &quot; INTPTR_FORMAT, i, e);
3494     if (forward_refs[i] != 0) {
3495       int from = forward_refs[i];
3496       int off = (int) start[from];
3497       st-&gt;print(&quot; (offset %d &lt;= [%d])&quot;, off, from);
3498     }
3499     if (MetaspaceObj::is_valid((Metadata*)e)) {
3500       st-&gt;print(&quot; &quot;);
3501       ((Metadata*)e)-&gt;print_value_on(st);
3502     } else if (self != NULL &amp;&amp; e &gt; 0 &amp;&amp; e &lt; 0x10000) {
3503       address location = self + e;
3504       int index = (int)((intptr_t*)location - start);
3505       st-&gt;print(&quot; (offset %d =&gt; [%d])&quot;, (int)e, index);
3506       if (index &gt;= 0 &amp;&amp; index &lt; len)
3507         forward_refs[index] = i;
3508     }
3509     st-&gt;cr();
3510   }
3511 }
3512 
3513 static void print_vtable(vtableEntry* start, int len, outputStream* st) {
3514   return print_vtable(NULL, reinterpret_cast&lt;intptr_t*&gt;(start), len, st);
3515 }
3516 
3517 template&lt;typename T&gt;
3518  static void print_array_on(outputStream* st, Array&lt;T&gt;* array) {
3519    if (array == NULL) { st-&gt;print_cr(&quot;NULL&quot;); return; }
3520    array-&gt;print_value_on(st); st-&gt;cr();
3521    if (Verbose || WizardMode) {
3522      for (int i = 0; i &lt; array-&gt;length(); i++) {
3523        st-&gt;print(&quot;%d : &quot;, i); array-&gt;at(i)-&gt;print_value_on(st); st-&gt;cr();
3524      }
3525    }
3526  }
3527 
3528 static void print_array_on(outputStream* st, Array&lt;int&gt;* array) {
3529   if (array == NULL) { st-&gt;print_cr(&quot;NULL&quot;); return; }
3530   array-&gt;print_value_on(st); st-&gt;cr();
3531   if (Verbose || WizardMode) {
3532     for (int i = 0; i &lt; array-&gt;length(); i++) {
3533       st-&gt;print(&quot;%d : %d&quot;, i, array-&gt;at(i)); st-&gt;cr();
3534     }
3535   }
3536 }
3537 
3538 void InstanceKlass::print_on(outputStream* st) const {
3539   assert(is_klass(), &quot;must be klass&quot;);
3540   Klass::print_on(st);
3541 
3542   st-&gt;print(BULLET&quot;instance size:     %d&quot;, size_helper());                        st-&gt;cr();
3543   st-&gt;print(BULLET&quot;klass size:        %d&quot;, size());                               st-&gt;cr();
3544   st-&gt;print(BULLET&quot;access:            &quot;); access_flags().print_on(st);            st-&gt;cr();
3545   st-&gt;print(BULLET&quot;misc flags:        0x%x&quot;, _misc_flags);                        st-&gt;cr();
3546   st-&gt;print(BULLET&quot;state:             &quot;); st-&gt;print_cr(&quot;%s&quot;, state_names[_init_state]);
3547   st-&gt;print(BULLET&quot;name:              &quot;); name()-&gt;print_value_on(st);             st-&gt;cr();
3548   st-&gt;print(BULLET&quot;super:             &quot;); Metadata::print_value_on_maybe_null(st, super()); st-&gt;cr();
3549   st-&gt;print(BULLET&quot;sub:               &quot;);
3550   Klass* sub = subklass();
3551   int n;
3552   for (n = 0; sub != NULL; n++, sub = sub-&gt;next_sibling()) {
3553     if (n &lt; MaxSubklassPrintSize) {
3554       sub-&gt;print_value_on(st);
3555       st-&gt;print(&quot;   &quot;);
3556     }
3557   }
3558   if (n &gt;= MaxSubklassPrintSize) st-&gt;print(&quot;(&quot; INTX_FORMAT &quot; more klasses...)&quot;, n - MaxSubklassPrintSize);
3559   st-&gt;cr();
3560 
3561   if (is_interface()) {
3562     st-&gt;print_cr(BULLET&quot;nof implementors:  %d&quot;, nof_implementors());
3563     if (nof_implementors() == 1) {
3564       st-&gt;print_cr(BULLET&quot;implementor:    &quot;);
3565       st-&gt;print(&quot;   &quot;);
3566       implementor()-&gt;print_value_on(st);
3567       st-&gt;cr();
3568     }
3569   }
3570 
3571   st-&gt;print(BULLET&quot;arrays:            &quot;); Metadata::print_value_on_maybe_null(st, array_klasses()); st-&gt;cr();
3572   st-&gt;print(BULLET&quot;methods:           &quot;); print_array_on(st, methods());
3573   st-&gt;print(BULLET&quot;method ordering:   &quot;); print_array_on(st, method_ordering());
3574   st-&gt;print(BULLET&quot;default_methods:   &quot;); print_array_on(st, default_methods());
3575   if (default_vtable_indices() != NULL) {
3576     st-&gt;print(BULLET&quot;default vtable indices:   &quot;); print_array_on(st, default_vtable_indices());
3577   }
3578   st-&gt;print(BULLET&quot;local interfaces:  &quot;); print_array_on(st, local_interfaces());
3579   st-&gt;print(BULLET&quot;trans. interfaces: &quot;); print_array_on(st, transitive_interfaces());
3580   st-&gt;print(BULLET&quot;constants:         &quot;); constants()-&gt;print_value_on(st);         st-&gt;cr();
3581   if (class_loader_data() != NULL) {
3582     st-&gt;print(BULLET&quot;class loader data:  &quot;);
3583     class_loader_data()-&gt;print_value_on(st);
3584     st-&gt;cr();
3585   }
3586   st-&gt;print(BULLET&quot;unsafe anonymous host class:        &quot;); Metadata::print_value_on_maybe_null(st, unsafe_anonymous_host()); st-&gt;cr();
3587   if (source_file_name() != NULL) {
3588     st-&gt;print(BULLET&quot;source file:       &quot;);
3589     source_file_name()-&gt;print_value_on(st);
3590     st-&gt;cr();
3591   }
3592   if (source_debug_extension() != NULL) {
3593     st-&gt;print(BULLET&quot;source debug extension:       &quot;);
3594     st-&gt;print(&quot;%s&quot;, source_debug_extension());
3595     st-&gt;cr();
3596   }
3597   st-&gt;print(BULLET&quot;class annotations:       &quot;); class_annotations()-&gt;print_value_on(st); st-&gt;cr();
3598   st-&gt;print(BULLET&quot;class type annotations:  &quot;); class_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3599   st-&gt;print(BULLET&quot;field annotations:       &quot;); fields_annotations()-&gt;print_value_on(st); st-&gt;cr();
3600   st-&gt;print(BULLET&quot;field type annotations:  &quot;); fields_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3601   {
3602     bool have_pv = false;
3603     // previous versions are linked together through the InstanceKlass
3604     for (InstanceKlass* pv_node = previous_versions();
3605          pv_node != NULL;
3606          pv_node = pv_node-&gt;previous_versions()) {
3607       if (!have_pv)
3608         st-&gt;print(BULLET&quot;previous version:  &quot;);
3609       have_pv = true;
3610       pv_node-&gt;constants()-&gt;print_value_on(st);
3611     }
3612     if (have_pv) st-&gt;cr();
3613   }
3614 
3615   if (generic_signature() != NULL) {
3616     st-&gt;print(BULLET&quot;generic signature: &quot;);
3617     generic_signature()-&gt;print_value_on(st);
3618     st-&gt;cr();
3619   }
3620   st-&gt;print(BULLET&quot;inner classes:     &quot;); inner_classes()-&gt;print_value_on(st);     st-&gt;cr();
3621   st-&gt;print(BULLET&quot;nest members:     &quot;); nest_members()-&gt;print_value_on(st);     st-&gt;cr();
3622   if (record_components() != NULL) {
3623     st-&gt;print(BULLET&quot;record components:     &quot;); record_components()-&gt;print_value_on(st);     st-&gt;cr();
3624   }
3625   st-&gt;print(BULLET&quot;permitted subclasses:     &quot;); permitted_subclasses()-&gt;print_value_on(st);     st-&gt;cr();
3626   if (java_mirror() != NULL) {
3627     st-&gt;print(BULLET&quot;java mirror:       &quot;);
3628     java_mirror()-&gt;print_value_on(st);
3629     st-&gt;cr();
3630   } else {
3631     st-&gt;print_cr(BULLET&quot;java mirror:       NULL&quot;);
3632   }
3633   st-&gt;print(BULLET&quot;vtable length      %d  (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, vtable_length(), p2i(start_of_vtable())); st-&gt;cr();
3634   if (vtable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_vtable(), vtable_length(), st);
3635   st-&gt;print(BULLET&quot;itable length      %d (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, itable_length(), p2i(start_of_itable())); st-&gt;cr();
3636   if (itable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(NULL, start_of_itable(), itable_length(), st);
3637   st-&gt;print_cr(BULLET&quot;---- static fields (%d words):&quot;, static_field_size());
3638   FieldPrinter print_static_field(st);
3639   ((InstanceKlass*)this)-&gt;do_local_static_fields(&amp;print_static_field);
3640   st-&gt;print_cr(BULLET&quot;---- non-static fields (%d words):&quot;, nonstatic_field_size());
3641   FieldPrinter print_nonstatic_field(st);
3642   InstanceKlass* ik = const_cast&lt;InstanceKlass*&gt;(this);
3643   ik-&gt;do_nonstatic_fields(&amp;print_nonstatic_field);
3644 
3645   st-&gt;print(BULLET&quot;non-static oop maps: &quot;);
3646   OopMapBlock* map     = start_of_nonstatic_oop_maps();
3647   OopMapBlock* end_map = map + nonstatic_oop_map_count();
3648   while (map &lt; end_map) {
3649     st-&gt;print(&quot;%d-%d &quot;, map-&gt;offset(), map-&gt;offset() + heapOopSize*(map-&gt;count() - 1));
3650     map++;
3651   }
3652   st-&gt;cr();
3653 }
3654 
3655 #endif //PRODUCT
3656 
3657 void InstanceKlass::print_value_on(outputStream* st) const {
3658   assert(is_klass(), &quot;must be klass&quot;);
3659   if (Verbose || WizardMode)  access_flags().print_on(st);
3660   name()-&gt;print_value_on(st);
3661 }
3662 
3663 #ifndef PRODUCT
3664 
3665 void FieldPrinter::do_field(fieldDescriptor* fd) {
3666   _st-&gt;print(BULLET);
3667    if (_obj == NULL) {
3668      fd-&gt;print_on(_st);
3669      _st-&gt;cr();
3670    } else {
3671      fd-&gt;print_on_for(_st, _obj);
3672      _st-&gt;cr();
3673    }
3674 }
3675 
3676 
3677 void InstanceKlass::oop_print_on(oop obj, outputStream* st) {
3678   Klass::oop_print_on(obj, st);
3679 
3680   if (this == SystemDictionary::String_klass()) {
3681     typeArrayOop value  = java_lang_String::value(obj);
3682     juint        length = java_lang_String::length(obj);
3683     if (value != NULL &amp;&amp;
3684         value-&gt;is_typeArray() &amp;&amp;
3685         length &lt;= (juint) value-&gt;length()) {
3686       st-&gt;print(BULLET&quot;string: &quot;);
3687       java_lang_String::print(obj, st);
3688       st-&gt;cr();
3689       if (!WizardMode)  return;  // that is enough
3690     }
3691   }
3692 
3693   st-&gt;print_cr(BULLET&quot;---- fields (total size %d words):&quot;, oop_size(obj));
3694   FieldPrinter print_field(st, obj);
3695   do_nonstatic_fields(&amp;print_field);
3696 
3697   if (this == SystemDictionary::Class_klass()) {
3698     st-&gt;print(BULLET&quot;signature: &quot;);
3699     java_lang_Class::print_signature(obj, st);
3700     st-&gt;cr();
3701     Klass* mirrored_klass = java_lang_Class::as_Klass(obj);
3702     st-&gt;print(BULLET&quot;fake entry for mirror: &quot;);
3703     Metadata::print_value_on_maybe_null(st, mirrored_klass);
3704     st-&gt;cr();
3705     Klass* array_klass = java_lang_Class::array_klass_acquire(obj);
3706     st-&gt;print(BULLET&quot;fake entry for array: &quot;);
3707     Metadata::print_value_on_maybe_null(st, array_klass);
3708     st-&gt;cr();
3709     st-&gt;print_cr(BULLET&quot;fake entry for oop_size: %d&quot;, java_lang_Class::oop_size(obj));
3710     st-&gt;print_cr(BULLET&quot;fake entry for static_oop_field_count: %d&quot;, java_lang_Class::static_oop_field_count(obj));
3711     Klass* real_klass = java_lang_Class::as_Klass(obj);
3712     if (real_klass != NULL &amp;&amp; real_klass-&gt;is_instance_klass()) {
3713       InstanceKlass::cast(real_klass)-&gt;do_local_static_fields(&amp;print_field);
3714     }
3715   } else if (this == SystemDictionary::MethodType_klass()) {
3716     st-&gt;print(BULLET&quot;signature: &quot;);
3717     java_lang_invoke_MethodType::print_signature(obj, st);
3718     st-&gt;cr();
3719   }
3720 }
3721 
3722 bool InstanceKlass::verify_itable_index(int i) {
3723   int method_count = klassItable::method_count_for_interface(this);
3724   assert(i &gt;= 0 &amp;&amp; i &lt; method_count, &quot;index out of bounds&quot;);
3725   return true;
3726 }
3727 
3728 #endif //PRODUCT
3729 
3730 void InstanceKlass::oop_print_value_on(oop obj, outputStream* st) {
3731   st-&gt;print(&quot;a &quot;);
3732   name()-&gt;print_value_on(st);
3733   obj-&gt;print_address_on(st);
3734   if (this == SystemDictionary::String_klass()
3735       &amp;&amp; java_lang_String::value(obj) != NULL) {
3736     ResourceMark rm;
3737     int len = java_lang_String::length(obj);
3738     int plen = (len &lt; 24 ? len : 12);
3739     char* str = java_lang_String::as_utf8_string(obj, 0, plen);
3740     st-&gt;print(&quot; = \&quot;%s\&quot;&quot;, str);
3741     if (len &gt; plen)
3742       st-&gt;print(&quot;...[%d]&quot;, len);
3743   } else if (this == SystemDictionary::Class_klass()) {
3744     Klass* k = java_lang_Class::as_Klass(obj);
3745     st-&gt;print(&quot; = &quot;);
3746     if (k != NULL) {
3747       k-&gt;print_value_on(st);
3748     } else {
3749       const char* tname = type2name(java_lang_Class::primitive_type(obj));
3750       st-&gt;print(&quot;%s&quot;, tname ? tname : &quot;type?&quot;);
3751     }
3752   } else if (this == SystemDictionary::MethodType_klass()) {
3753     st-&gt;print(&quot; = &quot;);
3754     java_lang_invoke_MethodType::print_signature(obj, st);
3755   } else if (java_lang_boxing_object::is_instance(obj)) {
3756     st-&gt;print(&quot; = &quot;);
3757     java_lang_boxing_object::print(obj, st);
3758   } else if (this == SystemDictionary::LambdaForm_klass()) {
3759     oop vmentry = java_lang_invoke_LambdaForm::vmentry(obj);
3760     if (vmentry != NULL) {
3761       st-&gt;print(&quot; =&gt; &quot;);
3762       vmentry-&gt;print_value_on(st);
3763     }
3764   } else if (this == SystemDictionary::MemberName_klass()) {
3765     Metadata* vmtarget = java_lang_invoke_MemberName::vmtarget(obj);
3766     if (vmtarget != NULL) {
3767       st-&gt;print(&quot; = &quot;);
3768       vmtarget-&gt;print_value_on(st);
3769     } else {
3770       java_lang_invoke_MemberName::clazz(obj)-&gt;print_value_on(st);
3771       st-&gt;print(&quot;.&quot;);
3772       java_lang_invoke_MemberName::name(obj)-&gt;print_value_on(st);
3773     }
3774   }
3775 }
3776 
3777 const char* InstanceKlass::internal_name() const {
3778   return external_name();
3779 }
3780 
3781 void InstanceKlass::print_class_load_logging(ClassLoaderData* loader_data,
3782                                              const char* module_name,
3783                                              const ClassFileStream* cfs) const {
3784   if (!log_is_enabled(Info, class, load)) {
3785     return;
3786   }
3787 
3788   ResourceMark rm;
3789   LogMessage(class, load) msg;
3790   stringStream info_stream;
3791 
3792   // Name and class hierarchy info
3793   info_stream.print(&quot;%s&quot;, external_name());
3794 
3795   // Source
3796   if (cfs != NULL) {
3797     if (cfs-&gt;source() != NULL) {
3798       if (module_name != NULL) {
3799         // When the boot loader created the stream, it didn&#39;t know the module name
3800         // yet. Let&#39;s format it now.
3801         if (cfs-&gt;from_boot_loader_modules_image()) {
3802           info_stream.print(&quot; source: jrt:/%s&quot;, module_name);
3803         } else {
3804           info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3805         }
3806       } else {
3807         info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3808       }
3809     } else if (loader_data == ClassLoaderData::the_null_class_loader_data()) {
3810       Thread* THREAD = Thread::current();
3811       Klass* caller =
3812             THREAD-&gt;is_Java_thread()
3813                 ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(1)
3814                 : NULL;
3815       // caller can be NULL, for example, during a JVMTI VM_Init hook
3816       if (caller != NULL) {
3817         info_stream.print(&quot; source: instance of %s&quot;, caller-&gt;external_name());
3818       } else {
3819         // source is unknown
3820       }
3821     } else {
3822       oop class_loader = loader_data-&gt;class_loader();
3823       info_stream.print(&quot; source: %s&quot;, class_loader-&gt;klass()-&gt;external_name());
3824     }
3825   } else {
3826     assert(this-&gt;is_shared(), &quot;must be&quot;);
3827     if (MetaspaceShared::is_shared_dynamic((void*)this)) {
3828       info_stream.print(&quot; source: shared objects file (top)&quot;);
3829     } else {
3830       info_stream.print(&quot; source: shared objects file&quot;);
3831     }
3832   }
3833 
3834   msg.info(&quot;%s&quot;, info_stream.as_string());
3835 
3836   if (log_is_enabled(Debug, class, load)) {
3837     stringStream debug_stream;
3838 
3839     // Class hierarchy info
3840     debug_stream.print(&quot; klass: &quot; INTPTR_FORMAT &quot; super: &quot; INTPTR_FORMAT,
3841                        p2i(this),  p2i(superklass()));
3842 
3843     // Interfaces
3844     if (local_interfaces() != NULL &amp;&amp; local_interfaces()-&gt;length() &gt; 0) {
3845       debug_stream.print(&quot; interfaces:&quot;);
3846       int length = local_interfaces()-&gt;length();
3847       for (int i = 0; i &lt; length; i++) {
3848         debug_stream.print(&quot; &quot; INTPTR_FORMAT,
3849                            p2i(InstanceKlass::cast(local_interfaces()-&gt;at(i))));
3850       }
3851     }
3852 
3853     // Class loader
3854     debug_stream.print(&quot; loader: [&quot;);
3855     loader_data-&gt;print_value_on(&amp;debug_stream);
3856     debug_stream.print(&quot;]&quot;);
3857 
3858     // Classfile checksum
3859     if (cfs) {
3860       debug_stream.print(&quot; bytes: %d checksum: %08x&quot;,
3861                          cfs-&gt;length(),
3862                          ClassLoader::crc32(0, (const char*)cfs-&gt;buffer(),
3863                          cfs-&gt;length()));
3864     }
3865 
3866     msg.debug(&quot;%s&quot;, debug_stream.as_string());
3867   }
3868 }
3869 
3870 // Verification
3871 
3872 class VerifyFieldClosure: public BasicOopIterateClosure {
3873  protected:
3874   template &lt;class T&gt; void do_oop_work(T* p) {
3875     oop obj = RawAccess&lt;&gt;::oop_load(p);
3876     if (!oopDesc::is_oop_or_null(obj)) {
3877       tty-&gt;print_cr(&quot;Failed: &quot; PTR_FORMAT &quot; -&gt; &quot; PTR_FORMAT, p2i(p), p2i(obj));
3878       Universe::print_on(tty);
3879       guarantee(false, &quot;boom&quot;);
3880     }
3881   }
3882  public:
3883   virtual void do_oop(oop* p)       { VerifyFieldClosure::do_oop_work(p); }
3884   virtual void do_oop(narrowOop* p) { VerifyFieldClosure::do_oop_work(p); }
3885 };
3886 
3887 void InstanceKlass::verify_on(outputStream* st) {
3888 #ifndef PRODUCT
3889   // Avoid redundant verifies, this really should be in product.
3890   if (_verify_count == Universe::verify_count()) return;
3891   _verify_count = Universe::verify_count();
3892 #endif
3893 
3894   // Verify Klass
3895   Klass::verify_on(st);
3896 
3897   // Verify that klass is present in ClassLoaderData
3898   guarantee(class_loader_data()-&gt;contains_klass(this),
3899             &quot;this class isn&#39;t found in class loader data&quot;);
3900 
3901   // Verify vtables
3902   if (is_linked()) {
3903     // $$$ This used to be done only for m/s collections.  Doing it
3904     // always seemed a valid generalization.  (DLD -- 6/00)
3905     vtable().verify(st);
3906   }
3907 
3908   // Verify first subklass
3909   if (subklass() != NULL) {
3910     guarantee(subklass()-&gt;is_klass(), &quot;should be klass&quot;);
3911   }
3912 
3913   // Verify siblings
3914   Klass* super = this-&gt;super();
3915   Klass* sib = next_sibling();
3916   if (sib != NULL) {
3917     if (sib == this) {
3918       fatal(&quot;subclass points to itself &quot; PTR_FORMAT, p2i(sib));
3919     }
3920 
3921     guarantee(sib-&gt;is_klass(), &quot;should be klass&quot;);
3922     guarantee(sib-&gt;super() == super, &quot;siblings should have same superklass&quot;);
3923   }
3924 
3925   // Verify local interfaces
3926   if (local_interfaces()) {
3927     Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
3928     for (int j = 0; j &lt; local_interfaces-&gt;length(); j++) {
3929       InstanceKlass* e = local_interfaces-&gt;at(j);
3930       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid local interface&quot;);
3931     }
3932   }
3933 
3934   // Verify transitive interfaces
3935   if (transitive_interfaces() != NULL) {
3936     Array&lt;InstanceKlass*&gt;* transitive_interfaces = this-&gt;transitive_interfaces();
3937     for (int j = 0; j &lt; transitive_interfaces-&gt;length(); j++) {
3938       InstanceKlass* e = transitive_interfaces-&gt;at(j);
3939       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid transitive interface&quot;);
3940     }
3941   }
3942 
3943   // Verify methods
3944   if (methods() != NULL) {
3945     Array&lt;Method*&gt;* methods = this-&gt;methods();
3946     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3947       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3948     }
3949     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3950       Method* m1 = methods-&gt;at(j);
3951       Method* m2 = methods-&gt;at(j + 1);
3952       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3953     }
3954   }
3955 
3956   // Verify method ordering
3957   if (method_ordering() != NULL) {
3958     Array&lt;int&gt;* method_ordering = this-&gt;method_ordering();
3959     int length = method_ordering-&gt;length();
3960     if (JvmtiExport::can_maintain_original_method_order() ||
3961         ((UseSharedSpaces || Arguments::is_dumping_archive()) &amp;&amp; length != 0)) {
3962       guarantee(length == methods()-&gt;length(), &quot;invalid method ordering length&quot;);
3963       jlong sum = 0;
3964       for (int j = 0; j &lt; length; j++) {
3965         int original_index = method_ordering-&gt;at(j);
3966         guarantee(original_index &gt;= 0, &quot;invalid method ordering index&quot;);
3967         guarantee(original_index &lt; length, &quot;invalid method ordering index&quot;);
3968         sum += original_index;
3969       }
3970       // Verify sum of indices 0,1,...,length-1
3971       guarantee(sum == ((jlong)length*(length-1))/2, &quot;invalid method ordering sum&quot;);
3972     } else {
3973       guarantee(length == 0, &quot;invalid method ordering length&quot;);
3974     }
3975   }
3976 
3977   // Verify default methods
3978   if (default_methods() != NULL) {
3979     Array&lt;Method*&gt;* methods = this-&gt;default_methods();
3980     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3981       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3982     }
3983     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3984       Method* m1 = methods-&gt;at(j);
3985       Method* m2 = methods-&gt;at(j + 1);
3986       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3987     }
3988   }
3989 
3990   // Verify JNI static field identifiers
3991   if (jni_ids() != NULL) {
3992     jni_ids()-&gt;verify(this);
3993   }
3994 
3995   // Verify other fields
3996   if (constants() != NULL) {
3997     guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
3998   }
3999   const Klass* anonymous_host = unsafe_anonymous_host();
4000   if (anonymous_host != NULL) {
4001     guarantee(anonymous_host-&gt;is_klass(), &quot;should be klass&quot;);
4002   }
4003 }
4004 
4005 void InstanceKlass::oop_verify_on(oop obj, outputStream* st) {
4006   Klass::oop_verify_on(obj, st);
4007   VerifyFieldClosure blk;
4008   obj-&gt;oop_iterate(&amp;blk);
4009 }
4010 
4011 
4012 // JNIid class for jfieldIDs only
4013 // Note to reviewers:
4014 // These JNI functions are just moved over to column 1 and not changed
4015 // in the compressed oops workspace.
4016 JNIid::JNIid(Klass* holder, int offset, JNIid* next) {
4017   _holder = holder;
4018   _offset = offset;
4019   _next = next;
4020   debug_only(_is_static_field_id = false;)
4021 }
4022 
4023 
4024 JNIid* JNIid::find(int offset) {
4025   JNIid* current = this;
4026   while (current != NULL) {
4027     if (current-&gt;offset() == offset) return current;
4028     current = current-&gt;next();
4029   }
4030   return NULL;
4031 }
4032 
4033 void JNIid::deallocate(JNIid* current) {
4034   while (current != NULL) {
4035     JNIid* next = current-&gt;next();
4036     delete current;
4037     current = next;
4038   }
4039 }
4040 
4041 
4042 void JNIid::verify(Klass* holder) {
4043   int first_field_offset  = InstanceMirrorKlass::offset_of_static_fields();
4044   int end_field_offset;
4045   end_field_offset = first_field_offset + (InstanceKlass::cast(holder)-&gt;static_field_size() * wordSize);
4046 
4047   JNIid* current = this;
4048   while (current != NULL) {
4049     guarantee(current-&gt;holder() == holder, &quot;Invalid klass in JNIid&quot;);
4050 #ifdef ASSERT
4051     int o = current-&gt;offset();
4052     if (current-&gt;is_static_field_id()) {
4053       guarantee(o &gt;= first_field_offset  &amp;&amp; o &lt; end_field_offset,  &quot;Invalid static field offset in JNIid&quot;);
4054     }
4055 #endif
4056     current = current-&gt;next();
4057   }
4058 }
4059 
4060 void InstanceKlass::set_init_state(ClassState state) {
4061 #ifdef ASSERT
4062   bool good_state = is_shared() ? (_init_state &lt;= state)
4063                                                : (_init_state &lt; state);
4064   assert(good_state || state == allocated, &quot;illegal state transition&quot;);
4065 #endif
4066   assert(_init_thread == NULL, &quot;should be cleared before state change&quot;);
4067   _init_state = (u1)state;
4068 }
4069 
4070 #if INCLUDE_JVMTI
4071 
4072 // RedefineClasses() support for previous versions
4073 
4074 // Globally, there is at least one previous version of a class to walk
4075 // during class unloading, which is saved because old methods in the class
4076 // are still running.   Otherwise the previous version list is cleaned up.
4077 bool InstanceKlass::_has_previous_versions = false;
4078 
4079 // Returns true if there are previous versions of a class for class
4080 // unloading only. Also resets the flag to false. purge_previous_version
4081 // will set the flag to true if there are any left, i.e., if there&#39;s any
4082 // work to do for next time. This is to avoid the expensive code cache
4083 // walk in CLDG::clean_deallocate_lists().
4084 bool InstanceKlass::has_previous_versions_and_reset() {
4085   bool ret = _has_previous_versions;
4086   log_trace(redefine, class, iklass, purge)(&quot;Class unloading: has_previous_versions = %s&quot;,
4087      ret ? &quot;true&quot; : &quot;false&quot;);
4088   _has_previous_versions = false;
4089   return ret;
4090 }
4091 
4092 // Purge previous versions before adding new previous versions of the class and
4093 // during class unloading.
4094 void InstanceKlass::purge_previous_version_list() {
4095   assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
4096   assert(has_been_redefined(), &quot;Should only be called for main class&quot;);
4097 
4098   // Quick exit.
4099   if (previous_versions() == NULL) {
4100     return;
4101   }
4102 
4103   // This klass has previous versions so see what we can cleanup
4104   // while it is safe to do so.
4105 
4106   int deleted_count = 0;    // leave debugging breadcrumbs
4107   int live_count = 0;
4108   ClassLoaderData* loader_data = class_loader_data();
4109   assert(loader_data != NULL, &quot;should never be null&quot;);
4110 
4111   ResourceMark rm;
4112   log_trace(redefine, class, iklass, purge)(&quot;%s: previous versions&quot;, external_name());
4113 
4114   // previous versions are linked together through the InstanceKlass
4115   InstanceKlass* pv_node = previous_versions();
4116   InstanceKlass* last = this;
4117   int version = 0;
4118 
4119   // check the previous versions list
4120   for (; pv_node != NULL; ) {
4121 
4122     ConstantPool* pvcp = pv_node-&gt;constants();
4123     assert(pvcp != NULL, &quot;cp ref was unexpectedly cleared&quot;);
4124 
4125     if (!pvcp-&gt;on_stack()) {
4126       // If the constant pool isn&#39;t on stack, none of the methods
4127       // are executing.  Unlink this previous_version.
4128       // The previous version InstanceKlass is on the ClassLoaderData deallocate list
4129       // so will be deallocated during the next phase of class unloading.
4130       log_trace(redefine, class, iklass, purge)
4131         (&quot;previous version &quot; INTPTR_FORMAT &quot; is dead.&quot;, p2i(pv_node));
4132       // For debugging purposes.
4133       pv_node-&gt;set_is_scratch_class();
4134       // Unlink from previous version list.
4135       assert(pv_node-&gt;class_loader_data() == loader_data, &quot;wrong loader_data&quot;);
4136       InstanceKlass* next = pv_node-&gt;previous_versions();
4137       pv_node-&gt;link_previous_versions(NULL);   // point next to NULL
4138       last-&gt;link_previous_versions(next);
4139       // Add to the deallocate list after unlinking
4140       loader_data-&gt;add_to_deallocate_list(pv_node);
4141       pv_node = next;
4142       deleted_count++;
4143       version++;
4144       continue;
4145     } else {
4146       log_trace(redefine, class, iklass, purge)(&quot;previous version &quot; INTPTR_FORMAT &quot; is alive&quot;, p2i(pv_node));
4147       assert(pvcp-&gt;pool_holder() != NULL, &quot;Constant pool with no holder&quot;);
4148       guarantee (!loader_data-&gt;is_unloading(), &quot;unloaded classes can&#39;t be on the stack&quot;);
4149       live_count++;
4150       // found a previous version for next time we do class unloading
4151       _has_previous_versions = true;
4152     }
4153 
4154     // At least one method is live in this previous version.
4155     // Reset dead EMCP methods not to get breakpoints.
4156     // All methods are deallocated when all of the methods for this class are no
4157     // longer running.
4158     Array&lt;Method*&gt;* method_refs = pv_node-&gt;methods();
4159     if (method_refs != NULL) {
4160       log_trace(redefine, class, iklass, purge)(&quot;previous methods length=%d&quot;, method_refs-&gt;length());
4161       for (int j = 0; j &lt; method_refs-&gt;length(); j++) {
4162         Method* method = method_refs-&gt;at(j);
4163 
4164         if (!method-&gt;on_stack()) {
4165           // no breakpoints for non-running methods
4166           if (method-&gt;is_running_emcp()) {
4167             method-&gt;set_running_emcp(false);
4168           }
4169         } else {
4170           assert (method-&gt;is_obsolete() || method-&gt;is_running_emcp(),
4171                   &quot;emcp method cannot run after emcp bit is cleared&quot;);
4172           log_trace(redefine, class, iklass, purge)
4173             (&quot;purge: %s(%s): prev method @%d in version @%d is alive&quot;,
4174              method-&gt;name()-&gt;as_C_string(), method-&gt;signature()-&gt;as_C_string(), j, version);
4175         }
4176       }
4177     }
4178     // next previous version
4179     last = pv_node;
4180     pv_node = pv_node-&gt;previous_versions();
4181     version++;
4182   }
4183   log_trace(redefine, class, iklass, purge)
4184     (&quot;previous version stats: live=%d, deleted=%d&quot;, live_count, deleted_count);
4185 }
4186 
4187 void InstanceKlass::mark_newly_obsolete_methods(Array&lt;Method*&gt;* old_methods,
4188                                                 int emcp_method_count) {
4189   int obsolete_method_count = old_methods-&gt;length() - emcp_method_count;
4190 
4191   if (emcp_method_count != 0 &amp;&amp; obsolete_method_count != 0 &amp;&amp;
4192       _previous_versions != NULL) {
4193     // We have a mix of obsolete and EMCP methods so we have to
4194     // clear out any matching EMCP method entries the hard way.
4195     int local_count = 0;
4196     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
4197       Method* old_method = old_methods-&gt;at(i);
4198       if (old_method-&gt;is_obsolete()) {
4199         // only obsolete methods are interesting
4200         Symbol* m_name = old_method-&gt;name();
4201         Symbol* m_signature = old_method-&gt;signature();
4202 
4203         // previous versions are linked together through the InstanceKlass
4204         int j = 0;
4205         for (InstanceKlass* prev_version = _previous_versions;
4206              prev_version != NULL;
4207              prev_version = prev_version-&gt;previous_versions(), j++) {
4208 
4209           Array&lt;Method*&gt;* method_refs = prev_version-&gt;methods();
4210           for (int k = 0; k &lt; method_refs-&gt;length(); k++) {
4211             Method* method = method_refs-&gt;at(k);
4212 
4213             if (!method-&gt;is_obsolete() &amp;&amp;
4214                 method-&gt;name() == m_name &amp;&amp;
4215                 method-&gt;signature() == m_signature) {
4216               // The current RedefineClasses() call has made all EMCP
4217               // versions of this method obsolete so mark it as obsolete
4218               log_trace(redefine, class, iklass, add)
4219                 (&quot;%s(%s): flush obsolete method @%d in version @%d&quot;,
4220                  m_name-&gt;as_C_string(), m_signature-&gt;as_C_string(), k, j);
4221 
4222               method-&gt;set_is_obsolete();
4223               break;
4224             }
4225           }
4226 
4227           // The previous loop may not find a matching EMCP method, but
4228           // that doesn&#39;t mean that we can optimize and not go any
4229           // further back in the PreviousVersion generations. The EMCP
4230           // method for this generation could have already been made obsolete,
4231           // but there still may be an older EMCP method that has not
4232           // been made obsolete.
4233         }
4234 
4235         if (++local_count &gt;= obsolete_method_count) {
4236           // no more obsolete methods so bail out now
4237           break;
4238         }
4239       }
4240     }
4241   }
4242 }
4243 
4244 // Save the scratch_class as the previous version if any of the methods are running.
4245 // The previous_versions are used to set breakpoints in EMCP methods and they are
4246 // also used to clean MethodData links to redefined methods that are no longer running.
4247 void InstanceKlass::add_previous_version(InstanceKlass* scratch_class,
4248                                          int emcp_method_count) {
4249   assert(Thread::current()-&gt;is_VM_thread(),
4250          &quot;only VMThread can add previous versions&quot;);
4251 
4252   ResourceMark rm;
4253   log_trace(redefine, class, iklass, add)
4254     (&quot;adding previous version ref for %s, EMCP_cnt=%d&quot;, scratch_class-&gt;external_name(), emcp_method_count);
4255 
4256   // Clean out old previous versions for this class
4257   purge_previous_version_list();
4258 
4259   // Mark newly obsolete methods in remaining previous versions.  An EMCP method from
4260   // a previous redefinition may be made obsolete by this redefinition.
4261   Array&lt;Method*&gt;* old_methods = scratch_class-&gt;methods();
4262   mark_newly_obsolete_methods(old_methods, emcp_method_count);
4263 
4264   // If the constant pool for this previous version of the class
4265   // is not marked as being on the stack, then none of the methods
4266   // in this previous version of the class are on the stack so
4267   // we don&#39;t need to add this as a previous version.
4268   ConstantPool* cp_ref = scratch_class-&gt;constants();
4269   if (!cp_ref-&gt;on_stack()) {
4270     log_trace(redefine, class, iklass, add)(&quot;scratch class not added; no methods are running&quot;);
4271     // For debugging purposes.
4272     scratch_class-&gt;set_is_scratch_class();
4273     scratch_class-&gt;class_loader_data()-&gt;add_to_deallocate_list(scratch_class);
4274     return;
4275   }
4276 
4277   if (emcp_method_count != 0) {
4278     // At least one method is still running, check for EMCP methods
4279     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
4280       Method* old_method = old_methods-&gt;at(i);
4281       if (!old_method-&gt;is_obsolete() &amp;&amp; old_method-&gt;on_stack()) {
4282         // if EMCP method (not obsolete) is on the stack, mark as EMCP so that
4283         // we can add breakpoints for it.
4284 
4285         // We set the method-&gt;on_stack bit during safepoints for class redefinition
4286         // and use this bit to set the is_running_emcp bit.
4287         // After the safepoint, the on_stack bit is cleared and the running emcp
4288         // method may exit.   If so, we would set a breakpoint in a method that
4289         // is never reached, but this won&#39;t be noticeable to the programmer.
4290         old_method-&gt;set_running_emcp(true);
4291         log_trace(redefine, class, iklass, add)
4292           (&quot;EMCP method %s is on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4293       } else if (!old_method-&gt;is_obsolete()) {
4294         log_trace(redefine, class, iklass, add)
4295           (&quot;EMCP method %s is NOT on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
4296       }
4297     }
4298   }
4299 
4300   // Add previous version if any methods are still running.
4301   // Set has_previous_version flag for processing during class unloading.
4302   _has_previous_versions = true;
4303   log_trace(redefine, class, iklass, add) (&quot;scratch class added; one of its methods is on_stack.&quot;);
4304   assert(scratch_class-&gt;previous_versions() == NULL, &quot;shouldn&#39;t have a previous version&quot;);
4305   scratch_class-&gt;link_previous_versions(previous_versions());
4306   link_previous_versions(scratch_class);
4307 } // end add_previous_version()
4308 
4309 #endif // INCLUDE_JVMTI
4310 
4311 Method* InstanceKlass::method_with_idnum(int idnum) {
4312   Method* m = NULL;
4313   if (idnum &lt; methods()-&gt;length()) {
4314     m = methods()-&gt;at(idnum);
4315   }
4316   if (m == NULL || m-&gt;method_idnum() != idnum) {
4317     for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4318       m = methods()-&gt;at(index);
4319       if (m-&gt;method_idnum() == idnum) {
4320         return m;
4321       }
4322     }
4323     // None found, return null for the caller to handle.
4324     return NULL;
4325   }
4326   return m;
4327 }
4328 
4329 
4330 Method* InstanceKlass::method_with_orig_idnum(int idnum) {
4331   if (idnum &gt;= methods()-&gt;length()) {
4332     return NULL;
4333   }
4334   Method* m = methods()-&gt;at(idnum);
4335   if (m != NULL &amp;&amp; m-&gt;orig_method_idnum() == idnum) {
4336     return m;
4337   }
4338   // Obsolete method idnum does not match the original idnum
4339   for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4340     m = methods()-&gt;at(index);
4341     if (m-&gt;orig_method_idnum() == idnum) {
4342       return m;
4343     }
4344   }
4345   // None found, return null for the caller to handle.
4346   return NULL;
4347 }
4348 
4349 
4350 Method* InstanceKlass::method_with_orig_idnum(int idnum, int version) {
4351   InstanceKlass* holder = get_klass_version(version);
4352   if (holder == NULL) {
4353     return NULL; // The version of klass is gone, no method is found
4354   }
4355   Method* method = holder-&gt;method_with_orig_idnum(idnum);
4356   return method;
4357 }
4358 
4359 #if INCLUDE_JVMTI
4360 JvmtiCachedClassFileData* InstanceKlass::get_cached_class_file() {
4361   return _cached_class_file;
4362 }
4363 
4364 jint InstanceKlass::get_cached_class_file_len() {
4365   return VM_RedefineClasses::get_cached_class_file_len(_cached_class_file);
4366 }
4367 
4368 unsigned char * InstanceKlass::get_cached_class_file_bytes() {
4369   return VM_RedefineClasses::get_cached_class_file_bytes(_cached_class_file);
4370 }
4371 #endif
4372 
4373 #define THROW_DVT_ERROR(s) \
4374   Exceptions::fthrow(THREAD_AND_LOCATION, vmSymbols::java_lang_IncompatibleClassChangeError(), \
4375       &quot;ValueCapableClass class &#39;%s&#39; %s&quot;, external_name(),(s)); \
4376       return
    </pre>
  </body>
</html>