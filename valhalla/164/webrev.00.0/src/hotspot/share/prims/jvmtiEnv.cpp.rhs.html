<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/prims/jvmtiEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderExt.hpp&quot;
  27 #include &quot;classfile/javaClasses.inline.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/modules.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
  34 #include &quot;jfr/jfrEvents.hpp&quot;
  35 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;logging/logConfiguration.hpp&quot;
  38 #include &quot;memory/resourceArea.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/instanceKlass.hpp&quot;
  41 #include &quot;oops/objArrayOop.inline.hpp&quot;
  42 #include &quot;oops/oop.inline.hpp&quot;
  43 #include &quot;prims/jniCheck.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  46 #include &quot;prims/jvmtiClassFileReconstituter.hpp&quot;
  47 #include &quot;prims/jvmtiCodeBlobEvents.hpp&quot;
  48 #include &quot;prims/jvmtiExtensions.hpp&quot;
  49 #include &quot;prims/jvmtiGetLoadedClasses.hpp&quot;
  50 #include &quot;prims/jvmtiImpl.hpp&quot;
  51 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  52 #include &quot;prims/jvmtiRawMonitor.hpp&quot;
  53 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  54 #include &quot;prims/jvmtiTagMap.hpp&quot;
  55 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  56 #include &quot;prims/jvmtiUtil.hpp&quot;
  57 #include &quot;runtime/arguments.hpp&quot;
  58 #include &quot;runtime/deoptimization.hpp&quot;
  59 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  60 #include &quot;runtime/handles.inline.hpp&quot;
  61 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  62 #include &quot;runtime/javaCalls.hpp&quot;
  63 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  64 #include &quot;runtime/jniHandles.inline.hpp&quot;
  65 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  66 #include &quot;runtime/osThread.hpp&quot;
  67 #include &quot;runtime/reflectionUtils.hpp&quot;
  68 #include &quot;runtime/signature.hpp&quot;
  69 #include &quot;runtime/thread.inline.hpp&quot;
  70 #include &quot;runtime/threadHeapSampler.hpp&quot;
  71 #include &quot;runtime/threadSMR.hpp&quot;
  72 #include &quot;runtime/timerTrace.hpp&quot;
  73 #include &quot;runtime/vframe.inline.hpp&quot;
  74 #include &quot;runtime/vmThread.hpp&quot;
  75 #include &quot;services/threadService.hpp&quot;
  76 #include &quot;utilities/exceptions.hpp&quot;
  77 #include &quot;utilities/preserveException.hpp&quot;
  78 #include &quot;utilities/utf8.hpp&quot;
  79 
  80 
  81 #define FIXLATER 0 // REMOVE this when completed.
  82 
  83  // FIXLATER: hook into JvmtiTrace
  84 #define TraceJVMTICalls false
  85 
  86 JvmtiEnv::JvmtiEnv(jint version) : JvmtiEnvBase(version) {
  87 }
  88 
  89 JvmtiEnv::~JvmtiEnv() {
  90 }
  91 
  92 JvmtiEnv*
  93 JvmtiEnv::create_a_jvmti(jint version) {
  94   return new JvmtiEnv(version);
  95 }
  96 
  97 // VM operation class to copy jni function table at safepoint.
  98 // More than one java threads or jvmti agents may be reading/
  99 // modifying jni function tables. To reduce the risk of bad
 100 // interaction b/w these threads it is copied at safepoint.
 101 class VM_JNIFunctionTableCopier : public VM_Operation {
 102  private:
 103   const struct JNINativeInterface_ *_function_table;
 104  public:
 105   VM_JNIFunctionTableCopier(const struct JNINativeInterface_ *func_tbl) {
 106     _function_table = func_tbl;
 107   };
 108 
 109   VMOp_Type type() const { return VMOp_JNIFunctionTableCopier; }
 110   void doit() {
 111     copy_jni_function_table(_function_table);
 112   };
 113 };
 114 
 115 //
 116 // Do not change the &quot;prefix&quot; marker below, everything above it is copied
 117 // unchanged into the filled stub, everything below is controlled by the
 118 // stub filler (only method bodies are carried forward, and then only for
 119 // functionality still in the spec).
 120 //
 121 // end file prefix
 122 
 123   //
 124   // Memory Management functions
 125   //
 126 
 127 // mem_ptr - pre-checked for NULL
 128 jvmtiError
 129 JvmtiEnv::Allocate(jlong size, unsigned char** mem_ptr) {
 130   return allocate(size, mem_ptr);
 131 } /* end Allocate */
 132 
 133 
 134 // mem - NULL is a valid value, must be checked
 135 jvmtiError
 136 JvmtiEnv::Deallocate(unsigned char* mem) {
 137   return deallocate(mem);
 138 } /* end Deallocate */
 139 
 140 // Threads_lock NOT held, java_thread not protected by lock
 141 // java_thread - pre-checked
 142 // data - NULL is a valid value, must be checked
 143 jvmtiError
 144 JvmtiEnv::SetThreadLocalStorage(JavaThread* java_thread, const void* data) {
 145   JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 146   if (state == NULL) {
 147     if (data == NULL) {
 148       // leaving state unset same as data set to NULL
 149       return JVMTI_ERROR_NONE;
 150     }
 151     // otherwise, create the state
 152     state = JvmtiThreadState::state_for(java_thread);
 153     if (state == NULL) {
 154       return JVMTI_ERROR_THREAD_NOT_ALIVE;
 155     }
 156   }
 157   state-&gt;env_thread_state(this)-&gt;set_agent_thread_local_storage_data((void*)data);
 158   return JVMTI_ERROR_NONE;
 159 } /* end SetThreadLocalStorage */
 160 
 161 
 162 // Threads_lock NOT held
 163 // thread - NOT pre-checked
 164 // data_ptr - pre-checked for NULL
 165 jvmtiError
 166 JvmtiEnv::GetThreadLocalStorage(jthread thread, void** data_ptr) {
 167   JavaThread* current_thread = JavaThread::current();
 168   if (thread == NULL) {
 169     JvmtiThreadState* state = current_thread-&gt;jvmti_thread_state();
 170     *data_ptr = (state == NULL) ? NULL :
 171       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 172   } else {
 173     // jvmti_GetThreadLocalStorage is &quot;in native&quot; and doesn&#39;t transition
 174     // the thread to _thread_in_vm. However, when the TLS for a thread
 175     // other than the current thread is required we need to transition
 176     // from native so as to resolve the jthread.
 177 
 178     ThreadInVMfromNative __tiv(current_thread);
 179     VM_ENTRY_BASE(jvmtiError, JvmtiEnv::GetThreadLocalStorage , current_thread)
 180     debug_only(VMNativeEntryWrapper __vew;)
 181 
 182     JavaThread* java_thread = NULL;
 183     ThreadsListHandle tlh(current_thread);
 184     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
 185     if (err != JVMTI_ERROR_NONE) {
 186       return err;
 187     }
 188 
 189     JvmtiThreadState* state = java_thread-&gt;jvmti_thread_state();
 190     *data_ptr = (state == NULL) ? NULL :
 191       state-&gt;env_thread_state(this)-&gt;get_agent_thread_local_storage_data();
 192   }
 193   return JVMTI_ERROR_NONE;
 194 } /* end GetThreadLocalStorage */
 195 
 196   //
 197   // Module functions
 198   //
 199 
 200 // module_count_ptr - pre-checked for NULL
 201 // modules_ptr - pre-checked for NULL
 202 jvmtiError
 203 JvmtiEnv::GetAllModules(jint* module_count_ptr, jobject** modules_ptr) {
 204     JvmtiModuleClosure jmc;
 205 
 206     return jmc.get_all_modules(this, module_count_ptr, modules_ptr);
 207 } /* end GetAllModules */
 208 
 209 
 210 // class_loader - NULL is a valid value, must be pre-checked
 211 // package_name - pre-checked for NULL
 212 // module_ptr - pre-checked for NULL
 213 jvmtiError
 214 JvmtiEnv::GetNamedModule(jobject class_loader, const char* package_name, jobject* module_ptr) {
 215   JavaThread* THREAD = JavaThread::current(); // pass to macros
 216   ResourceMark rm(THREAD);
 217   Handle h_loader (THREAD, JNIHandles::resolve(class_loader));
 218   // Check that loader is a subclass of java.lang.ClassLoader.
 219   if (h_loader.not_null() &amp;&amp; !java_lang_ClassLoader::is_subclass(h_loader-&gt;klass())) {
 220     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 221   }
 222   jobject module = Modules::get_named_module(h_loader, package_name, THREAD);
 223   if (HAS_PENDING_EXCEPTION) {
 224     CLEAR_PENDING_EXCEPTION;
 225     return JVMTI_ERROR_INTERNAL; // unexpected exception
 226   }
 227   *module_ptr = module;
 228   return JVMTI_ERROR_NONE;
 229 } /* end GetNamedModule */
 230 
 231 
 232 // module - pre-checked for NULL
 233 // to_module - pre-checked for NULL
 234 jvmtiError
 235 JvmtiEnv::AddModuleReads(jobject module, jobject to_module) {
 236   JavaThread* THREAD = JavaThread::current();
 237 
 238   // check module
 239   Handle h_module(THREAD, JNIHandles::resolve(module));
 240   if (!java_lang_Module::is_instance(h_module())) {
 241     return JVMTI_ERROR_INVALID_MODULE;
 242   }
 243   // check to_module
 244   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 245   if (!java_lang_Module::is_instance(h_to_module())) {
 246     return JVMTI_ERROR_INVALID_MODULE;
 247   }
 248   return JvmtiExport::add_module_reads(h_module, h_to_module, THREAD);
 249 } /* end AddModuleReads */
 250 
 251 
 252 // module - pre-checked for NULL
 253 // pkg_name - pre-checked for NULL
 254 // to_module - pre-checked for NULL
 255 jvmtiError
 256 JvmtiEnv::AddModuleExports(jobject module, const char* pkg_name, jobject to_module) {
 257   JavaThread* THREAD = JavaThread::current();
 258   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 259 
 260   // check module
 261   Handle h_module(THREAD, JNIHandles::resolve(module));
 262   if (!java_lang_Module::is_instance(h_module())) {
 263     return JVMTI_ERROR_INVALID_MODULE;
 264   }
 265   // check to_module
 266   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 267   if (!java_lang_Module::is_instance(h_to_module())) {
 268     return JVMTI_ERROR_INVALID_MODULE;
 269   }
 270   return JvmtiExport::add_module_exports(h_module, h_pkg, h_to_module, THREAD);
 271 } /* end AddModuleExports */
 272 
 273 
 274 // module - pre-checked for NULL
 275 // pkg_name - pre-checked for NULL
 276 // to_module - pre-checked for NULL
 277 jvmtiError
 278 JvmtiEnv::AddModuleOpens(jobject module, const char* pkg_name, jobject to_module) {
 279   JavaThread* THREAD = JavaThread::current();
 280   Handle h_pkg = java_lang_String::create_from_str(pkg_name, THREAD);
 281 
 282   // check module
 283   Handle h_module(THREAD, JNIHandles::resolve(module));
 284   if (!java_lang_Module::is_instance(h_module())) {
 285     return JVMTI_ERROR_INVALID_MODULE;
 286   }
 287   // check to_module
 288   Handle h_to_module(THREAD, JNIHandles::resolve(to_module));
 289   if (!java_lang_Module::is_instance(h_to_module())) {
 290     return JVMTI_ERROR_INVALID_MODULE;
 291   }
 292   return JvmtiExport::add_module_opens(h_module, h_pkg, h_to_module, THREAD);
 293 } /* end AddModuleOpens */
 294 
 295 
 296 // module - pre-checked for NULL
 297 // service - pre-checked for NULL
 298 jvmtiError
 299 JvmtiEnv::AddModuleUses(jobject module, jclass service) {
 300   JavaThread* THREAD = JavaThread::current();
 301 
 302   // check module
 303   Handle h_module(THREAD, JNIHandles::resolve(module));
 304   if (!java_lang_Module::is_instance(h_module())) {
 305     return JVMTI_ERROR_INVALID_MODULE;
 306   }
 307   // check service
 308   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 309   if (!java_lang_Class::is_instance(h_service()) ||
 310       java_lang_Class::is_primitive(h_service())) {
 311     return JVMTI_ERROR_INVALID_CLASS;
 312   }
 313   return JvmtiExport::add_module_uses(h_module, h_service, THREAD);
 314 } /* end AddModuleUses */
 315 
 316 
 317 // module - pre-checked for NULL
 318 // service - pre-checked for NULL
 319 // impl_class - pre-checked for NULL
 320 jvmtiError
 321 JvmtiEnv::AddModuleProvides(jobject module, jclass service, jclass impl_class) {
 322   JavaThread* THREAD = JavaThread::current();
 323 
 324   // check module
 325   Handle h_module(THREAD, JNIHandles::resolve(module));
 326   if (!java_lang_Module::is_instance(h_module())) {
 327     return JVMTI_ERROR_INVALID_MODULE;
 328   }
 329   // check service
 330   Handle h_service(THREAD, JNIHandles::resolve_external_guard(service));
 331   if (!java_lang_Class::is_instance(h_service()) ||
 332       java_lang_Class::is_primitive(h_service())) {
 333     return JVMTI_ERROR_INVALID_CLASS;
 334   }
 335   // check impl_class
 336   Handle h_impl_class(THREAD, JNIHandles::resolve_external_guard(impl_class));
 337   if (!java_lang_Class::is_instance(h_impl_class()) ||
 338       java_lang_Class::is_primitive(h_impl_class())) {
 339     return JVMTI_ERROR_INVALID_CLASS;
 340   }
 341   return JvmtiExport::add_module_provides(h_module, h_service, h_impl_class, THREAD);
 342 } /* end AddModuleProvides */
 343 
 344 // module - pre-checked for NULL
 345 // is_modifiable_class_ptr - pre-checked for NULL
 346 jvmtiError
 347 JvmtiEnv::IsModifiableModule(jobject module, jboolean* is_modifiable_module_ptr) {
 348   JavaThread* THREAD = JavaThread::current();
 349 
 350   // check module
 351   Handle h_module(THREAD, JNIHandles::resolve(module));
 352   if (!java_lang_Module::is_instance(h_module())) {
 353     return JVMTI_ERROR_INVALID_MODULE;
 354   }
 355 
 356   *is_modifiable_module_ptr = JNI_TRUE;
 357   return JVMTI_ERROR_NONE;
 358 } /* end IsModifiableModule */
 359 
 360 
 361   //
 362   // Class functions
 363   //
 364 
 365 // class_count_ptr - pre-checked for NULL
 366 // classes_ptr - pre-checked for NULL
 367 jvmtiError
 368 JvmtiEnv::GetLoadedClasses(jint* class_count_ptr, jclass** classes_ptr) {
 369   return JvmtiGetLoadedClasses::getLoadedClasses(this, class_count_ptr, classes_ptr);
 370 } /* end GetLoadedClasses */
 371 
 372 
 373 // initiating_loader - NULL is a valid value, must be checked
 374 // class_count_ptr - pre-checked for NULL
 375 // classes_ptr - pre-checked for NULL
 376 jvmtiError
 377 JvmtiEnv::GetClassLoaderClasses(jobject initiating_loader, jint* class_count_ptr, jclass** classes_ptr) {
 378   return JvmtiGetLoadedClasses::getClassLoaderClasses(this, initiating_loader,
 379                                                   class_count_ptr, classes_ptr);
 380 } /* end GetClassLoaderClasses */
 381 
 382 // k_mirror - may be primitive, this must be checked
 383 // is_modifiable_class_ptr - pre-checked for NULL
 384 jvmtiError
 385 JvmtiEnv::IsModifiableClass(oop k_mirror, jboolean* is_modifiable_class_ptr) {
 386   *is_modifiable_class_ptr = VM_RedefineClasses::is_modifiable_class(k_mirror)?
 387                                                        JNI_TRUE : JNI_FALSE;
 388   return JVMTI_ERROR_NONE;
 389 } /* end IsModifiableClass */
 390 
 391 // class_count - pre-checked to be greater than or equal to 0
 392 // classes - pre-checked for NULL
 393 jvmtiError
 394 JvmtiEnv::RetransformClasses(jint class_count, const jclass* classes) {
 395 //TODO: add locking
 396 
 397   int index;
 398   JavaThread* current_thread = JavaThread::current();
 399   ResourceMark rm(current_thread);
 400 
 401   jvmtiClassDefinition* class_definitions =
 402                             NEW_RESOURCE_ARRAY(jvmtiClassDefinition, class_count);
 403   NULL_CHECK(class_definitions, JVMTI_ERROR_OUT_OF_MEMORY);
 404 
 405   for (index = 0; index &lt; class_count; index++) {
 406     HandleMark hm(current_thread);
 407 
 408     jclass jcls = classes[index];
 409     oop k_mirror = JNIHandles::resolve_external_guard(jcls);
 410     if (k_mirror == NULL) {
 411       return JVMTI_ERROR_INVALID_CLASS;
 412     }
 413     if (!k_mirror-&gt;is_a(SystemDictionary::Class_klass())) {
 414       return JVMTI_ERROR_INVALID_CLASS;
 415     }
 416 
 417     if (!VM_RedefineClasses::is_modifiable_class(k_mirror)) {
 418       return JVMTI_ERROR_UNMODIFIABLE_CLASS;
 419     }
 420 
 421     Klass* klass = java_lang_Class::as_Klass(k_mirror);
 422 
 423     jint status = klass-&gt;jvmti_class_status();
 424     if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
 425       return JVMTI_ERROR_INVALID_CLASS;
 426     }
 427 
 428     InstanceKlass* ik = InstanceKlass::cast(klass);
 429     if (ik-&gt;get_cached_class_file_bytes() == NULL) {
 430       // Not cached, we need to reconstitute the class file from the
 431       // VM representation. We don&#39;t attach the reconstituted class
 432       // bytes to the InstanceKlass here because they have not been
 433       // validated and we&#39;re not at a safepoint.
 434       JvmtiClassFileReconstituter reconstituter(ik);
 435       if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
 436         return reconstituter.get_error();
 437       }
 438 
 439       class_definitions[index].class_byte_count = (jint)reconstituter.class_file_size();
 440       class_definitions[index].class_bytes      = (unsigned char*)
 441                                                        reconstituter.class_file_bytes();
 442     } else {
 443       // it is cached, get it from the cache
 444       class_definitions[index].class_byte_count = ik-&gt;get_cached_class_file_len();
 445       class_definitions[index].class_bytes      = ik-&gt;get_cached_class_file_bytes();
 446     }
 447     class_definitions[index].klass              = jcls;
 448   }
 449   EventRetransformClasses event;
 450   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_retransform);
 451   VMThread::execute(&amp;op);
 452   jvmtiError error = op.check_error();
 453   if (error == JVMTI_ERROR_NONE) {
 454     event.set_classCount(class_count);
 455     event.set_redefinitionId(op.id());
 456     event.commit();
 457   }
 458   return error;
 459 } /* end RetransformClasses */
 460 
 461 
 462 // class_count - pre-checked to be greater than or equal to 0
 463 // class_definitions - pre-checked for NULL
 464 jvmtiError
 465 JvmtiEnv::RedefineClasses(jint class_count, const jvmtiClassDefinition* class_definitions) {
 466 //TODO: add locking
 467   EventRedefineClasses event;
 468   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_redefine);
 469   VMThread::execute(&amp;op);
 470   jvmtiError error = op.check_error();
 471   if (error == JVMTI_ERROR_NONE) {
 472     event.set_classCount(class_count);
 473     event.set_redefinitionId(op.id());
 474     event.commit();
 475   }
 476   return error;
 477 } /* end RedefineClasses */
 478 
 479 
 480   //
 481   // Object functions
 482   //
 483 
 484 // size_ptr - pre-checked for NULL
 485 jvmtiError
 486 JvmtiEnv::GetObjectSize(jobject object, jlong* size_ptr) {
 487   oop mirror = JNIHandles::resolve_external_guard(object);
 488   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
<a name="1" id="anc1"></a><span class="line-modified"> 489   *size_ptr = (jlong)mirror-&gt;size() * wordSize;</span>
 490   return JVMTI_ERROR_NONE;
 491 } /* end GetObjectSize */
 492 
 493   //
 494   // Method functions
 495   //
 496 
 497 // prefix - NULL is a valid value, must be checked
 498 jvmtiError
 499 JvmtiEnv::SetNativeMethodPrefix(const char* prefix) {
 500   return prefix == NULL?
 501               SetNativeMethodPrefixes(0, NULL) :
 502               SetNativeMethodPrefixes(1, (char**)&amp;prefix);
 503 } /* end SetNativeMethodPrefix */
 504 
 505 
 506 // prefix_count - pre-checked to be greater than or equal to 0
 507 // prefixes - pre-checked for NULL
 508 jvmtiError
 509 JvmtiEnv::SetNativeMethodPrefixes(jint prefix_count, char** prefixes) {
 510   // Have to grab JVMTI thread state lock to be sure that some thread
 511   // isn&#39;t accessing the prefixes at the same time we are setting them.
 512   // No locks during VM bring-up.
 513   if (Threads::number_of_threads() == 0) {
 514     return set_native_method_prefixes(prefix_count, prefixes);
 515   } else {
 516     MutexLocker mu(JvmtiThreadState_lock);
 517     return set_native_method_prefixes(prefix_count, prefixes);
 518   }
 519 } /* end SetNativeMethodPrefixes */
 520 
 521   //
 522   // Event Management functions
 523   //
 524 
 525 // callbacks - NULL is a valid value, must be checked
 526 // size_of_callbacks - pre-checked to be greater than or equal to 0
 527 jvmtiError
 528 JvmtiEnv::SetEventCallbacks(const jvmtiEventCallbacks* callbacks, jint size_of_callbacks) {
 529   JvmtiEventController::set_event_callbacks(this, callbacks, size_of_callbacks);
 530   return JVMTI_ERROR_NONE;
 531 } /* end SetEventCallbacks */
 532 
 533 
 534 // event_thread - NULL is a valid value, must be checked
 535 jvmtiError
 536 JvmtiEnv::SetEventNotificationMode(jvmtiEventMode mode, jvmtiEvent event_type, jthread event_thread,   ...) {
 537   if (event_thread == NULL) {
 538     // Can be called at Agent_OnLoad() time with event_thread == NULL
 539     // when Thread::current() does not work yet so we cannot create a
 540     // ThreadsListHandle that is common to both thread-specific and
 541     // global code paths.
 542 
 543     // event_type must be valid
 544     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 545       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 546     }
 547 
 548     bool enabled = (mode == JVMTI_ENABLE);
 549 
 550     // assure that needed capabilities are present
 551     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 552       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 553     }
 554 
 555     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 556       record_class_file_load_hook_enabled();
 557     }
 558 
 559     JvmtiEventController::set_user_enabled(this, (JavaThread*) NULL, event_type, enabled);
 560   } else {
 561     // We have a specified event_thread.
 562     JavaThread* java_thread = NULL;
 563     ThreadsListHandle tlh;
 564     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), event_thread, &amp;java_thread, NULL);
 565     if (err != JVMTI_ERROR_NONE) {
 566       return err;
 567     }
 568 
 569     // event_type must be valid
 570     if (!JvmtiEventController::is_valid_event_type(event_type)) {
 571       return JVMTI_ERROR_INVALID_EVENT_TYPE;
 572     }
 573 
 574     // global events cannot be controlled at thread level.
 575     if (JvmtiEventController::is_global_event(event_type)) {
 576       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 577     }
 578 
 579     bool enabled = (mode == JVMTI_ENABLE);
 580 
 581     // assure that needed capabilities are present
 582     if (enabled &amp;&amp; !JvmtiUtil::has_event_capability(event_type, get_capabilities())) {
 583       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
 584     }
 585 
 586     if (event_type == JVMTI_EVENT_CLASS_FILE_LOAD_HOOK &amp;&amp; enabled) {
 587       record_class_file_load_hook_enabled();
 588     }
 589     JvmtiEventController::set_user_enabled(this, java_thread, event_type, enabled);
 590   }
 591 
 592   return JVMTI_ERROR_NONE;
 593 } /* end SetEventNotificationMode */
 594 
 595   //
 596   // Capability functions
 597   //
 598 
 599 // capabilities_ptr - pre-checked for NULL
 600 jvmtiError
 601 JvmtiEnv::GetPotentialCapabilities(jvmtiCapabilities* capabilities_ptr) {
 602   JvmtiManageCapabilities::get_potential_capabilities(get_capabilities(),
 603                                                       get_prohibited_capabilities(),
 604                                                       capabilities_ptr);
 605   return JVMTI_ERROR_NONE;
 606 } /* end GetPotentialCapabilities */
 607 
 608 
 609 // capabilities_ptr - pre-checked for NULL
 610 jvmtiError
 611 JvmtiEnv::AddCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 612   return JvmtiManageCapabilities::add_capabilities(get_capabilities(),
 613                                                    get_prohibited_capabilities(),
 614                                                    capabilities_ptr,
 615                                                    get_capabilities());
 616 } /* end AddCapabilities */
 617 
 618 
 619 // capabilities_ptr - pre-checked for NULL
 620 jvmtiError
 621 JvmtiEnv::RelinquishCapabilities(const jvmtiCapabilities* capabilities_ptr) {
 622   JvmtiManageCapabilities::relinquish_capabilities(get_capabilities(), capabilities_ptr, get_capabilities());
 623   return JVMTI_ERROR_NONE;
 624 } /* end RelinquishCapabilities */
 625 
 626 
 627 // capabilities_ptr - pre-checked for NULL
 628 jvmtiError
 629 JvmtiEnv::GetCapabilities(jvmtiCapabilities* capabilities_ptr) {
 630   JvmtiManageCapabilities::copy_capabilities(get_capabilities(), capabilities_ptr);
 631   return JVMTI_ERROR_NONE;
 632 } /* end GetCapabilities */
 633 
 634   //
 635   // Class Loader Search functions
 636   //
 637 
 638 // segment - pre-checked for NULL
 639 jvmtiError
 640 JvmtiEnv::AddToBootstrapClassLoaderSearch(const char* segment) {
 641   jvmtiPhase phase = get_phase();
 642   if (phase == JVMTI_PHASE_ONLOAD) {
 643     Arguments::append_sysclasspath(segment);
 644     return JVMTI_ERROR_NONE;
 645   } else if (use_version_1_0_semantics()) {
 646     // This JvmtiEnv requested version 1.0 semantics and this function
 647     // is only allowed in the ONLOAD phase in version 1.0 so we need to
 648     // return an error here.
 649     return JVMTI_ERROR_WRONG_PHASE;
 650   } else if (phase == JVMTI_PHASE_LIVE) {
 651     // The phase is checked by the wrapper that called this function,
 652     // but this thread could be racing with the thread that is
 653     // terminating the VM so we check one more time.
 654 
 655     // create the zip entry
 656     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, true);
 657     if (zip_entry == NULL) {
 658       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 659     }
 660 
 661     // lock the loader
 662     Thread* thread = Thread::current();
 663     HandleMark hm;
 664     Handle loader_lock = Handle(thread, SystemDictionary::system_loader_lock());
 665 
 666     ObjectLocker ol(loader_lock, thread);
 667 
 668     // add the jar file to the bootclasspath
 669     log_info(class, load)(&quot;opened: %s&quot;, zip_entry-&gt;name());
 670 #if INCLUDE_CDS
 671     ClassLoaderExt::append_boot_classpath(zip_entry);
 672 #else
 673     ClassLoader::add_to_boot_append_entries(zip_entry);
 674 #endif
 675     return JVMTI_ERROR_NONE;
 676   } else {
 677     return JVMTI_ERROR_WRONG_PHASE;
 678   }
 679 
 680 } /* end AddToBootstrapClassLoaderSearch */
 681 
 682 
 683 // segment - pre-checked for NULL
 684 jvmtiError
 685 JvmtiEnv::AddToSystemClassLoaderSearch(const char* segment) {
 686   jvmtiPhase phase = get_phase();
 687 
 688   if (phase == JVMTI_PHASE_ONLOAD) {
 689     for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
 690       if (strcmp(&quot;java.class.path&quot;, p-&gt;key()) == 0) {
 691         p-&gt;append_value(segment);
 692         break;
 693       }
 694     }
 695     return JVMTI_ERROR_NONE;
 696   } else if (phase == JVMTI_PHASE_LIVE) {
 697     // The phase is checked by the wrapper that called this function,
 698     // but this thread could be racing with the thread that is
 699     // terminating the VM so we check one more time.
 700     HandleMark hm;
 701 
 702     // create the zip entry (which will open the zip file and hence
 703     // check that the segment is indeed a zip file).
 704     ClassPathZipEntry* zip_entry = ClassLoader::create_class_path_zip_entry(segment, false);
 705     if (zip_entry == NULL) {
 706       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 707     }
 708     delete zip_entry;   // no longer needed
 709 
 710     // lock the loader
 711     Thread* THREAD = Thread::current();
 712     Handle loader = Handle(THREAD, SystemDictionary::java_system_loader());
 713 
 714     ObjectLocker ol(loader, THREAD);
 715 
 716     // need the path as java.lang.String
 717     Handle path = java_lang_String::create_from_platform_dependent_str(segment, THREAD);
 718     if (HAS_PENDING_EXCEPTION) {
 719       CLEAR_PENDING_EXCEPTION;
 720       return JVMTI_ERROR_INTERNAL;
 721     }
 722 
 723     // Invoke the appendToClassPathForInstrumentation method - if the method
 724     // is not found it means the loader doesn&#39;t support adding to the class path
 725     // in the live phase.
 726     {
 727       JavaValue res(T_VOID);
 728       JavaCalls::call_special(&amp;res,
 729                               loader,
 730                               loader-&gt;klass(),
 731                               vmSymbols::appendToClassPathForInstrumentation_name(),
 732                               vmSymbols::appendToClassPathForInstrumentation_signature(),
 733                               path,
 734                               THREAD);
 735       if (HAS_PENDING_EXCEPTION) {
 736         Symbol* ex_name = PENDING_EXCEPTION-&gt;klass()-&gt;name();
 737         CLEAR_PENDING_EXCEPTION;
 738 
 739         if (ex_name == vmSymbols::java_lang_NoSuchMethodError()) {
 740           return JVMTI_ERROR_CLASS_LOADER_UNSUPPORTED;
 741         } else {
 742           return JVMTI_ERROR_INTERNAL;
 743         }
 744       }
 745     }
 746 
 747     return JVMTI_ERROR_NONE;
 748   } else {
 749     return JVMTI_ERROR_WRONG_PHASE;
 750   }
 751 } /* end AddToSystemClassLoaderSearch */
 752 
 753   //
 754   // General functions
 755   //
 756 
 757 // phase_ptr - pre-checked for NULL
 758 jvmtiError
 759 JvmtiEnv::GetPhase(jvmtiPhase* phase_ptr) {
 760   *phase_ptr = phase();
 761   return JVMTI_ERROR_NONE;
 762 } /* end GetPhase */
 763 
 764 
 765 jvmtiError
 766 JvmtiEnv::DisposeEnvironment() {
 767   dispose();
 768   return JVMTI_ERROR_NONE;
 769 } /* end DisposeEnvironment */
 770 
 771 
 772 // data - NULL is a valid value, must be checked
 773 jvmtiError
 774 JvmtiEnv::SetEnvironmentLocalStorage(const void* data) {
 775   set_env_local_storage(data);
 776   return JVMTI_ERROR_NONE;
 777 } /* end SetEnvironmentLocalStorage */
 778 
 779 
 780 // data_ptr - pre-checked for NULL
 781 jvmtiError
 782 JvmtiEnv::GetEnvironmentLocalStorage(void** data_ptr) {
 783   *data_ptr = (void*)get_env_local_storage();
 784   return JVMTI_ERROR_NONE;
 785 } /* end GetEnvironmentLocalStorage */
 786 
 787 // version_ptr - pre-checked for NULL
 788 jvmtiError
 789 JvmtiEnv::GetVersionNumber(jint* version_ptr) {
 790   *version_ptr = JVMTI_VERSION;
 791   return JVMTI_ERROR_NONE;
 792 } /* end GetVersionNumber */
 793 
 794 
 795 // name_ptr - pre-checked for NULL
 796 jvmtiError
 797 JvmtiEnv::GetErrorName(jvmtiError error, char** name_ptr) {
 798   if (error &lt; JVMTI_ERROR_NONE || error &gt; JVMTI_ERROR_MAX) {
 799     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 800   }
 801   const char *name = JvmtiUtil::error_name(error);
 802   if (name == NULL) {
 803     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 804   }
 805   size_t len = strlen(name) + 1;
 806   jvmtiError err = allocate(len, (unsigned char**)name_ptr);
 807   if (err == JVMTI_ERROR_NONE) {
 808     memcpy(*name_ptr, name, len);
 809   }
 810   return err;
 811 } /* end GetErrorName */
 812 
 813 
 814 jvmtiError
 815 JvmtiEnv::SetVerboseFlag(jvmtiVerboseFlag flag, jboolean value) {
 816   LogLevelType level = value == 0 ? LogLevel::Off : LogLevel::Info;
 817   switch (flag) {
 818   case JVMTI_VERBOSE_OTHER:
 819     // ignore
 820     break;
 821   case JVMTI_VERBOSE_CLASS:
 822     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, unload));
 823     LogConfiguration::configure_stdout(level, false, LOG_TAGS(class, load));
 824     break;
 825   case JVMTI_VERBOSE_GC:
 826     LogConfiguration::configure_stdout(level, true, LOG_TAGS(gc));
 827     break;
 828   case JVMTI_VERBOSE_JNI:
 829     level = value == 0 ? LogLevel::Off : LogLevel::Debug;
 830     LogConfiguration::configure_stdout(level, true, LOG_TAGS(jni, resolve));
 831     break;
 832   default:
 833     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 834   };
 835   return JVMTI_ERROR_NONE;
 836 } /* end SetVerboseFlag */
 837 
 838 
 839 // format_ptr - pre-checked for NULL
 840 jvmtiError
 841 JvmtiEnv::GetJLocationFormat(jvmtiJlocationFormat* format_ptr) {
 842   *format_ptr = JVMTI_JLOCATION_JVMBCI;
 843   return JVMTI_ERROR_NONE;
 844 } /* end GetJLocationFormat */
 845 
 846   //
 847   // Thread functions
 848   //
 849 
 850 // Threads_lock NOT held
 851 // thread - NOT pre-checked
 852 // thread_state_ptr - pre-checked for NULL
 853 jvmtiError
 854 JvmtiEnv::GetThreadState(jthread thread, jint* thread_state_ptr) {
 855   JavaThread* current_thread = JavaThread::current();
 856   JavaThread* java_thread = NULL;
 857   oop thread_oop = NULL;
 858   ThreadsListHandle tlh(current_thread);
 859 
 860   if (thread == NULL) {
 861     java_thread = current_thread;
 862     thread_oop = java_thread-&gt;threadObj();
 863 
 864     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
 865       return JVMTI_ERROR_INVALID_THREAD;
 866     }
 867   } else {
 868     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
 869     if (err != JVMTI_ERROR_NONE) {
 870       // We got an error code so we don&#39;t have a JavaThread *, but
 871       // only return an error from here if we didn&#39;t get a valid
 872       // thread_oop.
 873       if (thread_oop == NULL) {
 874         return err;
 875       }
 876       // We have a valid thread_oop so we can return some thread state.
 877     }
 878   }
 879 
 880   // get most state bits
 881   jint state = (jint)java_lang_Thread::get_thread_status(thread_oop);
 882 
 883   if (java_thread != NULL) {
 884     // We have a JavaThread* so add more state bits.
 885     JavaThreadState jts = java_thread-&gt;thread_state();
 886 
 887     if (java_thread-&gt;is_being_ext_suspended()) {
 888       state |= JVMTI_THREAD_STATE_SUSPENDED;
 889     }
 890     if (jts == _thread_in_native) {
 891       state |= JVMTI_THREAD_STATE_IN_NATIVE;
 892     }
 893     if (java_thread-&gt;is_interrupted(false)) {
 894       state |= JVMTI_THREAD_STATE_INTERRUPTED;
 895     }
 896   }
 897 
 898   *thread_state_ptr = state;
 899   return JVMTI_ERROR_NONE;
 900 } /* end GetThreadState */
 901 
 902 
 903 // thread_ptr - pre-checked for NULL
 904 jvmtiError
 905 JvmtiEnv::GetCurrentThread(jthread* thread_ptr) {
 906   JavaThread* current_thread  = JavaThread::current();
 907   *thread_ptr = (jthread)JNIHandles::make_local(current_thread, current_thread-&gt;threadObj());
 908   return JVMTI_ERROR_NONE;
 909 } /* end GetCurrentThread */
 910 
 911 
 912 // threads_count_ptr - pre-checked for NULL
 913 // threads_ptr - pre-checked for NULL
 914 jvmtiError
 915 JvmtiEnv::GetAllThreads(jint* threads_count_ptr, jthread** threads_ptr) {
 916   int nthreads        = 0;
 917   Handle *thread_objs = NULL;
 918   ResourceMark rm;
 919   HandleMark hm;
 920 
 921   // enumerate threads (including agent threads)
 922   ThreadsListEnumerator tle(Thread::current(), true);
 923   nthreads = tle.num_threads();
 924   *threads_count_ptr = nthreads;
 925 
 926   if (nthreads == 0) {
 927     *threads_ptr = NULL;
 928     return JVMTI_ERROR_NONE;
 929   }
 930 
 931   thread_objs = NEW_RESOURCE_ARRAY(Handle, nthreads);
 932   NULL_CHECK(thread_objs, JVMTI_ERROR_OUT_OF_MEMORY);
 933 
 934   for (int i = 0; i &lt; nthreads; i++) {
 935     thread_objs[i] = Handle(tle.get_threadObj(i));
 936   }
 937 
 938   jthread *jthreads  = new_jthreadArray(nthreads, thread_objs);
 939   NULL_CHECK(jthreads, JVMTI_ERROR_OUT_OF_MEMORY);
 940 
 941   *threads_ptr = jthreads;
 942   return JVMTI_ERROR_NONE;
 943 } /* end GetAllThreads */
 944 
 945 
 946 // Threads_lock NOT held, java_thread not protected by lock
 947 // java_thread - pre-checked
 948 jvmtiError
 949 JvmtiEnv::SuspendThread(JavaThread* java_thread) {
 950   // don&#39;t allow hidden thread suspend request.
 951   if (java_thread-&gt;is_hidden_from_external_view()) {
 952     return (JVMTI_ERROR_NONE);
 953   }
 954 
 955   {
 956     MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
 957     if (java_thread-&gt;is_external_suspend()) {
 958       // don&#39;t allow nested external suspend requests.
 959       return (JVMTI_ERROR_THREAD_SUSPENDED);
 960     }
 961     if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
 962       return (JVMTI_ERROR_THREAD_NOT_ALIVE);
 963     }
 964     java_thread-&gt;set_external_suspend();
 965   }
 966 
 967   if (!JvmtiSuspendControl::suspend(java_thread)) {
 968     // the thread was in the process of exiting
 969     return (JVMTI_ERROR_THREAD_NOT_ALIVE);
 970   }
 971   return JVMTI_ERROR_NONE;
 972 } /* end SuspendThread */
 973 
 974 
 975 // request_count - pre-checked to be greater than or equal to 0
 976 // request_list - pre-checked for NULL
 977 // results - pre-checked for NULL
 978 jvmtiError
 979 JvmtiEnv::SuspendThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
 980   int needSafepoint = 0;  // &gt; 0 if we need a safepoint
 981   ThreadsListHandle tlh;
 982   for (int i = 0; i &lt; request_count; i++) {
 983     JavaThread *java_thread = NULL;
 984     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
 985     if (err != JVMTI_ERROR_NONE) {
 986       results[i] = err;
 987       continue;
 988     }
 989     // don&#39;t allow hidden thread suspend request.
 990     if (java_thread-&gt;is_hidden_from_external_view()) {
 991       results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
 992       continue;
 993     }
 994 
 995     {
 996       MutexLocker ml(java_thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
 997       if (java_thread-&gt;is_external_suspend()) {
 998         // don&#39;t allow nested external suspend requests.
 999         results[i] = JVMTI_ERROR_THREAD_SUSPENDED;
1000         continue;
1001       }
1002       if (java_thread-&gt;is_exiting()) { // thread is in the process of exiting
1003         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1004         continue;
1005       }
1006       java_thread-&gt;set_external_suspend();
1007     }
1008     if (java_thread-&gt;thread_state() == _thread_in_native) {
1009       // We need to try and suspend native threads here. Threads in
1010       // other states will self-suspend on their next transition.
1011       if (!JvmtiSuspendControl::suspend(java_thread)) {
1012         // The thread was in the process of exiting. Force another
1013         // safepoint to make sure that this thread transitions.
1014         needSafepoint++;
1015         results[i] = JVMTI_ERROR_THREAD_NOT_ALIVE;
1016         continue;
1017       }
1018     } else {
1019       needSafepoint++;
1020     }
1021     results[i] = JVMTI_ERROR_NONE;  // indicate successful suspend
1022   }
1023   if (needSafepoint &gt; 0) {
1024     VM_ThreadsSuspendJVMTI tsj;
1025     VMThread::execute(&amp;tsj);
1026   }
1027   // per-thread suspend results returned via results parameter
1028   return JVMTI_ERROR_NONE;
1029 } /* end SuspendThreadList */
1030 
1031 
1032 // Threads_lock NOT held, java_thread not protected by lock
1033 // java_thread - pre-checked
1034 jvmtiError
1035 JvmtiEnv::ResumeThread(JavaThread* java_thread) {
1036   // don&#39;t allow hidden thread resume request.
1037   if (java_thread-&gt;is_hidden_from_external_view()) {
1038     return JVMTI_ERROR_NONE;
1039   }
1040 
1041   if (!java_thread-&gt;is_being_ext_suspended()) {
1042     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1043   }
1044 
1045   if (!JvmtiSuspendControl::resume(java_thread)) {
1046     return JVMTI_ERROR_INTERNAL;
1047   }
1048   return JVMTI_ERROR_NONE;
1049 } /* end ResumeThread */
1050 
1051 
1052 // request_count - pre-checked to be greater than or equal to 0
1053 // request_list - pre-checked for NULL
1054 // results - pre-checked for NULL
1055 jvmtiError
1056 JvmtiEnv::ResumeThreadList(jint request_count, const jthread* request_list, jvmtiError* results) {
1057   ThreadsListHandle tlh;
1058   for (int i = 0; i &lt; request_count; i++) {
1059     JavaThread* java_thread = NULL;
1060     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), request_list[i], &amp;java_thread, NULL);
1061     if (err != JVMTI_ERROR_NONE) {
1062       results[i] = err;
1063       continue;
1064     }
1065     // don&#39;t allow hidden thread resume request.
1066     if (java_thread-&gt;is_hidden_from_external_view()) {
1067       results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1068       continue;
1069     }
1070     if (!java_thread-&gt;is_being_ext_suspended()) {
1071       results[i] = JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1072       continue;
1073     }
1074 
1075     if (!JvmtiSuspendControl::resume(java_thread)) {
1076       results[i] = JVMTI_ERROR_INTERNAL;
1077       continue;
1078     }
1079 
1080     results[i] = JVMTI_ERROR_NONE;  // indicate successful resume
1081   }
1082   // per-thread resume results returned via results parameter
1083   return JVMTI_ERROR_NONE;
1084 } /* end ResumeThreadList */
1085 
1086 
1087 // Threads_lock NOT held, java_thread not protected by lock
1088 // java_thread - pre-checked
1089 jvmtiError
1090 JvmtiEnv::StopThread(JavaThread* java_thread, jobject exception) {
1091   oop e = JNIHandles::resolve_external_guard(exception);
1092   NULL_CHECK(e, JVMTI_ERROR_NULL_POINTER);
1093 
1094   JavaThread::send_async_exception(java_thread-&gt;threadObj(), e);
1095 
1096   return JVMTI_ERROR_NONE;
1097 
1098 } /* end StopThread */
1099 
1100 
1101 // Threads_lock NOT held
1102 // thread - NOT pre-checked
1103 jvmtiError
1104 JvmtiEnv::InterruptThread(jthread thread) {
1105   JavaThread* current_thread  = JavaThread::current();
1106   JavaThread* java_thread = NULL;
1107   ThreadsListHandle tlh(current_thread);
1108   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, NULL);
1109   if (err != JVMTI_ERROR_NONE) {
1110     return err;
1111   }
1112   // Really this should be a Java call to Thread.interrupt to ensure the same
1113   // semantics, however historically this has not been done for some reason.
1114   // So we continue with that (which means we don&#39;t interact with any Java-level
1115   // Interruptible object) but we must set the Java-level interrupted state.
1116   java_lang_Thread::set_interrupted(JNIHandles::resolve(thread), true);
1117   java_thread-&gt;interrupt();
1118 
1119   return JVMTI_ERROR_NONE;
1120 } /* end InterruptThread */
1121 
1122 
1123 // Threads_lock NOT held
1124 // thread - NOT pre-checked
1125 // info_ptr - pre-checked for NULL
1126 jvmtiError
1127 JvmtiEnv::GetThreadInfo(jthread thread, jvmtiThreadInfo* info_ptr) {
1128   ResourceMark rm;
1129   HandleMark hm;
1130 
1131   JavaThread* current_thread = JavaThread::current();
1132   ThreadsListHandle tlh(current_thread);
1133 
1134   // if thread is NULL the current thread is used
1135   oop thread_oop = NULL;
1136   if (thread == NULL) {
1137     thread_oop = current_thread-&gt;threadObj();
1138     if (thread_oop == NULL || !thread_oop-&gt;is_a(SystemDictionary::Thread_klass())) {
1139       return JVMTI_ERROR_INVALID_THREAD;
1140     }
1141   } else {
1142     JavaThread* java_thread = NULL;
1143     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1144     if (err != JVMTI_ERROR_NONE) {
1145       // We got an error code so we don&#39;t have a JavaThread *, but
1146       // only return an error from here if we didn&#39;t get a valid
1147       // thread_oop.
1148       if (thread_oop == NULL) {
1149         return err;
1150       }
1151       // We have a valid thread_oop so we can return some thread info.
1152     }
1153   }
1154 
1155   Handle thread_obj(current_thread, thread_oop);
1156   Handle name;
1157   ThreadPriority priority;
1158   Handle     thread_group;
1159   Handle context_class_loader;
1160   bool          is_daemon;
1161 
1162   name = Handle(current_thread, java_lang_Thread::name(thread_obj()));
1163   priority = java_lang_Thread::priority(thread_obj());
1164   thread_group = Handle(current_thread, java_lang_Thread::threadGroup(thread_obj()));
1165   is_daemon = java_lang_Thread::is_daemon(thread_obj());
1166 
1167   oop loader = java_lang_Thread::context_class_loader(thread_obj());
1168   context_class_loader = Handle(current_thread, loader);
1169 
1170   { const char *n;
1171 
1172     if (name() != NULL) {
1173       n = java_lang_String::as_utf8_string(name());
1174     } else {
1175       int utf8_length = 0;
1176       n = UNICODE::as_utf8((jchar*) NULL, utf8_length);
1177     }
1178 
1179     info_ptr-&gt;name = (char *) jvmtiMalloc(strlen(n)+1);
1180     if (info_ptr-&gt;name == NULL)
1181       return JVMTI_ERROR_OUT_OF_MEMORY;
1182 
1183     strcpy(info_ptr-&gt;name, n);
1184   }
1185   info_ptr-&gt;is_daemon = is_daemon;
1186   info_ptr-&gt;priority  = priority;
1187 
1188   info_ptr-&gt;context_class_loader = (context_class_loader.is_null()) ? NULL :
1189                                      jni_reference(context_class_loader);
1190   info_ptr-&gt;thread_group = jni_reference(thread_group);
1191 
1192   return JVMTI_ERROR_NONE;
1193 } /* end GetThreadInfo */
1194 
1195 
1196 // Threads_lock NOT held, java_thread not protected by lock
1197 // java_thread - pre-checked
1198 // owned_monitor_count_ptr - pre-checked for NULL
1199 // owned_monitors_ptr - pre-checked for NULL
1200 jvmtiError
1201 JvmtiEnv::GetOwnedMonitorInfo(JavaThread* java_thread, jint* owned_monitor_count_ptr, jobject** owned_monitors_ptr) {
1202   jvmtiError err = JVMTI_ERROR_NONE;
1203   JavaThread* calling_thread = JavaThread::current();
1204 
1205   // growable array of jvmti monitors info on the C-heap
1206   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1207       new (ResourceObj::C_HEAP, mtServiceability) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, mtServiceability);
1208 
1209   // It is only safe to perform the direct operation on the current
1210   // thread. All other usage needs to use a direct handshake for safety.
1211   if (java_thread == calling_thread) {
1212     err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1213   } else {
1214     // get owned monitors info with handshake
1215     GetOwnedMonitorInfoClosure op(calling_thread, this, owned_monitors_list);
1216     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1217     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1218   }
1219   jint owned_monitor_count = owned_monitors_list-&gt;length();
1220   if (err == JVMTI_ERROR_NONE) {
1221     if ((err = allocate(owned_monitor_count * sizeof(jobject *),
1222                       (unsigned char**)owned_monitors_ptr)) == JVMTI_ERROR_NONE) {
1223       // copy into the returned array
1224       for (int i = 0; i &lt; owned_monitor_count; i++) {
1225         (*owned_monitors_ptr)[i] =
1226           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1227       }
1228       *owned_monitor_count_ptr = owned_monitor_count;
1229     }
1230   }
1231   // clean up.
1232   for (int i = 0; i &lt; owned_monitor_count; i++) {
1233     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1234   }
1235   delete owned_monitors_list;
1236 
1237   return err;
1238 } /* end GetOwnedMonitorInfo */
1239 
1240 
1241 // Threads_lock NOT held, java_thread not protected by lock
1242 // java_thread - pre-checked
1243 // monitor_info_count_ptr - pre-checked for NULL
1244 // monitor_info_ptr - pre-checked for NULL
1245 jvmtiError
1246 JvmtiEnv::GetOwnedMonitorStackDepthInfo(JavaThread* java_thread, jint* monitor_info_count_ptr, jvmtiMonitorStackDepthInfo** monitor_info_ptr) {
1247   jvmtiError err = JVMTI_ERROR_NONE;
1248   JavaThread* calling_thread = JavaThread::current();
1249 
1250   // growable array of jvmti monitors info on the C-heap
1251   GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list =
1252          new (ResourceObj::C_HEAP, mtServiceability) GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;(1, mtServiceability);
1253 
1254   // It is only safe to perform the direct operation on the current
1255   // thread. All other usage needs to use a direct handshake for safety.
1256   if (java_thread == calling_thread) {
1257     err = get_owned_monitors(calling_thread, java_thread, owned_monitors_list);
1258   } else {
1259     // get owned monitors info with handshake
1260     GetOwnedMonitorInfoClosure op(calling_thread, this, owned_monitors_list);
1261     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1262     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1263   }
1264 
1265   jint owned_monitor_count = owned_monitors_list-&gt;length();
1266   if (err == JVMTI_ERROR_NONE) {
1267     if ((err = allocate(owned_monitor_count * sizeof(jvmtiMonitorStackDepthInfo),
1268                       (unsigned char**)monitor_info_ptr)) == JVMTI_ERROR_NONE) {
1269       // copy to output array.
1270       for (int i = 0; i &lt; owned_monitor_count; i++) {
1271         (*monitor_info_ptr)[i].monitor =
1272           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;monitor;
1273         (*monitor_info_ptr)[i].stack_depth =
1274           ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(i))-&gt;stack_depth;
1275       }
1276     }
1277     *monitor_info_count_ptr = owned_monitor_count;
1278   }
1279 
1280   // clean up.
1281   for (int i = 0; i &lt; owned_monitor_count; i++) {
1282     deallocate((unsigned char*)owned_monitors_list-&gt;at(i));
1283   }
1284   delete owned_monitors_list;
1285 
1286   return err;
1287 } /* end GetOwnedMonitorStackDepthInfo */
1288 
1289 
1290 // Threads_lock NOT held, java_thread not protected by lock
1291 // java_thread - pre-checked
1292 // monitor_ptr - pre-checked for NULL
1293 jvmtiError
1294 JvmtiEnv::GetCurrentContendedMonitor(JavaThread* java_thread, jobject* monitor_ptr) {
1295   jvmtiError err = JVMTI_ERROR_NONE;
1296   JavaThread* calling_thread = JavaThread::current();
1297 
1298   // It is only safe to perform the direct operation on the current
1299   // thread. All other usage needs to use a direct handshake for safety.
1300   if (java_thread == calling_thread) {
1301     err = get_current_contended_monitor(calling_thread, java_thread, monitor_ptr);
1302   } else {
1303     // get contended monitor information with handshake
1304     GetCurrentContendedMonitorClosure op(calling_thread, this, monitor_ptr);
1305     bool executed = Handshake::execute_direct(&amp;op, java_thread);
1306     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;
1307   }
1308   return err;
1309 } /* end GetCurrentContendedMonitor */
1310 
1311 
1312 // Threads_lock NOT held
1313 // thread - NOT pre-checked
1314 // proc - pre-checked for NULL
1315 // arg - NULL is a valid value, must be checked
1316 jvmtiError
1317 JvmtiEnv::RunAgentThread(jthread thread, jvmtiStartFunction proc, const void* arg, jint priority) {
1318   JavaThread* current_thread = JavaThread::current();
1319 
1320   JavaThread* java_thread = NULL;
1321   oop thread_oop = NULL;
1322   ThreadsListHandle tlh(current_thread);
1323   jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), thread, &amp;java_thread, &amp;thread_oop);
1324   if (err != JVMTI_ERROR_NONE) {
1325     // We got an error code so we don&#39;t have a JavaThread *, but
1326     // only return an error from here if we didn&#39;t get a valid
1327     // thread_oop.
1328     if (thread_oop == NULL) {
1329       return err;
1330     }
1331     // We have a valid thread_oop.
1332   }
1333 
1334   if (java_thread != NULL) {
1335     // &#39;thread&#39; refers to an existing JavaThread.
1336     return JVMTI_ERROR_INVALID_THREAD;
1337   }
1338 
1339   if (priority &lt; JVMTI_THREAD_MIN_PRIORITY || priority &gt; JVMTI_THREAD_MAX_PRIORITY) {
1340     return JVMTI_ERROR_INVALID_PRIORITY;
1341   }
1342 
1343   Handle thread_hndl(current_thread, thread_oop);
1344   {
1345     MutexLocker mu(current_thread, Threads_lock); // grab Threads_lock
1346 
1347     JvmtiAgentThread *new_thread = new JvmtiAgentThread(this, proc, arg);
1348 
1349     // At this point it may be possible that no osthread was created for the
1350     // JavaThread due to lack of memory.
1351     if (new_thread == NULL || new_thread-&gt;osthread() == NULL) {
1352       if (new_thread != NULL) {
1353         new_thread-&gt;smr_delete();
1354       }
1355       return JVMTI_ERROR_OUT_OF_MEMORY;
1356     }
1357 
1358     java_lang_Thread::set_thread(thread_hndl(), new_thread);
1359     java_lang_Thread::set_priority(thread_hndl(), (ThreadPriority)priority);
1360     java_lang_Thread::set_daemon(thread_hndl());
1361 
1362     new_thread-&gt;set_threadObj(thread_hndl());
1363     Threads::add(new_thread);
1364     Thread::start(new_thread);
1365   } // unlock Threads_lock
1366 
1367   return JVMTI_ERROR_NONE;
1368 } /* end RunAgentThread */
1369 
1370   //
1371   // Thread Group functions
1372   //
1373 
1374 // group_count_ptr - pre-checked for NULL
1375 // groups_ptr - pre-checked for NULL
1376 jvmtiError
1377 JvmtiEnv::GetTopThreadGroups(jint* group_count_ptr, jthreadGroup** groups_ptr) {
1378   JavaThread* current_thread = JavaThread::current();
1379 
1380   // Only one top level thread group now.
1381   *group_count_ptr = 1;
1382 
1383   // Allocate memory to store global-refs to the thread groups.
1384   // Assume this area is freed by caller.
1385   *groups_ptr = (jthreadGroup *) jvmtiMalloc((sizeof(jthreadGroup)) * (*group_count_ptr));
1386 
1387   NULL_CHECK(*groups_ptr, JVMTI_ERROR_OUT_OF_MEMORY);
1388 
1389   // Convert oop to Handle, then convert Handle to global-ref.
1390   {
1391     HandleMark hm(current_thread);
1392     Handle system_thread_group(current_thread, Universe::system_thread_group());
1393     *groups_ptr[0] = jni_reference(system_thread_group);
1394   }
1395 
1396   return JVMTI_ERROR_NONE;
1397 } /* end GetTopThreadGroups */
1398 
1399 
1400 // info_ptr - pre-checked for NULL
1401 jvmtiError
1402 JvmtiEnv::GetThreadGroupInfo(jthreadGroup group, jvmtiThreadGroupInfo* info_ptr) {
1403   ResourceMark rm;
1404   HandleMark hm;
1405 
1406   JavaThread* current_thread = JavaThread::current();
1407 
1408   Handle group_obj (current_thread, JNIHandles::resolve_external_guard(group));
1409   NULL_CHECK(group_obj(), JVMTI_ERROR_INVALID_THREAD_GROUP);
1410 
1411   const char* name;
1412   Handle parent_group;
1413   bool is_daemon;
1414   ThreadPriority max_priority;
1415 
1416   name         = java_lang_ThreadGroup::name(group_obj());
1417   parent_group = Handle(current_thread, java_lang_ThreadGroup::parent(group_obj()));
1418   is_daemon    = java_lang_ThreadGroup::is_daemon(group_obj());
1419   max_priority = java_lang_ThreadGroup::maxPriority(group_obj());
1420 
1421   info_ptr-&gt;is_daemon    = is_daemon;
1422   info_ptr-&gt;max_priority = max_priority;
1423   info_ptr-&gt;parent       = jni_reference(parent_group);
1424 
1425   if (name != NULL) {
1426     info_ptr-&gt;name = (char*)jvmtiMalloc(strlen(name)+1);
1427     NULL_CHECK(info_ptr-&gt;name, JVMTI_ERROR_OUT_OF_MEMORY);
1428     strcpy(info_ptr-&gt;name, name);
1429   } else {
1430     info_ptr-&gt;name = NULL;
1431   }
1432 
1433   return JVMTI_ERROR_NONE;
1434 } /* end GetThreadGroupInfo */
1435 
1436 
1437 // thread_count_ptr - pre-checked for NULL
1438 // threads_ptr - pre-checked for NULL
1439 // group_count_ptr - pre-checked for NULL
1440 // groups_ptr - pre-checked for NULL
1441 jvmtiError
1442 JvmtiEnv::GetThreadGroupChildren(jthreadGroup group, jint* thread_count_ptr, jthread** threads_ptr, jint* group_count_ptr, jthreadGroup** groups_ptr) {
1443   JavaThread* current_thread = JavaThread::current();
1444   oop group_obj = (oop) JNIHandles::resolve_external_guard(group);
1445   NULL_CHECK(group_obj, JVMTI_ERROR_INVALID_THREAD_GROUP);
1446 
1447   Handle *thread_objs = NULL;
1448   Handle *group_objs  = NULL;
1449   int nthreads = 0;
1450   int ngroups = 0;
1451   int hidden_threads = 0;
1452 
1453   ResourceMark rm(current_thread);
1454   HandleMark hm(current_thread);
1455 
1456   Handle group_hdl(current_thread, group_obj);
1457 
1458   { // Cannot allow thread or group counts to change.
1459     ObjectLocker ol(group_hdl, current_thread);
1460 
1461     nthreads = java_lang_ThreadGroup::nthreads(group_hdl());
1462     ngroups  = java_lang_ThreadGroup::ngroups(group_hdl());
1463 
1464     if (nthreads &gt; 0) {
1465       ThreadsListHandle tlh(current_thread);
1466       objArrayOop threads = java_lang_ThreadGroup::threads(group_hdl());
1467       assert(nthreads &lt;= threads-&gt;length(), &quot;too many threads&quot;);
1468       thread_objs = NEW_RESOURCE_ARRAY(Handle,nthreads);
1469       for (int i = 0, j = 0; i &lt; nthreads; i++) {
1470         oop thread_obj = threads-&gt;obj_at(i);
1471         assert(thread_obj != NULL, &quot;thread_obj is NULL&quot;);
1472         JavaThread *java_thread = NULL;
1473         jvmtiError err = JvmtiExport::cv_oop_to_JavaThread(tlh.list(), thread_obj, &amp;java_thread);
1474         if (err == JVMTI_ERROR_NONE) {
1475           // Have a valid JavaThread*.
1476           if (java_thread-&gt;is_hidden_from_external_view()) {
1477             // Filter out hidden java threads.
1478             hidden_threads++;
1479             continue;
1480           }
1481         } else {
1482           // We couldn&#39;t convert thread_obj into a JavaThread*.
1483           if (err == JVMTI_ERROR_INVALID_THREAD) {
1484             // The thread_obj does not refer to a java.lang.Thread object
1485             // so skip it.
1486             hidden_threads++;
1487             continue;
1488           }
1489           // We have a valid thread_obj, but no JavaThread*; the caller
1490           // can still have limited use for the thread_obj.
1491         }
1492         thread_objs[j++] = Handle(current_thread, thread_obj);
1493       }
1494       nthreads -= hidden_threads;
1495     } // ThreadsListHandle is destroyed here.
1496 
1497     if (ngroups &gt; 0) {
1498       objArrayOop groups = java_lang_ThreadGroup::groups(group_hdl());
1499       assert(ngroups &lt;= groups-&gt;length(), &quot;too many groups&quot;);
1500       group_objs = NEW_RESOURCE_ARRAY(Handle,ngroups);
1501       for (int i = 0; i &lt; ngroups; i++) {
1502         oop group_obj = groups-&gt;obj_at(i);
1503         assert(group_obj != NULL, &quot;group_obj != NULL&quot;);
1504         group_objs[i] = Handle(current_thread, group_obj);
1505       }
1506     }
1507   } // ThreadGroup unlocked here
1508 
1509   *group_count_ptr  = ngroups;
1510   *thread_count_ptr = nthreads;
1511   *threads_ptr     = new_jthreadArray(nthreads, thread_objs);
1512   *groups_ptr      = new_jthreadGroupArray(ngroups, group_objs);
1513   if ((nthreads &gt; 0) &amp;&amp; (*threads_ptr == NULL)) {
1514     return JVMTI_ERROR_OUT_OF_MEMORY;
1515   }
1516   if ((ngroups &gt; 0) &amp;&amp; (*groups_ptr == NULL)) {
1517     return JVMTI_ERROR_OUT_OF_MEMORY;
1518   }
1519 
1520   return JVMTI_ERROR_NONE;
1521 } /* end GetThreadGroupChildren */
1522 
1523 
1524   //
1525   // Stack Frame functions
1526   //
1527 
1528 // Threads_lock NOT held, java_thread not protected by lock
1529 // java_thread - pre-checked
1530 // max_frame_count - pre-checked to be greater than or equal to 0
1531 // frame_buffer - pre-checked for NULL
1532 // count_ptr - pre-checked for NULL
1533 jvmtiError
1534 JvmtiEnv::GetStackTrace(JavaThread* java_thread, jint start_depth, jint max_frame_count, jvmtiFrameInfo* frame_buffer, jint* count_ptr) {
1535   jvmtiError err = JVMTI_ERROR_NONE;
1536 
1537   // It is only safe to perform the direct operation on the current
<a name="2" id="anc2"></a><span class="line-modified">1538   // thread. All other usage needs to use a direct handshake for safety.</span>
1539   if (java_thread == JavaThread::current()) {
1540     err = get_stack_trace(java_thread, start_depth, max_frame_count, frame_buffer, count_ptr);
1541   } else {
<a name="3" id="anc3"></a><span class="line-modified">1542     // Get stack trace with handshake.</span>
<span class="line-modified">1543     GetStackTraceClosure op(this, start_depth, max_frame_count, frame_buffer, count_ptr);</span>
<span class="line-modified">1544     bool executed = Handshake::execute_direct(&amp;op, java_thread);</span>
<span class="line-modified">1545     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;</span>

1546   }
1547 
1548   return err;
1549 } /* end GetStackTrace */
1550 
1551 
1552 // max_frame_count - pre-checked to be greater than or equal to 0
1553 // stack_info_ptr - pre-checked for NULL
1554 // thread_count_ptr - pre-checked for NULL
1555 jvmtiError
1556 JvmtiEnv::GetAllStackTraces(jint max_frame_count, jvmtiStackInfo** stack_info_ptr, jint* thread_count_ptr) {
1557   jvmtiError err = JVMTI_ERROR_NONE;
1558   JavaThread* calling_thread = JavaThread::current();
1559 
1560   // JVMTI get stack traces at safepoint.
1561   VM_GetAllStackTraces op(this, calling_thread, max_frame_count);
1562   VMThread::execute(&amp;op);
1563   *thread_count_ptr = op.final_thread_count();
1564   *stack_info_ptr = op.stack_info();
1565   err = op.result();
1566   return err;
1567 } /* end GetAllStackTraces */
1568 
1569 
1570 // thread_count - pre-checked to be greater than or equal to 0
1571 // thread_list - pre-checked for NULL
1572 // max_frame_count - pre-checked to be greater than or equal to 0
1573 // stack_info_ptr - pre-checked for NULL
1574 jvmtiError
1575 JvmtiEnv::GetThreadListStackTraces(jint thread_count, const jthread* thread_list, jint max_frame_count, jvmtiStackInfo** stack_info_ptr) {
1576   jvmtiError err = JVMTI_ERROR_NONE;
<a name="4" id="anc4"></a><span class="line-modified">1577 </span>
<span class="line-modified">1578   if (thread_count == 1) {</span>
<span class="line-modified">1579     // Use direct handshake if we need to get only one stack trace.</span>
<span class="line-modified">1580     JavaThread *current_thread = JavaThread::current();</span>
<span class="line-modified">1581     ThreadsListHandle tlh(current_thread);</span>
<span class="line-modified">1582     JavaThread *java_thread;</span>
<span class="line-added">1583     err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), *thread_list, &amp;java_thread, NULL);</span>
<span class="line-added">1584     if (err != JVMTI_ERROR_NONE) {</span>
<span class="line-added">1585       return err;</span>
<span class="line-added">1586     }</span>
<span class="line-added">1587 </span>
<span class="line-added">1588     GetSingleStackTraceClosure op(this, current_thread, *thread_list, max_frame_count);</span>
<span class="line-added">1589     bool executed = Handshake::execute_direct(&amp;op, java_thread);</span>
<span class="line-added">1590     err = executed ? op.result() : JVMTI_ERROR_THREAD_NOT_ALIVE;</span>
<span class="line-added">1591     if (err == JVMTI_ERROR_NONE) {</span>
<span class="line-added">1592       *stack_info_ptr = op.stack_info();</span>
<span class="line-added">1593     }</span>
<span class="line-added">1594   } else {</span>
<span class="line-added">1595     // JVMTI get stack traces at safepoint.</span>
<span class="line-added">1596     VM_GetThreadListStackTraces op(this, thread_count, thread_list, max_frame_count);</span>
<span class="line-added">1597     VMThread::execute(&amp;op);</span>
<span class="line-added">1598     err = op.result();</span>
<span class="line-added">1599     if (err == JVMTI_ERROR_NONE) {</span>
<span class="line-added">1600       *stack_info_ptr = op.stack_info();</span>
<span class="line-added">1601     }</span>
1602   }
1603   return err;
1604 } /* end GetThreadListStackTraces */
1605 
1606 
1607 // Threads_lock NOT held, java_thread not protected by lock
1608 // java_thread - pre-checked
1609 // count_ptr - pre-checked for NULL
1610 jvmtiError
1611 JvmtiEnv::GetFrameCount(JavaThread* java_thread, jint* count_ptr) {
1612   jvmtiError err = JVMTI_ERROR_NONE;
1613 
1614   // retrieve or create JvmtiThreadState.
1615   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1616   if (state == NULL) {
1617     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1618   }
1619 
1620   // It is only safe to perform the direct operation on the current
1621   // thread. All other usage needs to use a vm-safepoint-op for safety.
1622   if (java_thread == JavaThread::current()) {
1623     err = get_frame_count(state, count_ptr);
1624   } else {
1625     // get java stack frame count at safepoint.
1626     VM_GetFrameCount op(this, state, count_ptr);
1627     VMThread::execute(&amp;op);
1628     err = op.result();
1629   }
1630   return err;
1631 } /* end GetFrameCount */
1632 
1633 
1634 // Threads_lock NOT held, java_thread not protected by lock
1635 // java_thread - pre-checked
1636 jvmtiError
1637 JvmtiEnv::PopFrame(JavaThread* java_thread) {
1638   JavaThread* current_thread  = JavaThread::current();
1639   HandleMark hm(current_thread);
1640   uint32_t debug_bits = 0;
1641 
1642   // retrieve or create the state
1643   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1644   if (state == NULL) {
1645     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1646   }
1647 
1648   // Check if java_thread is fully suspended
1649   if (!java_thread-&gt;is_thread_fully_suspended(true /* wait for suspend completion */, &amp;debug_bits)) {
1650     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1651   }
1652   // Check to see if a PopFrame was already in progress
1653   if (java_thread-&gt;popframe_condition() != JavaThread::popframe_inactive) {
1654     // Probably possible for JVMTI clients to trigger this, but the
1655     // JPDA backend shouldn&#39;t allow this to happen
1656     return JVMTI_ERROR_INTERNAL;
1657   }
1658 
1659   {
1660     // Was workaround bug
1661     //    4812902: popFrame hangs if the method is waiting at a synchronize
1662     // Catch this condition and return an error to avoid hanging.
1663     // Now JVMTI spec allows an implementation to bail out with an opaque frame error.
1664     OSThread* osThread = java_thread-&gt;osthread();
1665     if (osThread-&gt;get_state() == MONITOR_WAIT) {
1666       return JVMTI_ERROR_OPAQUE_FRAME;
1667     }
1668   }
1669 
1670   {
1671     ResourceMark rm(current_thread);
1672     // Check if there are more than one Java frame in this thread, that the top two frames
1673     // are Java (not native) frames, and that there is no intervening VM frame
1674     int frame_count = 0;
1675     bool is_interpreted[2];
1676     intptr_t *frame_sp[2];
1677     // The 2-nd arg of constructor is needed to stop iterating at java entry frame.
1678     for (vframeStream vfs(java_thread, true); !vfs.at_end(); vfs.next()) {
1679       methodHandle mh(current_thread, vfs.method());
1680       if (mh-&gt;is_native()) return(JVMTI_ERROR_OPAQUE_FRAME);
1681       is_interpreted[frame_count] = vfs.is_interpreted_frame();
1682       frame_sp[frame_count] = vfs.frame_id();
1683       if (++frame_count &gt; 1) break;
1684     }
1685     if (frame_count &lt; 2)  {
1686       // We haven&#39;t found two adjacent non-native Java frames on the top.
1687       // There can be two situations here:
1688       //  1. There are no more java frames
1689       //  2. Two top java frames are separated by non-java native frames
1690       if(vframeFor(java_thread, 1) == NULL) {
1691         return JVMTI_ERROR_NO_MORE_FRAMES;
1692       } else {
1693         // Intervening non-java native or VM frames separate java frames.
1694         // Current implementation does not support this. See bug #5031735.
1695         // In theory it is possible to pop frames in such cases.
1696         return JVMTI_ERROR_OPAQUE_FRAME;
1697       }
1698     }
1699 
1700     // If any of the top 2 frames is a compiled one, need to deoptimize it
1701     for (int i = 0; i &lt; 2; i++) {
1702       if (!is_interpreted[i]) {
1703         Deoptimization::deoptimize_frame(java_thread, frame_sp[i]);
1704       }
1705     }
1706 
1707     // Update the thread state to reflect that the top frame is popped
1708     // so that cur_stack_depth is maintained properly and all frameIDs
1709     // are invalidated.
1710     // The current frame will be popped later when the suspended thread
1711     // is resumed and right before returning from VM to Java.
1712     // (see call_VM_base() in assembler_&lt;cpu&gt;.cpp).
1713 
1714     // It&#39;s fine to update the thread state here because no JVMTI events
1715     // shall be posted for this PopFrame.
1716 
1717     // It is only safe to perform the direct operation on the current
1718     // thread. All other usage needs to use a vm-safepoint-op for safety.
1719     if (java_thread == JavaThread::current()) {
1720       state-&gt;update_for_pop_top_frame();
1721     } else {
1722       VM_UpdateForPopTopFrame op(state);
1723       VMThread::execute(&amp;op);
1724       jvmtiError err = op.result();
1725       if (err != JVMTI_ERROR_NONE) {
1726         return err;
1727       }
1728     }
1729 
1730     java_thread-&gt;set_popframe_condition(JavaThread::popframe_pending_bit);
1731     // Set pending step flag for this popframe and it is cleared when next
1732     // step event is posted.
1733     state-&gt;set_pending_step_for_popframe();
1734   }
1735 
1736   return JVMTI_ERROR_NONE;
1737 } /* end PopFrame */
1738 
1739 
1740 // Threads_lock NOT held, java_thread not protected by lock
1741 // java_thread - pre-checked
1742 // java_thread - unchecked
1743 // depth - pre-checked as non-negative
1744 // method_ptr - pre-checked for NULL
1745 // location_ptr - pre-checked for NULL
1746 jvmtiError
1747 JvmtiEnv::GetFrameLocation(JavaThread* java_thread, jint depth, jmethodID* method_ptr, jlocation* location_ptr) {
1748   jvmtiError err = JVMTI_ERROR_NONE;
1749 
1750   // It is only safe to perform the direct operation on the current
1751   // thread. All other usage needs to use a vm-safepoint-op for safety.
1752   if (java_thread == JavaThread::current()) {
1753     err = get_frame_location(java_thread, depth, method_ptr, location_ptr);
1754   } else {
1755     // JVMTI get java stack frame location at safepoint.
1756     VM_GetFrameLocation op(this, java_thread, depth, method_ptr, location_ptr);
1757     VMThread::execute(&amp;op);
1758     err = op.result();
1759   }
1760   return err;
1761 } /* end GetFrameLocation */
1762 
1763 
1764 // Threads_lock NOT held, java_thread not protected by lock
1765 // java_thread - pre-checked
1766 // java_thread - unchecked
1767 // depth - pre-checked as non-negative
1768 jvmtiError
1769 JvmtiEnv::NotifyFramePop(JavaThread* java_thread, jint depth) {
1770   jvmtiError err = JVMTI_ERROR_NONE;
1771   ResourceMark rm;
1772   uint32_t debug_bits = 0;
1773 
1774   JvmtiThreadState *state = JvmtiThreadState::state_for(java_thread);
1775   if (state == NULL) {
1776     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1777   }
1778 
1779   if (!java_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {
1780     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1781   }
1782 
1783   if (TraceJVMTICalls) {
1784     JvmtiSuspendControl::print();
1785   }
1786 
1787   vframe *vf = vframeFor(java_thread, depth);
1788   if (vf == NULL) {
1789     return JVMTI_ERROR_NO_MORE_FRAMES;
1790   }
1791 
1792   if (!vf-&gt;is_java_frame() || ((javaVFrame*) vf)-&gt;method()-&gt;is_native()) {
1793     return JVMTI_ERROR_OPAQUE_FRAME;
1794   }
1795 
1796   assert(vf-&gt;frame_pointer() != NULL, &quot;frame pointer mustn&#39;t be NULL&quot;);
1797 
1798   // It is only safe to perform the direct operation on the current
1799   // thread. All other usage needs to use a vm-safepoint-op for safety.
1800   if (java_thread == JavaThread::current()) {
1801     int frame_number = state-&gt;count_frames() - depth;
1802     state-&gt;env_thread_state(this)-&gt;set_frame_pop(frame_number);
1803   } else {
1804     VM_SetFramePop op(this, state, depth);
1805     VMThread::execute(&amp;op);
1806     err = op.result();
1807   }
1808   return err;
1809 } /* end NotifyFramePop */
1810 
1811 
1812   //
1813   // Force Early Return functions
1814   //
1815 
1816 // Threads_lock NOT held, java_thread not protected by lock
1817 // java_thread - pre-checked
1818 jvmtiError
1819 JvmtiEnv::ForceEarlyReturnObject(JavaThread* java_thread, jobject value) {
1820   jvalue val;
1821   val.l = value;
1822   return force_early_return(java_thread, val, atos);
1823 } /* end ForceEarlyReturnObject */
1824 
1825 
1826 // Threads_lock NOT held, java_thread not protected by lock
1827 // java_thread - pre-checked
1828 jvmtiError
1829 JvmtiEnv::ForceEarlyReturnInt(JavaThread* java_thread, jint value) {
1830   jvalue val;
1831   val.i = value;
1832   return force_early_return(java_thread, val, itos);
1833 } /* end ForceEarlyReturnInt */
1834 
1835 
1836 // Threads_lock NOT held, java_thread not protected by lock
1837 // java_thread - pre-checked
1838 jvmtiError
1839 JvmtiEnv::ForceEarlyReturnLong(JavaThread* java_thread, jlong value) {
1840   jvalue val;
1841   val.j = value;
1842   return force_early_return(java_thread, val, ltos);
1843 } /* end ForceEarlyReturnLong */
1844 
1845 
1846 // Threads_lock NOT held, java_thread not protected by lock
1847 // java_thread - pre-checked
1848 jvmtiError
1849 JvmtiEnv::ForceEarlyReturnFloat(JavaThread* java_thread, jfloat value) {
1850   jvalue val;
1851   val.f = value;
1852   return force_early_return(java_thread, val, ftos);
1853 } /* end ForceEarlyReturnFloat */
1854 
1855 
1856 // Threads_lock NOT held, java_thread not protected by lock
1857 // java_thread - pre-checked
1858 jvmtiError
1859 JvmtiEnv::ForceEarlyReturnDouble(JavaThread* java_thread, jdouble value) {
1860   jvalue val;
1861   val.d = value;
1862   return force_early_return(java_thread, val, dtos);
1863 } /* end ForceEarlyReturnDouble */
1864 
1865 
1866 // Threads_lock NOT held, java_thread not protected by lock
1867 // java_thread - pre-checked
1868 jvmtiError
1869 JvmtiEnv::ForceEarlyReturnVoid(JavaThread* java_thread) {
1870   jvalue val;
1871   val.j = 0L;
1872   return force_early_return(java_thread, val, vtos);
1873 } /* end ForceEarlyReturnVoid */
1874 
1875 
1876   //
1877   // Heap functions
1878   //
1879 
1880 // klass - NULL is a valid value, must be checked
1881 // initial_object - NULL is a valid value, must be checked
1882 // callbacks - pre-checked for NULL
1883 // user_data - NULL is a valid value, must be checked
1884 jvmtiError
1885 JvmtiEnv::FollowReferences(jint heap_filter, jclass klass, jobject initial_object, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
1886   // check klass if provided
1887   Klass* k = NULL;
1888   if (klass != NULL) {
1889     oop k_mirror = JNIHandles::resolve_external_guard(klass);
1890     if (k_mirror == NULL) {
1891       return JVMTI_ERROR_INVALID_CLASS;
1892     }
1893     if (java_lang_Class::is_primitive(k_mirror)) {
1894       return JVMTI_ERROR_NONE;
1895     }
1896     k = java_lang_Class::as_Klass(k_mirror);
1897     if (klass == NULL) {
1898       return JVMTI_ERROR_INVALID_CLASS;
1899     }
1900   }
1901 
1902   if (initial_object != NULL) {
1903     oop init_obj = JNIHandles::resolve_external_guard(initial_object);
1904     if (init_obj == NULL) {
1905       return JVMTI_ERROR_INVALID_OBJECT;
1906     }
1907   }
1908 
1909   Thread *thread = Thread::current();
1910   HandleMark hm(thread);
1911 
1912   TraceTime t(&quot;FollowReferences&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1913   JvmtiTagMap::tag_map_for(this)-&gt;follow_references(heap_filter, k, initial_object, callbacks, user_data);
1914   return JVMTI_ERROR_NONE;
1915 } /* end FollowReferences */
1916 
1917 
1918 // klass - NULL is a valid value, must be checked
1919 // callbacks - pre-checked for NULL
1920 // user_data - NULL is a valid value, must be checked
1921 jvmtiError
1922 JvmtiEnv::IterateThroughHeap(jint heap_filter, jclass klass, const jvmtiHeapCallbacks* callbacks, const void* user_data) {
1923   // check klass if provided
1924   Klass* k = NULL;
1925   if (klass != NULL) {
1926     oop k_mirror = JNIHandles::resolve_external_guard(klass);
1927     if (k_mirror == NULL) {
1928       return JVMTI_ERROR_INVALID_CLASS;
1929     }
1930     if (java_lang_Class::is_primitive(k_mirror)) {
1931       return JVMTI_ERROR_NONE;
1932     }
1933     k = java_lang_Class::as_Klass(k_mirror);
1934     if (k == NULL) {
1935       return JVMTI_ERROR_INVALID_CLASS;
1936     }
1937   }
1938 
1939   TraceTime t(&quot;IterateThroughHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1940   JvmtiTagMap::tag_map_for(this)-&gt;iterate_through_heap(heap_filter, k, callbacks, user_data);
1941   return JVMTI_ERROR_NONE;
1942 } /* end IterateThroughHeap */
1943 
1944 
1945 // tag_ptr - pre-checked for NULL
1946 jvmtiError
1947 JvmtiEnv::GetTag(jobject object, jlong* tag_ptr) {
1948   oop o = JNIHandles::resolve_external_guard(object);
1949   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1950   *tag_ptr = JvmtiTagMap::tag_map_for(this)-&gt;get_tag(object);
1951   return JVMTI_ERROR_NONE;
1952 } /* end GetTag */
1953 
1954 
1955 jvmtiError
1956 JvmtiEnv::SetTag(jobject object, jlong tag) {
1957   oop o = JNIHandles::resolve_external_guard(object);
1958   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1959   JvmtiTagMap::tag_map_for(this)-&gt;set_tag(object, tag);
1960   return JVMTI_ERROR_NONE;
1961 } /* end SetTag */
1962 
1963 
1964 // tag_count - pre-checked to be greater than or equal to 0
1965 // tags - pre-checked for NULL
1966 // count_ptr - pre-checked for NULL
1967 // object_result_ptr - NULL is a valid value, must be checked
1968 // tag_result_ptr - NULL is a valid value, must be checked
1969 jvmtiError
1970 JvmtiEnv::GetObjectsWithTags(jint tag_count, const jlong* tags, jint* count_ptr, jobject** object_result_ptr, jlong** tag_result_ptr) {
1971   TraceTime t(&quot;GetObjectsWithTags&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
1972   return JvmtiTagMap::tag_map_for(this)-&gt;get_objects_with_tags((jlong*)tags, tag_count, count_ptr, object_result_ptr, tag_result_ptr);
1973 } /* end GetObjectsWithTags */
1974 
1975 
1976 jvmtiError
1977 JvmtiEnv::ForceGarbageCollection() {
1978   Universe::heap()-&gt;collect(GCCause::_jvmti_force_gc);
1979   return JVMTI_ERROR_NONE;
1980 } /* end ForceGarbageCollection */
1981 
1982 
1983   //
1984   // Heap (1.0) functions
1985   //
1986 
1987 // object_reference_callback - pre-checked for NULL
1988 // user_data - NULL is a valid value, must be checked
1989 jvmtiError
1990 JvmtiEnv::IterateOverObjectsReachableFromObject(jobject object, jvmtiObjectReferenceCallback object_reference_callback, const void* user_data) {
1991   oop o = JNIHandles::resolve_external_guard(object);
1992   NULL_CHECK(o, JVMTI_ERROR_INVALID_OBJECT);
1993   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_objects_reachable_from_object(object, object_reference_callback, user_data);
1994   return JVMTI_ERROR_NONE;
1995 } /* end IterateOverObjectsReachableFromObject */
1996 
1997 
1998 // heap_root_callback - NULL is a valid value, must be checked
1999 // stack_ref_callback - NULL is a valid value, must be checked
2000 // object_ref_callback - NULL is a valid value, must be checked
2001 // user_data - NULL is a valid value, must be checked
2002 jvmtiError
2003 JvmtiEnv::IterateOverReachableObjects(jvmtiHeapRootCallback heap_root_callback, jvmtiStackReferenceCallback stack_ref_callback, jvmtiObjectReferenceCallback object_ref_callback, const void* user_data) {
2004   TraceTime t(&quot;IterateOverReachableObjects&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2005   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_reachable_objects(heap_root_callback, stack_ref_callback, object_ref_callback, user_data);
2006   return JVMTI_ERROR_NONE;
2007 } /* end IterateOverReachableObjects */
2008 
2009 
2010 // heap_object_callback - pre-checked for NULL
2011 // user_data - NULL is a valid value, must be checked
2012 jvmtiError
2013 JvmtiEnv::IterateOverHeap(jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2014   TraceTime t(&quot;IterateOverHeap&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2015   Thread *thread = Thread::current();
2016   HandleMark hm(thread);
2017   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, NULL, heap_object_callback, user_data);
2018   return JVMTI_ERROR_NONE;
2019 } /* end IterateOverHeap */
2020 
2021 
2022 // k_mirror - may be primitive, this must be checked
2023 // heap_object_callback - pre-checked for NULL
2024 // user_data - NULL is a valid value, must be checked
2025 jvmtiError
2026 JvmtiEnv::IterateOverInstancesOfClass(oop k_mirror, jvmtiHeapObjectFilter object_filter, jvmtiHeapObjectCallback heap_object_callback, const void* user_data) {
2027   if (java_lang_Class::is_primitive(k_mirror)) {
2028     // DO PRIMITIVE CLASS PROCESSING
2029     return JVMTI_ERROR_NONE;
2030   }
2031   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2032   if (klass == NULL) {
2033     return JVMTI_ERROR_INVALID_CLASS;
2034   }
2035   TraceTime t(&quot;IterateOverInstancesOfClass&quot;, TRACETIME_LOG(Debug, jvmti, objecttagging));
2036   JvmtiTagMap::tag_map_for(this)-&gt;iterate_over_heap(object_filter, klass, heap_object_callback, user_data);
2037   return JVMTI_ERROR_NONE;
2038 } /* end IterateOverInstancesOfClass */
2039 
2040 
2041   //
2042   // Local Variable functions
2043   //
2044 
2045 // Threads_lock NOT held, java_thread not protected by lock
2046 // java_thread - pre-checked
2047 // java_thread - unchecked
2048 // depth - pre-checked as non-negative
2049 // value_ptr - pre-checked for NULL
2050 jvmtiError
2051 JvmtiEnv::GetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject* value_ptr) {
2052   JavaThread* current_thread = JavaThread::current();
2053   // rm object is created to clean up the javaVFrame created in
2054   // doit_prologue(), but after doit() is finished with it.
2055   ResourceMark rm(current_thread);
2056 
2057   VM_GetOrSetLocal op(java_thread, current_thread, depth, slot);
2058   VMThread::execute(&amp;op);
2059   jvmtiError err = op.result();
2060   if (err != JVMTI_ERROR_NONE) {
2061     return err;
2062   } else {
2063     *value_ptr = op.value().l;
2064     return JVMTI_ERROR_NONE;
2065   }
2066 } /* end GetLocalObject */
2067 
2068 // Threads_lock NOT held, java_thread not protected by lock
2069 // java_thread - pre-checked
2070 // java_thread - unchecked
2071 // depth - pre-checked as non-negative
2072 // value - pre-checked for NULL
2073 jvmtiError
2074 JvmtiEnv::GetLocalInstance(JavaThread* java_thread, jint depth, jobject* value_ptr){
2075   JavaThread* current_thread = JavaThread::current();
2076   // rm object is created to clean up the javaVFrame created in
2077   // doit_prologue(), but after doit() is finished with it.
2078   ResourceMark rm(current_thread);
2079 
2080   VM_GetReceiver op(java_thread, current_thread, depth);
2081   VMThread::execute(&amp;op);
2082   jvmtiError err = op.result();
2083   if (err != JVMTI_ERROR_NONE) {
2084     return err;
2085   } else {
2086     *value_ptr = op.value().l;
2087     return JVMTI_ERROR_NONE;
2088   }
2089 } /* end GetLocalInstance */
2090 
2091 
2092 // Threads_lock NOT held, java_thread not protected by lock
2093 // java_thread - pre-checked
2094 // java_thread - unchecked
2095 // depth - pre-checked as non-negative
2096 // value_ptr - pre-checked for NULL
2097 jvmtiError
2098 JvmtiEnv::GetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint* value_ptr) {
2099   // rm object is created to clean up the javaVFrame created in
2100   // doit_prologue(), but after doit() is finished with it.
2101   ResourceMark rm;
2102 
2103   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT);
2104   VMThread::execute(&amp;op);
2105   *value_ptr = op.value().i;
2106   return op.result();
2107 } /* end GetLocalInt */
2108 
2109 
2110 // Threads_lock NOT held, java_thread not protected by lock
2111 // java_thread - pre-checked
2112 // java_thread - unchecked
2113 // depth - pre-checked as non-negative
2114 // value_ptr - pre-checked for NULL
2115 jvmtiError
2116 JvmtiEnv::GetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong* value_ptr) {
2117   // rm object is created to clean up the javaVFrame created in
2118   // doit_prologue(), but after doit() is finished with it.
2119   ResourceMark rm;
2120 
2121   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG);
2122   VMThread::execute(&amp;op);
2123   *value_ptr = op.value().j;
2124   return op.result();
2125 } /* end GetLocalLong */
2126 
2127 
2128 // Threads_lock NOT held, java_thread not protected by lock
2129 // java_thread - pre-checked
2130 // java_thread - unchecked
2131 // depth - pre-checked as non-negative
2132 // value_ptr - pre-checked for NULL
2133 jvmtiError
2134 JvmtiEnv::GetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat* value_ptr) {
2135   // rm object is created to clean up the javaVFrame created in
2136   // doit_prologue(), but after doit() is finished with it.
2137   ResourceMark rm;
2138 
2139   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT);
2140   VMThread::execute(&amp;op);
2141   *value_ptr = op.value().f;
2142   return op.result();
2143 } /* end GetLocalFloat */
2144 
2145 
2146 // Threads_lock NOT held, java_thread not protected by lock
2147 // java_thread - pre-checked
2148 // java_thread - unchecked
2149 // depth - pre-checked as non-negative
2150 // value_ptr - pre-checked for NULL
2151 jvmtiError
2152 JvmtiEnv::GetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble* value_ptr) {
2153   // rm object is created to clean up the javaVFrame created in
2154   // doit_prologue(), but after doit() is finished with it.
2155   ResourceMark rm;
2156 
2157   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE);
2158   VMThread::execute(&amp;op);
2159   *value_ptr = op.value().d;
2160   return op.result();
2161 } /* end GetLocalDouble */
2162 
2163 
2164 // Threads_lock NOT held, java_thread not protected by lock
2165 // java_thread - pre-checked
2166 // java_thread - unchecked
2167 // depth - pre-checked as non-negative
2168 jvmtiError
2169 JvmtiEnv::SetLocalObject(JavaThread* java_thread, jint depth, jint slot, jobject value) {
2170   // rm object is created to clean up the javaVFrame created in
2171   // doit_prologue(), but after doit() is finished with it.
2172   ResourceMark rm;
2173   jvalue val;
2174   val.l = value;
2175   VM_GetOrSetLocal op(java_thread, depth, slot, T_OBJECT, val);
2176   VMThread::execute(&amp;op);
2177   return op.result();
2178 } /* end SetLocalObject */
2179 
2180 
2181 // Threads_lock NOT held, java_thread not protected by lock
2182 // java_thread - pre-checked
2183 // java_thread - unchecked
2184 // depth - pre-checked as non-negative
2185 jvmtiError
2186 JvmtiEnv::SetLocalInt(JavaThread* java_thread, jint depth, jint slot, jint value) {
2187   // rm object is created to clean up the javaVFrame created in
2188   // doit_prologue(), but after doit() is finished with it.
2189   ResourceMark rm;
2190   jvalue val;
2191   val.i = value;
2192   VM_GetOrSetLocal op(java_thread, depth, slot, T_INT, val);
2193   VMThread::execute(&amp;op);
2194   return op.result();
2195 } /* end SetLocalInt */
2196 
2197 
2198 // Threads_lock NOT held, java_thread not protected by lock
2199 // java_thread - pre-checked
2200 // java_thread - unchecked
2201 // depth - pre-checked as non-negative
2202 jvmtiError
2203 JvmtiEnv::SetLocalLong(JavaThread* java_thread, jint depth, jint slot, jlong value) {
2204   // rm object is created to clean up the javaVFrame created in
2205   // doit_prologue(), but after doit() is finished with it.
2206   ResourceMark rm;
2207   jvalue val;
2208   val.j = value;
2209   VM_GetOrSetLocal op(java_thread, depth, slot, T_LONG, val);
2210   VMThread::execute(&amp;op);
2211   return op.result();
2212 } /* end SetLocalLong */
2213 
2214 
2215 // Threads_lock NOT held, java_thread not protected by lock
2216 // java_thread - pre-checked
2217 // java_thread - unchecked
2218 // depth - pre-checked as non-negative
2219 jvmtiError
2220 JvmtiEnv::SetLocalFloat(JavaThread* java_thread, jint depth, jint slot, jfloat value) {
2221   // rm object is created to clean up the javaVFrame created in
2222   // doit_prologue(), but after doit() is finished with it.
2223   ResourceMark rm;
2224   jvalue val;
2225   val.f = value;
2226   VM_GetOrSetLocal op(java_thread, depth, slot, T_FLOAT, val);
2227   VMThread::execute(&amp;op);
2228   return op.result();
2229 } /* end SetLocalFloat */
2230 
2231 
2232 // Threads_lock NOT held, java_thread not protected by lock
2233 // java_thread - pre-checked
2234 // java_thread - unchecked
2235 // depth - pre-checked as non-negative
2236 jvmtiError
2237 JvmtiEnv::SetLocalDouble(JavaThread* java_thread, jint depth, jint slot, jdouble value) {
2238   // rm object is created to clean up the javaVFrame created in
2239   // doit_prologue(), but after doit() is finished with it.
2240   ResourceMark rm;
2241   jvalue val;
2242   val.d = value;
2243   VM_GetOrSetLocal op(java_thread, depth, slot, T_DOUBLE, val);
2244   VMThread::execute(&amp;op);
2245   return op.result();
2246 } /* end SetLocalDouble */
2247 
2248 
2249   //
2250   // Breakpoint functions
2251   //
2252 
2253 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2254 jvmtiError
2255 JvmtiEnv::SetBreakpoint(Method* method_oop, jlocation location) {
2256   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2257   if (location &lt; 0) {   // simple invalid location check first
2258     return JVMTI_ERROR_INVALID_LOCATION;
2259   }
2260   // verify that the breakpoint is not past the end of the method
2261   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2262     return JVMTI_ERROR_INVALID_LOCATION;
2263   }
2264 
2265   ResourceMark rm;
2266   JvmtiBreakpoint bp(method_oop, location);
2267   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2268   if (jvmti_breakpoints.set(bp) == JVMTI_ERROR_DUPLICATE)
2269     return JVMTI_ERROR_DUPLICATE;
2270 
2271   if (TraceJVMTICalls) {
2272     jvmti_breakpoints.print();
2273   }
2274 
2275   return JVMTI_ERROR_NONE;
2276 } /* end SetBreakpoint */
2277 
2278 
2279 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2280 jvmtiError
2281 JvmtiEnv::ClearBreakpoint(Method* method_oop, jlocation location) {
2282   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2283 
2284   if (location &lt; 0) {   // simple invalid location check first
2285     return JVMTI_ERROR_INVALID_LOCATION;
2286   }
2287 
2288   // verify that the breakpoint is not past the end of the method
2289   if (location &gt;= (jlocation) method_oop-&gt;code_size()) {
2290     return JVMTI_ERROR_INVALID_LOCATION;
2291   }
2292 
2293   JvmtiBreakpoint bp(method_oop, location);
2294 
2295   JvmtiBreakpoints&amp; jvmti_breakpoints = JvmtiCurrentBreakpoints::get_jvmti_breakpoints();
2296   if (jvmti_breakpoints.clear(bp) == JVMTI_ERROR_NOT_FOUND)
2297     return JVMTI_ERROR_NOT_FOUND;
2298 
2299   if (TraceJVMTICalls) {
2300     jvmti_breakpoints.print();
2301   }
2302 
2303   return JVMTI_ERROR_NONE;
2304 } /* end ClearBreakpoint */
2305 
2306 
2307   //
2308   // Watched Field functions
2309   //
2310 
2311 jvmtiError
2312 JvmtiEnv::SetFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2313   // make sure we haven&#39;t set this watch before
2314   if (fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_DUPLICATE;
2315   fdesc_ptr-&gt;set_is_field_access_watched(true);
2316 
2317   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, true);
2318 
2319   return JVMTI_ERROR_NONE;
2320 } /* end SetFieldAccessWatch */
2321 
2322 
2323 jvmtiError
2324 JvmtiEnv::ClearFieldAccessWatch(fieldDescriptor* fdesc_ptr) {
2325   // make sure we have a watch to clear
2326   if (!fdesc_ptr-&gt;is_field_access_watched()) return JVMTI_ERROR_NOT_FOUND;
2327   fdesc_ptr-&gt;set_is_field_access_watched(false);
2328 
2329   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_ACCESS, false);
2330 
2331   return JVMTI_ERROR_NONE;
2332 } /* end ClearFieldAccessWatch */
2333 
2334 
2335 jvmtiError
2336 JvmtiEnv::SetFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2337   // make sure we haven&#39;t set this watch before
2338   if (fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_DUPLICATE;
2339   fdesc_ptr-&gt;set_is_field_modification_watched(true);
2340 
2341   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, true);
2342 
2343   return JVMTI_ERROR_NONE;
2344 } /* end SetFieldModificationWatch */
2345 
2346 
2347 jvmtiError
2348 JvmtiEnv::ClearFieldModificationWatch(fieldDescriptor* fdesc_ptr) {
2349    // make sure we have a watch to clear
2350   if (!fdesc_ptr-&gt;is_field_modification_watched()) return JVMTI_ERROR_NOT_FOUND;
2351   fdesc_ptr-&gt;set_is_field_modification_watched(false);
2352 
2353   JvmtiEventController::change_field_watch(JVMTI_EVENT_FIELD_MODIFICATION, false);
2354 
2355   return JVMTI_ERROR_NONE;
2356 } /* end ClearFieldModificationWatch */
2357 
2358   //
2359   // Class functions
2360   //
2361 
2362 
2363 // k_mirror - may be primitive, this must be checked
2364 // signature_ptr - NULL is a valid value, must be checked
2365 // generic_ptr - NULL is a valid value, must be checked
2366 jvmtiError
2367 JvmtiEnv::GetClassSignature(oop k_mirror, char** signature_ptr, char** generic_ptr) {
2368   ResourceMark rm;
2369   bool isPrimitive = java_lang_Class::is_primitive(k_mirror);
2370   Klass* k = NULL;
2371   if (!isPrimitive) {
2372     k = java_lang_Class::as_Klass(k_mirror);
2373     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2374   }
2375   if (signature_ptr != NULL) {
2376     char* result = NULL;
2377     if (isPrimitive) {
2378       char tchar = type2char(java_lang_Class::primitive_type(k_mirror));
2379       result = (char*) jvmtiMalloc(2);
2380       result[0] = tchar;
2381       result[1] = &#39;\0&#39;;
2382     } else {
2383       const char* class_sig = k-&gt;signature_name();
2384       result = (char *) jvmtiMalloc(strlen(class_sig)+1);
2385       strcpy(result, class_sig);
2386     }
2387     *signature_ptr = result;
2388   }
2389   if (generic_ptr != NULL) {
2390     *generic_ptr = NULL;
2391     if (!isPrimitive &amp;&amp; k-&gt;is_instance_klass()) {
2392       Symbol* soo = InstanceKlass::cast(k)-&gt;generic_signature();
2393       if (soo != NULL) {
2394         const char *gen_sig = soo-&gt;as_C_string();
2395         if (gen_sig != NULL) {
2396           char* gen_result;
2397           jvmtiError err = allocate(strlen(gen_sig) + 1,
2398                                     (unsigned char **)&amp;gen_result);
2399           if (err != JVMTI_ERROR_NONE) {
2400             return err;
2401           }
2402           strcpy(gen_result, gen_sig);
2403           *generic_ptr = gen_result;
2404         }
2405       }
2406     }
2407   }
2408   return JVMTI_ERROR_NONE;
2409 } /* end GetClassSignature */
2410 
2411 
2412 // k_mirror - may be primitive, this must be checked
2413 // status_ptr - pre-checked for NULL
2414 jvmtiError
2415 JvmtiEnv::GetClassStatus(oop k_mirror, jint* status_ptr) {
2416   jint result = 0;
2417   if (java_lang_Class::is_primitive(k_mirror)) {
2418     result |= JVMTI_CLASS_STATUS_PRIMITIVE;
2419   } else {
2420     Klass* k = java_lang_Class::as_Klass(k_mirror);
2421     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2422     result = k-&gt;jvmti_class_status();
2423   }
2424   *status_ptr = result;
2425 
2426   return JVMTI_ERROR_NONE;
2427 } /* end GetClassStatus */
2428 
2429 
2430 // k_mirror - may be primitive, this must be checked
2431 // source_name_ptr - pre-checked for NULL
2432 jvmtiError
2433 JvmtiEnv::GetSourceFileName(oop k_mirror, char** source_name_ptr) {
2434   if (java_lang_Class::is_primitive(k_mirror)) {
2435      return JVMTI_ERROR_ABSENT_INFORMATION;
2436   }
2437   Klass* k_klass = java_lang_Class::as_Klass(k_mirror);
2438   NULL_CHECK(k_klass, JVMTI_ERROR_INVALID_CLASS);
2439 
2440   if (!k_klass-&gt;is_instance_klass()) {
2441     return JVMTI_ERROR_ABSENT_INFORMATION;
2442   }
2443 
2444   Symbol* sfnOop = InstanceKlass::cast(k_klass)-&gt;source_file_name();
2445   NULL_CHECK(sfnOop, JVMTI_ERROR_ABSENT_INFORMATION);
2446   {
2447     JavaThread* current_thread  = JavaThread::current();
2448     ResourceMark rm(current_thread);
2449     const char* sfncp = (const char*) sfnOop-&gt;as_C_string();
2450     *source_name_ptr = (char *) jvmtiMalloc(strlen(sfncp)+1);
2451     strcpy(*source_name_ptr, sfncp);
2452   }
2453 
2454   return JVMTI_ERROR_NONE;
2455 } /* end GetSourceFileName */
2456 
2457 
2458 // k_mirror - may be primitive, this must be checked
2459 // modifiers_ptr - pre-checked for NULL
2460 jvmtiError
2461 JvmtiEnv::GetClassModifiers(oop k_mirror, jint* modifiers_ptr) {
2462   JavaThread* current_thread  = JavaThread::current();
2463   jint result = 0;
2464   if (!java_lang_Class::is_primitive(k_mirror)) {
2465     Klass* k = java_lang_Class::as_Klass(k_mirror);
2466     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2467     result = k-&gt;compute_modifier_flags(current_thread);
2468     JavaThread* THREAD = current_thread; // pass to macros
2469     if (HAS_PENDING_EXCEPTION) {
2470       CLEAR_PENDING_EXCEPTION;
2471       return JVMTI_ERROR_INTERNAL;
2472     };
2473 
2474     // Reset the deleted  ACC_SUPER bit ( deleted in compute_modifier_flags()).
2475     if(k-&gt;is_super()) {
2476       result |= JVM_ACC_SUPER;
2477     }
2478   } else {
2479     result = (JVM_ACC_ABSTRACT | JVM_ACC_FINAL | JVM_ACC_PUBLIC);
2480   }
2481   *modifiers_ptr = result;
2482 
2483   return JVMTI_ERROR_NONE;
2484 } /* end GetClassModifiers */
2485 
2486 
2487 // k_mirror - may be primitive, this must be checked
2488 // method_count_ptr - pre-checked for NULL
2489 // methods_ptr - pre-checked for NULL
2490 jvmtiError
2491 JvmtiEnv::GetClassMethods(oop k_mirror, jint* method_count_ptr, jmethodID** methods_ptr) {
2492   JavaThread* current_thread  = JavaThread::current();
2493   HandleMark hm(current_thread);
2494 
2495   if (java_lang_Class::is_primitive(k_mirror)) {
2496     *method_count_ptr = 0;
2497     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2498     return JVMTI_ERROR_NONE;
2499   }
2500   Klass* k = java_lang_Class::as_Klass(k_mirror);
2501   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2502 
2503   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2504   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2505     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2506   }
2507 
2508   if (!k-&gt;is_instance_klass()) {
2509     *method_count_ptr = 0;
2510     *methods_ptr = (jmethodID*) jvmtiMalloc(0 * sizeof(jmethodID));
2511     return JVMTI_ERROR_NONE;
2512   }
2513   InstanceKlass* ik = InstanceKlass::cast(k);
2514   // Allocate the result and fill it in
2515   int result_length = ik-&gt;methods()-&gt;length();
2516   jmethodID* result_list = (jmethodID*)jvmtiMalloc(result_length * sizeof(jmethodID));
2517   int index;
2518   bool jmethodids_found = true;
2519 
2520   if (JvmtiExport::can_maintain_original_method_order()) {
2521     // Use the original method ordering indices stored in the class, so we can emit
2522     // jmethodIDs in the order they appeared in the class file
2523     for (index = 0; index &lt; result_length; index++) {
2524       Method* m = ik-&gt;methods()-&gt;at(index);
2525       int original_index = ik-&gt;method_ordering()-&gt;at(index);
2526       assert(original_index &gt;= 0 &amp;&amp; original_index &lt; result_length, &quot;invalid original method index&quot;);
2527       jmethodID id;
2528       if (jmethodids_found) {
2529         id = m-&gt;find_jmethod_id_or_null();
2530         if (id == NULL) {
2531           // If we find an uninitialized value, make sure there is
2532           // enough space for all the uninitialized values we might
2533           // find.
2534           ik-&gt;ensure_space_for_methodids(index);
2535           jmethodids_found = false;
2536           id = m-&gt;jmethod_id();
2537         }
2538       } else {
2539         id = m-&gt;jmethod_id();
2540       }
2541       result_list[original_index] = id;
2542     }
2543   } else {
2544     // otherwise just copy in any order
2545     for (index = 0; index &lt; result_length; index++) {
2546       Method* m = ik-&gt;methods()-&gt;at(index);
2547       jmethodID id;
2548       if (jmethodids_found) {
2549         id = m-&gt;find_jmethod_id_or_null();
2550         if (id == NULL) {
2551           // If we find an uninitialized value, make sure there is
2552           // enough space for all the uninitialized values we might
2553           // find.
2554           ik-&gt;ensure_space_for_methodids(index);
2555           jmethodids_found = false;
2556           id = m-&gt;jmethod_id();
2557         }
2558       } else {
2559         id = m-&gt;jmethod_id();
2560       }
2561       result_list[index] = id;
2562     }
2563   }
2564   // Fill in return value.
2565   *method_count_ptr = result_length;
2566   *methods_ptr = result_list;
2567 
2568   return JVMTI_ERROR_NONE;
2569 } /* end GetClassMethods */
2570 
2571 
2572 // k_mirror - may be primitive, this must be checked
2573 // field_count_ptr - pre-checked for NULL
2574 // fields_ptr - pre-checked for NULL
2575 jvmtiError
2576 JvmtiEnv::GetClassFields(oop k_mirror, jint* field_count_ptr, jfieldID** fields_ptr) {
2577   if (java_lang_Class::is_primitive(k_mirror)) {
2578     *field_count_ptr = 0;
2579     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2580     return JVMTI_ERROR_NONE;
2581   }
2582   JavaThread* current_thread = JavaThread::current();
2583   HandleMark hm(current_thread);
2584   Klass* k = java_lang_Class::as_Klass(k_mirror);
2585   NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2586 
2587   // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2588   if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) )) {
2589     return JVMTI_ERROR_CLASS_NOT_PREPARED;
2590   }
2591 
2592   if (!k-&gt;is_instance_klass()) {
2593     *field_count_ptr = 0;
2594     *fields_ptr = (jfieldID*) jvmtiMalloc(0 * sizeof(jfieldID));
2595     return JVMTI_ERROR_NONE;
2596   }
2597 
2598 
2599   InstanceKlass* ik = InstanceKlass::cast(k);
2600 
2601   int result_count = 0;
2602   // First, count the fields.
2603   FilteredFieldStream flds(ik, true, true);
2604   result_count = flds.field_count();
2605 
2606   // Allocate the result and fill it in
2607   jfieldID* result_list = (jfieldID*) jvmtiMalloc(result_count * sizeof(jfieldID));
2608   // The JVMTI spec requires fields in the order they occur in the class file,
2609   // this is the reverse order of what FieldStream hands out.
2610   int id_index = (result_count - 1);
2611 
2612   for (FilteredFieldStream src_st(ik, true, true); !src_st.eos(); src_st.next()) {
2613     result_list[id_index--] = jfieldIDWorkaround::to_jfieldID(
2614                                             ik, src_st.offset(),
2615                                             src_st.access_flags().is_static(),
2616                                             src_st.field_descriptor().is_inlined());
2617   }
2618   assert(id_index == -1, &quot;just checking&quot;);
2619   // Fill in the results
2620   *field_count_ptr = result_count;
2621   *fields_ptr = result_list;
2622 
2623   return JVMTI_ERROR_NONE;
2624 } /* end GetClassFields */
2625 
2626 
2627 // k_mirror - may be primitive, this must be checked
2628 // interface_count_ptr - pre-checked for NULL
2629 // interfaces_ptr - pre-checked for NULL
2630 jvmtiError
2631 JvmtiEnv::GetImplementedInterfaces(oop k_mirror, jint* interface_count_ptr, jclass** interfaces_ptr) {
2632   {
2633     if (java_lang_Class::is_primitive(k_mirror)) {
2634       *interface_count_ptr = 0;
2635       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2636       return JVMTI_ERROR_NONE;
2637     }
2638     JavaThread* current_thread = JavaThread::current();
2639     HandleMark hm(current_thread);
2640     Klass* k = java_lang_Class::as_Klass(k_mirror);
2641     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2642 
2643     // Return CLASS_NOT_PREPARED error as per JVMTI spec.
2644     if (!(k-&gt;jvmti_class_status() &amp; (JVMTI_CLASS_STATUS_PREPARED|JVMTI_CLASS_STATUS_ARRAY) ))
2645       return JVMTI_ERROR_CLASS_NOT_PREPARED;
2646 
2647     if (!k-&gt;is_instance_klass()) {
2648       *interface_count_ptr = 0;
2649       *interfaces_ptr = (jclass*) jvmtiMalloc(0 * sizeof(jclass));
2650       return JVMTI_ERROR_NONE;
2651     }
2652 
2653     InstanceKlass* ik = InstanceKlass::cast(k);
2654     Array&lt;InstanceKlass*&gt;* interface_list = ik-&gt;local_interfaces();
2655     int result_length = (interface_list == NULL ? 0 : interface_list-&gt;length());
2656     if (ik-&gt;has_injected_identityObject()) result_length--;
2657     jclass* result_list = (jclass*) jvmtiMalloc(result_length * sizeof(jclass));
2658     int cursor = 0;
2659     for (int i_index = 0; i_index &lt; result_length; i_index += 1) {
2660       InstanceKlass* klass_at = interface_list-&gt;at(i_index);
2661       assert(klass_at-&gt;is_klass(), &quot;interfaces must be Klass*s&quot;);
2662       assert(klass_at-&gt;is_interface(), &quot;interfaces must be interfaces&quot;);
2663       if (klass_at != SystemDictionary::IdentityObject_klass() || !ik-&gt;has_injected_identityObject()) {
2664         oop mirror_at = klass_at-&gt;java_mirror();
2665         Handle handle_at = Handle(current_thread, mirror_at);
2666         result_list[cursor++] = (jclass) jni_reference(handle_at);
2667       }
2668     }
2669     *interface_count_ptr = result_length;
2670     *interfaces_ptr = result_list;
2671   }
2672 
2673   return JVMTI_ERROR_NONE;
2674 } /* end GetImplementedInterfaces */
2675 
2676 
2677 // k_mirror - may be primitive, this must be checked
2678 // minor_version_ptr - pre-checked for NULL
2679 // major_version_ptr - pre-checked for NULL
2680 jvmtiError
2681 JvmtiEnv::GetClassVersionNumbers(oop k_mirror, jint* minor_version_ptr, jint* major_version_ptr) {
2682   if (java_lang_Class::is_primitive(k_mirror)) {
2683     return JVMTI_ERROR_ABSENT_INFORMATION;
2684   }
2685   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2686 
2687   jint status = klass-&gt;jvmti_class_status();
2688   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
2689     return JVMTI_ERROR_INVALID_CLASS;
2690   }
2691   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
2692     return JVMTI_ERROR_ABSENT_INFORMATION;
2693   }
2694 
2695   InstanceKlass* ik = InstanceKlass::cast(klass);
2696   *minor_version_ptr = ik-&gt;minor_version();
2697   *major_version_ptr = ik-&gt;major_version();
2698 
2699   return JVMTI_ERROR_NONE;
2700 } /* end GetClassVersionNumbers */
2701 
2702 
2703 // k_mirror - may be primitive, this must be checked
2704 // constant_pool_count_ptr - pre-checked for NULL
2705 // constant_pool_byte_count_ptr - pre-checked for NULL
2706 // constant_pool_bytes_ptr - pre-checked for NULL
2707 jvmtiError
2708 JvmtiEnv::GetConstantPool(oop k_mirror, jint* constant_pool_count_ptr, jint* constant_pool_byte_count_ptr, unsigned char** constant_pool_bytes_ptr) {
2709   if (java_lang_Class::is_primitive(k_mirror)) {
2710     return JVMTI_ERROR_ABSENT_INFORMATION;
2711   }
2712 
2713   Klass* klass = java_lang_Class::as_Klass(k_mirror);
2714   Thread *thread = Thread::current();
2715   ResourceMark rm(thread);
2716 
2717   jint status = klass-&gt;jvmti_class_status();
2718   if (status &amp; (JVMTI_CLASS_STATUS_ERROR)) {
2719     return JVMTI_ERROR_INVALID_CLASS;
2720   }
2721   if (status &amp; (JVMTI_CLASS_STATUS_ARRAY)) {
2722     return JVMTI_ERROR_ABSENT_INFORMATION;
2723   }
2724 
2725   InstanceKlass* ik = InstanceKlass::cast(klass);
2726   JvmtiConstantPoolReconstituter reconstituter(ik);
2727   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2728     return reconstituter.get_error();
2729   }
2730 
2731   unsigned char *cpool_bytes;
2732   int cpool_size = reconstituter.cpool_size();
2733   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2734     return reconstituter.get_error();
2735   }
2736   jvmtiError res = allocate(cpool_size, &amp;cpool_bytes);
2737   if (res != JVMTI_ERROR_NONE) {
2738     return res;
2739   }
2740   reconstituter.copy_cpool_bytes(cpool_bytes);
2741   if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
2742     return reconstituter.get_error();
2743   }
2744 
2745   constantPoolHandle  constants(thread, ik-&gt;constants());
2746   *constant_pool_count_ptr      = constants-&gt;length();
2747   *constant_pool_byte_count_ptr = cpool_size;
2748   *constant_pool_bytes_ptr      = cpool_bytes;
2749 
2750   return JVMTI_ERROR_NONE;
2751 } /* end GetConstantPool */
2752 
2753 
2754 // k_mirror - may be primitive, this must be checked
2755 // is_interface_ptr - pre-checked for NULL
2756 jvmtiError
2757 JvmtiEnv::IsInterface(oop k_mirror, jboolean* is_interface_ptr) {
2758   {
2759     bool result = false;
2760     if (!java_lang_Class::is_primitive(k_mirror)) {
2761       Klass* k = java_lang_Class::as_Klass(k_mirror);
2762       if (k != NULL &amp;&amp; k-&gt;is_interface()) {
2763         result = true;
2764       }
2765     }
2766     *is_interface_ptr = result;
2767   }
2768 
2769   return JVMTI_ERROR_NONE;
2770 } /* end IsInterface */
2771 
2772 
2773 // k_mirror - may be primitive, this must be checked
2774 // is_array_class_ptr - pre-checked for NULL
2775 jvmtiError
2776 JvmtiEnv::IsArrayClass(oop k_mirror, jboolean* is_array_class_ptr) {
2777   {
2778     bool result = false;
2779     if (!java_lang_Class::is_primitive(k_mirror)) {
2780       Klass* k = java_lang_Class::as_Klass(k_mirror);
2781       if (k != NULL &amp;&amp; k-&gt;is_array_klass()) {
2782         result = true;
2783       }
2784     }
2785     *is_array_class_ptr = result;
2786   }
2787 
2788   return JVMTI_ERROR_NONE;
2789 } /* end IsArrayClass */
2790 
2791 
2792 // k_mirror - may be primitive, this must be checked
2793 // classloader_ptr - pre-checked for NULL
2794 jvmtiError
2795 JvmtiEnv::GetClassLoader(oop k_mirror, jobject* classloader_ptr) {
2796   {
2797     if (java_lang_Class::is_primitive(k_mirror)) {
2798       *classloader_ptr = (jclass) jni_reference(Handle());
2799       return JVMTI_ERROR_NONE;
2800     }
2801     JavaThread* current_thread = JavaThread::current();
2802     HandleMark hm(current_thread);
2803     Klass* k = java_lang_Class::as_Klass(k_mirror);
2804     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2805 
2806     oop result_oop = k-&gt;class_loader();
2807     if (result_oop == NULL) {
2808       *classloader_ptr = (jclass) jni_reference(Handle());
2809       return JVMTI_ERROR_NONE;
2810     }
2811     Handle result_handle = Handle(current_thread, result_oop);
2812     jclass result_jnihandle = (jclass) jni_reference(result_handle);
2813     *classloader_ptr = result_jnihandle;
2814   }
2815   return JVMTI_ERROR_NONE;
2816 } /* end GetClassLoader */
2817 
2818 
2819 // k_mirror - may be primitive, this must be checked
2820 // source_debug_extension_ptr - pre-checked for NULL
2821 jvmtiError
2822 JvmtiEnv::GetSourceDebugExtension(oop k_mirror, char** source_debug_extension_ptr) {
2823   {
2824     if (java_lang_Class::is_primitive(k_mirror)) {
2825       return JVMTI_ERROR_ABSENT_INFORMATION;
2826     }
2827     Klass* k = java_lang_Class::as_Klass(k_mirror);
2828     NULL_CHECK(k, JVMTI_ERROR_INVALID_CLASS);
2829     if (!k-&gt;is_instance_klass()) {
2830       return JVMTI_ERROR_ABSENT_INFORMATION;
2831     }
2832     const char* sde = InstanceKlass::cast(k)-&gt;source_debug_extension();
2833     NULL_CHECK(sde, JVMTI_ERROR_ABSENT_INFORMATION);
2834 
2835     {
2836       *source_debug_extension_ptr = (char *) jvmtiMalloc(strlen(sde)+1);
2837       strcpy(*source_debug_extension_ptr, sde);
2838     }
2839   }
2840 
2841   return JVMTI_ERROR_NONE;
2842 } /* end GetSourceDebugExtension */
2843 
2844   //
2845   // Object functions
2846   //
2847 
2848 // hash_code_ptr - pre-checked for NULL
2849 jvmtiError
2850 JvmtiEnv::GetObjectHashCode(jobject object, jint* hash_code_ptr) {
2851   oop mirror = JNIHandles::resolve_external_guard(object);
2852   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
2853   NULL_CHECK(hash_code_ptr, JVMTI_ERROR_NULL_POINTER);
2854 
2855   {
2856     jint result = (jint) mirror-&gt;identity_hash();
2857     *hash_code_ptr = result;
2858   }
2859   return JVMTI_ERROR_NONE;
2860 } /* end GetObjectHashCode */
2861 
2862 
2863 // info_ptr - pre-checked for NULL
2864 jvmtiError
2865 JvmtiEnv::GetObjectMonitorUsage(jobject object, jvmtiMonitorUsage* info_ptr) {
2866   // This needs to be performed at a safepoint to gather stable data
2867   // because monitor owner / waiters might not be suspended.
2868   VM_GetObjectMonitorUsage op(this, JavaThread::current(), object, info_ptr);
2869   VMThread::execute(&amp;op);
2870   return op.result();
2871 } /* end GetObjectMonitorUsage */
2872 
2873 
2874   //
2875   // Field functions
2876   //
2877 
2878 // name_ptr - NULL is a valid value, must be checked
2879 // signature_ptr - NULL is a valid value, must be checked
2880 // generic_ptr - NULL is a valid value, must be checked
2881 jvmtiError
2882 JvmtiEnv::GetFieldName(fieldDescriptor* fdesc_ptr, char** name_ptr, char** signature_ptr, char** generic_ptr) {
2883   JavaThread* current_thread  = JavaThread::current();
2884   ResourceMark rm(current_thread);
2885   if (name_ptr == NULL) {
2886     // just don&#39;t return the name
2887   } else {
2888     const char* fieldName = fdesc_ptr-&gt;name()-&gt;as_C_string();
2889     *name_ptr =  (char*) jvmtiMalloc(strlen(fieldName) + 1);
2890     if (*name_ptr == NULL)
2891       return JVMTI_ERROR_OUT_OF_MEMORY;
2892     strcpy(*name_ptr, fieldName);
2893   }
2894   if (signature_ptr== NULL) {
2895     // just don&#39;t return the signature
2896   } else {
2897     const char* fieldSignature = fdesc_ptr-&gt;signature()-&gt;as_C_string();
2898     *signature_ptr = (char*) jvmtiMalloc(strlen(fieldSignature) + 1);
2899     if (*signature_ptr == NULL)
2900       return JVMTI_ERROR_OUT_OF_MEMORY;
2901     strcpy(*signature_ptr, fieldSignature);
2902   }
2903   if (generic_ptr != NULL) {
2904     *generic_ptr = NULL;
2905     Symbol* soop = fdesc_ptr-&gt;generic_signature();
2906     if (soop != NULL) {
2907       const char* gen_sig = soop-&gt;as_C_string();
2908       if (gen_sig != NULL) {
2909         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
2910         if (err != JVMTI_ERROR_NONE) {
2911           return err;
2912         }
2913         strcpy(*generic_ptr, gen_sig);
2914       }
2915     }
2916   }
2917   return JVMTI_ERROR_NONE;
2918 } /* end GetFieldName */
2919 
2920 
2921 // declaring_class_ptr - pre-checked for NULL
2922 jvmtiError
2923 JvmtiEnv::GetFieldDeclaringClass(fieldDescriptor* fdesc_ptr, jclass* declaring_class_ptr) {
2924 
2925   *declaring_class_ptr = get_jni_class_non_null(fdesc_ptr-&gt;field_holder());
2926   return JVMTI_ERROR_NONE;
2927 } /* end GetFieldDeclaringClass */
2928 
2929 
2930 // modifiers_ptr - pre-checked for NULL
2931 jvmtiError
2932 JvmtiEnv::GetFieldModifiers(fieldDescriptor* fdesc_ptr, jint* modifiers_ptr) {
2933 
2934   AccessFlags resultFlags = fdesc_ptr-&gt;access_flags();
2935   jint result = resultFlags.as_int();
2936   *modifiers_ptr = result;
2937 
2938   return JVMTI_ERROR_NONE;
2939 } /* end GetFieldModifiers */
2940 
2941 
2942 // is_synthetic_ptr - pre-checked for NULL
2943 jvmtiError
2944 JvmtiEnv::IsFieldSynthetic(fieldDescriptor* fdesc_ptr, jboolean* is_synthetic_ptr) {
2945   *is_synthetic_ptr = fdesc_ptr-&gt;is_synthetic();
2946   return JVMTI_ERROR_NONE;
2947 } /* end IsFieldSynthetic */
2948 
2949 
2950   //
2951   // Method functions
2952   //
2953 
2954 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2955 // name_ptr - NULL is a valid value, must be checked
2956 // signature_ptr - NULL is a valid value, must be checked
2957 // generic_ptr - NULL is a valid value, must be checked
2958 jvmtiError
2959 JvmtiEnv::GetMethodName(Method* method_oop, char** name_ptr, char** signature_ptr, char** generic_ptr) {
2960   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
2961   JavaThread* current_thread  = JavaThread::current();
2962 
2963   ResourceMark rm(current_thread); // get the utf8 name and signature
2964   if (name_ptr == NULL) {
2965     // just don&#39;t return the name
2966   } else {
2967     const char* utf8_name = (const char *) method_oop-&gt;name()-&gt;as_utf8();
2968     *name_ptr = (char *) jvmtiMalloc(strlen(utf8_name)+1);
2969     strcpy(*name_ptr, utf8_name);
2970   }
2971   if (signature_ptr == NULL) {
2972     // just don&#39;t return the signature
2973   } else {
2974     const char* utf8_signature = (const char *) method_oop-&gt;signature()-&gt;as_utf8();
2975     *signature_ptr = (char *) jvmtiMalloc(strlen(utf8_signature) + 1);
2976     strcpy(*signature_ptr, utf8_signature);
2977   }
2978 
2979   if (generic_ptr != NULL) {
2980     *generic_ptr = NULL;
2981     Symbol* soop = method_oop-&gt;generic_signature();
2982     if (soop != NULL) {
2983       const char* gen_sig = soop-&gt;as_C_string();
2984       if (gen_sig != NULL) {
2985         jvmtiError err = allocate(strlen(gen_sig) + 1, (unsigned char **)generic_ptr);
2986         if (err != JVMTI_ERROR_NONE) {
2987           return err;
2988         }
2989         strcpy(*generic_ptr, gen_sig);
2990       }
2991     }
2992   }
2993   return JVMTI_ERROR_NONE;
2994 } /* end GetMethodName */
2995 
2996 
2997 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
2998 // declaring_class_ptr - pre-checked for NULL
2999 jvmtiError
3000 JvmtiEnv::GetMethodDeclaringClass(Method* method_oop, jclass* declaring_class_ptr) {
3001   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3002   (*declaring_class_ptr) = get_jni_class_non_null(method_oop-&gt;method_holder());
3003   return JVMTI_ERROR_NONE;
3004 } /* end GetMethodDeclaringClass */
3005 
3006 
3007 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3008 // modifiers_ptr - pre-checked for NULL
3009 jvmtiError
3010 JvmtiEnv::GetMethodModifiers(Method* method_oop, jint* modifiers_ptr) {
3011   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3012   (*modifiers_ptr) = method_oop-&gt;access_flags().as_int() &amp; JVM_RECOGNIZED_METHOD_MODIFIERS;
3013   return JVMTI_ERROR_NONE;
3014 } /* end GetMethodModifiers */
3015 
3016 
3017 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3018 // max_ptr - pre-checked for NULL
3019 jvmtiError
3020 JvmtiEnv::GetMaxLocals(Method* method_oop, jint* max_ptr) {
3021   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3022   // get max stack
3023   (*max_ptr) = method_oop-&gt;max_locals();
3024   return JVMTI_ERROR_NONE;
3025 } /* end GetMaxLocals */
3026 
3027 
3028 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3029 // size_ptr - pre-checked for NULL
3030 jvmtiError
3031 JvmtiEnv::GetArgumentsSize(Method* method_oop, jint* size_ptr) {
3032   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3033   // get size of arguments
3034 
3035   (*size_ptr) = method_oop-&gt;size_of_parameters();
3036   return JVMTI_ERROR_NONE;
3037 } /* end GetArgumentsSize */
3038 
3039 
3040 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3041 // entry_count_ptr - pre-checked for NULL
3042 // table_ptr - pre-checked for NULL
3043 jvmtiError
3044 JvmtiEnv::GetLineNumberTable(Method* method_oop, jint* entry_count_ptr, jvmtiLineNumberEntry** table_ptr) {
3045   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3046   if (!method_oop-&gt;has_linenumber_table()) {
3047     return (JVMTI_ERROR_ABSENT_INFORMATION);
3048   }
3049 
3050   // The line number table is compressed so we don&#39;t know how big it is until decompressed.
3051   // Decompression is really fast so we just do it twice.
3052 
3053   // Compute size of table
3054   jint num_entries = 0;
3055   CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3056   while (stream.read_pair()) {
3057     num_entries++;
3058   }
3059   jvmtiLineNumberEntry *jvmti_table =
3060             (jvmtiLineNumberEntry *)jvmtiMalloc(num_entries * (sizeof(jvmtiLineNumberEntry)));
3061 
3062   // Fill jvmti table
3063   if (num_entries &gt; 0) {
3064     int index = 0;
3065     CompressedLineNumberReadStream stream(method_oop-&gt;compressed_linenumber_table());
3066     while (stream.read_pair()) {
3067       jvmti_table[index].start_location = (jlocation) stream.bci();
3068       jvmti_table[index].line_number = (jint) stream.line();
3069       index++;
3070     }
3071     assert(index == num_entries, &quot;sanity check&quot;);
3072   }
3073 
3074   // Set up results
3075   (*entry_count_ptr) = num_entries;
3076   (*table_ptr) = jvmti_table;
3077 
3078   return JVMTI_ERROR_NONE;
3079 } /* end GetLineNumberTable */
3080 
3081 
3082 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3083 // start_location_ptr - pre-checked for NULL
3084 // end_location_ptr - pre-checked for NULL
3085 jvmtiError
3086 JvmtiEnv::GetMethodLocation(Method* method_oop, jlocation* start_location_ptr, jlocation* end_location_ptr) {
3087 
3088   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3089   // get start and end location
3090   (*end_location_ptr) = (jlocation) (method_oop-&gt;code_size() - 1);
3091   if (method_oop-&gt;code_size() == 0) {
3092     // there is no code so there is no start location
3093     (*start_location_ptr) = (jlocation)(-1);
3094   } else {
3095     (*start_location_ptr) = (jlocation)(0);
3096   }
3097 
3098   return JVMTI_ERROR_NONE;
3099 } /* end GetMethodLocation */
3100 
3101 
3102 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3103 // entry_count_ptr - pre-checked for NULL
3104 // table_ptr - pre-checked for NULL
3105 jvmtiError
3106 JvmtiEnv::GetLocalVariableTable(Method* method_oop, jint* entry_count_ptr, jvmtiLocalVariableEntry** table_ptr) {
3107 
3108   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3109   JavaThread* current_thread  = JavaThread::current();
3110 
3111   // does the klass have any local variable information?
3112   InstanceKlass* ik = method_oop-&gt;method_holder();
3113   if (!ik-&gt;access_flags().has_localvariable_table()) {
3114     return (JVMTI_ERROR_ABSENT_INFORMATION);
3115   }
3116 
3117   ConstantPool* constants = method_oop-&gt;constants();
3118   NULL_CHECK(constants, JVMTI_ERROR_ABSENT_INFORMATION);
3119 
3120   // in the vm localvariable table representation, 6 consecutive elements in the table
3121   // represent a 6-tuple of shorts
3122   // [start_pc, length, name_index, descriptor_index, signature_index, index]
3123   jint num_entries = method_oop-&gt;localvariable_table_length();
3124   jvmtiLocalVariableEntry *jvmti_table = (jvmtiLocalVariableEntry *)
3125                 jvmtiMalloc(num_entries * (sizeof(jvmtiLocalVariableEntry)));
3126 
3127   if (num_entries &gt; 0) {
3128     LocalVariableTableElement* table = method_oop-&gt;localvariable_table_start();
3129     for (int i = 0; i &lt; num_entries; i++) {
3130       // get the 5 tuple information from the vm table
3131       jlocation start_location = (jlocation) table[i].start_bci;
3132       jint length = (jint) table[i].length;
3133       int name_index = (int) table[i].name_cp_index;
3134       int signature_index = (int) table[i].descriptor_cp_index;
3135       int generic_signature_index = (int) table[i].signature_cp_index;
3136       jint slot = (jint) table[i].slot;
3137 
3138       // get utf8 name and signature
3139       char *name_buf = NULL;
3140       char *sig_buf = NULL;
3141       char *gen_sig_buf = NULL;
3142       {
3143         ResourceMark rm(current_thread);
3144 
3145         const char *utf8_name = (const char *) constants-&gt;symbol_at(name_index)-&gt;as_utf8();
3146         name_buf = (char *) jvmtiMalloc(strlen(utf8_name)+1);
3147         strcpy(name_buf, utf8_name);
3148 
3149         const char *utf8_signature = (const char *) constants-&gt;symbol_at(signature_index)-&gt;as_utf8();
3150         sig_buf = (char *) jvmtiMalloc(strlen(utf8_signature)+1);
3151         strcpy(sig_buf, utf8_signature);
3152 
3153         if (generic_signature_index &gt; 0) {
3154           const char *utf8_gen_sign = (const char *)
3155                                        constants-&gt;symbol_at(generic_signature_index)-&gt;as_utf8();
3156           gen_sig_buf = (char *) jvmtiMalloc(strlen(utf8_gen_sign)+1);
3157           strcpy(gen_sig_buf, utf8_gen_sign);
3158         }
3159       }
3160 
3161       // fill in the jvmti local variable table
3162       jvmti_table[i].start_location = start_location;
3163       jvmti_table[i].length = length;
3164       jvmti_table[i].name = name_buf;
3165       jvmti_table[i].signature = sig_buf;
3166       jvmti_table[i].generic_signature = gen_sig_buf;
3167       jvmti_table[i].slot = slot;
3168     }
3169   }
3170 
3171   // set results
3172   (*entry_count_ptr) = num_entries;
3173   (*table_ptr) = jvmti_table;
3174 
3175   return JVMTI_ERROR_NONE;
3176 } /* end GetLocalVariableTable */
3177 
3178 
3179 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3180 // bytecode_count_ptr - pre-checked for NULL
3181 // bytecodes_ptr - pre-checked for NULL
3182 jvmtiError
3183 JvmtiEnv::GetBytecodes(Method* method_oop, jint* bytecode_count_ptr, unsigned char** bytecodes_ptr) {
3184   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3185 
3186   HandleMark hm;
3187   methodHandle method(Thread::current(), method_oop);
3188   jint size = (jint)method-&gt;code_size();
3189   jvmtiError err = allocate(size, bytecodes_ptr);
3190   if (err != JVMTI_ERROR_NONE) {
3191     return err;
3192   }
3193 
3194   (*bytecode_count_ptr) = size;
3195   // get byte codes
3196   JvmtiClassFileReconstituter::copy_bytecodes(method, *bytecodes_ptr);
3197 
3198   return JVMTI_ERROR_NONE;
3199 } /* end GetBytecodes */
3200 
3201 
3202 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3203 // is_native_ptr - pre-checked for NULL
3204 jvmtiError
3205 JvmtiEnv::IsMethodNative(Method* method_oop, jboolean* is_native_ptr) {
3206   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3207   (*is_native_ptr) = method_oop-&gt;is_native();
3208   return JVMTI_ERROR_NONE;
3209 } /* end IsMethodNative */
3210 
3211 
3212 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3213 // is_synthetic_ptr - pre-checked for NULL
3214 jvmtiError
3215 JvmtiEnv::IsMethodSynthetic(Method* method_oop, jboolean* is_synthetic_ptr) {
3216   NULL_CHECK(method_oop, JVMTI_ERROR_INVALID_METHODID);
3217   (*is_synthetic_ptr) = method_oop-&gt;is_synthetic();
3218   return JVMTI_ERROR_NONE;
3219 } /* end IsMethodSynthetic */
3220 
3221 
3222 // method_oop - pre-checked for validity, but may be NULL meaning obsolete method
3223 // is_obsolete_ptr - pre-checked for NULL
3224 jvmtiError
3225 JvmtiEnv::IsMethodObsolete(Method* method_oop, jboolean* is_obsolete_ptr) {
3226   if (use_version_1_0_semantics() &amp;&amp;
3227       get_capabilities()-&gt;can_redefine_classes == 0) {
3228     // This JvmtiEnv requested version 1.0 semantics and this function
3229     // requires the can_redefine_classes capability in version 1.0 so
3230     // we need to return an error here.
3231     return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3232   }
3233 
3234   if (method_oop == NULL || method_oop-&gt;is_obsolete()) {
3235     *is_obsolete_ptr = true;
3236   } else {
3237     *is_obsolete_ptr = false;
3238   }
3239   return JVMTI_ERROR_NONE;
3240 } /* end IsMethodObsolete */
3241 
3242   //
3243   // Raw Monitor functions
3244   //
3245 
3246 // name - pre-checked for NULL
3247 // monitor_ptr - pre-checked for NULL
3248 jvmtiError
3249 JvmtiEnv::CreateRawMonitor(const char* name, jrawMonitorID* monitor_ptr) {
3250   JvmtiRawMonitor* rmonitor = new JvmtiRawMonitor(name);
3251   NULL_CHECK(rmonitor, JVMTI_ERROR_OUT_OF_MEMORY);
3252 
3253   *monitor_ptr = (jrawMonitorID)rmonitor;
3254 
3255   return JVMTI_ERROR_NONE;
3256 } /* end CreateRawMonitor */
3257 
3258 
3259 // rmonitor - pre-checked for validity
3260 jvmtiError
3261 JvmtiEnv::DestroyRawMonitor(JvmtiRawMonitor * rmonitor) {
3262   if (Threads::number_of_threads() == 0) {
3263     // Remove this monitor from pending raw monitors list
3264     // if it has entered in onload or start phase.
3265     JvmtiPendingMonitors::destroy(rmonitor);
3266   } else {
3267     Thread* thread  = Thread::current();
3268     if (rmonitor-&gt;owner() == thread) {
3269       // The caller owns this monitor which we are about to destroy.
3270       // We exit the underlying synchronization object so that the
3271       // &quot;delete monitor&quot; call below can work without an assertion
3272       // failure on systems that don&#39;t like destroying synchronization
3273       // objects that are locked.
3274       int r;
3275       int recursion = rmonitor-&gt;recursions();
3276       for (int i = 0; i &lt;= recursion; i++) {
3277         r = rmonitor-&gt;raw_exit(thread);
3278         assert(r == JvmtiRawMonitor::M_OK, &quot;raw_exit should have worked&quot;);
3279         if (r != JvmtiRawMonitor::M_OK) {  // robustness
3280           return JVMTI_ERROR_INTERNAL;
3281         }
3282       }
3283     }
3284     if (rmonitor-&gt;owner() != NULL) {
3285       // The caller is trying to destroy a monitor that is locked by
3286       // someone else. While this is not forbidden by the JVMTI
3287       // spec, it will cause an assertion failure on systems that don&#39;t
3288       // like destroying synchronization objects that are locked.
3289       // We indicate a problem with the error return (and leak the
3290       // monitor&#39;s memory).
3291       return JVMTI_ERROR_NOT_MONITOR_OWNER;
3292     }
3293   }
3294 
3295   delete rmonitor;
3296 
3297   return JVMTI_ERROR_NONE;
3298 } /* end DestroyRawMonitor */
3299 
3300 
3301 // rmonitor - pre-checked for validity
3302 jvmtiError
3303 JvmtiEnv::RawMonitorEnter(JvmtiRawMonitor * rmonitor) {
3304   if (Threads::number_of_threads() == 0) {
3305     // No JavaThreads exist so JvmtiRawMonitor enter cannot be
3306     // used, add this raw monitor to the pending list.
3307     // The pending monitors will be actually entered when
3308     // the VM is setup.
3309     // See transition_pending_raw_monitors in create_vm()
3310     // in thread.cpp.
3311     JvmtiPendingMonitors::enter(rmonitor);
3312   } else {
3313     Thread* thread = Thread::current();
3314     if (thread-&gt;is_Java_thread()) {
3315       JavaThread* current_thread = (JavaThread*)thread;
3316 
3317       /* Transition to thread_blocked without entering vm state          */
3318       /* This is really evil. Normally you can&#39;t undo _thread_blocked    */
3319       /* transitions like this because it would cause us to miss a       */
3320       /* safepoint but since the thread was already in _thread_in_native */
3321       /* the thread is not leaving a safepoint safe state and it will    */
3322       /* block when it tries to return from native. We can&#39;t safepoint   */
3323       /* block in here because we could deadlock the vmthread. Blech.    */
3324 
3325       JavaThreadState state = current_thread-&gt;thread_state();
3326       assert(state == _thread_in_native, &quot;Must be _thread_in_native&quot;);
3327       // frame should already be walkable since we are in native
3328       assert(!current_thread-&gt;has_last_Java_frame() ||
3329              current_thread-&gt;frame_anchor()-&gt;walkable(), &quot;Must be walkable&quot;);
3330       current_thread-&gt;set_thread_state(_thread_blocked);
3331 
3332       rmonitor-&gt;raw_enter(current_thread);
3333       // restore state, still at a safepoint safe state
3334       current_thread-&gt;set_thread_state(state);
3335     } else {
3336       rmonitor-&gt;raw_enter(thread);
3337     }
3338   }
3339   return JVMTI_ERROR_NONE;
3340 } /* end RawMonitorEnter */
3341 
3342 
3343 // rmonitor - pre-checked for validity
3344 jvmtiError
3345 JvmtiEnv::RawMonitorExit(JvmtiRawMonitor * rmonitor) {
3346   jvmtiError err = JVMTI_ERROR_NONE;
3347 
3348   if (Threads::number_of_threads() == 0) {
3349     // No JavaThreads exist so just remove this monitor from the pending list.
3350     // Bool value from exit is false if rmonitor is not in the list.
3351     if (!JvmtiPendingMonitors::exit(rmonitor)) {
3352       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3353     }
3354   } else {
3355     Thread* thread = Thread::current();
3356     int r = rmonitor-&gt;raw_exit(thread);
3357     if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3358       err = JVMTI_ERROR_NOT_MONITOR_OWNER;
3359     }
3360   }
3361   return err;
3362 } /* end RawMonitorExit */
3363 
3364 
3365 // rmonitor - pre-checked for validity
3366 jvmtiError
3367 JvmtiEnv::RawMonitorWait(JvmtiRawMonitor * rmonitor, jlong millis) {
3368   Thread* thread = Thread::current();
3369   int r = rmonitor-&gt;raw_wait(millis, thread);
3370 
3371   switch (r) {
3372   case JvmtiRawMonitor::M_INTERRUPTED:
3373     return JVMTI_ERROR_INTERRUPT;
3374   case JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE:
3375     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3376   default:
3377     return JVMTI_ERROR_NONE;
3378   }
3379 } /* end RawMonitorWait */
3380 
3381 
3382 // rmonitor - pre-checked for validity
3383 jvmtiError
3384 JvmtiEnv::RawMonitorNotify(JvmtiRawMonitor * rmonitor) {
3385   Thread* thread = Thread::current();
3386   int r = rmonitor-&gt;raw_notify(thread);
3387 
3388   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3389     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3390   }
3391   return JVMTI_ERROR_NONE;
3392 } /* end RawMonitorNotify */
3393 
3394 
3395 // rmonitor - pre-checked for validity
3396 jvmtiError
3397 JvmtiEnv::RawMonitorNotifyAll(JvmtiRawMonitor * rmonitor) {
3398   Thread* thread = Thread::current();
3399   int r = rmonitor-&gt;raw_notifyAll(thread);
3400 
3401   if (r == JvmtiRawMonitor::M_ILLEGAL_MONITOR_STATE) {
3402     return JVMTI_ERROR_NOT_MONITOR_OWNER;
3403   }
3404   return JVMTI_ERROR_NONE;
3405 } /* end RawMonitorNotifyAll */
3406 
3407 
3408   //
3409   // JNI Function Interception functions
3410   //
3411 
3412 
3413 // function_table - pre-checked for NULL
3414 jvmtiError
3415 JvmtiEnv::SetJNIFunctionTable(const jniNativeInterface* function_table) {
3416   // Copy jni function table at safepoint.
3417   VM_JNIFunctionTableCopier copier(function_table);
3418   VMThread::execute(&amp;copier);
3419 
3420   return JVMTI_ERROR_NONE;
3421 } /* end SetJNIFunctionTable */
3422 
3423 
3424 // function_table - pre-checked for NULL
3425 jvmtiError
3426 JvmtiEnv::GetJNIFunctionTable(jniNativeInterface** function_table) {
3427   *function_table=(jniNativeInterface*)jvmtiMalloc(sizeof(jniNativeInterface));
3428   if (*function_table == NULL)
3429     return JVMTI_ERROR_OUT_OF_MEMORY;
3430   memcpy(*function_table,(JavaThread::current())-&gt;get_jni_functions(),sizeof(jniNativeInterface));
3431   return JVMTI_ERROR_NONE;
3432 } /* end GetJNIFunctionTable */
3433 
3434 
3435   //
3436   // Event Management functions
3437   //
3438 
3439 jvmtiError
3440 JvmtiEnv::GenerateEvents(jvmtiEvent event_type) {
3441   // can only generate two event types
3442   if (event_type != JVMTI_EVENT_COMPILED_METHOD_LOAD &amp;&amp;
3443       event_type != JVMTI_EVENT_DYNAMIC_CODE_GENERATED) {
3444     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3445   }
3446 
3447   // for compiled_method_load events we must check that the environment
3448   // has the can_generate_compiled_method_load_events capability.
3449   if (event_type == JVMTI_EVENT_COMPILED_METHOD_LOAD) {
3450     if (get_capabilities()-&gt;can_generate_compiled_method_load_events == 0) {
3451       return JVMTI_ERROR_MUST_POSSESS_CAPABILITY;
3452     }
3453     return JvmtiCodeBlobEvents::generate_compiled_method_load_events(this);
3454   } else {
3455     return JvmtiCodeBlobEvents::generate_dynamic_code_events(this);
3456   }
3457 
3458 } /* end GenerateEvents */
3459 
3460 
3461   //
3462   // Extension Mechanism functions
3463   //
3464 
3465 // extension_count_ptr - pre-checked for NULL
3466 // extensions - pre-checked for NULL
3467 jvmtiError
3468 JvmtiEnv::GetExtensionFunctions(jint* extension_count_ptr, jvmtiExtensionFunctionInfo** extensions) {
3469   return JvmtiExtensions::get_functions(this, extension_count_ptr, extensions);
3470 } /* end GetExtensionFunctions */
3471 
3472 
3473 // extension_count_ptr - pre-checked for NULL
3474 // extensions - pre-checked for NULL
3475 jvmtiError
3476 JvmtiEnv::GetExtensionEvents(jint* extension_count_ptr, jvmtiExtensionEventInfo** extensions) {
3477   return JvmtiExtensions::get_events(this, extension_count_ptr, extensions);
3478 } /* end GetExtensionEvents */
3479 
3480 
3481 // callback - NULL is a valid value, must be checked
3482 jvmtiError
3483 JvmtiEnv::SetExtensionEventCallback(jint extension_event_index, jvmtiExtensionEvent callback) {
3484   return JvmtiExtensions::set_event_callback(this, extension_event_index, callback);
3485 } /* end SetExtensionEventCallback */
3486 
3487   //
3488   // Timers functions
3489   //
3490 
3491 // info_ptr - pre-checked for NULL
3492 jvmtiError
3493 JvmtiEnv::GetCurrentThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3494   os::current_thread_cpu_time_info(info_ptr);
3495   return JVMTI_ERROR_NONE;
3496 } /* end GetCurrentThreadCpuTimerInfo */
3497 
3498 
3499 // nanos_ptr - pre-checked for NULL
3500 jvmtiError
3501 JvmtiEnv::GetCurrentThreadCpuTime(jlong* nanos_ptr) {
3502   *nanos_ptr = os::current_thread_cpu_time();
3503   return JVMTI_ERROR_NONE;
3504 } /* end GetCurrentThreadCpuTime */
3505 
3506 
3507 // info_ptr - pre-checked for NULL
3508 jvmtiError
3509 JvmtiEnv::GetThreadCpuTimerInfo(jvmtiTimerInfo* info_ptr) {
3510   os::thread_cpu_time_info(info_ptr);
3511   return JVMTI_ERROR_NONE;
3512 } /* end GetThreadCpuTimerInfo */
3513 
3514 
3515 // Threads_lock NOT held, java_thread not protected by lock
3516 // java_thread - pre-checked
3517 // nanos_ptr - pre-checked for NULL
3518 jvmtiError
3519 JvmtiEnv::GetThreadCpuTime(JavaThread* java_thread, jlong* nanos_ptr) {
3520   *nanos_ptr = os::thread_cpu_time(java_thread);
3521   return JVMTI_ERROR_NONE;
3522 } /* end GetThreadCpuTime */
3523 
3524 
3525 // info_ptr - pre-checked for NULL
3526 jvmtiError
3527 JvmtiEnv::GetTimerInfo(jvmtiTimerInfo* info_ptr) {
3528   os::javaTimeNanos_info(info_ptr);
3529   return JVMTI_ERROR_NONE;
3530 } /* end GetTimerInfo */
3531 
3532 
3533 // nanos_ptr - pre-checked for NULL
3534 jvmtiError
3535 JvmtiEnv::GetTime(jlong* nanos_ptr) {
3536   *nanos_ptr = os::javaTimeNanos();
3537   return JVMTI_ERROR_NONE;
3538 } /* end GetTime */
3539 
3540 
3541 // processor_count_ptr - pre-checked for NULL
3542 jvmtiError
3543 JvmtiEnv::GetAvailableProcessors(jint* processor_count_ptr) {
3544   *processor_count_ptr = os::active_processor_count();
3545   return JVMTI_ERROR_NONE;
3546 } /* end GetAvailableProcessors */
3547 
3548 jvmtiError
3549 JvmtiEnv::SetHeapSamplingInterval(jint sampling_interval) {
3550   if (sampling_interval &lt; 0) {
3551     return JVMTI_ERROR_ILLEGAL_ARGUMENT;
3552   }
3553   ThreadHeapSampler::set_sampling_interval(sampling_interval);
3554   return JVMTI_ERROR_NONE;
3555 } /* end SetHeapSamplingInterval */
3556 
3557   //
3558   // System Properties functions
3559   //
3560 
3561 // count_ptr - pre-checked for NULL
3562 // property_ptr - pre-checked for NULL
3563 jvmtiError
3564 JvmtiEnv::GetSystemProperties(jint* count_ptr, char*** property_ptr) {
3565   jvmtiError err = JVMTI_ERROR_NONE;
3566 
3567   // Get the number of readable properties.
3568   *count_ptr = Arguments::PropertyList_readable_count(Arguments::system_properties());
3569 
3570   // Allocate memory to hold the exact number of readable properties.
3571   err = allocate(*count_ptr * sizeof(char *), (unsigned char **)property_ptr);
3572   if (err != JVMTI_ERROR_NONE) {
3573     return err;
3574   }
3575   int readable_count = 0;
3576   // Loop through the system properties until all the readable properties are found.
3577   for (SystemProperty* p = Arguments::system_properties(); p != NULL &amp;&amp; readable_count &lt; *count_ptr; p = p-&gt;next()) {
3578     if (p-&gt;is_readable()) {
3579       const char *key = p-&gt;key();
3580       char **tmp_value = *property_ptr+readable_count;
3581       readable_count++;
3582       err = allocate((strlen(key)+1) * sizeof(char), (unsigned char**)tmp_value);
3583       if (err == JVMTI_ERROR_NONE) {
3584         strcpy(*tmp_value, key);
3585       } else {
3586         // clean up previously allocated memory.
3587         for (int j = 0; j &lt; readable_count; j++) {
3588           Deallocate((unsigned char*)*property_ptr+j);
3589         }
3590         Deallocate((unsigned char*)property_ptr);
3591         break;
3592       }
3593     }
3594   }
3595   assert(err != JVMTI_ERROR_NONE || readable_count == *count_ptr, &quot;Bad readable property count&quot;);
3596   return err;
3597 } /* end GetSystemProperties */
3598 
3599 
3600 // property - pre-checked for NULL
3601 // value_ptr - pre-checked for NULL
3602 jvmtiError
3603 JvmtiEnv::GetSystemProperty(const char* property, char** value_ptr) {
3604   jvmtiError err = JVMTI_ERROR_NONE;
3605   const char *value;
3606 
3607   // Return JVMTI_ERROR_NOT_AVAILABLE if property is not readable or doesn&#39;t exist.
3608   value = Arguments::PropertyList_get_readable_value(Arguments::system_properties(), property);
3609   if (value == NULL) {
3610     err =  JVMTI_ERROR_NOT_AVAILABLE;
3611   } else {
3612     err = allocate((strlen(value)+1) * sizeof(char), (unsigned char **)value_ptr);
3613     if (err == JVMTI_ERROR_NONE) {
3614       strcpy(*value_ptr, value);
3615     }
3616   }
3617   return err;
3618 } /* end GetSystemProperty */
3619 
3620 
3621 // property - pre-checked for NULL
3622 // value - NULL is a valid value, must be checked
3623 jvmtiError
3624 JvmtiEnv::SetSystemProperty(const char* property, const char* value_ptr) {
3625   jvmtiError err =JVMTI_ERROR_NOT_AVAILABLE;
3626 
3627   for (SystemProperty* p = Arguments::system_properties(); p != NULL; p = p-&gt;next()) {
3628     if (strcmp(property, p-&gt;key()) == 0) {
3629       if (p-&gt;set_writeable_value(value_ptr)) {
3630         err =  JVMTI_ERROR_NONE;
3631       }
3632     }
3633   }
3634   return err;
3635 } /* end SetSystemProperty */
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>