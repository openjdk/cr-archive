<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/opto/doCall.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciCallSite.hpp&quot;
  27 #include &quot;ci/ciMethodHandle.hpp&quot;
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;compiler/compileBroker.hpp&quot;
  30 #include &quot;compiler/compileLog.hpp&quot;
  31 #include &quot;interpreter/linkResolver.hpp&quot;
  32 #include &quot;opto/addnode.hpp&quot;
  33 #include &quot;opto/callGenerator.hpp&quot;
  34 #include &quot;opto/castnode.hpp&quot;
  35 #include &quot;opto/cfgnode.hpp&quot;
  36 #include &quot;opto/inlinetypenode.hpp&quot;
  37 #include &quot;opto/mulnode.hpp&quot;
  38 #include &quot;opto/parse.hpp&quot;
  39 #include &quot;opto/rootnode.hpp&quot;
  40 #include &quot;opto/runtime.hpp&quot;
  41 #include &quot;opto/subnode.hpp&quot;
  42 #include &quot;prims/nativeLookup.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
  44 
  45 void trace_type_profile(Compile* C, ciMethod *method, int depth, int bci, ciMethod *prof_method, ciKlass *prof_klass, int site_count, int receiver_count) {
  46   if (TraceTypeProfile || C-&gt;print_inlining()) {
  47     outputStream* out = tty;
  48     if (!C-&gt;print_inlining()) {
  49       if (!PrintOpto &amp;&amp; !PrintCompilation) {
  50         method-&gt;print_short_name();
  51         tty-&gt;cr();
  52       }
  53       CompileTask::print_inlining_tty(prof_method, depth, bci);
  54     } else {
  55       out = C-&gt;print_inlining_stream();
  56     }
  57     CompileTask::print_inline_indent(depth, out);
  58     out-&gt;print(&quot; \\-&gt; TypeProfile (%d/%d counts) = &quot;, receiver_count, site_count);
  59     stringStream ss;
  60     prof_klass-&gt;name()-&gt;print_symbol_on(&amp;ss);
  61     out-&gt;print(&quot;%s&quot;, ss.as_string());
  62     out-&gt;cr();
  63   }
  64 }
  65 
  66 CallGenerator* Compile::call_generator(ciMethod* callee, int vtable_index, bool call_does_dispatch,
  67                                        JVMState* jvms, bool allow_inline,
  68                                        float prof_factor, ciKlass* speculative_receiver_type,
  69                                        bool allow_intrinsics) {
  70   ciMethod*       caller   = jvms-&gt;method();
  71   int             bci      = jvms-&gt;bci();
  72   Bytecodes::Code bytecode = caller-&gt;java_code_at_bci(bci);
  73   guarantee(callee != NULL, &quot;failed method resolution&quot;);
  74 
  75   // Dtrace currently doesn&#39;t work unless all calls are vanilla
  76   if (env()-&gt;dtrace_method_probes()) {
  77     allow_inline = false;
  78   }
  79 
  80   // Note: When we get profiling during stage-1 compiles, we want to pull
  81   // from more specific profile data which pertains to this inlining.
  82   // Right now, ignore the information in jvms-&gt;caller(), and do method[bci].
  83   ciCallProfile profile = caller-&gt;call_profile_at_bci(bci);
  84 
  85   // See how many times this site has been invoked.
  86   int site_count = profile.count();
  87   int receiver_count = -1;
  88   if (call_does_dispatch &amp;&amp; UseTypeProfile &amp;&amp; profile.has_receiver(0)) {
  89     // Receivers in the profile structure are ordered by call counts
  90     // so that the most called (major) receiver is profile.receiver(0).
  91     receiver_count = profile.receiver_count(0);
  92   }
  93 
  94   CompileLog* log = this-&gt;log();
  95   if (log != NULL) {
  96     int rid = (receiver_count &gt;= 0)? log-&gt;identify(profile.receiver(0)): -1;
  97     int r2id = (rid != -1 &amp;&amp; profile.has_receiver(1))? log-&gt;identify(profile.receiver(1)):-1;
  98     log-&gt;begin_elem(&quot;call method=&#39;%d&#39; count=&#39;%d&#39; prof_factor=&#39;%f&#39;&quot;,
  99                     log-&gt;identify(callee), site_count, prof_factor);
 100     if (call_does_dispatch)  log-&gt;print(&quot; virtual=&#39;1&#39;&quot;);
 101     if (allow_inline)     log-&gt;print(&quot; inline=&#39;1&#39;&quot;);
 102     if (receiver_count &gt;= 0) {
 103       log-&gt;print(&quot; receiver=&#39;%d&#39; receiver_count=&#39;%d&#39;&quot;, rid, receiver_count);
 104       if (profile.has_receiver(1)) {
 105         log-&gt;print(&quot; receiver2=&#39;%d&#39; receiver2_count=&#39;%d&#39;&quot;, r2id, profile.receiver_count(1));
 106       }
 107     }
 108     if (callee-&gt;is_method_handle_intrinsic()) {
 109       log-&gt;print(&quot; method_handle_intrinsic=&#39;1&#39;&quot;);
 110     }
 111     log-&gt;end_elem();
 112   }
 113 
 114   // Special case the handling of certain common, profitable library
 115   // methods.  If these methods are replaced with specialized code,
 116   // then we return it as the inlined version of the call.
 117   // We do this before the strict f.p. check below because the
 118   // intrinsics handle strict f.p. correctly.
 119   CallGenerator* cg_intrinsic = NULL;
 120   if (allow_inline &amp;&amp; allow_intrinsics) {
 121     CallGenerator* cg = find_intrinsic(callee, call_does_dispatch);
 122     if (cg != NULL) {
 123       if (cg-&gt;is_predicated()) {
 124         // Code without intrinsic but, hopefully, inlined.
 125         CallGenerator* inline_cg = this-&gt;call_generator(callee,
 126               vtable_index, call_does_dispatch, jvms, allow_inline, prof_factor, speculative_receiver_type, false);
 127         if (inline_cg != NULL) {
 128           cg = CallGenerator::for_predicated_intrinsic(cg, inline_cg);
 129         }
 130       }
 131 
 132       // If intrinsic does the virtual dispatch, we try to use the type profile
 133       // first, and hopefully inline it as the regular virtual call below.
 134       // We will retry the intrinsic if nothing had claimed it afterwards.
 135       if (cg-&gt;does_virtual_dispatch()) {
 136         cg_intrinsic = cg;
 137         cg = NULL;
 138       } else {
 139         return cg;
 140       }
 141     }
 142   }
 143 
 144   // Do method handle calls.
 145   // NOTE: This must happen before normal inlining logic below since
 146   // MethodHandle.invoke* are native methods which obviously don&#39;t
 147   // have bytecodes and so normal inlining fails.
 148   if (callee-&gt;is_method_handle_intrinsic()) {
 149     CallGenerator* cg = CallGenerator::for_method_handle_call(jvms, caller, callee);
 150     return cg;
 151   }
 152 
 153   // If explicit rounding is required, do not inline strict into non-strict code (or the reverse).
 154   if (Matcher::strict_fp_requires_explicit_rounding &amp;&amp;
 155       caller-&gt;is_strict() != callee-&gt;is_strict()) {
 156     allow_inline = false;
 157   }
 158 
 159   // Attempt to inline...
 160   if (allow_inline) {
 161     // The profile data is only partly attributable to this caller,
 162     // scale back the call site information.
 163     float past_uses = jvms-&gt;method()-&gt;scale_count(site_count, prof_factor);
 164     // This is the number of times we expect the call code to be used.
 165     float expected_uses = past_uses;
 166 
 167     // Try inlining a bytecoded method:
 168     if (!call_does_dispatch) {
 169       InlineTree* ilt = InlineTree::find_subtree_from_root(this-&gt;ilt(), jvms-&gt;caller(), jvms-&gt;method());
 170       WarmCallInfo scratch_ci;
 171       bool should_delay = false;
 172       WarmCallInfo* ci = ilt-&gt;ok_to_inline(callee, jvms, profile, &amp;scratch_ci, should_delay);
 173       assert(ci != &amp;scratch_ci, &quot;do not let this pointer escape&quot;);
 174       bool allow_inline   = (ci != NULL &amp;&amp; !ci-&gt;is_cold());
 175       bool require_inline = (allow_inline &amp;&amp; ci-&gt;is_hot());
 176 
 177       if (allow_inline) {
 178         CallGenerator* cg = CallGenerator::for_inline(callee, expected_uses);
 179 
 180         if (require_inline &amp;&amp; cg != NULL) {
 181           // Delay the inlining of this method to give us the
 182           // opportunity to perform some high level optimizations
 183           // first.
 184           if (should_delay_string_inlining(callee, jvms)) {
 185             return CallGenerator::for_string_late_inline(callee, cg);
 186           } else if (should_delay_boxing_inlining(callee, jvms)) {
 187             return CallGenerator::for_boxing_late_inline(callee, cg);
 188           } else if (should_delay || AlwaysIncrementalInline) {
 189             return CallGenerator::for_late_inline(callee, cg);
 190           }
 191         }
 192         if (cg == NULL || should_delay) {
 193           // Fall through.
 194         } else if (require_inline || !InlineWarmCalls) {
 195           return cg;
 196         } else {
 197           CallGenerator* cold_cg = call_generator(callee, vtable_index, call_does_dispatch, jvms, false, prof_factor);
 198           return CallGenerator::for_warm_call(ci, cold_cg, cg);
 199         }
 200       }
 201     }
 202 
 203     // Try using the type profile.
 204     if (call_does_dispatch &amp;&amp; site_count &gt; 0 &amp;&amp; UseTypeProfile) {
 205       // The major receiver&#39;s count &gt;= TypeProfileMajorReceiverPercent of site_count.
 206       bool have_major_receiver = profile.has_receiver(0) &amp;&amp; (100.*profile.receiver_prob(0) &gt;= (float)TypeProfileMajorReceiverPercent);
 207       ciMethod* receiver_method = NULL;
 208 
 209       int morphism = profile.morphism();
 210       if (speculative_receiver_type != NULL) {
 211         if (!too_many_traps_or_recompiles(caller, bci, Deoptimization::Reason_speculate_class_check)) {
 212           // We have a speculative type, we should be able to resolve
 213           // the call. We do that before looking at the profiling at
 214           // this invoke because it may lead to bimorphic inlining which
 215           // a speculative type should help us avoid.
 216           receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 217                                                    speculative_receiver_type);
 218           if (receiver_method == NULL) {
 219             speculative_receiver_type = NULL;
 220           } else {
 221             morphism = 1;
 222           }
 223         } else {
 224           // speculation failed before. Use profiling at the call
 225           // (could allow bimorphic inlining for instance).
 226           speculative_receiver_type = NULL;
 227         }
 228       }
 229       if (receiver_method == NULL &amp;&amp;
 230           (have_major_receiver || morphism == 1 ||
 231            (morphism == 2 &amp;&amp; UseBimorphicInlining))) {
 232         // receiver_method = profile.method();
 233         // Profiles do not suggest methods now.  Look it up in the major receiver.
 234         receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 235                                                       profile.receiver(0));
 236       }
 237       if (receiver_method != NULL) {
 238         // The single majority receiver sufficiently outweighs the minority.
 239         CallGenerator* hit_cg = this-&gt;call_generator(receiver_method,
 240               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 241         if (hit_cg != NULL) {
 242           // Look up second receiver.
 243           CallGenerator* next_hit_cg = NULL;
 244           ciMethod* next_receiver_method = NULL;
 245           if (morphism == 2 &amp;&amp; UseBimorphicInlining) {
 246             next_receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 247                                                                profile.receiver(1));
 248             if (next_receiver_method != NULL) {
 249               next_hit_cg = this-&gt;call_generator(next_receiver_method,
 250                                   vtable_index, !call_does_dispatch, jvms,
 251                                   allow_inline, prof_factor);
 252               if (next_hit_cg != NULL &amp;&amp; !next_hit_cg-&gt;is_inline() &amp;&amp;
 253                   have_major_receiver &amp;&amp; UseOnlyInlinedBimorphic) {
 254                   // Skip if we can&#39;t inline second receiver&#39;s method
 255                   next_hit_cg = NULL;
 256               }
 257             }
 258           }
 259           CallGenerator* miss_cg;
 260           Deoptimization::DeoptReason reason = (morphism == 2
 261                                                ? Deoptimization::Reason_bimorphic
 262                                                : Deoptimization::reason_class_check(speculative_receiver_type != NULL));
 263           if ((morphism == 1 || (morphism == 2 &amp;&amp; next_hit_cg != NULL)) &amp;&amp;
 264               !too_many_traps_or_recompiles(caller, bci, reason)
 265              ) {
 266             // Generate uncommon trap for class check failure path
 267             // in case of monomorphic or bimorphic virtual call site.
 268             miss_cg = CallGenerator::for_uncommon_trap(callee, reason,
 269                         Deoptimization::Action_maybe_recompile);
 270           } else {
 271             // Generate virtual call for class check failure path
 272             // in case of polymorphic virtual call site.
 273             miss_cg = CallGenerator::for_virtual_call(callee, vtable_index);
 274           }
 275           if (miss_cg != NULL) {
 276             if (next_hit_cg != NULL) {
 277               assert(speculative_receiver_type == NULL, &quot;shouldn&#39;t end up here if we used speculation&quot;);
 278               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), next_receiver_method, profile.receiver(1), site_count, profile.receiver_count(1));
 279               // We don&#39;t need to record dependency on a receiver here and below.
 280               // Whenever we inline, the dependency is added by Parse::Parse().
 281               miss_cg = CallGenerator::for_predicted_call(profile.receiver(1), miss_cg, next_hit_cg, PROB_MAX);
 282             }
 283             if (miss_cg != NULL) {
 284               ciKlass* k = speculative_receiver_type != NULL ? speculative_receiver_type : profile.receiver(0);
 285               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), receiver_method, k, site_count, receiver_count);
 286               float hit_prob = speculative_receiver_type != NULL ? 1.0 : profile.receiver_prob(0);
 287               CallGenerator* cg = CallGenerator::for_predicted_call(k, miss_cg, hit_cg, hit_prob);
 288               if (cg != NULL)  return cg;
 289             }
 290           }
 291         }
 292       }
 293     }
 294 
 295     // If there is only one implementor of this interface then we
 296     // may be able to bind this invoke directly to the implementing
 297     // klass but we need both a dependence on the single interface
 298     // and on the method we bind to. Additionally since all we know
 299     // about the receiver type is that it&#39;s supposed to implement the
 300     // interface we have to insert a check that it&#39;s the class we
 301     // expect.  Interface types are not checked by the verifier so
 302     // they are roughly equivalent to Object.
 303     // The number of implementors for declared_interface is less or
 304     // equal to the number of implementors for target-&gt;holder() so
 305     // if number of implementors of target-&gt;holder() == 1 then
 306     // number of implementors for decl_interface is 0 or 1. If
 307     // it&#39;s 0 then no class implements decl_interface and there&#39;s
 308     // no point in inlining.
 309     if (call_does_dispatch &amp;&amp; bytecode == Bytecodes::_invokeinterface) {
 310       ciInstanceKlass* declared_interface =
 311           caller-&gt;get_declared_method_holder_at_bci(bci)-&gt;as_instance_klass();
 312       ciInstanceKlass* singleton = declared_interface-&gt;unique_implementor();
 313 
 314       if (singleton != NULL &amp;&amp;
 315           (!callee-&gt;is_default_method() || callee-&gt;is_overpass()) /* CHA doesn&#39;t support default methods yet */) {
 316         assert(singleton != declared_interface, &quot;not a unique implementor&quot;);
 317 
 318         ciMethod* cha_monomorphic_target =
 319             callee-&gt;find_monomorphic_target(caller-&gt;holder(), declared_interface, singleton);
 320 
 321         if (cha_monomorphic_target != NULL &amp;&amp;
 322             cha_monomorphic_target-&gt;holder() != env()-&gt;Object_klass()) { // subtype check against Object is useless
 323           ciKlass* holder = cha_monomorphic_target-&gt;holder();
 324 
 325           // Try to inline the method found by CHA. Inlined method is guarded by the type check.
 326           CallGenerator* hit_cg = call_generator(cha_monomorphic_target,
 327               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 328 
 329           // Deoptimize on type check fail. The interpreter will throw ICCE for us.
 330           CallGenerator* miss_cg = CallGenerator::for_uncommon_trap(callee,
 331               Deoptimization::Reason_class_check, Deoptimization::Action_none);
 332 
 333           CallGenerator* cg = CallGenerator::for_guarded_call(holder, miss_cg, hit_cg);
 334           if (hit_cg != NULL &amp;&amp; cg != NULL) {
 335             dependencies()-&gt;assert_unique_concrete_method(declared_interface, cha_monomorphic_target);
 336             return cg;
 337           }
 338         }
 339       }
 340     }
 341   }
 342 
 343   // Nothing claimed the intrinsic, we go with straight-forward inlining
 344   // for already discovered intrinsic.
 345   if (allow_inline &amp;&amp; allow_intrinsics &amp;&amp; cg_intrinsic != NULL) {
 346     assert(cg_intrinsic-&gt;does_virtual_dispatch(), &quot;sanity&quot;);
 347     return cg_intrinsic;
 348   }
 349 
 350   // There was no special inlining tactic, or it bailed out.
 351   // Use a more generic tactic, like a simple call.
 352   if (call_does_dispatch) {
 353     const char* msg = &quot;virtual call&quot;;
 354     if (PrintInlining) print_inlining(callee, jvms-&gt;depth() - 1, jvms-&gt;bci(), msg);
 355     C-&gt;log_inline_failure(msg);
 356     return CallGenerator::for_virtual_call(callee, vtable_index);
 357   } else {
 358     // Class Hierarchy Analysis or Type Profile reveals a unique target,
 359     // or it is a static or special call.
 360     return CallGenerator::for_direct_call(callee, should_delay_inlining(callee, jvms));
 361   }
 362 }
 363 
 364 // Return true for methods that shouldn&#39;t be inlined early so that
 365 // they are easier to analyze and optimize as intrinsics.
 366 bool Compile::should_delay_string_inlining(ciMethod* call_method, JVMState* jvms) {
 367   if (has_stringbuilder()) {
 368 
 369     if ((call_method-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 370          call_method-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass()) &amp;&amp;
 371         (jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 372          jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass())) {
 373       // Delay SB calls only when called from non-SB code
 374       return false;
 375     }
 376 
 377     switch (call_method-&gt;intrinsic_id()) {
 378       case vmIntrinsics::_StringBuilder_void:
 379       case vmIntrinsics::_StringBuilder_int:
 380       case vmIntrinsics::_StringBuilder_String:
 381       case vmIntrinsics::_StringBuilder_append_char:
 382       case vmIntrinsics::_StringBuilder_append_int:
 383       case vmIntrinsics::_StringBuilder_append_String:
 384       case vmIntrinsics::_StringBuilder_toString:
 385       case vmIntrinsics::_StringBuffer_void:
 386       case vmIntrinsics::_StringBuffer_int:
 387       case vmIntrinsics::_StringBuffer_String:
 388       case vmIntrinsics::_StringBuffer_append_char:
 389       case vmIntrinsics::_StringBuffer_append_int:
 390       case vmIntrinsics::_StringBuffer_append_String:
 391       case vmIntrinsics::_StringBuffer_toString:
 392       case vmIntrinsics::_Integer_toString:
 393         return true;
 394 
 395       case vmIntrinsics::_String_String:
 396         {
 397           Node* receiver = jvms-&gt;map()-&gt;in(jvms-&gt;argoff() + 1);
 398           if (receiver-&gt;is_Proj() &amp;&amp; receiver-&gt;in(0)-&gt;is_CallStaticJava()) {
 399             CallStaticJavaNode* csj = receiver-&gt;in(0)-&gt;as_CallStaticJava();
 400             ciMethod* m = csj-&gt;method();
 401             if (m != NULL &amp;&amp;
 402                 (m-&gt;intrinsic_id() == vmIntrinsics::_StringBuffer_toString ||
 403                  m-&gt;intrinsic_id() == vmIntrinsics::_StringBuilder_toString))
 404               // Delay String.&lt;init&gt;(new SB())
 405               return true;
 406           }
 407           return false;
 408         }
 409 
 410       default:
 411         return false;
 412     }
 413   }
 414   return false;
 415 }
 416 
 417 bool Compile::should_delay_boxing_inlining(ciMethod* call_method, JVMState* jvms) {
 418   if (eliminate_boxing() &amp;&amp; call_method-&gt;is_boxing_method()) {
 419     set_has_boxed_value(true);
 420     return aggressive_unboxing();
 421   }
 422   return false;
 423 }
 424 
 425 // uncommon-trap call-sites where callee is unloaded, uninitialized or will not link
 426 bool Parse::can_not_compile_call_site(ciMethod *dest_method, ciInstanceKlass* klass) {
 427   // Additional inputs to consider...
 428   // bc      = bc()
 429   // caller  = method()
 430   // iter().get_method_holder_index()
 431   assert( dest_method-&gt;is_loaded(), &quot;ciTypeFlow should not let us get here&quot; );
 432   // Interface classes can be loaded &amp; linked and never get around to
 433   // being initialized.  Uncommon-trap for not-initialized static or
 434   // v-calls.  Let interface calls happen.
 435   ciInstanceKlass* holder_klass = dest_method-&gt;holder();
 436   if (!holder_klass-&gt;is_being_initialized() &amp;&amp;
 437       !holder_klass-&gt;is_initialized() &amp;&amp;
 438       !holder_klass-&gt;is_interface()) {
 439     uncommon_trap(Deoptimization::Reason_uninitialized,
 440                   Deoptimization::Action_reinterpret,
 441                   holder_klass);
 442     return true;
 443   }
 444 
 445   assert(dest_method-&gt;is_loaded(), &quot;dest_method: typeflow responsibility&quot;);
 446   return false;
 447 }
 448 
 449 #ifdef ASSERT
 450 static bool check_call_consistency(JVMState* jvms, CallGenerator* cg) {
 451   ciMethod* symbolic_info = jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci());
 452   ciMethod* resolved_method = cg-&gt;method();
 453   if (!ciMethod::is_consistent_info(symbolic_info, resolved_method)) {
 454     tty-&gt;print_cr(&quot;JVMS:&quot;);
 455     jvms-&gt;dump();
 456     tty-&gt;print_cr(&quot;Bytecode info:&quot;);
 457     jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci())-&gt;print(); tty-&gt;cr();
 458     tty-&gt;print_cr(&quot;Resolved method:&quot;);
 459     cg-&gt;method()-&gt;print(); tty-&gt;cr();
 460     return false;
 461   }
 462   return true;
 463 }
 464 #endif // ASSERT
 465 
 466 //------------------------------do_call----------------------------------------
 467 // Handle your basic call.  Inline if we can &amp; want to, else just setup call.
 468 void Parse::do_call() {
 469   // It&#39;s likely we are going to add debug info soon.
 470   // Also, if we inline a guy who eventually needs debug info for this JVMS,
 471   // our contribution to it is cleaned up right here.
 472   kill_dead_locals();
 473 
 474   C-&gt;print_inlining_assert_ready();
 475 
 476   // Set frequently used booleans
 477   const bool is_virtual = bc() == Bytecodes::_invokevirtual;
 478   const bool is_virtual_or_interface = is_virtual || bc() == Bytecodes::_invokeinterface;
 479   const bool has_receiver = Bytecodes::has_receiver(bc());
 480 
 481   // Find target being called
 482   bool             will_link;
 483   ciSignature*     declared_signature = NULL;
 484   ciMethod*        orig_callee  = iter().get_method(will_link, &amp;declared_signature);  // callee in the bytecode
 485   ciInstanceKlass* holder_klass = orig_callee-&gt;holder();
 486   ciKlass*         holder       = iter().get_declared_method_holder();
 487   ciInstanceKlass* klass = ciEnv::get_instance_klass_for_declared_method_holder(holder);
 488   assert(declared_signature != NULL, &quot;cannot be null&quot;);
 489 
 490   // Bump max node limit for JSR292 users
 491   if (bc() == Bytecodes::_invokedynamic || orig_callee-&gt;is_method_handle_intrinsic()) {
 492     C-&gt;set_max_node_limit(3*MaxNodeLimit);
 493   }
 494 
 495   // uncommon-trap when callee is unloaded, uninitialized or will not link
 496   // bailout when too many arguments for register representation
 497   if (!will_link || can_not_compile_call_site(orig_callee, klass)) {
 498     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 499       method()-&gt;print_name(); tty-&gt;print_cr(&quot; can not compile call at bci %d to:&quot;, bci());
 500       orig_callee-&gt;print_name(); tty-&gt;cr();
 501     }
 502     return;
 503   }
 504   assert(holder_klass-&gt;is_loaded(), &quot;&quot;);
 505   //assert((bc_callee-&gt;is_static() || is_invokedynamic) == !has_receiver , &quot;must match bc&quot;);  // XXX invokehandle (cur_bc_raw)
 506   // Note: this takes into account invokeinterface of methods declared in java/lang/Object,
 507   // which should be invokevirtuals but according to the VM spec may be invokeinterfaces
 508   assert(holder_klass-&gt;is_interface() || holder_klass-&gt;super() == NULL || (bc() != Bytecodes::_invokeinterface), &quot;must match bc&quot;);
 509   // Note:  In the absence of miranda methods, an abstract class K can perform
 510   // an invokevirtual directly on an interface method I.m if K implements I.
 511 
 512   // orig_callee is the resolved callee which&#39;s signature includes the
 513   // appendix argument.
 514   const int nargs = orig_callee-&gt;arg_size();
 515   const bool is_signature_polymorphic = MethodHandles::is_signature_polymorphic(orig_callee-&gt;intrinsic_id());
 516 
 517   // Push appendix argument (MethodType, CallSite, etc.), if one.
 518   if (iter().has_appendix()) {
 519     ciObject* appendix_arg = iter().get_appendix();
 520     const TypeOopPtr* appendix_arg_type = TypeOopPtr::make_from_constant(appendix_arg, /* require_const= */ true);
 521     Node* appendix_arg_node = _gvn.makecon(appendix_arg_type);
 522     push(appendix_arg_node);
 523   }
 524 
 525   // ---------------------
 526   // Does Class Hierarchy Analysis reveal only a single target of a v-call?
 527   // Then we may inline or make a static call, but become dependent on there being only 1 target.
 528   // Does the call-site type profile reveal only one receiver?
 529   // Then we may introduce a run-time check and inline on the path where it succeeds.
 530   // The other path may uncommon_trap, check for another receiver, or do a v-call.
 531 
 532   // Try to get the most accurate receiver type
 533   ciMethod* callee             = orig_callee;
 534   int       vtable_index       = Method::invalid_vtable_index;
 535   bool      call_does_dispatch = false;
 536 
 537   // Speculative type of the receiver if any
 538   ciKlass* speculative_receiver_type = NULL;
 539   if (is_virtual_or_interface) {
 540     Node* receiver_node             = stack(sp() - nargs);
 541     const TypeOopPtr* receiver_type = NULL;
 542     if (receiver_node-&gt;is_InlineType()) {
 543       receiver_type = TypeInstPtr::make(TypePtr::NotNull, _gvn.type(receiver_node)-&gt;inline_klass());
 544     } else {
 545       receiver_type = _gvn.type(receiver_node)-&gt;isa_oopptr();
 546     }
 547     // call_does_dispatch and vtable_index are out-parameters.  They might be changed.
 548     // For arrays, klass below is Object. When vtable calls are used,
 549     // resolving the call with Object would allow an illegal call to
 550     // finalize() on an array. We use holder instead: illegal calls to
 551     // finalize() won&#39;t be compiled as vtable calls (IC call
 552     // resolution will catch the illegal call) and the few legal calls
 553     // on array types won&#39;t be either.
 554     callee = C-&gt;optimize_virtual_call(method(), bci(), klass, holder, orig_callee,
 555                                       receiver_type, is_virtual,
 556                                       call_does_dispatch, vtable_index);  // out-parameters
 557     speculative_receiver_type = receiver_type != NULL ? receiver_type-&gt;speculative_type() : NULL;
 558   }
 559 
 560   // Additional receiver subtype checks for interface calls via invokespecial or invokeinterface.
 561   ciKlass* receiver_constraint = NULL;
 562   if (iter().cur_bc_raw() == Bytecodes::_invokespecial &amp;&amp; !orig_callee-&gt;is_object_constructor()) {
 563     ciInstanceKlass* calling_klass = method()-&gt;holder();
 564     ciInstanceKlass* sender_klass =
 565         calling_klass-&gt;is_unsafe_anonymous() ? calling_klass-&gt;unsafe_anonymous_host() :
 566                                                calling_klass;
 567     if (sender_klass-&gt;is_interface()) {
 568       receiver_constraint = sender_klass;
 569     }
 570   } else if (iter().cur_bc_raw() == Bytecodes::_invokeinterface &amp;&amp; orig_callee-&gt;is_private()) {
 571     assert(holder-&gt;is_interface(), &quot;How did we get a non-interface method here!&quot;);
 572     receiver_constraint = holder;
 573   }
 574 
 575   if (receiver_constraint != NULL) {
 576     Node* receiver_node = stack(sp() - nargs);
 577     Node* cls_node = makecon(TypeKlassPtr::make(receiver_constraint));
 578     Node* bad_type_ctrl = NULL;
 579     Node* casted_receiver = gen_checkcast(receiver_node, cls_node, &amp;bad_type_ctrl);
 580     if (bad_type_ctrl != NULL) {
 581       PreserveJVMState pjvms(this);
 582       set_control(bad_type_ctrl);
 583       uncommon_trap(Deoptimization::Reason_class_check,
 584                     Deoptimization::Action_none);
 585     }
 586     if (stopped()) {
 587       return; // MUST uncommon-trap?
 588     }
 589     set_stack(sp() - nargs, casted_receiver);
 590   }
 591 
 592   // Note:  It&#39;s OK to try to inline a virtual call.
 593   // The call generator will not attempt to inline a polymorphic call
 594   // unless it knows how to optimize the receiver dispatch.
 595   bool try_inline = (C-&gt;do_inlining() || InlineAccessors);
 596 
 597   // ---------------------
 598   dec_sp(nargs);              // Temporarily pop args for JVM state of call
 599   JVMState* jvms = sync_jvms();
 600 
 601   // ---------------------
 602   // Decide call tactic.
 603   // This call checks with CHA, the interpreter profile, intrinsics table, etc.
 604   // It decides whether inlining is desirable or not.
 605   CallGenerator* cg = C-&gt;call_generator(callee, vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type);
 606 
 607   // NOTE:  Don&#39;t use orig_callee and callee after this point!  Use cg-&gt;method() instead.
 608   orig_callee = callee = NULL;
 609 
 610   // ---------------------
 611   // Round double arguments before call
 612   round_double_arguments(cg-&gt;method());
 613 
 614   // Feed profiling data for arguments to the type system so it can
 615   // propagate it as speculative types
 616   record_profiled_arguments_for_speculation(cg-&gt;method(), bc());
 617 
 618 #ifndef PRODUCT
 619   // bump global counters for calls
 620   count_compiled_calls(/*at_method_entry*/ false, cg-&gt;is_inline());
 621 
 622   // Record first part of parsing work for this call
 623   parse_histogram()-&gt;record_change();
 624 #endif // not PRODUCT
 625 
 626   assert(jvms == this-&gt;jvms(), &quot;still operating on the right JVMS&quot;);
 627   assert(jvms_in_sync(),       &quot;jvms must carry full info into CG&quot;);
 628 
 629   // save across call, for a subsequent cast_not_null.
 630   Node* receiver = has_receiver ? argument(0) : NULL;
 631 
 632   // The extra CheckCastPPs for speculative types mess with PhaseStringOpts
 633   if (receiver != NULL &amp;&amp; !receiver-&gt;is_InlineType() &amp;&amp; !call_does_dispatch &amp;&amp; !cg-&gt;is_string_late_inline()) {
 634     // Feed profiling data for a single receiver to the type system so
 635     // it can propagate it as a speculative type
 636     receiver = record_profiled_receiver_for_speculation(receiver);
 637   }
 638 
 639   // Bump method data counters (We profile *before* the call is made
 640   // because exceptions don&#39;t return to the call site.)
 641   profile_call(receiver);
 642 
 643   JVMState* new_jvms = cg-&gt;generate(jvms);
 644   if (new_jvms == NULL) {
 645     // When inlining attempt fails (e.g., too many arguments),
 646     // it may contaminate the current compile state, making it
 647     // impossible to pull back and try again.  Once we call
 648     // cg-&gt;generate(), we are committed.  If it fails, the whole
 649     // compilation task is compromised.
 650     if (failing())  return;
 651 
 652     // This can happen if a library intrinsic is available, but refuses
 653     // the call site, perhaps because it did not match a pattern the
 654     // intrinsic was expecting to optimize. Should always be possible to
 655     // get a normal java call that may inline in that case
 656     cg = C-&gt;call_generator(cg-&gt;method(), vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type, /* allow_intrinsics= */ false);
 657     new_jvms = cg-&gt;generate(jvms);
 658     if (new_jvms == NULL) {
 659       guarantee(failing(), &quot;call failed to generate:  calls should work&quot;);
 660       return;
 661     }
 662   }
 663 
 664   if (cg-&gt;is_inline()) {
 665     // Accumulate has_loops estimate
 666     C-&gt;set_has_loops(C-&gt;has_loops() || cg-&gt;method()-&gt;has_loops());
 667     C-&gt;env()-&gt;notice_inlined_method(cg-&gt;method());
 668   }
 669 
 670   // Reset parser state from [new_]jvms, which now carries results of the call.
 671   // Return value (if any) is already pushed on the stack by the cg.
 672   add_exception_states_from(new_jvms);
 673   if (new_jvms-&gt;map()-&gt;control() == top()) {
 674     stop_and_kill_map();
 675   } else {
 676     assert(new_jvms-&gt;same_calls_as(jvms), &quot;method/bci left unchanged&quot;);
 677     set_jvms(new_jvms);
 678   }
 679 
 680   assert(check_call_consistency(jvms, cg), &quot;inconsistent info&quot;);
 681 
 682   if (!stopped()) {
 683     // This was some sort of virtual call, which did a null check for us.
 684     // Now we can assert receiver-not-null, on the normal return path.
 685     if (receiver != NULL &amp;&amp; cg-&gt;is_virtual()) {
 686       Node* cast = cast_not_null(receiver);
 687       // %%% assert(receiver == cast, &quot;should already have cast the receiver&quot;);
 688     }
 689 
 690     // Round double result after a call from strict to non-strict code
 691     round_double_result(cg-&gt;method());
 692 
 693     ciType* rtype = cg-&gt;method()-&gt;return_type();
 694     ciType* ctype = declared_signature-&gt;return_type();
 695 
 696     if (Bytecodes::has_optional_appendix(iter().cur_bc_raw()) || is_signature_polymorphic) {
 697       // Be careful here with return types.
 698       if (ctype != rtype) {
 699         BasicType rt = rtype-&gt;basic_type();
 700         BasicType ct = ctype-&gt;basic_type();
 701         if (ct == T_VOID) {
 702           // It&#39;s OK for a method to return a value that is discarded.
 703           // The discarding does not require any special action from the caller.
 704           // The Java code knows this, at VerifyType.isNullConversion.
 705           pop_node(rt);  // whatever it was, pop it
 706         } else if (rt == T_INT || is_subword_type(rt)) {
 707           // Nothing.  These cases are handled in lambda form bytecode.
 708           assert(ct == T_INT || is_subword_type(ct), &quot;must match: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 709         } else if (is_reference_type(rt)) {
 710           assert(is_reference_type(ct), &quot;rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 711           if (ctype-&gt;is_loaded()) {
 712             const TypeOopPtr* arg_type = TypeOopPtr::make_from_klass(rtype-&gt;as_klass());
 713             const Type*       sig_type = TypeOopPtr::make_from_klass(ctype-&gt;as_klass());
 714             if (ct == T_INLINE_TYPE) {
 715               sig_type = sig_type-&gt;join_speculative(TypePtr::NOTNULL);
 716             }
 717             if (arg_type != NULL &amp;&amp; !arg_type-&gt;higher_equal(sig_type) &amp;&amp; !peek()-&gt;is_InlineType()) {
 718               Node* retnode = pop();
 719               Node* cast_obj = _gvn.transform(new CheckCastPPNode(control(), retnode, sig_type));
 720               push(cast_obj);
 721             }
 722           }
 723         } else {
 724           assert(rt == ct, &quot;unexpected mismatch: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 725           // push a zero; it&#39;s better than getting an oop/int mismatch
 726           pop_node(rt);
 727           Node* retnode = zerocon(ct);
 728           push_node(ct, retnode);
 729         }
 730         // Now that the value is well-behaved, continue with the call-site type.
 731         rtype = ctype;
 732       }
 733     } else {
 734       // Symbolic resolution enforces the types to be the same.
 735       // NOTE: We must relax the assert for unloaded types because two
 736       // different ciType instances of the same unloaded class type
 737       // can appear to be &quot;loaded&quot; by different loaders (depending on
 738       // the accessing class).
 739       assert(!rtype-&gt;is_loaded() || !ctype-&gt;is_loaded() || rtype == ctype,
 740              &quot;mismatched return types: rtype=%s, ctype=%s&quot;, rtype-&gt;name(), ctype-&gt;name());
 741     }
 742 
 743     if (rtype-&gt;basic_type() == T_INLINE_TYPE &amp;&amp; !peek()-&gt;is_InlineType()) {
 744       Node* retnode = pop();
 745       assert(!gvn().type(retnode)-&gt;maybe_null(), &quot;should never be null&quot;);
 746       if (rtype-&gt;as_inline_klass()-&gt;is_scalarizable()) {
 747         retnode = InlineTypeNode::make_from_oop(this, retnode, rtype-&gt;as_inline_klass());
 748       }
 749       push_node(T_INLINE_TYPE, retnode);
 750     }
 751 
 752     // If the return type of the method is not loaded, assert that the
 753     // value we got is a null.  Otherwise, we need to recompile.
 754     if (!rtype-&gt;is_loaded()) {
 755       if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 756         method()-&gt;print_name(); tty-&gt;print_cr(&quot; asserting nullness of result at bci: %d&quot;, bci());
 757         cg-&gt;method()-&gt;print_name(); tty-&gt;cr();
 758       }
 759       if (C-&gt;log() != NULL) {
 760         C-&gt;log()-&gt;elem(&quot;assert_null reason=&#39;return&#39; klass=&#39;%d&#39;&quot;,
 761                        C-&gt;log()-&gt;identify(rtype));
 762       }
 763       // If there is going to be a trap, put it at the next bytecode:
 764       set_bci(iter().next_bci());
 765       null_assert(peek());
 766       set_bci(iter().cur_bci()); // put it back
 767     }
 768     BasicType ct = ctype-&gt;basic_type();
 769     if (is_reference_type(ct)) {
 770       record_profiled_return_for_speculation();
 771     }
 772   }
 773 
 774   // Restart record of parsing work after possible inlining of call
 775 #ifndef PRODUCT
 776   parse_histogram()-&gt;set_initial_state(bc());
 777 #endif
 778 }
 779 
 780 //---------------------------catch_call_exceptions-----------------------------
 781 // Put a Catch and CatchProj nodes behind a just-created call.
 782 // Send their caught exceptions to the proper handler.
 783 // This may be used after a call to the rethrow VM stub,
 784 // when it is needed to process unloaded exception classes.
 785 void Parse::catch_call_exceptions(ciExceptionHandlerStream&amp; handlers) {
 786   // Exceptions are delivered through this channel:
 787   Node* i_o = this-&gt;i_o();
 788 
 789   // Add a CatchNode.
 790   GrowableArray&lt;int&gt;* bcis = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, -1);
 791   GrowableArray&lt;const Type*&gt;* extypes = new (C-&gt;node_arena()) GrowableArray&lt;const Type*&gt;(C-&gt;node_arena(), 8, 0, NULL);
 792   GrowableArray&lt;int&gt;* saw_unloaded = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, 0);
 793 
 794   bool default_handler = false;
 795   for (; !handlers.is_done(); handlers.next()) {
 796     ciExceptionHandler* h        = handlers.handler();
 797     int                 h_bci    = h-&gt;handler_bci();
 798     ciInstanceKlass*    h_klass  = h-&gt;is_catch_all() ? env()-&gt;Throwable_klass() : h-&gt;catch_klass();
 799     // Do not introduce unloaded exception types into the graph:
 800     if (!h_klass-&gt;is_loaded()) {
 801       if (saw_unloaded-&gt;contains(h_bci)) {
 802         /* We&#39;ve already seen an unloaded exception with h_bci,
 803            so don&#39;t duplicate. Duplication will cause the CatchNode to be
 804            unnecessarily large. See 4713716. */
 805         continue;
 806       } else {
 807         saw_unloaded-&gt;append(h_bci);
 808       }
 809     }
 810     const Type*         h_extype = TypeOopPtr::make_from_klass(h_klass);
 811     // (We use make_from_klass because it respects UseUniqueSubclasses.)
 812     h_extype = h_extype-&gt;join(TypeInstPtr::NOTNULL);
 813     assert(!h_extype-&gt;empty(), &quot;sanity&quot;);
 814     // Note:  It&#39;s OK if the BCIs repeat themselves.
 815     bcis-&gt;append(h_bci);
 816     extypes-&gt;append(h_extype);
 817     if (h_bci == -1) {
 818       default_handler = true;
 819     }
 820   }
 821 
 822   if (!default_handler) {
 823     bcis-&gt;append(-1);
 824     extypes-&gt;append(TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr());
 825   }
 826 
 827   int len = bcis-&gt;length();
 828   CatchNode *cn = new CatchNode(control(), i_o, len+1);
 829   Node *catch_ = _gvn.transform(cn);
 830 
 831   // now branch with the exception state to each of the (potential)
 832   // handlers
 833   for(int i=0; i &lt; len; i++) {
 834     // Setup JVM state to enter the handler.
 835     PreserveJVMState pjvms(this);
 836     // Locals are just copied from before the call.
 837     // Get control from the CatchNode.
 838     int handler_bci = bcis-&gt;at(i);
 839     Node* ctrl = _gvn.transform( new CatchProjNode(catch_, i+1,handler_bci));
 840     // This handler cannot happen?
 841     if (ctrl == top())  continue;
 842     set_control(ctrl);
 843 
 844     // Create exception oop
 845     const TypeInstPtr* extype = extypes-&gt;at(i)-&gt;is_instptr();
 846     Node *ex_oop = _gvn.transform(new CreateExNode(extypes-&gt;at(i), ctrl, i_o));
 847 
 848     // Handle unloaded exception classes.
 849     if (saw_unloaded-&gt;contains(handler_bci)) {
 850       // An unloaded exception type is coming here.  Do an uncommon trap.
 851 #ifndef PRODUCT
 852       // We do not expect the same handler bci to take both cold unloaded
 853       // and hot loaded exceptions.  But, watch for it.
 854       if ((Verbose || WizardMode) &amp;&amp; extype-&gt;is_loaded()) {
 855         tty-&gt;print(&quot;Warning: Handler @%d takes mixed loaded/unloaded exceptions in &quot;, bci());
 856         method()-&gt;print_name(); tty-&gt;cr();
 857       } else if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 858         tty-&gt;print(&quot;Bailing out on unloaded exception type &quot;);
 859         extype-&gt;klass()-&gt;print_name();
 860         tty-&gt;print(&quot; at bci:%d in &quot;, bci());
 861         method()-&gt;print_name(); tty-&gt;cr();
 862       }
 863 #endif
 864       // Emit an uncommon trap instead of processing the block.
 865       set_bci(handler_bci);
 866       push_ex_oop(ex_oop);
 867       uncommon_trap(Deoptimization::Reason_unloaded,
 868                     Deoptimization::Action_reinterpret,
 869                     extype-&gt;klass(), &quot;!loaded exception&quot;);
 870       set_bci(iter().cur_bci()); // put it back
 871       continue;
 872     }
 873 
 874     // go to the exception handler
 875     if (handler_bci &lt; 0) {     // merge with corresponding rethrow node
 876       throw_to_exit(make_exception_state(ex_oop));
 877     } else {                      // Else jump to corresponding handle
 878       push_ex_oop(ex_oop);        // Clear stack and push just the oop.
 879       merge_exception(handler_bci);
 880     }
 881   }
 882 
 883   // The first CatchProj is for the normal return.
 884   // (Note:  If this is a call to rethrow_Java, this node goes dead.)
 885   set_control(_gvn.transform( new CatchProjNode(catch_, CatchProjNode::fall_through_index, CatchProjNode::no_handler_bci)));
 886 }
 887 
 888 
 889 //----------------------------catch_inline_exceptions--------------------------
 890 // Handle all exceptions thrown by an inlined method or individual bytecode.
 891 // Common case 1: we have no handler, so all exceptions merge right into
 892 // the rethrow case.
 893 // Case 2: we have some handlers, with loaded exception klasses that have
 894 // no subklasses.  We do a Deutsch-Shiffman style type-check on the incoming
 895 // exception oop and branch to the handler directly.
 896 // Case 3: We have some handlers with subklasses or are not loaded at
 897 // compile-time.  We have to call the runtime to resolve the exception.
 898 // So we insert a RethrowCall and all the logic that goes with it.
 899 void Parse::catch_inline_exceptions(SafePointNode* ex_map) {
 900   // Caller is responsible for saving away the map for normal control flow!
 901   assert(stopped(), &quot;call set_map(NULL) first&quot;);
 902   assert(method()-&gt;has_exception_handlers(), &quot;don&#39;t come here w/o work to do&quot;);
 903 
 904   Node* ex_node = saved_ex_oop(ex_map);
 905   if (ex_node == top()) {
 906     // No action needed.
 907     return;
 908   }
 909   const TypeInstPtr* ex_type = _gvn.type(ex_node)-&gt;isa_instptr();
 910   NOT_PRODUCT(if (ex_type==NULL) tty-&gt;print_cr(&quot;*** Exception not InstPtr&quot;));
 911   if (ex_type == NULL)
 912     ex_type = TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr();
 913 
 914   // determine potential exception handlers
 915   ciExceptionHandlerStream handlers(method(), bci(),
 916                                     ex_type-&gt;klass()-&gt;as_instance_klass(),
 917                                     ex_type-&gt;klass_is_exact());
 918 
 919   // Start executing from the given throw state.  (Keep its stack, for now.)
 920   // Get the exception oop as known at compile time.
 921   ex_node = use_exception_state(ex_map);
 922 
 923   // Get the exception oop klass from its header
 924   Node* ex_klass_node = NULL;
 925   if (has_ex_handler() &amp;&amp; !ex_type-&gt;klass_is_exact()) {
 926     Node* p = basic_plus_adr( ex_node, ex_node, oopDesc::klass_offset_in_bytes());
 927     ex_klass_node = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 928 
 929     // Compute the exception klass a little more cleverly.
 930     // Obvious solution is to simple do a LoadKlass from the &#39;ex_node&#39;.
 931     // However, if the ex_node is a PhiNode, I&#39;m going to do a LoadKlass for
 932     // each arm of the Phi.  If I know something clever about the exceptions
 933     // I&#39;m loading the class from, I can replace the LoadKlass with the
 934     // klass constant for the exception oop.
 935     if (ex_node-&gt;is_Phi()) {
 936       ex_klass_node = new PhiNode(ex_node-&gt;in(0), TypeKlassPtr::OBJECT);
 937       for (uint i = 1; i &lt; ex_node-&gt;req(); i++) {
 938         Node* ex_in = ex_node-&gt;in(i);
 939         if (ex_in == top() || ex_in == NULL) {
 940           // This path was not taken.
 941           ex_klass_node-&gt;init_req(i, top());
 942           continue;
 943         }
 944         Node* p = basic_plus_adr(ex_in, ex_in, oopDesc::klass_offset_in_bytes());
 945         Node* k = _gvn.transform( LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 946         ex_klass_node-&gt;init_req( i, k );
 947       }
 948       _gvn.set_type(ex_klass_node, TypeKlassPtr::OBJECT);
 949 
 950     }
 951   }
 952 
 953   // Scan the exception table for applicable handlers.
 954   // If none, we can call rethrow() and be done!
 955   // If precise (loaded with no subklasses), insert a D.S. style
 956   // pointer compare to the correct handler and loop back.
 957   // If imprecise, switch to the Rethrow VM-call style handling.
 958 
 959   int remaining = handlers.count_remaining();
 960 
 961   // iterate through all entries sequentially
 962   for (;!handlers.is_done(); handlers.next()) {
 963     ciExceptionHandler* handler = handlers.handler();
 964 
 965     if (handler-&gt;is_rethrow()) {
 966       // If we fell off the end of the table without finding an imprecise
 967       // exception klass (and without finding a generic handler) then we
 968       // know this exception is not handled in this method.  We just rethrow
 969       // the exception into the caller.
 970       throw_to_exit(make_exception_state(ex_node));
 971       return;
 972     }
 973 
 974     // exception handler bci range covers throw_bci =&gt; investigate further
 975     int handler_bci = handler-&gt;handler_bci();
 976 
 977     if (remaining == 1) {
 978       push_ex_oop(ex_node);        // Push exception oop for handler
 979       if (PrintOpto &amp;&amp; WizardMode) {
 980         tty-&gt;print_cr(&quot;  Catching every inline exception bci:%d -&gt; handler_bci:%d&quot;, bci(), handler_bci);
 981       }
 982       merge_exception(handler_bci); // jump to handler
 983       return;                   // No more handling to be done here!
 984     }
 985 
 986     // Get the handler&#39;s klass
 987     ciInstanceKlass* klass = handler-&gt;catch_klass();
 988 
 989     if (!klass-&gt;is_loaded()) {  // klass is not loaded?
 990       // fall through into catch_call_exceptions which will emit a
 991       // handler with an uncommon trap.
 992       break;
 993     }
 994 
 995     if (klass-&gt;is_interface())  // should not happen, but...
 996       break;                    // bail out
 997 
 998     // Check the type of the exception against the catch type
 999     const TypeKlassPtr *tk = TypeKlassPtr::make(klass);
1000     Node* con = _gvn.makecon(tk);
1001     Node* not_subtype_ctrl = gen_subtype_check(ex_klass_node, con);
1002     if (!stopped()) {
1003       PreserveJVMState pjvms(this);
1004       const TypeInstPtr* tinst = TypeOopPtr::make_from_klass_unique(klass)-&gt;cast_to_ptr_type(TypePtr::NotNull)-&gt;is_instptr();
1005       assert(klass-&gt;has_subklass() || tinst-&gt;klass_is_exact(), &quot;lost exactness&quot;);
1006       Node* ex_oop = _gvn.transform(new CheckCastPPNode(control(), ex_node, tinst));
1007       push_ex_oop(ex_oop);      // Push exception oop for handler
1008       if (PrintOpto &amp;&amp; WizardMode) {
1009         tty-&gt;print(&quot;  Catching inline exception bci:%d -&gt; handler_bci:%d -- &quot;, bci(), handler_bci);
1010         klass-&gt;print_name();
1011         tty-&gt;cr();
1012       }
1013       merge_exception(handler_bci);
1014     }
1015     set_control(not_subtype_ctrl);
1016 
1017     // Come here if exception does not match handler.
1018     // Carry on with more handler checks.
1019     --remaining;
1020   }
1021 
1022   assert(!stopped(), &quot;you should return if you finish the chain&quot;);
1023 
1024   // Oops, need to call into the VM to resolve the klasses at runtime.
1025   // Note:  This call must not deoptimize, since it is not a real at this bci!
1026   kill_dead_locals();
1027 
1028   make_runtime_call(RC_NO_LEAF | RC_MUST_THROW,
1029                     OptoRuntime::rethrow_Type(),
1030                     OptoRuntime::rethrow_stub(),
1031                     NULL, NULL,
1032                     ex_node);
1033 
1034   // Rethrow is a pure call, no side effects, only a result.
1035   // The result cannot be allocated, so we use I_O
1036 
1037   // Catch exceptions from the rethrow
1038   catch_call_exceptions(handlers);
1039 }
1040 
1041 
1042 // (Note:  Moved add_debug_info into GraphKit::add_safepoint_edges.)
1043 
1044 
1045 #ifndef PRODUCT
1046 void Parse::count_compiled_calls(bool at_method_entry, bool is_inline) {
1047   if( CountCompiledCalls ) {
1048     if( at_method_entry ) {
1049       // bump invocation counter if top method (for statistics)
1050       if (CountCompiledCalls &amp;&amp; depth() == 1) {
1051         const TypePtr* addr_type = TypeMetadataPtr::make(method());
1052         Node* adr1 = makecon(addr_type);
1053         Node* adr2 = basic_plus_adr(adr1, adr1, in_bytes(Method::compiled_invocation_counter_offset()));
1054         increment_counter(adr2);
1055       }
1056     } else if (is_inline) {
1057       switch (bc()) {
1058       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_inlined_calls_addr()); break;
1059       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_inlined_interface_calls_addr()); break;
1060       case Bytecodes::_invokestatic:
1061       case Bytecodes::_invokedynamic:
1062       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_inlined_static_calls_addr()); break;
1063       default: fatal(&quot;unexpected call bytecode&quot;);
1064       }
1065     } else {
1066       switch (bc()) {
1067       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_normal_calls_addr()); break;
1068       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_interface_calls_addr()); break;
1069       case Bytecodes::_invokestatic:
1070       case Bytecodes::_invokedynamic:
1071       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_static_calls_addr()); break;
1072       default: fatal(&quot;unexpected call bytecode&quot;);
1073       }
1074     }
1075   }
1076 }
1077 #endif //PRODUCT
1078 
1079 
1080 ciMethod* Compile::optimize_virtual_call(ciMethod* caller, int bci, ciInstanceKlass* klass,
1081                                          ciKlass* holder, ciMethod* callee,
1082                                          const TypeOopPtr* receiver_type, bool is_virtual,
1083                                          bool&amp; call_does_dispatch, int&amp; vtable_index,
1084                                          bool check_access) {
1085   // Set default values for out-parameters.
1086   call_does_dispatch = true;
1087   vtable_index       = Method::invalid_vtable_index;
1088 
1089   // Choose call strategy.
1090   ciMethod* optimized_virtual_method = optimize_inlining(caller, bci, klass, callee,
1091                                                          receiver_type, check_access);
1092 
1093   // Have the call been sufficiently improved such that it is no longer a virtual?
1094   if (optimized_virtual_method != NULL) {
1095     callee             = optimized_virtual_method;
1096     call_does_dispatch = false;
1097   } else if (!UseInlineCaches &amp;&amp; is_virtual &amp;&amp; callee-&gt;is_loaded()) {
1098     // We can make a vtable call at this site
1099     vtable_index = callee-&gt;resolve_vtable_index(caller-&gt;holder(), holder);
1100   }
1101   return callee;
1102 }
1103 
1104 // Identify possible target method and inlining style
1105 ciMethod* Compile::optimize_inlining(ciMethod* caller, int bci, ciInstanceKlass* klass,
1106                                      ciMethod* callee, const TypeOopPtr* receiver_type,
1107                                      bool check_access) {
1108   // only use for virtual or interface calls
1109 
1110   // If it is obviously final, do not bother to call find_monomorphic_target,
1111   // because the class hierarchy checks are not needed, and may fail due to
1112   // incompletely loaded classes.  Since we do our own class loading checks
1113   // in this module, we may confidently bind to any method.
1114   if (callee-&gt;can_be_statically_bound()) {
1115     return callee;
1116   }
1117 
1118   // Attempt to improve the receiver
1119   bool actual_receiver_is_exact = false;
1120   ciInstanceKlass* actual_receiver = klass;
1121   if (receiver_type != NULL) {
1122     // Array methods are all inherited from Object, and are monomorphic.
1123     // finalize() call on array is not allowed.
1124     if (receiver_type-&gt;isa_aryptr() &amp;&amp;
1125         callee-&gt;holder() == env()-&gt;Object_klass() &amp;&amp;
1126         callee-&gt;name() != ciSymbol::finalize_method_name()) {
1127       return callee;
1128     }
1129 
1130     // All other interesting cases are instance klasses.
1131     if (!receiver_type-&gt;isa_instptr()) {
1132       return NULL;
1133     }
1134 
1135     ciInstanceKlass *ikl = receiver_type-&gt;klass()-&gt;as_instance_klass();
1136     if (ikl-&gt;is_loaded() &amp;&amp; ikl-&gt;is_initialized() &amp;&amp; !ikl-&gt;is_interface() &amp;&amp;
1137         (ikl == actual_receiver || ikl-&gt;is_subtype_of(actual_receiver))) {
1138       // ikl is a same or better type than the original actual_receiver,
1139       // e.g. static receiver from bytecodes.
1140       actual_receiver = ikl;
1141       // Is the actual_receiver exact?
1142       actual_receiver_is_exact = receiver_type-&gt;klass_is_exact();
1143     }
1144   }
1145 
1146   ciInstanceKlass*   calling_klass = caller-&gt;holder();
1147   ciMethod* cha_monomorphic_target = callee-&gt;find_monomorphic_target(calling_klass, klass, actual_receiver, check_access);
1148   if (cha_monomorphic_target != NULL) {
1149     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1150     // Look at the method-receiver type.  Does it add &quot;too much information&quot;?
1151     ciKlass*    mr_klass = cha_monomorphic_target-&gt;holder();
1152     const Type* mr_type  = TypeInstPtr::make(TypePtr::BotPTR, mr_klass);
1153     if (receiver_type == NULL || !receiver_type-&gt;higher_equal(mr_type)) {
1154       // Calling this method would include an implicit cast to its holder.
1155       // %%% Not yet implemented.  Would throw minor asserts at present.
1156       // %%% The most common wins are already gained by +UseUniqueSubclasses.
1157       // To fix, put the higher_equal check at the call of this routine,
1158       // and add a CheckCastPP to the receiver.
1159       if (TraceDependencies) {
1160         tty-&gt;print_cr(&quot;found unique CHA method, but could not cast up&quot;);
1161         tty-&gt;print(&quot;  method  = &quot;);
1162         cha_monomorphic_target-&gt;print();
1163         tty-&gt;cr();
1164       }
1165       if (log() != NULL) {
1166         log()-&gt;elem(&quot;missed_CHA_opportunity klass=&#39;%d&#39; method=&#39;%d&#39;&quot;,
1167                        log()-&gt;identify(klass),
1168                        log()-&gt;identify(cha_monomorphic_target));
1169       }
1170       cha_monomorphic_target = NULL;
1171     }
1172   }
1173 
1174   if (cha_monomorphic_target != NULL) {
1175     // Hardwiring a virtual.
1176     assert(!callee-&gt;can_be_statically_bound(), &quot;should have been handled earlier&quot;);
1177     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1178     if (!cha_monomorphic_target-&gt;can_be_statically_bound(actual_receiver)) {
1179       // If we inlined because CHA revealed only a single target method,
1180       // then we are dependent on that target method not getting overridden
1181       // by dynamic class loading.  Be sure to test the &quot;static&quot; receiver
1182       // dest_method here, as opposed to the actual receiver, which may
1183       // falsely lead us to believe that the receiver is final or private.
1184       dependencies()-&gt;assert_unique_concrete_method(actual_receiver, cha_monomorphic_target);
1185     }
1186     return cha_monomorphic_target;
1187   }
1188 
1189   // If the type is exact, we can still bind the method w/o a vcall.
1190   // (This case comes after CHA so we can see how much extra work it does.)
1191   if (actual_receiver_is_exact) {
1192     // In case of evolution, there is a dependence on every inlined method, since each
1193     // such method can be changed when its class is redefined.
1194     ciMethod* exact_method = callee-&gt;resolve_invoke(calling_klass, actual_receiver);
1195     if (exact_method != NULL) {
1196       if (PrintOpto) {
1197         tty-&gt;print(&quot;  Calling method via exact type @%d --- &quot;, bci);
1198         exact_method-&gt;print_name();
1199         tty-&gt;cr();
1200       }
1201       return exact_method;
1202     }
1203   }
1204 
1205   return NULL;
1206 }
    </pre>
  </body>
</html>