<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/doCall.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciCallSite.hpp&quot;
  27 #include &quot;ci/ciMethodHandle.hpp&quot;
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;compiler/compileBroker.hpp&quot;
  30 #include &quot;compiler/compileLog.hpp&quot;
  31 #include &quot;interpreter/linkResolver.hpp&quot;
  32 #include &quot;opto/addnode.hpp&quot;
  33 #include &quot;opto/callGenerator.hpp&quot;
  34 #include &quot;opto/castnode.hpp&quot;
  35 #include &quot;opto/cfgnode.hpp&quot;
  36 #include &quot;opto/inlinetypenode.hpp&quot;
  37 #include &quot;opto/mulnode.hpp&quot;
  38 #include &quot;opto/parse.hpp&quot;
  39 #include &quot;opto/rootnode.hpp&quot;
  40 #include &quot;opto/runtime.hpp&quot;
  41 #include &quot;opto/subnode.hpp&quot;
  42 #include &quot;prims/nativeLookup.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
  44 
  45 void trace_type_profile(Compile* C, ciMethod *method, int depth, int bci, ciMethod *prof_method, ciKlass *prof_klass, int site_count, int receiver_count) {
  46   if (TraceTypeProfile || C-&gt;print_inlining()) {
  47     outputStream* out = tty;
  48     if (!C-&gt;print_inlining()) {
  49       if (!PrintOpto &amp;&amp; !PrintCompilation) {
  50         method-&gt;print_short_name();
  51         tty-&gt;cr();
  52       }
  53       CompileTask::print_inlining_tty(prof_method, depth, bci);
  54     } else {
  55       out = C-&gt;print_inlining_stream();
  56     }
  57     CompileTask::print_inline_indent(depth, out);
  58     out-&gt;print(&quot; \\-&gt; TypeProfile (%d/%d counts) = &quot;, receiver_count, site_count);
  59     stringStream ss;
  60     prof_klass-&gt;name()-&gt;print_symbol_on(&amp;ss);
  61     out-&gt;print(&quot;%s&quot;, ss.as_string());
  62     out-&gt;cr();
  63   }
  64 }
  65 
  66 CallGenerator* Compile::call_generator(ciMethod* callee, int vtable_index, bool call_does_dispatch,
  67                                        JVMState* jvms, bool allow_inline,
  68                                        float prof_factor, ciKlass* speculative_receiver_type,
<a name="1" id="anc1"></a><span class="line-modified">  69                                        bool allow_intrinsics, bool delayed_forbidden) {</span>
  70   ciMethod*       caller   = jvms-&gt;method();
  71   int             bci      = jvms-&gt;bci();
  72   Bytecodes::Code bytecode = caller-&gt;java_code_at_bci(bci);
  73   guarantee(callee != NULL, &quot;failed method resolution&quot;);
  74 
  75   // Dtrace currently doesn&#39;t work unless all calls are vanilla
  76   if (env()-&gt;dtrace_method_probes()) {
  77     allow_inline = false;
  78   }
  79 
  80   // Note: When we get profiling during stage-1 compiles, we want to pull
  81   // from more specific profile data which pertains to this inlining.
  82   // Right now, ignore the information in jvms-&gt;caller(), and do method[bci].
  83   ciCallProfile profile = caller-&gt;call_profile_at_bci(bci);
  84 
  85   // See how many times this site has been invoked.
  86   int site_count = profile.count();
  87   int receiver_count = -1;
  88   if (call_does_dispatch &amp;&amp; UseTypeProfile &amp;&amp; profile.has_receiver(0)) {
  89     // Receivers in the profile structure are ordered by call counts
  90     // so that the most called (major) receiver is profile.receiver(0).
  91     receiver_count = profile.receiver_count(0);
  92   }
  93 
  94   CompileLog* log = this-&gt;log();
  95   if (log != NULL) {
  96     int rid = (receiver_count &gt;= 0)? log-&gt;identify(profile.receiver(0)): -1;
  97     int r2id = (rid != -1 &amp;&amp; profile.has_receiver(1))? log-&gt;identify(profile.receiver(1)):-1;
  98     log-&gt;begin_elem(&quot;call method=&#39;%d&#39; count=&#39;%d&#39; prof_factor=&#39;%f&#39;&quot;,
  99                     log-&gt;identify(callee), site_count, prof_factor);
 100     if (call_does_dispatch)  log-&gt;print(&quot; virtual=&#39;1&#39;&quot;);
 101     if (allow_inline)     log-&gt;print(&quot; inline=&#39;1&#39;&quot;);
 102     if (receiver_count &gt;= 0) {
 103       log-&gt;print(&quot; receiver=&#39;%d&#39; receiver_count=&#39;%d&#39;&quot;, rid, receiver_count);
 104       if (profile.has_receiver(1)) {
 105         log-&gt;print(&quot; receiver2=&#39;%d&#39; receiver2_count=&#39;%d&#39;&quot;, r2id, profile.receiver_count(1));
 106       }
 107     }
 108     if (callee-&gt;is_method_handle_intrinsic()) {
 109       log-&gt;print(&quot; method_handle_intrinsic=&#39;1&#39;&quot;);
 110     }
 111     log-&gt;end_elem();
 112   }
 113 
 114   // Special case the handling of certain common, profitable library
 115   // methods.  If these methods are replaced with specialized code,
 116   // then we return it as the inlined version of the call.
 117   // We do this before the strict f.p. check below because the
 118   // intrinsics handle strict f.p. correctly.
 119   CallGenerator* cg_intrinsic = NULL;
 120   if (allow_inline &amp;&amp; allow_intrinsics) {
 121     CallGenerator* cg = find_intrinsic(callee, call_does_dispatch);
 122     if (cg != NULL) {
 123       if (cg-&gt;is_predicated()) {
 124         // Code without intrinsic but, hopefully, inlined.
 125         CallGenerator* inline_cg = this-&gt;call_generator(callee,
 126               vtable_index, call_does_dispatch, jvms, allow_inline, prof_factor, speculative_receiver_type, false);
 127         if (inline_cg != NULL) {
 128           cg = CallGenerator::for_predicated_intrinsic(cg, inline_cg);
 129         }
 130       }
 131 
 132       // If intrinsic does the virtual dispatch, we try to use the type profile
 133       // first, and hopefully inline it as the regular virtual call below.
 134       // We will retry the intrinsic if nothing had claimed it afterwards.
 135       if (cg-&gt;does_virtual_dispatch()) {
 136         cg_intrinsic = cg;
 137         cg = NULL;
 138       } else {
 139         return cg;
 140       }
 141     }
 142   }
 143 
 144   // Do method handle calls.
 145   // NOTE: This must happen before normal inlining logic below since
 146   // MethodHandle.invoke* are native methods which obviously don&#39;t
 147   // have bytecodes and so normal inlining fails.
 148   if (callee-&gt;is_method_handle_intrinsic()) {
<a name="2" id="anc2"></a><span class="line-modified"> 149     CallGenerator* cg = CallGenerator::for_method_handle_call(jvms, caller, callee, delayed_forbidden);</span>
<span class="line-removed"> 150     assert(cg == NULL || !delayed_forbidden || !cg-&gt;is_late_inline() || cg-&gt;is_mh_late_inline(), &quot;unexpected CallGenerator&quot;);</span>
 151     return cg;
 152   }
 153 
 154   // If explicit rounding is required, do not inline strict into non-strict code (or the reverse).
 155   if (Matcher::strict_fp_requires_explicit_rounding &amp;&amp;
 156       caller-&gt;is_strict() != callee-&gt;is_strict()) {
 157     allow_inline = false;
 158   }
 159 
 160   // Attempt to inline...
 161   if (allow_inline) {
 162     // The profile data is only partly attributable to this caller,
 163     // scale back the call site information.
 164     float past_uses = jvms-&gt;method()-&gt;scale_count(site_count, prof_factor);
 165     // This is the number of times we expect the call code to be used.
 166     float expected_uses = past_uses;
 167 
 168     // Try inlining a bytecoded method:
 169     if (!call_does_dispatch) {
 170       InlineTree* ilt = InlineTree::find_subtree_from_root(this-&gt;ilt(), jvms-&gt;caller(), jvms-&gt;method());
 171       WarmCallInfo scratch_ci;
 172       bool should_delay = false;
 173       WarmCallInfo* ci = ilt-&gt;ok_to_inline(callee, jvms, profile, &amp;scratch_ci, should_delay);
 174       assert(ci != &amp;scratch_ci, &quot;do not let this pointer escape&quot;);
 175       bool allow_inline   = (ci != NULL &amp;&amp; !ci-&gt;is_cold());
 176       bool require_inline = (allow_inline &amp;&amp; ci-&gt;is_hot());
 177 
 178       if (allow_inline) {
 179         CallGenerator* cg = CallGenerator::for_inline(callee, expected_uses);
 180 
 181         if (require_inline &amp;&amp; cg != NULL) {
 182           // Delay the inlining of this method to give us the
 183           // opportunity to perform some high level optimizations
 184           // first.
 185           if (should_delay_string_inlining(callee, jvms)) {
<a name="3" id="anc3"></a><span class="line-removed"> 186             assert(!delayed_forbidden, &quot;strange&quot;);</span>
 187             return CallGenerator::for_string_late_inline(callee, cg);
 188           } else if (should_delay_boxing_inlining(callee, jvms)) {
<a name="4" id="anc4"></a><span class="line-removed"> 189             assert(!delayed_forbidden, &quot;strange&quot;);</span>
 190             return CallGenerator::for_boxing_late_inline(callee, cg);
<a name="5" id="anc5"></a><span class="line-modified"> 191           } else if ((should_delay || AlwaysIncrementalInline) &amp;&amp; !delayed_forbidden) {</span>
 192             return CallGenerator::for_late_inline(callee, cg);
 193           }
 194         }
 195         if (cg == NULL || should_delay) {
 196           // Fall through.
 197         } else if (require_inline || !InlineWarmCalls) {
 198           return cg;
 199         } else {
 200           CallGenerator* cold_cg = call_generator(callee, vtable_index, call_does_dispatch, jvms, false, prof_factor);
 201           return CallGenerator::for_warm_call(ci, cold_cg, cg);
 202         }
 203       }
 204     }
 205 
 206     // Try using the type profile.
 207     if (call_does_dispatch &amp;&amp; site_count &gt; 0 &amp;&amp; UseTypeProfile) {
 208       // The major receiver&#39;s count &gt;= TypeProfileMajorReceiverPercent of site_count.
 209       bool have_major_receiver = profile.has_receiver(0) &amp;&amp; (100.*profile.receiver_prob(0) &gt;= (float)TypeProfileMajorReceiverPercent);
 210       ciMethod* receiver_method = NULL;
 211 
 212       int morphism = profile.morphism();
 213       if (speculative_receiver_type != NULL) {
 214         if (!too_many_traps_or_recompiles(caller, bci, Deoptimization::Reason_speculate_class_check)) {
 215           // We have a speculative type, we should be able to resolve
 216           // the call. We do that before looking at the profiling at
 217           // this invoke because it may lead to bimorphic inlining which
 218           // a speculative type should help us avoid.
 219           receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 220                                                    speculative_receiver_type);
 221           if (receiver_method == NULL) {
 222             speculative_receiver_type = NULL;
 223           } else {
 224             morphism = 1;
 225           }
 226         } else {
 227           // speculation failed before. Use profiling at the call
 228           // (could allow bimorphic inlining for instance).
 229           speculative_receiver_type = NULL;
 230         }
 231       }
 232       if (receiver_method == NULL &amp;&amp;
 233           (have_major_receiver || morphism == 1 ||
 234            (morphism == 2 &amp;&amp; UseBimorphicInlining))) {
 235         // receiver_method = profile.method();
 236         // Profiles do not suggest methods now.  Look it up in the major receiver.
 237         receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 238                                                       profile.receiver(0));
 239       }
 240       if (receiver_method != NULL) {
 241         // The single majority receiver sufficiently outweighs the minority.
 242         CallGenerator* hit_cg = this-&gt;call_generator(receiver_method,
 243               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 244         if (hit_cg != NULL) {
 245           // Look up second receiver.
 246           CallGenerator* next_hit_cg = NULL;
 247           ciMethod* next_receiver_method = NULL;
 248           if (morphism == 2 &amp;&amp; UseBimorphicInlining) {
 249             next_receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 250                                                                profile.receiver(1));
 251             if (next_receiver_method != NULL) {
 252               next_hit_cg = this-&gt;call_generator(next_receiver_method,
 253                                   vtable_index, !call_does_dispatch, jvms,
 254                                   allow_inline, prof_factor);
 255               if (next_hit_cg != NULL &amp;&amp; !next_hit_cg-&gt;is_inline() &amp;&amp;
 256                   have_major_receiver &amp;&amp; UseOnlyInlinedBimorphic) {
 257                   // Skip if we can&#39;t inline second receiver&#39;s method
 258                   next_hit_cg = NULL;
 259               }
 260             }
 261           }
 262           CallGenerator* miss_cg;
 263           Deoptimization::DeoptReason reason = (morphism == 2
 264                                                ? Deoptimization::Reason_bimorphic
 265                                                : Deoptimization::reason_class_check(speculative_receiver_type != NULL));
 266           if ((morphism == 1 || (morphism == 2 &amp;&amp; next_hit_cg != NULL)) &amp;&amp;
 267               !too_many_traps_or_recompiles(caller, bci, reason)
 268              ) {
 269             // Generate uncommon trap for class check failure path
 270             // in case of monomorphic or bimorphic virtual call site.
 271             miss_cg = CallGenerator::for_uncommon_trap(callee, reason,
 272                         Deoptimization::Action_maybe_recompile);
 273           } else {
 274             // Generate virtual call for class check failure path
 275             // in case of polymorphic virtual call site.
 276             miss_cg = CallGenerator::for_virtual_call(callee, vtable_index);
 277           }
 278           if (miss_cg != NULL) {
 279             if (next_hit_cg != NULL) {
 280               assert(speculative_receiver_type == NULL, &quot;shouldn&#39;t end up here if we used speculation&quot;);
 281               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), next_receiver_method, profile.receiver(1), site_count, profile.receiver_count(1));
 282               // We don&#39;t need to record dependency on a receiver here and below.
 283               // Whenever we inline, the dependency is added by Parse::Parse().
 284               miss_cg = CallGenerator::for_predicted_call(profile.receiver(1), miss_cg, next_hit_cg, PROB_MAX);
 285             }
 286             if (miss_cg != NULL) {
 287               ciKlass* k = speculative_receiver_type != NULL ? speculative_receiver_type : profile.receiver(0);
 288               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), receiver_method, k, site_count, receiver_count);
 289               float hit_prob = speculative_receiver_type != NULL ? 1.0 : profile.receiver_prob(0);
 290               CallGenerator* cg = CallGenerator::for_predicted_call(k, miss_cg, hit_cg, hit_prob);
 291               if (cg != NULL)  return cg;
 292             }
 293           }
 294         }
 295       }
 296     }
 297 
 298     // If there is only one implementor of this interface then we
 299     // may be able to bind this invoke directly to the implementing
 300     // klass but we need both a dependence on the single interface
 301     // and on the method we bind to. Additionally since all we know
 302     // about the receiver type is that it&#39;s supposed to implement the
 303     // interface we have to insert a check that it&#39;s the class we
 304     // expect.  Interface types are not checked by the verifier so
 305     // they are roughly equivalent to Object.
 306     // The number of implementors for declared_interface is less or
 307     // equal to the number of implementors for target-&gt;holder() so
 308     // if number of implementors of target-&gt;holder() == 1 then
 309     // number of implementors for decl_interface is 0 or 1. If
 310     // it&#39;s 0 then no class implements decl_interface and there&#39;s
 311     // no point in inlining.
 312     if (call_does_dispatch &amp;&amp; bytecode == Bytecodes::_invokeinterface) {
 313       ciInstanceKlass* declared_interface =
 314           caller-&gt;get_declared_method_holder_at_bci(bci)-&gt;as_instance_klass();
 315       ciInstanceKlass* singleton = declared_interface-&gt;unique_implementor();
 316 
 317       if (singleton != NULL &amp;&amp;
 318           (!callee-&gt;is_default_method() || callee-&gt;is_overpass()) /* CHA doesn&#39;t support default methods yet */) {
 319         assert(singleton != declared_interface, &quot;not a unique implementor&quot;);
 320 
 321         ciMethod* cha_monomorphic_target =
 322             callee-&gt;find_monomorphic_target(caller-&gt;holder(), declared_interface, singleton);
 323 
 324         if (cha_monomorphic_target != NULL &amp;&amp;
 325             cha_monomorphic_target-&gt;holder() != env()-&gt;Object_klass()) { // subtype check against Object is useless
 326           ciKlass* holder = cha_monomorphic_target-&gt;holder();
 327 
 328           // Try to inline the method found by CHA. Inlined method is guarded by the type check.
 329           CallGenerator* hit_cg = call_generator(cha_monomorphic_target,
 330               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 331 
 332           // Deoptimize on type check fail. The interpreter will throw ICCE for us.
 333           CallGenerator* miss_cg = CallGenerator::for_uncommon_trap(callee,
 334               Deoptimization::Reason_class_check, Deoptimization::Action_none);
 335 
 336           CallGenerator* cg = CallGenerator::for_guarded_call(holder, miss_cg, hit_cg);
 337           if (hit_cg != NULL &amp;&amp; cg != NULL) {
 338             dependencies()-&gt;assert_unique_concrete_method(declared_interface, cha_monomorphic_target);
 339             return cg;
 340           }
 341         }
 342       }
 343     }
 344   }
 345 
 346   // Nothing claimed the intrinsic, we go with straight-forward inlining
 347   // for already discovered intrinsic.
 348   if (allow_inline &amp;&amp; allow_intrinsics &amp;&amp; cg_intrinsic != NULL) {
 349     assert(cg_intrinsic-&gt;does_virtual_dispatch(), &quot;sanity&quot;);
 350     return cg_intrinsic;
 351   }
 352 
 353   // There was no special inlining tactic, or it bailed out.
 354   // Use a more generic tactic, like a simple call.
 355   if (call_does_dispatch) {
 356     const char* msg = &quot;virtual call&quot;;
 357     if (PrintInlining) print_inlining(callee, jvms-&gt;depth() - 1, jvms-&gt;bci(), msg);
 358     C-&gt;log_inline_failure(msg);
 359     return CallGenerator::for_virtual_call(callee, vtable_index);
 360   } else {
 361     // Class Hierarchy Analysis or Type Profile reveals a unique target,
 362     // or it is a static or special call.
 363     return CallGenerator::for_direct_call(callee, should_delay_inlining(callee, jvms));
 364   }
 365 }
 366 
 367 // Return true for methods that shouldn&#39;t be inlined early so that
 368 // they are easier to analyze and optimize as intrinsics.
 369 bool Compile::should_delay_string_inlining(ciMethod* call_method, JVMState* jvms) {
 370   if (has_stringbuilder()) {
 371 
 372     if ((call_method-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 373          call_method-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass()) &amp;&amp;
 374         (jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 375          jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass())) {
 376       // Delay SB calls only when called from non-SB code
 377       return false;
 378     }
 379 
 380     switch (call_method-&gt;intrinsic_id()) {
 381       case vmIntrinsics::_StringBuilder_void:
 382       case vmIntrinsics::_StringBuilder_int:
 383       case vmIntrinsics::_StringBuilder_String:
 384       case vmIntrinsics::_StringBuilder_append_char:
 385       case vmIntrinsics::_StringBuilder_append_int:
 386       case vmIntrinsics::_StringBuilder_append_String:
 387       case vmIntrinsics::_StringBuilder_toString:
 388       case vmIntrinsics::_StringBuffer_void:
 389       case vmIntrinsics::_StringBuffer_int:
 390       case vmIntrinsics::_StringBuffer_String:
 391       case vmIntrinsics::_StringBuffer_append_char:
 392       case vmIntrinsics::_StringBuffer_append_int:
 393       case vmIntrinsics::_StringBuffer_append_String:
 394       case vmIntrinsics::_StringBuffer_toString:
 395       case vmIntrinsics::_Integer_toString:
 396         return true;
 397 
 398       case vmIntrinsics::_String_String:
 399         {
 400           Node* receiver = jvms-&gt;map()-&gt;in(jvms-&gt;argoff() + 1);
 401           if (receiver-&gt;is_Proj() &amp;&amp; receiver-&gt;in(0)-&gt;is_CallStaticJava()) {
 402             CallStaticJavaNode* csj = receiver-&gt;in(0)-&gt;as_CallStaticJava();
 403             ciMethod* m = csj-&gt;method();
 404             if (m != NULL &amp;&amp;
 405                 (m-&gt;intrinsic_id() == vmIntrinsics::_StringBuffer_toString ||
 406                  m-&gt;intrinsic_id() == vmIntrinsics::_StringBuilder_toString))
 407               // Delay String.&lt;init&gt;(new SB())
 408               return true;
 409           }
 410           return false;
 411         }
 412 
 413       default:
 414         return false;
 415     }
 416   }
 417   return false;
 418 }
 419 
 420 bool Compile::should_delay_boxing_inlining(ciMethod* call_method, JVMState* jvms) {
 421   if (eliminate_boxing() &amp;&amp; call_method-&gt;is_boxing_method()) {
 422     set_has_boxed_value(true);
 423     return aggressive_unboxing();
 424   }
 425   return false;
 426 }
 427 
 428 // uncommon-trap call-sites where callee is unloaded, uninitialized or will not link
 429 bool Parse::can_not_compile_call_site(ciMethod *dest_method, ciInstanceKlass* klass) {
 430   // Additional inputs to consider...
 431   // bc      = bc()
 432   // caller  = method()
 433   // iter().get_method_holder_index()
 434   assert( dest_method-&gt;is_loaded(), &quot;ciTypeFlow should not let us get here&quot; );
 435   // Interface classes can be loaded &amp; linked and never get around to
 436   // being initialized.  Uncommon-trap for not-initialized static or
 437   // v-calls.  Let interface calls happen.
 438   ciInstanceKlass* holder_klass = dest_method-&gt;holder();
 439   if (!holder_klass-&gt;is_being_initialized() &amp;&amp;
 440       !holder_klass-&gt;is_initialized() &amp;&amp;
 441       !holder_klass-&gt;is_interface()) {
 442     uncommon_trap(Deoptimization::Reason_uninitialized,
 443                   Deoptimization::Action_reinterpret,
 444                   holder_klass);
 445     return true;
 446   }
 447 
 448   assert(dest_method-&gt;is_loaded(), &quot;dest_method: typeflow responsibility&quot;);
 449   return false;
 450 }
 451 
 452 #ifdef ASSERT
 453 static bool check_call_consistency(JVMState* jvms, CallGenerator* cg) {
 454   ciMethod* symbolic_info = jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci());
 455   ciMethod* resolved_method = cg-&gt;method();
 456   if (!ciMethod::is_consistent_info(symbolic_info, resolved_method)) {
 457     tty-&gt;print_cr(&quot;JVMS:&quot;);
 458     jvms-&gt;dump();
 459     tty-&gt;print_cr(&quot;Bytecode info:&quot;);
 460     jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci())-&gt;print(); tty-&gt;cr();
 461     tty-&gt;print_cr(&quot;Resolved method:&quot;);
 462     cg-&gt;method()-&gt;print(); tty-&gt;cr();
 463     return false;
 464   }
 465   return true;
 466 }
 467 #endif // ASSERT
 468 
 469 //------------------------------do_call----------------------------------------
 470 // Handle your basic call.  Inline if we can &amp; want to, else just setup call.
 471 void Parse::do_call() {
 472   // It&#39;s likely we are going to add debug info soon.
 473   // Also, if we inline a guy who eventually needs debug info for this JVMS,
 474   // our contribution to it is cleaned up right here.
 475   kill_dead_locals();
 476 
 477   C-&gt;print_inlining_assert_ready();
 478 
 479   // Set frequently used booleans
 480   const bool is_virtual = bc() == Bytecodes::_invokevirtual;
 481   const bool is_virtual_or_interface = is_virtual || bc() == Bytecodes::_invokeinterface;
 482   const bool has_receiver = Bytecodes::has_receiver(bc());
 483 
 484   // Find target being called
 485   bool             will_link;
 486   ciSignature*     declared_signature = NULL;
 487   ciMethod*        orig_callee  = iter().get_method(will_link, &amp;declared_signature);  // callee in the bytecode
 488   ciInstanceKlass* holder_klass = orig_callee-&gt;holder();
 489   ciKlass*         holder       = iter().get_declared_method_holder();
 490   ciInstanceKlass* klass = ciEnv::get_instance_klass_for_declared_method_holder(holder);
 491   assert(declared_signature != NULL, &quot;cannot be null&quot;);
 492 
 493   // Bump max node limit for JSR292 users
 494   if (bc() == Bytecodes::_invokedynamic || orig_callee-&gt;is_method_handle_intrinsic()) {
 495     C-&gt;set_max_node_limit(3*MaxNodeLimit);
 496   }
 497 
 498   // uncommon-trap when callee is unloaded, uninitialized or will not link
 499   // bailout when too many arguments for register representation
 500   if (!will_link || can_not_compile_call_site(orig_callee, klass)) {
 501     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 502       method()-&gt;print_name(); tty-&gt;print_cr(&quot; can not compile call at bci %d to:&quot;, bci());
 503       orig_callee-&gt;print_name(); tty-&gt;cr();
 504     }
 505     return;
 506   }
 507   assert(holder_klass-&gt;is_loaded(), &quot;&quot;);
 508   //assert((bc_callee-&gt;is_static() || is_invokedynamic) == !has_receiver , &quot;must match bc&quot;);  // XXX invokehandle (cur_bc_raw)
 509   // Note: this takes into account invokeinterface of methods declared in java/lang/Object,
 510   // which should be invokevirtuals but according to the VM spec may be invokeinterfaces
 511   assert(holder_klass-&gt;is_interface() || holder_klass-&gt;super() == NULL || (bc() != Bytecodes::_invokeinterface), &quot;must match bc&quot;);
 512   // Note:  In the absence of miranda methods, an abstract class K can perform
 513   // an invokevirtual directly on an interface method I.m if K implements I.
 514 
 515   // orig_callee is the resolved callee which&#39;s signature includes the
 516   // appendix argument.
 517   const int nargs = orig_callee-&gt;arg_size();
 518   const bool is_signature_polymorphic = MethodHandles::is_signature_polymorphic(orig_callee-&gt;intrinsic_id());
 519 
 520   // Push appendix argument (MethodType, CallSite, etc.), if one.
 521   if (iter().has_appendix()) {
 522     ciObject* appendix_arg = iter().get_appendix();
 523     const TypeOopPtr* appendix_arg_type = TypeOopPtr::make_from_constant(appendix_arg, /* require_const= */ true);
 524     Node* appendix_arg_node = _gvn.makecon(appendix_arg_type);
 525     push(appendix_arg_node);
 526   }
 527 
 528   // ---------------------
 529   // Does Class Hierarchy Analysis reveal only a single target of a v-call?
 530   // Then we may inline or make a static call, but become dependent on there being only 1 target.
 531   // Does the call-site type profile reveal only one receiver?
 532   // Then we may introduce a run-time check and inline on the path where it succeeds.
 533   // The other path may uncommon_trap, check for another receiver, or do a v-call.
 534 
 535   // Try to get the most accurate receiver type
 536   ciMethod* callee             = orig_callee;
 537   int       vtable_index       = Method::invalid_vtable_index;
 538   bool      call_does_dispatch = false;
 539 
 540   // Speculative type of the receiver if any
 541   ciKlass* speculative_receiver_type = NULL;
 542   if (is_virtual_or_interface) {
 543     Node* receiver_node             = stack(sp() - nargs);
 544     const TypeOopPtr* receiver_type = NULL;
 545     if (receiver_node-&gt;is_InlineType()) {
 546       receiver_type = TypeInstPtr::make(TypePtr::NotNull, _gvn.type(receiver_node)-&gt;inline_klass());
 547     } else {
 548       receiver_type = _gvn.type(receiver_node)-&gt;isa_oopptr();
 549     }
 550     // call_does_dispatch and vtable_index are out-parameters.  They might be changed.
 551     // For arrays, klass below is Object. When vtable calls are used,
 552     // resolving the call with Object would allow an illegal call to
 553     // finalize() on an array. We use holder instead: illegal calls to
 554     // finalize() won&#39;t be compiled as vtable calls (IC call
 555     // resolution will catch the illegal call) and the few legal calls
 556     // on array types won&#39;t be either.
 557     callee = C-&gt;optimize_virtual_call(method(), bci(), klass, holder, orig_callee,
 558                                       receiver_type, is_virtual,
 559                                       call_does_dispatch, vtable_index);  // out-parameters
 560     speculative_receiver_type = receiver_type != NULL ? receiver_type-&gt;speculative_type() : NULL;
 561   }
 562 
 563   // Additional receiver subtype checks for interface calls via invokespecial or invokeinterface.
 564   ciKlass* receiver_constraint = NULL;
 565   if (iter().cur_bc_raw() == Bytecodes::_invokespecial &amp;&amp; !orig_callee-&gt;is_object_constructor()) {
 566     ciInstanceKlass* calling_klass = method()-&gt;holder();
 567     ciInstanceKlass* sender_klass =
 568         calling_klass-&gt;is_unsafe_anonymous() ? calling_klass-&gt;unsafe_anonymous_host() :
 569                                                calling_klass;
 570     if (sender_klass-&gt;is_interface()) {
 571       receiver_constraint = sender_klass;
 572     }
 573   } else if (iter().cur_bc_raw() == Bytecodes::_invokeinterface &amp;&amp; orig_callee-&gt;is_private()) {
 574     assert(holder-&gt;is_interface(), &quot;How did we get a non-interface method here!&quot;);
 575     receiver_constraint = holder;
 576   }
 577 
 578   if (receiver_constraint != NULL) {
 579     Node* receiver_node = stack(sp() - nargs);
 580     Node* cls_node = makecon(TypeKlassPtr::make(receiver_constraint));
 581     Node* bad_type_ctrl = NULL;
 582     Node* casted_receiver = gen_checkcast(receiver_node, cls_node, &amp;bad_type_ctrl);
 583     if (bad_type_ctrl != NULL) {
 584       PreserveJVMState pjvms(this);
 585       set_control(bad_type_ctrl);
 586       uncommon_trap(Deoptimization::Reason_class_check,
 587                     Deoptimization::Action_none);
 588     }
 589     if (stopped()) {
 590       return; // MUST uncommon-trap?
 591     }
 592     set_stack(sp() - nargs, casted_receiver);
 593   }
 594 
 595   // Note:  It&#39;s OK to try to inline a virtual call.
 596   // The call generator will not attempt to inline a polymorphic call
 597   // unless it knows how to optimize the receiver dispatch.
 598   bool try_inline = (C-&gt;do_inlining() || InlineAccessors);
 599 
 600   // ---------------------
 601   dec_sp(nargs);              // Temporarily pop args for JVM state of call
 602   JVMState* jvms = sync_jvms();
 603 
 604   // ---------------------
 605   // Decide call tactic.
 606   // This call checks with CHA, the interpreter profile, intrinsics table, etc.
 607   // It decides whether inlining is desirable or not.
 608   CallGenerator* cg = C-&gt;call_generator(callee, vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type);
 609 
 610   // NOTE:  Don&#39;t use orig_callee and callee after this point!  Use cg-&gt;method() instead.
 611   orig_callee = callee = NULL;
 612 
 613   // ---------------------
 614   // Round double arguments before call
 615   round_double_arguments(cg-&gt;method());
 616 
 617   // Feed profiling data for arguments to the type system so it can
 618   // propagate it as speculative types
 619   record_profiled_arguments_for_speculation(cg-&gt;method(), bc());
 620 
 621 #ifndef PRODUCT
 622   // bump global counters for calls
 623   count_compiled_calls(/*at_method_entry*/ false, cg-&gt;is_inline());
 624 
 625   // Record first part of parsing work for this call
 626   parse_histogram()-&gt;record_change();
 627 #endif // not PRODUCT
 628 
 629   assert(jvms == this-&gt;jvms(), &quot;still operating on the right JVMS&quot;);
 630   assert(jvms_in_sync(),       &quot;jvms must carry full info into CG&quot;);
 631 
 632   // save across call, for a subsequent cast_not_null.
 633   Node* receiver = has_receiver ? argument(0) : NULL;
 634 
 635   // The extra CheckCastPPs for speculative types mess with PhaseStringOpts
 636   if (receiver != NULL &amp;&amp; !receiver-&gt;is_InlineType() &amp;&amp; !call_does_dispatch &amp;&amp; !cg-&gt;is_string_late_inline()) {
 637     // Feed profiling data for a single receiver to the type system so
 638     // it can propagate it as a speculative type
 639     receiver = record_profiled_receiver_for_speculation(receiver);
 640   }
 641 
 642   // Bump method data counters (We profile *before* the call is made
 643   // because exceptions don&#39;t return to the call site.)
 644   profile_call(receiver);
 645 
 646   JVMState* new_jvms = cg-&gt;generate(jvms);
 647   if (new_jvms == NULL) {
 648     // When inlining attempt fails (e.g., too many arguments),
 649     // it may contaminate the current compile state, making it
 650     // impossible to pull back and try again.  Once we call
 651     // cg-&gt;generate(), we are committed.  If it fails, the whole
 652     // compilation task is compromised.
 653     if (failing())  return;
 654 
 655     // This can happen if a library intrinsic is available, but refuses
 656     // the call site, perhaps because it did not match a pattern the
 657     // intrinsic was expecting to optimize. Should always be possible to
 658     // get a normal java call that may inline in that case
 659     cg = C-&gt;call_generator(cg-&gt;method(), vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type, /* allow_intrinsics= */ false);
 660     new_jvms = cg-&gt;generate(jvms);
 661     if (new_jvms == NULL) {
 662       guarantee(failing(), &quot;call failed to generate:  calls should work&quot;);
 663       return;
 664     }
 665   }
 666 
 667   if (cg-&gt;is_inline()) {
 668     // Accumulate has_loops estimate
 669     C-&gt;set_has_loops(C-&gt;has_loops() || cg-&gt;method()-&gt;has_loops());
 670     C-&gt;env()-&gt;notice_inlined_method(cg-&gt;method());
 671   }
 672 
 673   // Reset parser state from [new_]jvms, which now carries results of the call.
 674   // Return value (if any) is already pushed on the stack by the cg.
 675   add_exception_states_from(new_jvms);
 676   if (new_jvms-&gt;map()-&gt;control() == top()) {
 677     stop_and_kill_map();
 678   } else {
 679     assert(new_jvms-&gt;same_calls_as(jvms), &quot;method/bci left unchanged&quot;);
 680     set_jvms(new_jvms);
 681   }
 682 
 683   assert(check_call_consistency(jvms, cg), &quot;inconsistent info&quot;);
 684 
 685   if (!stopped()) {
 686     // This was some sort of virtual call, which did a null check for us.
 687     // Now we can assert receiver-not-null, on the normal return path.
 688     if (receiver != NULL &amp;&amp; cg-&gt;is_virtual()) {
 689       Node* cast = cast_not_null(receiver);
 690       // %%% assert(receiver == cast, &quot;should already have cast the receiver&quot;);
 691     }
 692 
 693     // Round double result after a call from strict to non-strict code
 694     round_double_result(cg-&gt;method());
 695 
 696     ciType* rtype = cg-&gt;method()-&gt;return_type();
 697     ciType* ctype = declared_signature-&gt;return_type();
 698 
 699     if (Bytecodes::has_optional_appendix(iter().cur_bc_raw()) || is_signature_polymorphic) {
 700       // Be careful here with return types.
 701       if (ctype != rtype) {
 702         BasicType rt = rtype-&gt;basic_type();
 703         BasicType ct = ctype-&gt;basic_type();
 704         if (ct == T_VOID) {
 705           // It&#39;s OK for a method to return a value that is discarded.
 706           // The discarding does not require any special action from the caller.
 707           // The Java code knows this, at VerifyType.isNullConversion.
 708           pop_node(rt);  // whatever it was, pop it
 709         } else if (rt == T_INT || is_subword_type(rt)) {
 710           // Nothing.  These cases are handled in lambda form bytecode.
 711           assert(ct == T_INT || is_subword_type(ct), &quot;must match: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 712         } else if (is_reference_type(rt)) {
 713           assert(is_reference_type(ct), &quot;rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 714           if (ctype-&gt;is_loaded()) {
 715             const TypeOopPtr* arg_type = TypeOopPtr::make_from_klass(rtype-&gt;as_klass());
 716             const Type*       sig_type = TypeOopPtr::make_from_klass(ctype-&gt;as_klass());
 717             if (ct == T_INLINE_TYPE) {
 718               sig_type = sig_type-&gt;join_speculative(TypePtr::NOTNULL);
 719             }
 720             if (arg_type != NULL &amp;&amp; !arg_type-&gt;higher_equal(sig_type) &amp;&amp; !peek()-&gt;is_InlineType()) {
 721               Node* retnode = pop();
 722               Node* cast_obj = _gvn.transform(new CheckCastPPNode(control(), retnode, sig_type));
 723               push(cast_obj);
 724             }
 725           }
 726         } else {
 727           assert(rt == ct, &quot;unexpected mismatch: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 728           // push a zero; it&#39;s better than getting an oop/int mismatch
 729           pop_node(rt);
 730           Node* retnode = zerocon(ct);
 731           push_node(ct, retnode);
 732         }
 733         // Now that the value is well-behaved, continue with the call-site type.
 734         rtype = ctype;
 735       }
 736     } else {
 737       // Symbolic resolution enforces the types to be the same.
 738       // NOTE: We must relax the assert for unloaded types because two
 739       // different ciType instances of the same unloaded class type
 740       // can appear to be &quot;loaded&quot; by different loaders (depending on
 741       // the accessing class).
 742       assert(!rtype-&gt;is_loaded() || !ctype-&gt;is_loaded() || rtype == ctype,
 743              &quot;mismatched return types: rtype=%s, ctype=%s&quot;, rtype-&gt;name(), ctype-&gt;name());
 744     }
 745 
 746     if (rtype-&gt;basic_type() == T_INLINE_TYPE &amp;&amp; !peek()-&gt;is_InlineType()) {
 747       Node* retnode = pop();
 748       assert(!gvn().type(retnode)-&gt;maybe_null(), &quot;should never be null&quot;);
 749       if (rtype-&gt;as_inline_klass()-&gt;is_scalarizable()) {
 750         retnode = InlineTypeNode::make_from_oop(this, retnode, rtype-&gt;as_inline_klass());
 751       }
 752       push_node(T_INLINE_TYPE, retnode);
 753     }
 754 
 755     // If the return type of the method is not loaded, assert that the
 756     // value we got is a null.  Otherwise, we need to recompile.
 757     if (!rtype-&gt;is_loaded()) {
 758       if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 759         method()-&gt;print_name(); tty-&gt;print_cr(&quot; asserting nullness of result at bci: %d&quot;, bci());
 760         cg-&gt;method()-&gt;print_name(); tty-&gt;cr();
 761       }
 762       if (C-&gt;log() != NULL) {
 763         C-&gt;log()-&gt;elem(&quot;assert_null reason=&#39;return&#39; klass=&#39;%d&#39;&quot;,
 764                        C-&gt;log()-&gt;identify(rtype));
 765       }
 766       // If there is going to be a trap, put it at the next bytecode:
 767       set_bci(iter().next_bci());
 768       null_assert(peek());
 769       set_bci(iter().cur_bci()); // put it back
 770     }
 771     BasicType ct = ctype-&gt;basic_type();
 772     if (is_reference_type(ct)) {
 773       record_profiled_return_for_speculation();
 774     }
 775   }
 776 
 777   // Restart record of parsing work after possible inlining of call
 778 #ifndef PRODUCT
 779   parse_histogram()-&gt;set_initial_state(bc());
 780 #endif
 781 }
 782 
 783 //---------------------------catch_call_exceptions-----------------------------
 784 // Put a Catch and CatchProj nodes behind a just-created call.
 785 // Send their caught exceptions to the proper handler.
 786 // This may be used after a call to the rethrow VM stub,
 787 // when it is needed to process unloaded exception classes.
 788 void Parse::catch_call_exceptions(ciExceptionHandlerStream&amp; handlers) {
 789   // Exceptions are delivered through this channel:
 790   Node* i_o = this-&gt;i_o();
 791 
 792   // Add a CatchNode.
 793   GrowableArray&lt;int&gt;* bcis = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, -1);
 794   GrowableArray&lt;const Type*&gt;* extypes = new (C-&gt;node_arena()) GrowableArray&lt;const Type*&gt;(C-&gt;node_arena(), 8, 0, NULL);
 795   GrowableArray&lt;int&gt;* saw_unloaded = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, 0);
 796 
 797   bool default_handler = false;
 798   for (; !handlers.is_done(); handlers.next()) {
 799     ciExceptionHandler* h        = handlers.handler();
 800     int                 h_bci    = h-&gt;handler_bci();
 801     ciInstanceKlass*    h_klass  = h-&gt;is_catch_all() ? env()-&gt;Throwable_klass() : h-&gt;catch_klass();
 802     // Do not introduce unloaded exception types into the graph:
 803     if (!h_klass-&gt;is_loaded()) {
 804       if (saw_unloaded-&gt;contains(h_bci)) {
 805         /* We&#39;ve already seen an unloaded exception with h_bci,
 806            so don&#39;t duplicate. Duplication will cause the CatchNode to be
 807            unnecessarily large. See 4713716. */
 808         continue;
 809       } else {
 810         saw_unloaded-&gt;append(h_bci);
 811       }
 812     }
 813     const Type*         h_extype = TypeOopPtr::make_from_klass(h_klass);
 814     // (We use make_from_klass because it respects UseUniqueSubclasses.)
 815     h_extype = h_extype-&gt;join(TypeInstPtr::NOTNULL);
 816     assert(!h_extype-&gt;empty(), &quot;sanity&quot;);
 817     // Note:  It&#39;s OK if the BCIs repeat themselves.
 818     bcis-&gt;append(h_bci);
 819     extypes-&gt;append(h_extype);
 820     if (h_bci == -1) {
 821       default_handler = true;
 822     }
 823   }
 824 
 825   if (!default_handler) {
 826     bcis-&gt;append(-1);
 827     extypes-&gt;append(TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr());
 828   }
 829 
 830   int len = bcis-&gt;length();
 831   CatchNode *cn = new CatchNode(control(), i_o, len+1);
 832   Node *catch_ = _gvn.transform(cn);
 833 
 834   // now branch with the exception state to each of the (potential)
 835   // handlers
 836   for(int i=0; i &lt; len; i++) {
 837     // Setup JVM state to enter the handler.
 838     PreserveJVMState pjvms(this);
 839     // Locals are just copied from before the call.
 840     // Get control from the CatchNode.
 841     int handler_bci = bcis-&gt;at(i);
 842     Node* ctrl = _gvn.transform( new CatchProjNode(catch_, i+1,handler_bci));
 843     // This handler cannot happen?
 844     if (ctrl == top())  continue;
 845     set_control(ctrl);
 846 
 847     // Create exception oop
 848     const TypeInstPtr* extype = extypes-&gt;at(i)-&gt;is_instptr();
 849     Node *ex_oop = _gvn.transform(new CreateExNode(extypes-&gt;at(i), ctrl, i_o));
 850 
 851     // Handle unloaded exception classes.
 852     if (saw_unloaded-&gt;contains(handler_bci)) {
 853       // An unloaded exception type is coming here.  Do an uncommon trap.
 854 #ifndef PRODUCT
 855       // We do not expect the same handler bci to take both cold unloaded
 856       // and hot loaded exceptions.  But, watch for it.
 857       if ((Verbose || WizardMode) &amp;&amp; extype-&gt;is_loaded()) {
 858         tty-&gt;print(&quot;Warning: Handler @%d takes mixed loaded/unloaded exceptions in &quot;, bci());
 859         method()-&gt;print_name(); tty-&gt;cr();
 860       } else if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 861         tty-&gt;print(&quot;Bailing out on unloaded exception type &quot;);
 862         extype-&gt;klass()-&gt;print_name();
 863         tty-&gt;print(&quot; at bci:%d in &quot;, bci());
 864         method()-&gt;print_name(); tty-&gt;cr();
 865       }
 866 #endif
 867       // Emit an uncommon trap instead of processing the block.
 868       set_bci(handler_bci);
 869       push_ex_oop(ex_oop);
 870       uncommon_trap(Deoptimization::Reason_unloaded,
 871                     Deoptimization::Action_reinterpret,
 872                     extype-&gt;klass(), &quot;!loaded exception&quot;);
 873       set_bci(iter().cur_bci()); // put it back
 874       continue;
 875     }
 876 
 877     // go to the exception handler
 878     if (handler_bci &lt; 0) {     // merge with corresponding rethrow node
 879       throw_to_exit(make_exception_state(ex_oop));
 880     } else {                      // Else jump to corresponding handle
 881       push_ex_oop(ex_oop);        // Clear stack and push just the oop.
 882       merge_exception(handler_bci);
 883     }
 884   }
 885 
 886   // The first CatchProj is for the normal return.
 887   // (Note:  If this is a call to rethrow_Java, this node goes dead.)
 888   set_control(_gvn.transform( new CatchProjNode(catch_, CatchProjNode::fall_through_index, CatchProjNode::no_handler_bci)));
 889 }
 890 
 891 
 892 //----------------------------catch_inline_exceptions--------------------------
 893 // Handle all exceptions thrown by an inlined method or individual bytecode.
 894 // Common case 1: we have no handler, so all exceptions merge right into
 895 // the rethrow case.
 896 // Case 2: we have some handlers, with loaded exception klasses that have
 897 // no subklasses.  We do a Deutsch-Shiffman style type-check on the incoming
 898 // exception oop and branch to the handler directly.
 899 // Case 3: We have some handlers with subklasses or are not loaded at
 900 // compile-time.  We have to call the runtime to resolve the exception.
 901 // So we insert a RethrowCall and all the logic that goes with it.
 902 void Parse::catch_inline_exceptions(SafePointNode* ex_map) {
 903   // Caller is responsible for saving away the map for normal control flow!
 904   assert(stopped(), &quot;call set_map(NULL) first&quot;);
 905   assert(method()-&gt;has_exception_handlers(), &quot;don&#39;t come here w/o work to do&quot;);
 906 
 907   Node* ex_node = saved_ex_oop(ex_map);
 908   if (ex_node == top()) {
 909     // No action needed.
 910     return;
 911   }
 912   const TypeInstPtr* ex_type = _gvn.type(ex_node)-&gt;isa_instptr();
 913   NOT_PRODUCT(if (ex_type==NULL) tty-&gt;print_cr(&quot;*** Exception not InstPtr&quot;));
 914   if (ex_type == NULL)
 915     ex_type = TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr();
 916 
 917   // determine potential exception handlers
 918   ciExceptionHandlerStream handlers(method(), bci(),
 919                                     ex_type-&gt;klass()-&gt;as_instance_klass(),
 920                                     ex_type-&gt;klass_is_exact());
 921 
 922   // Start executing from the given throw state.  (Keep its stack, for now.)
 923   // Get the exception oop as known at compile time.
 924   ex_node = use_exception_state(ex_map);
 925 
 926   // Get the exception oop klass from its header
 927   Node* ex_klass_node = NULL;
 928   if (has_ex_handler() &amp;&amp; !ex_type-&gt;klass_is_exact()) {
 929     Node* p = basic_plus_adr( ex_node, ex_node, oopDesc::klass_offset_in_bytes());
 930     ex_klass_node = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 931 
 932     // Compute the exception klass a little more cleverly.
 933     // Obvious solution is to simple do a LoadKlass from the &#39;ex_node&#39;.
 934     // However, if the ex_node is a PhiNode, I&#39;m going to do a LoadKlass for
 935     // each arm of the Phi.  If I know something clever about the exceptions
 936     // I&#39;m loading the class from, I can replace the LoadKlass with the
 937     // klass constant for the exception oop.
 938     if (ex_node-&gt;is_Phi()) {
 939       ex_klass_node = new PhiNode(ex_node-&gt;in(0), TypeKlassPtr::OBJECT);
 940       for (uint i = 1; i &lt; ex_node-&gt;req(); i++) {
 941         Node* ex_in = ex_node-&gt;in(i);
 942         if (ex_in == top() || ex_in == NULL) {
 943           // This path was not taken.
 944           ex_klass_node-&gt;init_req(i, top());
 945           continue;
 946         }
 947         Node* p = basic_plus_adr(ex_in, ex_in, oopDesc::klass_offset_in_bytes());
 948         Node* k = _gvn.transform( LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 949         ex_klass_node-&gt;init_req( i, k );
 950       }
 951       _gvn.set_type(ex_klass_node, TypeKlassPtr::OBJECT);
 952 
 953     }
 954   }
 955 
 956   // Scan the exception table for applicable handlers.
 957   // If none, we can call rethrow() and be done!
 958   // If precise (loaded with no subklasses), insert a D.S. style
 959   // pointer compare to the correct handler and loop back.
 960   // If imprecise, switch to the Rethrow VM-call style handling.
 961 
 962   int remaining = handlers.count_remaining();
 963 
 964   // iterate through all entries sequentially
 965   for (;!handlers.is_done(); handlers.next()) {
 966     ciExceptionHandler* handler = handlers.handler();
 967 
 968     if (handler-&gt;is_rethrow()) {
 969       // If we fell off the end of the table without finding an imprecise
 970       // exception klass (and without finding a generic handler) then we
 971       // know this exception is not handled in this method.  We just rethrow
 972       // the exception into the caller.
 973       throw_to_exit(make_exception_state(ex_node));
 974       return;
 975     }
 976 
 977     // exception handler bci range covers throw_bci =&gt; investigate further
 978     int handler_bci = handler-&gt;handler_bci();
 979 
 980     if (remaining == 1) {
 981       push_ex_oop(ex_node);        // Push exception oop for handler
 982       if (PrintOpto &amp;&amp; WizardMode) {
 983         tty-&gt;print_cr(&quot;  Catching every inline exception bci:%d -&gt; handler_bci:%d&quot;, bci(), handler_bci);
 984       }
 985       merge_exception(handler_bci); // jump to handler
 986       return;                   // No more handling to be done here!
 987     }
 988 
 989     // Get the handler&#39;s klass
 990     ciInstanceKlass* klass = handler-&gt;catch_klass();
 991 
 992     if (!klass-&gt;is_loaded()) {  // klass is not loaded?
 993       // fall through into catch_call_exceptions which will emit a
 994       // handler with an uncommon trap.
 995       break;
 996     }
 997 
 998     if (klass-&gt;is_interface())  // should not happen, but...
 999       break;                    // bail out
1000 
1001     // Check the type of the exception against the catch type
1002     const TypeKlassPtr *tk = TypeKlassPtr::make(klass);
1003     Node* con = _gvn.makecon(tk);
1004     Node* not_subtype_ctrl = gen_subtype_check(ex_klass_node, con);
1005     if (!stopped()) {
1006       PreserveJVMState pjvms(this);
1007       const TypeInstPtr* tinst = TypeOopPtr::make_from_klass_unique(klass)-&gt;cast_to_ptr_type(TypePtr::NotNull)-&gt;is_instptr();
1008       assert(klass-&gt;has_subklass() || tinst-&gt;klass_is_exact(), &quot;lost exactness&quot;);
1009       Node* ex_oop = _gvn.transform(new CheckCastPPNode(control(), ex_node, tinst));
1010       push_ex_oop(ex_oop);      // Push exception oop for handler
1011       if (PrintOpto &amp;&amp; WizardMode) {
1012         tty-&gt;print(&quot;  Catching inline exception bci:%d -&gt; handler_bci:%d -- &quot;, bci(), handler_bci);
1013         klass-&gt;print_name();
1014         tty-&gt;cr();
1015       }
1016       merge_exception(handler_bci);
1017     }
1018     set_control(not_subtype_ctrl);
1019 
1020     // Come here if exception does not match handler.
1021     // Carry on with more handler checks.
1022     --remaining;
1023   }
1024 
1025   assert(!stopped(), &quot;you should return if you finish the chain&quot;);
1026 
1027   // Oops, need to call into the VM to resolve the klasses at runtime.
1028   // Note:  This call must not deoptimize, since it is not a real at this bci!
1029   kill_dead_locals();
1030 
1031   make_runtime_call(RC_NO_LEAF | RC_MUST_THROW,
1032                     OptoRuntime::rethrow_Type(),
1033                     OptoRuntime::rethrow_stub(),
1034                     NULL, NULL,
1035                     ex_node);
1036 
1037   // Rethrow is a pure call, no side effects, only a result.
1038   // The result cannot be allocated, so we use I_O
1039 
1040   // Catch exceptions from the rethrow
1041   catch_call_exceptions(handlers);
1042 }
1043 
1044 
1045 // (Note:  Moved add_debug_info into GraphKit::add_safepoint_edges.)
1046 
1047 
1048 #ifndef PRODUCT
1049 void Parse::count_compiled_calls(bool at_method_entry, bool is_inline) {
1050   if( CountCompiledCalls ) {
1051     if( at_method_entry ) {
1052       // bump invocation counter if top method (for statistics)
1053       if (CountCompiledCalls &amp;&amp; depth() == 1) {
1054         const TypePtr* addr_type = TypeMetadataPtr::make(method());
1055         Node* adr1 = makecon(addr_type);
1056         Node* adr2 = basic_plus_adr(adr1, adr1, in_bytes(Method::compiled_invocation_counter_offset()));
1057         increment_counter(adr2);
1058       }
1059     } else if (is_inline) {
1060       switch (bc()) {
1061       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_inlined_calls_addr()); break;
1062       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_inlined_interface_calls_addr()); break;
1063       case Bytecodes::_invokestatic:
1064       case Bytecodes::_invokedynamic:
1065       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_inlined_static_calls_addr()); break;
1066       default: fatal(&quot;unexpected call bytecode&quot;);
1067       }
1068     } else {
1069       switch (bc()) {
1070       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_normal_calls_addr()); break;
1071       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_interface_calls_addr()); break;
1072       case Bytecodes::_invokestatic:
1073       case Bytecodes::_invokedynamic:
1074       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_static_calls_addr()); break;
1075       default: fatal(&quot;unexpected call bytecode&quot;);
1076       }
1077     }
1078   }
1079 }
1080 #endif //PRODUCT
1081 
1082 
1083 ciMethod* Compile::optimize_virtual_call(ciMethod* caller, int bci, ciInstanceKlass* klass,
1084                                          ciKlass* holder, ciMethod* callee,
1085                                          const TypeOopPtr* receiver_type, bool is_virtual,
1086                                          bool&amp; call_does_dispatch, int&amp; vtable_index,
1087                                          bool check_access) {
1088   // Set default values for out-parameters.
1089   call_does_dispatch = true;
1090   vtable_index       = Method::invalid_vtable_index;
1091 
1092   // Choose call strategy.
1093   ciMethod* optimized_virtual_method = optimize_inlining(caller, bci, klass, callee,
1094                                                          receiver_type, check_access);
1095 
1096   // Have the call been sufficiently improved such that it is no longer a virtual?
1097   if (optimized_virtual_method != NULL) {
1098     callee             = optimized_virtual_method;
1099     call_does_dispatch = false;
1100   } else if (!UseInlineCaches &amp;&amp; is_virtual &amp;&amp; callee-&gt;is_loaded()) {
1101     // We can make a vtable call at this site
1102     vtable_index = callee-&gt;resolve_vtable_index(caller-&gt;holder(), holder);
1103   }
1104   return callee;
1105 }
1106 
1107 // Identify possible target method and inlining style
1108 ciMethod* Compile::optimize_inlining(ciMethod* caller, int bci, ciInstanceKlass* klass,
1109                                      ciMethod* callee, const TypeOopPtr* receiver_type,
1110                                      bool check_access) {
1111   // only use for virtual or interface calls
1112 
1113   // If it is obviously final, do not bother to call find_monomorphic_target,
1114   // because the class hierarchy checks are not needed, and may fail due to
1115   // incompletely loaded classes.  Since we do our own class loading checks
1116   // in this module, we may confidently bind to any method.
1117   if (callee-&gt;can_be_statically_bound()) {
1118     return callee;
1119   }
1120 
1121   // Attempt to improve the receiver
1122   bool actual_receiver_is_exact = false;
1123   ciInstanceKlass* actual_receiver = klass;
1124   if (receiver_type != NULL) {
1125     // Array methods are all inherited from Object, and are monomorphic.
1126     // finalize() call on array is not allowed.
1127     if (receiver_type-&gt;isa_aryptr() &amp;&amp;
1128         callee-&gt;holder() == env()-&gt;Object_klass() &amp;&amp;
1129         callee-&gt;name() != ciSymbol::finalize_method_name()) {
1130       return callee;
1131     }
1132 
1133     // All other interesting cases are instance klasses.
1134     if (!receiver_type-&gt;isa_instptr()) {
1135       return NULL;
1136     }
1137 
1138     ciInstanceKlass *ikl = receiver_type-&gt;klass()-&gt;as_instance_klass();
1139     if (ikl-&gt;is_loaded() &amp;&amp; ikl-&gt;is_initialized() &amp;&amp; !ikl-&gt;is_interface() &amp;&amp;
1140         (ikl == actual_receiver || ikl-&gt;is_subtype_of(actual_receiver))) {
1141       // ikl is a same or better type than the original actual_receiver,
1142       // e.g. static receiver from bytecodes.
1143       actual_receiver = ikl;
1144       // Is the actual_receiver exact?
1145       actual_receiver_is_exact = receiver_type-&gt;klass_is_exact();
1146     }
1147   }
1148 
1149   ciInstanceKlass*   calling_klass = caller-&gt;holder();
1150   ciMethod* cha_monomorphic_target = callee-&gt;find_monomorphic_target(calling_klass, klass, actual_receiver, check_access);
1151   if (cha_monomorphic_target != NULL) {
1152     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1153     // Look at the method-receiver type.  Does it add &quot;too much information&quot;?
1154     ciKlass*    mr_klass = cha_monomorphic_target-&gt;holder();
1155     const Type* mr_type  = TypeInstPtr::make(TypePtr::BotPTR, mr_klass);
1156     if (receiver_type == NULL || !receiver_type-&gt;higher_equal(mr_type)) {
1157       // Calling this method would include an implicit cast to its holder.
1158       // %%% Not yet implemented.  Would throw minor asserts at present.
1159       // %%% The most common wins are already gained by +UseUniqueSubclasses.
1160       // To fix, put the higher_equal check at the call of this routine,
1161       // and add a CheckCastPP to the receiver.
1162       if (TraceDependencies) {
1163         tty-&gt;print_cr(&quot;found unique CHA method, but could not cast up&quot;);
1164         tty-&gt;print(&quot;  method  = &quot;);
1165         cha_monomorphic_target-&gt;print();
1166         tty-&gt;cr();
1167       }
1168       if (log() != NULL) {
1169         log()-&gt;elem(&quot;missed_CHA_opportunity klass=&#39;%d&#39; method=&#39;%d&#39;&quot;,
1170                        log()-&gt;identify(klass),
1171                        log()-&gt;identify(cha_monomorphic_target));
1172       }
1173       cha_monomorphic_target = NULL;
1174     }
1175   }
1176 
1177   if (cha_monomorphic_target != NULL) {
1178     // Hardwiring a virtual.
1179     assert(!callee-&gt;can_be_statically_bound(), &quot;should have been handled earlier&quot;);
1180     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1181     if (!cha_monomorphic_target-&gt;can_be_statically_bound(actual_receiver)) {
1182       // If we inlined because CHA revealed only a single target method,
1183       // then we are dependent on that target method not getting overridden
1184       // by dynamic class loading.  Be sure to test the &quot;static&quot; receiver
1185       // dest_method here, as opposed to the actual receiver, which may
1186       // falsely lead us to believe that the receiver is final or private.
1187       dependencies()-&gt;assert_unique_concrete_method(actual_receiver, cha_monomorphic_target);
1188     }
1189     return cha_monomorphic_target;
1190   }
1191 
1192   // If the type is exact, we can still bind the method w/o a vcall.
1193   // (This case comes after CHA so we can see how much extra work it does.)
1194   if (actual_receiver_is_exact) {
1195     // In case of evolution, there is a dependence on every inlined method, since each
1196     // such method can be changed when its class is redefined.
1197     ciMethod* exact_method = callee-&gt;resolve_invoke(calling_klass, actual_receiver);
1198     if (exact_method != NULL) {
1199       if (PrintOpto) {
1200         tty-&gt;print(&quot;  Calling method via exact type @%d --- &quot;, bci);
1201         exact_method-&gt;print_name();
1202         tty-&gt;cr();
1203       }
1204       return exact_method;
1205     }
1206   }
1207 
1208   return NULL;
1209 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>