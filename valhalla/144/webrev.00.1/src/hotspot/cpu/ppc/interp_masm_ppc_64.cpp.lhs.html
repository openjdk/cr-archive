<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/ppc/interp_masm_ppc_64.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * Copyright (c) 2012, 2020 SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 
  27 #include &quot;precompiled.hpp&quot;
  28 #include &quot;asm/macroAssembler.inline.hpp&quot;
  29 #include &quot;gc/shared/barrierSet.hpp&quot;
  30 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  31 #include &quot;interp_masm_ppc.hpp&quot;
  32 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  33 #include &quot;oops/methodData.hpp&quot;
  34 #include &quot;prims/jvmtiThreadState.hpp&quot;
  35 #include &quot;runtime/frame.inline.hpp&quot;
  36 #include &quot;runtime/safepointMechanism.hpp&quot;
  37 #include &quot;runtime/sharedRuntime.hpp&quot;
  38 #include &quot;utilities/powerOfTwo.hpp&quot;
  39 
  40 // Implementation of InterpreterMacroAssembler.
  41 
  42 // This file specializes the assembler with interpreter-specific macros.
  43 
  44 #ifdef PRODUCT
  45 #define BLOCK_COMMENT(str) // nothing
  46 #else
  47 #define BLOCK_COMMENT(str) block_comment(str)
  48 #endif
  49 
  50 void InterpreterMacroAssembler::null_check_throw(Register a, int offset, Register temp_reg) {
  51   address exception_entry = Interpreter::throw_NullPointerException_entry();
  52   MacroAssembler::null_check_throw(a, offset, temp_reg, exception_entry);
  53 }
  54 
  55 void InterpreterMacroAssembler::jump_to_entry(address entry, Register Rscratch) {
  56   assert(entry, &quot;Entry must have been generated by now&quot;);
  57   if (is_within_range_of_b(entry, pc())) {
  58     b(entry);
  59   } else {
  60     load_const_optimized(Rscratch, entry, R0);
  61     mtctr(Rscratch);
  62     bctr();
  63   }
  64 }
  65 
  66 void InterpreterMacroAssembler::dispatch_next(TosState state, int bcp_incr, bool generate_poll) {
  67   Register bytecode = R12_scratch2;
  68   if (bcp_incr != 0) {
  69     lbzu(bytecode, bcp_incr, R14_bcp);
  70   } else {
  71     lbz(bytecode, 0, R14_bcp);
  72   }
  73 
  74   dispatch_Lbyte_code(state, bytecode, Interpreter::dispatch_table(state), generate_poll);
  75 }
  76 
  77 void InterpreterMacroAssembler::dispatch_via(TosState state, address* table) {
  78   // Load current bytecode.
  79   Register bytecode = R12_scratch2;
  80   lbz(bytecode, 0, R14_bcp);
  81   dispatch_Lbyte_code(state, bytecode, table);
  82 }
  83 
  84 // Dispatch code executed in the prolog of a bytecode which does not do it&#39;s
  85 // own dispatch. The dispatch address is computed and placed in R24_dispatch_addr.
  86 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int bcp_incr) {
  87   Register bytecode = R12_scratch2;
  88   lbz(bytecode, bcp_incr, R14_bcp);
  89 
  90   load_dispatch_table(R24_dispatch_addr, Interpreter::dispatch_table(state));
  91 
  92   sldi(bytecode, bytecode, LogBytesPerWord);
  93   ldx(R24_dispatch_addr, R24_dispatch_addr, bytecode);
  94 }
  95 
  96 // Dispatch code executed in the epilog of a bytecode which does not do it&#39;s
  97 // own dispatch. The dispatch address in R24_dispatch_addr is used for the
  98 // dispatch.
  99 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int bcp_incr) {
 100   if (bcp_incr) { addi(R14_bcp, R14_bcp, bcp_incr); }
 101   mtctr(R24_dispatch_addr);
 102   bcctr(bcondAlways, 0, bhintbhBCCTRisNotPredictable);
 103 }
 104 
 105 void InterpreterMacroAssembler::check_and_handle_popframe(Register scratch_reg) {
 106   assert(scratch_reg != R0, &quot;can&#39;t use R0 as scratch_reg here&quot;);
 107   if (JvmtiExport::can_pop_frame()) {
 108     Label L;
 109 
 110     // Check the &quot;pending popframe condition&quot; flag in the current thread.
 111     lwz(scratch_reg, in_bytes(JavaThread::popframe_condition_offset()), R16_thread);
 112 
 113     // Initiate popframe handling only if it is not already being
 114     // processed. If the flag has the popframe_processing bit set, it
 115     // means that this code is called *during* popframe handling - we
 116     // don&#39;t want to reenter.
 117     andi_(R0, scratch_reg, JavaThread::popframe_pending_bit);
 118     beq(CCR0, L);
 119 
 120     andi_(R0, scratch_reg, JavaThread::popframe_processing_bit);
 121     bne(CCR0, L);
 122 
 123     // Call the Interpreter::remove_activation_preserving_args_entry()
 124     // func to get the address of the same-named entrypoint in the
 125     // generated interpreter code.
 126 #if defined(ABI_ELFv2)
 127     call_c(CAST_FROM_FN_PTR(address,
 128                             Interpreter::remove_activation_preserving_args_entry),
 129            relocInfo::none);
 130 #else
 131     call_c(CAST_FROM_FN_PTR(FunctionDescriptor*,
 132                             Interpreter::remove_activation_preserving_args_entry),
 133            relocInfo::none);
 134 #endif
 135 
 136     // Jump to Interpreter::_remove_activation_preserving_args_entry.
 137     mtctr(R3_RET);
 138     bctr();
 139 
 140     align(32, 12);
 141     bind(L);
 142   }
 143 }
 144 
 145 void InterpreterMacroAssembler::check_and_handle_earlyret(Register scratch_reg) {
 146   const Register Rthr_state_addr = scratch_reg;
 147   if (JvmtiExport::can_force_early_return()) {
 148     Label Lno_early_ret;
 149     ld(Rthr_state_addr, in_bytes(JavaThread::jvmti_thread_state_offset()), R16_thread);
 150     cmpdi(CCR0, Rthr_state_addr, 0);
 151     beq(CCR0, Lno_early_ret);
 152 
 153     lwz(R0, in_bytes(JvmtiThreadState::earlyret_state_offset()), Rthr_state_addr);
 154     cmpwi(CCR0, R0, JvmtiThreadState::earlyret_pending);
 155     bne(CCR0, Lno_early_ret);
 156 
 157     // Jump to Interpreter::_earlyret_entry.
 158     lwz(R3_ARG1, in_bytes(JvmtiThreadState::earlyret_tos_offset()), Rthr_state_addr);
 159     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry));
 160     mtlr(R3_RET);
 161     blr();
 162 
 163     align(32, 12);
 164     bind(Lno_early_ret);
 165   }
 166 }
 167 
 168 void InterpreterMacroAssembler::load_earlyret_value(TosState state, Register Rscratch1) {
 169   const Register RjvmtiState = Rscratch1;
 170   const Register Rscratch2   = R0;
 171 
 172   ld(RjvmtiState, in_bytes(JavaThread::jvmti_thread_state_offset()), R16_thread);
 173   li(Rscratch2, 0);
 174 
 175   switch (state) {
 176     case atos: ld(R17_tos, in_bytes(JvmtiThreadState::earlyret_oop_offset()), RjvmtiState);
 177                std(Rscratch2, in_bytes(JvmtiThreadState::earlyret_oop_offset()), RjvmtiState);
 178                break;
 179     case ltos: ld(R17_tos, in_bytes(JvmtiThreadState::earlyret_value_offset()), RjvmtiState);
 180                break;
 181     case btos: // fall through
 182     case ztos: // fall through
 183     case ctos: // fall through
 184     case stos: // fall through
 185     case itos: lwz(R17_tos, in_bytes(JvmtiThreadState::earlyret_value_offset()), RjvmtiState);
 186                break;
 187     case ftos: lfs(F15_ftos, in_bytes(JvmtiThreadState::earlyret_value_offset()), RjvmtiState);
 188                break;
 189     case dtos: lfd(F15_ftos, in_bytes(JvmtiThreadState::earlyret_value_offset()), RjvmtiState);
 190                break;
 191     case vtos: break;
 192     default  : ShouldNotReachHere();
 193   }
 194 
 195   // Clean up tos value in the jvmti thread state.
 196   std(Rscratch2, in_bytes(JvmtiThreadState::earlyret_value_offset()), RjvmtiState);
 197   // Set tos state field to illegal value.
 198   li(Rscratch2, ilgl);
 199   stw(Rscratch2, in_bytes(JvmtiThreadState::earlyret_tos_offset()), RjvmtiState);
 200 }
 201 
 202 // Common code to dispatch and dispatch_only.
 203 // Dispatch value in Lbyte_code and increment Lbcp.
 204 
 205 void InterpreterMacroAssembler::load_dispatch_table(Register dst, address* table) {
 206   address table_base = (address)Interpreter::dispatch_table((TosState)0);
 207   intptr_t table_offs = (intptr_t)table - (intptr_t)table_base;
 208   if (is_simm16(table_offs)) {
 209     addi(dst, R25_templateTableBase, (int)table_offs);
 210   } else {
 211     load_const_optimized(dst, table, R0);
 212   }
 213 }
 214 
 215 void InterpreterMacroAssembler::dispatch_Lbyte_code(TosState state, Register bytecode,
 216                                                     address* table, bool generate_poll) {
 217   assert_different_registers(bytecode, R11_scratch1);
 218 
 219   // Calc dispatch table address.
 220   load_dispatch_table(R11_scratch1, table);
 221 
 222   if (generate_poll) {
 223     address *sfpt_tbl = Interpreter::safept_table(state);
 224     if (table != sfpt_tbl) {
 225       Label dispatch;
 226       ld(R0, in_bytes(Thread::polling_page_offset()), R16_thread);
 227       // Armed page has poll_bit set, if poll bit is cleared just continue.
 228       andi_(R0, R0, SafepointMechanism::poll_bit());
 229       beq(CCR0, dispatch);
 230       load_dispatch_table(R11_scratch1, sfpt_tbl);
 231       align(32, 16);
 232       bind(dispatch);
 233     }
 234   }
 235 
 236   sldi(R12_scratch2, bytecode, LogBytesPerWord);
 237   ldx(R11_scratch1, R11_scratch1, R12_scratch2);
 238 
 239   // Jump off!
 240   mtctr(R11_scratch1);
 241   bcctr(bcondAlways, 0, bhintbhBCCTRisNotPredictable);
 242 }
 243 
 244 void InterpreterMacroAssembler::load_receiver(Register Rparam_count, Register Rrecv_dst) {
 245   sldi(Rrecv_dst, Rparam_count, Interpreter::logStackElementSize);
 246   ldx(Rrecv_dst, Rrecv_dst, R15_esp);
 247 }
 248 
 249 // helpers for expression stack
 250 
 251 void InterpreterMacroAssembler::pop_i(Register r) {
 252   lwzu(r, Interpreter::stackElementSize, R15_esp);
 253 }
 254 
 255 void InterpreterMacroAssembler::pop_ptr(Register r) {
 256   ldu(r, Interpreter::stackElementSize, R15_esp);
 257 }
 258 
 259 void InterpreterMacroAssembler::pop_l(Register r) {
 260   ld(r, Interpreter::stackElementSize, R15_esp);
 261   addi(R15_esp, R15_esp, 2 * Interpreter::stackElementSize);
 262 }
 263 
 264 void InterpreterMacroAssembler::pop_f(FloatRegister f) {
 265   lfsu(f, Interpreter::stackElementSize, R15_esp);
 266 }
 267 
 268 void InterpreterMacroAssembler::pop_d(FloatRegister f) {
 269   lfd(f, Interpreter::stackElementSize, R15_esp);
 270   addi(R15_esp, R15_esp, 2 * Interpreter::stackElementSize);
 271 }
 272 
 273 void InterpreterMacroAssembler::push_i(Register r) {
 274   stw(r, 0, R15_esp);
 275   addi(R15_esp, R15_esp, - Interpreter::stackElementSize );
 276 }
 277 
 278 void InterpreterMacroAssembler::push_ptr(Register r) {
 279   std(r, 0, R15_esp);
 280   addi(R15_esp, R15_esp, - Interpreter::stackElementSize );
 281 }
 282 
 283 void InterpreterMacroAssembler::push_l(Register r) {
 284   // Clear unused slot.
 285   load_const_optimized(R0, 0L);
 286   std(R0, 0, R15_esp);
 287   std(r, - Interpreter::stackElementSize, R15_esp);
 288   addi(R15_esp, R15_esp, - 2 * Interpreter::stackElementSize );
 289 }
 290 
 291 void InterpreterMacroAssembler::push_f(FloatRegister f) {
 292   stfs(f, 0, R15_esp);
 293   addi(R15_esp, R15_esp, - Interpreter::stackElementSize );
 294 }
 295 
 296 void InterpreterMacroAssembler::push_d(FloatRegister f)   {
 297   stfd(f, - Interpreter::stackElementSize, R15_esp);
 298   addi(R15_esp, R15_esp, - 2 * Interpreter::stackElementSize );
 299 }
 300 
 301 void InterpreterMacroAssembler::push_2ptrs(Register first, Register second) {
 302   std(first, 0, R15_esp);
 303   std(second, -Interpreter::stackElementSize, R15_esp);
 304   addi(R15_esp, R15_esp, - 2 * Interpreter::stackElementSize );
 305 }
 306 
 307 void InterpreterMacroAssembler::move_l_to_d(Register l, FloatRegister d) {
 308   if (VM_Version::has_mtfprd()) {
 309     mtfprd(d, l);
 310   } else {
 311     std(l, 0, R15_esp);
 312     lfd(d, 0, R15_esp);
 313   }
 314 }
 315 
 316 void InterpreterMacroAssembler::move_d_to_l(FloatRegister d, Register l) {
 317   if (VM_Version::has_mtfprd()) {
 318     mffprd(l, d);
 319   } else {
 320     stfd(d, 0, R15_esp);
 321     ld(l, 0, R15_esp);
 322   }
 323 }
 324 
 325 void InterpreterMacroAssembler::push(TosState state) {
 326   switch (state) {
 327     case atos: push_ptr();                break;
 328     case btos:
 329     case ztos:
 330     case ctos:
 331     case stos:
 332     case itos: push_i();                  break;
 333     case ltos: push_l();                  break;
 334     case ftos: push_f();                  break;
 335     case dtos: push_d();                  break;
 336     case vtos: /* nothing to do */        break;
 337     default  : ShouldNotReachHere();
 338   }
 339 }
 340 
 341 void InterpreterMacroAssembler::pop(TosState state) {
 342   switch (state) {
 343     case atos: pop_ptr();            break;
 344     case btos:
 345     case ztos:
 346     case ctos:
 347     case stos:
 348     case itos: pop_i();              break;
 349     case ltos: pop_l();              break;
 350     case ftos: pop_f();              break;
 351     case dtos: pop_d();              break;
 352     case vtos: /* nothing to do */   break;
 353     default  : ShouldNotReachHere();
 354   }
 355   verify_oop(R17_tos, state);
 356 }
 357 
 358 void InterpreterMacroAssembler::empty_expression_stack() {
 359   addi(R15_esp, R26_monitor, - Interpreter::stackElementSize);
 360 }
 361 
 362 void InterpreterMacroAssembler::get_2_byte_integer_at_bcp(int         bcp_offset,
 363                                                           Register    Rdst,
 364                                                           signedOrNot is_signed) {
 365 #if defined(VM_LITTLE_ENDIAN)
 366   if (bcp_offset) {
 367     load_const_optimized(Rdst, bcp_offset);
 368     lhbrx(Rdst, R14_bcp, Rdst);
 369   } else {
 370     lhbrx(Rdst, R14_bcp);
 371   }
 372   if (is_signed == Signed) {
 373     extsh(Rdst, Rdst);
 374   }
 375 #else
 376   // Read Java big endian format.
 377   if (is_signed == Signed) {
 378     lha(Rdst, bcp_offset, R14_bcp);
 379   } else {
 380     lhz(Rdst, bcp_offset, R14_bcp);
 381   }
 382 #endif
 383 }
 384 
 385 void InterpreterMacroAssembler::get_4_byte_integer_at_bcp(int         bcp_offset,
 386                                                           Register    Rdst,
 387                                                           signedOrNot is_signed) {
 388 #if defined(VM_LITTLE_ENDIAN)
 389   if (bcp_offset) {
 390     load_const_optimized(Rdst, bcp_offset);
 391     lwbrx(Rdst, R14_bcp, Rdst);
 392   } else {
 393     lwbrx(Rdst, R14_bcp);
 394   }
 395   if (is_signed == Signed) {
 396     extsw(Rdst, Rdst);
 397   }
 398 #else
 399   // Read Java big endian format.
 400   if (bcp_offset &amp; 3) { // Offset unaligned?
 401     load_const_optimized(Rdst, bcp_offset);
 402     if (is_signed == Signed) {
 403       lwax(Rdst, R14_bcp, Rdst);
 404     } else {
 405       lwzx(Rdst, R14_bcp, Rdst);
 406     }
 407   } else {
 408     if (is_signed == Signed) {
 409       lwa(Rdst, bcp_offset, R14_bcp);
 410     } else {
 411       lwz(Rdst, bcp_offset, R14_bcp);
 412     }
 413   }
 414 #endif
 415 }
 416 
 417 
 418 // Load the constant pool cache index from the bytecode stream.
 419 //
 420 // Kills / writes:
 421 //   - Rdst, Rscratch
 422 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register Rdst, int bcp_offset,
 423                                                        size_t index_size) {
 424   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 425   // Cache index is always in the native format, courtesy of Rewriter.
 426   if (index_size == sizeof(u2)) {
 427     lhz(Rdst, bcp_offset, R14_bcp);
 428   } else if (index_size == sizeof(u4)) {
 429     if (bcp_offset &amp; 3) {
 430       load_const_optimized(Rdst, bcp_offset);
 431       lwax(Rdst, R14_bcp, Rdst);
 432     } else {
 433       lwa(Rdst, bcp_offset, R14_bcp);
 434     }
 435     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 436     nand(Rdst, Rdst, Rdst); // convert to plain index
 437   } else if (index_size == sizeof(u1)) {
 438     lbz(Rdst, bcp_offset, R14_bcp);
 439   } else {
 440     ShouldNotReachHere();
 441   }
 442   // Rdst now contains cp cache index.
 443 }
 444 
 445 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache, int bcp_offset,
 446                                                            size_t index_size) {
 447   get_cache_index_at_bcp(cache, bcp_offset, index_size);
 448   sldi(cache, cache, exact_log2(in_words(ConstantPoolCacheEntry::size()) * BytesPerWord));
 449   add(cache, R27_constPoolCache, cache);
 450 }
 451 
 452 // Load 4-byte signed or unsigned integer in Java format (that is, big-endian format)
 453 // from (Rsrc)+offset.
 454 void InterpreterMacroAssembler::get_u4(Register Rdst, Register Rsrc, int offset,
 455                                        signedOrNot is_signed) {
 456 #if defined(VM_LITTLE_ENDIAN)
 457   if (offset) {
 458     load_const_optimized(Rdst, offset);
 459     lwbrx(Rdst, Rdst, Rsrc);
 460   } else {
 461     lwbrx(Rdst, Rsrc);
 462   }
 463   if (is_signed == Signed) {
 464     extsw(Rdst, Rdst);
 465   }
 466 #else
 467   if (is_signed == Signed) {
 468     lwa(Rdst, offset, Rsrc);
 469   } else {
 470     lwz(Rdst, offset, Rsrc);
 471   }
 472 #endif
 473 }
 474 
 475 // Load object from cpool-&gt;resolved_references(index).
 476 void InterpreterMacroAssembler::load_resolved_reference_at_index(Register result, Register index, Label *L_handle_null) {
 477   assert_different_registers(result, index);
 478   get_constant_pool(result);
 479 
 480   // Convert from field index to resolved_references() index and from
 481   // word index to byte offset. Since this is a java object, it can be compressed.
 482   Register tmp = index;  // reuse
 483   sldi(tmp, index, LogBytesPerHeapOop);
 484   // Load pointer for resolved_references[] objArray.
 485   ld(result, ConstantPool::cache_offset_in_bytes(), result);
 486   ld(result, ConstantPoolCache::resolved_references_offset_in_bytes(), result);
 487   resolve_oop_handle(result);
 488 #ifdef ASSERT
 489   Label index_ok;
 490   lwa(R0, arrayOopDesc::length_offset_in_bytes(), result);
 491   sldi(R0, R0, LogBytesPerHeapOop);
 492   cmpd(CCR0, tmp, R0);
 493   blt(CCR0, index_ok);
 494   stop(&quot;resolved reference index out of bounds&quot;);
 495   bind(index_ok);
 496 #endif
 497   // Add in the index.
 498   add(result, tmp, result);
 499   load_heap_oop(result, arrayOopDesc::base_offset_in_bytes(T_OBJECT), result, tmp, R0, false, 0, L_handle_null);
 500 }
 501 
 502 // load cpool-&gt;resolved_klass_at(index)
 503 void InterpreterMacroAssembler::load_resolved_klass_at_offset(Register Rcpool, Register Roffset, Register Rklass) {
 504   // int value = *(Rcpool-&gt;int_at_addr(which));
 505   // int resolved_klass_index = extract_low_short_from_int(value);
 506   add(Roffset, Rcpool, Roffset);
 507 #if defined(VM_LITTLE_ENDIAN)
 508   lhz(Roffset, sizeof(ConstantPool), Roffset);     // Roffset = resolved_klass_index
 509 #else
 510   lhz(Roffset, sizeof(ConstantPool) + 2, Roffset); // Roffset = resolved_klass_index
 511 #endif
 512 
 513   ld(Rklass, ConstantPool::resolved_klasses_offset_in_bytes(), Rcpool); // Rklass = Rcpool-&gt;_resolved_klasses
 514 
 515   sldi(Roffset, Roffset, LogBytesPerWord);
 516   addi(Roffset, Roffset, Array&lt;Klass*&gt;::base_offset_in_bytes());
 517   isync(); // Order load of instance Klass wrt. tags.
 518   ldx(Rklass, Rklass, Roffset);
 519 }
 520 
 521 void InterpreterMacroAssembler::load_resolved_method_at_index(int byte_no,
 522                                                               Register cache,
 523                                                               Register method) {
 524   const int method_offset = in_bytes(
 525     ConstantPoolCache::base_offset() +
 526       ((byte_no == TemplateTable::f2_byte)
 527        ? ConstantPoolCacheEntry::f2_offset()
 528        : ConstantPoolCacheEntry::f1_offset()));
 529 
 530   ld(method, method_offset, cache); // get f1 Method*
 531 }
 532 
 533 // Generate a subtype check: branch to ok_is_subtype if sub_klass is
 534 // a subtype of super_klass. Blows registers Rsub_klass, tmp1, tmp2.
 535 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass, Register Rsuper_klass, Register Rtmp1,
 536                                                   Register Rtmp2, Register Rtmp3, Label &amp;ok_is_subtype) {
 537   // Profile the not-null value&#39;s klass.
 538   profile_typecheck(Rsub_klass, Rtmp1, Rtmp2);
 539   check_klass_subtype(Rsub_klass, Rsuper_klass, Rtmp1, Rtmp2, ok_is_subtype);
 540   profile_typecheck_failed(Rtmp1, Rtmp2);
 541 }
 542 
 543 // Separate these two to allow for delay slot in middle.
 544 // These are used to do a test and full jump to exception-throwing code.
 545 
 546 // Check that index is in range for array, then shift index by index_shift,
 547 // and put arrayOop + shifted_index into res.
 548 // Note: res is still shy of address by array offset into object.
 549 
 550 void InterpreterMacroAssembler::index_check_without_pop(Register Rarray, Register Rindex,
 551                                                         int index_shift, Register Rtmp, Register Rres) {
 552   // Check that index is in range for array, then shift index by index_shift,
 553   // and put arrayOop + shifted_index into res.
 554   // Note: res is still shy of address by array offset into object.
 555   // Kills:
 556   //   - Rindex
 557   // Writes:
 558   //   - Rres: Address that corresponds to the array index if check was successful.
 559   verify_oop(Rarray);
 560   const Register Rlength   = R0;
 561   const Register RsxtIndex = Rtmp;
 562   Label LisNull, LnotOOR;
 563 
 564   // Array nullcheck
 565   if (!ImplicitNullChecks) {
 566     cmpdi(CCR0, Rarray, 0);
 567     beq(CCR0, LisNull);
 568   } else {
 569     null_check_throw(Rarray, arrayOopDesc::length_offset_in_bytes(), /*temp*/RsxtIndex);
 570   }
 571 
 572   // Rindex might contain garbage in upper bits (remember that we don&#39;t sign extend
 573   // during integer arithmetic operations). So kill them and put value into same register
 574   // where ArrayIndexOutOfBounds would expect the index in.
 575   rldicl(RsxtIndex, Rindex, 0, 32); // zero extend 32 bit -&gt; 64 bit
 576 
 577   // Index check
 578   lwz(Rlength, arrayOopDesc::length_offset_in_bytes(), Rarray);
 579   cmplw(CCR0, Rindex, Rlength);
 580   sldi(RsxtIndex, RsxtIndex, index_shift);
 581   blt(CCR0, LnotOOR);
 582   // Index should be in R17_tos, array should be in R4_ARG2.
 583   mr_if_needed(R17_tos, Rindex);
 584   mr_if_needed(R4_ARG2, Rarray);
 585   load_dispatch_table(Rtmp, (address*)Interpreter::_throw_ArrayIndexOutOfBoundsException_entry);
 586   mtctr(Rtmp);
 587   bctr();
 588 
 589   if (!ImplicitNullChecks) {
 590     bind(LisNull);
 591     load_dispatch_table(Rtmp, (address*)Interpreter::_throw_NullPointerException_entry);
 592     mtctr(Rtmp);
 593     bctr();
 594   }
 595 
 596   align(32, 16);
 597   bind(LnotOOR);
 598 
 599   // Calc address
 600   add(Rres, RsxtIndex, Rarray);
 601 }
 602 
 603 void InterpreterMacroAssembler::index_check(Register array, Register index,
 604                                             int index_shift, Register tmp, Register res) {
 605   // pop array
 606   pop_ptr(array);
 607 
 608   // check array
 609   index_check_without_pop(array, index, index_shift, tmp, res);
 610 }
 611 
 612 void InterpreterMacroAssembler::get_const(Register Rdst) {
 613   ld(Rdst, in_bytes(Method::const_offset()), R19_method);
 614 }
 615 
 616 void InterpreterMacroAssembler::get_constant_pool(Register Rdst) {
 617   get_const(Rdst);
 618   ld(Rdst, in_bytes(ConstMethod::constants_offset()), Rdst);
 619 }
 620 
 621 void InterpreterMacroAssembler::get_constant_pool_cache(Register Rdst) {
 622   get_constant_pool(Rdst);
 623   ld(Rdst, ConstantPool::cache_offset_in_bytes(), Rdst);
 624 }
 625 
 626 void InterpreterMacroAssembler::get_cpool_and_tags(Register Rcpool, Register Rtags) {
 627   get_constant_pool(Rcpool);
 628   ld(Rtags, ConstantPool::tags_offset_in_bytes(), Rcpool);
 629 }
 630 
 631 // Unlock if synchronized method.
 632 //
 633 // Unlock the receiver if this is a synchronized method.
 634 // Unlock any Java monitors from synchronized blocks.
 635 //
 636 // If there are locked Java monitors
 637 //   If throw_monitor_exception
 638 //     throws IllegalMonitorStateException
 639 //   Else if install_monitor_exception
 640 //     installs IllegalMonitorStateException
 641 //   Else
 642 //     no error processing
 643 void InterpreterMacroAssembler::unlock_if_synchronized_method(TosState state,
 644                                                               bool throw_monitor_exception,
 645                                                               bool install_monitor_exception) {
 646   Label Lunlocked, Lno_unlock;
 647   {
 648     Register Rdo_not_unlock_flag = R11_scratch1;
 649     Register Raccess_flags       = R12_scratch2;
 650 
 651     // Check if synchronized method or unlocking prevented by
 652     // JavaThread::do_not_unlock_if_synchronized flag.
 653     lbz(Rdo_not_unlock_flag, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread);
 654     lwz(Raccess_flags, in_bytes(Method::access_flags_offset()), R19_method);
 655     li(R0, 0);
 656     stb(R0, in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()), R16_thread); // reset flag
 657 
 658     push(state);
 659 
 660     // Skip if we don&#39;t have to unlock.
 661     rldicl_(R0, Raccess_flags, 64-JVM_ACC_SYNCHRONIZED_BIT, 63); // Extract bit and compare to 0.
 662     beq(CCR0, Lunlocked);
 663 
 664     cmpwi(CCR0, Rdo_not_unlock_flag, 0);
 665     bne(CCR0, Lno_unlock);
 666   }
 667 
 668   // Unlock
 669   {
 670     Register Rmonitor_base = R11_scratch1;
 671 
 672     Label Lunlock;
 673     // If it&#39;s still locked, everything is ok, unlock it.
 674     ld(Rmonitor_base, 0, R1_SP);
 675     addi(Rmonitor_base, Rmonitor_base,
 676          -(frame::ijava_state_size + frame::interpreter_frame_monitor_size_in_bytes())); // Monitor base
 677 
 678     ld(R0, BasicObjectLock::obj_offset_in_bytes(), Rmonitor_base);
 679     cmpdi(CCR0, R0, 0);
 680     bne(CCR0, Lunlock);
 681 
 682     // If it&#39;s already unlocked, throw exception.
 683     if (throw_monitor_exception) {
 684       call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_illegal_monitor_state_exception));
 685       should_not_reach_here();
 686     } else {
 687       if (install_monitor_exception) {
 688         call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::new_illegal_monitor_state_exception));
 689         b(Lunlocked);
 690       }
 691     }
 692 
 693     bind(Lunlock);
 694     unlock_object(Rmonitor_base);
 695   }
 696 
 697   // Check that all other monitors are unlocked. Throw IllegelMonitorState exception if not.
 698   bind(Lunlocked);
 699   {
 700     Label Lexception, Lrestart;
 701     Register Rcurrent_obj_addr = R11_scratch1;
 702     const int delta = frame::interpreter_frame_monitor_size_in_bytes();
 703     assert((delta &amp; LongAlignmentMask) == 0, &quot;sizeof BasicObjectLock must be even number of doublewords&quot;);
 704 
 705     bind(Lrestart);
 706     // Set up search loop: Calc num of iterations.
 707     {
 708       Register Riterations = R12_scratch2;
 709       Register Rmonitor_base = Rcurrent_obj_addr;
 710       ld(Rmonitor_base, 0, R1_SP);
 711       addi(Rmonitor_base, Rmonitor_base, - frame::ijava_state_size);  // Monitor base
 712 
 713       subf_(Riterations, R26_monitor, Rmonitor_base);
 714       ble(CCR0, Lno_unlock);
 715 
 716       addi(Rcurrent_obj_addr, Rmonitor_base,
 717            BasicObjectLock::obj_offset_in_bytes() - frame::interpreter_frame_monitor_size_in_bytes());
 718       // Check if any monitor is on stack, bail out if not
 719       srdi(Riterations, Riterations, exact_log2(delta));
 720       mtctr(Riterations);
 721     }
 722 
 723     // The search loop: Look for locked monitors.
 724     {
 725       const Register Rcurrent_obj = R0;
 726       Label Lloop;
 727 
 728       ld(Rcurrent_obj, 0, Rcurrent_obj_addr);
 729       addi(Rcurrent_obj_addr, Rcurrent_obj_addr, -delta);
 730       bind(Lloop);
 731 
 732       // Check if current entry is used.
 733       cmpdi(CCR0, Rcurrent_obj, 0);
 734       bne(CCR0, Lexception);
 735       // Preload next iteration&#39;s compare value.
 736       ld(Rcurrent_obj, 0, Rcurrent_obj_addr);
 737       addi(Rcurrent_obj_addr, Rcurrent_obj_addr, -delta);
 738       bdnz(Lloop);
 739     }
 740     // Fell through: Everything&#39;s unlocked =&gt; finish.
 741     b(Lno_unlock);
 742 
 743     // An object is still locked =&gt; need to throw exception.
 744     bind(Lexception);
 745     if (throw_monitor_exception) {
 746       call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_illegal_monitor_state_exception));
 747       should_not_reach_here();
 748     } else {
 749       // Stack unrolling. Unlock object and if requested, install illegal_monitor_exception.
 750       // Unlock does not block, so don&#39;t have to worry about the frame.
 751       Register Rmonitor_addr = R11_scratch1;
 752       addi(Rmonitor_addr, Rcurrent_obj_addr, -BasicObjectLock::obj_offset_in_bytes() + delta);
 753       unlock_object(Rmonitor_addr);
 754       if (install_monitor_exception) {
 755         call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::new_illegal_monitor_state_exception));
 756       }
 757       b(Lrestart);
 758     }
 759   }
 760 
 761   align(32, 12);
 762   bind(Lno_unlock);
 763   pop(state);
 764 }
 765 
 766 // Support function for remove_activation &amp; Co.
 767 void InterpreterMacroAssembler::merge_frames(Register Rsender_sp, Register return_pc,
 768                                              Register Rscratch1, Register Rscratch2) {
 769   // Pop interpreter frame.
 770   ld(Rscratch1, 0, R1_SP); // *SP
 771   ld(Rsender_sp, _ijava_state_neg(sender_sp), Rscratch1); // top_frame_sp
 772   ld(Rscratch2, 0, Rscratch1); // **SP
 773   if (return_pc!=noreg) {
 774     ld(return_pc, _abi(lr), Rscratch1); // LR
 775   }
 776 
 777   // Merge top frames.
 778   subf(Rscratch1, R1_SP, Rsender_sp); // top_frame_sp - SP
 779   stdux(Rscratch2, R1_SP, Rscratch1); // atomically set *(SP = top_frame_sp) = **SP
 780 }
 781 
 782 void InterpreterMacroAssembler::narrow(Register result) {
 783   Register ret_type = R11_scratch1;
 784   ld(R11_scratch1, in_bytes(Method::const_offset()), R19_method);
 785   lbz(ret_type, in_bytes(ConstMethod::result_type_offset()), R11_scratch1);
 786 
 787   Label notBool, notByte, notChar, done;
 788 
 789   // common case first
 790   cmpwi(CCR0, ret_type, T_INT);
 791   beq(CCR0, done);
 792 
 793   cmpwi(CCR0, ret_type, T_BOOLEAN);
 794   bne(CCR0, notBool);
 795   andi(result, result, 0x1);
 796   b(done);
 797 
 798   bind(notBool);
 799   cmpwi(CCR0, ret_type, T_BYTE);
 800   bne(CCR0, notByte);
 801   extsb(result, result);
 802   b(done);
 803 
 804   bind(notByte);
 805   cmpwi(CCR0, ret_type, T_CHAR);
 806   bne(CCR0, notChar);
 807   andi(result, result, 0xffff);
 808   b(done);
 809 
 810   bind(notChar);
 811   // cmpwi(CCR0, ret_type, T_SHORT);  // all that&#39;s left
 812   // bne(CCR0, done);
 813   extsh(result, result);
 814 
 815   // Nothing to do for T_INT
 816   bind(done);
 817 }
 818 
 819 // Remove activation.
 820 //
 821 // Unlock the receiver if this is a synchronized method.
 822 // Unlock any Java monitors from synchronized blocks.
 823 // Remove the activation from the stack.
 824 //
 825 // If there are locked Java monitors
 826 //    If throw_monitor_exception
 827 //       throws IllegalMonitorStateException
 828 //    Else if install_monitor_exception
 829 //       installs IllegalMonitorStateException
 830 //    Else
 831 //       no error processing
 832 void InterpreterMacroAssembler::remove_activation(TosState state,
 833                                                   bool throw_monitor_exception,
 834                                                   bool install_monitor_exception) {
 835   BLOCK_COMMENT(&quot;remove_activation {&quot;);
 836   unlock_if_synchronized_method(state, throw_monitor_exception, install_monitor_exception);
 837 
 838   // Save result (push state before jvmti call and pop it afterwards) and notify jvmti.
 839   notify_method_exit(false, state, NotifyJVMTI, true);
 840 
 841   BLOCK_COMMENT(&quot;reserved_stack_check:&quot;);
 842   if (StackReservedPages &gt; 0) {
 843     // Test if reserved zone needs to be enabled.
 844     Label no_reserved_zone_enabling;
 845 
 846     // Compare frame pointers. There is no good stack pointer, as with stack
 847     // frame compression we can get different SPs when we do calls. A subsequent
 848     // call could have a smaller SP, so that this compare succeeds for an
 849     // inner call of the method annotated with ReservedStack.
 850     ld_ptr(R0, JavaThread::reserved_stack_activation_offset(), R16_thread);
 851     ld_ptr(R11_scratch1, _abi(callers_sp), R1_SP); // Load frame pointer.
 852     cmpld(CCR0, R11_scratch1, R0);
 853     blt_predict_taken(CCR0, no_reserved_zone_enabling);
 854 
 855     // Enable reserved zone again, throw stack overflow exception.
 856     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), R16_thread);
 857     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_delayed_StackOverflowError));
 858 
 859     should_not_reach_here();
 860 
 861     bind(no_reserved_zone_enabling);
 862   }
 863 
 864   verify_oop(R17_tos, state);
 865   verify_thread();
 866 
 867   merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ R0, R11_scratch1, R12_scratch2);
 868   mtlr(R0);
 869   BLOCK_COMMENT(&quot;} remove_activation&quot;);
 870 }
 871 
 872 // Lock object
 873 //
 874 // Registers alive
 875 //   monitor - Address of the BasicObjectLock to be used for locking,
 876 //             which must be initialized with the object to lock.
 877 //   object  - Address of the object to be locked.
 878 //
 879 void InterpreterMacroAssembler::lock_object(Register monitor, Register object) {
 880   if (UseHeavyMonitors) {
 881     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
 882             monitor, /*check_for_exceptions=*/true);
 883   } else {
 884     // template code:
 885     //
 886     // markWord displaced_header = obj-&gt;mark().set_unlocked();
 887     // monitor-&gt;lock()-&gt;set_displaced_header(displaced_header);
 888     // if (Atomic::cmpxchg(/*addr*/obj-&gt;mark_addr(), /*cmp*/displaced_header, /*ex=*/monitor) == displaced_header) {
 889     //   // We stored the monitor address into the object&#39;s mark word.
 890     // } else if (THREAD-&gt;is_lock_owned((address)displaced_header))
 891     //   // Simple recursive case.
 892     //   monitor-&gt;lock()-&gt;set_displaced_header(NULL);
 893     // } else {
 894     //   // Slow path.
 895     //   InterpreterRuntime::monitorenter(THREAD, monitor);
 896     // }
 897 
 898     const Register displaced_header = R7_ARG5;
 899     const Register object_mark_addr = R8_ARG6;
 900     const Register current_header   = R9_ARG7;
 901     const Register tmp              = R10_ARG8;
 902 
 903     Label done;
 904     Label cas_failed, slow_case;
 905 
 906     assert_different_registers(displaced_header, object_mark_addr, current_header, tmp);
 907 
 908     // markWord displaced_header = obj-&gt;mark().set_unlocked();
 909 
 910     // Load markWord from object into displaced_header.
 911     ld(displaced_header, oopDesc::mark_offset_in_bytes(), object);
 912 
 913     if (UseBiasedLocking) {
 914       biased_locking_enter(CCR0, object, displaced_header, tmp, current_header, done, &amp;slow_case);
 915     }
 916 
 917     // Set displaced_header to be (markWord of object | UNLOCK_VALUE).
 918     ori(displaced_header, displaced_header, markWord::unlocked_value);
 919 
 920     // monitor-&gt;lock()-&gt;set_displaced_header(displaced_header);
 921 
 922     // Initialize the box (Must happen before we update the object mark!).
 923     std(displaced_header, BasicObjectLock::lock_offset_in_bytes() +
 924         BasicLock::displaced_header_offset_in_bytes(), monitor);
 925 
 926     // if (Atomic::cmpxchg(/*addr*/obj-&gt;mark_addr(), /*cmp*/displaced_header, /*ex=*/monitor) == displaced_header) {
 927 
 928     // Store stack address of the BasicObjectLock (this is monitor) into object.
 929     addi(object_mark_addr, object, oopDesc::mark_offset_in_bytes());
 930 
 931     // Must fence, otherwise, preceding store(s) may float below cmpxchg.
 932     // CmpxchgX sets CCR0 to cmpX(current, displaced).
 933     cmpxchgd(/*flag=*/CCR0,
 934              /*current_value=*/current_header,
 935              /*compare_value=*/displaced_header, /*exchange_value=*/monitor,
 936              /*where=*/object_mark_addr,
 937              MacroAssembler::MemBarRel | MacroAssembler::MemBarAcq,
 938              MacroAssembler::cmpxchgx_hint_acquire_lock(),
 939              noreg,
 940              &amp;cas_failed,
 941              /*check without membar and ldarx first*/true);
 942 
 943     // If the compare-and-exchange succeeded, then we found an unlocked
 944     // object and we have now locked it.
 945     b(done);
 946     bind(cas_failed);
 947 
 948     // } else if (THREAD-&gt;is_lock_owned((address)displaced_header))
 949     //   // Simple recursive case.
 950     //   monitor-&gt;lock()-&gt;set_displaced_header(NULL);
 951 
 952     // We did not see an unlocked object so try the fast recursive case.
 953 
 954     // Check if owner is self by comparing the value in the markWord of object
 955     // (current_header) with the stack pointer.
 956     sub(current_header, current_header, R1_SP);
 957 
 958     assert(os::vm_page_size() &gt; 0xfff, &quot;page size too small - change the constant&quot;);
 959     load_const_optimized(tmp, ~(os::vm_page_size()-1) | markWord::lock_mask_in_place);
 960 
 961     and_(R0/*==0?*/, current_header, tmp);
 962     // If condition is true we are done and hence we can store 0 in the displaced
 963     // header indicating it is a recursive lock.
 964     bne(CCR0, slow_case);
 965     std(R0/*==0!*/, BasicObjectLock::lock_offset_in_bytes() +
 966         BasicLock::displaced_header_offset_in_bytes(), monitor);
 967     b(done);
 968 
 969     // } else {
 970     //   // Slow path.
 971     //   InterpreterRuntime::monitorenter(THREAD, monitor);
 972 
 973     // None of the above fast optimizations worked so we have to get into the
 974     // slow case of monitor enter.
 975     bind(slow_case);
 976     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
 977             monitor, /*check_for_exceptions=*/true);
 978     // }
 979     align(32, 12);
 980     bind(done);
 981   }
 982 }
 983 
 984 // Unlocks an object. Used in monitorexit bytecode and remove_activation.
 985 //
 986 // Registers alive
 987 //   monitor - Address of the BasicObjectLock to be used for locking,
 988 //             which must be initialized with the object to lock.
 989 //
 990 // Throw IllegalMonitorException if object is not locked by current thread.
 991 void InterpreterMacroAssembler::unlock_object(Register monitor, bool check_for_exceptions) {
 992   if (UseHeavyMonitors) {
 993     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
 994             monitor, check_for_exceptions);
 995   } else {
 996 
 997     // template code:
 998     //
 999     // if ((displaced_header = monitor-&gt;displaced_header()) == NULL) {
1000     //   // Recursive unlock. Mark the monitor unlocked by setting the object field to NULL.
1001     //   monitor-&gt;set_obj(NULL);
1002     // } else if (Atomic::cmpxchg(obj-&gt;mark_addr(), monitor, displaced_header) == monitor) {
1003     //   // We swapped the unlocked mark in displaced_header into the object&#39;s mark word.
1004     //   monitor-&gt;set_obj(NULL);
1005     // } else {
1006     //   // Slow path.
1007     //   InterpreterRuntime::monitorexit(THREAD, monitor);
1008     // }
1009 
1010     const Register object           = R7_ARG5;
1011     const Register displaced_header = R8_ARG6;
1012     const Register object_mark_addr = R9_ARG7;
1013     const Register current_header   = R10_ARG8;
1014 
1015     Label free_slot;
1016     Label slow_case;
1017 
1018     assert_different_registers(object, displaced_header, object_mark_addr, current_header);
1019 
1020     if (UseBiasedLocking) {
1021       // The object address from the monitor is in object.
1022       ld(object, BasicObjectLock::obj_offset_in_bytes(), monitor);
1023       assert(oopDesc::mark_offset_in_bytes() == 0, &quot;offset of _mark is not 0&quot;);
1024       biased_locking_exit(CCR0, object, displaced_header, free_slot);
1025     }
1026 
1027     // Test first if we are in the fast recursive case.
1028     ld(displaced_header, BasicObjectLock::lock_offset_in_bytes() +
1029            BasicLock::displaced_header_offset_in_bytes(), monitor);
1030 
1031     // If the displaced header is zero, we have a recursive unlock.
1032     cmpdi(CCR0, displaced_header, 0);
1033     beq(CCR0, free_slot); // recursive unlock
1034 
1035     // } else if (Atomic::cmpxchg(obj-&gt;mark_addr(), monitor, displaced_header) == monitor) {
1036     //   // We swapped the unlocked mark in displaced_header into the object&#39;s mark word.
1037     //   monitor-&gt;set_obj(NULL);
1038 
1039     // If we still have a lightweight lock, unlock the object and be done.
1040 
1041     // The object address from the monitor is in object.
1042     if (!UseBiasedLocking) { ld(object, BasicObjectLock::obj_offset_in_bytes(), monitor); }
1043     addi(object_mark_addr, object, oopDesc::mark_offset_in_bytes());
1044 
1045     // We have the displaced header in displaced_header. If the lock is still
1046     // lightweight, it will contain the monitor address and we&#39;ll store the
1047     // displaced header back into the object&#39;s mark word.
1048     // CmpxchgX sets CCR0 to cmpX(current, monitor).
1049     cmpxchgd(/*flag=*/CCR0,
1050              /*current_value=*/current_header,
1051              /*compare_value=*/monitor, /*exchange_value=*/displaced_header,
1052              /*where=*/object_mark_addr,
1053              MacroAssembler::MemBarRel,
1054              MacroAssembler::cmpxchgx_hint_release_lock(),
1055              noreg,
1056              &amp;slow_case);
1057     b(free_slot);
1058 
1059     // } else {
1060     //   // Slow path.
1061     //   InterpreterRuntime::monitorexit(THREAD, monitor);
1062 
1063     // The lock has been converted into a heavy lock and hence
1064     // we need to get into the slow case.
1065     bind(slow_case);
1066     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1067             monitor, check_for_exceptions);
1068     // }
1069 
1070     Label done;
1071     b(done); // Monitor register may be overwritten! Runtime has already freed the slot.
1072 
1073     // Exchange worked, do monitor-&gt;set_obj(NULL);
1074     align(32, 12);
1075     bind(free_slot);
1076     li(R0, 0);
1077     std(R0, BasicObjectLock::obj_offset_in_bytes(), monitor);
1078     bind(done);
1079   }
1080 }
1081 
1082 // Load compiled (i2c) or interpreter entry when calling from interpreted and
1083 // do the call. Centralized so that all interpreter calls will do the same actions.
1084 // If jvmti single stepping is on for a thread we must not call compiled code.
1085 //
1086 // Input:
1087 //   - Rtarget_method: method to call
1088 //   - Rret_addr:      return address
1089 //   - 2 scratch regs
1090 //
1091 void InterpreterMacroAssembler::call_from_interpreter(Register Rtarget_method, Register Rret_addr,
1092                                                       Register Rscratch1, Register Rscratch2) {
1093   assert_different_registers(Rscratch1, Rscratch2, Rtarget_method, Rret_addr);
1094   // Assume we want to go compiled if available.
1095   const Register Rtarget_addr = Rscratch1;
1096   const Register Rinterp_only = Rscratch2;
1097 
1098   ld(Rtarget_addr, in_bytes(Method::from_interpreted_offset()), Rtarget_method);
1099 
1100   if (JvmtiExport::can_post_interpreter_events()) {
1101     lwz(Rinterp_only, in_bytes(JavaThread::interp_only_mode_offset()), R16_thread);
1102 
1103     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
1104     // compiled code in threads for which the event is enabled. Check here for
1105     // interp_only_mode if these events CAN be enabled.
1106     Label done;
1107     verify_thread();
1108     cmpwi(CCR0, Rinterp_only, 0);
1109     beq(CCR0, done);
1110     ld(Rtarget_addr, in_bytes(Method::interpreter_entry_offset()), Rtarget_method);
1111     align(32, 12);
1112     bind(done);
1113   }
1114 
1115 #ifdef ASSERT
1116   {
1117     Label Lok;
1118     cmpdi(CCR0, Rtarget_addr, 0);
1119     bne(CCR0, Lok);
1120     stop(&quot;null entry point&quot;);
1121     bind(Lok);
1122   }
1123 #endif // ASSERT
1124 
1125   mr(R21_sender_SP, R1_SP);
1126 
1127   // Calc a precise SP for the call. The SP value we calculated in
1128   // generate_fixed_frame() is based on the max_stack() value, so we would waste stack space
1129   // if esp is not max. Also, the i2c adapter extends the stack space without restoring
1130   // our pre-calced value, so repeating calls via i2c would result in stack overflow.
1131   // Since esp already points to an empty slot, we just have to sub 1 additional slot
1132   // to meet the abi scratch requirements.
1133   // The max_stack pointer will get restored by means of the GR_Lmax_stack local in
1134   // the return entry of the interpreter.
1135   addi(Rscratch2, R15_esp, Interpreter::stackElementSize - frame::abi_reg_args_size);
1136   clrrdi(Rscratch2, Rscratch2, exact_log2(frame::alignment_in_bytes)); // round towards smaller address
1137   resize_frame_absolute(Rscratch2, Rscratch2, R0);
1138 
1139   mr_if_needed(R19_method, Rtarget_method);
1140   mtctr(Rtarget_addr);
1141   mtlr(Rret_addr);
1142 
1143   save_interpreter_state(Rscratch2);
1144 #ifdef ASSERT
1145   ld(Rscratch1, _ijava_state_neg(top_frame_sp), Rscratch2); // Rscratch2 contains fp
1146   cmpd(CCR0, R21_sender_SP, Rscratch1);
1147   asm_assert_eq(&quot;top_frame_sp incorrect&quot;);
1148 #endif
1149 
1150   bctr();
1151 }
1152 
1153 // Set the method data pointer for the current bcp.
1154 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1155   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1156   Label get_continue;
1157   ld(R28_mdx, in_bytes(Method::method_data_offset()), R19_method);
1158   test_method_data_pointer(get_continue);
1159   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), R19_method, R14_bcp);
1160 
1161   addi(R28_mdx, R28_mdx, in_bytes(MethodData::data_offset()));
1162   add(R28_mdx, R28_mdx, R3_RET);
1163   bind(get_continue);
1164 }
1165 
1166 // Test ImethodDataPtr. If it is null, continue at the specified label.
1167 void InterpreterMacroAssembler::test_method_data_pointer(Label&amp; zero_continue) {
1168   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1169   cmpdi(CCR0, R28_mdx, 0);
1170   beq(CCR0, zero_continue);
1171 }
1172 
1173 void InterpreterMacroAssembler::verify_method_data_pointer() {
1174   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1175 #ifdef ASSERT
1176   Label verify_continue;
1177   test_method_data_pointer(verify_continue);
1178 
1179   // If the mdp is valid, it will point to a DataLayout header which is
1180   // consistent with the bcp. The converse is highly probable also.
1181   lhz(R11_scratch1, in_bytes(DataLayout::bci_offset()), R28_mdx);
1182   ld(R12_scratch2, in_bytes(Method::const_offset()), R19_method);
1183   addi(R11_scratch1, R11_scratch1, in_bytes(ConstMethod::codes_offset()));
1184   add(R11_scratch1, R12_scratch2, R12_scratch2);
1185   cmpd(CCR0, R11_scratch1, R14_bcp);
1186   beq(CCR0, verify_continue);
1187 
1188   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp ), R19_method, R14_bcp, R28_mdx);
1189 
1190   bind(verify_continue);
1191 #endif
1192 }
1193 
1194 void InterpreterMacroAssembler::test_invocation_counter_for_mdp(Register invocation_count,
1195                                                                 Register method_counters,
1196                                                                 Register Rscratch,
1197                                                                 Label &amp;profile_continue) {
1198   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1199   // Control will flow to &quot;profile_continue&quot; if the counter is less than the
1200   // limit or if we call profile_method().
1201   Label done;
1202 
1203   // If no method data exists, and the counter is high enough, make one.
1204   lwz(Rscratch, in_bytes(MethodCounters::interpreter_profile_limit_offset()), method_counters);
1205 
1206   cmpdi(CCR0, R28_mdx, 0);
1207   // Test to see if we should create a method data oop.
1208   cmpd(CCR1, Rscratch, invocation_count);
1209   bne(CCR0, done);
1210   bge(CCR1, profile_continue);
1211 
1212   // Build it now.
1213   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1214   set_method_data_pointer_for_bcp();
1215   b(profile_continue);
1216 
1217   align(32, 12);
1218   bind(done);
1219 }
1220 
1221 void InterpreterMacroAssembler::test_backedge_count_for_osr(Register backedge_count, Register method_counters,
1222                                                             Register target_bcp, Register disp, Register Rtmp) {
1223   assert_different_registers(backedge_count, target_bcp, disp, Rtmp, R4_ARG2);
1224   assert(UseOnStackReplacement,&quot;Must UseOnStackReplacement to test_backedge_count_for_osr&quot;);
1225 
1226   Label did_not_overflow;
1227   Label overflow_with_error;
1228 
1229   lwz(Rtmp, in_bytes(MethodCounters::interpreter_backward_branch_limit_offset()), method_counters);
1230   cmpw(CCR0, backedge_count, Rtmp);
1231 
1232   blt(CCR0, did_not_overflow);
1233 
1234   // When ProfileInterpreter is on, the backedge_count comes from the
1235   // methodDataOop, which value does not get reset on the call to
1236   // frequency_counter_overflow(). To avoid excessive calls to the overflow
1237   // routine while the method is being compiled, add a second test to make sure
1238   // the overflow function is called only once every overflow_frequency.
1239   if (ProfileInterpreter) {
1240     const int overflow_frequency = 1024;
1241     andi_(Rtmp, backedge_count, overflow_frequency-1);
1242     bne(CCR0, did_not_overflow);
1243   }
1244 
1245   // Overflow in loop, pass branch bytecode.
1246   subf(R4_ARG2, disp, target_bcp); // Compute branch bytecode (previous bcp).
1247   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::frequency_counter_overflow), R4_ARG2, true);
1248 
1249   // Was an OSR adapter generated?
1250   cmpdi(CCR0, R3_RET, 0);
1251   beq(CCR0, overflow_with_error);
1252 
1253   // Has the nmethod been invalidated already?
1254   lbz(Rtmp, nmethod::state_offset(), R3_RET);
1255   cmpwi(CCR0, Rtmp, nmethod::in_use);
1256   bne(CCR0, overflow_with_error);
1257 
1258   // Migrate the interpreter frame off of the stack.
1259   // We can use all registers because we will not return to interpreter from this point.
1260 
1261   // Save nmethod.
1262   const Register osr_nmethod = R31;
1263   mr(osr_nmethod, R3_RET);
1264   set_top_ijava_frame_at_SP_as_last_Java_frame(R1_SP, R11_scratch1);
1265   call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::OSR_migration_begin), R16_thread);
1266   reset_last_Java_frame();
1267   // OSR buffer is in ARG1
1268 
1269   // Remove the interpreter frame.
1270   merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ R0, R11_scratch1, R12_scratch2);
1271 
1272   // Jump to the osr code.
1273   ld(R11_scratch1, nmethod::osr_entry_point_offset(), osr_nmethod);
1274   mtlr(R0);
1275   mtctr(R11_scratch1);
1276   bctr();
1277 
1278   align(32, 12);
1279   bind(overflow_with_error);
1280   bind(did_not_overflow);
1281 }
1282 
1283 // Store a value at some constant offset from the method data pointer.
1284 void InterpreterMacroAssembler::set_mdp_data_at(int constant, Register value) {
1285   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1286 
1287   std(value, constant, R28_mdx);
1288 }
1289 
1290 // Increment the value at some constant offset from the method data pointer.
1291 void InterpreterMacroAssembler::increment_mdp_data_at(int constant,
1292                                                       Register counter_addr,
1293                                                       Register Rbumped_count,
1294                                                       bool decrement) {
1295   // Locate the counter at a fixed offset from the mdp:
1296   addi(counter_addr, R28_mdx, constant);
1297   increment_mdp_data_at(counter_addr, Rbumped_count, decrement);
1298 }
1299 
1300 // Increment the value at some non-fixed (reg + constant) offset from
1301 // the method data pointer.
1302 void InterpreterMacroAssembler::increment_mdp_data_at(Register reg,
1303                                                       int constant,
1304                                                       Register scratch,
1305                                                       Register Rbumped_count,
1306                                                       bool decrement) {
1307   // Add the constant to reg to get the offset.
1308   add(scratch, R28_mdx, reg);
1309   // Then calculate the counter address.
1310   addi(scratch, scratch, constant);
1311   increment_mdp_data_at(scratch, Rbumped_count, decrement);
1312 }
1313 
1314 void InterpreterMacroAssembler::increment_mdp_data_at(Register counter_addr,
1315                                                       Register Rbumped_count,
1316                                                       bool decrement) {
1317   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1318 
1319   // Load the counter.
1320   ld(Rbumped_count, 0, counter_addr);
1321 
1322   if (decrement) {
1323     // Decrement the register. Set condition codes.
1324     addi(Rbumped_count, Rbumped_count, - DataLayout::counter_increment);
1325     // Store the decremented counter, if it is still negative.
1326     std(Rbumped_count, 0, counter_addr);
1327     // Note: add/sub overflow check are not ported, since 64 bit
1328     // calculation should never overflow.
1329   } else {
1330     // Increment the register. Set carry flag.
1331     addi(Rbumped_count, Rbumped_count, DataLayout::counter_increment);
1332     // Store the incremented counter.
1333     std(Rbumped_count, 0, counter_addr);
1334   }
1335 }
1336 
1337 // Set a flag value at the current method data pointer position.
1338 void InterpreterMacroAssembler::set_mdp_flag_at(int flag_constant,
1339                                                 Register scratch) {
1340   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1341   // Load the data header.
1342   lbz(scratch, in_bytes(DataLayout::flags_offset()), R28_mdx);
1343   // Set the flag.
1344   ori(scratch, scratch, flag_constant);
1345   // Store the modified header.
1346   stb(scratch, in_bytes(DataLayout::flags_offset()), R28_mdx);
1347 }
1348 
1349 // Test the location at some offset from the method data pointer.
1350 // If it is not equal to value, branch to the not_equal_continue Label.
1351 void InterpreterMacroAssembler::test_mdp_data_at(int offset,
1352                                                  Register value,
1353                                                  Label&amp; not_equal_continue,
1354                                                  Register test_out) {
1355   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1356 
1357   ld(test_out, offset, R28_mdx);
1358   cmpd(CCR0,  value, test_out);
1359   bne(CCR0, not_equal_continue);
1360 }
1361 
1362 // Update the method data pointer by the displacement located at some fixed
1363 // offset from the method data pointer.
1364 void InterpreterMacroAssembler::update_mdp_by_offset(int offset_of_disp,
1365                                                      Register scratch) {
1366   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1367 
1368   ld(scratch, offset_of_disp, R28_mdx);
1369   add(R28_mdx, scratch, R28_mdx);
1370 }
1371 
1372 // Update the method data pointer by the displacement located at the
1373 // offset (reg + offset_of_disp).
1374 void InterpreterMacroAssembler::update_mdp_by_offset(Register reg,
1375                                                      int offset_of_disp,
1376                                                      Register scratch) {
1377   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1378 
1379   add(scratch, reg, R28_mdx);
1380   ld(scratch, offset_of_disp, scratch);
1381   add(R28_mdx, scratch, R28_mdx);
1382 }
1383 
1384 // Update the method data pointer by a simple constant displacement.
1385 void InterpreterMacroAssembler::update_mdp_by_constant(int constant) {
1386   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1387   addi(R28_mdx, R28_mdx, constant);
1388 }
1389 
1390 // Update the method data pointer for a _ret bytecode whose target
1391 // was not among our cached targets.
1392 void InterpreterMacroAssembler::update_mdp_for_ret(TosState state,
1393                                                    Register return_bci) {
1394   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1395 
1396   push(state);
1397   assert(return_bci-&gt;is_nonvolatile(), &quot;need to protect return_bci&quot;);
1398   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret), return_bci);
1399   pop(state);
1400 }
1401 
1402 // Increments the backedge counter.
1403 // Returns backedge counter + invocation counter in Rdst.
1404 void InterpreterMacroAssembler::increment_backedge_counter(const Register Rcounters, const Register Rdst,
1405                                                            const Register Rtmp1, Register Rscratch) {
1406   assert(UseCompiler, &quot;incrementing must be useful&quot;);
1407   assert_different_registers(Rdst, Rtmp1);
1408   const Register invocation_counter = Rtmp1;
1409   const Register counter = Rdst;
1410   // TODO: PPC port: assert(4 == InvocationCounter::sz_counter(), &quot;unexpected field size.&quot;);
1411 
1412   // Load backedge counter.
1413   lwz(counter, in_bytes(MethodCounters::backedge_counter_offset()) +
1414                in_bytes(InvocationCounter::counter_offset()), Rcounters);
1415   // Load invocation counter.
1416   lwz(invocation_counter, in_bytes(MethodCounters::invocation_counter_offset()) +
1417                           in_bytes(InvocationCounter::counter_offset()), Rcounters);
1418 
1419   // Add the delta to the backedge counter.
1420   addi(counter, counter, InvocationCounter::count_increment);
1421 
1422   // Mask the invocation counter.
1423   andi(invocation_counter, invocation_counter, InvocationCounter::count_mask_value);
1424 
1425   // Store new counter value.
1426   stw(counter, in_bytes(MethodCounters::backedge_counter_offset()) +
1427                in_bytes(InvocationCounter::counter_offset()), Rcounters);
1428   // Return invocation counter + backedge counter.
1429   add(counter, counter, invocation_counter);
1430 }
1431 
1432 // Count a taken branch in the bytecodes.
1433 void InterpreterMacroAssembler::profile_taken_branch(Register scratch, Register bumped_count) {
1434   if (ProfileInterpreter) {
1435     Label profile_continue;
1436 
1437     // If no method data exists, go to profile_continue.
1438     test_method_data_pointer(profile_continue);
1439 
1440     // We are taking a branch. Increment the taken count.
1441     increment_mdp_data_at(in_bytes(JumpData::taken_offset()), scratch, bumped_count);
1442 
1443     // The method data pointer needs to be updated to reflect the new target.
1444     update_mdp_by_offset(in_bytes(JumpData::displacement_offset()), scratch);
1445     bind (profile_continue);
1446   }
1447 }
1448 
1449 // Count a not-taken branch in the bytecodes.
1450 void InterpreterMacroAssembler::profile_not_taken_branch(Register scratch1, Register scratch2) {
1451   if (ProfileInterpreter) {
1452     Label profile_continue;
1453 
1454     // If no method data exists, go to profile_continue.
1455     test_method_data_pointer(profile_continue);
1456 
1457     // We are taking a branch. Increment the not taken count.
1458     increment_mdp_data_at(in_bytes(BranchData::not_taken_offset()), scratch1, scratch2);
1459 
1460     // The method data pointer needs to be updated to correspond to the
1461     // next bytecode.
1462     update_mdp_by_constant(in_bytes(BranchData::branch_data_size()));
1463     bind (profile_continue);
1464   }
1465 }
1466 
1467 // Count a non-virtual call in the bytecodes.
1468 void InterpreterMacroAssembler::profile_call(Register scratch1, Register scratch2) {
1469   if (ProfileInterpreter) {
1470     Label profile_continue;
1471 
1472     // If no method data exists, go to profile_continue.
1473     test_method_data_pointer(profile_continue);
1474 
1475     // We are making a call. Increment the count.
1476     increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch1, scratch2);
1477 
1478     // The method data pointer needs to be updated to reflect the new target.
1479     update_mdp_by_constant(in_bytes(CounterData::counter_data_size()));
1480     bind (profile_continue);
1481   }
1482 }
1483 
1484 // Count a final call in the bytecodes.
1485 void InterpreterMacroAssembler::profile_final_call(Register scratch1, Register scratch2) {
1486   if (ProfileInterpreter) {
1487     Label profile_continue;
1488 
1489     // If no method data exists, go to profile_continue.
1490     test_method_data_pointer(profile_continue);
1491 
1492     // We are making a call. Increment the count.
1493     increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch1, scratch2);
1494 
1495     // The method data pointer needs to be updated to reflect the new target.
1496     update_mdp_by_constant(in_bytes(VirtualCallData::virtual_call_data_size()));
1497     bind (profile_continue);
1498   }
1499 }
1500 
1501 // Count a virtual call in the bytecodes.
1502 void InterpreterMacroAssembler::profile_virtual_call(Register Rreceiver,
1503                                                      Register Rscratch1,
1504                                                      Register Rscratch2,
1505                                                      bool receiver_can_be_null) {
1506   if (!ProfileInterpreter) { return; }
1507   Label profile_continue;
1508 
1509   // If no method data exists, go to profile_continue.
1510   test_method_data_pointer(profile_continue);
1511 
1512   Label skip_receiver_profile;
1513   if (receiver_can_be_null) {
1514     Label not_null;
1515     cmpdi(CCR0, Rreceiver, 0);
1516     bne(CCR0, not_null);
1517     // We are making a call. Increment the count for null receiver.
1518     increment_mdp_data_at(in_bytes(CounterData::count_offset()), Rscratch1, Rscratch2);
1519     b(skip_receiver_profile);
1520     bind(not_null);
1521   }
1522 
1523   // Record the receiver type.
1524   record_klass_in_profile(Rreceiver, Rscratch1, Rscratch2, true);
1525   bind(skip_receiver_profile);
1526 
1527   // The method data pointer needs to be updated to reflect the new target.
1528   update_mdp_by_constant(in_bytes(VirtualCallData::virtual_call_data_size()));
1529   bind (profile_continue);
1530 }
1531 
1532 void InterpreterMacroAssembler::profile_typecheck(Register Rklass, Register Rscratch1, Register Rscratch2) {
1533   if (ProfileInterpreter) {
1534     Label profile_continue;
1535 
1536     // If no method data exists, go to profile_continue.
1537     test_method_data_pointer(profile_continue);
1538 
1539     int mdp_delta = in_bytes(BitData::bit_data_size());
1540     if (TypeProfileCasts) {
1541       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1542 
1543       // Record the object type.
1544       record_klass_in_profile(Rklass, Rscratch1, Rscratch2, false);
1545     }
1546 
1547     // The method data pointer needs to be updated.
1548     update_mdp_by_constant(mdp_delta);
1549 
1550     bind (profile_continue);
1551   }
1552 }
1553 
1554 void InterpreterMacroAssembler::profile_typecheck_failed(Register Rscratch1, Register Rscratch2) {
1555   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1556     Label profile_continue;
1557 
1558     // If no method data exists, go to profile_continue.
1559     test_method_data_pointer(profile_continue);
1560 
1561     int count_offset = in_bytes(CounterData::count_offset());
1562     // Back up the address, since we have already bumped the mdp.
1563     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1564 
1565     // *Decrement* the counter. We expect to see zero or small negatives.
1566     increment_mdp_data_at(count_offset, Rscratch1, Rscratch2, true);
1567 
1568     bind (profile_continue);
1569   }
1570 }
1571 
1572 // Count a ret in the bytecodes.
1573 void InterpreterMacroAssembler::profile_ret(TosState state, Register return_bci,
1574                                             Register scratch1, Register scratch2) {
1575   if (ProfileInterpreter) {
1576     Label profile_continue;
1577     uint row;
1578 
1579     // If no method data exists, go to profile_continue.
1580     test_method_data_pointer(profile_continue);
1581 
1582     // Update the total ret count.
1583     increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch1, scratch2 );
1584 
1585     for (row = 0; row &lt; RetData::row_limit(); row++) {
1586       Label next_test;
1587 
1588       // See if return_bci is equal to bci[n]:
1589       test_mdp_data_at(in_bytes(RetData::bci_offset(row)), return_bci, next_test, scratch1);
1590 
1591       // return_bci is equal to bci[n]. Increment the count.
1592       increment_mdp_data_at(in_bytes(RetData::bci_count_offset(row)), scratch1, scratch2);
1593 
1594       // The method data pointer needs to be updated to reflect the new target.
1595       update_mdp_by_offset(in_bytes(RetData::bci_displacement_offset(row)), scratch1);
1596       b(profile_continue);
1597       bind(next_test);
1598     }
1599 
1600     update_mdp_for_ret(state, return_bci);
1601 
1602     bind (profile_continue);
1603   }
1604 }
1605 
1606 // Count the default case of a switch construct.
1607 void InterpreterMacroAssembler::profile_switch_default(Register scratch1,  Register scratch2) {
1608   if (ProfileInterpreter) {
1609     Label profile_continue;
1610 
1611     // If no method data exists, go to profile_continue.
1612     test_method_data_pointer(profile_continue);
1613 
1614     // Update the default case count
1615     increment_mdp_data_at(in_bytes(MultiBranchData::default_count_offset()),
1616                           scratch1, scratch2);
1617 
1618     // The method data pointer needs to be updated.
1619     update_mdp_by_offset(in_bytes(MultiBranchData::default_displacement_offset()),
1620                          scratch1);
1621 
1622     bind (profile_continue);
1623   }
1624 }
1625 
1626 // Count the index&#39;th case of a switch construct.
1627 void InterpreterMacroAssembler::profile_switch_case(Register index,
1628                                                     Register scratch1,
1629                                                     Register scratch2,
1630                                                     Register scratch3) {
1631   if (ProfileInterpreter) {
1632     assert_different_registers(index, scratch1, scratch2, scratch3);
1633     Label profile_continue;
1634 
1635     // If no method data exists, go to profile_continue.
1636     test_method_data_pointer(profile_continue);
1637 
1638     // Build the base (index * per_case_size_in_bytes()) + case_array_offset_in_bytes().
1639     li(scratch3, in_bytes(MultiBranchData::case_array_offset()));
1640 
1641     assert (in_bytes(MultiBranchData::per_case_size()) == 16, &quot;so that shladd works&quot;);
1642     sldi(scratch1, index, exact_log2(in_bytes(MultiBranchData::per_case_size())));
1643     add(scratch1, scratch1, scratch3);
1644 
1645     // Update the case count.
1646     increment_mdp_data_at(scratch1, in_bytes(MultiBranchData::relative_count_offset()), scratch2, scratch3);
1647 
1648     // The method data pointer needs to be updated.
1649     update_mdp_by_offset(scratch1, in_bytes(MultiBranchData::relative_displacement_offset()), scratch2);
1650 
1651     bind (profile_continue);
1652   }
1653 }
1654 
1655 void InterpreterMacroAssembler::profile_null_seen(Register Rscratch1, Register Rscratch2) {
1656   if (ProfileInterpreter) {
1657     assert_different_registers(Rscratch1, Rscratch2);
1658     Label profile_continue;
1659 
1660     // If no method data exists, go to profile_continue.
1661     test_method_data_pointer(profile_continue);
1662 
1663     set_mdp_flag_at(BitData::null_seen_byte_constant(), Rscratch1);
1664 
1665     // The method data pointer needs to be updated.
1666     int mdp_delta = in_bytes(BitData::bit_data_size());
1667     if (TypeProfileCasts) {
1668       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1669     }
1670     update_mdp_by_constant(mdp_delta);
1671 
1672     bind (profile_continue);
1673   }
1674 }
1675 
1676 void InterpreterMacroAssembler::record_klass_in_profile(Register Rreceiver,
1677                                                         Register Rscratch1, Register Rscratch2,
1678                                                         bool is_virtual_call) {
1679   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1680   assert_different_registers(Rreceiver, Rscratch1, Rscratch2);
1681 
1682   Label done;
1683   record_klass_in_profile_helper(Rreceiver, Rscratch1, Rscratch2, 0, done, is_virtual_call);
1684   bind (done);
1685 }
1686 
1687 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1688                                         Register receiver, Register scratch1, Register scratch2,
1689                                         int start_row, Label&amp; done, bool is_virtual_call) {
1690   if (TypeProfileWidth == 0) {
1691     if (is_virtual_call) {
1692       increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch1, scratch2);
1693     }
1694     return;
1695   }
1696 
1697   int last_row = VirtualCallData::row_limit() - 1;
1698   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1699   // Test this row for both the receiver and for null.
1700   // Take any of three different outcomes:
1701   //   1. found receiver =&gt; increment count and goto done
1702   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1703   //   3. found something else =&gt; keep looking for cases 1 and 2
1704   // Case 3 is handled by a recursive call.
1705   for (int row = start_row; row &lt;= last_row; row++) {
1706     Label next_test;
1707     bool test_for_null_also = (row == start_row);
1708 
1709     // See if the receiver is receiver[n].
1710     int recvr_offset = in_bytes(VirtualCallData::receiver_offset(row));
1711     test_mdp_data_at(recvr_offset, receiver, next_test, scratch1);
1712     // delayed()-&gt;tst(scratch);
1713 
1714     // The receiver is receiver[n]. Increment count[n].
1715     int count_offset = in_bytes(VirtualCallData::receiver_count_offset(row));
1716     increment_mdp_data_at(count_offset, scratch1, scratch2);
1717     b(done);
1718     bind(next_test);
1719 
1720     if (test_for_null_also) {
1721       Label found_null;
1722       // Failed the equality check on receiver[n]... Test for null.
1723       if (start_row == last_row) {
1724         // The only thing left to do is handle the null case.
1725         if (is_virtual_call) {
1726           // Scratch1 contains test_out from test_mdp_data_at.
1727           cmpdi(CCR0, scratch1, 0);
1728           beq(CCR0, found_null);
1729           // Receiver did not match any saved receiver and there is no empty row for it.
1730           // Increment total counter to indicate polymorphic case.
1731           increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch1, scratch2);
1732           b(done);
1733           bind(found_null);
1734         } else {
1735           cmpdi(CCR0, scratch1, 0);
1736           bne(CCR0, done);
1737         }
1738         break;
1739       }
1740       // Since null is rare, make it be the branch-taken case.
1741       cmpdi(CCR0, scratch1, 0);
1742       beq(CCR0, found_null);
1743 
1744       // Put all the &quot;Case 3&quot; tests here.
1745       record_klass_in_profile_helper(receiver, scratch1, scratch2, start_row + 1, done, is_virtual_call);
1746 
1747       // Found a null. Keep searching for a matching receiver,
1748       // but remember that this is an empty (unused) slot.
1749       bind(found_null);
1750     }
1751   }
1752 
1753   // In the fall-through case, we found no matching receiver, but we
1754   // observed the receiver[start_row] is NULL.
1755 
1756   // Fill in the receiver field and increment the count.
1757   int recvr_offset = in_bytes(VirtualCallData::receiver_offset(start_row));
1758   set_mdp_data_at(recvr_offset, receiver);
1759   int count_offset = in_bytes(VirtualCallData::receiver_count_offset(start_row));
1760   li(scratch1, DataLayout::counter_increment);
1761   set_mdp_data_at(count_offset, scratch1);
1762   if (start_row &gt; 0) {
1763     b(done);
1764   }
1765 }
1766 
1767 // Argument and return type profilig.
1768 // kills: tmp, tmp2, R0, CR0, CR1
1769 void InterpreterMacroAssembler::profile_obj_type(Register obj, Register mdo_addr_base,
1770                                                  RegisterOrConstant mdo_addr_offs,
1771                                                  Register tmp, Register tmp2) {
1772   Label do_nothing, do_update;
1773 
1774   // tmp2 = obj is allowed
1775   assert_different_registers(obj, mdo_addr_base, tmp, R0);
1776   assert_different_registers(tmp2, mdo_addr_base, tmp, R0);
1777   const Register klass = tmp2;
1778 
1779   verify_oop(obj);
1780 
1781   ld(tmp, mdo_addr_offs, mdo_addr_base);
1782 
1783   // Set null_seen if obj is 0.
1784   cmpdi(CCR0, obj, 0);
1785   ori(R0, tmp, TypeEntries::null_seen);
1786   beq(CCR0, do_update);
1787 
1788   load_klass(klass, obj);
1789 
1790   clrrdi(R0, tmp, exact_log2(-TypeEntries::type_klass_mask));
1791   // Basically same as andi(R0, tmp, TypeEntries::type_klass_mask);
1792   cmpd(CCR1, R0, klass);
1793   // Klass seen before, nothing to do (regardless of unknown bit).
1794   //beq(CCR1, do_nothing);
1795 
1796   andi_(R0, klass, TypeEntries::type_unknown);
1797   // Already unknown. Nothing to do anymore.
1798   //bne(CCR0, do_nothing);
1799   crorc(CCR0, Assembler::equal, CCR1, Assembler::equal); // cr0 eq = cr1 eq or cr0 ne
1800   beq(CCR0, do_nothing);
1801 
1802   clrrdi_(R0, tmp, exact_log2(-TypeEntries::type_mask));
1803   orr(R0, klass, tmp); // Combine klass and null_seen bit (only used if (tmp &amp; type_mask)==0).
1804   beq(CCR0, do_update); // First time here. Set profile type.
1805 
1806   // Different than before. Cannot keep accurate profile.
1807   ori(R0, tmp, TypeEntries::type_unknown);
1808 
1809   bind(do_update);
1810   // update profile
1811   std(R0, mdo_addr_offs, mdo_addr_base);
1812 
1813   align(32, 12);
1814   bind(do_nothing);
1815 }
1816 
1817 void InterpreterMacroAssembler::profile_arguments_type(Register callee,
1818                                                        Register tmp1, Register tmp2,
1819                                                        bool is_virtual) {
1820   if (!ProfileInterpreter) {
1821     return;
1822   }
1823 
1824   assert_different_registers(callee, tmp1, tmp2, R28_mdx);
1825 
1826   if (MethodData::profile_arguments() || MethodData::profile_return()) {
1827     Label profile_continue;
1828 
1829     test_method_data_pointer(profile_continue);
1830 
1831     int off_to_start = is_virtual ?
1832       in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
1833 
1834     lbz(tmp1, in_bytes(DataLayout::tag_offset()) - off_to_start, R28_mdx);
1835     cmpwi(CCR0, tmp1, is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag);
1836     bne(CCR0, profile_continue);
1837 
1838     if (MethodData::profile_arguments()) {
1839       Label done;
1840       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
1841       add(R28_mdx, off_to_args, R28_mdx);
1842 
1843       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
1844         if (i &gt; 0 || MethodData::profile_return()) {
1845           // If return value type is profiled we may have no argument to profile.
1846           ld(tmp1, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args, R28_mdx);
1847           cmpdi(CCR0, tmp1, (i+1)*TypeStackSlotEntries::per_arg_count());
1848           addi(tmp1, tmp1, -i*TypeStackSlotEntries::per_arg_count());
1849           blt(CCR0, done);
1850         }
1851         ld(tmp1, in_bytes(Method::const_offset()), callee);
1852         lhz(tmp1, in_bytes(ConstMethod::size_of_parameters_offset()), tmp1);
1853         // Stack offset o (zero based) from the start of the argument
1854         // list, for n arguments translates into offset n - o - 1 from
1855         // the end of the argument list. But there&#39;s an extra slot at
1856         // the top of the stack. So the offset is n - o from Lesp.
1857         ld(tmp2, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))-off_to_args, R28_mdx);
1858         subf(tmp1, tmp2, tmp1);
1859 
1860         sldi(tmp1, tmp1, Interpreter::logStackElementSize);
1861         ldx(tmp1, tmp1, R15_esp);
1862 
1863         profile_obj_type(tmp1, R28_mdx, in_bytes(TypeEntriesAtCall::argument_type_offset(i))-off_to_args, tmp2, tmp1);
1864 
1865         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
1866         addi(R28_mdx, R28_mdx, to_add);
1867         off_to_args += to_add;
1868       }
1869 
1870       if (MethodData::profile_return()) {
1871         ld(tmp1, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args, R28_mdx);
1872         addi(tmp1, tmp1, -TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count());
1873       }
1874 
1875       bind(done);
1876 
1877       if (MethodData::profile_return()) {
1878         // We&#39;re right after the type profile for the last
1879         // argument. tmp1 is the number of cells left in the
1880         // CallTypeData/VirtualCallTypeData to reach its end. Non null
1881         // if there&#39;s a return to profile.
<a name="1" id="anc1"></a><span class="line-modified">1882         assert(ReturnTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(),</span>
1883                &quot;can&#39;t move past ret type&quot;);
1884         sldi(tmp1, tmp1, exact_log2(DataLayout::cell_size));
1885         add(R28_mdx, tmp1, R28_mdx);
1886       }
1887     } else {
1888       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
1889       update_mdp_by_constant(in_bytes(TypeEntriesAtCall::return_only_size()));
1890     }
1891 
1892     // Mdp points right after the end of the
1893     // CallTypeData/VirtualCallTypeData, right after the cells for the
1894     // return value type if there&#39;s one.
1895     align(32, 12);
1896     bind(profile_continue);
1897   }
1898 }
1899 
1900 void InterpreterMacroAssembler::profile_return_type(Register ret, Register tmp1, Register tmp2) {
1901   assert_different_registers(ret, tmp1, tmp2);
1902   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
1903     Label profile_continue;
1904 
1905     test_method_data_pointer(profile_continue);
1906 
1907     if (MethodData::profile_return_jsr292_only()) {
1908       // If we don&#39;t profile all invoke bytecodes we must make sure
1909       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
1910       // begining of the ProfileData we intend to update to check its
1911       // type because we&#39;re right after it and we don&#39;t known its
1912       // length.
1913       lbz(tmp1, 0, R14_bcp);
1914       lbz(tmp2, Method::intrinsic_id_offset_in_bytes(), R19_method);
1915       cmpwi(CCR0, tmp1, Bytecodes::_invokedynamic);
1916       cmpwi(CCR1, tmp1, Bytecodes::_invokehandle);
1917       cror(CCR0, Assembler::equal, CCR1, Assembler::equal);
1918       cmpwi(CCR1, tmp2, vmIntrinsics::_compiledLambdaForm);
1919       cror(CCR0, Assembler::equal, CCR1, Assembler::equal);
1920       bne(CCR0, profile_continue);
1921     }
1922 
<a name="2" id="anc2"></a><span class="line-modified">1923     profile_obj_type(ret, R28_mdx, -in_bytes(ReturnTypeEntry::size()), tmp1, tmp2);</span>
1924 
1925     align(32, 12);
1926     bind(profile_continue);
1927   }
1928 }
1929 
1930 void InterpreterMacroAssembler::profile_parameters_type(Register tmp1, Register tmp2,
1931                                                         Register tmp3, Register tmp4) {
1932   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
1933     Label profile_continue, done;
1934 
1935     test_method_data_pointer(profile_continue);
1936 
1937     // Load the offset of the area within the MDO used for
1938     // parameters. If it&#39;s negative we&#39;re not profiling any parameters.
1939     lwz(tmp1, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset()), R28_mdx);
1940     cmpwi(CCR0, tmp1, 0);
1941     blt(CCR0, profile_continue);
1942 
1943     // Compute a pointer to the area for parameters from the offset
1944     // and move the pointer to the slot for the last
1945     // parameters. Collect profiling from last parameter down.
1946     // mdo start + parameters offset + array length - 1
1947 
1948     // Pointer to the parameter area in the MDO.
1949     const Register mdp = tmp1;
1950     add(mdp, tmp1, R28_mdx);
1951 
1952     // Offset of the current profile entry to update.
1953     const Register entry_offset = tmp2;
1954     // entry_offset = array len in number of cells
1955     ld(entry_offset, in_bytes(ArrayData::array_len_offset()), mdp);
1956 
1957     int off_base = in_bytes(ParametersTypeData::stack_slot_offset(0));
1958     assert(off_base % DataLayout::cell_size == 0, &quot;should be a number of cells&quot;);
1959 
1960     // entry_offset (number of cells)  = array len - size of 1 entry + offset of the stack slot field
1961     addi(entry_offset, entry_offset, -TypeStackSlotEntries::per_arg_count() + (off_base / DataLayout::cell_size));
1962     // entry_offset in bytes
1963     sldi(entry_offset, entry_offset, exact_log2(DataLayout::cell_size));
1964 
1965     Label loop;
1966     align(32, 12);
1967     bind(loop);
1968 
1969     // Load offset on the stack from the slot for this parameter.
1970     ld(tmp3, entry_offset, mdp);
1971     sldi(tmp3, tmp3, Interpreter::logStackElementSize);
1972     neg(tmp3, tmp3);
1973     // Read the parameter from the local area.
1974     ldx(tmp3, tmp3, R18_locals);
1975 
1976     // Make entry_offset now point to the type field for this parameter.
1977     int type_base = in_bytes(ParametersTypeData::type_offset(0));
1978     assert(type_base &gt; off_base, &quot;unexpected&quot;);
1979     addi(entry_offset, entry_offset, type_base - off_base);
1980 
1981     // Profile the parameter.
1982     profile_obj_type(tmp3, mdp, entry_offset, tmp4, tmp3);
1983 
1984     // Go to next parameter.
1985     int delta = TypeStackSlotEntries::per_arg_count() * DataLayout::cell_size + (type_base - off_base);
1986     cmpdi(CCR0, entry_offset, off_base + delta);
1987     addi(entry_offset, entry_offset, -delta);
1988     bge(CCR0, loop);
1989 
1990     align(32, 12);
1991     bind(profile_continue);
1992   }
1993 }
1994 
1995 // Add a InterpMonitorElem to stack (see frame_sparc.hpp).
1996 void InterpreterMacroAssembler::add_monitor_to_stack(bool stack_is_empty, Register Rtemp1, Register Rtemp2) {
1997 
1998   // Very-local scratch registers.
1999   const Register esp  = Rtemp1;
2000   const Register slot = Rtemp2;
2001 
2002   // Extracted monitor_size.
2003   int monitor_size = frame::interpreter_frame_monitor_size_in_bytes();
2004   assert(Assembler::is_aligned((unsigned int)monitor_size,
2005                                (unsigned int)frame::alignment_in_bytes),
2006          &quot;size of a monitor must respect alignment of SP&quot;);
2007 
2008   resize_frame(-monitor_size, /*temp*/esp); // Allocate space for new monitor
2009   std(R1_SP, _ijava_state_neg(top_frame_sp), esp); // esp contains fp
2010 
2011   // Shuffle expression stack down. Recall that stack_base points
2012   // just above the new expression stack bottom. Old_tos and new_tos
2013   // are used to scan thru the old and new expression stacks.
2014   if (!stack_is_empty) {
2015     Label copy_slot, copy_slot_finished;
2016     const Register n_slots = slot;
2017 
2018     addi(esp, R15_esp, Interpreter::stackElementSize); // Point to first element (pre-pushed stack).
2019     subf(n_slots, esp, R26_monitor);
2020     srdi_(n_slots, n_slots, LogBytesPerWord);          // Compute number of slots to copy.
2021     assert(LogBytesPerWord == 3, &quot;conflicts assembler instructions&quot;);
2022     beq(CCR0, copy_slot_finished);                     // Nothing to copy.
2023 
2024     mtctr(n_slots);
2025 
2026     // loop
2027     bind(copy_slot);
2028     ld(slot, 0, esp);              // Move expression stack down.
2029     std(slot, -monitor_size, esp); // distance = monitor_size
2030     addi(esp, esp, BytesPerWord);
2031     bdnz(copy_slot);
2032 
2033     bind(copy_slot_finished);
2034   }
2035 
2036   addi(R15_esp, R15_esp, -monitor_size);
2037   addi(R26_monitor, R26_monitor, -monitor_size);
2038 
2039   // Restart interpreter
2040 }
2041 
2042 // ============================================================================
2043 // Java locals access
2044 
2045 // Load a local variable at index in Rindex into register Rdst_value.
2046 // Also puts address of local into Rdst_address as a service.
2047 // Kills:
2048 //   - Rdst_value
2049 //   - Rdst_address
2050 void InterpreterMacroAssembler::load_local_int(Register Rdst_value, Register Rdst_address, Register Rindex) {
2051   sldi(Rdst_address, Rindex, Interpreter::logStackElementSize);
2052   subf(Rdst_address, Rdst_address, R18_locals);
2053   lwz(Rdst_value, 0, Rdst_address);
2054 }
2055 
2056 // Load a local variable at index in Rindex into register Rdst_value.
2057 // Also puts address of local into Rdst_address as a service.
2058 // Kills:
2059 //   - Rdst_value
2060 //   - Rdst_address
2061 void InterpreterMacroAssembler::load_local_long(Register Rdst_value, Register Rdst_address, Register Rindex) {
2062   sldi(Rdst_address, Rindex, Interpreter::logStackElementSize);
2063   subf(Rdst_address, Rdst_address, R18_locals);
2064   ld(Rdst_value, -8, Rdst_address);
2065 }
2066 
2067 // Load a local variable at index in Rindex into register Rdst_value.
2068 // Also puts address of local into Rdst_address as a service.
2069 // Input:
2070 //   - Rindex:      slot nr of local variable
2071 // Kills:
2072 //   - Rdst_value
2073 //   - Rdst_address
2074 void InterpreterMacroAssembler::load_local_ptr(Register Rdst_value,
2075                                                Register Rdst_address,
2076                                                Register Rindex) {
2077   sldi(Rdst_address, Rindex, Interpreter::logStackElementSize);
2078   subf(Rdst_address, Rdst_address, R18_locals);
2079   ld(Rdst_value, 0, Rdst_address);
2080 }
2081 
2082 // Load a local variable at index in Rindex into register Rdst_value.
2083 // Also puts address of local into Rdst_address as a service.
2084 // Kills:
2085 //   - Rdst_value
2086 //   - Rdst_address
2087 void InterpreterMacroAssembler::load_local_float(FloatRegister Rdst_value,
2088                                                  Register Rdst_address,
2089                                                  Register Rindex) {
2090   sldi(Rdst_address, Rindex, Interpreter::logStackElementSize);
2091   subf(Rdst_address, Rdst_address, R18_locals);
2092   lfs(Rdst_value, 0, Rdst_address);
2093 }
2094 
2095 // Load a local variable at index in Rindex into register Rdst_value.
2096 // Also puts address of local into Rdst_address as a service.
2097 // Kills:
2098 //   - Rdst_value
2099 //   - Rdst_address
2100 void InterpreterMacroAssembler::load_local_double(FloatRegister Rdst_value,
2101                                                   Register Rdst_address,
2102                                                   Register Rindex) {
2103   sldi(Rdst_address, Rindex, Interpreter::logStackElementSize);
2104   subf(Rdst_address, Rdst_address, R18_locals);
2105   lfd(Rdst_value, -8, Rdst_address);
2106 }
2107 
2108 // Store an int value at local variable slot Rindex.
2109 // Kills:
2110 //   - Rindex
2111 void InterpreterMacroAssembler::store_local_int(Register Rvalue, Register Rindex) {
2112   sldi(Rindex, Rindex, Interpreter::logStackElementSize);
2113   subf(Rindex, Rindex, R18_locals);
2114   stw(Rvalue, 0, Rindex);
2115 }
2116 
2117 // Store a long value at local variable slot Rindex.
2118 // Kills:
2119 //   - Rindex
2120 void InterpreterMacroAssembler::store_local_long(Register Rvalue, Register Rindex) {
2121   sldi(Rindex, Rindex, Interpreter::logStackElementSize);
2122   subf(Rindex, Rindex, R18_locals);
2123   std(Rvalue, -8, Rindex);
2124 }
2125 
2126 // Store an oop value at local variable slot Rindex.
2127 // Kills:
2128 //   - Rindex
2129 void InterpreterMacroAssembler::store_local_ptr(Register Rvalue, Register Rindex) {
2130   sldi(Rindex, Rindex, Interpreter::logStackElementSize);
2131   subf(Rindex, Rindex, R18_locals);
2132   std(Rvalue, 0, Rindex);
2133 }
2134 
2135 // Store an int value at local variable slot Rindex.
2136 // Kills:
2137 //   - Rindex
2138 void InterpreterMacroAssembler::store_local_float(FloatRegister Rvalue, Register Rindex) {
2139   sldi(Rindex, Rindex, Interpreter::logStackElementSize);
2140   subf(Rindex, Rindex, R18_locals);
2141   stfs(Rvalue, 0, Rindex);
2142 }
2143 
2144 // Store an int value at local variable slot Rindex.
2145 // Kills:
2146 //   - Rindex
2147 void InterpreterMacroAssembler::store_local_double(FloatRegister Rvalue, Register Rindex) {
2148   sldi(Rindex, Rindex, Interpreter::logStackElementSize);
2149   subf(Rindex, Rindex, R18_locals);
2150   stfd(Rvalue, -8, Rindex);
2151 }
2152 
2153 // Read pending exception from thread and jump to interpreter.
2154 // Throw exception entry if one if pending. Fall through otherwise.
2155 void InterpreterMacroAssembler::check_and_forward_exception(Register Rscratch1, Register Rscratch2) {
2156   assert_different_registers(Rscratch1, Rscratch2, R3);
2157   Register Rexception = Rscratch1;
2158   Register Rtmp       = Rscratch2;
2159   Label Ldone;
2160   // Get pending exception oop.
2161   ld(Rexception, thread_(pending_exception));
2162   cmpdi(CCR0, Rexception, 0);
2163   beq(CCR0, Ldone);
2164   li(Rtmp, 0);
2165   mr_if_needed(R3, Rexception);
2166   std(Rtmp, thread_(pending_exception)); // Clear exception in thread
2167   if (Interpreter::rethrow_exception_entry() != NULL) {
2168     // Already got entry address.
2169     load_dispatch_table(Rtmp, (address*)Interpreter::rethrow_exception_entry());
2170   } else {
2171     // Dynamically load entry address.
2172     int simm16_rest = load_const_optimized(Rtmp, &amp;Interpreter::_rethrow_exception_entry, R0, true);
2173     ld(Rtmp, simm16_rest, Rtmp);
2174   }
2175   mtctr(Rtmp);
2176   save_interpreter_state(Rtmp);
2177   bctr();
2178 
2179   align(32, 12);
2180   bind(Ldone);
2181 }
2182 
2183 void InterpreterMacroAssembler::call_VM(Register oop_result, address entry_point, bool check_exceptions) {
2184   save_interpreter_state(R11_scratch1);
2185 
2186   MacroAssembler::call_VM(oop_result, entry_point, false);
2187 
2188   restore_interpreter_state(R11_scratch1, /*bcp_and_mdx_only*/ true);
2189 
2190   check_and_handle_popframe(R11_scratch1);
2191   check_and_handle_earlyret(R11_scratch1);
2192   // Now check exceptions manually.
2193   if (check_exceptions) {
2194     check_and_forward_exception(R11_scratch1, R12_scratch2);
2195   }
2196 }
2197 
2198 void InterpreterMacroAssembler::call_VM(Register oop_result, address entry_point,
2199                                         Register arg_1, bool check_exceptions) {
2200   // ARG1 is reserved for the thread.
2201   mr_if_needed(R4_ARG2, arg_1);
2202   call_VM(oop_result, entry_point, check_exceptions);
2203 }
2204 
2205 void InterpreterMacroAssembler::call_VM(Register oop_result, address entry_point,
2206                                         Register arg_1, Register arg_2,
2207                                         bool check_exceptions) {
2208   // ARG1 is reserved for the thread.
2209   mr_if_needed(R4_ARG2, arg_1);
2210   assert(arg_2 != R4_ARG2, &quot;smashed argument&quot;);
2211   mr_if_needed(R5_ARG3, arg_2);
2212   call_VM(oop_result, entry_point, check_exceptions);
2213 }
2214 
2215 void InterpreterMacroAssembler::call_VM(Register oop_result, address entry_point,
2216                                         Register arg_1, Register arg_2, Register arg_3,
2217                                         bool check_exceptions) {
2218   // ARG1 is reserved for the thread.
2219   mr_if_needed(R4_ARG2, arg_1);
2220   assert(arg_2 != R4_ARG2, &quot;smashed argument&quot;);
2221   mr_if_needed(R5_ARG3, arg_2);
2222   assert(arg_3 != R4_ARG2 &amp;&amp; arg_3 != R5_ARG3, &quot;smashed argument&quot;);
2223   mr_if_needed(R6_ARG4, arg_3);
2224   call_VM(oop_result, entry_point, check_exceptions);
2225 }
2226 
2227 void InterpreterMacroAssembler::save_interpreter_state(Register scratch) {
2228   ld(scratch, 0, R1_SP);
2229   std(R15_esp, _ijava_state_neg(esp), scratch);
2230   std(R14_bcp, _ijava_state_neg(bcp), scratch);
2231   std(R26_monitor, _ijava_state_neg(monitors), scratch);
2232   if (ProfileInterpreter) { std(R28_mdx, _ijava_state_neg(mdx), scratch); }
2233   // Other entries should be unchanged.
2234 }
2235 
2236 void InterpreterMacroAssembler::restore_interpreter_state(Register scratch, bool bcp_and_mdx_only) {
2237   ld(scratch, 0, R1_SP);
2238   ld(R14_bcp, _ijava_state_neg(bcp), scratch); // Changed by VM code (exception).
2239   if (ProfileInterpreter) { ld(R28_mdx, _ijava_state_neg(mdx), scratch); } // Changed by VM code.
2240   if (!bcp_and_mdx_only) {
2241     // Following ones are Metadata.
2242     ld(R19_method, _ijava_state_neg(method), scratch);
2243     ld(R27_constPoolCache, _ijava_state_neg(cpoolCache), scratch);
2244     // Following ones are stack addresses and don&#39;t require reload.
2245     ld(R15_esp, _ijava_state_neg(esp), scratch);
2246     ld(R18_locals, _ijava_state_neg(locals), scratch);
2247     ld(R26_monitor, _ijava_state_neg(monitors), scratch);
2248   }
2249 #ifdef ASSERT
2250   {
2251     Label Lok;
2252     subf(R0, R1_SP, scratch);
2253     cmpdi(CCR0, R0, frame::abi_reg_args_size + frame::ijava_state_size);
2254     bge(CCR0, Lok);
2255     stop(&quot;frame too small (restore istate)&quot;);
2256     bind(Lok);
2257   }
2258 #endif
2259 }
2260 
2261 void InterpreterMacroAssembler::get_method_counters(Register method,
2262                                                     Register Rcounters,
2263                                                     Label&amp; skip) {
2264   BLOCK_COMMENT(&quot;Load and ev. allocate counter object {&quot;);
2265   Label has_counters;
2266   ld(Rcounters, in_bytes(Method::method_counters_offset()), method);
2267   cmpdi(CCR0, Rcounters, 0);
2268   bne(CCR0, has_counters);
2269   call_VM(noreg, CAST_FROM_FN_PTR(address,
2270                                   InterpreterRuntime::build_method_counters), method);
2271   ld(Rcounters, in_bytes(Method::method_counters_offset()), method);
2272   cmpdi(CCR0, Rcounters, 0);
2273   beq(CCR0, skip); // No MethodCounters, OutOfMemory.
2274   BLOCK_COMMENT(&quot;} Load and ev. allocate counter object&quot;);
2275 
2276   bind(has_counters);
2277 }
2278 
2279 void InterpreterMacroAssembler::increment_invocation_counter(Register Rcounters,
2280                                                              Register iv_be_count,
2281                                                              Register Rtmp_r0) {
2282   assert(UseCompiler || LogTouchedMethods, &quot;incrementing must be useful&quot;);
2283   Register invocation_count = iv_be_count;
2284   Register backedge_count   = Rtmp_r0;
2285   int delta = InvocationCounter::count_increment;
2286 
2287   // Load each counter in a register.
2288   //  ld(inv_counter, Rtmp);
2289   //  ld(be_counter, Rtmp2);
2290   int inv_counter_offset = in_bytes(MethodCounters::invocation_counter_offset() +
2291                                     InvocationCounter::counter_offset());
2292   int be_counter_offset  = in_bytes(MethodCounters::backedge_counter_offset() +
2293                                     InvocationCounter::counter_offset());
2294 
2295   BLOCK_COMMENT(&quot;Increment profiling counters {&quot;);
2296 
2297   // Load the backedge counter.
2298   lwz(backedge_count, be_counter_offset, Rcounters); // is unsigned int
2299   // Mask the backedge counter.
2300   andi(backedge_count, backedge_count, InvocationCounter::count_mask_value);
2301 
2302   // Load the invocation counter.
2303   lwz(invocation_count, inv_counter_offset, Rcounters); // is unsigned int
2304   // Add the delta to the invocation counter and store the result.
2305   addi(invocation_count, invocation_count, delta);
2306   // Store value.
2307   stw(invocation_count, inv_counter_offset, Rcounters);
2308 
2309   // Add invocation counter + backedge counter.
2310   add(iv_be_count, backedge_count, invocation_count);
2311 
2312   // Note that this macro must leave the backedge_count + invocation_count in
2313   // register iv_be_count!
2314   BLOCK_COMMENT(&quot;} Increment profiling counters&quot;);
2315 }
2316 
2317 void InterpreterMacroAssembler::verify_oop(Register reg, TosState state) {
2318   if (state == atos) { MacroAssembler::verify_oop(reg, FILE_AND_LINE); }
2319 }
2320 
2321 // Local helper function for the verify_oop_or_return_address macro.
2322 static bool verify_return_address(Method* m, int bci) {
2323 #ifndef PRODUCT
2324   address pc = (address)(m-&gt;constMethod()) + in_bytes(ConstMethod::codes_offset()) + bci;
2325   // Assume it is a valid return address if it is inside m and is preceded by a jsr.
2326   if (!m-&gt;contains(pc))                                            return false;
2327   address jsr_pc;
2328   jsr_pc = pc - Bytecodes::length_for(Bytecodes::_jsr);
2329   if (*jsr_pc == Bytecodes::_jsr   &amp;&amp; jsr_pc &gt;= m-&gt;code_base())    return true;
2330   jsr_pc = pc - Bytecodes::length_for(Bytecodes::_jsr_w);
2331   if (*jsr_pc == Bytecodes::_jsr_w &amp;&amp; jsr_pc &gt;= m-&gt;code_base())    return true;
2332 #endif // PRODUCT
2333   return false;
2334 }
2335 
2336 void InterpreterMacroAssembler::verify_FPU(int stack_depth, TosState state) {
2337   if (VerifyFPU) {
2338     unimplemented(&quot;verfiyFPU&quot;);
2339   }
2340 }
2341 
2342 void InterpreterMacroAssembler::verify_oop_or_return_address(Register reg, Register Rtmp) {
2343   if (!VerifyOops) return;
2344 
2345   // The VM documentation for the astore[_wide] bytecode allows
2346   // the TOS to be not only an oop but also a return address.
2347   Label test;
2348   Label skip;
2349   // See if it is an address (in the current method):
2350 
2351   const int log2_bytecode_size_limit = 16;
2352   srdi_(Rtmp, reg, log2_bytecode_size_limit);
2353   bne(CCR0, test);
2354 
2355   address fd = CAST_FROM_FN_PTR(address, verify_return_address);
2356   const int nbytes_save = MacroAssembler::num_volatile_regs * 8;
2357   save_volatile_gprs(R1_SP, -nbytes_save); // except R0
2358   save_LR_CR(Rtmp); // Save in old frame.
2359   push_frame_reg_args(nbytes_save, Rtmp);
2360 
2361   load_const_optimized(Rtmp, fd, R0);
2362   mr_if_needed(R4_ARG2, reg);
2363   mr(R3_ARG1, R19_method);
2364   call_c(Rtmp); // call C
2365 
2366   pop_frame();
2367   restore_LR_CR(Rtmp);
2368   restore_volatile_gprs(R1_SP, -nbytes_save); // except R0
2369   b(skip);
2370 
2371   // Perform a more elaborate out-of-line call.
2372   // Not an address; verify it:
2373   bind(test);
2374   verify_oop(reg);
2375   bind(skip);
2376 }
2377 
2378 // Inline assembly for:
2379 //
2380 // if (thread is in interp_only_mode) {
2381 //   InterpreterRuntime::post_method_entry();
2382 // }
2383 // if (*jvmpi::event_flags_array_at_addr(JVMPI_EVENT_METHOD_ENTRY ) ||
2384 //     *jvmpi::event_flags_array_at_addr(JVMPI_EVENT_METHOD_ENTRY2)   ) {
2385 //   SharedRuntime::jvmpi_method_entry(method, receiver);
2386 // }
2387 void InterpreterMacroAssembler::notify_method_entry() {
2388   // JVMTI
2389   // Whenever JVMTI puts a thread in interp_only_mode, method
2390   // entry/exit events are sent for that thread to track stack
2391   // depth. If it is possible to enter interp_only_mode we add
2392   // the code to check if the event should be sent.
2393   if (JvmtiExport::can_post_interpreter_events()) {
2394     Label jvmti_post_done;
2395 
2396     lwz(R0, in_bytes(JavaThread::interp_only_mode_offset()), R16_thread);
2397     cmpwi(CCR0, R0, 0);
2398     beq(CCR0, jvmti_post_done);
2399     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_entry),
2400             /*check_exceptions=*/true);
2401 
2402     bind(jvmti_post_done);
2403   }
2404 }
2405 
2406 // Inline assembly for:
2407 //
2408 // if (thread is in interp_only_mode) {
2409 //   // save result
2410 //   InterpreterRuntime::post_method_exit();
2411 //   // restore result
2412 // }
2413 // if (*jvmpi::event_flags_array_at_addr(JVMPI_EVENT_METHOD_EXIT)) {
2414 //   // save result
2415 //   SharedRuntime::jvmpi_method_exit();
2416 //   // restore result
2417 // }
2418 //
2419 // Native methods have their result stored in d_tmp and l_tmp.
2420 // Java methods have their result stored in the expression stack.
2421 void InterpreterMacroAssembler::notify_method_exit(bool is_native_method, TosState state,
2422                                                    NotifyMethodExitMode mode, bool check_exceptions) {
2423   // JVMTI
2424   // Whenever JVMTI puts a thread in interp_only_mode, method
2425   // entry/exit events are sent for that thread to track stack
2426   // depth. If it is possible to enter interp_only_mode we add
2427   // the code to check if the event should be sent.
2428   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
2429     Label jvmti_post_done;
2430 
2431     lwz(R0, in_bytes(JavaThread::interp_only_mode_offset()), R16_thread);
2432     cmpwi(CCR0, R0, 0);
2433     beq(CCR0, jvmti_post_done);
2434     if (!is_native_method) { push(state); } // Expose tos to GC.
2435     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit),
2436             /*check_exceptions=*/check_exceptions);
2437     if (!is_native_method) { pop(state); }
2438 
2439     align(32, 12);
2440     bind(jvmti_post_done);
2441   }
2442 
2443   // Dtrace support not implemented.
2444 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>