<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/oops/method.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/metadataOnStackMark.hpp&quot;
  28 #include &quot;classfile/symbolTable.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;code/debugInfoRec.hpp&quot;
  32 #include &quot;compiler/compilationPolicy.hpp&quot;
  33 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  34 #include &quot;interpreter/bytecodeStream.hpp&quot;
  35 #include &quot;interpreter/bytecodeTracer.hpp&quot;
  36 #include &quot;interpreter/bytecodes.hpp&quot;
  37 #include &quot;interpreter/interpreter.hpp&quot;
  38 #include &quot;interpreter/oopMapCache.hpp&quot;
  39 #include &quot;logging/log.hpp&quot;
  40 #include &quot;logging/logTag.hpp&quot;
  41 #include &quot;logging/logStream.hpp&quot;
  42 #include &quot;memory/allocation.inline.hpp&quot;
  43 #include &quot;memory/metadataFactory.hpp&quot;
  44 #include &quot;memory/metaspaceClosure.hpp&quot;
  45 #include &quot;memory/metaspaceShared.hpp&quot;
  46 #include &quot;memory/oopFactory.hpp&quot;
  47 #include &quot;memory/resourceArea.hpp&quot;
  48 #include &quot;memory/universe.hpp&quot;
  49 #include &quot;oops/constMethod.hpp&quot;
  50 #include &quot;oops/constantPool.hpp&quot;
  51 #include &quot;oops/method.inline.hpp&quot;
  52 #include &quot;oops/methodData.hpp&quot;
  53 #include &quot;oops/objArrayKlass.hpp&quot;
  54 #include &quot;oops/objArrayOop.inline.hpp&quot;
  55 #include &quot;oops/oop.inline.hpp&quot;
  56 #include &quot;oops/symbol.hpp&quot;
<a name="1" id="anc1"></a><span class="line-added">  57 #include &quot;oops/inlineKlass.inline.hpp&quot;</span>
  58 #include &quot;prims/jvmtiExport.hpp&quot;
  59 #include &quot;prims/methodHandles.hpp&quot;
  60 #include &quot;prims/nativeLookup.hpp&quot;
  61 #include &quot;runtime/arguments.hpp&quot;
  62 #include &quot;runtime/atomic.hpp&quot;
  63 #include &quot;runtime/frame.inline.hpp&quot;
  64 #include &quot;runtime/handles.inline.hpp&quot;
  65 #include &quot;runtime/init.hpp&quot;
  66 #include &quot;runtime/orderAccess.hpp&quot;
  67 #include &quot;runtime/relocator.hpp&quot;
  68 #include &quot;runtime/safepointVerifiers.hpp&quot;
  69 #include &quot;runtime/sharedRuntime.hpp&quot;
  70 #include &quot;runtime/signature.hpp&quot;
  71 #include &quot;utilities/align.hpp&quot;
  72 #include &quot;utilities/quickSort.hpp&quot;
  73 #include &quot;utilities/vmError.hpp&quot;
  74 #include &quot;utilities/xmlstream.hpp&quot;
  75 
  76 // Implementation of Method
  77 
  78 Method* Method::allocate(ClassLoaderData* loader_data,
  79                          int byte_code_size,
  80                          AccessFlags access_flags,
  81                          InlineTableSizes* sizes,
  82                          ConstMethod::MethodType method_type,
  83                          TRAPS) {
  84   assert(!access_flags.is_native() || byte_code_size == 0,
  85          &quot;native methods should not contain byte codes&quot;);
  86   ConstMethod* cm = ConstMethod::allocate(loader_data,
  87                                           byte_code_size,
  88                                           sizes,
  89                                           method_type,
  90                                           CHECK_NULL);
  91   int size = Method::size(access_flags.is_native());
  92   return new (loader_data, size, MetaspaceObj::MethodType, THREAD) Method(cm, access_flags);
  93 }
  94 
  95 Method::Method(ConstMethod* xconst, AccessFlags access_flags) {
  96   NoSafepointVerifier no_safepoint;
  97   set_constMethod(xconst);
  98   set_access_flags(access_flags);
  99   set_intrinsic_id(vmIntrinsics::_none);
 100   set_force_inline(false);
 101   set_hidden(false);
 102   set_dont_inline(false);
 103   set_has_injected_profile(false);
 104   set_method_data(NULL);
 105   clear_method_counters();
 106   set_vtable_index(Method::garbage_vtable_index);
 107 
 108   // Fix and bury in Method*
 109   set_interpreter_entry(NULL); // sets i2i entry and from_int
 110   set_adapter_entry(NULL);
 111   Method::clear_code(); // from_c/from_i get set to c2i/i2i
 112 
 113   if (access_flags.is_native()) {
 114     clear_native_function();
 115     set_signature_handler(NULL);
 116   }
<a name="2" id="anc2"></a>
 117   NOT_PRODUCT(set_compiled_invocation_count(0);)
 118 }
 119 
 120 // Release Method*.  The nmethod will be gone when we get here because
 121 // we&#39;ve walked the code cache.
 122 void Method::deallocate_contents(ClassLoaderData* loader_data) {
 123   MetadataFactory::free_metadata(loader_data, constMethod());
 124   set_constMethod(NULL);
 125   MetadataFactory::free_metadata(loader_data, method_data());
 126   set_method_data(NULL);
 127   MetadataFactory::free_metadata(loader_data, method_counters());
 128   clear_method_counters();
 129   // The nmethod will be gone when we get here.
 130   if (code() != NULL) _code = NULL;
 131 }
 132 
 133 void Method::release_C_heap_structures() {
 134   if (method_data()) {
 135 #if INCLUDE_JVMCI
 136     FailedSpeculation::free_failed_speculations(method_data()-&gt;get_failed_speculations_address());
 137 #endif
 138     // Destroy MethodData
 139     method_data()-&gt;~MethodData();
 140   }
 141 }
 142 
 143 address Method::get_i2c_entry() {
 144   assert(adapter() != NULL, &quot;must have&quot;);
 145   return adapter()-&gt;get_i2c_entry();
 146 }
 147 
 148 address Method::get_c2i_entry() {
 149   assert(adapter() != NULL, &quot;must have&quot;);
 150   return adapter()-&gt;get_c2i_entry();
 151 }
 152 
<a name="3" id="anc3"></a><span class="line-added"> 153 address Method::get_c2i_inline_entry() {</span>
<span class="line-added"> 154   assert(adapter() != NULL, &quot;must have&quot;);</span>
<span class="line-added"> 155   return adapter()-&gt;get_c2i_inline_entry();</span>
<span class="line-added"> 156 }</span>
<span class="line-added"> 157 </span>
 158 address Method::get_c2i_unverified_entry() {
 159   assert(adapter() != NULL, &quot;must have&quot;);
 160   return adapter()-&gt;get_c2i_unverified_entry();
 161 }
 162 
<a name="4" id="anc4"></a><span class="line-added"> 163 address Method::get_c2i_unverified_inline_entry() {</span>
<span class="line-added"> 164   assert(adapter() != NULL, &quot;must have&quot;);</span>
<span class="line-added"> 165   return adapter()-&gt;get_c2i_unverified_inline_entry();</span>
<span class="line-added"> 166 }</span>
<span class="line-added"> 167 </span>
 168 address Method::get_c2i_no_clinit_check_entry() {
 169   assert(VM_Version::supports_fast_class_init_checks(), &quot;&quot;);
 170   assert(adapter() != NULL, &quot;must have&quot;);
 171   return adapter()-&gt;get_c2i_no_clinit_check_entry();
 172 }
 173 
 174 char* Method::name_and_sig_as_C_string() const {
 175   return name_and_sig_as_C_string(constants()-&gt;pool_holder(), name(), signature());
 176 }
 177 
 178 char* Method::name_and_sig_as_C_string(char* buf, int size) const {
 179   return name_and_sig_as_C_string(constants()-&gt;pool_holder(), name(), signature(), buf, size);
 180 }
 181 
 182 char* Method::name_and_sig_as_C_string(Klass* klass, Symbol* method_name, Symbol* signature) {
 183   const char* klass_name = klass-&gt;external_name();
 184   int klass_name_len  = (int)strlen(klass_name);
 185   int method_name_len = method_name-&gt;utf8_length();
 186   int len             = klass_name_len + 1 + method_name_len + signature-&gt;utf8_length();
 187   char* dest          = NEW_RESOURCE_ARRAY(char, len + 1);
 188   strcpy(dest, klass_name);
 189   dest[klass_name_len] = &#39;.&#39;;
 190   strcpy(&amp;dest[klass_name_len + 1], method_name-&gt;as_C_string());
 191   strcpy(&amp;dest[klass_name_len + 1 + method_name_len], signature-&gt;as_C_string());
 192   dest[len] = 0;
 193   return dest;
 194 }
 195 
 196 char* Method::name_and_sig_as_C_string(Klass* klass, Symbol* method_name, Symbol* signature, char* buf, int size) {
 197   Symbol* klass_name = klass-&gt;name();
 198   klass_name-&gt;as_klass_external_name(buf, size);
 199   int len = (int)strlen(buf);
 200 
 201   if (len &lt; size - 1) {
 202     buf[len++] = &#39;.&#39;;
 203 
 204     method_name-&gt;as_C_string(&amp;(buf[len]), size - len);
 205     len = (int)strlen(buf);
 206 
 207     signature-&gt;as_C_string(&amp;(buf[len]), size - len);
 208   }
 209 
 210   return buf;
 211 }
 212 
 213 const char* Method::external_name() const {
 214   return external_name(constants()-&gt;pool_holder(), name(), signature());
 215 }
 216 
 217 void Method::print_external_name(outputStream *os) const {
 218   print_external_name(os, constants()-&gt;pool_holder(), name(), signature());
 219 }
 220 
 221 const char* Method::external_name(Klass* klass, Symbol* method_name, Symbol* signature) {
 222   stringStream ss;
 223   print_external_name(&amp;ss, klass, method_name, signature);
 224   return ss.as_string();
 225 }
 226 
 227 void Method::print_external_name(outputStream *os, Klass* klass, Symbol* method_name, Symbol* signature) {
 228   signature-&gt;print_as_signature_external_return_type(os);
 229   os-&gt;print(&quot; %s.%s(&quot;, klass-&gt;external_name(), method_name-&gt;as_C_string());
 230   signature-&gt;print_as_signature_external_parameters(os);
 231   os-&gt;print(&quot;)&quot;);
 232 }
 233 
 234 int Method::fast_exception_handler_bci_for(const methodHandle&amp; mh, Klass* ex_klass, int throw_bci, TRAPS) {
 235   // exception table holds quadruple entries of the form (beg_bci, end_bci, handler_bci, klass_index)
 236   // access exception table
 237   ExceptionTable table(mh());
 238   int length = table.length();
 239   // iterate through all entries sequentially
 240   constantPoolHandle pool(THREAD, mh-&gt;constants());
 241   for (int i = 0; i &lt; length; i ++) {
 242     //reacquire the table in case a GC happened
 243     ExceptionTable table(mh());
 244     int beg_bci = table.start_pc(i);
 245     int end_bci = table.end_pc(i);
 246     assert(beg_bci &lt;= end_bci, &quot;inconsistent exception table&quot;);
 247     if (beg_bci &lt;= throw_bci &amp;&amp; throw_bci &lt; end_bci) {
 248       // exception handler bci range covers throw_bci =&gt; investigate further
 249       int handler_bci = table.handler_pc(i);
 250       int klass_index = table.catch_type_index(i);
 251       if (klass_index == 0) {
 252         return handler_bci;
 253       } else if (ex_klass == NULL) {
 254         return handler_bci;
 255       } else {
 256         // we know the exception class =&gt; get the constraint class
 257         // this may require loading of the constraint class; if verification
 258         // fails or some other exception occurs, return handler_bci
 259         Klass* k = pool-&gt;klass_at(klass_index, CHECK_(handler_bci));
 260         assert(k != NULL, &quot;klass not loaded&quot;);
 261         if (ex_klass-&gt;is_subtype_of(k)) {
 262           return handler_bci;
 263         }
 264       }
 265     }
 266   }
 267 
 268   return -1;
 269 }
 270 
 271 void Method::mask_for(int bci, InterpreterOopMap* mask) {
 272   methodHandle h_this(Thread::current(), this);
 273   // Only GC uses the OopMapCache during thread stack root scanning
 274   // any other uses generate an oopmap but do not save it in the cache.
 275   if (Universe::heap()-&gt;is_gc_active()) {
 276     method_holder()-&gt;mask_for(h_this, bci, mask);
 277   } else {
 278     OopMapCache::compute_one_oop_map(h_this, bci, mask);
 279   }
 280   return;
 281 }
 282 
 283 
 284 int Method::bci_from(address bcp) const {
 285   if (is_native() &amp;&amp; bcp == 0) {
 286     return 0;
 287   }
 288 #ifdef ASSERT
 289   {
 290     ResourceMark rm;
 291     assert(is_native() &amp;&amp; bcp == code_base() || contains(bcp) || VMError::is_error_reported(),
 292            &quot;bcp doesn&#39;t belong to this method: bcp: &quot; INTPTR_FORMAT &quot;, method: %s&quot;,
 293            p2i(bcp), name_and_sig_as_C_string());
 294   }
 295 #endif
 296   return bcp - code_base();
 297 }
 298 
 299 
 300 int Method::validate_bci(int bci) const {
 301   return (bci == 0 || bci &lt; code_size()) ? bci : -1;
 302 }
 303 
 304 // Return bci if it appears to be a valid bcp
 305 // Return -1 otherwise.
 306 // Used by profiling code, when invalid data is a possibility.
 307 // The caller is responsible for validating the Method* itself.
 308 int Method::validate_bci_from_bcp(address bcp) const {
 309   // keep bci as -1 if not a valid bci
 310   int bci = -1;
 311   if (bcp == 0 || bcp == code_base()) {
 312     // code_size() may return 0 and we allow 0 here
 313     // the method may be native
 314     bci = 0;
 315   } else if (contains(bcp)) {
 316     bci = bcp - code_base();
 317   }
 318   // Assert that if we have dodged any asserts, bci is negative.
 319   assert(bci == -1 || bci == bci_from(bcp_from(bci)), &quot;sane bci if &gt;=0&quot;);
 320   return bci;
 321 }
 322 
 323 address Method::bcp_from(int bci) const {
 324   assert((is_native() &amp;&amp; bci == 0) || (!is_native() &amp;&amp; 0 &lt;= bci &amp;&amp; bci &lt; code_size()),
 325          &quot;illegal bci: %d for %s method&quot;, bci, is_native() ? &quot;native&quot; : &quot;non-native&quot;);
 326   address bcp = code_base() + bci;
 327   assert(is_native() &amp;&amp; bcp == code_base() || contains(bcp), &quot;bcp doesn&#39;t belong to this method&quot;);
 328   return bcp;
 329 }
 330 
 331 address Method::bcp_from(address bcp) const {
 332   if (is_native() &amp;&amp; bcp == NULL) {
 333     return code_base();
 334   } else {
 335     return bcp;
 336   }
 337 }
 338 
 339 int Method::size(bool is_native) {
 340   // If native, then include pointers for native_function and signature_handler
 341   int extra_bytes = (is_native) ? 2*sizeof(address*) : 0;
 342   int extra_words = align_up(extra_bytes, BytesPerWord) / BytesPerWord;
 343   return align_metadata_size(header_size() + extra_words);
 344 }
 345 
 346 Symbol* Method::klass_name() const {
 347   return method_holder()-&gt;name();
 348 }
 349 
 350 void Method::metaspace_pointers_do(MetaspaceClosure* it) {
 351   log_trace(cds)(&quot;Iter(Method): %p&quot;, this);
 352 
 353   it-&gt;push(&amp;_constMethod);
 354   it-&gt;push(&amp;_method_data);
 355   it-&gt;push(&amp;_method_counters);
 356 
 357   Method* this_ptr = this;
 358   it-&gt;push_method_entry(&amp;this_ptr, (intptr_t*)&amp;_i2i_entry);
 359   it-&gt;push_method_entry(&amp;this_ptr, (intptr_t*)&amp;_from_compiled_entry);
<a name="5" id="anc5"></a><span class="line-added"> 360   it-&gt;push_method_entry(&amp;this_ptr, (intptr_t*)&amp;_from_compiled_inline_ro_entry);</span>
<span class="line-added"> 361   it-&gt;push_method_entry(&amp;this_ptr, (intptr_t*)&amp;_from_compiled_inline_entry);</span>
 362   it-&gt;push_method_entry(&amp;this_ptr, (intptr_t*)&amp;_from_interpreted_entry);
 363 }
 364 
 365 // Attempt to return method oop to original state.  Clear any pointers
 366 // (to objects outside the shared spaces).  We won&#39;t be able to predict
 367 // where they should point in a new JVM.  Further initialize some
 368 // entries now in order allow them to be write protected later.
 369 
 370 void Method::remove_unshareable_info() {
 371   unlink_method();
 372   JFR_ONLY(REMOVE_METHOD_ID(this);)
 373 }
 374 
 375 void Method::set_vtable_index(int index) {
 376   if (is_shared() &amp;&amp; !MetaspaceShared::remapped_readwrite()) {
 377     // At runtime initialize_vtable is rerun as part of link_class_impl()
 378     // for a shared class loaded by the non-boot loader to obtain the loader
 379     // constraints based on the runtime classloaders&#39; context.
 380     return; // don&#39;t write into the shared class
 381   } else {
 382     _vtable_index = index;
 383   }
 384 }
 385 
 386 void Method::set_itable_index(int index) {
 387   if (is_shared() &amp;&amp; !MetaspaceShared::remapped_readwrite()) {
 388     // At runtime initialize_itable is rerun as part of link_class_impl()
 389     // for a shared class loaded by the non-boot loader to obtain the loader
 390     // constraints based on the runtime classloaders&#39; context. The dumptime
 391     // itable index should be the same as the runtime index.
 392     assert(_vtable_index == itable_index_max - index,
 393            &quot;archived itable index is different from runtime index&quot;);
 394     return; // don’t write into the shared class
 395   } else {
 396     _vtable_index = itable_index_max - index;
 397   }
 398   assert(valid_itable_index(), &quot;&quot;);
 399 }
 400 
 401 // The RegisterNatives call being attempted tried to register with a method that
 402 // is not native.  Ask JVM TI what prefixes have been specified.  Then check
 403 // to see if the native method is now wrapped with the prefixes.  See the
 404 // SetNativeMethodPrefix(es) functions in the JVM TI Spec for details.
 405 static Method* find_prefixed_native(Klass* k, Symbol* name, Symbol* signature, TRAPS) {
 406 #if INCLUDE_JVMTI
 407   ResourceMark rm(THREAD);
 408   Method* method;
 409   int name_len = name-&gt;utf8_length();
 410   char* name_str = name-&gt;as_utf8();
 411   int prefix_count;
 412   char** prefixes = JvmtiExport::get_all_native_method_prefixes(&amp;prefix_count);
 413   for (int i = 0; i &lt; prefix_count; i++) {
 414     char* prefix = prefixes[i];
 415     int prefix_len = (int)strlen(prefix);
 416 
 417     // try adding this prefix to the method name and see if it matches another method name
 418     int trial_len = name_len + prefix_len;
 419     char* trial_name_str = NEW_RESOURCE_ARRAY(char, trial_len + 1);
 420     strcpy(trial_name_str, prefix);
 421     strcat(trial_name_str, name_str);
 422     TempNewSymbol trial_name = SymbolTable::probe(trial_name_str, trial_len);
 423     if (trial_name == NULL) {
 424       continue; // no such symbol, so this prefix wasn&#39;t used, try the next prefix
 425     }
 426     method = k-&gt;lookup_method(trial_name, signature);
 427     if (method == NULL) {
 428       continue; // signature doesn&#39;t match, try the next prefix
 429     }
 430     if (method-&gt;is_native()) {
 431       method-&gt;set_is_prefixed_native();
 432       return method; // wahoo, we found a prefixed version of the method, return it
 433     }
 434     // found as non-native, so prefix is good, add it, probably just need more prefixes
 435     name_len = trial_len;
 436     name_str = trial_name_str;
 437   }
 438 #endif // INCLUDE_JVMTI
 439   return NULL; // not found
 440 }
 441 
 442 bool Method::register_native(Klass* k, Symbol* name, Symbol* signature, address entry, TRAPS) {
 443   Method* method = k-&gt;lookup_method(name, signature);
 444   if (method == NULL) {
 445     ResourceMark rm(THREAD);
 446     stringStream st;
 447     st.print(&quot;Method &#39;&quot;);
 448     print_external_name(&amp;st, k, name, signature);
 449     st.print(&quot;&#39; name or signature does not match&quot;);
 450     THROW_MSG_(vmSymbols::java_lang_NoSuchMethodError(), st.as_string(), false);
 451   }
 452   if (!method-&gt;is_native()) {
 453     // trying to register to a non-native method, see if a JVM TI agent has added prefix(es)
 454     method = find_prefixed_native(k, name, signature, THREAD);
 455     if (method == NULL) {
 456       ResourceMark rm(THREAD);
 457       stringStream st;
 458       st.print(&quot;Method &#39;&quot;);
 459       print_external_name(&amp;st, k, name, signature);
 460       st.print(&quot;&#39; is not declared as native&quot;);
 461       THROW_MSG_(vmSymbols::java_lang_NoSuchMethodError(), st.as_string(), false);
 462     }
 463   }
 464 
 465   if (entry != NULL) {
 466     method-&gt;set_native_function(entry, native_bind_event_is_interesting);
 467   } else {
 468     method-&gt;clear_native_function();
 469   }
 470   if (log_is_enabled(Debug, jni, resolve)) {
 471     ResourceMark rm(THREAD);
 472     log_debug(jni, resolve)(&quot;[Registering JNI native method %s.%s]&quot;,
 473                             method-&gt;method_holder()-&gt;external_name(),
 474                             method-&gt;name()-&gt;as_C_string());
 475   }
 476   return true;
 477 }
 478 
 479 bool Method::was_executed_more_than(int n) {
 480   // Invocation counter is reset when the Method* is compiled.
 481   // If the method has compiled code we therefore assume it has
 482   // be excuted more than n times.
 483   if (is_accessor() || is_empty_method() || (code() != NULL)) {
 484     // interpreter doesn&#39;t bump invocation counter of trivial methods
 485     // compiler does not bump invocation counter of compiled methods
 486     return true;
 487   }
 488   else if ((method_counters() != NULL &amp;&amp;
 489             method_counters()-&gt;invocation_counter()-&gt;carry()) ||
 490            (method_data() != NULL &amp;&amp;
 491             method_data()-&gt;invocation_counter()-&gt;carry())) {
 492     // The carry bit is set when the counter overflows and causes
 493     // a compilation to occur.  We don&#39;t know how many times
 494     // the counter has been reset, so we simply assume it has
 495     // been executed more than n times.
 496     return true;
 497   } else {
 498     return invocation_count() &gt; n;
 499   }
 500 }
 501 
 502 void Method::print_invocation_count() {
 503   if (is_static()) tty-&gt;print(&quot;static &quot;);
 504   if (is_final()) tty-&gt;print(&quot;final &quot;);
 505   if (is_synchronized()) tty-&gt;print(&quot;synchronized &quot;);
 506   if (is_native()) tty-&gt;print(&quot;native &quot;);
 507   tty-&gt;print(&quot;%s::&quot;, method_holder()-&gt;external_name());
 508   name()-&gt;print_symbol_on(tty);
 509   signature()-&gt;print_symbol_on(tty);
 510 
 511   if (WizardMode) {
 512     // dump the size of the byte codes
 513     tty-&gt;print(&quot; {%d}&quot;, code_size());
 514   }
 515   tty-&gt;cr();
 516 
 517   tty-&gt;print_cr (&quot;  interpreter_invocation_count: %8d &quot;, interpreter_invocation_count());
 518   tty-&gt;print_cr (&quot;  invocation_counter:           %8d &quot;, invocation_count());
 519   tty-&gt;print_cr (&quot;  backedge_counter:             %8d &quot;, backedge_count());
 520 #ifndef PRODUCT
 521   if (CountCompiledCalls) {
 522     tty-&gt;print_cr (&quot;  compiled_invocation_count: %8d &quot;, compiled_invocation_count());
 523   }
 524 #endif
 525 }
 526 
 527 // Build a MethodData* object to hold information about this method
 528 // collected in the interpreter.
 529 void Method::build_interpreter_method_data(const methodHandle&amp; method, TRAPS) {
 530   // Do not profile the method if metaspace has hit an OOM previously
 531   // allocating profiling data. Callers clear pending exception so don&#39;t
 532   // add one here.
 533   if (ClassLoaderDataGraph::has_metaspace_oom()) {
 534     return;
 535   }
 536 
 537   // Grab a lock here to prevent multiple
 538   // MethodData*s from being created.
 539   MutexLocker ml(THREAD, MethodData_lock);
 540   if (method-&gt;method_data() == NULL) {
 541     ClassLoaderData* loader_data = method-&gt;method_holder()-&gt;class_loader_data();
 542     MethodData* method_data = MethodData::allocate(loader_data, method, THREAD);
 543     if (HAS_PENDING_EXCEPTION) {
 544       CompileBroker::log_metaspace_failure();
 545       ClassLoaderDataGraph::set_metaspace_oom(true);
 546       return;   // return the exception (which is cleared)
 547     }
 548 
 549     method-&gt;set_method_data(method_data);
 550     if (PrintMethodData &amp;&amp; (Verbose || WizardMode)) {
 551       ResourceMark rm(THREAD);
 552       tty-&gt;print(&quot;build_interpreter_method_data for &quot;);
 553       method-&gt;print_name(tty);
 554       tty-&gt;cr();
 555       // At the end of the run, the MDO, full of data, will be dumped.
 556     }
 557   }
 558 }
 559 
 560 MethodCounters* Method::build_method_counters(Method* m, TRAPS) {
 561   // Do not profile the method if metaspace has hit an OOM previously
 562   if (ClassLoaderDataGraph::has_metaspace_oom()) {
 563     return NULL;
 564   }
 565 
 566   methodHandle mh(THREAD, m);
 567   MethodCounters* counters = MethodCounters::allocate(mh, THREAD);
 568   if (HAS_PENDING_EXCEPTION) {
 569     CompileBroker::log_metaspace_failure();
 570     ClassLoaderDataGraph::set_metaspace_oom(true);
 571     return NULL;   // return the exception (which is cleared)
 572   }
 573   if (!mh-&gt;init_method_counters(counters)) {
 574     MetadataFactory::free_metadata(mh-&gt;method_holder()-&gt;class_loader_data(), counters);
 575   }
 576 
 577   if (LogTouchedMethods) {
 578     mh-&gt;log_touched(CHECK_NULL);
 579   }
 580 
 581   return mh-&gt;method_counters();
 582 }
 583 
 584 bool Method::init_method_counters(MethodCounters* counters) {
 585   // Try to install a pointer to MethodCounters, return true on success.
 586   return Atomic::replace_if_null(&amp;_method_counters, counters);
 587 }
 588 
 589 int Method::extra_stack_words() {
 590   // not an inline function, to avoid a header dependency on Interpreter
 591   return extra_stack_entries() * Interpreter::stackElementSize;
 592 }
 593 
 594 // Derive size of parameters, return type, and fingerprint,
 595 // all in one pass, which is run at load time.
 596 // We need the first two, and might as well grab the third.
 597 void Method::compute_from_signature(Symbol* sig) {
 598   // At this point, since we are scanning the signature,
 599   // we might as well compute the whole fingerprint.
 600   Fingerprinter fp(sig, is_static());
 601   set_size_of_parameters(fp.size_of_parameters());
 602   constMethod()-&gt;set_result_type(fp.return_type());
 603   constMethod()-&gt;set_fingerprint(fp.fingerprint());
 604 }
 605 
<a name="6" id="anc6"></a><span class="line-added"> 606 // InlineKlass the method is declared to return. This must not</span>
<span class="line-added"> 607 // safepoint as it is called with references live on the stack at</span>
<span class="line-added"> 608 // locations the GC is unaware of.</span>
<span class="line-added"> 609 InlineKlass* Method::returned_inline_type(Thread* thread) const {</span>
<span class="line-added"> 610   SignatureStream ss(signature());</span>
<span class="line-added"> 611   while (!ss.at_return_type()) {</span>
<span class="line-added"> 612     ss.next();</span>
<span class="line-added"> 613   }</span>
<span class="line-added"> 614   Handle class_loader(thread, method_holder()-&gt;class_loader());</span>
<span class="line-added"> 615   Handle protection_domain(thread, method_holder()-&gt;protection_domain());</span>
<span class="line-added"> 616   Klass* k = NULL;</span>
<span class="line-added"> 617   {</span>
<span class="line-added"> 618     NoSafepointVerifier nsv;</span>
<span class="line-added"> 619     k = ss.as_klass(class_loader, protection_domain, SignatureStream::ReturnNull, thread);</span>
<span class="line-added"> 620   }</span>
<span class="line-added"> 621   assert(k != NULL &amp;&amp; !thread-&gt;has_pending_exception(), &quot;can&#39;t resolve klass&quot;);</span>
<span class="line-added"> 622   return InlineKlass::cast(k);</span>
<span class="line-added"> 623 }</span>
 624 bool Method::is_empty_method() const {
 625   return  code_size() == 1
 626       &amp;&amp; *code_base() == Bytecodes::_return;
 627 }
 628 
 629 bool Method::is_vanilla_constructor() const {
 630   // Returns true if this method is a vanilla constructor, i.e. an &quot;&lt;init&gt;&quot; &quot;()V&quot; method
 631   // which only calls the superclass vanilla constructor and possibly does stores of
 632   // zero constants to local fields:
 633   //
<a name="7" id="anc7"></a><span class="line-modified"> 634   //   aload_0, _fast_aload_0, or _nofast_aload_0</span>
 635   //   invokespecial
 636   //   indexbyte1
 637   //   indexbyte2
 638   //
 639   // followed by an (optional) sequence of:
 640   //
 641   //   aload_0
 642   //   aconst_null / iconst_0 / fconst_0 / dconst_0
 643   //   putfield
 644   //   indexbyte1
 645   //   indexbyte2
 646   //
 647   // followed by:
 648   //
 649   //   return
 650 
 651   assert(name() == vmSymbols::object_initializer_name(),    &quot;Should only be called for default constructors&quot;);
 652   assert(signature() == vmSymbols::void_method_signature(), &quot;Should only be called for default constructors&quot;);
 653   int size = code_size();
 654   // Check if size match
 655   if (size == 0 || size % 5 != 0) return false;
 656   address cb = code_base();
 657   int last = size - 1;
<a name="8" id="anc8"></a><span class="line-modified"> 658   if ((cb[0] != Bytecodes::_aload_0 &amp;&amp; cb[0] != Bytecodes::_fast_aload_0 &amp;&amp; cb[0] != Bytecodes::_nofast_aload_0) ||</span>
<span class="line-added"> 659        cb[1] != Bytecodes::_invokespecial || cb[last] != Bytecodes::_return) {</span>
 660     // Does not call superclass default constructor
 661     return false;
 662   }
 663   // Check optional sequence
 664   for (int i = 4; i &lt; last; i += 5) {
 665     if (cb[i] != Bytecodes::_aload_0) return false;
 666     if (!Bytecodes::is_zero_const(Bytecodes::cast(cb[i+1]))) return false;
 667     if (cb[i+2] != Bytecodes::_putfield) return false;
 668   }
 669   return true;
 670 }
 671 
 672 
 673 bool Method::compute_has_loops_flag() {
 674   BytecodeStream bcs(methodHandle(Thread::current(), this));
 675   Bytecodes::Code bc;
 676 
 677   while ((bc = bcs.next()) &gt;= 0) {
 678     switch( bc ) {
 679       case Bytecodes::_ifeq:
 680       case Bytecodes::_ifnull:
 681       case Bytecodes::_iflt:
 682       case Bytecodes::_ifle:
 683       case Bytecodes::_ifne:
 684       case Bytecodes::_ifnonnull:
 685       case Bytecodes::_ifgt:
 686       case Bytecodes::_ifge:
 687       case Bytecodes::_if_icmpeq:
 688       case Bytecodes::_if_icmpne:
 689       case Bytecodes::_if_icmplt:
 690       case Bytecodes::_if_icmpgt:
 691       case Bytecodes::_if_icmple:
 692       case Bytecodes::_if_icmpge:
 693       case Bytecodes::_if_acmpeq:
 694       case Bytecodes::_if_acmpne:
 695       case Bytecodes::_goto:
 696       case Bytecodes::_jsr:
 697         if( bcs.dest() &lt; bcs.next_bci() ) _access_flags.set_has_loops();
 698         break;
 699 
 700       case Bytecodes::_goto_w:
 701       case Bytecodes::_jsr_w:
 702         if( bcs.dest_w() &lt; bcs.next_bci() ) _access_flags.set_has_loops();
 703         break;
 704 
 705       default:
 706         break;
 707     }
 708   }
 709   _access_flags.set_loops_flag_init();
 710   return _access_flags.has_loops();
 711 }
 712 
 713 bool Method::is_final_method(AccessFlags class_access_flags) const {
 714   // or &quot;does_not_require_vtable_entry&quot;
 715   // default method or overpass can occur, is not final (reuses vtable entry)
 716   // private methods in classes get vtable entries for backward class compatibility.
 717   if (is_overpass() || is_default_method())  return false;
 718   return is_final() || class_access_flags.is_final();
 719 }
 720 
 721 bool Method::is_final_method() const {
 722   return is_final_method(method_holder()-&gt;access_flags());
 723 }
 724 
 725 bool Method::is_default_method() const {
 726   if (method_holder() != NULL &amp;&amp;
 727       method_holder()-&gt;is_interface() &amp;&amp;
 728       !is_abstract() &amp;&amp; !is_private()) {
 729     return true;
 730   } else {
 731     return false;
 732   }
 733 }
 734 
 735 bool Method::can_be_statically_bound(AccessFlags class_access_flags) const {
 736   if (is_final_method(class_access_flags))  return true;
 737 #ifdef ASSERT
 738   ResourceMark rm;
 739   bool is_nonv = (vtable_index() == nonvirtual_vtable_index);
 740   if (class_access_flags.is_interface()) {
 741       assert(is_nonv == is_static() || is_nonv == is_private(),
 742              &quot;nonvirtual unexpected for non-static, non-private: %s&quot;,
 743              name_and_sig_as_C_string());
 744   }
 745 #endif
 746   assert(valid_vtable_index() || valid_itable_index(), &quot;method must be linked before we ask this question&quot;);
 747   return vtable_index() == nonvirtual_vtable_index;
 748 }
 749 
 750 bool Method::can_be_statically_bound() const {
 751   return can_be_statically_bound(method_holder()-&gt;access_flags());
 752 }
 753 
 754 bool Method::can_be_statically_bound(InstanceKlass* context) const {
 755   return (method_holder() == context) &amp;&amp; can_be_statically_bound();
 756 }
 757 
 758 bool Method::is_accessor() const {
 759   return is_getter() || is_setter();
 760 }
 761 
 762 bool Method::is_getter() const {
 763   if (code_size() != 5) return false;
 764   if (size_of_parameters() != 1) return false;
 765   if (java_code_at(0) != Bytecodes::_aload_0)  return false;
 766   if (java_code_at(1) != Bytecodes::_getfield) return false;
 767   switch (java_code_at(4)) {
 768     case Bytecodes::_ireturn:
 769     case Bytecodes::_lreturn:
 770     case Bytecodes::_freturn:
 771     case Bytecodes::_dreturn:
 772     case Bytecodes::_areturn:
 773       break;
 774     default:
 775       return false;
 776   }
 777   return true;
 778 }
 779 
 780 bool Method::is_setter() const {
 781   if (code_size() != 6) return false;
 782   if (java_code_at(0) != Bytecodes::_aload_0) return false;
 783   switch (java_code_at(1)) {
 784     case Bytecodes::_iload_1:
 785     case Bytecodes::_aload_1:
 786     case Bytecodes::_fload_1:
 787       if (size_of_parameters() != 2) return false;
 788       break;
 789     case Bytecodes::_dload_1:
 790     case Bytecodes::_lload_1:
 791       if (size_of_parameters() != 3) return false;
 792       break;
 793     default:
 794       return false;
 795   }
 796   if (java_code_at(2) != Bytecodes::_putfield) return false;
 797   if (java_code_at(5) != Bytecodes::_return)   return false;
 798   return true;
 799 }
 800 
 801 bool Method::is_constant_getter() const {
 802   int last_index = code_size() - 1;
 803   // Check if the first 1-3 bytecodes are a constant push
 804   // and the last bytecode is a return.
 805   return (2 &lt;= code_size() &amp;&amp; code_size() &lt;= 4 &amp;&amp;
 806           Bytecodes::is_const(java_code_at(0)) &amp;&amp;
 807           Bytecodes::length_for(java_code_at(0)) == last_index &amp;&amp;
 808           Bytecodes::is_return(java_code_at(last_index)));
 809 }
 810 
<a name="9" id="anc9"></a><span class="line-modified"> 811 bool Method::is_object_constructor_or_class_initializer() const {</span>
<span class="line-modified"> 812   return (is_object_constructor() || is_class_initializer());</span>





 813 }
 814 
<a name="10" id="anc10"></a><span class="line-modified"> 815 bool Method::is_class_initializer() const {</span>
 816   // For classfiles version 51 or greater, ensure that the clinit method is
 817   // static.  Non-static methods with the name &quot;&lt;clinit&gt;&quot; are not static
 818   // initializers. (older classfiles exempted for backward compatibility)
<a name="11" id="anc11"></a><span class="line-modified"> 819   return (name() == vmSymbols::class_initializer_name() &amp;&amp;</span>
<span class="line-modified"> 820           (is_static() ||</span>
<span class="line-added"> 821            method_holder()-&gt;major_version() &lt; 51));</span>
<span class="line-added"> 822 }</span>
<span class="line-added"> 823 </span>
<span class="line-added"> 824 // A method named &lt;init&gt;, if non-static, is a classic object constructor.</span>
<span class="line-added"> 825 bool Method::is_object_constructor() const {</span>
<span class="line-added"> 826    return name() == vmSymbols::object_initializer_name() &amp;&amp; !is_static();</span>
 827 }
 828 
<a name="12" id="anc12"></a><span class="line-modified"> 829 // A static method named &lt;init&gt; is a factory for an inline class.</span>
<span class="line-modified"> 830 bool Method::is_static_init_factory() const {</span>
<span class="line-added"> 831    return name() == vmSymbols::object_initializer_name() &amp;&amp; is_static();</span>
 832 }
 833 
 834 bool Method::needs_clinit_barrier() const {
 835   return is_static() &amp;&amp; !method_holder()-&gt;is_initialized();
 836 }
 837 
 838 objArrayHandle Method::resolved_checked_exceptions_impl(Method* method, TRAPS) {
 839   int length = method-&gt;checked_exceptions_length();
 840   if (length == 0) {  // common case
 841     return objArrayHandle(THREAD, Universe::the_empty_class_klass_array());
 842   } else {
 843     methodHandle h_this(THREAD, method);
 844     objArrayOop m_oop = oopFactory::new_objArray(SystemDictionary::Class_klass(), length, CHECK_(objArrayHandle()));
 845     objArrayHandle mirrors (THREAD, m_oop);
 846     for (int i = 0; i &lt; length; i++) {
 847       CheckedExceptionElement* table = h_this-&gt;checked_exceptions_start(); // recompute on each iteration, not gc safe
 848       Klass* k = h_this-&gt;constants()-&gt;klass_at(table[i].class_cp_index, CHECK_(objArrayHandle()));
 849       if (log_is_enabled(Warning, exceptions) &amp;&amp;
 850           !k-&gt;is_subclass_of(SystemDictionary::Throwable_klass())) {
 851         ResourceMark rm(THREAD);
 852         log_warning(exceptions)(
 853           &quot;Class %s in throws clause of method %s is not a subtype of class java.lang.Throwable&quot;,
 854           k-&gt;external_name(), method-&gt;external_name());
 855       }
 856       mirrors-&gt;obj_at_put(i, k-&gt;java_mirror());
 857     }
 858     return mirrors;
 859   }
 860 };
 861 
 862 
 863 int Method::line_number_from_bci(int bci) const {
 864   int best_bci  =  0;
 865   int best_line = -1;
 866   if (bci == SynchronizationEntryBCI) bci = 0;
 867   if (0 &lt;= bci &amp;&amp; bci &lt; code_size() &amp;&amp; has_linenumber_table()) {
 868     // The line numbers are a short array of 2-tuples [start_pc, line_number].
 869     // Not necessarily sorted and not necessarily one-to-one.
 870     CompressedLineNumberReadStream stream(compressed_linenumber_table());
 871     while (stream.read_pair()) {
 872       if (stream.bci() == bci) {
 873         // perfect match
 874         return stream.line();
 875       } else {
 876         // update best_bci/line
 877         if (stream.bci() &lt; bci &amp;&amp; stream.bci() &gt;= best_bci) {
 878           best_bci  = stream.bci();
 879           best_line = stream.line();
 880         }
 881       }
 882     }
 883   }
 884   return best_line;
 885 }
 886 
 887 
 888 bool Method::is_klass_loaded_by_klass_index(int klass_index) const {
<a name="13" id="anc13"></a><span class="line-modified"> 889   if( constants()-&gt;tag_at(klass_index).is_unresolved_klass()) {</span>
 890     Thread *thread = Thread::current();
 891     Symbol* klass_name = constants()-&gt;klass_name_at(klass_index);
 892     Handle loader(thread, method_holder()-&gt;class_loader());
 893     Handle prot  (thread, method_holder()-&gt;protection_domain());
 894     return SystemDictionary::find(klass_name, loader, prot, thread) != NULL;
 895   } else {
 896     return true;
 897   }
 898 }
 899 
 900 
 901 bool Method::is_klass_loaded(int refinfo_index, bool must_be_resolved) const {
 902   int klass_index = constants()-&gt;klass_ref_index_at(refinfo_index);
 903   if (must_be_resolved) {
 904     // Make sure klass is resolved in constantpool.
<a name="14" id="anc14"></a><span class="line-modified"> 905     if (constants()-&gt;tag_at(klass_index).is_unresolved_klass()) {</span>
<span class="line-added"> 906       return false;</span>
<span class="line-added"> 907     }</span>
 908   }
 909   return is_klass_loaded_by_klass_index(klass_index);
 910 }
 911 
 912 
 913 void Method::set_native_function(address function, bool post_event_flag) {
 914   assert(function != NULL, &quot;use clear_native_function to unregister natives&quot;);
 915   assert(!is_method_handle_intrinsic() || function == SharedRuntime::native_method_throw_unsatisfied_link_error_entry(), &quot;&quot;);
 916   address* native_function = native_function_addr();
 917 
 918   // We can see racers trying to place the same native function into place. Once
 919   // is plenty.
 920   address current = *native_function;
 921   if (current == function) return;
 922   if (post_event_flag &amp;&amp; JvmtiExport::should_post_native_method_bind() &amp;&amp;
 923       function != NULL) {
 924     // native_method_throw_unsatisfied_link_error_entry() should only
 925     // be passed when post_event_flag is false.
 926     assert(function !=
 927       SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
 928       &quot;post_event_flag mis-match&quot;);
 929 
 930     // post the bind event, and possible change the bind function
 931     JvmtiExport::post_native_method_bind(this, &amp;function);
 932   }
 933   *native_function = function;
 934   // This function can be called more than once. We must make sure that we always
 935   // use the latest registered method -&gt; check if a stub already has been generated.
 936   // If so, we have to make it not_entrant.
 937   CompiledMethod* nm = code(); // Put it into local variable to guard against concurrent updates
 938   if (nm != NULL) {
 939     nm-&gt;make_not_entrant();
 940   }
 941 }
 942 
 943 
 944 bool Method::has_native_function() const {
 945   if (is_method_handle_intrinsic())
 946     return false;  // special-cased in SharedRuntime::generate_native_wrapper
 947   address func = native_function();
 948   return (func != NULL &amp;&amp; func != SharedRuntime::native_method_throw_unsatisfied_link_error_entry());
 949 }
 950 
 951 
 952 void Method::clear_native_function() {
 953   // Note: is_method_handle_intrinsic() is allowed here.
 954   set_native_function(
 955     SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
 956     !native_bind_event_is_interesting);
 957   this-&gt;unlink_code();
 958 }
 959 
 960 
 961 void Method::set_signature_handler(address handler) {
 962   address* signature_handler =  signature_handler_addr();
 963   *signature_handler = handler;
 964 }
 965 
 966 
 967 void Method::print_made_not_compilable(int comp_level, bool is_osr, bool report, const char* reason) {
 968   assert(reason != NULL, &quot;must provide a reason&quot;);
 969   if (PrintCompilation &amp;&amp; report) {
 970     ttyLocker ttyl;
 971     tty-&gt;print(&quot;made not %scompilable on &quot;, is_osr ? &quot;OSR &quot; : &quot;&quot;);
 972     if (comp_level == CompLevel_all) {
 973       tty-&gt;print(&quot;all levels &quot;);
 974     } else {
 975       tty-&gt;print(&quot;level %d &quot;, comp_level);
 976     }
 977     this-&gt;print_short_name(tty);
 978     int size = this-&gt;code_size();
 979     if (size &gt; 0) {
 980       tty-&gt;print(&quot; (%d bytes)&quot;, size);
 981     }
 982     if (reason != NULL) {
 983       tty-&gt;print(&quot;   %s&quot;, reason);
 984     }
 985     tty-&gt;cr();
 986   }
 987   if ((TraceDeoptimization || LogCompilation) &amp;&amp; (xtty != NULL)) {
 988     ttyLocker ttyl;
 989     xtty-&gt;begin_elem(&quot;make_not_compilable thread=&#39;&quot; UINTX_FORMAT &quot;&#39; osr=&#39;%d&#39; level=&#39;%d&#39;&quot;,
 990                      os::current_thread_id(), is_osr, comp_level);
 991     if (reason != NULL) {
 992       xtty-&gt;print(&quot; reason=\&#39;%s\&#39;&quot;, reason);
 993     }
 994     xtty-&gt;method(this);
 995     xtty-&gt;stamp();
 996     xtty-&gt;end_elem();
 997   }
 998 }
 999 
1000 bool Method::is_always_compilable() const {
1001   // Generated adapters must be compiled
1002   if (is_method_handle_intrinsic() &amp;&amp; is_synthetic()) {
1003     assert(!is_not_c1_compilable(), &quot;sanity check&quot;);
1004     assert(!is_not_c2_compilable(), &quot;sanity check&quot;);
1005     return true;
1006   }
1007 
1008   return false;
1009 }
1010 
1011 bool Method::is_not_compilable(int comp_level) const {
1012   if (number_of_breakpoints() &gt; 0)
1013     return true;
1014   if (is_always_compilable())
1015     return false;
1016   if (comp_level == CompLevel_any)
1017     return is_not_c1_compilable() || is_not_c2_compilable();
1018   if (is_c1_compile(comp_level))
1019     return is_not_c1_compilable();
1020   if (is_c2_compile(comp_level))
1021     return is_not_c2_compilable();
1022   return false;
1023 }
1024 
1025 // call this when compiler finds that this method is not compilable
1026 void Method::set_not_compilable(const char* reason, int comp_level, bool report) {
1027   if (is_always_compilable()) {
1028     // Don&#39;t mark a method which should be always compilable
1029     return;
1030   }
1031   print_made_not_compilable(comp_level, /*is_osr*/ false, report, reason);
1032   if (comp_level == CompLevel_all) {
1033     set_not_c1_compilable();
1034     set_not_c2_compilable();
1035   } else {
1036     if (is_c1_compile(comp_level))
1037       set_not_c1_compilable();
1038     if (is_c2_compile(comp_level))
1039       set_not_c2_compilable();
1040   }
1041   assert(!CompilationPolicy::can_be_compiled(methodHandle(Thread::current(), this), comp_level), &quot;sanity check&quot;);
1042 }
1043 
1044 bool Method::is_not_osr_compilable(int comp_level) const {
1045   if (is_not_compilable(comp_level))
1046     return true;
1047   if (comp_level == CompLevel_any)
1048     return is_not_c1_osr_compilable() || is_not_c2_osr_compilable();
1049   if (is_c1_compile(comp_level))
1050     return is_not_c1_osr_compilable();
1051   if (is_c2_compile(comp_level))
1052     return is_not_c2_osr_compilable();
1053   return false;
1054 }
1055 
1056 void Method::set_not_osr_compilable(const char* reason, int comp_level, bool report) {
1057   print_made_not_compilable(comp_level, /*is_osr*/ true, report, reason);
1058   if (comp_level == CompLevel_all) {
1059     set_not_c1_osr_compilable();
1060     set_not_c2_osr_compilable();
1061   } else {
1062     if (is_c1_compile(comp_level))
1063       set_not_c1_osr_compilable();
1064     if (is_c2_compile(comp_level))
1065       set_not_c2_osr_compilable();
1066   }
1067   assert(!CompilationPolicy::can_be_osr_compiled(methodHandle(Thread::current(), this), comp_level), &quot;sanity check&quot;);
1068 }
1069 
1070 // Revert to using the interpreter and clear out the nmethod
1071 void Method::clear_code() {
1072   // this may be NULL if c2i adapters have not been made yet
1073   // Only should happen at allocate time.
1074   if (adapter() == NULL) {
1075     _from_compiled_entry    = NULL;
<a name="15" id="anc15"></a><span class="line-added">1076     _from_compiled_inline_entry = NULL;</span>
<span class="line-added">1077     _from_compiled_inline_ro_entry = NULL;</span>
1078   } else {
1079     _from_compiled_entry    = adapter()-&gt;get_c2i_entry();
<a name="16" id="anc16"></a><span class="line-added">1080     _from_compiled_inline_entry = adapter()-&gt;get_c2i_inline_entry();</span>
<span class="line-added">1081     _from_compiled_inline_ro_entry = adapter()-&gt;get_c2i_inline_ro_entry();</span>
1082   }
1083   OrderAccess::storestore();
1084   _from_interpreted_entry = _i2i_entry;
1085   OrderAccess::storestore();
1086   _code = NULL;
1087 }
1088 
1089 void Method::unlink_code(CompiledMethod *compare) {
1090   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1091   // We need to check if either the _code or _from_compiled_code_entry_point
1092   // refer to this nmethod because there is a race in setting these two fields
1093   // in Method* as seen in bugid 4947125.
1094   // If the vep() points to the zombie nmethod, the memory for the nmethod
1095   // could be flushed and the compiler and vtable stubs could still call
1096   // through it.
1097   if (code() == compare ||
1098       from_compiled_entry() == compare-&gt;verified_entry_point()) {
1099     clear_code();
1100   }
1101 }
1102 
1103 void Method::unlink_code() {
1104   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1105   clear_code();
1106 }
1107 
1108 #if INCLUDE_CDS
1109 // Called by class data sharing to remove any entry points (which are not shared)
1110 void Method::unlink_method() {
1111   _code = NULL;
1112 
1113   Arguments::assert_is_dumping_archive();
1114   // Set the values to what they should be at run time. Note that
1115   // this Method can no longer be executed during dump time.
1116   _i2i_entry = Interpreter::entry_for_cds_method(methodHandle(Thread::current(), this));
1117   _from_interpreted_entry = _i2i_entry;
1118 
1119   if (DynamicDumpSharedSpaces) {
1120     assert(_from_compiled_entry != NULL, &quot;sanity&quot;);
1121   } else {
1122     // TODO: Simplify the adapter trampoline allocation for static archiving.
1123     //       Remove the use of CDSAdapterHandlerEntry.
1124     CDSAdapterHandlerEntry* cds_adapter = (CDSAdapterHandlerEntry*)adapter();
1125     constMethod()-&gt;set_adapter_trampoline(cds_adapter-&gt;get_adapter_trampoline());
<a name="17" id="anc17"></a><span class="line-added">1126 </span>
1127     _from_compiled_entry = cds_adapter-&gt;get_c2i_entry_trampoline();
1128     assert(*((int*)_from_compiled_entry) == 0,
<a name="18" id="anc18"></a><span class="line-modified">1129            &quot;instructions must be zeros during dump time, to be initialized at run time&quot;);</span>
<span class="line-added">1130 </span>
<span class="line-added">1131     _from_compiled_inline_ro_entry = cds_adapter-&gt;get_c2i_inline_ro_entry_trampoline();</span>
<span class="line-added">1132     assert(*((int*)_from_compiled_inline_ro_entry) == 0,</span>
<span class="line-added">1133            &quot;instructions must be zeros during dump time, to be initialized at run time&quot;);</span>
<span class="line-added">1134 </span>
<span class="line-added">1135     _from_compiled_inline_entry = cds_adapter-&gt;get_c2i_inline_entry_trampoline();</span>
<span class="line-added">1136     assert(*((int*)_from_compiled_inline_entry) == 0,</span>
<span class="line-added">1137            &quot;instructions must be zeros during dump time, to be initialized at run time&quot;);</span>
1138   }
1139 
1140   if (is_native()) {
1141     *native_function_addr() = NULL;
1142     set_signature_handler(NULL);
1143   }
1144   NOT_PRODUCT(set_compiled_invocation_count(0);)
1145 
1146   set_method_data(NULL);
1147   clear_method_counters();
1148 }
1149 #endif
1150 
1151 /****************************************************************************
1152 // The following illustrates how the entries work for CDS shared Methods:
1153 //
1154 // Our goal is to delay writing into a shared Method until it&#39;s compiled.
1155 // Hence, we want to determine the initial values for _i2i_entry,
1156 // _from_interpreted_entry and _from_compiled_entry during CDS dump time.
1157 //
1158 // In this example, both Methods A and B have the _i2i_entry of &quot;zero_locals&quot;.
1159 // They also have similar signatures so that they will share the same
1160 // AdapterHandlerEntry.
1161 //
1162 // _adapter_trampoline points to a fixed location in the RW section of
1163 // the CDS archive. This location initially contains a NULL pointer. When the
1164 // first of method A or B is linked, an AdapterHandlerEntry is allocated
1165 // dynamically, and its c2i/i2c entries are generated.
1166 //
1167 // _i2i_entry and _from_interpreted_entry initially points to the same
1168 // (fixed) location in the CODE section of the CDS archive. This contains
1169 // an unconditional branch to the actual entry for &quot;zero_locals&quot;, which is
1170 // generated at run time and may be on an arbitrary address. Thus, the
1171 // unconditional branch is also generated at run time to jump to the correct
1172 // address.
1173 //
1174 // Similarly, _from_compiled_entry points to a fixed address in the CODE
1175 // section. This address has enough space for an unconditional branch
1176 // instruction, and is initially zero-filled. After the AdapterHandlerEntry is
1177 // initialized, and the address for the actual c2i_entry is known, we emit a
1178 // branch instruction here to branch to the actual c2i_entry.
1179 //
1180 // The effect of the extra branch on the i2i and c2i entries is negligible.
1181 //
1182 // The reason for putting _adapter_trampoline in RO is many shared Methods
1183 // share the same AdapterHandlerEntry, so we can save space in the RW section
1184 // by having the extra indirection.
1185 
1186 
1187 [Method A: RW]
1188   _constMethod ----&gt; [ConstMethod: RO]
1189                        _adapter_trampoline -----------+
1190                                                       |
1191   _i2i_entry              (same value as method B)    |
1192   _from_interpreted_entry (same value as method B)    |
1193   _from_compiled_entry    (same value as method B)    |
1194                                                       |
1195                                                       |
1196 [Method B: RW]                               +--------+
1197   _constMethod ----&gt; [ConstMethod: RO]       |
1198                        _adapter_trampoline --+---&gt;(AdapterHandlerEntry* ptr: RW)-+
1199                                                                                  |
1200                                                  +-------------------------------+
1201                                                  |
1202                                                  +----&gt; [AdapterHandlerEntry] (allocated at run time)
1203                                                               _fingerprint
1204                                                               _c2i_entry ---------------------------------+-&gt;[c2i entry..]
1205  _i2i_entry  -------------+                                   _i2c_entry ---------------+-&gt; [i2c entry..] |
1206  _from_interpreted_entry  |                                   _c2i_unverified_entry     |                 |
1207          |                |                                   _c2i_no_clinit_check_entry|                 |
1208          |                |  (_cds_entry_table: CODE)                                   |                 |
1209          |                +-&gt;[0]: jmp _entry_table[0] --&gt; (i2i_entry_for &quot;zero_locals&quot;) |                 |
1210          |                |                               (allocated at run time)       |                 |
1211          |                |  ...                           [asm code ...]               |                 |
1212          +-[not compiled]-+  [n]: jmp _entry_table[n]                                   |                 |
1213          |                                                                              |                 |
1214          |                                                                              |                 |
1215          +-[compiled]-------------------------------------------------------------------+                 |
1216                                                                                                           |
1217  _from_compiled_entry------------&gt;  (_c2i_entry_trampoline: CODE)                                         |
1218                                     [jmp c2i_entry] ------------------------------------------------------+
1219 
1220 ***/
1221 
1222 // Called when the method_holder is getting linked. Setup entrypoints so the method
1223 // is ready to be called from interpreter, compiler, and vtables.
1224 void Method::link_method(const methodHandle&amp; h_method, TRAPS) {
1225   // If the code cache is full, we may reenter this function for the
1226   // leftover methods that weren&#39;t linked.
1227   if (is_shared()) {
1228     // Can&#39;t assert that the adapters are sane, because methods get linked before
1229     // the interpreter is generated, and hence before its adapters are generated.
1230     // If you messed them up you will notice soon enough though, don&#39;t you worry.
1231     if (adapter() != NULL) {
1232       return;
1233     }
1234   } else if (_i2i_entry != NULL) {
1235     return;
1236   }
1237   assert( _code == NULL, &quot;nothing compiled yet&quot; );
1238 
1239   // Setup interpreter entrypoint
1240   assert(this == h_method(), &quot;wrong h_method()&quot; );
1241 
1242   if (!is_shared()) {
1243     assert(adapter() == NULL, &quot;init&#39;d to NULL&quot;);
1244     address entry = Interpreter::entry_for_method(h_method);
1245     assert(entry != NULL, &quot;interpreter entry must be non-null&quot;);
1246     // Sets both _i2i_entry and _from_interpreted_entry
1247     set_interpreter_entry(entry);
1248   }
1249 
1250   // Don&#39;t overwrite already registered native entries.
1251   if (is_native() &amp;&amp; !has_native_function()) {
1252     set_native_function(
1253       SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
1254       !native_bind_event_is_interesting);
1255   }
1256 
1257   // Setup compiler entrypoint.  This is made eagerly, so we do not need
1258   // special handling of vtables.  An alternative is to make adapters more
1259   // lazily by calling make_adapter() from from_compiled_entry() for the
1260   // normal calls.  For vtable calls life gets more complicated.  When a
1261   // call-site goes mega-morphic we need adapters in all methods which can be
1262   // called from the vtable.  We need adapters on such methods that get loaded
1263   // later.  Ditto for mega-morphic itable calls.  If this proves to be a
1264   // problem we&#39;ll make these lazily later.
1265   (void) make_adapters(h_method, CHECK);
1266 
1267   // ONLY USE the h_method now as make_adapter may have blocked
1268 
1269 }
1270 
1271 address Method::make_adapters(const methodHandle&amp; mh, TRAPS) {
1272   // Adapters for compiled code are made eagerly here.  They are fairly
1273   // small (generally &lt; 100 bytes) and quick to make (and cached and shared)
1274   // so making them eagerly shouldn&#39;t be too expensive.
1275   AdapterHandlerEntry* adapter = AdapterHandlerLibrary::get_adapter(mh);
1276   if (adapter == NULL ) {
1277     if (!is_init_completed()) {
1278       // Don&#39;t throw exceptions during VM initialization because java.lang.* classes
1279       // might not have been initialized, causing problems when constructing the
1280       // Java exception object.
1281       vm_exit_during_initialization(&quot;Out of space in CodeCache for adapters&quot;);
1282     } else {
1283       THROW_MSG_NULL(vmSymbols::java_lang_VirtualMachineError(), &quot;Out of space in CodeCache for adapters&quot;);
1284     }
1285   }
1286 
1287   if (mh-&gt;is_shared()) {
1288     assert(mh-&gt;adapter() == adapter, &quot;must be&quot;);
1289     assert(mh-&gt;_from_compiled_entry != NULL, &quot;must be&quot;);
<a name="19" id="anc19"></a><span class="line-added">1290     assert(mh-&gt;_from_compiled_inline_entry != NULL, &quot;must be&quot;);</span>
<span class="line-added">1291     assert(mh-&gt;_from_compiled_inline_ro_entry != NULL, &quot;must be&quot;);</span>
1292   } else {
1293     mh-&gt;set_adapter_entry(adapter);
1294     mh-&gt;_from_compiled_entry = adapter-&gt;get_c2i_entry();
<a name="20" id="anc20"></a><span class="line-added">1295     mh-&gt;_from_compiled_inline_entry = adapter-&gt;get_c2i_inline_entry();</span>
<span class="line-added">1296     mh-&gt;_from_compiled_inline_ro_entry = adapter-&gt;get_c2i_inline_ro_entry();</span>
1297   }
1298   return adapter-&gt;get_c2i_entry();
1299 }
1300 
1301 void Method::restore_unshareable_info(TRAPS) {
1302   assert(is_method() &amp;&amp; is_valid_method(this), &quot;ensure C++ vtable is restored&quot;);
1303 
<a name="21" id="anc21"></a><span class="line-added">1304 #if 0</span>
<span class="line-added">1305   /*</span>
<span class="line-added">1306    * CDS:TODO --</span>
<span class="line-added">1307    * &quot;Q&quot; classes in the method signature must be resolved during link_method.</span>
<span class="line-added">1308    * However, at this point we are still inside method_holder()-&gt;restore_unshareable_info.</span>
<span class="line-added">1309    * If we try to resolve method_holder(), or multually dependent classes, it will</span>
<span class="line-added">1310    * cause deadlock and other ill effects.</span>
<span class="line-added">1311    *</span>
<span class="line-added">1312    * For now, lets do method linking inside InstanceKlass::link_class(). Optimization</span>
<span class="line-added">1313    * may be possible if we know that resolution will never happen.</span>
<span class="line-added">1314    */</span>
<span class="line-added">1315 </span>
1316   // Since restore_unshareable_info can be called more than once for a method, don&#39;t
1317   // redo any work.
1318   if (adapter() == NULL) {
1319     methodHandle mh(THREAD, this);
1320     link_method(mh, CHECK);
1321   }
<a name="22" id="anc22"></a><span class="line-added">1322 #endif</span>
1323 }
1324 
<a name="23" id="anc23"></a><span class="line-modified">1325 address Method::from_compiled_entry_no_trampoline(bool caller_is_c1) const {</span>
1326   CompiledMethod *code = Atomic::load_acquire(&amp;_code);
<a name="24" id="anc24"></a><span class="line-modified">1327   if (caller_is_c1) {</span>
<span class="line-modified">1328     // C1 - inline type arguments are passed as objects</span>
<span class="line-added">1329     if (code) {</span>
<span class="line-added">1330       return code-&gt;verified_inline_entry_point();</span>
<span class="line-added">1331     } else {</span>
<span class="line-added">1332       return adapter()-&gt;get_c2i_inline_entry();</span>
<span class="line-added">1333     }</span>
1334   } else {
<a name="25" id="anc25"></a><span class="line-modified">1335     // C2 - inline type arguments may be passed as fields</span>
<span class="line-added">1336     if (code) {</span>
<span class="line-added">1337       return code-&gt;verified_entry_point();</span>
<span class="line-added">1338     } else {</span>
<span class="line-added">1339       return adapter()-&gt;get_c2i_entry();</span>
<span class="line-added">1340     }</span>
1341   }
1342 }
1343 
1344 // The verified_code_entry() must be called when a invoke is resolved
1345 // on this method.
1346 
1347 // It returns the compiled code entry point, after asserting not null.
1348 // This function is called after potential safepoints so that nmethod
1349 // or adapter that it points to is still live and valid.
1350 // This function must not hit a safepoint!
1351 address Method::verified_code_entry() {
1352   debug_only(NoSafepointVerifier nsv;)
1353   assert(_from_compiled_entry != NULL, &quot;must be set&quot;);
1354   return _from_compiled_entry;
1355 }
1356 
<a name="26" id="anc26"></a><span class="line-added">1357 address Method::verified_inline_code_entry() {</span>
<span class="line-added">1358   debug_only(NoSafepointVerifier nsv;)</span>
<span class="line-added">1359   assert(_from_compiled_inline_entry != NULL, &quot;must be set&quot;);</span>
<span class="line-added">1360   return _from_compiled_inline_entry;</span>
<span class="line-added">1361 }</span>
<span class="line-added">1362 </span>
<span class="line-added">1363 address Method::verified_inline_ro_code_entry() {</span>
<span class="line-added">1364   debug_only(NoSafepointVerifier nsv;)</span>
<span class="line-added">1365   assert(_from_compiled_inline_ro_entry != NULL, &quot;must be set&quot;);</span>
<span class="line-added">1366   return _from_compiled_inline_ro_entry;</span>
<span class="line-added">1367 }</span>
<span class="line-added">1368 </span>
1369 // Check that if an nmethod ref exists, it has a backlink to this or no backlink at all
1370 // (could be racing a deopt).
1371 // Not inline to avoid circular ref.
1372 bool Method::check_code() const {
1373   // cached in a register or local.  There&#39;s a race on the value of the field.
1374   CompiledMethod *code = Atomic::load_acquire(&amp;_code);
1375   return code == NULL || (code-&gt;method() == NULL) || (code-&gt;method() == (Method*)this &amp;&amp; !code-&gt;is_osr_method());
1376 }
1377 
1378 // Install compiled code.  Instantly it can execute.
1379 void Method::set_code(const methodHandle&amp; mh, CompiledMethod *code) {
1380   assert_lock_strong(CompiledMethod_lock);
1381   assert( code, &quot;use clear_code to remove code&quot; );
1382   assert( mh-&gt;check_code(), &quot;&quot; );
1383 
1384   guarantee(mh-&gt;adapter() != NULL, &quot;Adapter blob must already exist!&quot;);
1385 
1386   // These writes must happen in this order, because the interpreter will
1387   // directly jump to from_interpreted_entry which jumps to an i2c adapter
1388   // which jumps to _from_compiled_entry.
1389   mh-&gt;_code = code;             // Assign before allowing compiled code to exec
1390 
1391   int comp_level = code-&gt;comp_level();
1392   // In theory there could be a race here. In practice it is unlikely
1393   // and not worth worrying about.
1394   if (comp_level &gt; mh-&gt;highest_comp_level()) {
1395     mh-&gt;set_highest_comp_level(comp_level);
1396   }
1397 
1398   OrderAccess::storestore();
1399   mh-&gt;_from_compiled_entry = code-&gt;verified_entry_point();
<a name="27" id="anc27"></a><span class="line-added">1400   mh-&gt;_from_compiled_inline_entry = code-&gt;verified_inline_entry_point();</span>
<span class="line-added">1401   mh-&gt;_from_compiled_inline_ro_entry = code-&gt;verified_inline_ro_entry_point();</span>
1402   OrderAccess::storestore();
1403   // Instantly compiled code can execute.
1404   if (!mh-&gt;is_method_handle_intrinsic())
1405     mh-&gt;_from_interpreted_entry = mh-&gt;get_i2c_entry();
1406 }
1407 
1408 
1409 bool Method::is_overridden_in(Klass* k) const {
1410   InstanceKlass* ik = InstanceKlass::cast(k);
1411 
1412   if (ik-&gt;is_interface()) return false;
1413 
1414   // If method is an interface, we skip it - except if it
1415   // is a miranda method
1416   if (method_holder()-&gt;is_interface()) {
1417     // Check that method is not a miranda method
1418     if (ik-&gt;lookup_method(name(), signature()) == NULL) {
1419       // No implementation exist - so miranda method
1420       return false;
1421     }
1422     return true;
1423   }
1424 
1425   assert(ik-&gt;is_subclass_of(method_holder()), &quot;should be subklass&quot;);
1426   if (!has_vtable_index()) {
1427     return false;
1428   } else {
1429     Method* vt_m = ik-&gt;method_at_vtable(vtable_index());
1430     return vt_m != this;
1431   }
1432 }
1433 
1434 
1435 // give advice about whether this Method* should be cached or not
1436 bool Method::should_not_be_cached() const {
1437   if (is_old()) {
1438     // This method has been redefined. It is either EMCP or obsolete
1439     // and we don&#39;t want to cache it because that would pin the method
1440     // down and prevent it from being collectible if and when it
1441     // finishes executing.
1442     return true;
1443   }
1444 
1445   // caching this method should be just fine
1446   return false;
1447 }
1448 
1449 
1450 /**
1451  *  Returns true if this is one of the specially treated methods for
1452  *  security related stack walks (like Reflection.getCallerClass).
1453  */
1454 bool Method::is_ignored_by_security_stack_walk() const {
1455   if (intrinsic_id() == vmIntrinsics::_invoke) {
1456     // This is Method.invoke() -- ignore it
1457     return true;
1458   }
1459   if (method_holder()-&gt;is_subclass_of(SystemDictionary::reflect_MethodAccessorImpl_klass())) {
1460     // This is an auxilary frame -- ignore it
1461     return true;
1462   }
1463   if (is_method_handle_intrinsic() || is_compiled_lambda_form()) {
1464     // This is an internal adapter frame for method handles -- ignore it
1465     return true;
1466   }
1467   return false;
1468 }
1469 
1470 
1471 // Constant pool structure for invoke methods:
1472 enum {
1473   _imcp_invoke_name = 1,        // utf8: &#39;invokeExact&#39;, etc.
1474   _imcp_invoke_signature,       // utf8: (variable Symbol*)
1475   _imcp_limit
1476 };
1477 
1478 // Test if this method is an MH adapter frame generated by Java code.
1479 // Cf. java/lang/invoke/InvokerBytecodeGenerator
1480 bool Method::is_compiled_lambda_form() const {
1481   return intrinsic_id() == vmIntrinsics::_compiledLambdaForm;
1482 }
1483 
1484 // Test if this method is an internal MH primitive method.
1485 bool Method::is_method_handle_intrinsic() const {
1486   vmIntrinsics::ID iid = intrinsic_id();
1487   return (MethodHandles::is_signature_polymorphic(iid) &amp;&amp;
1488           MethodHandles::is_signature_polymorphic_intrinsic(iid));
1489 }
1490 
1491 bool Method::has_member_arg() const {
1492   vmIntrinsics::ID iid = intrinsic_id();
1493   return (MethodHandles::is_signature_polymorphic(iid) &amp;&amp;
1494           MethodHandles::has_member_arg(iid));
1495 }
1496 
1497 // Make an instance of a signature-polymorphic internal MH primitive.
1498 methodHandle Method::make_method_handle_intrinsic(vmIntrinsics::ID iid,
1499                                                          Symbol* signature,
1500                                                          TRAPS) {
1501   ResourceMark rm(THREAD);
1502   methodHandle empty;
1503 
1504   InstanceKlass* holder = SystemDictionary::MethodHandle_klass();
1505   Symbol* name = MethodHandles::signature_polymorphic_intrinsic_name(iid);
1506   assert(iid == MethodHandles::signature_polymorphic_name_id(name), &quot;&quot;);
1507 
1508   log_info(methodhandles)(&quot;make_method_handle_intrinsic MH.%s%s&quot;, name-&gt;as_C_string(), signature-&gt;as_C_string());
1509 
1510   // invariant:   cp-&gt;symbol_at_put is preceded by a refcount increment (more usually a lookup)
1511   name-&gt;increment_refcount();
1512   signature-&gt;increment_refcount();
1513 
1514   int cp_length = _imcp_limit;
1515   ClassLoaderData* loader_data = holder-&gt;class_loader_data();
1516   constantPoolHandle cp;
1517   {
1518     ConstantPool* cp_oop = ConstantPool::allocate(loader_data, cp_length, CHECK_(empty));
1519     cp = constantPoolHandle(THREAD, cp_oop);
1520   }
1521   cp-&gt;copy_fields(holder-&gt;constants());
1522   cp-&gt;set_pool_holder(holder);
1523   cp-&gt;symbol_at_put(_imcp_invoke_name,       name);
1524   cp-&gt;symbol_at_put(_imcp_invoke_signature,  signature);
1525   cp-&gt;set_has_preresolution();
1526 
1527   // decide on access bits:  public or not?
1528   int flags_bits = (JVM_ACC_NATIVE | JVM_ACC_SYNTHETIC | JVM_ACC_FINAL);
1529   bool must_be_static = MethodHandles::is_signature_polymorphic_static(iid);
1530   if (must_be_static)  flags_bits |= JVM_ACC_STATIC;
1531   assert((flags_bits &amp; JVM_ACC_PUBLIC) == 0, &quot;do not expose these methods&quot;);
1532 
1533   methodHandle m;
1534   {
1535     InlineTableSizes sizes;
1536     Method* m_oop = Method::allocate(loader_data, 0,
1537                                      accessFlags_from(flags_bits), &amp;sizes,
1538                                      ConstMethod::NORMAL, CHECK_(empty));
1539     m = methodHandle(THREAD, m_oop);
1540   }
1541   m-&gt;set_constants(cp());
1542   m-&gt;set_name_index(_imcp_invoke_name);
1543   m-&gt;set_signature_index(_imcp_invoke_signature);
1544   assert(MethodHandles::is_signature_polymorphic_name(m-&gt;name()), &quot;&quot;);
1545   assert(m-&gt;signature() == signature, &quot;&quot;);
1546   m-&gt;compute_from_signature(signature);
1547   m-&gt;init_intrinsic_id();
1548   assert(m-&gt;is_method_handle_intrinsic(), &quot;&quot;);
1549 #ifdef ASSERT
1550   if (!MethodHandles::is_signature_polymorphic(m-&gt;intrinsic_id()))  m-&gt;print();
1551   assert(MethodHandles::is_signature_polymorphic(m-&gt;intrinsic_id()), &quot;must be an invoker&quot;);
1552   assert(m-&gt;intrinsic_id() == iid, &quot;correctly predicted iid&quot;);
1553 #endif //ASSERT
1554 
1555   // Finally, set up its entry points.
1556   assert(m-&gt;can_be_statically_bound(), &quot;&quot;);
1557   m-&gt;set_vtable_index(Method::nonvirtual_vtable_index);
1558   m-&gt;link_method(m, CHECK_(empty));
1559 
1560   if (log_is_enabled(Info, methodhandles) &amp;&amp; (Verbose || WizardMode)) {
1561     LogTarget(Info, methodhandles) lt;
1562     LogStream ls(lt);
1563     m-&gt;print_on(&amp;ls);
1564   }
1565 
1566   return m;
1567 }
1568 
1569 Klass* Method::check_non_bcp_klass(Klass* klass) {
1570   if (klass != NULL &amp;&amp; klass-&gt;class_loader() != NULL) {
1571     if (klass-&gt;is_objArray_klass())
1572       klass = ObjArrayKlass::cast(klass)-&gt;bottom_klass();
1573     return klass;
1574   }
1575   return NULL;
1576 }
1577 
1578 
1579 methodHandle Method::clone_with_new_data(const methodHandle&amp; m, u_char* new_code, int new_code_length,
1580                                                 u_char* new_compressed_linenumber_table, int new_compressed_linenumber_size, TRAPS) {
1581   // Code below does not work for native methods - they should never get rewritten anyway
1582   assert(!m-&gt;is_native(), &quot;cannot rewrite native methods&quot;);
1583   // Allocate new Method*
1584   AccessFlags flags = m-&gt;access_flags();
1585 
1586   ConstMethod* cm = m-&gt;constMethod();
1587   int checked_exceptions_len = cm-&gt;checked_exceptions_length();
1588   int localvariable_len = cm-&gt;localvariable_table_length();
1589   int exception_table_len = cm-&gt;exception_table_length();
1590   int method_parameters_len = cm-&gt;method_parameters_length();
1591   int method_annotations_len = cm-&gt;method_annotations_length();
1592   int parameter_annotations_len = cm-&gt;parameter_annotations_length();
1593   int type_annotations_len = cm-&gt;type_annotations_length();
1594   int default_annotations_len = cm-&gt;default_annotations_length();
1595 
1596   InlineTableSizes sizes(
1597       localvariable_len,
1598       new_compressed_linenumber_size,
1599       exception_table_len,
1600       checked_exceptions_len,
1601       method_parameters_len,
1602       cm-&gt;generic_signature_index(),
1603       method_annotations_len,
1604       parameter_annotations_len,
1605       type_annotations_len,
1606       default_annotations_len,
1607       0);
1608 
1609   ClassLoaderData* loader_data = m-&gt;method_holder()-&gt;class_loader_data();
1610   Method* newm_oop = Method::allocate(loader_data,
1611                                       new_code_length,
1612                                       flags,
1613                                       &amp;sizes,
1614                                       m-&gt;method_type(),
1615                                       CHECK_(methodHandle()));
1616   methodHandle newm (THREAD, newm_oop);
1617 
1618   // Create a shallow copy of Method part, but be careful to preserve the new ConstMethod*
1619   ConstMethod* newcm = newm-&gt;constMethod();
1620   int new_const_method_size = newm-&gt;constMethod()-&gt;size();
1621 
1622   // This works because the source and target are both Methods. Some compilers
1623   // (e.g., clang) complain that the target vtable pointer will be stomped,
1624   // so cast away newm()&#39;s and m()&#39;s Methodness.
1625   memcpy((void*)newm(), (void*)m(), sizeof(Method));
1626 
1627   // Create shallow copy of ConstMethod.
1628   memcpy(newcm, m-&gt;constMethod(), sizeof(ConstMethod));
1629 
1630   // Reset correct method/const method, method size, and parameter info
1631   newm-&gt;set_constMethod(newcm);
1632   newm-&gt;constMethod()-&gt;set_code_size(new_code_length);
1633   newm-&gt;constMethod()-&gt;set_constMethod_size(new_const_method_size);
1634   assert(newm-&gt;code_size() == new_code_length, &quot;check&quot;);
1635   assert(newm-&gt;method_parameters_length() == method_parameters_len, &quot;check&quot;);
1636   assert(newm-&gt;checked_exceptions_length() == checked_exceptions_len, &quot;check&quot;);
1637   assert(newm-&gt;exception_table_length() == exception_table_len, &quot;check&quot;);
1638   assert(newm-&gt;localvariable_table_length() == localvariable_len, &quot;check&quot;);
1639   // Copy new byte codes
1640   memcpy(newm-&gt;code_base(), new_code, new_code_length);
1641   // Copy line number table
1642   if (new_compressed_linenumber_size &gt; 0) {
1643     memcpy(newm-&gt;compressed_linenumber_table(),
1644            new_compressed_linenumber_table,
1645            new_compressed_linenumber_size);
1646   }
1647   // Copy method_parameters
1648   if (method_parameters_len &gt; 0) {
1649     memcpy(newm-&gt;method_parameters_start(),
1650            m-&gt;method_parameters_start(),
1651            method_parameters_len * sizeof(MethodParametersElement));
1652   }
1653   // Copy checked_exceptions
1654   if (checked_exceptions_len &gt; 0) {
1655     memcpy(newm-&gt;checked_exceptions_start(),
1656            m-&gt;checked_exceptions_start(),
1657            checked_exceptions_len * sizeof(CheckedExceptionElement));
1658   }
1659   // Copy exception table
1660   if (exception_table_len &gt; 0) {
1661     memcpy(newm-&gt;exception_table_start(),
1662            m-&gt;exception_table_start(),
1663            exception_table_len * sizeof(ExceptionTableElement));
1664   }
1665   // Copy local variable number table
1666   if (localvariable_len &gt; 0) {
1667     memcpy(newm-&gt;localvariable_table_start(),
1668            m-&gt;localvariable_table_start(),
1669            localvariable_len * sizeof(LocalVariableTableElement));
1670   }
1671   // Copy stackmap table
1672   if (m-&gt;has_stackmap_table()) {
1673     int code_attribute_length = m-&gt;stackmap_data()-&gt;length();
1674     Array&lt;u1&gt;* stackmap_data =
1675       MetadataFactory::new_array&lt;u1&gt;(loader_data, code_attribute_length, 0, CHECK_(methodHandle()));
1676     memcpy((void*)stackmap_data-&gt;adr_at(0),
1677            (void*)m-&gt;stackmap_data()-&gt;adr_at(0), code_attribute_length);
1678     newm-&gt;set_stackmap_data(stackmap_data);
1679   }
1680 
1681   // copy annotations over to new method
1682   newcm-&gt;copy_annotations_from(loader_data, cm, CHECK_(methodHandle()));
1683   return newm;
1684 }
1685 
1686 vmSymbols::SID Method::klass_id_for_intrinsics(const Klass* holder) {
1687   // if loader is not the default loader (i.e., != NULL), we can&#39;t know the intrinsics
1688   // because we are not loading from core libraries
1689   // exception: the AES intrinsics come from lib/ext/sunjce_provider.jar
1690   // which does not use the class default class loader so we check for its loader here
1691   const InstanceKlass* ik = InstanceKlass::cast(holder);
1692   if ((ik-&gt;class_loader() != NULL) &amp;&amp; !SystemDictionary::is_platform_class_loader(ik-&gt;class_loader())) {
1693     return vmSymbols::NO_SID;   // regardless of name, no intrinsics here
1694   }
1695 
1696   // see if the klass name is well-known:
1697   Symbol* klass_name = ik-&gt;name();
1698   return vmSymbols::find_sid(klass_name);
1699 }
1700 
1701 void Method::init_intrinsic_id() {
1702   assert(_intrinsic_id == vmIntrinsics::_none, &quot;do this just once&quot;);
1703   const uintptr_t max_id_uint = right_n_bits((int)(sizeof(_intrinsic_id) * BitsPerByte));
1704   assert((uintptr_t)vmIntrinsics::ID_LIMIT &lt;= max_id_uint, &quot;else fix size&quot;);
1705   assert(intrinsic_id_size_in_bytes() == sizeof(_intrinsic_id), &quot;&quot;);
1706 
1707   // the klass name is well-known:
1708   vmSymbols::SID klass_id = klass_id_for_intrinsics(method_holder());
1709   assert(klass_id != vmSymbols::NO_SID, &quot;caller responsibility&quot;);
1710 
1711   // ditto for method and signature:
1712   vmSymbols::SID  name_id = vmSymbols::find_sid(name());
1713   if (klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle)
1714       &amp;&amp; klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle)
1715       &amp;&amp; name_id == vmSymbols::NO_SID) {
1716     return;
1717   }
1718   vmSymbols::SID   sig_id = vmSymbols::find_sid(signature());
1719   if (klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle)
1720       &amp;&amp; klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle)
1721       &amp;&amp; sig_id == vmSymbols::NO_SID) {
1722     return;
1723   }
1724   jshort flags = access_flags().as_short();
1725 
1726   vmIntrinsics::ID id = vmIntrinsics::find_id(klass_id, name_id, sig_id, flags);
1727   if (id != vmIntrinsics::_none) {
1728     set_intrinsic_id(id);
1729     if (id == vmIntrinsics::_Class_cast) {
1730       // Even if the intrinsic is rejected, we want to inline this simple method.
1731       set_force_inline(true);
1732     }
1733     return;
1734   }
1735 
1736   // A few slightly irregular cases:
1737   switch (klass_id) {
1738   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_StrictMath):
1739     // Second chance: check in regular Math.
1740     switch (name_id) {
1741     case vmSymbols::VM_SYMBOL_ENUM_NAME(min_name):
1742     case vmSymbols::VM_SYMBOL_ENUM_NAME(max_name):
1743     case vmSymbols::VM_SYMBOL_ENUM_NAME(sqrt_name):
1744       // pretend it is the corresponding method in the non-strict class:
1745       klass_id = vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_Math);
1746       id = vmIntrinsics::find_id(klass_id, name_id, sig_id, flags);
1747       break;
1748     default:
1749       break;
1750     }
1751     break;
1752 
1753   // Signature-polymorphic methods: MethodHandle.invoke*, InvokeDynamic.*., VarHandle
1754   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle):
1755   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle):
1756     if (!is_native())  break;
1757     id = MethodHandles::signature_polymorphic_name_id(method_holder(), name());
1758     if (is_static() != MethodHandles::is_signature_polymorphic_static(id))
1759       id = vmIntrinsics::_none;
1760     break;
1761 
1762   default:
1763     break;
1764   }
1765 
1766   if (id != vmIntrinsics::_none) {
1767     // Set up its iid.  It is an alias method.
1768     set_intrinsic_id(id);
1769     return;
1770   }
1771 }
1772 
1773 bool Method::load_signature_classes(const methodHandle&amp; m, TRAPS) {
1774   if (!THREAD-&gt;can_call_java()) {
1775     // There is nothing useful this routine can do from within the Compile thread.
1776     // Hopefully, the signature contains only well-known classes.
1777     // We could scan for this and return true/false, but the caller won&#39;t care.
1778     return false;
1779   }
1780   bool sig_is_loaded = true;
1781   ResourceMark rm(THREAD);
1782   for (ResolvingSignatureStream ss(m()); !ss.is_done(); ss.next()) {
1783     if (ss.is_reference()) {
1784       // load everything, including arrays &quot;[Lfoo;&quot;
1785       Klass* klass = ss.as_klass(SignatureStream::ReturnNull, THREAD);
1786       // We are loading classes eagerly. If a ClassNotFoundException or
1787       // a LinkageError was generated, be sure to ignore it.
1788       if (HAS_PENDING_EXCEPTION) {
1789         if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::ClassNotFoundException_klass()) ||
1790             PENDING_EXCEPTION-&gt;is_a(SystemDictionary::LinkageError_klass())) {
1791           CLEAR_PENDING_EXCEPTION;
1792         } else {
1793           return false;
1794         }
1795       }
1796       if( klass == NULL) { sig_is_loaded = false; }
1797     }
1798   }
1799   return sig_is_loaded;
1800 }
1801 
1802 bool Method::has_unloaded_classes_in_signature(const methodHandle&amp; m, TRAPS) {
1803   ResourceMark rm(THREAD);
1804   for(ResolvingSignatureStream ss(m()); !ss.is_done(); ss.next()) {
1805     if (ss.type() == T_OBJECT) {
1806       // Do not use ss.is_reference() here, since we don&#39;t care about
1807       // unloaded array component types.
1808       Klass* klass = ss.as_klass_if_loaded(THREAD);
1809       assert(!HAS_PENDING_EXCEPTION, &quot;as_klass_if_loaded contract&quot;);
1810       if (klass == NULL) return true;
1811     }
1812   }
1813   return false;
1814 }
1815 
1816 // Exposed so field engineers can debug VM
1817 void Method::print_short_name(outputStream* st) {
1818   ResourceMark rm;
1819 #ifdef PRODUCT
1820   st-&gt;print(&quot; %s::&quot;, method_holder()-&gt;external_name());
1821 #else
1822   st-&gt;print(&quot; %s::&quot;, method_holder()-&gt;internal_name());
1823 #endif
1824   name()-&gt;print_symbol_on(st);
1825   if (WizardMode) signature()-&gt;print_symbol_on(st);
1826   else if (MethodHandles::is_signature_polymorphic(intrinsic_id()))
1827     MethodHandles::print_as_basic_type_signature_on(st, signature());
1828 }
1829 
1830 // Comparer for sorting an object array containing
1831 // Method*s.
1832 static int method_comparator(Method* a, Method* b) {
1833   return a-&gt;name()-&gt;fast_compare(b-&gt;name());
1834 }
1835 
1836 // This is only done during class loading, so it is OK to assume method_idnum matches the methods() array
1837 // default_methods also uses this without the ordering for fast find_method
1838 void Method::sort_methods(Array&lt;Method*&gt;* methods, bool set_idnums, method_comparator_func func) {
1839   int length = methods-&gt;length();
1840   if (length &gt; 1) {
1841     if (func == NULL) {
1842       func = method_comparator;
1843     }
1844     {
1845       NoSafepointVerifier nsv;
1846       QuickSort::sort(methods-&gt;data(), length, func, /*idempotent=*/false);
1847     }
1848     // Reset method ordering
1849     if (set_idnums) {
1850       for (int i = 0; i &lt; length; i++) {
1851         Method* m = methods-&gt;at(i);
1852         m-&gt;set_method_idnum(i);
1853         m-&gt;set_orig_method_idnum(i);
1854       }
1855     }
1856   }
1857 }
1858 
1859 //-----------------------------------------------------------------------------------
1860 // Non-product code unless JVM/TI needs it
1861 
1862 #if !defined(PRODUCT) || INCLUDE_JVMTI
1863 class SignatureTypePrinter : public SignatureTypeNames {
1864  private:
1865   outputStream* _st;
1866   bool _use_separator;
1867 
1868   void type_name(const char* name) {
1869     if (_use_separator) _st-&gt;print(&quot;, &quot;);
1870     _st-&gt;print(&quot;%s&quot;, name);
1871     _use_separator = true;
1872   }
1873 
1874  public:
1875   SignatureTypePrinter(Symbol* signature, outputStream* st) : SignatureTypeNames(signature) {
1876     _st = st;
1877     _use_separator = false;
1878   }
1879 
1880   void print_parameters()              { _use_separator = false; do_parameters_on(this); }
1881   void print_returntype()              { _use_separator = false; do_type(return_type()); }
1882 };
1883 
1884 
1885 void Method::print_name(outputStream* st) {
1886   Thread *thread = Thread::current();
1887   ResourceMark rm(thread);
1888   st-&gt;print(&quot;%s &quot;, is_static() ? &quot;static&quot; : &quot;virtual&quot;);
1889   if (WizardMode) {
1890     st-&gt;print(&quot;%s.&quot;, method_holder()-&gt;internal_name());
1891     name()-&gt;print_symbol_on(st);
1892     signature()-&gt;print_symbol_on(st);
1893   } else {
1894     SignatureTypePrinter sig(signature(), st);
1895     sig.print_returntype();
1896     st-&gt;print(&quot; %s.&quot;, method_holder()-&gt;internal_name());
1897     name()-&gt;print_symbol_on(st);
1898     st-&gt;print(&quot;(&quot;);
1899     sig.print_parameters();
1900     st-&gt;print(&quot;)&quot;);
1901   }
1902 }
1903 #endif // !PRODUCT || INCLUDE_JVMTI
1904 
1905 
1906 void Method::print_codes_on(outputStream* st) const {
1907   print_codes_on(0, code_size(), st);
1908 }
1909 
1910 void Method::print_codes_on(int from, int to, outputStream* st) const {
1911   Thread *thread = Thread::current();
1912   ResourceMark rm(thread);
1913   methodHandle mh (thread, (Method*)this);
1914   BytecodeStream s(mh);
1915   s.set_interval(from, to);
1916   BytecodeTracer::set_closure(BytecodeTracer::std_closure());
1917   while (s.next() &gt;= 0) BytecodeTracer::trace(mh, s.bcp(), st);
1918 }
1919 
1920 CompressedLineNumberReadStream::CompressedLineNumberReadStream(u_char* buffer) : CompressedReadStream(buffer) {
1921   _bci = 0;
1922   _line = 0;
1923 };
1924 
1925 bool CompressedLineNumberReadStream::read_pair() {
1926   jubyte next = read_byte();
1927   // Check for terminator
1928   if (next == 0) return false;
1929   if (next == 0xFF) {
1930     // Escape character, regular compression used
1931     _bci  += read_signed_int();
1932     _line += read_signed_int();
1933   } else {
1934     // Single byte compression used
1935     _bci  += next &gt;&gt; 3;
1936     _line += next &amp; 0x7;
1937   }
1938   return true;
1939 }
1940 
1941 #if INCLUDE_JVMTI
1942 
1943 Bytecodes::Code Method::orig_bytecode_at(int bci) const {
1944   BreakpointInfo* bp = method_holder()-&gt;breakpoints();
1945   for (; bp != NULL; bp = bp-&gt;next()) {
1946     if (bp-&gt;match(this, bci)) {
1947       return bp-&gt;orig_bytecode();
1948     }
1949   }
1950   {
1951     ResourceMark rm;
1952     fatal(&quot;no original bytecode found in %s at bci %d&quot;, name_and_sig_as_C_string(), bci);
1953   }
1954   return Bytecodes::_shouldnotreachhere;
1955 }
1956 
1957 void Method::set_orig_bytecode_at(int bci, Bytecodes::Code code) {
1958   assert(code != Bytecodes::_breakpoint, &quot;cannot patch breakpoints this way&quot;);
1959   BreakpointInfo* bp = method_holder()-&gt;breakpoints();
1960   for (; bp != NULL; bp = bp-&gt;next()) {
1961     if (bp-&gt;match(this, bci)) {
1962       bp-&gt;set_orig_bytecode(code);
1963       // and continue, in case there is more than one
1964     }
1965   }
1966 }
1967 
1968 void Method::set_breakpoint(int bci) {
1969   InstanceKlass* ik = method_holder();
1970   BreakpointInfo *bp = new BreakpointInfo(this, bci);
1971   bp-&gt;set_next(ik-&gt;breakpoints());
1972   ik-&gt;set_breakpoints(bp);
1973   // do this last:
1974   bp-&gt;set(this);
1975 }
1976 
1977 static void clear_matches(Method* m, int bci) {
1978   InstanceKlass* ik = m-&gt;method_holder();
1979   BreakpointInfo* prev_bp = NULL;
1980   BreakpointInfo* next_bp;
1981   for (BreakpointInfo* bp = ik-&gt;breakpoints(); bp != NULL; bp = next_bp) {
1982     next_bp = bp-&gt;next();
1983     // bci value of -1 is used to delete all breakpoints in method m (ex: clear_all_breakpoint).
1984     if (bci &gt;= 0 ? bp-&gt;match(m, bci) : bp-&gt;match(m)) {
1985       // do this first:
1986       bp-&gt;clear(m);
1987       // unhook it
1988       if (prev_bp != NULL)
1989         prev_bp-&gt;set_next(next_bp);
1990       else
1991         ik-&gt;set_breakpoints(next_bp);
1992       delete bp;
1993       // When class is redefined JVMTI sets breakpoint in all versions of EMCP methods
1994       // at same location. So we have multiple matching (method_index and bci)
1995       // BreakpointInfo nodes in BreakpointInfo list. We should just delete one
1996       // breakpoint for clear_breakpoint request and keep all other method versions
1997       // BreakpointInfo for future clear_breakpoint request.
1998       // bcivalue of -1 is used to clear all breakpoints (see clear_all_breakpoints)
1999       // which is being called when class is unloaded. We delete all the Breakpoint
2000       // information for all versions of method. We may not correctly restore the original
2001       // bytecode in all method versions, but that is ok. Because the class is being unloaded
2002       // so these methods won&#39;t be used anymore.
2003       if (bci &gt;= 0) {
2004         break;
2005       }
2006     } else {
2007       // This one is a keeper.
2008       prev_bp = bp;
2009     }
2010   }
2011 }
2012 
2013 void Method::clear_breakpoint(int bci) {
2014   assert(bci &gt;= 0, &quot;&quot;);
2015   clear_matches(this, bci);
2016 }
2017 
2018 void Method::clear_all_breakpoints() {
2019   clear_matches(this, -1);
2020 }
2021 
2022 #endif // INCLUDE_JVMTI
2023 
2024 int Method::invocation_count() {
2025   MethodCounters *mcs = method_counters();
2026   if (TieredCompilation) {
2027     MethodData* const mdo = method_data();
2028     if (((mcs != NULL) ? mcs-&gt;invocation_counter()-&gt;carry() : false) ||
2029         ((mdo != NULL) ? mdo-&gt;invocation_counter()-&gt;carry() : false)) {
2030       return InvocationCounter::count_limit;
2031     } else {
2032       return ((mcs != NULL) ? mcs-&gt;invocation_counter()-&gt;count() : 0) +
2033              ((mdo != NULL) ? mdo-&gt;invocation_counter()-&gt;count() : 0);
2034     }
2035   } else {
2036     return (mcs == NULL) ? 0 : mcs-&gt;invocation_counter()-&gt;count();
2037   }
2038 }
2039 
2040 int Method::backedge_count() {
2041   MethodCounters *mcs = method_counters();
2042   if (TieredCompilation) {
2043     MethodData* const mdo = method_data();
2044     if (((mcs != NULL) ? mcs-&gt;backedge_counter()-&gt;carry() : false) ||
2045         ((mdo != NULL) ? mdo-&gt;backedge_counter()-&gt;carry() : false)) {
2046       return InvocationCounter::count_limit;
2047     } else {
2048       return ((mcs != NULL) ? mcs-&gt;backedge_counter()-&gt;count() : 0) +
2049              ((mdo != NULL) ? mdo-&gt;backedge_counter()-&gt;count() : 0);
2050     }
2051   } else {
2052     return (mcs == NULL) ? 0 : mcs-&gt;backedge_counter()-&gt;count();
2053   }
2054 }
2055 
2056 int Method::highest_comp_level() const {
2057   const MethodCounters* mcs = method_counters();
2058   if (mcs != NULL) {
2059     return mcs-&gt;highest_comp_level();
2060   } else {
2061     return CompLevel_none;
2062   }
2063 }
2064 
2065 int Method::highest_osr_comp_level() const {
2066   const MethodCounters* mcs = method_counters();
2067   if (mcs != NULL) {
2068     return mcs-&gt;highest_osr_comp_level();
2069   } else {
2070     return CompLevel_none;
2071   }
2072 }
2073 
2074 void Method::set_highest_comp_level(int level) {
2075   MethodCounters* mcs = method_counters();
2076   if (mcs != NULL) {
2077     mcs-&gt;set_highest_comp_level(level);
2078   }
2079 }
2080 
2081 void Method::set_highest_osr_comp_level(int level) {
2082   MethodCounters* mcs = method_counters();
2083   if (mcs != NULL) {
2084     mcs-&gt;set_highest_osr_comp_level(level);
2085   }
2086 }
2087 
2088 #if INCLUDE_JVMTI
2089 
2090 BreakpointInfo::BreakpointInfo(Method* m, int bci) {
2091   _bci = bci;
2092   _name_index = m-&gt;name_index();
2093   _signature_index = m-&gt;signature_index();
2094   _orig_bytecode = (Bytecodes::Code) *m-&gt;bcp_from(_bci);
2095   if (_orig_bytecode == Bytecodes::_breakpoint)
2096     _orig_bytecode = m-&gt;orig_bytecode_at(_bci);
2097   _next = NULL;
2098 }
2099 
2100 void BreakpointInfo::set(Method* method) {
2101 #ifdef ASSERT
2102   {
2103     Bytecodes::Code code = (Bytecodes::Code) *method-&gt;bcp_from(_bci);
2104     if (code == Bytecodes::_breakpoint)
2105       code = method-&gt;orig_bytecode_at(_bci);
2106     assert(orig_bytecode() == code, &quot;original bytecode must be the same&quot;);
2107   }
2108 #endif
2109   Thread *thread = Thread::current();
2110   *method-&gt;bcp_from(_bci) = Bytecodes::_breakpoint;
2111   method-&gt;incr_number_of_breakpoints(thread);
2112   {
2113     // Deoptimize all dependents on this method
2114     HandleMark hm(thread);
2115     methodHandle mh(thread, method);
2116     CodeCache::flush_dependents_on_method(mh);
2117   }
2118 }
2119 
2120 void BreakpointInfo::clear(Method* method) {
2121   *method-&gt;bcp_from(_bci) = orig_bytecode();
2122   assert(method-&gt;number_of_breakpoints() &gt; 0, &quot;must not go negative&quot;);
2123   method-&gt;decr_number_of_breakpoints(Thread::current());
2124 }
2125 
2126 #endif // INCLUDE_JVMTI
2127 
2128 // jmethodID handling
2129 
2130 // This is a block allocating object, sort of like JNIHandleBlock, only a
2131 // lot simpler.
2132 // It&#39;s allocated on the CHeap because once we allocate a jmethodID, we can
2133 // never get rid of it.
2134 
2135 static const int min_block_size = 8;
2136 
2137 class JNIMethodBlockNode : public CHeapObj&lt;mtClass&gt; {
2138   friend class JNIMethodBlock;
2139   Method**        _methods;
2140   int             _number_of_methods;
2141   int             _top;
2142   JNIMethodBlockNode* _next;
2143 
2144  public:
2145 
2146   JNIMethodBlockNode(int num_methods = min_block_size);
2147 
2148   ~JNIMethodBlockNode() { FREE_C_HEAP_ARRAY(Method*, _methods); }
2149 
2150   void ensure_methods(int num_addl_methods) {
2151     if (_top &lt; _number_of_methods) {
2152       num_addl_methods -= _number_of_methods - _top;
2153       if (num_addl_methods &lt;= 0) {
2154         return;
2155       }
2156     }
2157     if (_next == NULL) {
2158       _next = new JNIMethodBlockNode(MAX2(num_addl_methods, min_block_size));
2159     } else {
2160       _next-&gt;ensure_methods(num_addl_methods);
2161     }
2162   }
2163 };
2164 
2165 class JNIMethodBlock : public CHeapObj&lt;mtClass&gt; {
2166   JNIMethodBlockNode _head;
2167   JNIMethodBlockNode *_last_free;
2168  public:
2169   static Method* const _free_method;
2170 
2171   JNIMethodBlock(int initial_capacity = min_block_size)
2172       : _head(initial_capacity), _last_free(&amp;_head) {}
2173 
2174   void ensure_methods(int num_addl_methods) {
2175     _last_free-&gt;ensure_methods(num_addl_methods);
2176   }
2177 
2178   Method** add_method(Method* m) {
2179     for (JNIMethodBlockNode* b = _last_free; b != NULL; b = b-&gt;_next) {
2180       if (b-&gt;_top &lt; b-&gt;_number_of_methods) {
2181         // top points to the next free entry.
2182         int i = b-&gt;_top;
2183         b-&gt;_methods[i] = m;
2184         b-&gt;_top++;
2185         _last_free = b;
2186         return &amp;(b-&gt;_methods[i]);
2187       } else if (b-&gt;_top == b-&gt;_number_of_methods) {
2188         // if the next free entry ran off the block see if there&#39;s a free entry
2189         for (int i = 0; i &lt; b-&gt;_number_of_methods; i++) {
2190           if (b-&gt;_methods[i] == _free_method) {
2191             b-&gt;_methods[i] = m;
2192             _last_free = b;
2193             return &amp;(b-&gt;_methods[i]);
2194           }
2195         }
2196         // Only check each block once for frees.  They&#39;re very unlikely.
2197         // Increment top past the end of the block.
2198         b-&gt;_top++;
2199       }
2200       // need to allocate a next block.
2201       if (b-&gt;_next == NULL) {
2202         b-&gt;_next = _last_free = new JNIMethodBlockNode();
2203       }
2204     }
2205     guarantee(false, &quot;Should always allocate a free block&quot;);
2206     return NULL;
2207   }
2208 
2209   bool contains(Method** m) {
2210     if (m == NULL) return false;
2211     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
2212       if (b-&gt;_methods &lt;= m &amp;&amp; m &lt; b-&gt;_methods + b-&gt;_number_of_methods) {
2213         // This is a bit of extra checking, for two reasons.  One is
2214         // that contains() deals with pointers that are passed in by
2215         // JNI code, so making sure that the pointer is aligned
2216         // correctly is valuable.  The other is that &lt;= and &gt; are
2217         // technically not defined on pointers, so the if guard can
2218         // pass spuriously; no modern compiler is likely to make that
2219         // a problem, though (and if one did, the guard could also
2220         // fail spuriously, which would be bad).
2221         ptrdiff_t idx = m - b-&gt;_methods;
2222         if (b-&gt;_methods + idx == m) {
2223           return true;
2224         }
2225       }
2226     }
2227     return false;  // not found
2228   }
2229 
2230   // Doesn&#39;t really destroy it, just marks it as free so it can be reused.
2231   void destroy_method(Method** m) {
2232 #ifdef ASSERT
2233     assert(contains(m), &quot;should be a methodID&quot;);
2234 #endif // ASSERT
2235     *m = _free_method;
2236   }
2237 
2238   // During class unloading the methods are cleared, which is different
2239   // than freed.
2240   void clear_all_methods() {
2241     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
2242       for (int i = 0; i&lt; b-&gt;_number_of_methods; i++) {
2243         b-&gt;_methods[i] = NULL;
2244       }
2245     }
2246   }
2247 #ifndef PRODUCT
2248   int count_methods() {
2249     // count all allocated methods
2250     int count = 0;
2251     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
2252       for (int i = 0; i&lt; b-&gt;_number_of_methods; i++) {
2253         if (b-&gt;_methods[i] != _free_method) count++;
2254       }
2255     }
2256     return count;
2257   }
2258 #endif // PRODUCT
2259 };
2260 
2261 // Something that can&#39;t be mistaken for an address or a markWord
2262 Method* const JNIMethodBlock::_free_method = (Method*)55;
2263 
2264 JNIMethodBlockNode::JNIMethodBlockNode(int num_methods) : _top(0), _next(NULL) {
2265   _number_of_methods = MAX2(num_methods, min_block_size);
2266   _methods = NEW_C_HEAP_ARRAY(Method*, _number_of_methods, mtInternal);
2267   for (int i = 0; i &lt; _number_of_methods; i++) {
2268     _methods[i] = JNIMethodBlock::_free_method;
2269   }
2270 }
2271 
2272 void Method::ensure_jmethod_ids(ClassLoaderData* loader_data, int capacity) {
2273   ClassLoaderData* cld = loader_data;
2274   if (!SafepointSynchronize::is_at_safepoint()) {
2275     // Have to add jmethod_ids() to class loader data thread-safely.
2276     // Also have to add the method to the list safely, which the cld lock
2277     // protects as well.
2278     MutexLocker ml(cld-&gt;metaspace_lock(),  Mutex::_no_safepoint_check_flag);
2279     if (cld-&gt;jmethod_ids() == NULL) {
2280       cld-&gt;set_jmethod_ids(new JNIMethodBlock(capacity));
2281     } else {
2282       cld-&gt;jmethod_ids()-&gt;ensure_methods(capacity);
2283     }
2284   } else {
2285     // At safepoint, we are single threaded and can set this.
2286     if (cld-&gt;jmethod_ids() == NULL) {
2287       cld-&gt;set_jmethod_ids(new JNIMethodBlock(capacity));
2288     } else {
2289       cld-&gt;jmethod_ids()-&gt;ensure_methods(capacity);
2290     }
2291   }
2292 }
2293 
2294 // Add a method id to the jmethod_ids
2295 jmethodID Method::make_jmethod_id(ClassLoaderData* loader_data, Method* m) {
2296   ClassLoaderData* cld = loader_data;
2297 
2298   if (!SafepointSynchronize::is_at_safepoint()) {
2299     // Have to add jmethod_ids() to class loader data thread-safely.
2300     // Also have to add the method to the list safely, which the cld lock
2301     // protects as well.
2302     MutexLocker ml(cld-&gt;metaspace_lock(),  Mutex::_no_safepoint_check_flag);
2303     if (cld-&gt;jmethod_ids() == NULL) {
2304       cld-&gt;set_jmethod_ids(new JNIMethodBlock());
2305     }
2306     // jmethodID is a pointer to Method*
2307     return (jmethodID)cld-&gt;jmethod_ids()-&gt;add_method(m);
2308   } else {
2309     // At safepoint, we are single threaded and can set this.
2310     if (cld-&gt;jmethod_ids() == NULL) {
2311       cld-&gt;set_jmethod_ids(new JNIMethodBlock());
2312     }
2313     // jmethodID is a pointer to Method*
2314     return (jmethodID)cld-&gt;jmethod_ids()-&gt;add_method(m);
2315   }
2316 }
2317 
2318 jmethodID Method::jmethod_id() {
2319   methodHandle mh(Thread::current(), this);
2320   return method_holder()-&gt;get_jmethod_id(mh);
2321 }
2322 
2323 // Mark a jmethodID as free.  This is called when there is a data race in
2324 // InstanceKlass while creating the jmethodID cache.
2325 void Method::destroy_jmethod_id(ClassLoaderData* loader_data, jmethodID m) {
2326   ClassLoaderData* cld = loader_data;
2327   Method** ptr = (Method**)m;
2328   assert(cld-&gt;jmethod_ids() != NULL, &quot;should have method handles&quot;);
2329   cld-&gt;jmethod_ids()-&gt;destroy_method(ptr);
2330 }
2331 
2332 void Method::change_method_associated_with_jmethod_id(jmethodID jmid, Method* new_method) {
2333   // Can&#39;t assert the method_holder is the same because the new method has the
2334   // scratch method holder.
2335   assert(resolve_jmethod_id(jmid)-&gt;method_holder()-&gt;class_loader()
2336            == new_method-&gt;method_holder()-&gt;class_loader() ||
2337            new_method-&gt;method_holder()-&gt;class_loader() == NULL, // allow Unsafe substitution
2338          &quot;changing to a different class loader&quot;);
2339   // Just change the method in place, jmethodID pointer doesn&#39;t change.
2340   *((Method**)jmid) = new_method;
2341 }
2342 
2343 bool Method::is_method_id(jmethodID mid) {
2344   Method* m = resolve_jmethod_id(mid);
2345   assert(m != NULL, &quot;should be called with non-null method&quot;);
2346   InstanceKlass* ik = m-&gt;method_holder();
2347   ClassLoaderData* cld = ik-&gt;class_loader_data();
2348   if (cld-&gt;jmethod_ids() == NULL) return false;
2349   return (cld-&gt;jmethod_ids()-&gt;contains((Method**)mid));
2350 }
2351 
2352 Method* Method::checked_resolve_jmethod_id(jmethodID mid) {
2353   if (mid == NULL) return NULL;
2354   Method* o = resolve_jmethod_id(mid);
2355   if (o == NULL || o == JNIMethodBlock::_free_method || !((Metadata*)o)-&gt;is_method()) {
2356     return NULL;
2357   }
2358   return o;
2359 };
2360 
2361 void Method::set_on_stack(const bool value) {
2362   // Set both the method itself and its constant pool.  The constant pool
2363   // on stack means some method referring to it is also on the stack.
2364   constants()-&gt;set_on_stack(value);
2365 
2366   bool already_set = on_stack();
2367   _access_flags.set_on_stack(value);
2368   if (value &amp;&amp; !already_set) {
2369     MetadataOnStackMark::record(this);
2370   }
2371   assert(!value || !is_old() || is_obsolete() || is_running_emcp(),
2372          &quot;emcp methods cannot run after emcp bit is cleared&quot;);
2373 }
2374 
2375 // Called when the class loader is unloaded to make all methods weak.
2376 void Method::clear_jmethod_ids(ClassLoaderData* loader_data) {
2377   loader_data-&gt;jmethod_ids()-&gt;clear_all_methods();
2378 }
2379 
2380 bool Method::has_method_vptr(const void* ptr) {
2381   Method m;
2382   // This assumes that the vtbl pointer is the first word of a C++ object.
2383   return dereference_vptr(&amp;m) == dereference_vptr(ptr);
2384 }
2385 
2386 // Check that this pointer is valid by checking that the vtbl pointer matches
2387 bool Method::is_valid_method(const Method* m) {
2388   if (m == NULL) {
2389     return false;
2390   } else if ((intptr_t(m) &amp; (wordSize-1)) != 0) {
2391     // Quick sanity check on pointer.
2392     return false;
2393   } else if (m-&gt;is_shared()) {
2394     return MetaspaceShared::is_valid_shared_method(m);
2395   } else if (Metaspace::contains_non_shared(m)) {
2396     return has_method_vptr((const void*)m);
2397   } else {
2398     return false;
2399   }
2400 }
2401 
2402 #ifndef PRODUCT
2403 void Method::print_jmethod_ids(const ClassLoaderData* loader_data, outputStream* out) {
2404   out-&gt;print(&quot; jni_method_id count = %d&quot;, loader_data-&gt;jmethod_ids()-&gt;count_methods());
2405 }
2406 #endif // PRODUCT
2407 
2408 
2409 // Printing
2410 
2411 #ifndef PRODUCT
2412 
2413 void Method::print_on(outputStream* st) const {
2414   ResourceMark rm;
2415   assert(is_method(), &quot;must be method&quot;);
2416   st-&gt;print_cr(&quot;%s&quot;, internal_name());
2417   st-&gt;print_cr(&quot; - this oop:          &quot; INTPTR_FORMAT, p2i(this));
2418   st-&gt;print   (&quot; - method holder:     &quot;); method_holder()-&gt;print_value_on(st); st-&gt;cr();
2419   st-&gt;print   (&quot; - constants:         &quot; INTPTR_FORMAT &quot; &quot;, p2i(constants()));
2420   constants()-&gt;print_value_on(st); st-&gt;cr();
2421   st-&gt;print   (&quot; - access:            0x%x  &quot;, access_flags().as_int()); access_flags().print_on(st); st-&gt;cr();
2422   st-&gt;print   (&quot; - name:              &quot;);    name()-&gt;print_value_on(st); st-&gt;cr();
2423   st-&gt;print   (&quot; - signature:         &quot;);    signature()-&gt;print_value_on(st); st-&gt;cr();
2424   st-&gt;print_cr(&quot; - max stack:         %d&quot;,   max_stack());
2425   st-&gt;print_cr(&quot; - max locals:        %d&quot;,   max_locals());
2426   st-&gt;print_cr(&quot; - size of params:    %d&quot;,   size_of_parameters());
2427   st-&gt;print_cr(&quot; - method size:       %d&quot;,   method_size());
2428   if (intrinsic_id() != vmIntrinsics::_none)
2429     st-&gt;print_cr(&quot; - intrinsic id:      %d %s&quot;, intrinsic_id(), vmIntrinsics::name_at(intrinsic_id()));
2430   if (highest_comp_level() != CompLevel_none)
2431     st-&gt;print_cr(&quot; - highest level:     %d&quot;, highest_comp_level());
2432   st-&gt;print_cr(&quot; - vtable index:      %d&quot;,   _vtable_index);
<a name="28" id="anc28"></a><span class="line-added">2433   if (valid_itable_index())</span>
<span class="line-added">2434     st-&gt;print_cr(&quot; - itable index:      %d&quot;,   itable_index());</span>
2435   st-&gt;print_cr(&quot; - i2i entry:         &quot; INTPTR_FORMAT, p2i(interpreter_entry()));
2436   st-&gt;print(   &quot; - adapters:          &quot;);
2437   AdapterHandlerEntry* a = ((Method*)this)-&gt;adapter();
2438   if (a == NULL)
2439     st-&gt;print_cr(INTPTR_FORMAT, p2i(a));
2440   else
2441     a-&gt;print_adapter_on(st);
2442   st-&gt;print_cr(&quot; - compiled entry     &quot; INTPTR_FORMAT, p2i(from_compiled_entry()));
2443   st-&gt;print_cr(&quot; - code size:         %d&quot;,   code_size());
2444   if (code_size() != 0) {
2445     st-&gt;print_cr(&quot; - code start:        &quot; INTPTR_FORMAT, p2i(code_base()));
2446     st-&gt;print_cr(&quot; - code end (excl):   &quot; INTPTR_FORMAT, p2i(code_base() + code_size()));
2447   }
2448   if (method_data() != NULL) {
2449     st-&gt;print_cr(&quot; - method data:       &quot; INTPTR_FORMAT, p2i(method_data()));
2450   }
2451   st-&gt;print_cr(&quot; - checked ex length: %d&quot;,   checked_exceptions_length());
2452   if (checked_exceptions_length() &gt; 0) {
2453     CheckedExceptionElement* table = checked_exceptions_start();
2454     st-&gt;print_cr(&quot; - checked ex start:  &quot; INTPTR_FORMAT, p2i(table));
2455     if (Verbose) {
2456       for (int i = 0; i &lt; checked_exceptions_length(); i++) {
2457         st-&gt;print_cr(&quot;   - throws %s&quot;, constants()-&gt;printable_name_at(table[i].class_cp_index));
2458       }
2459     }
2460   }
2461   if (has_linenumber_table()) {
2462     u_char* table = compressed_linenumber_table();
2463     st-&gt;print_cr(&quot; - linenumber start:  &quot; INTPTR_FORMAT, p2i(table));
2464     if (Verbose) {
2465       CompressedLineNumberReadStream stream(table);
2466       while (stream.read_pair()) {
2467         st-&gt;print_cr(&quot;   - line %d: %d&quot;, stream.line(), stream.bci());
2468       }
2469     }
2470   }
2471   st-&gt;print_cr(&quot; - localvar length:   %d&quot;,   localvariable_table_length());
2472   if (localvariable_table_length() &gt; 0) {
2473     LocalVariableTableElement* table = localvariable_table_start();
2474     st-&gt;print_cr(&quot; - localvar start:    &quot; INTPTR_FORMAT, p2i(table));
2475     if (Verbose) {
2476       for (int i = 0; i &lt; localvariable_table_length(); i++) {
2477         int bci = table[i].start_bci;
2478         int len = table[i].length;
2479         const char* name = constants()-&gt;printable_name_at(table[i].name_cp_index);
2480         const char* desc = constants()-&gt;printable_name_at(table[i].descriptor_cp_index);
2481         int slot = table[i].slot;
2482         st-&gt;print_cr(&quot;   - %s %s bci=%d len=%d slot=%d&quot;, desc, name, bci, len, slot);
2483       }
2484     }
2485   }
2486   if (code() != NULL) {
2487     st-&gt;print   (&quot; - compiled code: &quot;);
2488     code()-&gt;print_value_on(st);
2489   }
2490   if (is_native()) {
2491     st-&gt;print_cr(&quot; - native function:   &quot; INTPTR_FORMAT, p2i(native_function()));
2492     st-&gt;print_cr(&quot; - signature handler: &quot; INTPTR_FORMAT, p2i(signature_handler()));
2493   }
2494 }
2495 
2496 void Method::print_linkage_flags(outputStream* st) {
2497   access_flags().print_on(st);
2498   if (is_default_method()) {
2499     st-&gt;print(&quot;default &quot;);
2500   }
2501   if (is_overpass()) {
2502     st-&gt;print(&quot;overpass &quot;);
2503   }
2504 }
2505 #endif //PRODUCT
2506 
2507 void Method::print_value_on(outputStream* st) const {
2508   assert(is_method(), &quot;must be method&quot;);
2509   st-&gt;print(&quot;%s&quot;, internal_name());
2510   print_address_on(st);
2511   st-&gt;print(&quot; &quot;);
<a name="29" id="anc29"></a><span class="line-added">2512   if (WizardMode) access_flags().print_on(st);</span>
2513   name()-&gt;print_value_on(st);
2514   st-&gt;print(&quot; &quot;);
2515   signature()-&gt;print_value_on(st);
2516   st-&gt;print(&quot; in &quot;);
2517   method_holder()-&gt;print_value_on(st);
2518   if (WizardMode) st-&gt;print(&quot;#%d&quot;, _vtable_index);
2519   if (WizardMode) st-&gt;print(&quot;[%d,%d]&quot;, size_of_parameters(), max_locals());
2520   if (WizardMode &amp;&amp; code() != NULL) st-&gt;print(&quot; ((nmethod*)%p)&quot;, code());
2521 }
2522 
2523 // LogTouchedMethods and PrintTouchedMethods
2524 
2525 // TouchedMethodRecord -- we can&#39;t use a HashtableEntry&lt;Method*&gt; because
2526 // the Method may be garbage collected. Let&#39;s roll our own hash table.
2527 class TouchedMethodRecord : CHeapObj&lt;mtTracing&gt; {
2528 public:
2529   // It&#39;s OK to store Symbols here because they will NOT be GC&#39;ed if
2530   // LogTouchedMethods is enabled.
2531   TouchedMethodRecord* _next;
2532   Symbol* _class_name;
2533   Symbol* _method_name;
2534   Symbol* _method_signature;
2535 };
2536 
2537 static const int TOUCHED_METHOD_TABLE_SIZE = 20011;
2538 static TouchedMethodRecord** _touched_method_table = NULL;
2539 
2540 void Method::log_touched(TRAPS) {
2541 
2542   const int table_size = TOUCHED_METHOD_TABLE_SIZE;
2543   Symbol* my_class = klass_name();
2544   Symbol* my_name  = name();
2545   Symbol* my_sig   = signature();
2546 
2547   unsigned int hash = my_class-&gt;identity_hash() +
2548                       my_name-&gt;identity_hash() +
2549                       my_sig-&gt;identity_hash();
2550   juint index = juint(hash) % table_size;
2551 
2552   MutexLocker ml(THREAD, TouchedMethodLog_lock);
2553   if (_touched_method_table == NULL) {
2554     _touched_method_table = NEW_C_HEAP_ARRAY2(TouchedMethodRecord*, table_size,
2555                                               mtTracing, CURRENT_PC);
2556     memset(_touched_method_table, 0, sizeof(TouchedMethodRecord*)*table_size);
2557   }
2558 
2559   TouchedMethodRecord* ptr = _touched_method_table[index];
2560   while (ptr) {
2561     if (ptr-&gt;_class_name       == my_class &amp;&amp;
2562         ptr-&gt;_method_name      == my_name &amp;&amp;
2563         ptr-&gt;_method_signature == my_sig) {
2564       return;
2565     }
2566     if (ptr-&gt;_next == NULL) break;
2567     ptr = ptr-&gt;_next;
2568   }
2569   TouchedMethodRecord* nptr = NEW_C_HEAP_OBJ(TouchedMethodRecord, mtTracing);
2570   my_class-&gt;increment_refcount();
2571   my_name-&gt;increment_refcount();
2572   my_sig-&gt;increment_refcount();
2573   nptr-&gt;_class_name         = my_class;
2574   nptr-&gt;_method_name        = my_name;
2575   nptr-&gt;_method_signature   = my_sig;
2576   nptr-&gt;_next               = NULL;
2577 
2578   if (ptr == NULL) {
2579     // first
2580     _touched_method_table[index] = nptr;
2581   } else {
2582     ptr-&gt;_next = nptr;
2583   }
2584 }
2585 
2586 void Method::print_touched_methods(outputStream* out) {
2587   MutexLocker ml(Thread::current()-&gt;is_VM_thread() ? NULL : TouchedMethodLog_lock);
2588   out-&gt;print_cr(&quot;# Method::print_touched_methods version 1&quot;);
2589   if (_touched_method_table) {
2590     for (int i = 0; i &lt; TOUCHED_METHOD_TABLE_SIZE; i++) {
2591       TouchedMethodRecord* ptr = _touched_method_table[i];
2592       while(ptr) {
2593         ptr-&gt;_class_name-&gt;print_symbol_on(out);       out-&gt;print(&quot;.&quot;);
2594         ptr-&gt;_method_name-&gt;print_symbol_on(out);      out-&gt;print(&quot;:&quot;);
2595         ptr-&gt;_method_signature-&gt;print_symbol_on(out); out-&gt;cr();
2596         ptr = ptr-&gt;_next;
2597       }
2598     }
2599   }
2600 }
2601 
2602 // Verification
2603 
2604 void Method::verify_on(outputStream* st) {
2605   guarantee(is_method(), &quot;object must be method&quot;);
2606   guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
2607   MethodData* md = method_data();
2608   guarantee(md == NULL ||
2609       md-&gt;is_methodData(), &quot;should be method data&quot;);
2610 }
<a name="30" id="anc30"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="30" type="hidden" />
</body>
</html>