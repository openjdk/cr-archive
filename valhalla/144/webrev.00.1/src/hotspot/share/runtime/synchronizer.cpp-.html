<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/runtime/synchronizer.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;logging/log.hpp&quot;
  28 #include &quot;logging/logStream.hpp&quot;
  29 #include &quot;jfr/jfrEvents.hpp&quot;
  30 #include &quot;memory/allocation.inline.hpp&quot;
  31 #include &quot;memory/metaspaceShared.hpp&quot;
  32 #include &quot;memory/padded.hpp&quot;
  33 #include &quot;memory/resourceArea.hpp&quot;
  34 #include &quot;memory/universe.hpp&quot;
  35 #include &quot;oops/markWord.hpp&quot;
  36 #include &quot;oops/oop.inline.hpp&quot;
  37 #include &quot;runtime/atomic.hpp&quot;
  38 #include &quot;runtime/biasedLocking.hpp&quot;
  39 #include &quot;runtime/handles.inline.hpp&quot;
  40 #include &quot;runtime/handshake.hpp&quot;
  41 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  42 #include &quot;runtime/mutexLocker.hpp&quot;
  43 #include &quot;runtime/objectMonitor.hpp&quot;
  44 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  45 #include &quot;runtime/osThread.hpp&quot;
  46 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  47 #include &quot;runtime/safepointVerifiers.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 #include &quot;runtime/stubRoutines.hpp&quot;
  50 #include &quot;runtime/synchronizer.hpp&quot;
  51 #include &quot;runtime/thread.inline.hpp&quot;
  52 #include &quot;runtime/timer.hpp&quot;
  53 #include &quot;runtime/vframe.hpp&quot;
  54 #include &quot;runtime/vmThread.hpp&quot;
  55 #include &quot;utilities/align.hpp&quot;
  56 #include &quot;utilities/dtrace.hpp&quot;
  57 #include &quot;utilities/events.hpp&quot;
  58 #include &quot;utilities/preserveException.hpp&quot;
  59 
  60 // The &quot;core&quot; versions of monitor enter and exit reside in this file.
  61 // The interpreter and compilers contain specialized transliterated
  62 // variants of the enter-exit fast-path operations.  See i486.ad fast_lock(),
  63 // for instance.  If you make changes here, make sure to modify the
  64 // interpreter, and both C1 and C2 fast-path inline locking code emission.
  65 //
  66 // -----------------------------------------------------------------------------
  67 
  68 #ifdef DTRACE_ENABLED
  69 
  70 // Only bother with this argument setup if dtrace is available
  71 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  72 
  73 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  74   char* bytes = NULL;                                                      \
  75   int len = 0;                                                             \
  76   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  77   Symbol* klassname = ((oop)(obj))-&gt;klass()-&gt;name();                       \
  78   if (klassname != NULL) {                                                 \
  79     bytes = (char*)klassname-&gt;bytes();                                     \
  80     len = klassname-&gt;utf8_length();                                        \
  81   }
  82 
  83 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  84   {                                                                        \
  85     if (DTraceMonitorProbes) {                                             \
  86       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  87       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  88                            (uintptr_t)(monitor), bytes, len, (millis));    \
  89     }                                                                      \
  90   }
  91 
  92 #define HOTSPOT_MONITOR_PROBE_notify HOTSPOT_MONITOR_NOTIFY
  93 #define HOTSPOT_MONITOR_PROBE_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  94 #define HOTSPOT_MONITOR_PROBE_waited HOTSPOT_MONITOR_WAITED
  95 
  96 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  97   {                                                                        \
  98     if (DTraceMonitorProbes) {                                             \
  99       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
 100       HOTSPOT_MONITOR_PROBE_##probe(jtid, /* probe = waited */             \
 101                                     (uintptr_t)(monitor), bytes, len);     \
 102     }                                                                      \
 103   }
 104 
 105 #else //  ndef DTRACE_ENABLED
 106 
 107 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
 108 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
 109 
 110 #endif // ndef DTRACE_ENABLED
 111 
 112 // This exists only as a workaround of dtrace bug 6254741
 113 int dtrace_waited_probe(ObjectMonitor* monitor, Handle obj, Thread* thr) {
 114   DTRACE_MONITOR_PROBE(waited, monitor, obj(), thr);
 115   return 0;
 116 }
 117 
 118 #define NINFLATIONLOCKS 256
 119 static volatile intptr_t gInflationLocks[NINFLATIONLOCKS];
 120 
 121 // global list of blocks of monitors
 122 PaddedObjectMonitor* ObjectSynchronizer::g_block_list = NULL;
 123 bool volatile ObjectSynchronizer::_is_async_deflation_requested = false;
 124 jlong ObjectSynchronizer::_last_async_deflation_time_ns = 0;
 125 
 126 struct ObjectMonitorListGlobals {
 127   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 128   // These are highly shared list related variables.
 129   // To avoid false-sharing they need to be the sole occupants of a cache line.
 130 
 131   // Global ObjectMonitor free list. Newly allocated and deflated
 132   // ObjectMonitors are prepended here.
 133   ObjectMonitor* _free_list;
 134   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 135 
 136   // Global ObjectMonitor in-use list. When a JavaThread is exiting,
 137   // ObjectMonitors on its per-thread in-use list are prepended here.
 138   ObjectMonitor* _in_use_list;
 139   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 140 
 141   // Global ObjectMonitor wait list. Deflated ObjectMonitors wait on
 142   // this list until after a handshake or a safepoint for platforms
 143   // that don&#39;t support handshakes. After the handshake or safepoint,
 144   // the deflated ObjectMonitors are prepended to free_list.
 145   ObjectMonitor* _wait_list;
 146   DEFINE_PAD_MINUS_SIZE(3, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 147 
 148   int _free_count;    // # on free_list
 149   DEFINE_PAD_MINUS_SIZE(4, OM_CACHE_LINE_SIZE, sizeof(int));
 150 
 151   int _in_use_count;  // # on in_use_list
 152   DEFINE_PAD_MINUS_SIZE(5, OM_CACHE_LINE_SIZE, sizeof(int));
 153 
 154   int _population;    // # Extant -- in circulation
 155   DEFINE_PAD_MINUS_SIZE(6, OM_CACHE_LINE_SIZE, sizeof(int));
 156 
 157   int _wait_count;    // # on wait_list
 158   DEFINE_PAD_MINUS_SIZE(7, OM_CACHE_LINE_SIZE, sizeof(int));
 159 };
 160 static ObjectMonitorListGlobals om_list_globals;
 161 
 162 #define CHAINMARKER (cast_to_oop&lt;intptr_t&gt;(-1))
 163 
 164 
 165 // =====================&gt; Spin-lock functions
 166 
 167 // ObjectMonitors are not lockable outside of this file. We use spin-locks
 168 // implemented using a bit in the _next_om field instead of the heavier
 169 // weight locking mechanisms for faster list management.
 170 
 171 #define OM_LOCK_BIT 0x1
 172 
 173 // Return true if the ObjectMonitor is locked.
 174 // Otherwise returns false.
 175 static bool is_locked(ObjectMonitor* om) {
 176   return ((intptr_t)om-&gt;next_om() &amp; OM_LOCK_BIT) == OM_LOCK_BIT;
 177 }
 178 
 179 // Mark an ObjectMonitor* with OM_LOCK_BIT and return it.
 180 static ObjectMonitor* mark_om_ptr(ObjectMonitor* om) {
 181   return (ObjectMonitor*)((intptr_t)om | OM_LOCK_BIT);
 182 }
 183 
 184 // Return the unmarked next field in an ObjectMonitor. Note: the next
 185 // field may or may not have been marked with OM_LOCK_BIT originally.
 186 static ObjectMonitor* unmarked_next(ObjectMonitor* om) {
 187   return (ObjectMonitor*)((intptr_t)om-&gt;next_om() &amp; ~OM_LOCK_BIT);
 188 }
 189 
 190 // Try to lock an ObjectMonitor. Returns true if locking was successful.
 191 // Otherwise returns false.
 192 static bool try_om_lock(ObjectMonitor* om) {
 193   // Get current next field without any OM_LOCK_BIT value.
 194   ObjectMonitor* next = unmarked_next(om);
 195   if (om-&gt;try_set_next_om(next, mark_om_ptr(next)) != next) {
 196     return false;  // Cannot lock the ObjectMonitor.
 197   }
 198   return true;
 199 }
 200 
 201 // Lock an ObjectMonitor.
 202 static void om_lock(ObjectMonitor* om) {
 203   while (true) {
 204     if (try_om_lock(om)) {
 205       return;
 206     }
 207   }
 208 }
 209 
 210 // Unlock an ObjectMonitor.
 211 static void om_unlock(ObjectMonitor* om) {
 212   ObjectMonitor* next = om-&gt;next_om();
 213   guarantee(((intptr_t)next &amp; OM_LOCK_BIT) == OM_LOCK_BIT, &quot;next=&quot; INTPTR_FORMAT
 214             &quot; must have OM_LOCK_BIT=%x set.&quot;, p2i(next), OM_LOCK_BIT);
 215 
 216   next = (ObjectMonitor*)((intptr_t)next &amp; ~OM_LOCK_BIT);  // Clear OM_LOCK_BIT.
 217   om-&gt;set_next_om(next);
 218 }
 219 
 220 // Get the list head after locking it. Returns the list head or NULL
 221 // if the list is empty.
 222 static ObjectMonitor* get_list_head_locked(ObjectMonitor** list_p) {
 223   while (true) {
 224     ObjectMonitor* mid = Atomic::load(list_p);
 225     if (mid == NULL) {
 226       return NULL;  // The list is empty.
 227     }
 228     if (try_om_lock(mid)) {
 229       if (Atomic::load(list_p) != mid) {
 230         // The list head changed before we could lock it so we have to retry.
 231         om_unlock(mid);
 232         continue;
 233       }
 234       return mid;
 235     }
 236   }
 237 }
 238 
 239 #undef OM_LOCK_BIT
 240 
 241 
 242 // =====================&gt; List Management functions
 243 
 244 // Prepend a list of ObjectMonitors to the specified *list_p. &#39;tail&#39; is
 245 // the last ObjectMonitor in the list and there are &#39;count&#39; on the list.
 246 // Also updates the specified *count_p.
 247 static void prepend_list_to_common(ObjectMonitor* list, ObjectMonitor* tail,
 248                                    int count, ObjectMonitor** list_p,
 249                                    int* count_p) {
 250   while (true) {
 251     ObjectMonitor* cur = Atomic::load(list_p);
 252     // Prepend list to *list_p.
 253     if (!try_om_lock(tail)) {
 254       // Failed to lock tail due to a list walker so try it all again.
 255       continue;
 256     }
 257     tail-&gt;set_next_om(cur);  // tail now points to cur (and unlocks tail)
 258     if (cur == NULL) {
 259       // No potential race with takers or other prependers since
 260       // *list_p is empty.
 261       if (Atomic::cmpxchg(list_p, cur, list) == cur) {
 262         // Successfully switched *list_p to the list value.
 263         Atomic::add(count_p, count);
 264         break;
 265       }
 266       // Implied else: try it all again
 267     } else {
 268       if (!try_om_lock(cur)) {
 269         continue;  // failed to lock cur so try it all again
 270       }
 271       // We locked cur so try to switch *list_p to the list value.
 272       if (Atomic::cmpxchg(list_p, cur, list) != cur) {
 273         // The list head has changed so unlock cur and try again:
 274         om_unlock(cur);
 275         continue;
 276       }
 277       Atomic::add(count_p, count);
 278       om_unlock(cur);
 279       break;
 280     }
 281   }
 282 }
 283 
 284 // Prepend a newly allocated block of ObjectMonitors to g_block_list and
 285 // om_list_globals._free_list. Also updates om_list_globals._population
 286 // and om_list_globals._free_count.
 287 void ObjectSynchronizer::prepend_block_to_lists(PaddedObjectMonitor* new_blk) {
 288   // First we handle g_block_list:
 289   while (true) {
 290     PaddedObjectMonitor* cur = Atomic::load(&amp;g_block_list);
 291     // Prepend new_blk to g_block_list. The first ObjectMonitor in
 292     // a block is reserved for use as linkage to the next block.
 293     new_blk[0].set_next_om(cur);
 294     if (Atomic::cmpxchg(&amp;g_block_list, cur, new_blk) == cur) {
 295       // Successfully switched g_block_list to the new_blk value.
 296       Atomic::add(&amp;om_list_globals._population, _BLOCKSIZE - 1);
 297       break;
 298     }
 299     // Implied else: try it all again
 300   }
 301 
 302   // Second we handle om_list_globals._free_list:
 303   prepend_list_to_common(new_blk + 1, &amp;new_blk[_BLOCKSIZE - 1], _BLOCKSIZE - 1,
 304                          &amp;om_list_globals._free_list, &amp;om_list_globals._free_count);
 305 }
 306 
 307 // Prepend a list of ObjectMonitors to om_list_globals._free_list.
 308 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 309 // on the list. Also updates om_list_globals._free_count.
 310 static void prepend_list_to_global_free_list(ObjectMonitor* list,
 311                                              ObjectMonitor* tail, int count) {
 312   prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
 313                          &amp;om_list_globals._free_count);
 314 }
 315 
 316 // Prepend a list of ObjectMonitors to om_list_globals._wait_list.
 317 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 318 // on the list. Also updates om_list_globals._wait_count.
 319 static void prepend_list_to_global_wait_list(ObjectMonitor* list,
 320                                              ObjectMonitor* tail, int count) {
 321   prepend_list_to_common(list, tail, count, &amp;om_list_globals._wait_list,
 322                          &amp;om_list_globals._wait_count);
 323 }
 324 
 325 // Prepend a list of ObjectMonitors to om_list_globals._in_use_list.
 326 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 327 // on the list. Also updates om_list_globals._in_use_list.
 328 static void prepend_list_to_global_in_use_list(ObjectMonitor* list,
 329                                                ObjectMonitor* tail, int count) {
 330   prepend_list_to_common(list, tail, count, &amp;om_list_globals._in_use_list,
 331                          &amp;om_list_globals._in_use_count);
 332 }
 333 
 334 // Prepend an ObjectMonitor to the specified list. Also updates
 335 // the specified counter.
 336 static void prepend_to_common(ObjectMonitor* m, ObjectMonitor** list_p,
 337                               int* count_p) {
 338   while (true) {
 339     om_lock(m);  // Lock m so we can safely update its next field.
 340     ObjectMonitor* cur = NULL;
 341     // Lock the list head to guard against races with a list walker
 342     // or async deflater thread (which only races in om_in_use_list):
 343     if ((cur = get_list_head_locked(list_p)) != NULL) {
 344       // List head is now locked so we can safely switch it.
 345       m-&gt;set_next_om(cur);  // m now points to cur (and unlocks m)
 346       Atomic::store(list_p, m);  // Switch list head to unlocked m.
 347       om_unlock(cur);
 348       break;
 349     }
 350     // The list is empty so try to set the list head.
 351     assert(cur == NULL, &quot;cur must be NULL: cur=&quot; INTPTR_FORMAT, p2i(cur));
 352     m-&gt;set_next_om(cur);  // m now points to NULL (and unlocks m)
 353     if (Atomic::cmpxchg(list_p, cur, m) == cur) {
 354       // List head is now unlocked m.
 355       break;
 356     }
 357     // Implied else: try it all again
 358   }
 359   Atomic::inc(count_p);
 360 }
 361 
 362 // Prepend an ObjectMonitor to a per-thread om_free_list.
 363 // Also updates the per-thread om_free_count.
 364 static void prepend_to_om_free_list(Thread* self, ObjectMonitor* m) {
 365   prepend_to_common(m, &amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 366 }
 367 
 368 // Prepend an ObjectMonitor to a per-thread om_in_use_list.
 369 // Also updates the per-thread om_in_use_count.
 370 static void prepend_to_om_in_use_list(Thread* self, ObjectMonitor* m) {
 371   prepend_to_common(m, &amp;self-&gt;om_in_use_list, &amp;self-&gt;om_in_use_count);
 372 }
 373 
 374 // Take an ObjectMonitor from the start of the specified list. Also
 375 // decrements the specified counter. Returns NULL if none are available.
 376 static ObjectMonitor* take_from_start_of_common(ObjectMonitor** list_p,
 377                                                 int* count_p) {
 378   ObjectMonitor* take = NULL;
 379   // Lock the list head to guard against races with a list walker
 380   // or async deflater thread (which only races in om_list_globals._free_list):
 381   if ((take = get_list_head_locked(list_p)) == NULL) {
 382     return NULL;  // None are available.
 383   }
 384   ObjectMonitor* next = unmarked_next(take);
 385   // Switch locked list head to next (which unlocks the list head, but
 386   // leaves take locked):
 387   Atomic::store(list_p, next);
 388   Atomic::dec(count_p);
 389   // Unlock take, but leave the next value for any lagging list
 390   // walkers. It will get cleaned up when take is prepended to
 391   // the in-use list:
 392   om_unlock(take);
 393   return take;
 394 }
 395 
 396 // Take an ObjectMonitor from the start of the om_list_globals._free_list.
 397 // Also updates om_list_globals._free_count. Returns NULL if none are
 398 // available.
 399 static ObjectMonitor* take_from_start_of_global_free_list() {
 400   return take_from_start_of_common(&amp;om_list_globals._free_list,
 401                                    &amp;om_list_globals._free_count);
 402 }
 403 
 404 // Take an ObjectMonitor from the start of a per-thread free-list.
 405 // Also updates om_free_count. Returns NULL if none are available.
 406 static ObjectMonitor* take_from_start_of_om_free_list(Thread* self) {
 407   return take_from_start_of_common(&amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 408 }
 409 
 410 
 411 // =====================&gt; Quick functions
 412 
 413 // The quick_* forms are special fast-path variants used to improve
 414 // performance.  In the simplest case, a &quot;quick_*&quot; implementation could
 415 // simply return false, in which case the caller will perform the necessary
 416 // state transitions and call the slow-path form.
 417 // The fast-path is designed to handle frequently arising cases in an efficient
 418 // manner and is just a degenerate &quot;optimistic&quot; variant of the slow-path.
 419 // returns true  -- to indicate the call was satisfied.
 420 // returns false -- to indicate the call needs the services of the slow-path.
 421 // A no-loitering ordinance is in effect for code in the quick_* family
 422 // operators: safepoints or indefinite blocking (blocking that might span a
 423 // safepoint) are forbidden. Generally the thread_state() is _in_Java upon
 424 // entry.
 425 //
 426 // Consider: An interesting optimization is to have the JIT recognize the
 427 // following common idiom:
 428 //   synchronized (someobj) { .... ; notify(); }
 429 // That is, we find a notify() or notifyAll() call that immediately precedes
 430 // the monitorexit operation.  In that case the JIT could fuse the operations
 431 // into a single notifyAndExit() runtime primitive.
 432 
 433 bool ObjectSynchronizer::quick_notify(oopDesc* obj, Thread* self, bool all) {
 434   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 435   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 436   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 437   NoSafepointVerifier nsv;
 438   if (obj == NULL) return false;  // slow-path for invalid obj
 439   const markWord mark = obj-&gt;mark();
 440 
 441   if (mark.has_locker() &amp;&amp; self-&gt;is_lock_owned((address)mark.locker())) {
 442     // Degenerate notify
 443     // stack-locked by caller so by definition the implied waitset is empty.
 444     return true;
 445   }
 446 
 447   if (mark.has_monitor()) {
 448     ObjectMonitor* const mon = mark.monitor();
 449     assert(mon-&gt;object() == obj, &quot;invariant&quot;);
 450     if (mon-&gt;owner() != self) return false;  // slow-path for IMS exception
 451 
 452     if (mon-&gt;first_waiter() != NULL) {
 453       // We have one or more waiters. Since this is an inflated monitor
 454       // that we own, we can transfer one or more threads from the waitset
 455       // to the entrylist here and now, avoiding the slow-path.
 456       if (all) {
 457         DTRACE_MONITOR_PROBE(notifyAll, mon, obj, self);
 458       } else {
 459         DTRACE_MONITOR_PROBE(notify, mon, obj, self);
 460       }
 461       int free_count = 0;
 462       do {
 463         mon-&gt;INotify(self);
 464         ++free_count;
 465       } while (mon-&gt;first_waiter() != NULL &amp;&amp; all);
 466       OM_PERFDATA_OP(Notifications, inc(free_count));
 467     }
 468     return true;
 469   }
 470 
 471   // biased locking and any other IMS exception states take the slow-path
 472   return false;
 473 }
 474 
 475 
 476 // The LockNode emitted directly at the synchronization site would have
 477 // been too big if it were to have included support for the cases of inflated
 478 // recursive enter and exit, so they go here instead.
 479 // Note that we can&#39;t safely call AsyncPrintJavaStack() from within
 480 // quick_enter() as our thread state remains _in_Java.
 481 
 482 bool ObjectSynchronizer::quick_enter(oop obj, Thread* self,
 483                                      BasicLock * lock) {
 484   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 485   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 486   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 487   NoSafepointVerifier nsv;
 488   if (obj == NULL) return false;       // Need to throw NPE
 489 
 490   const markWord mark = obj-&gt;mark();
 491 
 492   if (mark.has_monitor()) {
 493     ObjectMonitor* const m = mark.monitor();
 494     if (AsyncDeflateIdleMonitors) {
 495       // An async deflation can race us before we manage to make the
 496       // ObjectMonitor busy by setting the owner below. If we detect
 497       // that race we just bail out to the slow-path here.
 498       if (m-&gt;object() == NULL) {
 499         return false;
 500       }
 501     } else {
 502       assert(m-&gt;object() == obj, &quot;invariant&quot;);
 503     }
 504     Thread* const owner = (Thread *) m-&gt;_owner;
 505 
 506     // Lock contention and Transactional Lock Elision (TLE) diagnostics
 507     // and observability
 508     // Case: light contention possibly amenable to TLE
 509     // Case: TLE inimical operations such as nested/recursive synchronization
 510 
 511     if (owner == self) {
 512       m-&gt;_recursions++;
 513       return true;
 514     }
 515 
 516     // This Java Monitor is inflated so obj&#39;s header will never be
 517     // displaced to this thread&#39;s BasicLock. Make the displaced header
 518     // non-NULL so this BasicLock is not seen as recursive nor as
 519     // being locked. We do this unconditionally so that this thread&#39;s
 520     // BasicLock cannot be mis-interpreted by any stack walkers. For
 521     // performance reasons, stack walkers generally first check for
 522     // Biased Locking in the object&#39;s header, the second check is for
 523     // stack-locking in the object&#39;s header, the third check is for
 524     // recursive stack-locking in the displaced header in the BasicLock,
 525     // and last are the inflated Java Monitor (ObjectMonitor) checks.
 526     lock-&gt;set_displaced_header(markWord::unused_mark());
 527 
 528     if (owner == NULL &amp;&amp; m-&gt;try_set_owner_from(NULL, self) == NULL) {
 529       assert(m-&gt;_recursions == 0, &quot;invariant&quot;);
 530       return true;
 531     }
 532   }
 533 
 534   // Note that we could inflate in quick_enter.
 535   // This is likely a useful optimization
 536   // Critically, in quick_enter() we must not:
 537   // -- perform bias revocation, or
 538   // -- block indefinitely, or
 539   // -- reach a safepoint
 540 
 541   return false;        // revert to slow-path
 542 }
 543 
 544 // -----------------------------------------------------------------------------
 545 // Monitor Enter/Exit
 546 // The interpreter and compiler assembly code tries to lock using the fast path
 547 // of this algorithm. Make sure to update that code if the following function is
 548 // changed. The implementation is extremely sensitive to race condition. Be careful.
 549 
 550 void ObjectSynchronizer::enter(Handle obj, BasicLock* lock, TRAPS) {
 551   if (UseBiasedLocking) {
 552     if (!SafepointSynchronize::is_at_safepoint()) {
 553       BiasedLocking::revoke(obj, THREAD);
 554     } else {
 555       BiasedLocking::revoke_at_safepoint(obj);
 556     }
 557   }
 558 
 559   markWord mark = obj-&gt;mark();
 560   assert(!mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 561 
 562   if (mark.is_neutral()) {
 563     // Anticipate successful CAS -- the ST of the displaced mark must
 564     // be visible &lt;= the ST performed by the CAS.
 565     lock-&gt;set_displaced_header(mark);
 566     if (mark == obj()-&gt;cas_set_mark(markWord::from_pointer(lock), mark)) {
 567       return;
 568     }
 569     // Fall through to inflate() ...
 570   } else if (mark.has_locker() &amp;&amp;
 571              THREAD-&gt;is_lock_owned((address)mark.locker())) {
 572     assert(lock != mark.locker(), &quot;must not re-lock the same lock&quot;);
 573     assert(lock != (BasicLock*)obj-&gt;mark().value(), &quot;don&#39;t relock with same BasicLock&quot;);
 574     lock-&gt;set_displaced_header(markWord::from_pointer(NULL));
 575     return;
 576   }
 577 
 578   // The object header will never be displaced to this lock,
 579   // so it does not matter what the value is, except that it
 580   // must be non-zero to avoid looking like a re-entrant lock,
 581   // and must not look locked either.
 582   lock-&gt;set_displaced_header(markWord::unused_mark());
 583   // An async deflation can race after the inflate() call and before
 584   // enter() can make the ObjectMonitor busy. enter() returns false if
 585   // we have lost the race to async deflation and we simply try again.
 586   while (true) {
 587     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_monitor_enter);
 588     if (monitor-&gt;enter(THREAD)) {
 589       return;
 590     }
 591   }
 592 }
 593 
 594 void ObjectSynchronizer::exit(oop object, BasicLock* lock, TRAPS) {
 595   markWord mark = object-&gt;mark();
 596   // We cannot check for Biased Locking if we are racing an inflation.
 597   assert(mark == markWord::INFLATING() ||
 598          !mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 599 
 600   markWord dhw = lock-&gt;displaced_header();
 601   if (dhw.value() == 0) {
 602     // If the displaced header is NULL, then this exit matches up with
 603     // a recursive enter. No real work to do here except for diagnostics.
 604 #ifndef PRODUCT
 605     if (mark != markWord::INFLATING()) {
 606       // Only do diagnostics if we are not racing an inflation. Simply
 607       // exiting a recursive enter of a Java Monitor that is being
 608       // inflated is safe; see the has_monitor() comment below.
 609       assert(!mark.is_neutral(), &quot;invariant&quot;);
 610       assert(!mark.has_locker() ||
 611              THREAD-&gt;is_lock_owned((address)mark.locker()), &quot;invariant&quot;);
 612       if (mark.has_monitor()) {
 613         // The BasicLock&#39;s displaced_header is marked as a recursive
 614         // enter and we have an inflated Java Monitor (ObjectMonitor).
 615         // This is a special case where the Java Monitor was inflated
 616         // after this thread entered the stack-lock recursively. When a
 617         // Java Monitor is inflated, we cannot safely walk the Java
 618         // Monitor owner&#39;s stack and update the BasicLocks because a
 619         // Java Monitor can be asynchronously inflated by a thread that
 620         // does not own the Java Monitor.
 621         ObjectMonitor* m = mark.monitor();
 622         assert(((oop)(m-&gt;object()))-&gt;mark() == mark, &quot;invariant&quot;);
 623         assert(m-&gt;is_entered(THREAD), &quot;invariant&quot;);
 624       }
 625     }
 626 #endif
 627     return;
 628   }
 629 
 630   if (mark == markWord::from_pointer(lock)) {
 631     // If the object is stack-locked by the current thread, try to
 632     // swing the displaced header from the BasicLock back to the mark.
 633     assert(dhw.is_neutral(), &quot;invariant&quot;);
 634     if (object-&gt;cas_set_mark(dhw, mark) == mark) {
 635       return;
 636     }
 637   }
 638 
 639   // We have to take the slow-path of possible inflation and then exit.
 640   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 641   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 642   ObjectMonitor* monitor = inflate(THREAD, object, inflate_cause_vm_internal);
 643   monitor-&gt;exit(true, THREAD);
 644 }
 645 
 646 // -----------------------------------------------------------------------------
 647 // Class Loader  support to workaround deadlocks on the class loader lock objects
 648 // Also used by GC
 649 // complete_exit()/reenter() are used to wait on a nested lock
 650 // i.e. to give up an outer lock completely and then re-enter
 651 // Used when holding nested locks - lock acquisition order: lock1 then lock2
 652 //  1) complete_exit lock1 - saving recursion count
 653 //  2) wait on lock2
 654 //  3) when notified on lock2, unlock lock2
 655 //  4) reenter lock1 with original recursion count
 656 //  5) lock lock2
 657 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 658 intx ObjectSynchronizer::complete_exit(Handle obj, TRAPS) {
 659   if (UseBiasedLocking) {
 660     BiasedLocking::revoke(obj, THREAD);
 661     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 662   }
 663 
 664   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 665   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 666   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 667   intptr_t ret_code = monitor-&gt;complete_exit(THREAD);
 668   return ret_code;
 669 }
 670 
 671 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 672 void ObjectSynchronizer::reenter(Handle obj, intx recursions, TRAPS) {
 673   if (UseBiasedLocking) {
 674     BiasedLocking::revoke(obj, THREAD);
 675     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 676   }
 677 
 678   // An async deflation can race after the inflate() call and before
 679   // reenter() -&gt; enter() can make the ObjectMonitor busy. reenter() -&gt;
 680   // enter() returns false if we have lost the race to async deflation
 681   // and we simply try again.
 682   while (true) {
 683     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 684     if (monitor-&gt;reenter(recursions, THREAD)) {
 685       return;
 686     }
 687   }
 688 }
 689 
 690 // -----------------------------------------------------------------------------
 691 // JNI locks on java objects
 692 // NOTE: must use heavy weight monitor to handle jni monitor enter
 693 void ObjectSynchronizer::jni_enter(Handle obj, TRAPS) {
 694   // the current locking is from JNI instead of Java code
 695   if (UseBiasedLocking) {
 696     BiasedLocking::revoke(obj, THREAD);
 697     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 698   }
 699   THREAD-&gt;set_current_pending_monitor_is_from_java(false);
 700   // An async deflation can race after the inflate() call and before
 701   // enter() can make the ObjectMonitor busy. enter() returns false if
 702   // we have lost the race to async deflation and we simply try again.
 703   while (true) {
 704     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_jni_enter);
 705     if (monitor-&gt;enter(THREAD)) {
 706       break;
 707     }
 708   }
 709   THREAD-&gt;set_current_pending_monitor_is_from_java(true);
 710 }
 711 
 712 // NOTE: must use heavy weight monitor to handle jni monitor exit
 713 void ObjectSynchronizer::jni_exit(oop obj, Thread* THREAD) {
 714   if (UseBiasedLocking) {
 715     Handle h_obj(THREAD, obj);
 716     BiasedLocking::revoke(h_obj, THREAD);
 717     obj = h_obj();
 718   }
 719   assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 720 
 721   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 722   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 723   ObjectMonitor* monitor = inflate(THREAD, obj, inflate_cause_jni_exit);
 724   // If this thread has locked the object, exit the monitor. We
 725   // intentionally do not use CHECK here because we must exit the
 726   // monitor even if an exception is pending.
 727   if (monitor-&gt;check_owner(THREAD)) {
 728     monitor-&gt;exit(true, THREAD);
 729   }
 730 }
 731 
 732 // -----------------------------------------------------------------------------
 733 // Internal VM locks on java objects
 734 // standard constructor, allows locking failures
 735 ObjectLocker::ObjectLocker(Handle obj, Thread* thread, bool do_lock) {
 736   _dolock = do_lock;
 737   _thread = thread;
 738   _thread-&gt;check_for_valid_safepoint_state();
 739   _obj = obj;
 740 
 741   if (_dolock) {
 742     ObjectSynchronizer::enter(_obj, &amp;_lock, _thread);
 743   }
 744 }
 745 
 746 ObjectLocker::~ObjectLocker() {
 747   if (_dolock) {
 748     ObjectSynchronizer::exit(_obj(), &amp;_lock, _thread);
 749   }
 750 }
 751 
 752 
 753 // -----------------------------------------------------------------------------
 754 //  Wait/Notify/NotifyAll
 755 // NOTE: must use heavy weight monitor to handle wait()
 756 int ObjectSynchronizer::wait(Handle obj, jlong millis, TRAPS) {
 757   if (UseBiasedLocking) {
 758     BiasedLocking::revoke(obj, THREAD);
 759     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 760   }
 761   if (millis &lt; 0) {
 762     THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 763   }
 764   // The ObjectMonitor* can&#39;t be async deflated because the _waiters
 765   // field is incremented before ownership is dropped and decremented
 766   // after ownership is regained.
 767   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 768 
 769   DTRACE_MONITOR_WAIT_PROBE(monitor, obj(), THREAD, millis);
 770   monitor-&gt;wait(millis, true, THREAD);
 771 
 772   // This dummy call is in place to get around dtrace bug 6254741.  Once
 773   // that&#39;s fixed we can uncomment the following line, remove the call
 774   // and change this function back into a &quot;void&quot; func.
 775   // DTRACE_MONITOR_PROBE(waited, monitor, obj(), THREAD);
 776   int ret_code = dtrace_waited_probe(monitor, obj, THREAD);
 777   return ret_code;
 778 }
 779 
 780 void ObjectSynchronizer::wait_uninterruptibly(Handle obj, jlong millis, TRAPS) {
 781   if (UseBiasedLocking) {
 782     BiasedLocking::revoke(obj, THREAD);
 783     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 784   }
 785   if (millis &lt; 0) {
 786     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 787   }
 788   // The ObjectMonitor* can&#39;t be async deflated because the _waiters
 789   // field is incremented before ownership is dropped and decremented
 790   // after ownership is regained.
 791   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 792   monitor-&gt;wait(millis, false, THREAD);
 793 }
 794 
 795 void ObjectSynchronizer::notify(Handle obj, TRAPS) {
 796   if (UseBiasedLocking) {
 797     BiasedLocking::revoke(obj, THREAD);
 798     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 799   }
 800 
 801   markWord mark = obj-&gt;mark();
 802   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 803     return;
 804   }
 805   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 806   // dropped by the calling thread.
 807   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_notify);
 808   monitor-&gt;notify(THREAD);
 809 }
 810 
 811 // NOTE: see comment of notify()
 812 void ObjectSynchronizer::notifyall(Handle obj, TRAPS) {
 813   if (UseBiasedLocking) {
 814     BiasedLocking::revoke(obj, THREAD);
 815     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 816   }
 817 
 818   markWord mark = obj-&gt;mark();
 819   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 820     return;
 821   }
 822   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 823   // dropped by the calling thread.
 824   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_notify);
 825   monitor-&gt;notifyAll(THREAD);
 826 }
 827 
 828 // -----------------------------------------------------------------------------
 829 // Hash Code handling
 830 //
 831 // Performance concern:
 832 // OrderAccess::storestore() calls release() which at one time stored 0
 833 // into the global volatile OrderAccess::dummy variable. This store was
 834 // unnecessary for correctness. Many threads storing into a common location
 835 // causes considerable cache migration or &quot;sloshing&quot; on large SMP systems.
 836 // As such, I avoided using OrderAccess::storestore(). In some cases
 837 // OrderAccess::fence() -- which incurs local latency on the executing
 838 // processor -- is a better choice as it scales on SMP systems.
 839 //
 840 // See http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot for
 841 // a discussion of coherency costs. Note that all our current reference
 842 // platforms provide strong ST-ST order, so the issue is moot on IA32,
 843 // x64, and SPARC.
 844 //
 845 // As a general policy we use &quot;volatile&quot; to control compiler-based reordering
 846 // and explicit fences (barriers) to control for architectural reordering
 847 // performed by the CPU(s) or platform.
 848 
 849 struct SharedGlobals {
 850   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 851   // These are highly shared mostly-read variables.
 852   // To avoid false-sharing they need to be the sole occupants of a cache line.
 853   volatile int stw_random;
 854   volatile int stw_cycle;
 855   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(volatile int) * 2);
 856   // Hot RW variable -- Sequester to avoid false-sharing
 857   volatile int hc_sequence;
 858   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(volatile int));
 859 };
 860 
 861 static SharedGlobals GVars;
 862 
 863 static markWord read_stable_mark(oop obj) {
 864   markWord mark = obj-&gt;mark();
 865   if (!mark.is_being_inflated()) {
 866     return mark;       // normal fast-path return
 867   }
 868 
 869   int its = 0;
 870   for (;;) {
 871     markWord mark = obj-&gt;mark();
 872     if (!mark.is_being_inflated()) {
 873       return mark;    // normal fast-path return
 874     }
 875 
 876     // The object is being inflated by some other thread.
 877     // The caller of read_stable_mark() must wait for inflation to complete.
 878     // Avoid live-lock
 879     // TODO: consider calling SafepointSynchronize::do_call_back() while
 880     // spinning to see if there&#39;s a safepoint pending.  If so, immediately
 881     // yielding or blocking would be appropriate.  Avoid spinning while
 882     // there is a safepoint pending.
 883     // TODO: add inflation contention performance counters.
 884     // TODO: restrict the aggregate number of spinners.
 885 
 886     ++its;
 887     if (its &gt; 10000 || !os::is_MP()) {
 888       if (its &amp; 1) {
 889         os::naked_yield();
 890       } else {
 891         // Note that the following code attenuates the livelock problem but is not
 892         // a complete remedy.  A more complete solution would require that the inflating
 893         // thread hold the associated inflation lock.  The following code simply restricts
 894         // the number of spinners to at most one.  We&#39;ll have N-2 threads blocked
 895         // on the inflationlock, 1 thread holding the inflation lock and using
 896         // a yield/park strategy, and 1 thread in the midst of inflation.
 897         // A more refined approach would be to change the encoding of INFLATING
 898         // to allow encapsulation of a native thread pointer.  Threads waiting for
 899         // inflation to complete would use CAS to push themselves onto a singly linked
 900         // list rooted at the markword.  Once enqueued, they&#39;d loop, checking a per-thread flag
 901         // and calling park().  When inflation was complete the thread that accomplished inflation
 902         // would detach the list and set the markword to inflated with a single CAS and
 903         // then for each thread on the list, set the flag and unpark() the thread.
 904         // This is conceptually similar to muxAcquire-muxRelease, except that muxRelease
 905         // wakes at most one thread whereas we need to wake the entire list.
 906         int ix = (cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 5) &amp; (NINFLATIONLOCKS-1);
 907         int YieldThenBlock = 0;
 908         assert(ix &gt;= 0 &amp;&amp; ix &lt; NINFLATIONLOCKS, &quot;invariant&quot;);
 909         assert((NINFLATIONLOCKS &amp; (NINFLATIONLOCKS-1)) == 0, &quot;invariant&quot;);
 910         Thread::muxAcquire(gInflationLocks + ix, &quot;gInflationLock&quot;);
 911         while (obj-&gt;mark() == markWord::INFLATING()) {
 912           // Beware: NakedYield() is advisory and has almost no effect on some platforms
 913           // so we periodically call self-&gt;_ParkEvent-&gt;park(1).
 914           // We use a mixed spin/yield/block mechanism.
 915           if ((YieldThenBlock++) &gt;= 16) {
 916             Thread::current()-&gt;_ParkEvent-&gt;park(1);
 917           } else {
 918             os::naked_yield();
 919           }
 920         }
 921         Thread::muxRelease(gInflationLocks + ix);
 922       }
 923     } else {
 924       SpinPause();       // SMP-polite spinning
 925     }
 926   }
 927 }
 928 
 929 // hashCode() generation :
 930 //
 931 // Possibilities:
 932 // * MD5Digest of {obj,stw_random}
 933 // * CRC32 of {obj,stw_random} or any linear-feedback shift register function.
 934 // * A DES- or AES-style SBox[] mechanism
 935 // * One of the Phi-based schemes, such as:
 936 //   2654435761 = 2^32 * Phi (golden ratio)
 937 //   HashCodeValue = ((uintptr_t(obj) &gt;&gt; 3) * 2654435761) ^ GVars.stw_random ;
 938 // * A variation of Marsaglia&#39;s shift-xor RNG scheme.
 939 // * (obj ^ stw_random) is appealing, but can result
 940 //   in undesirable regularity in the hashCode values of adjacent objects
 941 //   (objects allocated back-to-back, in particular).  This could potentially
 942 //   result in hashtable collisions and reduced hashtable efficiency.
 943 //   There are simple ways to &quot;diffuse&quot; the middle address bits over the
 944 //   generated hashCode values:
 945 
 946 static inline intptr_t get_next_hash(Thread* self, oop obj) {
 947   intptr_t value = 0;
 948   if (hashCode == 0) {
 949     // This form uses global Park-Miller RNG.
 950     // On MP system we&#39;ll have lots of RW access to a global, so the
 951     // mechanism induces lots of coherency traffic.
 952     value = os::random();
 953   } else if (hashCode == 1) {
 954     // This variation has the property of being stable (idempotent)
 955     // between STW operations.  This can be useful in some of the 1-0
 956     // synchronization schemes.
 957     intptr_t addr_bits = cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 3;
 958     value = addr_bits ^ (addr_bits &gt;&gt; 5) ^ GVars.stw_random;
 959   } else if (hashCode == 2) {
 960     value = 1;            // for sensitivity testing
 961   } else if (hashCode == 3) {
 962     value = ++GVars.hc_sequence;
 963   } else if (hashCode == 4) {
 964     value = cast_from_oop&lt;intptr_t&gt;(obj);
 965   } else {
 966     // Marsaglia&#39;s xor-shift scheme with thread-specific state
 967     // This is probably the best overall implementation -- we&#39;ll
 968     // likely make this the default in future releases.
 969     unsigned t = self-&gt;_hashStateX;
 970     t ^= (t &lt;&lt; 11);
 971     self-&gt;_hashStateX = self-&gt;_hashStateY;
 972     self-&gt;_hashStateY = self-&gt;_hashStateZ;
 973     self-&gt;_hashStateZ = self-&gt;_hashStateW;
 974     unsigned v = self-&gt;_hashStateW;
 975     v = (v ^ (v &gt;&gt; 19)) ^ (t ^ (t &gt;&gt; 8));
 976     self-&gt;_hashStateW = v;
 977     value = v;
 978   }
 979 
 980   value &amp;= markWord::hash_mask;
 981   if (value == 0) value = 0xBAD;
 982   assert(value != markWord::no_hash, &quot;invariant&quot;);
 983   return value;
 984 }
 985 
 986 intptr_t ObjectSynchronizer::FastHashCode(Thread* self, oop obj) {
 987   if (UseBiasedLocking) {
 988     // NOTE: many places throughout the JVM do not expect a safepoint
 989     // to be taken here, in particular most operations on perm gen
 990     // objects. However, we only ever bias Java instances and all of
 991     // the call sites of identity_hash that might revoke biases have
 992     // been checked to make sure they can handle a safepoint. The
 993     // added check of the bias pattern is to avoid useless calls to
 994     // thread-local storage.
 995     if (obj-&gt;mark().has_bias_pattern()) {
 996       // Handle for oop obj in case of STW safepoint
 997       Handle hobj(self, obj);
 998       // Relaxing assertion for bug 6320749.
 999       assert(Universe::verify_in_progress() ||
1000              !SafepointSynchronize::is_at_safepoint(),
1001              &quot;biases should not be seen by VM thread here&quot;);
1002       BiasedLocking::revoke(hobj, JavaThread::current());
1003       obj = hobj();
1004       assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1005     }
1006   }
1007 
1008   // hashCode() is a heap mutator ...
1009   // Relaxing assertion for bug 6320749.
1010   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1011          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1012   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1013          self-&gt;is_Java_thread() , &quot;invariant&quot;);
1014   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1015          ((JavaThread *)self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1016 
1017   while (true) {
1018     ObjectMonitor* monitor = NULL;
1019     markWord temp, test;
1020     intptr_t hash;
1021     markWord mark = read_stable_mark(obj);
1022 
1023     // object should remain ineligible for biased locking
1024     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1025 
1026     if (mark.is_neutral()) {            // if this is a normal header
1027       hash = mark.hash();
1028       if (hash != 0) {                  // if it has a hash, just return it
1029         return hash;
1030       }
1031       hash = get_next_hash(self, obj);  // get a new hash
1032       temp = mark.copy_set_hash(hash);  // merge the hash into header
1033                                         // try to install the hash
1034       test = obj-&gt;cas_set_mark(temp, mark);
1035       if (test == mark) {               // if the hash was installed, return it
1036         return hash;
1037       }
1038       // Failed to install the hash. It could be that another thread
1039       // installed the hash just before our attempt or inflation has
1040       // occurred or... so we fall thru to inflate the monitor for
1041       // stability and then install the hash.
1042     } else if (mark.has_monitor()) {
1043       monitor = mark.monitor();
1044       temp = monitor-&gt;header();
1045       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1046       hash = temp.hash();
1047       if (hash != 0) {
1048         // It has a hash.
1049 
1050         // Separate load of dmw/header above from the loads in
1051         // is_being_async_deflated().
1052         if (support_IRIW_for_not_multiple_copy_atomic_cpu) {
1053           // A non-multiple copy atomic (nMCA) machine needs a bigger
1054           // hammer to separate the load above and the loads below.
1055           OrderAccess::fence();
1056         } else {
1057           OrderAccess::loadload();
1058         }
1059         if (monitor-&gt;is_being_async_deflated()) {
1060           // But we can&#39;t safely use the hash if we detect that async
1061           // deflation has occurred. So we attempt to restore the
1062           // header/dmw to the object&#39;s header so that we only retry
1063           // once if the deflater thread happens to be slow.
1064           monitor-&gt;install_displaced_markword_in_object(obj);
1065           continue;
1066         }
1067         return hash;
1068       }
1069       // Fall thru so we only have one place that installs the hash in
1070       // the ObjectMonitor.
1071     } else if (self-&gt;is_lock_owned((address)mark.locker())) {
1072       // This is a stack lock owned by the calling thread so fetch the
1073       // displaced markWord from the BasicLock on the stack.
1074       temp = mark.displaced_mark_helper();
1075       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1076       hash = temp.hash();
1077       if (hash != 0) {                  // if it has a hash, just return it
1078         return hash;
1079       }
1080       // WARNING:
1081       // The displaced header in the BasicLock on a thread&#39;s stack
1082       // is strictly immutable. It CANNOT be changed in ANY cases.
1083       // So we have to inflate the stack lock into an ObjectMonitor
1084       // even if the current thread owns the lock. The BasicLock on
1085       // a thread&#39;s stack can be asynchronously read by other threads
1086       // during an inflate() call so any change to that stack memory
1087       // may not propagate to other threads correctly.
1088     }
1089 
1090     // Inflate the monitor to set the hash.
1091 
1092     // An async deflation can race after the inflate() call and before we
1093     // can update the ObjectMonitor&#39;s header with the hash value below.
1094     monitor = inflate(self, obj, inflate_cause_hash_code);
1095     // Load ObjectMonitor&#39;s header/dmw field and see if it has a hash.
1096     mark = monitor-&gt;header();
1097     assert(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1098     hash = mark.hash();
1099     if (hash == 0) {                    // if it does not have a hash
1100       hash = get_next_hash(self, obj);  // get a new hash
1101       temp = mark.copy_set_hash(hash);  // merge the hash into header
1102       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1103       uintptr_t v = Atomic::cmpxchg((volatile uintptr_t*)monitor-&gt;header_addr(), mark.value(), temp.value());
1104       test = markWord(v);
1105       if (test != mark) {
1106         // The attempt to update the ObjectMonitor&#39;s header/dmw field
1107         // did not work. This can happen if another thread managed to
1108         // merge in the hash just before our cmpxchg().
1109         // If we add any new usages of the header/dmw field, this code
1110         // will need to be updated.
1111         hash = test.hash();
1112         assert(test.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, test.value());
1113         assert(hash != 0, &quot;should only have lost the race to a thread that set a non-zero hash&quot;);
1114       }
1115       if (monitor-&gt;is_being_async_deflated()) {
1116         // If we detect that async deflation has occurred, then we
1117         // attempt to restore the header/dmw to the object&#39;s header
1118         // so that we only retry once if the deflater thread happens
1119         // to be slow.
1120         monitor-&gt;install_displaced_markword_in_object(obj);
1121         continue;
1122       }
1123     }
1124     // We finally get the hash.
1125     return hash;
1126   }
1127 }
1128 
1129 // Deprecated -- use FastHashCode() instead.
1130 
1131 intptr_t ObjectSynchronizer::identity_hash_value_for(Handle obj) {
1132   return FastHashCode(Thread::current(), obj());
1133 }
1134 
1135 
1136 bool ObjectSynchronizer::current_thread_holds_lock(JavaThread* thread,
1137                                                    Handle h_obj) {
1138   if (UseBiasedLocking) {
1139     BiasedLocking::revoke(h_obj, thread);
1140     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1141   }
1142 
1143   assert(thread == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1144   oop obj = h_obj();
1145 
1146   markWord mark = read_stable_mark(obj);
1147 
1148   // Uncontended case, header points to stack
1149   if (mark.has_locker()) {
1150     return thread-&gt;is_lock_owned((address)mark.locker());
1151   }
1152   // Contended case, header points to ObjectMonitor (tagged pointer)
1153   if (mark.has_monitor()) {
1154     // The first stage of async deflation does not affect any field
1155     // used by this comparison so the ObjectMonitor* is usable here.
1156     ObjectMonitor* monitor = mark.monitor();
1157     return monitor-&gt;is_entered(thread) != 0;
1158   }
1159   // Unlocked case, header in place
1160   assert(mark.is_neutral(), &quot;sanity check&quot;);
1161   return false;
1162 }
1163 
1164 // Be aware of this method could revoke bias of the lock object.
1165 // This method queries the ownership of the lock handle specified by &#39;h_obj&#39;.
1166 // If the current thread owns the lock, it returns owner_self. If no
1167 // thread owns the lock, it returns owner_none. Otherwise, it will return
1168 // owner_other.
1169 ObjectSynchronizer::LockOwnership ObjectSynchronizer::query_lock_ownership
1170 (JavaThread *self, Handle h_obj) {
1171   // The caller must beware this method can revoke bias, and
1172   // revocation can result in a safepoint.
1173   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1174   assert(self-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1175 
1176   // Possible mark states: neutral, biased, stack-locked, inflated
1177 
1178   if (UseBiasedLocking &amp;&amp; h_obj()-&gt;mark().has_bias_pattern()) {
1179     // CASE: biased
1180     BiasedLocking::revoke(h_obj, self);
1181     assert(!h_obj-&gt;mark().has_bias_pattern(),
1182            &quot;biases should be revoked by now&quot;);
1183   }
1184 
1185   assert(self == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1186   oop obj = h_obj();
1187   markWord mark = read_stable_mark(obj);
1188 
1189   // CASE: stack-locked.  Mark points to a BasicLock on the owner&#39;s stack.
1190   if (mark.has_locker()) {
1191     return self-&gt;is_lock_owned((address)mark.locker()) ?
1192       owner_self : owner_other;
1193   }
1194 
1195   // CASE: inflated. Mark (tagged pointer) points to an ObjectMonitor.
1196   // The Object:ObjectMonitor relationship is stable as long as we&#39;re
1197   // not at a safepoint and AsyncDeflateIdleMonitors is false.
1198   if (mark.has_monitor()) {
1199     // The first stage of async deflation does not affect any field
1200     // used by this comparison so the ObjectMonitor* is usable here.
1201     ObjectMonitor* monitor = mark.monitor();
1202     void* owner = monitor-&gt;owner();
1203     if (owner == NULL) return owner_none;
1204     return (owner == self ||
1205             self-&gt;is_lock_owned((address)owner)) ? owner_self : owner_other;
1206   }
1207 
1208   // CASE: neutral
1209   assert(mark.is_neutral(), &quot;sanity check&quot;);
1210   return owner_none;           // it&#39;s unlocked
1211 }
1212 
1213 // FIXME: jvmti should call this
1214 JavaThread* ObjectSynchronizer::get_lock_owner(ThreadsList * t_list, Handle h_obj) {
1215   if (UseBiasedLocking) {
1216     if (SafepointSynchronize::is_at_safepoint()) {
1217       BiasedLocking::revoke_at_safepoint(h_obj);
1218     } else {
1219       BiasedLocking::revoke(h_obj, JavaThread::current());
1220     }
1221     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1222   }
1223 
1224   oop obj = h_obj();
1225   address owner = NULL;
1226 
1227   markWord mark = read_stable_mark(obj);
1228 
1229   // Uncontended case, header points to stack
1230   if (mark.has_locker()) {
1231     owner = (address) mark.locker();
1232   }
1233 
1234   // Contended case, header points to ObjectMonitor (tagged pointer)
1235   else if (mark.has_monitor()) {
1236     // The first stage of async deflation does not affect any field
1237     // used by this comparison so the ObjectMonitor* is usable here.
1238     ObjectMonitor* monitor = mark.monitor();
1239     assert(monitor != NULL, &quot;monitor should be non-null&quot;);
1240     owner = (address) monitor-&gt;owner();
1241   }
1242 
1243   if (owner != NULL) {
1244     // owning_thread_from_monitor_owner() may also return NULL here
1245     return Threads::owning_thread_from_monitor_owner(t_list, owner);
1246   }
1247 
1248   // Unlocked case, header in place
1249   // Cannot have assertion since this object may have been
1250   // locked by another thread when reaching here.
1251   // assert(mark.is_neutral(), &quot;sanity check&quot;);
1252 
1253   return NULL;
1254 }
1255 
1256 // Visitors ...
1257 
1258 void ObjectSynchronizer::monitors_iterate(MonitorClosure* closure) {
1259   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
1260   while (block != NULL) {
1261     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
1262     for (int i = _BLOCKSIZE - 1; i &gt; 0; i--) {
1263       ObjectMonitor* mid = (ObjectMonitor *)(block + i);
1264       if (mid-&gt;object() != NULL) {
1265         // Only process with closure if the object is set.
1266 
1267         // monitors_iterate() is only called at a safepoint or when the
1268         // target thread is suspended or when the target thread is
1269         // operating on itself. The current closures in use today are
1270         // only interested in an owned ObjectMonitor and ownership
1271         // cannot be dropped under the calling contexts so the
1272         // ObjectMonitor cannot be async deflated.
1273         closure-&gt;do_monitor(mid);
1274       }
1275     }
1276     // unmarked_next() is not needed with g_block_list (no locking
1277     // used with block linkage _next_om fields).
1278     block = (PaddedObjectMonitor*)block-&gt;next_om();
1279   }
1280 }
1281 
1282 static bool monitors_used_above_threshold() {
1283   int population = Atomic::load(&amp;om_list_globals._population);
1284   if (population == 0) {
1285     return false;
1286   }
1287   if (MonitorUsedDeflationThreshold &gt; 0) {
1288     int monitors_used = population - Atomic::load(&amp;om_list_globals._free_count) -
1289                         Atomic::load(&amp;om_list_globals._wait_count);
1290     int monitor_usage = (monitors_used * 100LL) / population;
1291     return monitor_usage &gt; MonitorUsedDeflationThreshold;
1292   }
1293   return false;
1294 }
1295 
1296 bool ObjectSynchronizer::is_async_deflation_needed() {
1297   if (!AsyncDeflateIdleMonitors) {
1298     return false;
1299   }
1300   if (is_async_deflation_requested()) {
1301     // Async deflation request.
1302     return true;
1303   }
1304   if (AsyncDeflationInterval &gt; 0 &amp;&amp;
1305       time_since_last_async_deflation_ms() &gt; AsyncDeflationInterval &amp;&amp;
1306       monitors_used_above_threshold()) {
1307     // It&#39;s been longer than our specified deflate interval and there
1308     // are too many monitors in use. We don&#39;t deflate more frequently
1309     // than AsyncDeflationInterval (unless is_async_deflation_requested)
1310     // in order to not swamp the ServiceThread.
1311     return true;
1312   }
1313   return false;
1314 }
1315 
1316 bool ObjectSynchronizer::is_safepoint_deflation_needed() {
1317   return !AsyncDeflateIdleMonitors &amp;&amp;
1318          monitors_used_above_threshold();  // Too many monitors in use.
1319 }
1320 
1321 bool ObjectSynchronizer::request_deflate_idle_monitors() {
1322   bool is_JavaThread = Thread::current()-&gt;is_Java_thread();
1323   bool ret_code = false;
1324 
1325   if (AsyncDeflateIdleMonitors) {
1326     jlong last_time = last_async_deflation_time_ns();
1327     set_is_async_deflation_requested(true);
1328     {
1329       MonitorLocker ml(Service_lock, Mutex::_no_safepoint_check_flag);
1330       ml.notify_all();
1331     }
1332     const int N_CHECKS = 5;
1333     for (int i = 0; i &lt; N_CHECKS; i++) {  // sleep for at most 5 seconds
1334       if (last_async_deflation_time_ns() &gt; last_time) {
1335         log_info(monitorinflation)(&quot;Async Deflation happened after %d check(s).&quot;, i);
1336         ret_code = true;
1337         break;
1338       }
1339       if (is_JavaThread) {
1340         // JavaThread has to honor the blocking protocol.
1341         ThreadBlockInVM tbivm(JavaThread::current());
1342         os::naked_short_sleep(999);  // sleep for almost 1 second
1343       } else {
1344         os::naked_short_sleep(999);  // sleep for almost 1 second
1345       }
1346     }
1347     if (!ret_code) {
1348       log_info(monitorinflation)(&quot;Async Deflation DID NOT happen after %d checks.&quot;, N_CHECKS);
1349     }
1350   } else {
1351     // Only need to force this safepoint if we are not using async
1352     // deflation. The VMThread won&#39;t call this function before the
1353     // final safepoint if we are not using async deflation so we
1354     // don&#39;t have to reason about the VMThread executing a VM-op here.
1355     VM_ForceSafepoint force_safepoint_op;
1356     VMThread::execute(&amp;force_safepoint_op);
1357     ret_code = true;
1358   }
1359 
1360   return ret_code;
1361 }
1362 
1363 jlong ObjectSynchronizer::time_since_last_async_deflation_ms() {
1364   return (os::javaTimeNanos() - last_async_deflation_time_ns()) / (NANOUNITS / MILLIUNITS);
1365 }
1366 
1367 void ObjectSynchronizer::oops_do(OopClosure* f) {
1368   // We only scan the global used list here (for moribund threads), and
1369   // the thread-local monitors in Thread::oops_do().
1370   global_used_oops_do(f);
1371 }
1372 
1373 void ObjectSynchronizer::global_used_oops_do(OopClosure* f) {
1374   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1375   list_oops_do(Atomic::load(&amp;om_list_globals._in_use_list), f);
1376 }
1377 
1378 void ObjectSynchronizer::thread_local_used_oops_do(Thread* thread, OopClosure* f) {
1379   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1380   list_oops_do(thread-&gt;om_in_use_list, f);
1381 }
1382 
1383 void ObjectSynchronizer::list_oops_do(ObjectMonitor* list, OopClosure* f) {
1384   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1385   // The oops_do() phase does not overlap with monitor deflation
1386   // so no need to lock ObjectMonitors for the list traversal.
1387   for (ObjectMonitor* mid = list; mid != NULL; mid = unmarked_next(mid)) {
1388     if (mid-&gt;object() != NULL) {
1389       f-&gt;do_oop((oop*)mid-&gt;object_addr());
1390     }
1391   }
1392 }
1393 
1394 
1395 // -----------------------------------------------------------------------------
1396 // ObjectMonitor Lifecycle
1397 // -----------------------
1398 // Inflation unlinks monitors from om_list_globals._free_list or a per-thread
1399 // free list and associates them with objects. Deflation -- which occurs at
1400 // STW-time or asynchronously -- disassociates idle monitors from objects.
1401 // Such scavenged monitors are returned to the om_list_globals._free_list.
1402 //
1403 // ObjectMonitors reside in type-stable memory (TSM) and are immortal.
1404 //
1405 // Lifecycle:
1406 // --   unassigned and on the om_list_globals._free_list
1407 // --   unassigned and on a per-thread free list
1408 // --   assigned to an object.  The object is inflated and the mark refers
1409 //      to the ObjectMonitor.
1410 
1411 ObjectMonitor* ObjectSynchronizer::om_alloc(Thread* self) {
1412   // A large MAXPRIVATE value reduces both list lock contention
1413   // and list coherency traffic, but also tends to increase the
1414   // number of ObjectMonitors in circulation as well as the STW
1415   // scavenge costs.  As usual, we lean toward time in space-time
1416   // tradeoffs.
1417   const int MAXPRIVATE = 1024;
1418   NoSafepointVerifier nsv;
1419 
1420   for (;;) {
1421     ObjectMonitor* m;
1422 
1423     // 1: try to allocate from the thread&#39;s local om_free_list.
1424     // Threads will attempt to allocate first from their local list, then
1425     // from the global list, and only after those attempts fail will the
1426     // thread attempt to instantiate new monitors. Thread-local free lists
1427     // improve allocation latency, as well as reducing coherency traffic
1428     // on the shared global list.
1429     m = take_from_start_of_om_free_list(self);
1430     if (m != NULL) {
1431       guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1432       m-&gt;set_allocation_state(ObjectMonitor::New);
1433       prepend_to_om_in_use_list(self, m);
1434       return m;
1435     }
1436 
1437     // 2: try to allocate from the global om_list_globals._free_list
1438     // If we&#39;re using thread-local free lists then try
1439     // to reprovision the caller&#39;s free list.
1440     if (Atomic::load(&amp;om_list_globals._free_list) != NULL) {
1441       // Reprovision the thread&#39;s om_free_list.
1442       // Use bulk transfers to reduce the allocation rate and heat
1443       // on various locks.
1444       for (int i = self-&gt;om_free_provision; --i &gt;= 0;) {
1445         ObjectMonitor* take = take_from_start_of_global_free_list();
1446         if (take == NULL) {
1447           break;  // No more are available.
1448         }
1449         guarantee(take-&gt;object() == NULL, &quot;invariant&quot;);
1450         if (AsyncDeflateIdleMonitors) {
1451           // We allowed 3 field values to linger during async deflation.
1452           // Clear or restore them as appropriate.
1453           take-&gt;set_header(markWord::zero());
1454           // DEFLATER_MARKER is the only non-NULL value we should see here.
1455           take-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
1456           if (take-&gt;contentions() &lt; 0) {
1457             // Add back max_jint to restore the contentions field to its
1458             // proper value.
1459             take-&gt;add_to_contentions(max_jint);
1460 
1461 #ifdef ASSERT
1462             jint l_contentions = take-&gt;contentions();
1463 #endif
1464             assert(l_contentions &gt;= 0, &quot;must not be negative: l_contentions=%d, contentions=%d&quot;,
1465                    l_contentions, take-&gt;contentions());
1466           }
1467         }
1468         take-&gt;Recycle();
1469         // Since we&#39;re taking from the global free-list, take must be Free.
1470         // om_release() also sets the allocation state to Free because it
1471         // is called from other code paths.
1472         assert(take-&gt;is_free(), &quot;invariant&quot;);
1473         om_release(self, take, false);
1474       }
1475       self-&gt;om_free_provision += 1 + (self-&gt;om_free_provision / 2);
1476       if (self-&gt;om_free_provision &gt; MAXPRIVATE) self-&gt;om_free_provision = MAXPRIVATE;
1477       continue;
1478     }
1479 
1480     // 3: allocate a block of new ObjectMonitors
1481     // Both the local and global free lists are empty -- resort to malloc().
1482     // In the current implementation ObjectMonitors are TSM - immortal.
1483     // Ideally, we&#39;d write &quot;new ObjectMonitor[_BLOCKSIZE], but we want
1484     // each ObjectMonitor to start at the beginning of a cache line,
1485     // so we use align_up().
1486     // A better solution would be to use C++ placement-new.
1487     // BEWARE: As it stands currently, we don&#39;t run the ctors!
1488     assert(_BLOCKSIZE &gt; 1, &quot;invariant&quot;);
1489     size_t neededsize = sizeof(PaddedObjectMonitor) * _BLOCKSIZE;
1490     PaddedObjectMonitor* temp;
1491     size_t aligned_size = neededsize + (OM_CACHE_LINE_SIZE - 1);
1492     void* real_malloc_addr = NEW_C_HEAP_ARRAY(char, aligned_size, mtInternal);
1493     temp = (PaddedObjectMonitor*)align_up(real_malloc_addr, OM_CACHE_LINE_SIZE);
1494     (void)memset((void *) temp, 0, neededsize);
1495 
1496     // Format the block.
1497     // initialize the linked list, each monitor points to its next
1498     // forming the single linked free list, the very first monitor
1499     // will points to next block, which forms the block list.
1500     // The trick of using the 1st element in the block as g_block_list
1501     // linkage should be reconsidered.  A better implementation would
1502     // look like: class Block { Block * next; int N; ObjectMonitor Body [N] ; }
1503 
1504     for (int i = 1; i &lt; _BLOCKSIZE; i++) {
1505       temp[i].set_next_om((ObjectMonitor*)&amp;temp[i + 1]);
1506       assert(temp[i].is_free(), &quot;invariant&quot;);
1507     }
1508 
1509     // terminate the last monitor as the end of list
1510     temp[_BLOCKSIZE - 1].set_next_om((ObjectMonitor*)NULL);
1511 
1512     // Element [0] is reserved for global list linkage
1513     temp[0].set_object(CHAINMARKER);
1514 
1515     // Consider carving out this thread&#39;s current request from the
1516     // block in hand.  This avoids some lock traffic and redundant
1517     // list activity.
1518 
1519     prepend_block_to_lists(temp);
1520   }
1521 }
1522 
1523 // Place &quot;m&quot; on the caller&#39;s private per-thread om_free_list.
1524 // In practice there&#39;s no need to clamp or limit the number of
1525 // monitors on a thread&#39;s om_free_list as the only non-allocation time
1526 // we&#39;ll call om_release() is to return a monitor to the free list after
1527 // a CAS attempt failed. This doesn&#39;t allow unbounded #s of monitors to
1528 // accumulate on a thread&#39;s free list.
1529 //
1530 // Key constraint: all ObjectMonitors on a thread&#39;s free list and the global
1531 // free list must have their object field set to null. This prevents the
1532 // scavenger -- deflate_monitor_list() or deflate_monitor_list_using_JT()
1533 // -- from reclaiming them while we are trying to release them.
1534 
1535 void ObjectSynchronizer::om_release(Thread* self, ObjectMonitor* m,
1536                                     bool from_per_thread_alloc) {
1537   guarantee(m-&gt;header().value() == 0, &quot;invariant&quot;);
1538   guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1539   NoSafepointVerifier nsv;
1540 
1541   if ((m-&gt;is_busy() | m-&gt;_recursions) != 0) {
1542     stringStream ss;
1543     fatal(&quot;freeing in-use monitor: %s, recursions=&quot; INTX_FORMAT,
1544           m-&gt;is_busy_to_string(&amp;ss), m-&gt;_recursions);
1545   }
1546   m-&gt;set_allocation_state(ObjectMonitor::Free);
1547   // _next_om is used for both per-thread in-use and free lists so
1548   // we have to remove &#39;m&#39; from the in-use list first (as needed).
1549   if (from_per_thread_alloc) {
1550     // Need to remove &#39;m&#39; from om_in_use_list.
1551     ObjectMonitor* mid = NULL;
1552     ObjectMonitor* next = NULL;
1553 
1554     // This list walk can race with another list walker or with async
1555     // deflation so we have to worry about an ObjectMonitor being
1556     // removed from this list while we are walking it.
1557 
1558     // Lock the list head to avoid racing with another list walker
1559     // or with async deflation.
1560     if ((mid = get_list_head_locked(&amp;self-&gt;om_in_use_list)) == NULL) {
1561       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; in-use list must not be empty.&quot;, p2i(self));
1562     }
1563     next = unmarked_next(mid);
1564     if (m == mid) {
1565       // First special case:
1566       // &#39;m&#39; matches mid, is the list head and is locked. Switch the list
1567       // head to next which unlocks the list head, but leaves the extracted
1568       // mid locked:
1569       Atomic::store(&amp;self-&gt;om_in_use_list, next);
1570     } else if (m == next) {
1571       // Second special case:
1572       // &#39;m&#39; matches next after the list head and we already have the list
1573       // head locked so set mid to what we are extracting:
1574       mid = next;
1575       // Lock mid to prevent races with a list walker or an async
1576       // deflater thread that&#39;s ahead of us. The locked list head
1577       // prevents races from behind us.
1578       om_lock(mid);
1579       // Update next to what follows mid (if anything):
1580       next = unmarked_next(mid);
1581       // Switch next after the list head to new next which unlocks the
1582       // list head, but leaves the extracted mid locked:
1583       self-&gt;om_in_use_list-&gt;set_next_om(next);
1584     } else {
1585       // We have to search the list to find &#39;m&#39;.
1586       guarantee(next != NULL, &quot;thread=&quot; INTPTR_FORMAT &quot;: om_in_use_list=&quot; INTPTR_FORMAT
1587                 &quot; is too short.&quot;, p2i(self), p2i(self-&gt;om_in_use_list));
1588       // Our starting anchor is next after the list head which is the
1589       // last ObjectMonitor we checked:
1590       ObjectMonitor* anchor = next;
1591       // Lock anchor to prevent races with a list walker or an async
1592       // deflater thread that&#39;s ahead of us. The locked list head
1593       // prevents races from behind us.
1594       om_lock(anchor);
1595       om_unlock(mid);  // Unlock the list head now that anchor is locked.
1596       while ((mid = unmarked_next(anchor)) != NULL) {
1597         if (m == mid) {
1598           // We found &#39;m&#39; on the per-thread in-use list so extract it.
1599           // Update next to what follows mid (if anything):
1600           next = unmarked_next(mid);
1601           // Switch next after the anchor to new next which unlocks the
1602           // anchor, but leaves the extracted mid locked:
1603           anchor-&gt;set_next_om(next);
1604           break;
1605         } else {
1606           // Lock the next anchor to prevent races with a list walker
1607           // or an async deflater thread that&#39;s ahead of us. The locked
1608           // current anchor prevents races from behind us.
1609           om_lock(mid);
1610           // Unlock current anchor now that next anchor is locked:
1611           om_unlock(anchor);
1612           anchor = mid;  // Advance to new anchor and try again.
1613         }
1614       }
1615     }
1616 
1617     if (mid == NULL) {
1618       // Reached end of the list and didn&#39;t find &#39;m&#39; so:
1619       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; must find m=&quot; INTPTR_FORMAT &quot;on om_in_use_list=&quot;
1620             INTPTR_FORMAT, p2i(self), p2i(m), p2i(self-&gt;om_in_use_list));
1621     }
1622 
1623     // At this point mid is disconnected from the in-use list so
1624     // its lock no longer has any effects on the in-use list.
1625     Atomic::dec(&amp;self-&gt;om_in_use_count);
1626     // Unlock mid, but leave the next value for any lagging list
1627     // walkers. It will get cleaned up when mid is prepended to
1628     // the thread&#39;s free list:
1629     om_unlock(mid);
1630   }
1631 
1632   prepend_to_om_free_list(self, m);
1633   guarantee(m-&gt;is_free(), &quot;invariant&quot;);
1634 }
1635 
1636 // Return ObjectMonitors on a moribund thread&#39;s free and in-use
1637 // lists to the appropriate global lists. The ObjectMonitors on the
1638 // per-thread in-use list may still be in use by other threads.
1639 //
1640 // We currently call om_flush() from Threads::remove() before the
1641 // thread has been excised from the thread list and is no longer a
1642 // mutator. This means that om_flush() cannot run concurrently with
1643 // a safepoint and interleave with deflate_idle_monitors(). In
1644 // particular, this ensures that the thread&#39;s in-use monitors are
1645 // scanned by a GC safepoint, either via Thread::oops_do() (before
1646 // om_flush() is called) or via ObjectSynchronizer::oops_do() (after
1647 // om_flush() is called).
1648 //
1649 // With AsyncDeflateIdleMonitors, deflate_global_idle_monitors_using_JT()
1650 // and deflate_per_thread_idle_monitors_using_JT() (in another thread) can
1651 // run at the same time as om_flush() so we have to follow a careful
1652 // protocol to prevent list corruption.
1653 
1654 void ObjectSynchronizer::om_flush(Thread* self) {
1655   // Process the per-thread in-use list first to be consistent.
1656   int in_use_count = 0;
1657   ObjectMonitor* in_use_list = NULL;
1658   ObjectMonitor* in_use_tail = NULL;
1659   NoSafepointVerifier nsv;
1660 
1661   // This function can race with a list walker or with an async
1662   // deflater thread so we lock the list head to prevent confusion.
1663   // An async deflater thread checks to see if the target thread
1664   // is exiting, but if it has made it past that check before we
1665   // started exiting, then it is racing to get to the in-use list.
1666   if ((in_use_list = get_list_head_locked(&amp;self-&gt;om_in_use_list)) != NULL) {
1667     // At this point, we have locked the in-use list head so a racing
1668     // thread cannot come in after us. However, a racing thread could
1669     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1670     //
1671     // The thread is going away, however the ObjectMonitors on the
1672     // om_in_use_list may still be in-use by other threads. Link
1673     // them to in_use_tail, which will be linked into the global
1674     // in-use list (om_list_globals._in_use_list) below.
1675     //
1676     // Account for the in-use list head before the loop since it is
1677     // already locked (by this thread):
1678     in_use_tail = in_use_list;
1679     in_use_count++;
1680     for (ObjectMonitor* cur_om = unmarked_next(in_use_list); cur_om != NULL;) {
1681       if (is_locked(cur_om)) {
1682         // cur_om is locked so there must be a racing walker or async
1683         // deflater thread ahead of us so we&#39;ll give it a chance to finish.
1684         while (is_locked(cur_om)) {
1685           os::naked_short_sleep(1);
1686         }
1687         // Refetch the possibly changed next field and try again.
1688         cur_om = unmarked_next(in_use_tail);
1689         continue;
1690       }
1691       if (cur_om-&gt;object() == NULL) {
1692         // cur_om was deflated and the object ref was cleared while it
1693         // was locked. We happened to see it just after it was unlocked
1694         // (and added to the free list). Refetch the possibly changed
1695         // next field and try again.
1696         cur_om = unmarked_next(in_use_tail);
1697         continue;
1698       }
1699       in_use_tail = cur_om;
1700       in_use_count++;
1701       cur_om = unmarked_next(cur_om);
1702     }
1703     guarantee(in_use_tail != NULL, &quot;invariant&quot;);
1704     int l_om_in_use_count = Atomic::load(&amp;self-&gt;om_in_use_count);
1705     ADIM_guarantee(l_om_in_use_count == in_use_count, &quot;in-use counts don&#39;t match: &quot;
1706                    &quot;l_om_in_use_count=%d, in_use_count=%d&quot;, l_om_in_use_count, in_use_count);
1707     Atomic::store(&amp;self-&gt;om_in_use_count, 0);
1708     // Clear the in-use list head (which also unlocks it):
1709     Atomic::store(&amp;self-&gt;om_in_use_list, (ObjectMonitor*)NULL);
1710     om_unlock(in_use_list);
1711   }
1712 
1713   int free_count = 0;
1714   ObjectMonitor* free_list = NULL;
1715   ObjectMonitor* free_tail = NULL;
1716   // This function can race with a list walker thread so we lock the
1717   // list head to prevent confusion.
1718   if ((free_list = get_list_head_locked(&amp;self-&gt;om_free_list)) != NULL) {
1719     // At this point, we have locked the free list head so a racing
1720     // thread cannot come in after us. However, a racing thread could
1721     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1722     //
1723     // The thread is going away. Set &#39;free_tail&#39; to the last per-thread free
1724     // monitor which will be linked to om_list_globals._free_list below.
1725     //
1726     // Account for the free list head before the loop since it is
1727     // already locked (by this thread):
1728     free_tail = free_list;
1729     free_count++;
1730     for (ObjectMonitor* s = unmarked_next(free_list); s != NULL; s = unmarked_next(s)) {
1731       if (is_locked(s)) {
1732         // s is locked so there must be a racing walker thread ahead
1733         // of us so we&#39;ll give it a chance to finish.
1734         while (is_locked(s)) {
1735           os::naked_short_sleep(1);
1736         }
1737       }
1738       free_tail = s;
1739       free_count++;
1740       guarantee(s-&gt;object() == NULL, &quot;invariant&quot;);
1741       if (s-&gt;is_busy()) {
1742         stringStream ss;
1743         fatal(&quot;must be !is_busy: %s&quot;, s-&gt;is_busy_to_string(&amp;ss));
1744       }
1745     }
1746     guarantee(free_tail != NULL, &quot;invariant&quot;);
1747     int l_om_free_count = Atomic::load(&amp;self-&gt;om_free_count);
1748     ADIM_guarantee(l_om_free_count == free_count, &quot;free counts don&#39;t match: &quot;
1749                    &quot;l_om_free_count=%d, free_count=%d&quot;, l_om_free_count, free_count);
1750     Atomic::store(&amp;self-&gt;om_free_count, 0);
1751     Atomic::store(&amp;self-&gt;om_free_list, (ObjectMonitor*)NULL);
1752     om_unlock(free_list);
1753   }
1754 
1755   if (free_tail != NULL) {
1756     prepend_list_to_global_free_list(free_list, free_tail, free_count);
1757   }
1758 
1759   if (in_use_tail != NULL) {
1760     prepend_list_to_global_in_use_list(in_use_list, in_use_tail, in_use_count);
1761   }
1762 
1763   LogStreamHandle(Debug, monitorinflation) lsh_debug;
1764   LogStreamHandle(Info, monitorinflation) lsh_info;
1765   LogStream* ls = NULL;
1766   if (log_is_enabled(Debug, monitorinflation)) {
1767     ls = &amp;lsh_debug;
1768   } else if ((free_count != 0 || in_use_count != 0) &amp;&amp;
1769              log_is_enabled(Info, monitorinflation)) {
1770     ls = &amp;lsh_info;
1771   }
1772   if (ls != NULL) {
1773     ls-&gt;print_cr(&quot;om_flush: jt=&quot; INTPTR_FORMAT &quot;, free_count=%d&quot;
1774                  &quot;, in_use_count=%d&quot; &quot;, om_free_provision=%d&quot;,
1775                  p2i(self), free_count, in_use_count, self-&gt;om_free_provision);
1776   }
1777 }
1778 
1779 static void post_monitor_inflate_event(EventJavaMonitorInflate* event,
1780                                        const oop obj,
1781                                        ObjectSynchronizer::InflateCause cause) {
1782   assert(event != NULL, &quot;invariant&quot;);
1783   assert(event-&gt;should_commit(), &quot;invariant&quot;);
1784   event-&gt;set_monitorClass(obj-&gt;klass());
1785   event-&gt;set_address((uintptr_t)(void*)obj);
1786   event-&gt;set_cause((u1)cause);
1787   event-&gt;commit();
1788 }
1789 
1790 // Fast path code shared by multiple functions
1791 void ObjectSynchronizer::inflate_helper(oop obj) {
1792   markWord mark = obj-&gt;mark();
1793   if (mark.has_monitor()) {
1794     ObjectMonitor* monitor = mark.monitor();
1795     assert(ObjectSynchronizer::verify_objmon_isinpool(monitor), &quot;monitor=&quot; INTPTR_FORMAT &quot; is invalid&quot;, p2i(monitor));
1796     markWord dmw = monitor-&gt;header();
1797     assert(dmw.is_neutral(), &quot;sanity check: header=&quot; INTPTR_FORMAT, dmw.value());
1798     return;
1799   }
1800   (void)inflate(Thread::current(), obj, inflate_cause_vm_internal);
1801 }
1802 
1803 ObjectMonitor* ObjectSynchronizer::inflate(Thread* self, oop object,
1804                                            const InflateCause cause) {
1805   // Inflate mutates the heap ...
1806   // Relaxing assertion for bug 6320749.
1807   assert(Universe::verify_in_progress() ||
1808          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1809 
1810   EventJavaMonitorInflate event;
1811 
1812   for (;;) {
1813     const markWord mark = object-&gt;mark();
1814     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1815 
1816     // The mark can be in one of the following states:
1817     // *  Inflated     - just return
1818     // *  Stack-locked - coerce it to inflated
1819     // *  INFLATING    - busy wait for conversion to complete
1820     // *  Neutral      - aggressively inflate the object.
1821     // *  BIASED       - Illegal.  We should never see this
1822 
1823     // CASE: inflated
1824     if (mark.has_monitor()) {
1825       ObjectMonitor* inf = mark.monitor();
1826       markWord dmw = inf-&gt;header();
1827       assert(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1828       assert(AsyncDeflateIdleMonitors || inf-&gt;object() == object, &quot;invariant&quot;);
1829       assert(ObjectSynchronizer::verify_objmon_isinpool(inf), &quot;monitor is invalid&quot;);
1830       return inf;
1831     }
1832 
1833     // CASE: inflation in progress - inflating over a stack-lock.
1834     // Some other thread is converting from stack-locked to inflated.
1835     // Only that thread can complete inflation -- other threads must wait.
1836     // The INFLATING value is transient.
1837     // Currently, we spin/yield/park and poll the markword, waiting for inflation to finish.
1838     // We could always eliminate polling by parking the thread on some auxiliary list.
1839     if (mark == markWord::INFLATING()) {
1840       read_stable_mark(object);
1841       continue;
1842     }
1843 
1844     // CASE: stack-locked
1845     // Could be stack-locked either by this thread or by some other thread.
1846     //
1847     // Note that we allocate the objectmonitor speculatively, _before_ attempting
1848     // to install INFLATING into the mark word.  We originally installed INFLATING,
1849     // allocated the objectmonitor, and then finally STed the address of the
1850     // objectmonitor into the mark.  This was correct, but artificially lengthened
1851     // the interval in which INFLATED appeared in the mark, thus increasing
1852     // the odds of inflation contention.
1853     //
1854     // We now use per-thread private objectmonitor free lists.
1855     // These list are reprovisioned from the global free list outside the
1856     // critical INFLATING...ST interval.  A thread can transfer
1857     // multiple objectmonitors en-mass from the global free list to its local free list.
1858     // This reduces coherency traffic and lock contention on the global free list.
1859     // Using such local free lists, it doesn&#39;t matter if the om_alloc() call appears
1860     // before or after the CAS(INFLATING) operation.
1861     // See the comments in om_alloc().
1862 
1863     LogStreamHandle(Trace, monitorinflation) lsh;
1864 
1865     if (mark.has_locker()) {
1866       ObjectMonitor* m = om_alloc(self);
1867       // Optimistically prepare the objectmonitor - anticipate successful CAS
1868       // We do this before the CAS in order to minimize the length of time
1869       // in which INFLATING appears in the mark.
1870       m-&gt;Recycle();
1871       m-&gt;_Responsible  = NULL;
1872       m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;   // Consider: maintain by type/class
1873 
1874       markWord cmp = object-&gt;cas_set_mark(markWord::INFLATING(), mark);
1875       if (cmp != mark) {
1876         // om_release() will reset the allocation state from New to Free.
1877         om_release(self, m, true);
1878         continue;       // Interference -- just retry
1879       }
1880 
1881       // We&#39;ve successfully installed INFLATING (0) into the mark-word.
1882       // This is the only case where 0 will appear in a mark-word.
1883       // Only the singular thread that successfully swings the mark-word
1884       // to 0 can perform (or more precisely, complete) inflation.
1885       //
1886       // Why do we CAS a 0 into the mark-word instead of just CASing the
1887       // mark-word from the stack-locked value directly to the new inflated state?
1888       // Consider what happens when a thread unlocks a stack-locked object.
1889       // It attempts to use CAS to swing the displaced header value from the
1890       // on-stack BasicLock back into the object header.  Recall also that the
1891       // header value (hash code, etc) can reside in (a) the object header, or
1892       // (b) a displaced header associated with the stack-lock, or (c) a displaced
1893       // header in an ObjectMonitor.  The inflate() routine must copy the header
1894       // value from the BasicLock on the owner&#39;s stack to the ObjectMonitor, all
1895       // the while preserving the hashCode stability invariants.  If the owner
1896       // decides to release the lock while the value is 0, the unlock will fail
1897       // and control will eventually pass from slow_exit() to inflate.  The owner
1898       // will then spin, waiting for the 0 value to disappear.   Put another way,
1899       // the 0 causes the owner to stall if the owner happens to try to
1900       // drop the lock (restoring the header from the BasicLock to the object)
1901       // while inflation is in-progress.  This protocol avoids races that might
1902       // would otherwise permit hashCode values to change or &quot;flicker&quot; for an object.
1903       // Critically, while object-&gt;mark is 0 mark.displaced_mark_helper() is stable.
1904       // 0 serves as a &quot;BUSY&quot; inflate-in-progress indicator.
1905 
1906 
1907       // fetch the displaced mark from the owner&#39;s stack.
1908       // The owner can&#39;t die or unwind past the lock while our INFLATING
1909       // object is in the mark.  Furthermore the owner can&#39;t complete
1910       // an unlock on the object, either.
1911       markWord dmw = mark.displaced_mark_helper();
1912       // Catch if the object&#39;s header is not neutral (not locked and
1913       // not marked is what we care about here).
1914       ADIM_guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1915 
1916       // Setup monitor fields to proper values -- prepare the monitor
1917       m-&gt;set_header(dmw);
1918 
1919       // Optimization: if the mark.locker stack address is associated
1920       // with this thread we could simply set m-&gt;_owner = self.
1921       // Note that a thread can inflate an object
1922       // that it has stack-locked -- as might happen in wait() -- directly
1923       // with CAS.  That is, we can avoid the xchg-NULL .... ST idiom.
1924       if (AsyncDeflateIdleMonitors) {
1925         m-&gt;set_owner_from(NULL, DEFLATER_MARKER, mark.locker());
1926       } else {
1927         m-&gt;set_owner_from(NULL, mark.locker());
1928       }
1929       m-&gt;set_object(object);
1930       // TODO-FIXME: assert BasicLock-&gt;dhw != 0.
1931 
1932       // Must preserve store ordering. The monitor state must
1933       // be stable at the time of publishing the monitor address.
1934       guarantee(object-&gt;mark() == markWord::INFLATING(), &quot;invariant&quot;);
1935       object-&gt;release_set_mark(markWord::encode(m));
1936 
1937       // Once ObjectMonitor is configured and the object is associated
1938       // with the ObjectMonitor, it is safe to allow async deflation:
1939       assert(m-&gt;is_new(), &quot;freshly allocated monitor must be new&quot;);
1940       m-&gt;set_allocation_state(ObjectMonitor::Old);
1941 
1942       // Hopefully the performance counters are allocated on distinct cache lines
1943       // to avoid false sharing on MP systems ...
1944       OM_PERFDATA_OP(Inflations, inc());
1945       if (log_is_enabled(Trace, monitorinflation)) {
1946         ResourceMark rm(self);
1947         lsh.print_cr(&quot;inflate(has_locker): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1948                      INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1949                      object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
1950       }
1951       if (event.should_commit()) {
1952         post_monitor_inflate_event(&amp;event, object, cause);
1953       }
1954       return m;
1955     }
1956 
1957     // CASE: neutral
1958     // TODO-FIXME: for entry we currently inflate and then try to CAS _owner.
1959     // If we know we&#39;re inflating for entry it&#39;s better to inflate by swinging a
1960     // pre-locked ObjectMonitor pointer into the object header.   A successful
1961     // CAS inflates the object *and* confers ownership to the inflating thread.
1962     // In the current implementation we use a 2-step mechanism where we CAS()
1963     // to inflate and then CAS() again to try to swing _owner from NULL to self.
1964     // An inflateTry() method that we could call from enter() would be useful.
1965 
1966     // Catch if the object&#39;s header is not neutral (not locked and
1967     // not marked is what we care about here).
1968     ADIM_guarantee(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1969     ObjectMonitor* m = om_alloc(self);
1970     // prepare m for installation - set monitor to initial state
1971     m-&gt;Recycle();
1972     m-&gt;set_header(mark);
1973     if (AsyncDeflateIdleMonitors) {
1974       // DEFLATER_MARKER is the only non-NULL value we should see here.
1975       m-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
1976     }
1977     m-&gt;set_object(object);
1978     m-&gt;_Responsible  = NULL;
1979     m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;       // consider: keep metastats by type/class
1980 
1981     if (object-&gt;cas_set_mark(markWord::encode(m), mark) != mark) {
1982       m-&gt;set_header(markWord::zero());
1983       m-&gt;set_object(NULL);
1984       m-&gt;Recycle();
1985       // om_release() will reset the allocation state from New to Free.
1986       om_release(self, m, true);
1987       m = NULL;
1988       continue;
1989       // interference - the markword changed - just retry.
1990       // The state-transitions are one-way, so there&#39;s no chance of
1991       // live-lock -- &quot;Inflated&quot; is an absorbing state.
1992     }
1993 
1994     // Once the ObjectMonitor is configured and object is associated
1995     // with the ObjectMonitor, it is safe to allow async deflation:
1996     assert(m-&gt;is_new(), &quot;freshly allocated monitor must be new&quot;);
1997     m-&gt;set_allocation_state(ObjectMonitor::Old);
1998 
1999     // Hopefully the performance counters are allocated on distinct
2000     // cache lines to avoid false sharing on MP systems ...
2001     OM_PERFDATA_OP(Inflations, inc());
2002     if (log_is_enabled(Trace, monitorinflation)) {
2003       ResourceMark rm(self);
2004       lsh.print_cr(&quot;inflate(neutral): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2005                    INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
2006                    object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
2007     }
2008     if (event.should_commit()) {
2009       post_monitor_inflate_event(&amp;event, object, cause);
2010     }
2011     return m;
2012   }
2013 }
2014 
2015 
2016 // We maintain a list of in-use monitors for each thread.
2017 //
2018 // For safepoint based deflation:
2019 // deflate_thread_local_monitors() scans a single thread&#39;s in-use list, while
2020 // deflate_idle_monitors() scans only a global list of in-use monitors which
2021 // is populated only as a thread dies (see om_flush()).
2022 //
2023 // These operations are called at all safepoints, immediately after mutators
2024 // are stopped, but before any objects have moved. Collectively they traverse
2025 // the population of in-use monitors, deflating where possible. The scavenged
2026 // monitors are returned to the global monitor free list.
2027 //
2028 // Beware that we scavenge at *every* stop-the-world point. Having a large
2029 // number of monitors in-use could negatively impact performance. We also want
2030 // to minimize the total # of monitors in circulation, as they incur a small
2031 // footprint penalty.
2032 //
2033 // Perversely, the heap size -- and thus the STW safepoint rate --
2034 // typically drives the scavenge rate.  Large heaps can mean infrequent GC,
2035 // which in turn can mean large(r) numbers of ObjectMonitors in circulation.
2036 // This is an unfortunate aspect of this design.
2037 //
2038 // For async deflation:
2039 // If a special deflation request is made, then the safepoint based
2040 // deflation mechanism is used. Otherwise, an async deflation request
2041 // is registered with the ServiceThread and it is notified.
2042 
2043 void ObjectSynchronizer::do_safepoint_work(DeflateMonitorCounters* counters) {
2044   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2045 
2046   // The per-thread in-use lists are handled in
2047   // ParallelSPCleanupThreadClosure::do_thread().
2048 
2049   if (!AsyncDeflateIdleMonitors) {
2050     // Use the older mechanism for the global in-use list.
2051     ObjectSynchronizer::deflate_idle_monitors(counters);
2052     return;
2053   }
2054 
2055   log_debug(monitorinflation)(&quot;requesting async deflation of idle monitors.&quot;);
2056   // Request deflation of idle monitors by the ServiceThread:
2057   set_is_async_deflation_requested(true);
2058   MonitorLocker ml(Service_lock, Mutex::_no_safepoint_check_flag);
2059   ml.notify_all();
2060 
2061   if (log_is_enabled(Debug, monitorinflation)) {
2062     // exit_globals()&#39;s call to audit_and_print_stats() is done
2063     // at the Info level and not at a safepoint.
2064     // For safepoint based deflation, audit_and_print_stats() is called
2065     // in ObjectSynchronizer::finish_deflate_idle_monitors() at the
2066     // Debug level at a safepoint.
2067     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2068   }
2069 }
2070 
2071 // Deflate a single monitor if not in-use
2072 // Return true if deflated, false if in-use
2073 bool ObjectSynchronizer::deflate_monitor(ObjectMonitor* mid, oop obj,
2074                                          ObjectMonitor** free_head_p,
2075                                          ObjectMonitor** free_tail_p) {
2076   bool deflated;
2077   // Normal case ... The monitor is associated with obj.
2078   const markWord mark = obj-&gt;mark();
2079   guarantee(mark == markWord::encode(mid), &quot;should match: mark=&quot;
2080             INTPTR_FORMAT &quot;, encoded mid=&quot; INTPTR_FORMAT, mark.value(),
2081             markWord::encode(mid).value());
2082   // Make sure that mark.monitor() and markWord::encode() agree:
2083   guarantee(mark.monitor() == mid, &quot;should match: monitor()=&quot; INTPTR_FORMAT
2084             &quot;, mid=&quot; INTPTR_FORMAT, p2i(mark.monitor()), p2i(mid));
2085   const markWord dmw = mid-&gt;header();
2086   guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
2087 
2088   if (mid-&gt;is_busy()) {
2089     // Easy checks are first - the ObjectMonitor is busy so no deflation.
2090     deflated = false;
2091   } else {
2092     // Deflate the monitor if it is no longer being used
2093     // It&#39;s idle - scavenge and return to the global free list
2094     // plain old deflation ...
2095     if (log_is_enabled(Trace, monitorinflation)) {
2096       ResourceMark rm;
2097       log_trace(monitorinflation)(&quot;deflate_monitor: &quot;
2098                                   &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2099                                   INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(obj),
2100                                   mark.value(), obj-&gt;klass()-&gt;external_name());
2101     }
2102 
2103     // Restore the header back to obj
2104     obj-&gt;release_set_mark(dmw);
2105     if (AsyncDeflateIdleMonitors) {
2106       // clear() expects the owner field to be NULL.
2107       // DEFLATER_MARKER is the only non-NULL value we should see here.
2108       mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
2109     }
2110     mid-&gt;clear();
2111 
2112     assert(mid-&gt;object() == NULL, &quot;invariant: object=&quot; INTPTR_FORMAT,
2113            p2i(mid-&gt;object()));
2114     assert(mid-&gt;is_free(), &quot;invariant&quot;);
2115 
2116     // Move the deflated ObjectMonitor to the working free list
2117     // defined by free_head_p and free_tail_p.
2118     if (*free_head_p == NULL) *free_head_p = mid;
2119     if (*free_tail_p != NULL) {
2120       // We append to the list so the caller can use mid-&gt;_next_om
2121       // to fix the linkages in its context.
2122       ObjectMonitor* prevtail = *free_tail_p;
2123       // Should have been cleaned up by the caller:
2124       // Note: Should not have to lock prevtail here since we&#39;re at a
2125       // safepoint and ObjectMonitors on the local free list should
2126       // not be accessed in parallel.
2127 #ifdef ASSERT
2128       ObjectMonitor* l_next_om = prevtail-&gt;next_om();
2129 #endif
2130       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2131       prevtail-&gt;set_next_om(mid);
2132     }
2133     *free_tail_p = mid;
2134     // At this point, mid-&gt;_next_om still refers to its current
2135     // value and another ObjectMonitor&#39;s _next_om field still
2136     // refers to this ObjectMonitor. Those linkages have to be
2137     // cleaned up by the caller who has the complete context.
2138     deflated = true;
2139   }
2140   return deflated;
2141 }
2142 
2143 // Deflate the specified ObjectMonitor if not in-use using a JavaThread.
2144 // Returns true if it was deflated and false otherwise.
2145 //
2146 // The async deflation protocol sets owner to DEFLATER_MARKER and
2147 // makes contentions negative as signals to contending threads that
2148 // an async deflation is in progress. There are a number of checks
2149 // as part of the protocol to make sure that the calling thread has
2150 // not lost the race to a contending thread.
2151 //
2152 // The ObjectMonitor has been successfully async deflated when:
2153 //   (contentions &lt; 0)
2154 // Contending threads that see that condition know to retry their operation.
2155 //
2156 bool ObjectSynchronizer::deflate_monitor_using_JT(ObjectMonitor* mid,
2157                                                   ObjectMonitor** free_head_p,
2158                                                   ObjectMonitor** free_tail_p) {
2159   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2160   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2161   // A newly allocated ObjectMonitor should not be seen here so we
2162   // avoid an endless inflate/deflate cycle.
2163   assert(mid-&gt;is_old(), &quot;must be old: allocation_state=%d&quot;,
2164          (int) mid-&gt;allocation_state());
2165 
2166   if (mid-&gt;is_busy()) {
2167     // Easy checks are first - the ObjectMonitor is busy so no deflation.
2168     return false;
2169   }
2170 
2171   // Set a NULL owner to DEFLATER_MARKER to force any contending thread
2172   // through the slow path. This is just the first part of the async
2173   // deflation dance.
2174   if (mid-&gt;try_set_owner_from(NULL, DEFLATER_MARKER) != NULL) {
2175     // The owner field is no longer NULL so we lost the race since the
2176     // ObjectMonitor is now busy.
2177     return false;
2178   }
2179 
2180   if (mid-&gt;contentions() &gt; 0 || mid-&gt;_waiters != 0) {
2181     // Another thread has raced to enter the ObjectMonitor after
2182     // mid-&gt;is_busy() above or has already entered and waited on
2183     // it which makes it busy so no deflation. Restore owner to
2184     // NULL if it is still DEFLATER_MARKER.
2185     if (mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL) != DEFLATER_MARKER) {
2186       // Deferred decrement for the JT EnterI() that cancelled the async deflation.
2187       mid-&gt;add_to_contentions(-1);
2188     }
2189     return false;
2190   }
2191 
2192   // Make a zero contentions field negative to force any contending threads
2193   // to retry. This is the second part of the async deflation dance.
2194   if (Atomic::cmpxchg(&amp;mid-&gt;_contentions, (jint)0, -max_jint) != 0) {
2195     // Contentions was no longer 0 so we lost the race since the
2196     // ObjectMonitor is now busy. Restore owner to NULL if it is
2197     // still DEFLATER_MARKER:
2198     if (mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL) != DEFLATER_MARKER) {
2199       // Deferred decrement for the JT EnterI() that cancelled the async deflation.
2200       mid-&gt;add_to_contentions(-1);
2201     }
2202     return false;
2203   }
2204 
2205   // Sanity checks for the races:
2206   guarantee(mid-&gt;owner_is_DEFLATER_MARKER(), &quot;must be deflater marker&quot;);
2207   guarantee(mid-&gt;contentions() &lt; 0, &quot;must be negative: contentions=%d&quot;,
2208             mid-&gt;contentions());
2209   guarantee(mid-&gt;_waiters == 0, &quot;must be 0: waiters=%d&quot;, mid-&gt;_waiters);
2210   guarantee(mid-&gt;_cxq == NULL, &quot;must be no contending threads: cxq=&quot;
2211             INTPTR_FORMAT, p2i(mid-&gt;_cxq));
2212   guarantee(mid-&gt;_EntryList == NULL,
2213             &quot;must be no entering threads: EntryList=&quot; INTPTR_FORMAT,
2214             p2i(mid-&gt;_EntryList));
2215 
2216   const oop obj = (oop) mid-&gt;object();
2217   if (log_is_enabled(Trace, monitorinflation)) {
2218     ResourceMark rm;
2219     log_trace(monitorinflation)(&quot;deflate_monitor_using_JT: &quot;
2220                                 &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2221                                 INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;,
2222                                 p2i(obj), obj-&gt;mark().value(),
2223                                 obj-&gt;klass()-&gt;external_name());
2224   }
2225 
2226   // Install the old mark word if nobody else has already done it.
2227   mid-&gt;install_displaced_markword_in_object(obj);
2228   mid-&gt;clear_common();
2229 
2230   assert(mid-&gt;object() == NULL, &quot;must be NULL: object=&quot; INTPTR_FORMAT,
2231          p2i(mid-&gt;object()));
2232   assert(mid-&gt;is_free(), &quot;must be free: allocation_state=%d&quot;,
2233          (int)mid-&gt;allocation_state());
2234 
2235   // Move the deflated ObjectMonitor to the working free list
2236   // defined by free_head_p and free_tail_p.
2237   if (*free_head_p == NULL) {
2238     // First one on the list.
2239     *free_head_p = mid;
2240   }
2241   if (*free_tail_p != NULL) {
2242     // We append to the list so the caller can use mid-&gt;_next_om
2243     // to fix the linkages in its context.
2244     ObjectMonitor* prevtail = *free_tail_p;
2245     // prevtail should have been cleaned up by the caller:
2246 #ifdef ASSERT
2247     ObjectMonitor* l_next_om = unmarked_next(prevtail);
2248 #endif
2249     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2250     om_lock(prevtail);
2251     prevtail-&gt;set_next_om(mid);  // prevtail now points to mid (and is unlocked)
2252   }
2253   *free_tail_p = mid;
2254 
2255   // At this point, mid-&gt;_next_om still refers to its current
2256   // value and another ObjectMonitor&#39;s _next_om field still
2257   // refers to this ObjectMonitor. Those linkages have to be
2258   // cleaned up by the caller who has the complete context.
2259 
2260   // We leave owner == DEFLATER_MARKER and contentions &lt; 0
2261   // to force any racing threads to retry.
2262   return true;  // Success, ObjectMonitor has been deflated.
2263 }
2264 
2265 // Walk a given monitor list, and deflate idle monitors.
2266 // The given list could be a per-thread list or a global list.
2267 //
2268 // In the case of parallel processing of thread local monitor lists,
2269 // work is done by Threads::parallel_threads_do() which ensures that
2270 // each Java thread is processed by exactly one worker thread, and
2271 // thus avoid conflicts that would arise when worker threads would
2272 // process the same monitor lists concurrently.
2273 //
2274 // See also ParallelSPCleanupTask and
2275 // SafepointSynchronize::do_cleanup_tasks() in safepoint.cpp and
2276 // Threads::parallel_java_threads_do() in thread.cpp.
2277 int ObjectSynchronizer::deflate_monitor_list(ObjectMonitor** list_p,
2278                                              int* count_p,
2279                                              ObjectMonitor** free_head_p,
2280                                              ObjectMonitor** free_tail_p) {
2281   ObjectMonitor* cur_mid_in_use = NULL;
2282   ObjectMonitor* mid = NULL;
2283   ObjectMonitor* next = NULL;
2284   int deflated_count = 0;
2285 
2286   // This list walk executes at a safepoint and does not race with any
2287   // other list walkers.
2288 
2289   for (mid = Atomic::load(list_p); mid != NULL; mid = next) {
2290     next = unmarked_next(mid);
2291     oop obj = (oop) mid-&gt;object();
2292     if (obj != NULL &amp;&amp; deflate_monitor(mid, obj, free_head_p, free_tail_p)) {
2293       // Deflation succeeded and already updated free_head_p and
2294       // free_tail_p as needed. Finish the move to the local free list
2295       // by unlinking mid from the global or per-thread in-use list.
2296       if (cur_mid_in_use == NULL) {
2297         // mid is the list head so switch the list head to next:
2298         Atomic::store(list_p, next);
2299       } else {
2300         // Switch cur_mid_in_use&#39;s next field to next:
2301         cur_mid_in_use-&gt;set_next_om(next);
2302       }
2303       // At this point mid is disconnected from the in-use list.
2304       deflated_count++;
2305       Atomic::dec(count_p);
2306       // mid is current tail in the free_head_p list so NULL terminate it:
2307       mid-&gt;set_next_om(NULL);
2308     } else {
2309       cur_mid_in_use = mid;
2310     }
2311   }
2312   return deflated_count;
2313 }
2314 
2315 // Walk a given ObjectMonitor list and deflate idle ObjectMonitors using
2316 // a JavaThread. Returns the number of deflated ObjectMonitors. The given
2317 // list could be a per-thread in-use list or the global in-use list.
2318 // If a safepoint has started, then we save state via saved_mid_in_use_p
2319 // and return to the caller to honor the safepoint.
2320 //
2321 int ObjectSynchronizer::deflate_monitor_list_using_JT(ObjectMonitor** list_p,
2322                                                       int* count_p,
2323                                                       ObjectMonitor** free_head_p,
2324                                                       ObjectMonitor** free_tail_p,
2325                                                       ObjectMonitor** saved_mid_in_use_p) {
2326   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2327   JavaThread* self = JavaThread::current();
2328 
2329   ObjectMonitor* cur_mid_in_use = NULL;
2330   ObjectMonitor* mid = NULL;
2331   ObjectMonitor* next = NULL;
2332   ObjectMonitor* next_next = NULL;
2333   int deflated_count = 0;
2334   NoSafepointVerifier nsv;
2335 
2336   // We use the more complicated lock-cur_mid_in_use-and-mid-as-we-go
2337   // protocol because om_release() can do list deletions in parallel;
2338   // this also prevents races with a list walker thread. We also
2339   // lock-next-next-as-we-go to prevent an om_flush() that is behind
2340   // this thread from passing us.
2341   if (*saved_mid_in_use_p == NULL) {
2342     // No saved state so start at the beginning.
2343     // Lock the list head so we can possibly deflate it:
2344     if ((mid = get_list_head_locked(list_p)) == NULL) {
2345       return 0;  // The list is empty so nothing to deflate.
2346     }
2347     next = unmarked_next(mid);
2348   } else {
2349     // We&#39;re restarting after a safepoint so restore the necessary state
2350     // before we resume.
2351     cur_mid_in_use = *saved_mid_in_use_p;
2352     // Lock cur_mid_in_use so we can possibly update its
2353     // next field to extract a deflated ObjectMonitor.
2354     om_lock(cur_mid_in_use);
2355     mid = unmarked_next(cur_mid_in_use);
2356     if (mid == NULL) {
2357       om_unlock(cur_mid_in_use);
2358       *saved_mid_in_use_p = NULL;
2359       return 0;  // The remainder is empty so nothing more to deflate.
2360     }
2361     // Lock mid so we can possibly deflate it:
2362     om_lock(mid);
2363     next = unmarked_next(mid);
2364   }
2365 
2366   while (true) {
2367     // The current mid is locked at this point. If we have a
2368     // cur_mid_in_use, then it is also locked at this point.
2369 
2370     if (next != NULL) {
2371       // We lock next so that an om_flush() thread that is behind us
2372       // cannot pass us when we unlock the current mid.
2373       om_lock(next);
2374       next_next = unmarked_next(next);
2375     }
2376 
2377     // Only try to deflate if there is an associated Java object and if
2378     // mid is old (is not newly allocated and is not newly freed).
2379     if (mid-&gt;object() != NULL &amp;&amp; mid-&gt;is_old() &amp;&amp;
2380         deflate_monitor_using_JT(mid, free_head_p, free_tail_p)) {
2381       // Deflation succeeded and already updated free_head_p and
2382       // free_tail_p as needed. Finish the move to the local free list
2383       // by unlinking mid from the global or per-thread in-use list.
2384       if (cur_mid_in_use == NULL) {
2385         // mid is the list head and it is locked. Switch the list head
2386         // to next which is also locked (if not NULL) and also leave
2387         // mid locked:
2388         Atomic::store(list_p, next);
2389       } else {
2390         ObjectMonitor* locked_next = mark_om_ptr(next);
2391         // mid and cur_mid_in_use are locked. Switch cur_mid_in_use&#39;s
2392         // next field to locked_next and also leave mid locked:
2393         cur_mid_in_use-&gt;set_next_om(locked_next);
2394       }
2395       // At this point mid is disconnected from the in-use list so
2396       // its lock longer has any effects on in-use list.
2397       deflated_count++;
2398       Atomic::dec(count_p);
2399       // mid is current tail in the free_head_p list so NULL terminate it
2400       // (which also unlocks it):
2401       mid-&gt;set_next_om(NULL);
2402 
2403       // All the list management is done so move on to the next one:
2404       mid = next;  // mid keeps non-NULL next&#39;s locked state
2405       next = next_next;
2406     } else {
2407       // mid is considered in-use if it does not have an associated
2408       // Java object or mid is not old or deflation did not succeed.
2409       // A mid-&gt;is_new() node can be seen here when it is freshly
2410       // returned by om_alloc() (and skips the deflation code path).
2411       // A mid-&gt;is_old() node can be seen here when deflation failed.
2412       // A mid-&gt;is_free() node can be seen here when a fresh node from
2413       // om_alloc() is released by om_release() due to losing the race
2414       // in inflate().
2415 
2416       // All the list management is done so move on to the next one:
2417       if (cur_mid_in_use != NULL) {
2418         om_unlock(cur_mid_in_use);
2419       }
2420       // The next cur_mid_in_use keeps mid&#39;s lock state so
2421       // that it is stable for a possible next field change. It
2422       // cannot be modified by om_release() while it is locked.
2423       cur_mid_in_use = mid;
2424       mid = next;  // mid keeps non-NULL next&#39;s locked state
2425       next = next_next;
2426 
2427       if (SafepointMechanism::should_block(self) &amp;&amp;
2428           cur_mid_in_use != Atomic::load(list_p) &amp;&amp; cur_mid_in_use-&gt;is_old()) {
2429         // If a safepoint has started and cur_mid_in_use is not the list
2430         // head and is old, then it is safe to use as saved state. Return
2431         // to the caller before blocking.
2432         *saved_mid_in_use_p = cur_mid_in_use;
2433         om_unlock(cur_mid_in_use);
2434         if (mid != NULL) {
2435           om_unlock(mid);
2436         }
2437         return deflated_count;
2438       }
2439     }
2440     if (mid == NULL) {
2441       if (cur_mid_in_use != NULL) {
2442         om_unlock(cur_mid_in_use);
2443       }
2444       break;  // Reached end of the list so nothing more to deflate.
2445     }
2446 
2447     // The current mid&#39;s next field is locked at this point. If we have
2448     // a cur_mid_in_use, then it is also locked at this point.
2449   }
2450   // We finished the list without a safepoint starting so there&#39;s
2451   // no need to save state.
2452   *saved_mid_in_use_p = NULL;
2453   return deflated_count;
2454 }
2455 
2456 void ObjectSynchronizer::prepare_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2457   counters-&gt;n_in_use = 0;              // currently associated with objects
2458   counters-&gt;n_in_circulation = 0;      // extant
2459   counters-&gt;n_scavenged = 0;           // reclaimed (global and per-thread)
2460   counters-&gt;per_thread_scavenged = 0;  // per-thread scavenge total
2461   counters-&gt;per_thread_times = 0.0;    // per-thread scavenge times
2462 }
2463 
2464 void ObjectSynchronizer::deflate_idle_monitors(DeflateMonitorCounters* counters) {
2465   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2466 
2467   if (AsyncDeflateIdleMonitors) {
2468     // Nothing to do when global idle ObjectMonitors are deflated using
2469     // a JavaThread.
2470     return;
2471   }
2472 
2473   bool deflated = false;
2474 
2475   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2476   ObjectMonitor* free_tail_p = NULL;
2477   elapsedTimer timer;
2478 
2479   if (log_is_enabled(Info, monitorinflation)) {
2480     timer.start();
2481   }
2482 
2483   // Note: the thread-local monitors lists get deflated in
2484   // a separate pass. See deflate_thread_local_monitors().
2485 
2486   // For moribund threads, scan om_list_globals._in_use_list
2487   int deflated_count = 0;
2488   if (Atomic::load(&amp;om_list_globals._in_use_list) != NULL) {
2489     // Update n_in_circulation before om_list_globals._in_use_count is
2490     // updated by deflation.
2491     Atomic::add(&amp;counters-&gt;n_in_circulation,
2492                 Atomic::load(&amp;om_list_globals._in_use_count));
2493 
2494     deflated_count = deflate_monitor_list(&amp;om_list_globals._in_use_list,
2495                                           &amp;om_list_globals._in_use_count,
2496                                           &amp;free_head_p, &amp;free_tail_p);
2497     Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;om_list_globals._in_use_count));
2498   }
2499 
2500   if (free_head_p != NULL) {
2501     // Move the deflated ObjectMonitors back to the global free list.
2502     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2503 #ifdef ASSERT
2504     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2505 #endif
2506     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2507     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2508     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2509   }
2510   timer.stop();
2511 
2512   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2513   LogStreamHandle(Info, monitorinflation) lsh_info;
2514   LogStream* ls = NULL;
2515   if (log_is_enabled(Debug, monitorinflation)) {
2516     ls = &amp;lsh_debug;
2517   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2518     ls = &amp;lsh_info;
2519   }
2520   if (ls != NULL) {
2521     ls-&gt;print_cr(&quot;deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2522   }
2523 }
2524 
2525 class HandshakeForDeflation : public HandshakeClosure {
2526  public:
2527   HandshakeForDeflation() : HandshakeClosure(&quot;HandshakeForDeflation&quot;) {}
2528 
2529   void do_thread(Thread* thread) {
2530     log_trace(monitorinflation)(&quot;HandshakeForDeflation::do_thread: thread=&quot;
2531                                 INTPTR_FORMAT, p2i(thread));
2532   }
2533 };
2534 
2535 void ObjectSynchronizer::deflate_idle_monitors_using_JT() {
2536   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2537 
2538   // Deflate any global idle monitors.
2539   deflate_global_idle_monitors_using_JT();
2540 
2541   int count = 0;
2542   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2543     if (Atomic::load(&amp;jt-&gt;om_in_use_count) &gt; 0 &amp;&amp; !jt-&gt;is_exiting()) {
2544       // This JavaThread is using ObjectMonitors so deflate any that
2545       // are idle unless this JavaThread is exiting; do not race with
2546       // ObjectSynchronizer::om_flush().
2547       deflate_per_thread_idle_monitors_using_JT(jt);
2548       count++;
2549     }
2550   }
2551   if (count &gt; 0) {
2552     log_debug(monitorinflation)(&quot;did async deflation of idle monitors for %d thread(s).&quot;, count);
2553   }
2554 
2555   log_info(monitorinflation)(&quot;async global_population=%d, global_in_use_count=%d, &quot;
2556                              &quot;global_free_count=%d, global_wait_count=%d&quot;,
2557                              Atomic::load(&amp;om_list_globals._population),
2558                              Atomic::load(&amp;om_list_globals._in_use_count),
2559                              Atomic::load(&amp;om_list_globals._free_count),
2560                              Atomic::load(&amp;om_list_globals._wait_count));
2561 
2562   // The ServiceThread&#39;s async deflation request has been processed.
2563   _last_async_deflation_time_ns = os::javaTimeNanos();
2564   set_is_async_deflation_requested(false);
2565 
2566   if (Atomic::load(&amp;om_list_globals._wait_count) &gt; 0) {
2567     // There are deflated ObjectMonitors waiting for a handshake
2568     // (or a safepoint) for safety.
2569 
2570     ObjectMonitor* list = Atomic::load(&amp;om_list_globals._wait_list);
2571     ADIM_guarantee(list != NULL, &quot;om_list_globals._wait_list must not be NULL&quot;);
2572     int count = Atomic::load(&amp;om_list_globals._wait_count);
2573     Atomic::store(&amp;om_list_globals._wait_count, 0);
2574     Atomic::store(&amp;om_list_globals._wait_list, (ObjectMonitor*)NULL);
2575 
2576     // Find the tail for prepend_list_to_common(). No need to mark
2577     // ObjectMonitors for this list walk since only the deflater
2578     // thread manages the wait list.
2579     int l_count = 0;
2580     ObjectMonitor* tail = NULL;
2581     for (ObjectMonitor* n = list; n != NULL; n = unmarked_next(n)) {
2582       tail = n;
2583       l_count++;
2584     }
2585     ADIM_guarantee(count == l_count, &quot;count=%d != l_count=%d&quot;, count, l_count);
2586 
2587     // Will execute a safepoint if !ThreadLocalHandshakes:
2588     HandshakeForDeflation hfd_hc;
2589     Handshake::execute(&amp;hfd_hc);
2590 
2591     prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
2592                            &amp;om_list_globals._free_count);
2593 
2594     log_info(monitorinflation)(&quot;moved %d idle monitors from global waiting list to global free list&quot;, count);
2595   }
2596 }
2597 
2598 // Deflate global idle ObjectMonitors using a JavaThread.
2599 //
2600 void ObjectSynchronizer::deflate_global_idle_monitors_using_JT() {
2601   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2602   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2603   JavaThread* self = JavaThread::current();
2604 
2605   deflate_common_idle_monitors_using_JT(true /* is_global */, self);
2606 }
2607 
2608 // Deflate the specified JavaThread&#39;s idle ObjectMonitors using a JavaThread.
2609 //
2610 void ObjectSynchronizer::deflate_per_thread_idle_monitors_using_JT(JavaThread* target) {
2611   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2612   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2613 
2614   deflate_common_idle_monitors_using_JT(false /* !is_global */, target);
2615 }
2616 
2617 // Deflate global or per-thread idle ObjectMonitors using a JavaThread.
2618 //
2619 void ObjectSynchronizer::deflate_common_idle_monitors_using_JT(bool is_global, JavaThread* target) {
2620   JavaThread* self = JavaThread::current();
2621 
2622   int deflated_count = 0;
2623   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged ObjectMonitors
2624   ObjectMonitor* free_tail_p = NULL;
2625   ObjectMonitor* saved_mid_in_use_p = NULL;
2626   elapsedTimer timer;
2627 
2628   if (log_is_enabled(Info, monitorinflation)) {
2629     timer.start();
2630   }
2631 
2632   if (is_global) {
2633     OM_PERFDATA_OP(MonExtant, set_value(Atomic::load(&amp;om_list_globals._in_use_count)));
2634   } else {
2635     OM_PERFDATA_OP(MonExtant, inc(Atomic::load(&amp;target-&gt;om_in_use_count)));
2636   }
2637 
2638   do {
2639     int local_deflated_count;
2640     if (is_global) {
2641       local_deflated_count =
2642           deflate_monitor_list_using_JT(&amp;om_list_globals._in_use_list,
2643                                         &amp;om_list_globals._in_use_count,
2644                                         &amp;free_head_p, &amp;free_tail_p,
2645                                         &amp;saved_mid_in_use_p);
2646     } else {
2647       local_deflated_count =
2648           deflate_monitor_list_using_JT(&amp;target-&gt;om_in_use_list,
2649                                         &amp;target-&gt;om_in_use_count, &amp;free_head_p,
2650                                         &amp;free_tail_p, &amp;saved_mid_in_use_p);
2651     }
2652     deflated_count += local_deflated_count;
2653 
2654     if (free_head_p != NULL) {
2655       // Move the deflated ObjectMonitors to the global free list.
2656       guarantee(free_tail_p != NULL &amp;&amp; local_deflated_count &gt; 0, &quot;free_tail_p=&quot; INTPTR_FORMAT &quot;, local_deflated_count=%d&quot;, p2i(free_tail_p), local_deflated_count);
2657       // Note: The target thread can be doing an om_alloc() that
2658       // is trying to prepend an ObjectMonitor on its in-use list
2659       // at the same time that we have deflated the current in-use
2660       // list head and put it on the local free list. prepend_to_common()
2661       // will detect the race and retry which avoids list corruption,
2662       // but the next field in free_tail_p can flicker to marked
2663       // and then unmarked while prepend_to_common() is sorting it
2664       // all out.
2665 #ifdef ASSERT
2666       ObjectMonitor* l_next_om = unmarked_next(free_tail_p);
2667 #endif
2668       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2669 
2670       prepend_list_to_global_wait_list(free_head_p, free_tail_p, local_deflated_count);
2671 
2672       OM_PERFDATA_OP(Deflations, inc(local_deflated_count));
2673     }
2674 
2675     if (saved_mid_in_use_p != NULL) {
2676       // deflate_monitor_list_using_JT() detected a safepoint starting.
2677       timer.stop();
2678       {
2679         if (is_global) {
2680           log_debug(monitorinflation)(&quot;pausing deflation of global idle monitors for a safepoint.&quot;);
2681         } else {
2682           log_debug(monitorinflation)(&quot;jt=&quot; INTPTR_FORMAT &quot;: pausing deflation of per-thread idle monitors for a safepoint.&quot;, p2i(target));
2683         }
2684         assert(SafepointMechanism::should_block(self), &quot;sanity check&quot;);
2685         ThreadBlockInVM blocker(self);
2686       }
2687       // Prepare for another loop after the safepoint.
2688       free_head_p = NULL;
2689       free_tail_p = NULL;
2690       if (log_is_enabled(Info, monitorinflation)) {
2691         timer.start();
2692       }
2693     }
2694   } while (saved_mid_in_use_p != NULL);
2695   timer.stop();
2696 
2697   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2698   LogStreamHandle(Info, monitorinflation) lsh_info;
2699   LogStream* ls = NULL;
2700   if (log_is_enabled(Debug, monitorinflation)) {
2701     ls = &amp;lsh_debug;
2702   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2703     ls = &amp;lsh_info;
2704   }
2705   if (ls != NULL) {
2706     if (is_global) {
2707       ls-&gt;print_cr(&quot;async-deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2708     } else {
2709       ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: async-deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(target), timer.seconds(), deflated_count);
2710     }
2711   }
2712 }
2713 
2714 void ObjectSynchronizer::finish_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2715   // Report the cumulative time for deflating each thread&#39;s idle
2716   // monitors. Note: if the work is split among more than one
2717   // worker thread, then the reported time will likely be more
2718   // than a beginning to end measurement of the phase.
2719   log_info(safepoint, cleanup)(&quot;deflating per-thread idle monitors, %3.7f secs, monitors=%d&quot;, counters-&gt;per_thread_times, counters-&gt;per_thread_scavenged);
2720 
2721   if (AsyncDeflateIdleMonitors) {
2722     // Nothing to do when idle ObjectMonitors are deflated using
2723     // a JavaThread.
2724     return;
2725   }
2726 
2727   if (log_is_enabled(Debug, monitorinflation)) {
2728     // exit_globals()&#39;s call to audit_and_print_stats() is done
2729     // at the Info level and not at a safepoint.
2730     // For async deflation, audit_and_print_stats() is called in
2731     // ObjectSynchronizer::do_safepoint_work() at the Debug level
2732     // at a safepoint.
2733     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2734   } else if (log_is_enabled(Info, monitorinflation)) {
2735     log_info(monitorinflation)(&quot;global_population=%d, global_in_use_count=%d, &quot;
2736                                &quot;global_free_count=%d, global_wait_count=%d&quot;,
2737                                Atomic::load(&amp;om_list_globals._population),
2738                                Atomic::load(&amp;om_list_globals._in_use_count),
2739                                Atomic::load(&amp;om_list_globals._free_count),
2740                                Atomic::load(&amp;om_list_globals._wait_count));
2741   }
2742 
2743   OM_PERFDATA_OP(Deflations, inc(counters-&gt;n_scavenged));
2744   OM_PERFDATA_OP(MonExtant, set_value(counters-&gt;n_in_circulation));
2745 
2746   GVars.stw_random = os::random();
2747   GVars.stw_cycle++;
2748 }
2749 
2750 void ObjectSynchronizer::deflate_thread_local_monitors(Thread* thread, DeflateMonitorCounters* counters) {
2751   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2752 
2753   if (AsyncDeflateIdleMonitors) {
2754     // Nothing to do when per-thread idle ObjectMonitors are deflated
2755     // using a JavaThread.
2756     return;
2757   }
2758 
2759   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2760   ObjectMonitor* free_tail_p = NULL;
2761   elapsedTimer timer;
2762 
2763   if (log_is_enabled(Info, safepoint, cleanup) ||
2764       log_is_enabled(Info, monitorinflation)) {
2765     timer.start();
2766   }
2767 
2768   // Update n_in_circulation before om_in_use_count is updated by deflation.
2769   Atomic::add(&amp;counters-&gt;n_in_circulation, Atomic::load(&amp;thread-&gt;om_in_use_count));
2770 
2771   int deflated_count = deflate_monitor_list(&amp;thread-&gt;om_in_use_list, &amp;thread-&gt;om_in_use_count, &amp;free_head_p, &amp;free_tail_p);
2772   Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;thread-&gt;om_in_use_count));
2773 
2774   if (free_head_p != NULL) {
2775     // Move the deflated ObjectMonitors back to the global free list.
2776     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2777 #ifdef ASSERT
2778     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2779 #endif
2780     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2781     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2782     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2783     Atomic::add(&amp;counters-&gt;per_thread_scavenged, deflated_count);
2784   }
2785 
2786   timer.stop();
2787   counters-&gt;per_thread_times += timer.seconds();
2788 
2789   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2790   LogStreamHandle(Info, monitorinflation) lsh_info;
2791   LogStream* ls = NULL;
2792   if (log_is_enabled(Debug, monitorinflation)) {
2793     ls = &amp;lsh_debug;
2794   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2795     ls = &amp;lsh_info;
2796   }
2797   if (ls != NULL) {
2798     ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(thread), timer.seconds(), deflated_count);
2799   }
2800 }
2801 
2802 // Monitor cleanup on JavaThread::exit
2803 
2804 // Iterate through monitor cache and attempt to release thread&#39;s monitors
2805 // Gives up on a particular monitor if an exception occurs, but continues
2806 // the overall iteration, swallowing the exception.
2807 class ReleaseJavaMonitorsClosure: public MonitorClosure {
2808  private:
2809   TRAPS;
2810 
2811  public:
2812   ReleaseJavaMonitorsClosure(Thread* thread) : THREAD(thread) {}
2813   void do_monitor(ObjectMonitor* mid) {
2814     if (mid-&gt;owner() == THREAD) {
2815       (void)mid-&gt;complete_exit(CHECK);
2816     }
2817   }
2818 };
2819 
2820 // Release all inflated monitors owned by THREAD.  Lightweight monitors are
2821 // ignored.  This is meant to be called during JNI thread detach which assumes
2822 // all remaining monitors are heavyweight.  All exceptions are swallowed.
2823 // Scanning the extant monitor list can be time consuming.
2824 // A simple optimization is to add a per-thread flag that indicates a thread
2825 // called jni_monitorenter() during its lifetime.
2826 //
2827 // Instead of No_Savepoint_Verifier it might be cheaper to
2828 // use an idiom of the form:
2829 //   auto int tmp = SafepointSynchronize::_safepoint_counter ;
2830 //   &lt;code that must not run at safepoint&gt;
2831 //   guarantee (((tmp ^ _safepoint_counter) | (tmp &amp; 1)) == 0) ;
2832 // Since the tests are extremely cheap we could leave them enabled
2833 // for normal product builds.
2834 
2835 void ObjectSynchronizer::release_monitors_owned_by_thread(TRAPS) {
2836   assert(THREAD == JavaThread::current(), &quot;must be current Java thread&quot;);
2837   NoSafepointVerifier nsv;
2838   ReleaseJavaMonitorsClosure rjmc(THREAD);
2839   ObjectSynchronizer::monitors_iterate(&amp;rjmc);
2840   THREAD-&gt;clear_pending_exception();
2841 }
2842 
2843 const char* ObjectSynchronizer::inflate_cause_name(const InflateCause cause) {
2844   switch (cause) {
2845     case inflate_cause_vm_internal:    return &quot;VM Internal&quot;;
2846     case inflate_cause_monitor_enter:  return &quot;Monitor Enter&quot;;
2847     case inflate_cause_wait:           return &quot;Monitor Wait&quot;;
2848     case inflate_cause_notify:         return &quot;Monitor Notify&quot;;
2849     case inflate_cause_hash_code:      return &quot;Monitor Hash Code&quot;;
2850     case inflate_cause_jni_enter:      return &quot;JNI Monitor Enter&quot;;
2851     case inflate_cause_jni_exit:       return &quot;JNI Monitor Exit&quot;;
2852     default:
2853       ShouldNotReachHere();
2854   }
2855   return &quot;Unknown&quot;;
2856 }
2857 
2858 //------------------------------------------------------------------------------
2859 // Debugging code
2860 
2861 u_char* ObjectSynchronizer::get_gvars_addr() {
2862   return (u_char*)&amp;GVars;
2863 }
2864 
2865 u_char* ObjectSynchronizer::get_gvars_hc_sequence_addr() {
2866   return (u_char*)&amp;GVars.hc_sequence;
2867 }
2868 
2869 size_t ObjectSynchronizer::get_gvars_size() {
2870   return sizeof(SharedGlobals);
2871 }
2872 
2873 u_char* ObjectSynchronizer::get_gvars_stw_random_addr() {
2874   return (u_char*)&amp;GVars.stw_random;
2875 }
2876 
2877 // This function can be called at a safepoint or it can be called when
2878 // we are trying to exit the VM. When we are trying to exit the VM, the
2879 // list walker functions can run in parallel with the other list
2880 // operations so spin-locking is used for safety.
2881 //
2882 // Calls to this function can be added in various places as a debugging
2883 // aid; pass &#39;true&#39; for the &#39;on_exit&#39; parameter to have in-use monitor
2884 // details logged at the Info level and &#39;false&#39; for the &#39;on_exit&#39;
2885 // parameter to have in-use monitor details logged at the Trace level.
2886 // deflate_monitor_list() no longer uses spin-locking so be careful
2887 // when adding audit_and_print_stats() calls at a safepoint.
2888 //
2889 void ObjectSynchronizer::audit_and_print_stats(bool on_exit) {
2890   assert(on_exit || SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
2891 
2892   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2893   LogStreamHandle(Info, monitorinflation) lsh_info;
2894   LogStreamHandle(Trace, monitorinflation) lsh_trace;
2895   LogStream* ls = NULL;
2896   if (log_is_enabled(Trace, monitorinflation)) {
2897     ls = &amp;lsh_trace;
2898   } else if (log_is_enabled(Debug, monitorinflation)) {
2899     ls = &amp;lsh_debug;
2900   } else if (log_is_enabled(Info, monitorinflation)) {
2901     ls = &amp;lsh_info;
2902   }
2903   assert(ls != NULL, &quot;sanity check&quot;);
2904 
2905   // Log counts for the global and per-thread monitor lists:
2906   int chk_om_population = log_monitor_list_counts(ls);
2907   int error_cnt = 0;
2908 
2909   ls-&gt;print_cr(&quot;Checking global lists:&quot;);
2910 
2911   // Check om_list_globals._population:
2912   if (Atomic::load(&amp;om_list_globals._population) == chk_om_population) {
2913     ls-&gt;print_cr(&quot;global_population=%d equals chk_om_population=%d&quot;,
2914                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2915   } else {
2916     // With fine grained locks on the monitor lists, it is possible for
2917     // log_monitor_list_counts() to return a value that doesn&#39;t match
2918     // om_list_globals._population. So far a higher value has been
2919     // seen in testing so something is being double counted by
2920     // log_monitor_list_counts().
2921     ls-&gt;print_cr(&quot;WARNING: global_population=%d is not equal to &quot;
2922                  &quot;chk_om_population=%d&quot;,
2923                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2924   }
2925 
2926   // Check om_list_globals._in_use_list and om_list_globals._in_use_count:
2927   chk_global_in_use_list_and_count(ls, &amp;error_cnt);
2928 
2929   // Check om_list_globals._free_list and om_list_globals._free_count:
2930   chk_global_free_list_and_count(ls, &amp;error_cnt);
2931 
2932   // Check om_list_globals._wait_list and om_list_globals._wait_count:
2933   chk_global_wait_list_and_count(ls, &amp;error_cnt);
2934 
2935   ls-&gt;print_cr(&quot;Checking per-thread lists:&quot;);
2936 
2937   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2938     // Check om_in_use_list and om_in_use_count:
2939     chk_per_thread_in_use_list_and_count(jt, ls, &amp;error_cnt);
2940 
2941     // Check om_free_list and om_free_count:
2942     chk_per_thread_free_list_and_count(jt, ls, &amp;error_cnt);
2943   }
2944 
2945   if (error_cnt == 0) {
2946     ls-&gt;print_cr(&quot;No errors found in monitor list checks.&quot;);
2947   } else {
2948     log_error(monitorinflation)(&quot;found monitor list errors: error_cnt=%d&quot;, error_cnt);
2949   }
2950 
2951   if ((on_exit &amp;&amp; log_is_enabled(Info, monitorinflation)) ||
2952       (!on_exit &amp;&amp; log_is_enabled(Trace, monitorinflation))) {
2953     // When exiting this log output is at the Info level. When called
2954     // at a safepoint, this log output is at the Trace level since
2955     // there can be a lot of it.
2956     log_in_use_monitor_details(ls);
2957   }
2958 
2959   ls-&gt;flush();
2960 
2961   guarantee(error_cnt == 0, &quot;ERROR: found monitor list errors: error_cnt=%d&quot;, error_cnt);
2962 }
2963 
2964 // Check a free monitor entry; log any errors.
2965 void ObjectSynchronizer::chk_free_entry(JavaThread* jt, ObjectMonitor* n,
2966                                         outputStream * out, int *error_cnt_p) {
2967   stringStream ss;
2968   if (n-&gt;is_busy()) {
2969     if (jt != NULL) {
2970       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2971                     &quot;: free per-thread monitor must not be busy: %s&quot;, p2i(jt),
2972                     p2i(n), n-&gt;is_busy_to_string(&amp;ss));
2973     } else {
2974       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2975                     &quot;must not be busy: %s&quot;, p2i(n), n-&gt;is_busy_to_string(&amp;ss));
2976     }
2977     *error_cnt_p = *error_cnt_p + 1;
2978   }
2979   if (n-&gt;header().value() != 0) {
2980     if (jt != NULL) {
2981       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2982                     &quot;: free per-thread monitor must have NULL _header &quot;
2983                     &quot;field: _header=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
2984                     n-&gt;header().value());
2985       *error_cnt_p = *error_cnt_p + 1;
2986     } else if (!AsyncDeflateIdleMonitors) {
2987       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2988                     &quot;must have NULL _header field: _header=&quot; INTPTR_FORMAT,
2989                     p2i(n), n-&gt;header().value());
2990       *error_cnt_p = *error_cnt_p + 1;
2991     }
2992   }
2993   if (n-&gt;object() != NULL) {
2994     if (jt != NULL) {
2995       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2996                     &quot;: free per-thread monitor must have NULL _object &quot;
2997                     &quot;field: _object=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
2998                     p2i(n-&gt;object()));
2999     } else {
3000       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
3001                     &quot;must have NULL _object field: _object=&quot; INTPTR_FORMAT,
3002                     p2i(n), p2i(n-&gt;object()));
3003     }
3004     *error_cnt_p = *error_cnt_p + 1;
3005   }
3006 }
3007 
3008 // Lock the next ObjectMonitor for traversal and unlock the current
3009 // ObjectMonitor. Returns the next ObjectMonitor if there is one.
3010 // Otherwise returns NULL (after unlocking the current ObjectMonitor).
3011 // This function is used by the various list walker functions to
3012 // safely walk a list without allowing an ObjectMonitor to be moved
3013 // to another list in the middle of a walk.
3014 static ObjectMonitor* lock_next_for_traversal(ObjectMonitor* cur) {
3015   assert(is_locked(cur), &quot;cur=&quot; INTPTR_FORMAT &quot; must be locked&quot;, p2i(cur));
3016   ObjectMonitor* next = unmarked_next(cur);
3017   if (next == NULL) {  // Reached the end of the list.
3018     om_unlock(cur);
3019     return NULL;
3020   }
3021   om_lock(next);   // Lock next before unlocking current to keep
3022   om_unlock(cur);  // from being by-passed by another thread.
3023   return next;
3024 }
3025 
3026 // Check the global free list and count; log the results of the checks.
3027 void ObjectSynchronizer::chk_global_free_list_and_count(outputStream * out,
3028                                                         int *error_cnt_p) {
3029   int chk_om_free_count = 0;
3030   ObjectMonitor* cur = NULL;
3031   if ((cur = get_list_head_locked(&amp;om_list_globals._free_list)) != NULL) {
3032     // Marked the global free list head so process the list.
3033     while (true) {
3034       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
3035       chk_om_free_count++;
3036 
3037       cur = lock_next_for_traversal(cur);
3038       if (cur == NULL) {
3039         break;
3040       }
3041     }
3042   }
3043   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
3044   if (l_free_count == chk_om_free_count) {
3045     out-&gt;print_cr(&quot;global_free_count=%d equals chk_om_free_count=%d&quot;,
3046                   l_free_count, chk_om_free_count);
3047   } else {
3048     // With fine grained locks on om_list_globals._free_list, it
3049     // is possible for an ObjectMonitor to be prepended to
3050     // om_list_globals._free_list after we started calculating
3051     // chk_om_free_count so om_list_globals._free_count may not
3052     // match anymore.
3053     out-&gt;print_cr(&quot;WARNING: global_free_count=%d is not equal to &quot;
3054                   &quot;chk_om_free_count=%d&quot;, l_free_count, chk_om_free_count);
3055   }
3056 }
3057 
3058 // Check the global wait list and count; log the results of the checks.
3059 void ObjectSynchronizer::chk_global_wait_list_and_count(outputStream * out,
3060                                                         int *error_cnt_p) {
3061   int chk_om_wait_count = 0;
3062   ObjectMonitor* cur = NULL;
3063   if ((cur = get_list_head_locked(&amp;om_list_globals._wait_list)) != NULL) {
3064     // Marked the global wait list head so process the list.
3065     while (true) {
3066       // Rules for om_list_globals._wait_list are the same as for
3067       // om_list_globals._free_list:
3068       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
3069       chk_om_wait_count++;
3070 
3071       cur = lock_next_for_traversal(cur);
3072       if (cur == NULL) {
3073         break;
3074       }
3075     }
3076   }
3077   if (Atomic::load(&amp;om_list_globals._wait_count) == chk_om_wait_count) {
3078     out-&gt;print_cr(&quot;global_wait_count=%d equals chk_om_wait_count=%d&quot;,
3079                   Atomic::load(&amp;om_list_globals._wait_count), chk_om_wait_count);
3080   } else {
3081     out-&gt;print_cr(&quot;ERROR: global_wait_count=%d is not equal to &quot;
3082                   &quot;chk_om_wait_count=%d&quot;,
3083                   Atomic::load(&amp;om_list_globals._wait_count), chk_om_wait_count);
3084     *error_cnt_p = *error_cnt_p + 1;
3085   }
3086 }
3087 
3088 // Check the global in-use list and count; log the results of the checks.
3089 void ObjectSynchronizer::chk_global_in_use_list_and_count(outputStream * out,
3090                                                           int *error_cnt_p) {
3091   int chk_om_in_use_count = 0;
3092   ObjectMonitor* cur = NULL;
3093   if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
3094     // Marked the global in-use list head so process the list.
3095     while (true) {
3096       chk_in_use_entry(NULL /* jt */, cur, out, error_cnt_p);
3097       chk_om_in_use_count++;
3098 
3099       cur = lock_next_for_traversal(cur);
3100       if (cur == NULL) {
3101         break;
3102       }
3103     }
3104   }
3105   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
3106   if (l_in_use_count == chk_om_in_use_count) {
3107     out-&gt;print_cr(&quot;global_in_use_count=%d equals chk_om_in_use_count=%d&quot;,
3108                   l_in_use_count, chk_om_in_use_count);
3109   } else {
3110     // With fine grained locks on the monitor lists, it is possible for
3111     // an exiting JavaThread to put its in-use ObjectMonitors on the
3112     // global in-use list after chk_om_in_use_count is calculated above.
3113     out-&gt;print_cr(&quot;WARNING: global_in_use_count=%d is not equal to chk_om_in_use_count=%d&quot;,
3114                   l_in_use_count, chk_om_in_use_count);
3115   }
3116 }
3117 
3118 // Check an in-use monitor entry; log any errors.
3119 void ObjectSynchronizer::chk_in_use_entry(JavaThread* jt, ObjectMonitor* n,
3120                                           outputStream * out, int *error_cnt_p) {
3121   if (n-&gt;header().value() == 0) {
3122     if (jt != NULL) {
3123       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3124                     &quot;: in-use per-thread monitor must have non-NULL _header &quot;
3125                     &quot;field.&quot;, p2i(jt), p2i(n));
3126     } else {
3127       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
3128                     &quot;must have non-NULL _header field.&quot;, p2i(n));
3129     }
3130     *error_cnt_p = *error_cnt_p + 1;
3131   }
3132   if (n-&gt;object() == NULL) {
3133     if (jt != NULL) {
3134       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3135                     &quot;: in-use per-thread monitor must have non-NULL _object &quot;
3136                     &quot;field.&quot;, p2i(jt), p2i(n));
3137     } else {
3138       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
3139                     &quot;must have non-NULL _object field.&quot;, p2i(n));
3140     }
3141     *error_cnt_p = *error_cnt_p + 1;
3142   }
3143   const oop obj = (oop)n-&gt;object();
3144   const markWord mark = obj-&gt;mark();
3145   if (!mark.has_monitor()) {
3146     if (jt != NULL) {
3147       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3148                     &quot;: in-use per-thread monitor&#39;s object does not think &quot;
3149                     &quot;it has a monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
3150                     INTPTR_FORMAT,  p2i(jt), p2i(n), p2i(obj), mark.value());
3151     } else {
3152       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
3153                     &quot;monitor&#39;s object does not think it has a monitor: obj=&quot;
3154                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT, p2i(n),
3155                     p2i(obj), mark.value());
3156     }
3157     *error_cnt_p = *error_cnt_p + 1;
3158   }
3159   ObjectMonitor* const obj_mon = mark.monitor();
3160   if (n != obj_mon) {
3161     if (jt != NULL) {
3162       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3163                     &quot;: in-use per-thread monitor&#39;s object does not refer &quot;
3164                     &quot;to the same monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
3165                     INTPTR_FORMAT &quot;, obj_mon=&quot; INTPTR_FORMAT, p2i(jt),
3166                     p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
3167     } else {
3168       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
3169                     &quot;monitor&#39;s object does not refer to the same monitor: obj=&quot;
3170                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT &quot;, obj_mon=&quot;
3171                     INTPTR_FORMAT, p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
3172     }
3173     *error_cnt_p = *error_cnt_p + 1;
3174   }
3175 }
3176 
3177 // Check the thread&#39;s free list and count; log the results of the checks.
3178 void ObjectSynchronizer::chk_per_thread_free_list_and_count(JavaThread *jt,
3179                                                             outputStream * out,
3180                                                             int *error_cnt_p) {
3181   int chk_om_free_count = 0;
3182   ObjectMonitor* cur = NULL;
3183   if ((cur = get_list_head_locked(&amp;jt-&gt;om_free_list)) != NULL) {
3184     // Marked the per-thread free list head so process the list.
3185     while (true) {
3186       chk_free_entry(jt, cur, out, error_cnt_p);
3187       chk_om_free_count++;
3188 
3189       cur = lock_next_for_traversal(cur);
3190       if (cur == NULL) {
3191         break;
3192       }
3193     }
3194   }
3195   int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
3196   if (l_om_free_count == chk_om_free_count) {
3197     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d equals &quot;
3198                   &quot;chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count, chk_om_free_count);
3199   } else {
3200     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d is not &quot;
3201                   &quot;equal to chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count,
3202                   chk_om_free_count);
3203     *error_cnt_p = *error_cnt_p + 1;
3204   }
3205 }
3206 
3207 // Check the thread&#39;s in-use list and count; log the results of the checks.
3208 void ObjectSynchronizer::chk_per_thread_in_use_list_and_count(JavaThread *jt,
3209                                                               outputStream * out,
3210                                                               int *error_cnt_p) {
3211   int chk_om_in_use_count = 0;
3212   ObjectMonitor* cur = NULL;
3213   if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
3214     // Marked the per-thread in-use list head so process the list.
3215     while (true) {
3216       chk_in_use_entry(jt, cur, out, error_cnt_p);
3217       chk_om_in_use_count++;
3218 
3219       cur = lock_next_for_traversal(cur);
3220       if (cur == NULL) {
3221         break;
3222       }
3223     }
3224   }
3225   int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
3226   if (l_om_in_use_count == chk_om_in_use_count) {
3227     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d equals &quot;
3228                   &quot;chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
3229                   chk_om_in_use_count);
3230   } else {
3231     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d is not &quot;
3232                   &quot;equal to chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
3233                   chk_om_in_use_count);
3234     *error_cnt_p = *error_cnt_p + 1;
3235   }
3236 }
3237 
3238 // Log details about ObjectMonitors on the in-use lists. The &#39;BHL&#39;
3239 // flags indicate why the entry is in-use, &#39;object&#39; and &#39;object type&#39;
3240 // indicate the associated object and its type.
3241 void ObjectSynchronizer::log_in_use_monitor_details(outputStream * out) {
3242   stringStream ss;
3243   if (Atomic::load(&amp;om_list_globals._in_use_count) &gt; 0) {
3244     out-&gt;print_cr(&quot;In-use global monitor info:&quot;);
3245     out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
3246     out-&gt;print_cr(&quot;%18s  %s  %18s  %18s&quot;,
3247                   &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
3248     out-&gt;print_cr(&quot;==================  ===  ==================  ==================&quot;);
3249     ObjectMonitor* cur = NULL;
3250     if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
3251       // Marked the global in-use list head so process the list.
3252       while (true) {
3253         const oop obj = (oop) cur-&gt;object();
3254         const markWord mark = cur-&gt;header();
3255         ResourceMark rm;
3256         out-&gt;print(INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT &quot;  %s&quot;, p2i(cur),
3257                    cur-&gt;is_busy() != 0, mark.hash() != 0, cur-&gt;owner() != NULL,
3258                    p2i(obj), obj-&gt;klass()-&gt;external_name());
3259         if (cur-&gt;is_busy() != 0) {
3260           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
3261           ss.reset();
3262         }
3263         out-&gt;cr();
3264 
3265         cur = lock_next_for_traversal(cur);
3266         if (cur == NULL) {
3267           break;
3268         }
3269       }
3270     }
3271   }
3272 
3273   out-&gt;print_cr(&quot;In-use per-thread monitor info:&quot;);
3274   out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
3275   out-&gt;print_cr(&quot;%18s  %18s  %s  %18s  %18s&quot;,
3276                 &quot;jt&quot;, &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
3277   out-&gt;print_cr(&quot;==================  ==================  ===  ==================  ==================&quot;);
3278   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
3279     ObjectMonitor* cur = NULL;
3280     if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
3281       // Marked the global in-use list head so process the list.
3282       while (true) {
3283         const oop obj = (oop) cur-&gt;object();
3284         const markWord mark = cur-&gt;header();
3285         ResourceMark rm;
3286         out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT
3287                    &quot;  %s&quot;, p2i(jt), p2i(cur), cur-&gt;is_busy() != 0,
3288                    mark.hash() != 0, cur-&gt;owner() != NULL, p2i(obj),
3289                    obj-&gt;klass()-&gt;external_name());
3290         if (cur-&gt;is_busy() != 0) {
3291           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
3292           ss.reset();
3293         }
3294         out-&gt;cr();
3295 
3296         cur = lock_next_for_traversal(cur);
3297         if (cur == NULL) {
3298           break;
3299         }
3300       }
3301     }
3302   }
3303 
3304   out-&gt;flush();
3305 }
3306 
3307 // Log counts for the global and per-thread monitor lists and return
3308 // the population count.
3309 int ObjectSynchronizer::log_monitor_list_counts(outputStream * out) {
3310   int pop_count = 0;
3311   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s  %10s&quot;,
3312                 &quot;Global Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Wait&quot;, &quot;Total&quot;);
3313   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========  ==========&quot;);
3314   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
3315   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
3316   int l_wait_count = Atomic::load(&amp;om_list_globals._wait_count);
3317   out-&gt;print_cr(&quot;%18s  %10d  %10d  %10d  %10d&quot;, &quot;&quot;, l_in_use_count,
3318                 l_free_count, l_wait_count,
3319                 Atomic::load(&amp;om_list_globals._population));
3320   pop_count += l_in_use_count + l_free_count + l_wait_count;
3321 
3322   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s&quot;,
3323                 &quot;Per-Thread Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Provision&quot;);
3324   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========&quot;);
3325 
3326   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
3327     int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
3328     int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
3329     out-&gt;print_cr(INTPTR_FORMAT &quot;  %10d  %10d  %10d&quot;, p2i(jt),
3330                   l_om_in_use_count, l_om_free_count, jt-&gt;om_free_provision);
3331     pop_count += l_om_in_use_count + l_om_free_count;
3332   }
3333   return pop_count;
3334 }
3335 
3336 #ifndef PRODUCT
3337 
3338 // Check if monitor belongs to the monitor cache
3339 // The list is grow-only so it&#39;s *relatively* safe to traverse
3340 // the list of extant blocks without taking a lock.
3341 
3342 int ObjectSynchronizer::verify_objmon_isinpool(ObjectMonitor *monitor) {
3343   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
3344   while (block != NULL) {
3345     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
3346     if (monitor &gt; &amp;block[0] &amp;&amp; monitor &lt; &amp;block[_BLOCKSIZE]) {
3347       address mon = (address)monitor;
3348       address blk = (address)block;
3349       size_t diff = mon - blk;
3350       assert((diff % sizeof(PaddedObjectMonitor)) == 0, &quot;must be aligned&quot;);
3351       return 1;
3352     }
3353     // unmarked_next() is not needed with g_block_list (no locking
3354     // used with block linkage _next_om fields).
3355     block = (PaddedObjectMonitor*)block-&gt;next_om();
3356   }
3357   return 0;
3358 }
3359 
3360 #endif
    </pre>
  </body>
</html>