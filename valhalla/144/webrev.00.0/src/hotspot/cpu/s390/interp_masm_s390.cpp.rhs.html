<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/s390/interp_masm_s390.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.
<a name="1" id="anc1"></a><span class="line-modified">   3  * Copyright (c) 2016, 2020 SAP SE. All rights reserved.</span>
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 // Major contributions by AHa, AS, JL, ML.
  27 
  28 #include &quot;precompiled.hpp&quot;
  29 #include &quot;asm/macroAssembler.inline.hpp&quot;
  30 #include &quot;gc/shared/barrierSet.hpp&quot;
  31 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  32 #include &quot;interp_masm_s390.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
  34 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  35 #include &quot;oops/arrayOop.hpp&quot;
  36 #include &quot;oops/markWord.hpp&quot;
<a name="2" id="anc2"></a><span class="line-added">  37 #include &quot;oops/methodData.hpp&quot;</span>
  38 #include &quot;prims/jvmtiExport.hpp&quot;
  39 #include &quot;prims/jvmtiThreadState.hpp&quot;
  40 #include &quot;runtime/basicLock.hpp&quot;
  41 #include &quot;runtime/biasedLocking.hpp&quot;
  42 #include &quot;runtime/frame.inline.hpp&quot;
  43 #include &quot;runtime/safepointMechanism.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;runtime/thread.inline.hpp&quot;
  46 #include &quot;utilities/powerOfTwo.hpp&quot;
  47 
  48 // Implementation of InterpreterMacroAssembler.
  49 // This file specializes the assembler with interpreter-specific macros.
  50 
  51 #ifdef PRODUCT
  52 #define BLOCK_COMMENT(str)
  53 #define BIND(label)        bind(label);
  54 #else
  55 #define BLOCK_COMMENT(str) block_comment(str)
  56 #define BIND(label)        bind(label); BLOCK_COMMENT(#label &quot;:&quot;)
  57 #endif
  58 
  59 void InterpreterMacroAssembler::jump_to_entry(address entry, Register Rscratch) {
  60   assert(entry != NULL, &quot;Entry must have been generated by now&quot;);
  61   assert(Rscratch != Z_R0, &quot;Can&#39;t use R0 for addressing&quot;);
  62   branch_optimized(Assembler::bcondAlways, entry);
  63 }
  64 
  65 void InterpreterMacroAssembler::empty_expression_stack(void) {
  66   get_monitors(Z_R1_scratch);
  67   add2reg(Z_esp, -Interpreter::stackElementSize, Z_R1_scratch);
  68 }
  69 
  70 // Dispatch code executed in the prolog of a bytecode which does not do it&#39;s
  71 // own dispatch.
  72 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int bcp_incr) {
  73   // On z/Architecture we are short on registers, therefore we do not preload the
  74   // dispatch address of the next bytecode.
  75 }
  76 
  77 // Dispatch code executed in the epilog of a bytecode which does not do it&#39;s
  78 // own dispatch.
  79 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int step) {
  80   dispatch_next(state, step);
  81 }
  82 
  83 void InterpreterMacroAssembler::dispatch_next(TosState state, int bcp_incr, bool generate_poll) {
  84   z_llgc(Z_bytecode, bcp_incr, Z_R0, Z_bcp);  // Load next bytecode.
  85   add2reg(Z_bcp, bcp_incr);                   // Advance bcp. Add2reg produces optimal code.
  86   dispatch_base(state, Interpreter::dispatch_table(state), generate_poll);
  87 }
  88 
  89 // Common code to dispatch and dispatch_only.
  90 // Dispatch value in Lbyte_code and increment Lbcp.
  91 
  92 void InterpreterMacroAssembler::dispatch_base(TosState state, address* table, bool generate_poll) {
  93   verify_FPU(1, state);
  94 
  95 #ifdef ASSERT
  96   address reentry = NULL;
  97   { Label OK;
  98     // Check if the frame pointer in Z_fp is correct.
  99     z_cg(Z_fp, 0, Z_SP);
 100     z_bre(OK);
 101     reentry = stop_chain_static(reentry, &quot;invalid frame pointer Z_fp: &quot; FILE_AND_LINE);
 102     bind(OK);
 103   }
 104   { Label OK;
 105     // check if the locals pointer in Z_locals is correct
 106     z_cg(Z_locals, _z_ijava_state_neg(locals), Z_fp);
 107     z_bre(OK);
 108     reentry = stop_chain_static(reentry, &quot;invalid locals pointer Z_locals: &quot; FILE_AND_LINE);
 109     bind(OK);
 110   }
 111 #endif
 112 
 113   // TODO: Maybe implement +VerifyActivationFrameSize here.
 114   // verify_thread(); // Too slow. We will just verify on method entry &amp; exit.
 115   verify_oop(Z_tos, state);
 116 
 117   // Dispatch table to use.
 118   load_absolute_address(Z_tmp_1, (address)table);  // Z_tmp_1 = table;
 119 
 120   if (generate_poll) {
 121     address *sfpt_tbl = Interpreter::safept_table(state);
 122     if (table != sfpt_tbl) {
 123       Label dispatch;
 124       const Address poll_byte_addr(Z_thread, in_bytes(Thread::polling_page_offset()) + 7 /* Big Endian */);
 125       // Armed page has poll_bit set, if poll bit is cleared just continue.
 126       z_tm(poll_byte_addr, SafepointMechanism::poll_bit());
 127       z_braz(dispatch);
 128       load_absolute_address(Z_tmp_1, (address)sfpt_tbl);  // Z_tmp_1 = table;
 129       bind(dispatch);
 130     }
 131   }
 132 
 133   // 0 &lt;= Z_bytecode &lt; 256 =&gt; Use a 32 bit shift, because it is shorter than sllg.
 134   // Z_bytecode must have been loaded zero-extended for this approach to be correct.
 135   z_sll(Z_bytecode, LogBytesPerWord, Z_R0);   // Multiply by wordSize.
 136   z_lg(Z_tmp_1, 0, Z_bytecode, Z_tmp_1);      // Get entry addr.
 137 
 138   z_br(Z_tmp_1);
 139 }
 140 
 141 void InterpreterMacroAssembler::dispatch_only(TosState state, bool generate_poll) {
 142   dispatch_base(state, Interpreter::dispatch_table(state), generate_poll);
 143 }
 144 
 145 void InterpreterMacroAssembler::dispatch_only_normal(TosState state) {
 146   dispatch_base(state, Interpreter::normal_table(state));
 147 }
 148 
 149 void InterpreterMacroAssembler::dispatch_via(TosState state, address *table) {
 150   // Load current bytecode.
 151   z_llgc(Z_bytecode, Address(Z_bcp, (intptr_t)0));
 152   dispatch_base(state, table);
 153 }
 154 
 155 // The following call_VM*_base() methods overload and mask the respective
 156 // declarations/definitions in class MacroAssembler. They are meant as a &quot;detour&quot;
 157 // to perform additional, template interpreter specific tasks before actually
 158 // calling their MacroAssembler counterparts.
 159 
 160 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point) {
 161   bool allow_relocation = true; // Fenerally valid variant. Assume code is relocated.
 162   // interpreter specific
 163   // Note: No need to save/restore bcp (Z_R13) pointer since these are callee
 164   // saved registers and no blocking/ GC can happen in leaf calls.
 165 
 166   // super call
 167   MacroAssembler::call_VM_leaf_base(entry_point, allow_relocation);
 168 }
 169 
 170 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point, bool allow_relocation) {
 171   // interpreter specific
 172   // Note: No need to save/restore bcp (Z_R13) pointer since these are callee
 173   // saved registers and no blocking/ GC can happen in leaf calls.
 174 
 175   // super call
 176   MacroAssembler::call_VM_leaf_base(entry_point, allow_relocation);
 177 }
 178 
 179 void InterpreterMacroAssembler::call_VM_base(Register oop_result, Register last_java_sp,
 180                                              address entry_point, bool check_exceptions) {
 181   bool allow_relocation = true; // Fenerally valid variant. Assume code is relocated.
 182   // interpreter specific
 183 
 184   save_bcp();
 185   save_esp();
 186   // super call
 187   MacroAssembler::call_VM_base(oop_result, last_java_sp,
 188                                entry_point, allow_relocation, check_exceptions);
 189   restore_bcp();
 190 }
 191 
 192 void InterpreterMacroAssembler::call_VM_base(Register oop_result, Register last_java_sp,
 193                                              address entry_point, bool allow_relocation,
 194                                              bool check_exceptions) {
 195   // interpreter specific
 196 
 197   save_bcp();
 198   save_esp();
 199   // super call
 200   MacroAssembler::call_VM_base(oop_result, last_java_sp,
 201                                entry_point, allow_relocation, check_exceptions);
 202   restore_bcp();
 203 }
 204 
 205 void InterpreterMacroAssembler::check_and_handle_popframe(Register scratch_reg) {
 206   if (JvmtiExport::can_pop_frame()) {
 207     BLOCK_COMMENT(&quot;check_and_handle_popframe {&quot;);
 208     Label L;
 209     // Initiate popframe handling only if it is not already being
 210     // processed. If the flag has the popframe_processing bit set, it
 211     // means that this code is called *during* popframe handling - we
 212     // don&#39;t want to reenter.
 213     // TODO: Check if all four state combinations could be visible.
 214     // If (processing and !pending) is an invisible/impossible state,
 215     // there is optimization potential by testing both bits at once.
 216     // Then, All_Zeroes and All_Ones means skip, Mixed means doit.
 217     testbit(Address(Z_thread, JavaThread::popframe_condition_offset()),
 218             exact_log2(JavaThread::popframe_pending_bit));
 219     z_bfalse(L);
 220     testbit(Address(Z_thread, JavaThread::popframe_condition_offset()),
 221             exact_log2(JavaThread::popframe_processing_bit));
 222     z_btrue(L);
 223 
 224     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 225     // address of the same-named entrypoint in the generated interpreter code.
 226     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 227     // The above call should (as its only effect) return the contents of the field
 228     // _remove_activation_preserving_args_entry in Z_RET.
 229     // We just jump there to have the work done.
 230     z_br(Z_RET);
 231     // There is no way for control to fall thru here.
 232 
 233     bind(L);
 234     BLOCK_COMMENT(&quot;} check_and_handle_popframe&quot;);
 235   }
 236 }
 237 
 238 
 239 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 240   Register RjvmtiState = Z_R1_scratch;
 241   int      tos_off     = in_bytes(JvmtiThreadState::earlyret_tos_offset());
 242   int      oop_off     = in_bytes(JvmtiThreadState::earlyret_oop_offset());
 243   int      val_off     = in_bytes(JvmtiThreadState::earlyret_value_offset());
 244   int      state_off   = in_bytes(JavaThread::jvmti_thread_state_offset());
 245 
 246   z_lg(RjvmtiState, state_off, Z_thread);
 247 
 248   switch (state) {
 249     case atos: z_lg(Z_tos, oop_off, RjvmtiState);
 250       store_const(Address(RjvmtiState, oop_off), 0L, 8, 8, Z_R0_scratch);
 251                                                     break;
 252     case ltos: z_lg(Z_tos, val_off, RjvmtiState);   break;
 253     case btos: // fall through
 254     case ztos: // fall through
 255     case ctos: // fall through
 256     case stos: // fall through
 257     case itos: z_llgf(Z_tos, val_off, RjvmtiState); break;
 258     case ftos: z_le(Z_ftos, val_off, RjvmtiState);  break;
 259     case dtos: z_ld(Z_ftos, val_off, RjvmtiState);  break;
 260     case vtos:   /* nothing to do */                break;
 261     default  : ShouldNotReachHere();
 262   }
 263 
 264   // Clean up tos value in the jvmti thread state.
 265   store_const(Address(RjvmtiState, val_off),   0L, 8, 8, Z_R0_scratch);
 266   // Set tos state field to illegal value.
 267   store_const(Address(RjvmtiState, tos_off), ilgl, 4, 1, Z_R0_scratch);
 268 }
 269 
 270 void InterpreterMacroAssembler::check_and_handle_earlyret(Register scratch_reg) {
 271   if (JvmtiExport::can_force_early_return()) {
 272     BLOCK_COMMENT(&quot;check_and_handle_earlyret {&quot;);
 273     Label L;
 274     // arg regs are save, because we are just behind the call in call_VM_base
 275     Register jvmti_thread_state = Z_ARG2;
 276     Register tmp                = Z_ARG3;
 277     load_and_test_long(jvmti_thread_state, Address(Z_thread, JavaThread::jvmti_thread_state_offset()));
 278     z_bre(L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 279 
 280     // Initiate earlyret handling only if it is not already being processed.
 281     // If the flag has the earlyret_processing bit set, it means that this code
 282     // is called *during* earlyret handling - we don&#39;t want to reenter.
 283 
 284     assert((JvmtiThreadState::earlyret_pending != 0) &amp;&amp; (JvmtiThreadState::earlyret_inactive == 0),
 285           &quot;must fix this check, when changing the values of the earlyret enum&quot;);
 286     assert(JvmtiThreadState::earlyret_pending == 1, &quot;must fix this check, when changing the values of the earlyret enum&quot;);
 287 
 288     load_and_test_int(tmp, Address(jvmti_thread_state, JvmtiThreadState::earlyret_state_offset()));
 289     z_brz(L); // if (thread-&gt;jvmti_thread_state()-&gt;_earlyret_state != JvmtiThreadState::earlyret_pending) exit;
 290 
 291     // Call Interpreter::remove_activation_early_entry() to get the address of the
 292     // same-named entrypoint in the generated interpreter code.
 293     assert(sizeof(TosState) == 4, &quot;unexpected size&quot;);
 294     z_l(Z_ARG1, Address(jvmti_thread_state, JvmtiThreadState::earlyret_tos_offset()));
 295     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), Z_ARG1);
 296     // The above call should (as its only effect) return the contents of the field
 297     // _remove_activation_preserving_args_entry in Z_RET.
 298     // We just jump there to have the work done.
 299     z_br(Z_RET);
 300     // There is no way for control to fall thru here.
 301 
 302     bind(L);
 303     BLOCK_COMMENT(&quot;} check_and_handle_earlyret&quot;);
 304   }
 305 }
 306 
 307 void InterpreterMacroAssembler::super_call_VM_leaf(address entry_point, Register arg_1, Register arg_2) {
 308   lgr_if_needed(Z_ARG1, arg_1);
 309   assert(arg_2 != Z_ARG1, &quot;smashed argument&quot;);
 310   lgr_if_needed(Z_ARG2, arg_2);
 311   MacroAssembler::call_VM_leaf_base(entry_point, true);
 312 }
 313 
 314 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register index, int bcp_offset, size_t index_size) {
 315   Address param(Z_bcp, bcp_offset);
 316 
 317   BLOCK_COMMENT(&quot;get_cache_index_at_bcp {&quot;);
 318   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 319   if (index_size == sizeof(u2)) {
 320     load_sized_value(index, param, 2, false /*signed*/);
 321   } else if (index_size == sizeof(u4)) {
 322 
 323     load_sized_value(index, param, 4, false);
 324 
 325     // Check if the secondary index definition is still ~x, otherwise
 326     // we have to change the following assembler code to calculate the
 327     // plain index.
 328     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 329     not_(index);  // Convert to plain index.
 330   } else if (index_size == sizeof(u1)) {
 331     z_llgc(index, param);
 332   } else {
 333     ShouldNotReachHere();
 334   }
 335   BLOCK_COMMENT(&quot;}&quot;);
 336 }
 337 
 338 
 339 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache, Register cpe_offset,
 340                                                            int bcp_offset, size_t index_size) {
 341   BLOCK_COMMENT(&quot;get_cache_and_index_at_bcp {&quot;);
 342   assert_different_registers(cache, cpe_offset);
 343   get_cache_index_at_bcp(cpe_offset, bcp_offset, index_size);
 344   z_lg(cache, Address(Z_fp, _z_ijava_state_neg(cpoolCache)));
 345   // Convert from field index to ConstantPoolCache offset in bytes.
 346   z_sllg(cpe_offset, cpe_offset, exact_log2(in_words(ConstantPoolCacheEntry::size()) * BytesPerWord));
 347   BLOCK_COMMENT(&quot;}&quot;);
 348 }
 349 
 350 // Kills Z_R0_scratch.
 351 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,
 352                                                                         Register cpe_offset,
 353                                                                         Register bytecode,
 354                                                                         int byte_no,
 355                                                                         int bcp_offset,
 356                                                                         size_t index_size) {
 357   BLOCK_COMMENT(&quot;get_cache_and_index_and_bytecode_at_bcp {&quot;);
 358   get_cache_and_index_at_bcp(cache, cpe_offset, bcp_offset, index_size);
 359 
 360   // We want to load (from CP cache) the bytecode that corresponds to the passed-in byte_no.
 361   // It is located at (cache + cpe_offset + base_offset + indices_offset + (8-1) (last byte in DW) - (byte_no+1).
 362   // Instead of loading, shifting and masking a DW, we just load that one byte of interest with z_llgc (unsigned).
 363   const int base_ix_off = in_bytes(ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset());
 364   const int off_in_DW   = (8-1) - (1+byte_no);
 365   assert(ConstantPoolCacheEntry::bytecode_1_mask == ConstantPoolCacheEntry::bytecode_2_mask, &quot;common mask&quot;);
 366   assert(ConstantPoolCacheEntry::bytecode_1_mask == 0xff, &quot;&quot;);
 367   load_sized_value(bytecode, Address(cache, cpe_offset, base_ix_off+off_in_DW), 1, false /*signed*/);
 368 
 369   BLOCK_COMMENT(&quot;}&quot;);
 370 }
 371 
 372 // Load object from cpool-&gt;resolved_references(index).
 373 void InterpreterMacroAssembler::load_resolved_reference_at_index(Register result, Register index) {
 374   assert_different_registers(result, index);
 375   get_constant_pool(result);
 376 
 377   // Convert
 378   //  - from field index to resolved_references() index and
 379   //  - from word index to byte offset.
 380   // Since this is a java object, it is potentially compressed.
 381   Register tmp = index;  // reuse
 382   z_sllg(index, index, LogBytesPerHeapOop); // Offset into resolved references array.
 383   // Load pointer for resolved_references[] objArray.
 384   z_lg(result, ConstantPool::cache_offset_in_bytes(), result);
 385   z_lg(result, ConstantPoolCache::resolved_references_offset_in_bytes(), result);
 386   resolve_oop_handle(result); // Load resolved references array itself.
 387 #ifdef ASSERT
 388   NearLabel index_ok;
 389   z_lgf(Z_R0, Address(result, arrayOopDesc::length_offset_in_bytes()));
 390   z_sllg(Z_R0, Z_R0, LogBytesPerHeapOop);
 391   compare64_and_branch(tmp, Z_R0, Assembler::bcondLow, index_ok);
 392   stop(&quot;resolved reference index out of bounds&quot;, 0x09256);
 393   bind(index_ok);
 394 #endif
 395   z_agr(result, index);    // Address of indexed array element.
 396   load_heap_oop(result, Address(result, arrayOopDesc::base_offset_in_bytes(T_OBJECT)), tmp, noreg);
 397 }
 398 
 399 // load cpool-&gt;resolved_klass_at(index)
 400 void InterpreterMacroAssembler::load_resolved_klass_at_offset(Register cpool, Register offset, Register iklass) {
 401   // int value = *(Rcpool-&gt;int_at_addr(which));
 402   // int resolved_klass_index = extract_low_short_from_int(value);
 403   z_llgh(offset, Address(cpool, offset, sizeof(ConstantPool) + 2)); // offset = resolved_klass_index (s390 is big-endian)
 404   z_sllg(offset, offset, LogBytesPerWord);                          // Convert &#39;index&#39; to &#39;offset&#39;
 405   z_lg(iklass, Address(cpool, ConstantPool::resolved_klasses_offset_in_bytes())); // iklass = cpool-&gt;_resolved_klasses
 406   z_lg(iklass, Address(iklass, offset, Array&lt;Klass*&gt;::base_offset_in_bytes()));
 407 }
 408 
 409 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache,
 410                                                                Register tmp,
 411                                                                int bcp_offset,
 412                                                                size_t index_size) {
 413   BLOCK_COMMENT(&quot;get_cache_entry_pointer_at_bcp {&quot;);
 414     get_cache_and_index_at_bcp(cache, tmp, bcp_offset, index_size);
 415     add2reg_with_index(cache, in_bytes(ConstantPoolCache::base_offset()), tmp, cache);
 416   BLOCK_COMMENT(&quot;}&quot;);
 417 }
 418 
 419 void InterpreterMacroAssembler::load_resolved_method_at_index(int byte_no,
 420                                                               Register cache,
 421                                                               Register cpe_offset,
 422                                                               Register method) {
 423   const int method_offset = in_bytes(
 424     ConstantPoolCache::base_offset() +
 425       ((byte_no == TemplateTable::f2_byte)
 426        ? ConstantPoolCacheEntry::f2_offset()
 427        : ConstantPoolCacheEntry::f1_offset()));
 428 
 429   z_lg(method, Address(cache, cpe_offset, method_offset)); // get f1 Method*
 430 }
 431 
 432 // Generate a subtype check: branch to ok_is_subtype if sub_klass is
 433 // a subtype of super_klass. Blows registers Rsuper_klass, Rsub_klass, tmp1, tmp2.
 434 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 435                                                   Register Rsuper_klass,
 436                                                   Register Rtmp1,
 437                                                   Register Rtmp2,
 438                                                   Label &amp;ok_is_subtype) {
 439   // Profile the not-null value&#39;s klass.
 440   profile_typecheck(Rtmp1, Rsub_klass, Rtmp2);
 441 
 442   // Do the check.
 443   check_klass_subtype(Rsub_klass, Rsuper_klass, Rtmp1, Rtmp2, ok_is_subtype);
 444 
 445   // Profile the failure of the check.
 446   profile_typecheck_failed(Rtmp1, Rtmp2);
 447 }
 448 
 449 // Pop topmost element from stack. It just disappears.
 450 // Useful if consumed previously by access via stackTop().
 451 void InterpreterMacroAssembler::popx(int len) {
 452   add2reg(Z_esp, len*Interpreter::stackElementSize);
 453   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 454 }
 455 
 456 // Get Address object of stack top. No checks. No pop.
 457 // Purpose: - Provide address of stack operand to exploit reg-mem operations.
 458 //          - Avoid RISC-like mem2reg - reg-reg-op sequence.
 459 Address InterpreterMacroAssembler::stackTop() {
 460   return Address(Z_esp, Interpreter::expr_offset_in_bytes(0));
 461 }
 462 
 463 void InterpreterMacroAssembler::pop_i(Register r) {
 464   z_l(r, Interpreter::expr_offset_in_bytes(0), Z_esp);
 465   add2reg(Z_esp, Interpreter::stackElementSize);
 466   assert_different_registers(r, Z_R1_scratch);
 467   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 468 }
 469 
 470 void InterpreterMacroAssembler::pop_ptr(Register r) {
 471   z_lg(r, Interpreter::expr_offset_in_bytes(0), Z_esp);
 472   add2reg(Z_esp, Interpreter::stackElementSize);
 473   assert_different_registers(r, Z_R1_scratch);
 474   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 475 }
 476 
 477 void InterpreterMacroAssembler::pop_l(Register r) {
 478   z_lg(r, Interpreter::expr_offset_in_bytes(0), Z_esp);
 479   add2reg(Z_esp, 2*Interpreter::stackElementSize);
 480   assert_different_registers(r, Z_R1_scratch);
 481   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 482 }
 483 
 484 void InterpreterMacroAssembler::pop_f(FloatRegister f) {
 485   mem2freg_opt(f, Address(Z_esp, Interpreter::expr_offset_in_bytes(0)), false);
 486   add2reg(Z_esp, Interpreter::stackElementSize);
 487   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 488 }
 489 
 490 void InterpreterMacroAssembler::pop_d(FloatRegister f) {
 491   mem2freg_opt(f, Address(Z_esp, Interpreter::expr_offset_in_bytes(0)), true);
 492   add2reg(Z_esp, 2*Interpreter::stackElementSize);
 493   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 494 }
 495 
 496 void InterpreterMacroAssembler::push_i(Register r) {
 497   assert_different_registers(r, Z_R1_scratch);
 498   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 499   z_st(r, Address(Z_esp));
 500   add2reg(Z_esp, -Interpreter::stackElementSize);
 501 }
 502 
 503 void InterpreterMacroAssembler::push_ptr(Register r) {
 504   z_stg(r, Address(Z_esp));
 505   add2reg(Z_esp, -Interpreter::stackElementSize);
 506 }
 507 
 508 void InterpreterMacroAssembler::push_l(Register r) {
 509   assert_different_registers(r, Z_R1_scratch);
 510   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 511   int offset = -Interpreter::stackElementSize;
 512   z_stg(r, Address(Z_esp, offset));
 513   clear_mem(Address(Z_esp), Interpreter::stackElementSize);
 514   add2reg(Z_esp, 2 * offset);
 515 }
 516 
 517 void InterpreterMacroAssembler::push_f(FloatRegister f) {
 518   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 519   freg2mem_opt(f, Address(Z_esp), false);
 520   add2reg(Z_esp, -Interpreter::stackElementSize);
 521 }
 522 
 523 void InterpreterMacroAssembler::push_d(FloatRegister d) {
 524   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 525   int offset = -Interpreter::stackElementSize;
 526   freg2mem_opt(d, Address(Z_esp, offset));
 527   add2reg(Z_esp, 2 * offset);
 528 }
 529 
 530 void InterpreterMacroAssembler::push(TosState state) {
 531   verify_oop(Z_tos, state);
 532   switch (state) {
 533     case atos: push_ptr();           break;
 534     case btos: push_i();             break;
 535     case ztos:
 536     case ctos:
 537     case stos: push_i();             break;
 538     case itos: push_i();             break;
 539     case ltos: push_l();             break;
 540     case ftos: push_f();             break;
 541     case dtos: push_d();             break;
 542     case vtos: /* nothing to do */   break;
 543     default  : ShouldNotReachHere();
 544   }
 545 }
 546 
 547 void InterpreterMacroAssembler::pop(TosState state) {
 548   switch (state) {
 549     case atos: pop_ptr(Z_tos);       break;
 550     case btos: pop_i(Z_tos);         break;
 551     case ztos:
 552     case ctos:
 553     case stos: pop_i(Z_tos);         break;
 554     case itos: pop_i(Z_tos);         break;
 555     case ltos: pop_l(Z_tos);         break;
 556     case ftos: pop_f(Z_ftos);        break;
 557     case dtos: pop_d(Z_ftos);        break;
 558     case vtos: /* nothing to do */   break;
 559     default  : ShouldNotReachHere();
 560   }
 561   verify_oop(Z_tos, state);
 562 }
 563 
 564 // Helpers for swap and dup.
 565 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 566   z_lg(val, Address(Z_esp, Interpreter::expr_offset_in_bytes(n)));
 567 }
 568 
 569 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 570   z_stg(val, Address(Z_esp, Interpreter::expr_offset_in_bytes(n)));
 571 }
 572 
 573 void InterpreterMacroAssembler::prepare_to_jump_from_interpreted(Register method) {
 574   // Satisfy interpreter calling convention (see generate_normal_entry()).
 575   z_lgr(Z_R10, Z_SP); // Set sender sp (aka initial caller sp, aka unextended sp).
 576   // Record top_frame_sp, because the callee might modify it, if it&#39;s compiled.
 577   z_stg(Z_SP, _z_ijava_state_neg(top_frame_sp), Z_fp);
 578   save_bcp();
 579   save_esp();
 580   z_lgr(Z_method, method); // Set Z_method (kills Z_fp!).
 581 }
 582 
 583 // Jump to from_interpreted entry of a call unless single stepping is possible
 584 // in this thread in which case we must call the i2i entry.
 585 void InterpreterMacroAssembler::jump_from_interpreted(Register method, Register temp) {
 586   assert_different_registers(method, Z_R10 /*used for initial_caller_sp*/, temp);
 587   prepare_to_jump_from_interpreted(method);
 588 
 589   if (JvmtiExport::can_post_interpreter_events()) {
 590     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 591     // compiled code in threads for which the event is enabled. Check here for
 592     // interp_only_mode if these events CAN be enabled.
 593     z_lg(Z_R1_scratch, Address(method, Method::from_interpreted_offset()));
 594     MacroAssembler::load_and_test_int(Z_R0_scratch, Address(Z_thread, JavaThread::interp_only_mode_offset()));
 595     z_bcr(bcondEqual, Z_R1_scratch); // Run compiled code if zero.
 596     // Run interpreted.
 597     z_lg(Z_R1_scratch, Address(method, Method::interpreter_entry_offset()));
 598     z_br(Z_R1_scratch);
 599   } else {
 600     // Run compiled code.
 601     z_lg(Z_R1_scratch, Address(method, Method::from_interpreted_offset()));
 602     z_br(Z_R1_scratch);
 603   }
 604 }
 605 
 606 #ifdef ASSERT
 607 void InterpreterMacroAssembler::verify_esp(Register Resp, Register Rtemp) {
 608   // About to read or write Resp[0].
 609   // Make sure it is not in the monitors or the TOP_IJAVA_FRAME_ABI.
 610   address reentry = NULL;
 611 
 612   {
 613     // Check if the frame pointer in Z_fp is correct.
 614     NearLabel OK;
 615     z_cg(Z_fp, 0, Z_SP);
 616     z_bre(OK);
 617     reentry = stop_chain_static(reentry, &quot;invalid frame pointer Z_fp&quot;);
 618     bind(OK);
 619   }
 620   {
 621     // Resp must not point into or below the operand stack,
 622     // i.e. IJAVA_STATE.monitors &gt; Resp.
 623     NearLabel OK;
 624     Register Rmonitors = Rtemp;
 625     z_lg(Rmonitors, _z_ijava_state_neg(monitors), Z_fp);
 626     compareU64_and_branch(Rmonitors, Resp, bcondHigh, OK);
 627     reentry = stop_chain_static(reentry, &quot;too many pops: Z_esp points into monitor area&quot;);
 628     bind(OK);
 629   }
 630   {
 631     // Resp may point to the last word of TOP_IJAVA_FRAME_ABI, but not below
 632     // i.e. !(Z_SP + frame::z_top_ijava_frame_abi_size - Interpreter::stackElementSize &gt; Resp).
 633     NearLabel OK;
 634     Register Rabi_bottom = Rtemp;
 635     add2reg(Rabi_bottom, frame::z_top_ijava_frame_abi_size - Interpreter::stackElementSize, Z_SP);
 636     compareU64_and_branch(Rabi_bottom, Resp, bcondNotHigh, OK);
 637     reentry = stop_chain_static(reentry, &quot;too many pushes: Z_esp points into TOP_IJAVA_FRAME_ABI&quot;);
 638     bind(OK);
 639   }
 640 }
 641 
 642 void InterpreterMacroAssembler::asm_assert_ijava_state_magic(Register tmp) {
 643   Label magic_ok;
 644   load_const_optimized(tmp, frame::z_istate_magic_number);
 645   z_cg(tmp, Address(Z_fp, _z_ijava_state_neg(magic)));
 646   z_bre(magic_ok);
 647   stop_static(&quot;error: wrong magic number in ijava_state access&quot;);
 648   bind(magic_ok);
 649 }
 650 #endif // ASSERT
 651 
 652 void InterpreterMacroAssembler::save_bcp() {
 653   z_stg(Z_bcp, Address(Z_fp, _z_ijava_state_neg(bcp)));
 654   asm_assert_ijava_state_magic(Z_bcp);
 655   NOT_PRODUCT(z_lg(Z_bcp, Address(Z_fp, _z_ijava_state_neg(bcp))));
 656 }
 657 
 658 void InterpreterMacroAssembler::restore_bcp() {
 659   asm_assert_ijava_state_magic(Z_bcp);
 660   z_lg(Z_bcp, Address(Z_fp, _z_ijava_state_neg(bcp)));
 661 }
 662 
 663 void InterpreterMacroAssembler::save_esp() {
 664   z_stg(Z_esp, Address(Z_fp, _z_ijava_state_neg(esp)));
 665 }
 666 
 667 void InterpreterMacroAssembler::restore_esp() {
 668   asm_assert_ijava_state_magic(Z_esp);
 669   z_lg(Z_esp, Address(Z_fp, _z_ijava_state_neg(esp)));
 670 }
 671 
 672 void InterpreterMacroAssembler::get_monitors(Register reg) {
 673   asm_assert_ijava_state_magic(reg);
 674   mem2reg_opt(reg, Address(Z_fp, _z_ijava_state_neg(monitors)));
 675 }
 676 
 677 void InterpreterMacroAssembler::save_monitors(Register reg) {
 678   reg2mem_opt(reg, Address(Z_fp, _z_ijava_state_neg(monitors)));
 679 }
 680 
 681 void InterpreterMacroAssembler::get_mdp(Register mdp) {
 682   z_lg(mdp, _z_ijava_state_neg(mdx), Z_fp);
 683 }
 684 
 685 void InterpreterMacroAssembler::save_mdp(Register mdp) {
 686   z_stg(mdp, _z_ijava_state_neg(mdx), Z_fp);
 687 }
 688 
 689 // Values that are only read (besides initialization).
 690 void InterpreterMacroAssembler::restore_locals() {
 691   asm_assert_ijava_state_magic(Z_locals);
 692   z_lg(Z_locals, Address(Z_fp, _z_ijava_state_neg(locals)));
 693 }
 694 
 695 void InterpreterMacroAssembler::get_method(Register reg) {
 696   asm_assert_ijava_state_magic(reg);
 697   z_lg(reg, Address(Z_fp, _z_ijava_state_neg(method)));
 698 }
 699 
 700 void InterpreterMacroAssembler::get_2_byte_integer_at_bcp(Register Rdst, int bcp_offset,
 701                                                           signedOrNot is_signed) {
 702   // Rdst is an 8-byte return value!!!
 703 
 704   // Unaligned loads incur only a small penalty on z/Architecture. The penalty
 705   // is a few (2..3) ticks, even when the load crosses a cache line
 706   // boundary. In case of a cache miss, the stall could, of course, be
 707   // much longer.
 708 
 709   switch (is_signed) {
 710     case Signed:
 711       z_lgh(Rdst, bcp_offset, Z_R0, Z_bcp);
 712      break;
 713    case Unsigned:
 714      z_llgh(Rdst, bcp_offset, Z_R0, Z_bcp);
 715      break;
 716    default:
 717      ShouldNotReachHere();
 718   }
 719 }
 720 
 721 
 722 void InterpreterMacroAssembler::get_4_byte_integer_at_bcp(Register Rdst, int bcp_offset,
 723                                                           setCCOrNot set_cc) {
 724   // Rdst is an 8-byte return value!!!
 725 
 726   // Unaligned loads incur only a small penalty on z/Architecture. The penalty
 727   // is a few (2..3) ticks, even when the load crosses a cache line
 728   // boundary. In case of a cache miss, the stall could, of course, be
 729   // much longer.
 730 
 731   // Both variants implement a sign-extending int2long load.
 732   if (set_cc == set_CC) {
 733     load_and_test_int2long(Rdst, Address(Z_bcp, (intptr_t)bcp_offset));
 734   } else {
 735     mem2reg_signed_opt(    Rdst, Address(Z_bcp, (intptr_t)bcp_offset));
 736   }
 737 }
 738 
 739 void InterpreterMacroAssembler::get_constant_pool(Register Rdst) {
 740   get_method(Rdst);
 741   mem2reg_opt(Rdst, Address(Rdst, Method::const_offset()));
 742   mem2reg_opt(Rdst, Address(Rdst, ConstMethod::constants_offset()));
 743 }
 744 
 745 void InterpreterMacroAssembler::get_cpool_and_tags(Register Rcpool, Register Rtags) {
 746   get_constant_pool(Rcpool);
 747   mem2reg_opt(Rtags, Address(Rcpool, ConstantPool::tags_offset_in_bytes()));
 748 }
 749 
 750 // Unlock if synchronized method.
 751 //
 752 // Unlock the receiver if this is a synchronized method.
 753 // Unlock any Java monitors from syncronized blocks.
 754 //
 755 // If there are locked Java monitors
 756 //   If throw_monitor_exception
 757 //     throws IllegalMonitorStateException
 758 //   Else if install_monitor_exception
 759 //     installs IllegalMonitorStateException
 760 //   Else
 761 //     no error processing
 762 void InterpreterMacroAssembler::unlock_if_synchronized_method(TosState state,
 763                                                               bool throw_monitor_exception,
 764                                                               bool install_monitor_exception) {
 765   NearLabel unlocked, unlock, no_unlock;
 766 
 767   {
 768     Register R_method = Z_ARG2;
 769     Register R_do_not_unlock_if_synchronized = Z_ARG3;
 770 
 771     // Get the value of _do_not_unlock_if_synchronized into G1_scratch.
 772     const Address do_not_unlock_if_synchronized(Z_thread,
 773                                                 JavaThread::do_not_unlock_if_synchronized_offset());
 774     load_sized_value(R_do_not_unlock_if_synchronized, do_not_unlock_if_synchronized, 1, false /*unsigned*/);
 775     z_mvi(do_not_unlock_if_synchronized, false); // Reset the flag.
 776 
 777     // Check if synchronized method.
 778     get_method(R_method);
 779     verify_oop(Z_tos, state);
 780     push(state); // Save tos/result.
 781     testbit(method2_(R_method, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
 782     z_bfalse(unlocked);
 783 
 784     // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag
 785     // is set.
 786     compareU64_and_branch(R_do_not_unlock_if_synchronized, (intptr_t)0L, bcondNotEqual, no_unlock);
 787   }
 788 
 789   // unlock monitor
 790 
 791   // BasicObjectLock will be first in list, since this is a
 792   // synchronized method. However, need to check that the object has
 793   // not been unlocked by an explicit monitorexit bytecode.
 794   const Address monitor(Z_fp, -(frame::z_ijava_state_size + (int) sizeof(BasicObjectLock)));
 795   // We use Z_ARG2 so that if we go slow path it will be the correct
 796   // register for unlock_object to pass to VM directly.
 797   load_address(Z_ARG2, monitor); // Address of first monitor.
 798   z_lg(Z_ARG3, Address(Z_ARG2, BasicObjectLock::obj_offset_in_bytes()));
 799   compareU64_and_branch(Z_ARG3, (intptr_t)0L, bcondNotEqual, unlock);
 800 
 801   if (throw_monitor_exception) {
 802     // Entry already unlocked need to throw an exception.
 803     MacroAssembler::call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_illegal_monitor_state_exception));
 804     should_not_reach_here();
 805   } else {
 806     // Monitor already unlocked during a stack unroll.
 807     // If requested, install an illegal_monitor_state_exception.
 808     // Continue with stack unrolling.
 809     if (install_monitor_exception) {
 810       MacroAssembler::call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::new_illegal_monitor_state_exception));
 811     }
 812    z_bru(unlocked);
 813   }
 814 
 815   bind(unlock);
 816 
 817   unlock_object(Z_ARG2);
 818 
 819   bind(unlocked);
 820 
 821   // I0, I1: Might contain return value
 822 
 823   // Check that all monitors are unlocked.
 824   {
 825     NearLabel loop, exception, entry, restart;
 826     const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 827     // We use Z_ARG2 so that if we go slow path it will be the correct
 828     // register for unlock_object to pass to VM directly.
 829     Register R_current_monitor = Z_ARG2;
 830     Register R_monitor_block_bot = Z_ARG1;
 831     const Address monitor_block_top(Z_fp, _z_ijava_state_neg(monitors));
 832     const Address monitor_block_bot(Z_fp, -frame::z_ijava_state_size);
 833 
 834     bind(restart);
 835     // Starting with top-most entry.
 836     z_lg(R_current_monitor, monitor_block_top);
 837     // Points to word before bottom of monitor block.
 838     load_address(R_monitor_block_bot, monitor_block_bot);
 839     z_bru(entry);
 840 
 841     // Entry already locked, need to throw exception.
 842     bind(exception);
 843 
 844     if (throw_monitor_exception) {
 845       // Throw exception.
 846       MacroAssembler::call_VM(noreg,
 847                               CAST_FROM_FN_PTR(address, InterpreterRuntime::
 848                                                throw_illegal_monitor_state_exception));
 849       should_not_reach_here();
 850     } else {
 851       // Stack unrolling. Unlock object and install illegal_monitor_exception.
 852       // Unlock does not block, so don&#39;t have to worry about the frame.
 853       // We don&#39;t have to preserve c_rarg1 since we are going to throw an exception.
 854       unlock_object(R_current_monitor);
 855       if (install_monitor_exception) {
 856         call_VM(noreg, CAST_FROM_FN_PTR(address,
 857                                         InterpreterRuntime::
 858                                         new_illegal_monitor_state_exception));
 859       }
 860       z_bru(restart);
 861     }
 862 
 863     bind(loop);
 864     // Check if current entry is used.
 865     load_and_test_long(Z_R0_scratch, Address(R_current_monitor, BasicObjectLock::obj_offset_in_bytes()));
 866     z_brne(exception);
 867 
 868     add2reg(R_current_monitor, entry_size); // Otherwise advance to next entry.
 869     bind(entry);
 870     compareU64_and_branch(R_current_monitor, R_monitor_block_bot, bcondNotEqual, loop);
 871   }
 872 
 873   bind(no_unlock);
 874   pop(state);
 875   verify_oop(Z_tos, state);
 876 }
 877 
 878 void InterpreterMacroAssembler::narrow(Register result, Register ret_type) {
 879   get_method(ret_type);
 880   z_lg(ret_type, Address(ret_type, in_bytes(Method::const_offset())));
 881   z_lb(ret_type, Address(ret_type, in_bytes(ConstMethod::result_type_offset())));
 882 
 883   Label notBool, notByte, notChar, done;
 884 
 885   // common case first
 886   compareU32_and_branch(ret_type, T_INT, bcondEqual, done);
 887 
 888   compareU32_and_branch(ret_type, T_BOOLEAN, bcondNotEqual, notBool);
 889   z_nilf(result, 0x1);
 890   z_bru(done);
 891 
 892   bind(notBool);
 893   compareU32_and_branch(ret_type, T_BYTE, bcondNotEqual, notByte);
 894   z_lbr(result, result);
 895   z_bru(done);
 896 
 897   bind(notByte);
 898   compareU32_and_branch(ret_type, T_CHAR, bcondNotEqual, notChar);
 899   z_nilf(result, 0xffff);
 900   z_bru(done);
 901 
 902   bind(notChar);
 903   // compareU32_and_branch(ret_type, T_SHORT, bcondNotEqual, notShort);
 904   z_lhr(result, result);
 905 
 906   // Nothing to do for T_INT
 907   bind(done);
 908 }
 909 
 910 // remove activation
 911 //
 912 // Unlock the receiver if this is a synchronized method.
 913 // Unlock any Java monitors from syncronized blocks.
 914 // Remove the activation from the stack.
 915 //
 916 // If there are locked Java monitors
 917 //   If throw_monitor_exception
 918 //     throws IllegalMonitorStateException
 919 //   Else if install_monitor_exception
 920 //     installs IllegalMonitorStateException
 921 //   Else
 922 //     no error processing
 923 void InterpreterMacroAssembler::remove_activation(TosState state,
 924                                                   Register return_pc,
 925                                                   bool throw_monitor_exception,
 926                                                   bool install_monitor_exception,
 927                                                   bool notify_jvmti) {
 928   BLOCK_COMMENT(&quot;remove_activation {&quot;);
 929   unlock_if_synchronized_method(state, throw_monitor_exception, install_monitor_exception);
 930 
 931   // Save result (push state before jvmti call and pop it afterwards) and notify jvmti.
 932   notify_method_exit(false, state, notify_jvmti ? NotifyJVMTI : SkipNotifyJVMTI);
 933 
 934   if (StackReservedPages &gt; 0) {
 935     BLOCK_COMMENT(&quot;reserved_stack_check:&quot;);
 936     // Test if reserved zone needs to be enabled.
 937     Label no_reserved_zone_enabling;
 938 
 939     // Compare frame pointers. There is no good stack pointer, as with stack
 940     // frame compression we can get different SPs when we do calls. A subsequent
 941     // call could have a smaller SP, so that this compare succeeds for an
 942     // inner call of the method annotated with ReservedStack.
 943     z_lg(Z_R0, Address(Z_SP, (intptr_t)_z_abi(callers_sp)));
 944     z_clg(Z_R0, Address(Z_thread, JavaThread::reserved_stack_activation_offset())); // Compare with frame pointer in memory.
 945     z_brl(no_reserved_zone_enabling);
 946 
 947     // Enable reserved zone again, throw stack overflow exception.
 948     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), Z_thread);
 949     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_delayed_StackOverflowError));
 950 
 951     should_not_reach_here();
 952 
 953     bind(no_reserved_zone_enabling);
 954   }
 955 
 956   verify_oop(Z_tos, state);
 957   verify_thread();
 958 
 959   pop_interpreter_frame(return_pc, Z_ARG2, Z_ARG3);
 960   BLOCK_COMMENT(&quot;} remove_activation&quot;);
 961 }
 962 
 963 // lock object
 964 //
 965 // Registers alive
 966 //   monitor - Address of the BasicObjectLock to be used for locking,
 967 //             which must be initialized with the object to lock.
 968 //   object  - Address of the object to be locked.
 969 void InterpreterMacroAssembler::lock_object(Register monitor, Register object) {
 970 
 971   if (UseHeavyMonitors) {
 972     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
 973             monitor, /*check_for_exceptions=*/false);
 974     return;
 975   }
 976 
 977   // template code:
 978   //
 979   // markWord displaced_header = obj-&gt;mark().set_unlocked();
 980   // monitor-&gt;lock()-&gt;set_displaced_header(displaced_header);
 981   // if (Atomic::cmpxchg(/*addr*/obj-&gt;mark_addr(), /*cmp*/displaced_header, /*ex=*/monitor) == displaced_header) {
 982   //   // We stored the monitor address into the object&#39;s mark word.
 983   // } else if (THREAD-&gt;is_lock_owned((address)displaced_header))
 984   //   // Simple recursive case.
 985   //   monitor-&gt;lock()-&gt;set_displaced_header(NULL);
 986   // } else {
 987   //   // Slow path.
 988   //   InterpreterRuntime::monitorenter(THREAD, monitor);
 989   // }
 990 
 991   const Register displaced_header = Z_ARG5;
 992   const Register object_mark_addr = Z_ARG4;
 993   const Register current_header   = Z_ARG5;
 994 
 995   NearLabel done;
 996   NearLabel slow_case;
 997 
 998   // markWord displaced_header = obj-&gt;mark().set_unlocked();
 999 
1000   // Load markWord from object into displaced_header.
1001   z_lg(displaced_header, oopDesc::mark_offset_in_bytes(), object);
1002 
1003   if (UseBiasedLocking) {
1004     biased_locking_enter(object, displaced_header, Z_R1, Z_R0, done, &amp;slow_case);
1005   }
1006 
1007   // Set displaced_header to be (markWord of object | UNLOCK_VALUE).
1008   z_oill(displaced_header, markWord::unlocked_value);
1009 
1010   // monitor-&gt;lock()-&gt;set_displaced_header(displaced_header);
1011 
1012   // Initialize the box (Must happen before we update the object mark!).
1013   z_stg(displaced_header, BasicObjectLock::lock_offset_in_bytes() +
1014                           BasicLock::displaced_header_offset_in_bytes(), monitor);
1015 
1016   // if (Atomic::cmpxchg(/*addr*/obj-&gt;mark_addr(), /*cmp*/displaced_header, /*ex=*/monitor) == displaced_header) {
1017 
1018   // Store stack address of the BasicObjectLock (this is monitor) into object.
1019   add2reg(object_mark_addr, oopDesc::mark_offset_in_bytes(), object);
1020 
1021   z_csg(displaced_header, monitor, 0, object_mark_addr);
1022   assert(current_header==displaced_header, &quot;must be same register&quot;); // Identified two registers from z/Architecture.
1023 
1024   z_bre(done);
1025 
1026   // } else if (THREAD-&gt;is_lock_owned((address)displaced_header))
1027   //   // Simple recursive case.
1028   //   monitor-&gt;lock()-&gt;set_displaced_header(NULL);
1029 
1030   // We did not see an unlocked object so try the fast recursive case.
1031 
1032   // Check if owner is self by comparing the value in the markWord of object
1033   // (current_header) with the stack pointer.
1034   z_sgr(current_header, Z_SP);
1035 
1036   assert(os::vm_page_size() &gt; 0xfff, &quot;page size too small - change the constant&quot;);
1037 
1038   // The prior sequence &quot;LGR, NGR, LTGR&quot; can be done better
1039   // (Z_R1 is temp and not used after here).
1040   load_const_optimized(Z_R0, (~(os::vm_page_size()-1) | markWord::lock_mask_in_place));
1041   z_ngr(Z_R0, current_header); // AND sets CC (result eq/ne 0)
1042 
1043   // If condition is true we are done and hence we can store 0 in the displaced
1044   // header indicating it is a recursive lock and be done.
1045   z_brne(slow_case);
1046   z_release();  // Membar unnecessary on zarch AND because the above csg does a sync before and after.
1047   z_stg(Z_R0/*==0!*/, BasicObjectLock::lock_offset_in_bytes() +
1048                       BasicLock::displaced_header_offset_in_bytes(), monitor);
1049   z_bru(done);
1050 
1051   // } else {
1052   //   // Slow path.
1053   //   InterpreterRuntime::monitorenter(THREAD, monitor);
1054 
1055   // None of the above fast optimizations worked so we have to get into the
1056   // slow case of monitor enter.
1057   bind(slow_case);
1058 
1059   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1060           monitor, /*check_for_exceptions=*/false);
1061 
1062   // }
1063 
1064   bind(done);
1065 }
1066 
1067 // Unlocks an object. Used in monitorexit bytecode and remove_activation.
1068 //
1069 // Registers alive
1070 //   monitor - address of the BasicObjectLock to be used for locking,
1071 //             which must be initialized with the object to lock.
1072 //
1073 // Throw IllegalMonitorException if object is not locked by current thread.
1074 void InterpreterMacroAssembler::unlock_object(Register monitor, Register object) {
1075 
1076   if (UseHeavyMonitors) {
1077     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit), monitor);
1078     return;
1079   }
1080 
1081 // else {
1082   // template code:
1083   //
1084   // if ((displaced_header = monitor-&gt;displaced_header()) == NULL) {
1085   //   // Recursive unlock. Mark the monitor unlocked by setting the object field to NULL.
1086   //   monitor-&gt;set_obj(NULL);
1087   // } else if (Atomic::cmpxchg(obj-&gt;mark_addr(), monitor, displaced_header) == monitor) {
1088   //   // We swapped the unlocked mark in displaced_header into the object&#39;s mark word.
1089   //   monitor-&gt;set_obj(NULL);
1090   // } else {
1091   //   // Slow path.
1092   //   InterpreterRuntime::monitorexit(THREAD, monitor);
1093   // }
1094 
1095   const Register displaced_header = Z_ARG4;
1096   const Register current_header   = Z_R1;
1097   Address obj_entry(monitor, BasicObjectLock::obj_offset_in_bytes());
1098   Label done;
1099 
1100   if (object == noreg) {
1101     // In the template interpreter, we must assure that the object
1102     // entry in the monitor is cleared on all paths. Thus we move
1103     // loading up to here, and clear the entry afterwards.
1104     object = Z_ARG3; // Use Z_ARG3 if caller didn&#39;t pass object.
1105     z_lg(object, obj_entry);
1106   }
1107 
1108   assert_different_registers(monitor, object, displaced_header, current_header);
1109 
1110   // if ((displaced_header = monitor-&gt;displaced_header()) == NULL) {
1111   //   // Recursive unlock. Mark the monitor unlocked by setting the object field to NULL.
1112   //   monitor-&gt;set_obj(NULL);
1113 
1114   clear_mem(obj_entry, sizeof(oop));
1115 
1116   if (UseBiasedLocking) {
1117     // The object address from the monitor is in object.
1118     assert(oopDesc::mark_offset_in_bytes() == 0, &quot;offset of _mark is not 0&quot;);
1119     biased_locking_exit(object, displaced_header, done);
1120   }
1121 
1122   // Test first if we are in the fast recursive case.
1123   MacroAssembler::load_and_test_long(displaced_header,
1124                                      Address(monitor, BasicObjectLock::lock_offset_in_bytes() +
1125                                                       BasicLock::displaced_header_offset_in_bytes()));
1126   z_bre(done); // displaced_header == 0 -&gt; goto done
1127 
1128   // } else if (Atomic::cmpxchg(obj-&gt;mark_addr(), monitor, displaced_header) == monitor) {
1129   //   // We swapped the unlocked mark in displaced_header into the object&#39;s mark word.
1130   //   monitor-&gt;set_obj(NULL);
1131 
1132   // If we still have a lightweight lock, unlock the object and be done.
1133 
1134   // The markword is expected to be at offset 0.
1135   assert(oopDesc::mark_offset_in_bytes() == 0, &quot;unlock_object: review code below&quot;);
1136 
1137   // We have the displaced header in displaced_header. If the lock is still
1138   // lightweight, it will contain the monitor address and we&#39;ll store the
1139   // displaced header back into the object&#39;s mark word.
1140   z_lgr(current_header, monitor);
1141   z_csg(current_header, displaced_header, 0, object);
1142   z_bre(done);
1143 
1144   // } else {
1145   //   // Slow path.
1146   //   InterpreterRuntime::monitorexit(THREAD, monitor);
1147 
1148   // The lock has been converted into a heavy lock and hence
1149   // we need to get into the slow case.
1150   z_stg(object, obj_entry);   // Restore object entry, has been cleared above.
1151   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit), monitor);
1152 
1153   // }
1154 
1155   bind(done);
1156 }
1157 
1158 void InterpreterMacroAssembler::test_method_data_pointer(Register mdp, Label&amp; zero_continue) {
1159   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1160   load_and_test_long(mdp, Address(Z_fp, _z_ijava_state_neg(mdx)));
1161   z_brz(zero_continue);
1162 }
1163 
1164 // Set the method data pointer for the current bcp.
1165 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1166   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1167   Label    set_mdp;
1168   Register mdp    = Z_ARG4;
1169   Register method = Z_ARG5;
1170 
1171   get_method(method);
1172   // Test MDO to avoid the call if it is NULL.
1173   load_and_test_long(mdp, method2_(method, method_data));
1174   z_brz(set_mdp);
1175 
1176   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), method, Z_bcp);
1177   // Z_RET: mdi
1178   // Mdo is guaranteed to be non-zero here, we checked for it before the call.
1179   assert(method-&gt;is_nonvolatile(), &quot;choose nonvolatile reg or reload from frame&quot;);
1180   z_lg(mdp, method2_(method, method_data)); // Must reload, mdp is volatile reg.
1181   add2reg_with_index(mdp, in_bytes(MethodData::data_offset()), Z_RET, mdp);
1182 
1183   bind(set_mdp);
1184   save_mdp(mdp);
1185 }
1186 
1187 void InterpreterMacroAssembler::verify_method_data_pointer() {
1188   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1189 #ifdef ASSERT
1190   NearLabel verify_continue;
1191   Register bcp_expected = Z_ARG3;
1192   Register mdp    = Z_ARG4;
1193   Register method = Z_ARG5;
1194 
1195   test_method_data_pointer(mdp, verify_continue); // If mdp is zero, continue
1196   get_method(method);
1197 
1198   // If the mdp is valid, it will point to a DataLayout header which is
1199   // consistent with the bcp. The converse is highly probable also.
1200   load_sized_value(bcp_expected, Address(mdp, DataLayout::bci_offset()), 2, false /*signed*/);
1201   z_ag(bcp_expected, Address(method, Method::const_offset()));
1202   load_address(bcp_expected, Address(bcp_expected, ConstMethod::codes_offset()));
1203   compareU64_and_branch(bcp_expected, Z_bcp, bcondEqual, verify_continue);
1204   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp), method, Z_bcp, mdp);
1205   bind(verify_continue);
1206 #endif // ASSERT
1207 }
1208 
1209 void InterpreterMacroAssembler::set_mdp_data_at(Register mdp_in, int constant, Register value) {
1210   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1211   z_stg(value, constant, mdp_in);
1212 }
1213 
1214 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1215                                                       int constant,
1216                                                       Register tmp,
1217                                                       bool decrement) {
1218   assert_different_registers(mdp_in, tmp);
1219   // counter address
1220   Address data(mdp_in, constant);
1221   const int delta = decrement ? -DataLayout::counter_increment : DataLayout::counter_increment;
1222   add2mem_64(Address(mdp_in, constant), delta, tmp);
1223 }
1224 
1225 void InterpreterMacroAssembler::set_mdp_flag_at(Register mdp_in,
1226                                                 int flag_byte_constant) {
1227   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1228   // Set the flag.
1229   z_oi(Address(mdp_in, DataLayout::flags_offset()), flag_byte_constant);
1230 }
1231 
1232 void InterpreterMacroAssembler::test_mdp_data_at(Register mdp_in,
1233                                                  int offset,
1234                                                  Register value,
1235                                                  Register test_value_out,
1236                                                  Label&amp; not_equal_continue) {
1237   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1238   if (test_value_out == noreg) {
1239     z_cg(value, Address(mdp_in, offset));
1240     z_brne(not_equal_continue);
1241   } else {
1242     // Put the test value into a register, so caller can use it:
1243     z_lg(test_value_out, Address(mdp_in, offset));
1244     compareU64_and_branch(test_value_out, value, bcondNotEqual, not_equal_continue);
1245   }
1246 }
1247 
1248 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in, int offset_of_disp) {
1249   update_mdp_by_offset(mdp_in, noreg, offset_of_disp);
1250 }
1251 
1252 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1253                                                      Register dataidx,
1254                                                      int offset_of_disp) {
1255   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1256   Address disp_address(mdp_in, dataidx, offset_of_disp);
1257   Assembler::z_ag(mdp_in, disp_address);
1258   save_mdp(mdp_in);
1259 }
1260 
1261 void InterpreterMacroAssembler::update_mdp_by_constant(Register mdp_in, int constant) {
1262   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1263   add2reg(mdp_in, constant);
1264   save_mdp(mdp_in);
1265 }
1266 
1267 void InterpreterMacroAssembler::update_mdp_for_ret(Register return_bci) {
1268   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1269   assert(return_bci-&gt;is_nonvolatile(), &quot;choose nonvolatile reg or save/restore&quot;);
1270   call_VM(noreg,
1271           CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret),
1272           return_bci);
1273 }
1274 
1275 void InterpreterMacroAssembler::profile_taken_branch(Register mdp, Register bumped_count) {
1276   if (ProfileInterpreter) {
1277     Label profile_continue;
1278 
1279     // If no method data exists, go to profile_continue.
1280     // Otherwise, assign to mdp.
1281     test_method_data_pointer(mdp, profile_continue);
1282 
1283     // We are taking a branch. Increment the taken count.
1284     // We inline increment_mdp_data_at to return bumped_count in a register
1285     //increment_mdp_data_at(mdp, in_bytes(JumpData::taken_offset()));
1286     Address data(mdp, JumpData::taken_offset());
1287     z_lg(bumped_count, data);
1288     // 64-bit overflow is very unlikely. Saturation to 32-bit values is
1289     // performed when reading the counts.
1290     add2reg(bumped_count, DataLayout::counter_increment);
1291     z_stg(bumped_count, data); // Store back out
1292 
1293     // The method data pointer needs to be updated to reflect the new target.
1294     update_mdp_by_offset(mdp, in_bytes(JumpData::displacement_offset()));
1295     bind(profile_continue);
1296   }
1297 }
1298 
1299 // Kills Z_R1_scratch.
1300 void InterpreterMacroAssembler::profile_not_taken_branch(Register mdp) {
1301   if (ProfileInterpreter) {
1302     Label profile_continue;
1303 
1304     // If no method data exists, go to profile_continue.
1305     test_method_data_pointer(mdp, profile_continue);
1306 
1307     // We are taking a branch. Increment the not taken count.
1308     increment_mdp_data_at(mdp, in_bytes(BranchData::not_taken_offset()), Z_R1_scratch);
1309 
1310     // The method data pointer needs to be updated to correspond to
1311     // the next bytecode.
1312     update_mdp_by_constant(mdp, in_bytes(BranchData::branch_data_size()));
1313     bind(profile_continue);
1314   }
1315 }
1316 
1317 // Kills: Z_R1_scratch.
1318 void InterpreterMacroAssembler::profile_call(Register mdp) {
1319   if (ProfileInterpreter) {
1320     Label profile_continue;
1321 
1322     // If no method data exists, go to profile_continue.
1323     test_method_data_pointer(mdp, profile_continue);
1324 
1325     // We are making a call. Increment the count.
1326     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1327 
1328     // The method data pointer needs to be updated to reflect the new target.
1329     update_mdp_by_constant(mdp, in_bytes(CounterData::counter_data_size()));
1330     bind(profile_continue);
1331   }
1332 }
1333 
1334 void InterpreterMacroAssembler::profile_final_call(Register mdp) {
1335   if (ProfileInterpreter) {
1336     Label profile_continue;
1337 
1338     // If no method data exists, go to profile_continue.
1339     test_method_data_pointer(mdp, profile_continue);
1340 
1341     // We are making a call. Increment the count.
1342     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1343 
1344     // The method data pointer needs to be updated to reflect the new target.
1345     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1346     bind(profile_continue);
1347   }
1348 }
1349 
1350 void InterpreterMacroAssembler::profile_virtual_call(Register receiver,
1351                                                      Register mdp,
1352                                                      Register reg2,
1353                                                      bool receiver_can_be_null) {
1354   if (ProfileInterpreter) {
1355     NearLabel profile_continue;
1356 
1357     // If no method data exists, go to profile_continue.
1358     test_method_data_pointer(mdp, profile_continue);
1359 
1360     NearLabel skip_receiver_profile;
1361     if (receiver_can_be_null) {
1362       NearLabel not_null;
1363       compareU64_and_branch(receiver, (intptr_t)0L, bcondNotEqual, not_null);
1364       // We are making a call. Increment the count for null receiver.
1365       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1366       z_bru(skip_receiver_profile);
1367       bind(not_null);
1368     }
1369 
1370     // Record the receiver type.
1371     record_klass_in_profile(receiver, mdp, reg2, true);
1372     bind(skip_receiver_profile);
1373 
1374     // The method data pointer needs to be updated to reflect the new target.
1375     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1376     bind(profile_continue);
1377   }
1378 }
1379 
1380 // This routine creates a state machine for updating the multi-row
1381 // type profile at a virtual call site (or other type-sensitive bytecode).
1382 // The machine visits each row (of receiver/count) until the receiver type
1383 // is found, or until it runs out of rows. At the same time, it remembers
1384 // the location of the first empty row. (An empty row records null for its
1385 // receiver, and can be allocated for a newly-observed receiver type.)
1386 // Because there are two degrees of freedom in the state, a simple linear
1387 // search will not work; it must be a decision tree. Hence this helper
1388 // function is recursive, to generate the required tree structured code.
1389 // It&#39;s the interpreter, so we are trading off code space for speed.
1390 // See below for example code.
1391 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1392                                         Register receiver, Register mdp,
1393                                         Register reg2, int start_row,
1394                                         Label&amp; done, bool is_virtual_call) {
1395   if (TypeProfileWidth == 0) {
1396     if (is_virtual_call) {
1397       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1398     }
1399     return;
1400   }
1401 
1402   int last_row = VirtualCallData::row_limit() - 1;
1403   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1404   // Test this row for both the receiver and for null.
1405   // Take any of three different outcomes:
1406   //   1. found receiver =&gt; increment count and goto done
1407   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1408   //   3. found something else =&gt; keep looking for cases 1 and 2
1409   // Case 3 is handled by a recursive call.
1410   for (int row = start_row; row &lt;= last_row; row++) {
1411     NearLabel next_test;
1412     bool test_for_null_also = (row == start_row);
1413 
1414     // See if the receiver is receiver[n].
1415     int recvr_offset = in_bytes(VirtualCallData::receiver_offset(row));
1416     test_mdp_data_at(mdp, recvr_offset, receiver,
1417                      (test_for_null_also ? reg2 : noreg),
1418                      next_test);
1419     // (Reg2 now contains the receiver from the CallData.)
1420 
1421     // The receiver is receiver[n]. Increment count[n].
1422     int count_offset = in_bytes(VirtualCallData::receiver_count_offset(row));
1423     increment_mdp_data_at(mdp, count_offset);
1424     z_bru(done);
1425     bind(next_test);
1426 
1427     if (test_for_null_also) {
1428       Label found_null;
1429       // Failed the equality check on receiver[n]... Test for null.
1430       z_ltgr(reg2, reg2);
1431       if (start_row == last_row) {
1432         // The only thing left to do is handle the null case.
1433         if (is_virtual_call) {
1434           z_brz(found_null);
1435           // Receiver did not match any saved receiver and there is no empty row for it.
1436           // Increment total counter to indicate polymorphic case.
1437           increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1438           z_bru(done);
1439           bind(found_null);
1440         } else {
1441           z_brnz(done);
1442         }
1443         break;
1444       }
1445       // Since null is rare, make it be the branch-taken case.
1446       z_brz(found_null);
1447 
1448       // Put all the &quot;Case 3&quot; tests here.
1449       record_klass_in_profile_helper(receiver, mdp, reg2, start_row + 1, done, is_virtual_call);
1450 
1451       // Found a null. Keep searching for a matching receiver,
1452       // but remember that this is an empty (unused) slot.
1453       bind(found_null);
1454     }
1455   }
1456 
1457   // In the fall-through case, we found no matching receiver, but we
1458   // observed the receiver[start_row] is NULL.
1459 
1460   // Fill in the receiver field and increment the count.
1461   int recvr_offset = in_bytes(VirtualCallData::receiver_offset(start_row));
1462   set_mdp_data_at(mdp, recvr_offset, receiver);
1463   int count_offset = in_bytes(VirtualCallData::receiver_count_offset(start_row));
1464   load_const_optimized(reg2, DataLayout::counter_increment);
1465   set_mdp_data_at(mdp, count_offset, reg2);
1466   if (start_row &gt; 0) {
1467     z_bru(done);
1468   }
1469 }
1470 
1471 // Example state machine code for three profile rows:
1472 //   // main copy of decision tree, rooted at row[1]
1473 //   if (row[0].rec == rec) { row[0].incr(); goto done; }
1474 //   if (row[0].rec != NULL) {
1475 //     // inner copy of decision tree, rooted at row[1]
1476 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1477 //     if (row[1].rec != NULL) {
1478 //       // degenerate decision tree, rooted at row[2]
1479 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1480 //       if (row[2].rec != NULL) { count.incr(); goto done; } // overflow
1481 //       row[2].init(rec); goto done;
1482 //     } else {
1483 //       // remember row[1] is empty
1484 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1485 //       row[1].init(rec); goto done;
1486 //     }
1487 //   } else {
1488 //     // remember row[0] is empty
1489 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1490 //     if (row[2].rec == rec) { row[2].incr(); goto done; }
1491 //     row[0].init(rec); goto done;
1492 //   }
1493 //   done:
1494 
1495 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1496                                                         Register mdp, Register reg2,
1497                                                         bool is_virtual_call) {
1498   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1499   Label done;
1500 
1501   record_klass_in_profile_helper(receiver, mdp, reg2, 0, done, is_virtual_call);
1502 
1503   bind (done);
1504 }
1505 
1506 void InterpreterMacroAssembler::profile_ret(Register return_bci, Register mdp) {
1507   if (ProfileInterpreter) {
1508     NearLabel profile_continue;
1509     uint row;
1510 
1511     // If no method data exists, go to profile_continue.
1512     test_method_data_pointer(mdp, profile_continue);
1513 
1514     // Update the total ret count.
1515     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1516 
1517     for (row = 0; row &lt; RetData::row_limit(); row++) {
1518       NearLabel next_test;
1519 
1520       // See if return_bci is equal to bci[n]:
1521       test_mdp_data_at(mdp,
1522                        in_bytes(RetData::bci_offset(row)),
1523                        return_bci, noreg,
1524                        next_test);
1525 
1526       // Return_bci is equal to bci[n]. Increment the count.
1527       increment_mdp_data_at(mdp, in_bytes(RetData::bci_count_offset(row)));
1528 
1529       // The method data pointer needs to be updated to reflect the new target.
1530       update_mdp_by_offset(mdp, in_bytes(RetData::bci_displacement_offset(row)));
1531       z_bru(profile_continue);
1532       bind(next_test);
1533     }
1534 
1535     update_mdp_for_ret(return_bci);
1536 
1537     bind(profile_continue);
1538   }
1539 }
1540 
1541 void InterpreterMacroAssembler::profile_null_seen(Register mdp) {
1542   if (ProfileInterpreter) {
1543     Label profile_continue;
1544 
1545     // If no method data exists, go to profile_continue.
1546     test_method_data_pointer(mdp, profile_continue);
1547 
1548     set_mdp_flag_at(mdp, BitData::null_seen_byte_constant());
1549 
1550     // The method data pointer needs to be updated.
1551     int mdp_delta = in_bytes(BitData::bit_data_size());
1552     if (TypeProfileCasts) {
1553       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1554     }
1555     update_mdp_by_constant(mdp, mdp_delta);
1556 
1557     bind(profile_continue);
1558   }
1559 }
1560 
1561 void InterpreterMacroAssembler::profile_typecheck_failed(Register mdp, Register tmp) {
1562   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1563     Label profile_continue;
1564 
1565     // If no method data exists, go to profile_continue.
1566     test_method_data_pointer(mdp, profile_continue);
1567 
1568     int count_offset = in_bytes(CounterData::count_offset());
1569     // Back up the address, since we have already bumped the mdp.
1570     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1571 
1572     // *Decrement* the counter. We expect to see zero or small negatives.
1573     increment_mdp_data_at(mdp, count_offset, tmp, true);
1574 
1575     bind (profile_continue);
1576   }
1577 }
1578 
1579 void InterpreterMacroAssembler::profile_typecheck(Register mdp, Register klass, Register reg2) {
1580   if (ProfileInterpreter) {
1581     Label profile_continue;
1582 
1583     // If no method data exists, go to profile_continue.
1584     test_method_data_pointer(mdp, profile_continue);
1585 
1586     // The method data pointer needs to be updated.
1587     int mdp_delta = in_bytes(BitData::bit_data_size());
1588     if (TypeProfileCasts) {
1589       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1590 
1591       // Record the object type.
1592       record_klass_in_profile(klass, mdp, reg2, false);
1593     }
1594     update_mdp_by_constant(mdp, mdp_delta);
1595 
1596     bind(profile_continue);
1597   }
1598 }
1599 
1600 void InterpreterMacroAssembler::profile_switch_default(Register mdp) {
1601   if (ProfileInterpreter) {
1602     Label profile_continue;
1603 
1604     // If no method data exists, go to profile_continue.
1605     test_method_data_pointer(mdp, profile_continue);
1606 
1607     // Update the default case count.
1608     increment_mdp_data_at(mdp, in_bytes(MultiBranchData::default_count_offset()));
1609 
1610     // The method data pointer needs to be updated.
1611     update_mdp_by_offset(mdp, in_bytes(MultiBranchData::default_displacement_offset()));
1612 
1613     bind(profile_continue);
1614   }
1615 }
1616 
1617 // Kills: index, scratch1, scratch2.
1618 void InterpreterMacroAssembler::profile_switch_case(Register index,
1619                                                     Register mdp,
1620                                                     Register scratch1,
1621                                                     Register scratch2) {
1622   if (ProfileInterpreter) {
1623     Label profile_continue;
1624     assert_different_registers(index, mdp, scratch1, scratch2);
1625 
1626     // If no method data exists, go to profile_continue.
1627     test_method_data_pointer(mdp, profile_continue);
1628 
1629     // Build the base (index * per_case_size_in_bytes()) +
1630     // case_array_offset_in_bytes().
1631     z_sllg(index, index, exact_log2(in_bytes(MultiBranchData::per_case_size())));
1632     add2reg(index, in_bytes(MultiBranchData::case_array_offset()));
1633 
1634     // Add the calculated base to the mdp -&gt; address of the case&#39; data.
1635     Address case_data_addr(mdp, index);
1636     Register case_data = scratch1;
1637     load_address(case_data, case_data_addr);
1638 
1639     // Update the case count.
1640     increment_mdp_data_at(case_data,
1641                           in_bytes(MultiBranchData::relative_count_offset()),
1642                           scratch2);
1643 
1644     // The method data pointer needs to be updated.
1645     update_mdp_by_offset(mdp,
1646                          index,
1647                          in_bytes(MultiBranchData::relative_displacement_offset()));
1648 
1649     bind(profile_continue);
1650   }
1651 }
1652 
1653 // kills: R0, R1, flags, loads klass from obj (if not null)
1654 void InterpreterMacroAssembler::profile_obj_type(Register obj, Address mdo_addr, Register klass, bool cmp_done) {
1655   NearLabel null_seen, init_klass, do_nothing, do_update;
1656 
1657   // Klass = obj is allowed.
1658   const Register tmp = Z_R1;
1659   assert_different_registers(obj, mdo_addr.base(), tmp, Z_R0);
1660   assert_different_registers(klass, mdo_addr.base(), tmp, Z_R0);
1661 
1662   z_lg(tmp, mdo_addr);
1663   if (cmp_done) {
1664     z_brz(null_seen);
1665   } else {
1666     compareU64_and_branch(obj, (intptr_t)0, Assembler::bcondEqual, null_seen);
1667   }
1668 
1669   MacroAssembler::verify_oop(obj, FILE_AND_LINE);
1670   load_klass(klass, obj);
1671 
1672   // Klass seen before, nothing to do (regardless of unknown bit).
1673   z_lgr(Z_R0, tmp);
1674   assert(Immediate::is_uimm(~TypeEntries::type_klass_mask, 16), &quot;or change following instruction&quot;);
1675   z_nill(Z_R0, TypeEntries::type_klass_mask &amp; 0xFFFF);
1676   compareU64_and_branch(Z_R0, klass, Assembler::bcondEqual, do_nothing);
1677 
1678   // Already unknown. Nothing to do anymore.
1679   z_tmll(tmp, TypeEntries::type_unknown);
1680   z_brc(Assembler::bcondAllOne, do_nothing);
1681 
1682   z_lgr(Z_R0, tmp);
1683   assert(Immediate::is_uimm(~TypeEntries::type_mask, 16), &quot;or change following instruction&quot;);
1684   z_nill(Z_R0, TypeEntries::type_mask &amp; 0xFFFF);
1685   compareU64_and_branch(Z_R0, (intptr_t)0, Assembler::bcondEqual, init_klass);
1686 
1687   // Different than before. Cannot keep accurate profile.
1688   z_oill(tmp, TypeEntries::type_unknown);
1689   z_bru(do_update);
1690 
1691   bind(init_klass);
1692   // Combine klass and null_seen bit (only used if (tmp &amp; type_mask)==0).
1693   z_ogr(tmp, klass);
1694   z_bru(do_update);
1695 
1696   bind(null_seen);
1697   // Set null_seen if obj is 0.
1698   z_oill(tmp, TypeEntries::null_seen);
1699   // fallthru: z_bru(do_update);
1700 
1701   bind(do_update);
1702   z_stg(tmp, mdo_addr);
1703 
1704   bind(do_nothing);
1705 }
1706 
1707 void InterpreterMacroAssembler::profile_arguments_type(Register mdp, Register callee, Register tmp, bool is_virtual) {
1708   if (!ProfileInterpreter) {
1709     return;
1710   }
1711 
1712   assert_different_registers(mdp, callee, tmp);
1713 
1714   if (MethodData::profile_arguments() || MethodData::profile_return()) {
1715     Label profile_continue;
1716 
1717     test_method_data_pointer(mdp, profile_continue);
1718 
1719     int off_to_start = is_virtual ? in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
1720 
1721     z_cliy(in_bytes(DataLayout::tag_offset()) - off_to_start, mdp,
1722            is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag);
1723     z_brne(profile_continue);
1724 
1725     if (MethodData::profile_arguments()) {
1726       NearLabel done;
1727       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
1728       add2reg(mdp, off_to_args);
1729 
1730       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
1731         if (i &gt; 0 || MethodData::profile_return()) {
1732           // If return value type is profiled we may have no argument to profile.
1733           z_lg(tmp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args, mdp);
1734           add2reg(tmp, -i*TypeStackSlotEntries::per_arg_count());
1735           compare64_and_branch(tmp, TypeStackSlotEntries::per_arg_count(), Assembler::bcondLow, done);
1736         }
1737         z_lg(tmp, Address(callee, Method::const_offset()));
1738         z_lgh(tmp, Address(tmp, ConstMethod::size_of_parameters_offset()));
1739         // Stack offset o (zero based) from the start of the argument
1740         // list. For n arguments translates into offset n - o - 1 from
1741         // the end of the argument list. But there is an extra slot at
1742         // the top of the stack. So the offset is n - o from Lesp.
1743         z_sg(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))-off_to_args));
1744         z_sllg(tmp, tmp, Interpreter::logStackElementSize);
1745         Address stack_slot_addr(tmp, Z_esp);
1746         z_ltg(tmp, stack_slot_addr);
1747 
1748         Address mdo_arg_addr(mdp, in_bytes(TypeEntriesAtCall::argument_type_offset(i))-off_to_args);
1749         profile_obj_type(tmp, mdo_arg_addr, tmp, /*ltg did compare to 0*/ true);
1750 
1751         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
1752         add2reg(mdp, to_add);
1753         off_to_args += to_add;
1754       }
1755 
1756       if (MethodData::profile_return()) {
1757         z_lg(tmp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args, mdp);
1758         add2reg(tmp, -TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count());
1759       }
1760 
1761       bind(done);
1762 
1763       if (MethodData::profile_return()) {
1764         // We&#39;re right after the type profile for the last
1765         // argument. Tmp is the number of cells left in the
1766         // CallTypeData/VirtualCallTypeData to reach its end. Non null
1767         // if there&#39;s a return to profile.
1768         assert(SingleTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(), &quot;can&#39;t move past ret type&quot;);
1769         z_sllg(tmp, tmp, exact_log2(DataLayout::cell_size));
1770         z_agr(mdp, tmp);
1771       }
1772       z_stg(mdp, _z_ijava_state_neg(mdx), Z_fp);
1773     } else {
1774       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
1775       update_mdp_by_constant(mdp, in_bytes(TypeEntriesAtCall::return_only_size()));
1776     }
1777 
1778     // Mdp points right after the end of the
1779     // CallTypeData/VirtualCallTypeData, right after the cells for the
1780     // return value type if there&#39;s one.
1781     bind(profile_continue);
1782   }
1783 }
1784 
1785 void InterpreterMacroAssembler::profile_return_type(Register mdp, Register ret, Register tmp) {
1786   assert_different_registers(mdp, ret, tmp);
1787   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
1788     Label profile_continue;
1789 
1790     test_method_data_pointer(mdp, profile_continue);
1791 
1792     if (MethodData::profile_return_jsr292_only()) {
1793       // If we don&#39;t profile all invoke bytecodes we must make sure
1794       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
1795       // beginning of the ProfileData we intend to update to check its
1796       // type because we&#39;re right after it and we don&#39;t known its
1797       // length.
1798       NearLabel do_profile;
1799       Address bc(Z_bcp);
1800       z_lb(tmp, bc);
1801       compare32_and_branch(tmp, Bytecodes::_invokedynamic, Assembler::bcondEqual, do_profile);
1802       compare32_and_branch(tmp, Bytecodes::_invokehandle, Assembler::bcondEqual, do_profile);
1803       get_method(tmp);
1804       // Supplement to 8139891: _intrinsic_id exceeded 1-byte size limit.
1805       if (Method::intrinsic_id_size_in_bytes() == 1) {
1806         z_cli(Method::intrinsic_id_offset_in_bytes(), tmp, vmIntrinsics::_compiledLambdaForm);
1807       } else {
1808         assert(Method::intrinsic_id_size_in_bytes() == 2, &quot;size error: check Method::_intrinsic_id&quot;);
1809         z_lh(tmp, Method::intrinsic_id_offset_in_bytes(), Z_R0, tmp);
1810         z_chi(tmp, vmIntrinsics::_compiledLambdaForm);
1811       }
1812       z_brne(profile_continue);
1813 
1814       bind(do_profile);
1815     }
1816 
1817     Address mdo_ret_addr(mdp, -in_bytes(SingleTypeEntry::size()));
1818     profile_obj_type(ret, mdo_ret_addr, tmp);
1819 
1820     bind(profile_continue);
1821   }
1822 }
1823 
1824 void InterpreterMacroAssembler::profile_parameters_type(Register mdp, Register tmp1, Register tmp2) {
1825   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
1826     Label profile_continue, done;
1827 
1828     test_method_data_pointer(mdp, profile_continue);
1829 
1830     // Load the offset of the area within the MDO used for
1831     // parameters. If it&#39;s negative we&#39;re not profiling any parameters.
1832     Address parm_di_addr(mdp, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset()));
1833     load_and_test_int2long(tmp1, parm_di_addr);
1834     z_brl(profile_continue);
1835 
1836     // Compute a pointer to the area for parameters from the offset
1837     // and move the pointer to the slot for the last
1838     // parameters. Collect profiling from last parameter down.
1839     // mdo start + parameters offset + array length - 1
1840 
1841     // Pointer to the parameter area in the MDO.
1842     z_agr(mdp, tmp1);
1843 
1844     // Offset of the current profile entry to update.
1845     const Register entry_offset = tmp1;
1846     // entry_offset = array len in number of cells.
1847     z_lg(entry_offset, Address(mdp, ArrayData::array_len_offset()));
1848     // entry_offset (number of cells) = array len - size of 1 entry
1849     add2reg(entry_offset, -TypeStackSlotEntries::per_arg_count());
1850     // entry_offset in bytes
1851     z_sllg(entry_offset, entry_offset, exact_log2(DataLayout::cell_size));
1852 
1853     Label loop;
1854     bind(loop);
1855 
1856     Address arg_off(mdp, entry_offset, ParametersTypeData::stack_slot_offset(0));
1857     Address arg_type(mdp, entry_offset, ParametersTypeData::type_offset(0));
1858 
1859     // Load offset on the stack from the slot for this parameter.
1860     z_lg(tmp2, arg_off);
1861     z_sllg(tmp2, tmp2, Interpreter::logStackElementSize);
1862     z_lcgr(tmp2); // Negate.
1863 
1864     // Profile the parameter.
1865     z_ltg(tmp2, Address(Z_locals, tmp2));
1866     profile_obj_type(tmp2, arg_type, tmp2, /*ltg did compare to 0*/ true);
1867 
1868     // Go to next parameter.
1869     z_aghi(entry_offset, -TypeStackSlotEntries::per_arg_count() * DataLayout::cell_size);
1870     z_brnl(loop);
1871 
1872     bind(profile_continue);
1873   }
1874 }
1875 
1876 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
1877 void InterpreterMacroAssembler::increment_mask_and_jump(Address          counter_addr,
1878                                                         int              increment,
1879                                                         Address          mask,
1880                                                         Register         scratch,
1881                                                         bool             preloaded,
1882                                                         branch_condition cond,
1883                                                         Label           *where) {
1884   assert_different_registers(counter_addr.base(), scratch);
1885   if (preloaded) {
1886     add2reg(scratch, increment);
1887     reg2mem_opt(scratch, counter_addr, false);
1888   } else {
1889     if (VM_Version::has_MemWithImmALUOps() &amp;&amp; Immediate::is_simm8(increment) &amp;&amp; counter_addr.is_RSYform()) {
1890       z_alsi(counter_addr.disp20(), counter_addr.base(), increment);
1891       mem2reg_signed_opt(scratch, counter_addr);
1892     } else {
1893       mem2reg_signed_opt(scratch, counter_addr);
1894       add2reg(scratch, increment);
1895       reg2mem_opt(scratch, counter_addr, false);
1896     }
1897   }
1898   z_n(scratch, mask);
1899   if (where) { z_brc(cond, *where); }
1900 }
1901 
1902 // Get MethodCounters object for given method. Lazily allocated if necessary.
1903 //   method    - Ptr to Method object.
1904 //   Rcounters - Ptr to MethodCounters object associated with Method object.
1905 //   skip      - Exit point if MethodCounters object can&#39;t be created (OOM condition).
1906 void InterpreterMacroAssembler::get_method_counters(Register Rmethod,
1907                                                     Register Rcounters,
1908                                                     Label&amp; skip) {
1909   assert_different_registers(Rmethod, Rcounters);
1910 
1911   BLOCK_COMMENT(&quot;get MethodCounters object {&quot;);
1912 
1913   Label has_counters;
1914   load_and_test_long(Rcounters, Address(Rmethod, Method::method_counters_offset()));
1915   z_brnz(has_counters);
1916 
1917   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::build_method_counters), Rmethod);
1918   z_ltgr(Rcounters, Z_RET); // Runtime call returns MethodCounters object.
1919   z_brz(skip); // No MethodCounters, out of memory.
1920 
1921   bind(has_counters);
1922 
1923   BLOCK_COMMENT(&quot;} get MethodCounters object&quot;);
1924 }
1925 
1926 // Increment invocation counter in MethodCounters object.
1927 // Return (invocation_counter+backedge_counter) as &quot;result&quot; in RctrSum.
1928 // Counter values are all unsigned.
1929 void InterpreterMacroAssembler::increment_invocation_counter(Register Rcounters, Register RctrSum) {
1930   assert(UseCompiler || LogTouchedMethods, &quot;incrementing must be useful&quot;);
1931   assert_different_registers(Rcounters, RctrSum);
1932 
1933   int increment          = InvocationCounter::count_increment;
1934   int inv_counter_offset = in_bytes(MethodCounters::invocation_counter_offset() + InvocationCounter::counter_offset());
1935   int be_counter_offset  = in_bytes(MethodCounters::backedge_counter_offset()   + InvocationCounter::counter_offset());
1936 
1937   BLOCK_COMMENT(&quot;Increment invocation counter {&quot;);
1938 
1939   if (VM_Version::has_MemWithImmALUOps() &amp;&amp; Immediate::is_simm8(increment)) {
1940     // Increment the invocation counter in place,
1941     // then add the incremented value to the backedge counter.
1942     z_l(RctrSum, be_counter_offset, Rcounters);
1943     z_alsi(inv_counter_offset, Rcounters, increment);     // Atomic increment @no extra cost!
1944     z_nilf(RctrSum, InvocationCounter::count_mask_value); // Mask off state bits.
1945     z_al(RctrSum, inv_counter_offset, Z_R0, Rcounters);
1946   } else {
1947     // This path is optimized for low register consumption
1948     // at the cost of somewhat higher operand delays.
1949     // It does not need an extra temp register.
1950 
1951     // Update the invocation counter.
1952     z_l(RctrSum, inv_counter_offset, Rcounters);
1953     if (RctrSum == Z_R0) {
1954       z_ahi(RctrSum, increment);
1955     } else {
1956       add2reg(RctrSum, increment);
1957     }
1958     z_st(RctrSum, inv_counter_offset, Rcounters);
1959 
1960     // Mask off the state bits.
1961     z_nilf(RctrSum, InvocationCounter::count_mask_value);
1962 
1963     // Add the backedge counter to the updated invocation counter to
1964     // form the result.
1965     z_al(RctrSum, be_counter_offset, Z_R0, Rcounters);
1966   }
1967 
1968   BLOCK_COMMENT(&quot;} Increment invocation counter&quot;);
1969 
1970   // Note that this macro must leave the backedge_count + invocation_count in Rtmp!
1971 }
1972 
1973 
1974 // increment backedge counter in MethodCounters object.
1975 // return (invocation_counter+backedge_counter) as &quot;result&quot; in RctrSum
1976 // counter values are all unsigned!
1977 void InterpreterMacroAssembler::increment_backedge_counter(Register Rcounters, Register RctrSum) {
1978   assert(UseCompiler, &quot;incrementing must be useful&quot;);
1979   assert_different_registers(Rcounters, RctrSum);
1980 
1981   int increment          = InvocationCounter::count_increment;
1982   int inv_counter_offset = in_bytes(MethodCounters::invocation_counter_offset() + InvocationCounter::counter_offset());
1983   int be_counter_offset  = in_bytes(MethodCounters::backedge_counter_offset()   + InvocationCounter::counter_offset());
1984 
1985   BLOCK_COMMENT(&quot;Increment backedge counter {&quot;);
1986 
1987   if (VM_Version::has_MemWithImmALUOps() &amp;&amp; Immediate::is_simm8(increment)) {
1988     // Increment the invocation counter in place,
1989     // then add the incremented value to the backedge counter.
1990     z_l(RctrSum, inv_counter_offset, Rcounters);
1991     z_alsi(be_counter_offset, Rcounters, increment);      // Atomic increment @no extra cost!
1992     z_nilf(RctrSum, InvocationCounter::count_mask_value); // Mask off state bits.
1993     z_al(RctrSum, be_counter_offset, Z_R0, Rcounters);
1994   } else {
1995     // This path is optimized for low register consumption
1996     // at the cost of somewhat higher operand delays.
1997     // It does not need an extra temp register.
1998 
1999     // Update the invocation counter.
2000     z_l(RctrSum, be_counter_offset, Rcounters);
2001     if (RctrSum == Z_R0) {
2002       z_ahi(RctrSum, increment);
2003     } else {
2004       add2reg(RctrSum, increment);
2005     }
2006     z_st(RctrSum, be_counter_offset, Rcounters);
2007 
2008     // Mask off the state bits.
2009     z_nilf(RctrSum, InvocationCounter::count_mask_value);
2010 
2011     // Add the backedge counter to the updated invocation counter to
2012     // form the result.
2013     z_al(RctrSum, inv_counter_offset, Z_R0, Rcounters);
2014   }
2015 
2016   BLOCK_COMMENT(&quot;} Increment backedge counter&quot;);
2017 
2018   // Note that this macro must leave the backedge_count + invocation_count in Rtmp!
2019 }
2020 
2021 // Add an InterpMonitorElem to stack (see frame_s390.hpp).
2022 void InterpreterMacroAssembler::add_monitor_to_stack(bool     stack_is_empty,
2023                                                      Register Rtemp1,
2024                                                      Register Rtemp2,
2025                                                      Register Rtemp3) {
2026 
2027   const Register Rcurr_slot = Rtemp1;
2028   const Register Rlimit     = Rtemp2;
2029   const jint delta = -frame::interpreter_frame_monitor_size() * wordSize;
2030 
2031   assert((delta &amp; LongAlignmentMask) == 0,
2032          &quot;sizeof BasicObjectLock must be even number of doublewords&quot;);
2033   assert(2 * wordSize == -delta, &quot;this works only as long as delta == -2*wordSize&quot;);
2034   assert(Rcurr_slot != Z_R0, &quot;Register must be usable as base register&quot;);
2035   assert_different_registers(Rlimit, Rcurr_slot, Rtemp3);
2036 
2037   get_monitors(Rlimit);
2038 
2039   // Adjust stack pointer for additional monitor entry.
2040   resize_frame(RegisterOrConstant((intptr_t) delta), Z_fp, false);
2041 
2042   if (!stack_is_empty) {
2043     // Must copy stack contents down.
2044     NearLabel next, done;
2045 
2046     // Rtemp := addr(Tos), Z_esp is pointing below it!
2047     add2reg(Rcurr_slot, wordSize, Z_esp);
2048 
2049     // Nothing to do, if already at monitor area.
2050     compareU64_and_branch(Rcurr_slot, Rlimit, bcondNotLow, done);
2051 
2052     bind(next);
2053 
2054     // Move one stack slot.
2055     mem2reg_opt(Rtemp3, Address(Rcurr_slot));
2056     reg2mem_opt(Rtemp3, Address(Rcurr_slot, delta));
2057     add2reg(Rcurr_slot, wordSize);
2058     compareU64_and_branch(Rcurr_slot, Rlimit, bcondLow, next); // Are we done?
2059 
2060     bind(done);
2061     // Done copying stack.
2062   }
2063 
2064   // Adjust expression stack and monitor pointers.
2065   add2reg(Z_esp, delta);
2066   add2reg(Rlimit, delta);
2067   save_monitors(Rlimit);
2068 }
2069 
2070 // Note: Index holds the offset in bytes afterwards.
2071 // You can use this to store a new value (with Llocals as the base).
2072 void InterpreterMacroAssembler::access_local_int(Register index, Register dst) {
2073   z_sllg(index, index, LogBytesPerWord);
2074   mem2reg_opt(dst, Address(Z_locals, index), false);
2075 }
2076 
2077 void InterpreterMacroAssembler::verify_oop(Register reg, TosState state) {
2078   if (state == atos) { MacroAssembler::verify_oop(reg, FILE_AND_LINE); }
2079 }
2080 
2081 // Inline assembly for:
2082 //
2083 // if (thread is in interp_only_mode) {
2084 //   InterpreterRuntime::post_method_entry();
2085 // }
2086 
2087 void InterpreterMacroAssembler::notify_method_entry() {
2088 
2089   // JVMTI
2090   // Whenever JVMTI puts a thread in interp_only_mode, method
2091   // entry/exit events are sent for that thread to track stack
2092   // depth. If it is possible to enter interp_only_mode we add
2093   // the code to check if the event should be sent.
2094   if (JvmtiExport::can_post_interpreter_events()) {
2095     Label jvmti_post_done;
2096     MacroAssembler::load_and_test_int(Z_R0, Address(Z_thread, JavaThread::interp_only_mode_offset()));
2097     z_bre(jvmti_post_done);
2098     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_entry));
2099     bind(jvmti_post_done);
2100   }
2101 }
2102 
2103 // Inline assembly for:
2104 //
2105 // if (thread is in interp_only_mode) {
2106 //   if (!native_method) save result
2107 //   InterpreterRuntime::post_method_exit();
2108 //   if (!native_method) restore result
2109 // }
2110 // if (DTraceMethodProbes) {
2111 //   SharedRuntime::dtrace_method_exit(thread, method);
2112 // }
2113 //
2114 // For native methods their result is stored in z_ijava_state.lresult
2115 // and z_ijava_state.fresult before coming here.
2116 // Java methods have their result stored in the expression stack.
2117 //
2118 // Notice the dependency to frame::interpreter_frame_result().
2119 void InterpreterMacroAssembler::notify_method_exit(bool native_method,
2120                                                    TosState state,
2121                                                    NotifyMethodExitMode mode) {
2122   // JVMTI
2123   // Whenever JVMTI puts a thread in interp_only_mode, method
2124   // entry/exit events are sent for that thread to track stack
2125   // depth. If it is possible to enter interp_only_mode we add
2126   // the code to check if the event should be sent.
2127   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
2128     Label jvmti_post_done;
2129     MacroAssembler::load_and_test_int(Z_R0, Address(Z_thread, JavaThread::interp_only_mode_offset()));
2130     z_bre(jvmti_post_done);
2131     if (!native_method) push(state); // see frame::interpreter_frame_result()
2132     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
2133     if (!native_method) pop(state);
2134     bind(jvmti_post_done);
2135   }
2136 
2137 #if 0
2138   // Dtrace currently not supported on z/Architecture.
2139   {
2140     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2141     push(state);
2142     get_method(c_rarg1);
2143     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit),
2144                  r15_thread, c_rarg1);
2145     pop(state);
2146   }
2147 #endif
2148 }
2149 
2150 void InterpreterMacroAssembler::skip_if_jvmti_mode(Label &amp;Lskip, Register Rscratch) {
2151   if (!JvmtiExport::can_post_interpreter_events()) {
2152     return;
2153   }
2154 
2155   load_and_test_int(Rscratch, Address(Z_thread, JavaThread::interp_only_mode_offset()));
2156   z_brnz(Lskip);
2157 
2158 }
2159 
2160 // Pop the topmost TOP_IJAVA_FRAME and set it&#39;s sender_sp as new Z_SP.
2161 // The return pc is loaded into the register return_pc.
2162 //
2163 // Registers updated:
2164 //     return_pc  - The return pc of the calling frame.
2165 //     tmp1, tmp2 - scratch
2166 void InterpreterMacroAssembler::pop_interpreter_frame(Register return_pc, Register tmp1, Register tmp2) {
2167   // F0  Z_SP -&gt; caller_sp (F1&#39;s)
2168   //             ...
2169   //             sender_sp (F1&#39;s)
2170   //             ...
2171   // F1  Z_fp -&gt; caller_sp (F2&#39;s)
2172   //             return_pc (Continuation after return from F0.)
2173   //             ...
2174   // F2          caller_sp
2175 
2176   // Remove F0&#39;s activation. Restoring Z_SP to sender_sp reverts modifications
2177   // (a) by a c2i adapter and (b) by generate_fixed_frame().
2178   // In case (a) the new top frame F1 is an unextended compiled frame.
2179   // In case (b) F1 is converted from PARENT_IJAVA_FRAME to TOP_IJAVA_FRAME.
2180 
2181   // Case (b) seems to be redundant when returning to a interpreted caller,
2182   // because then the caller&#39;s top_frame_sp is installed as sp (see
2183   // TemplateInterpreterGenerator::generate_return_entry_for ()). But
2184   // pop_interpreter_frame() is also used in exception handling and there the
2185   // frame type of the caller is unknown, therefore top_frame_sp cannot be used,
2186   // so it is important that sender_sp is the caller&#39;s sp as TOP_IJAVA_FRAME.
2187 
2188   Register R_f1_sender_sp = tmp1;
2189   Register R_f2_sp = tmp2;
2190 
2191   // First check for the interpreter frame&#39;s magic.
2192   asm_assert_ijava_state_magic(R_f2_sp/*tmp*/);
2193   z_lg(R_f2_sp, _z_parent_ijava_frame_abi(callers_sp), Z_fp);
2194   z_lg(R_f1_sender_sp, _z_ijava_state_neg(sender_sp), Z_fp);
2195   if (return_pc-&gt;is_valid())
2196     z_lg(return_pc, _z_parent_ijava_frame_abi(return_pc), Z_fp);
2197   // Pop F0 by resizing to R_f1_sender_sp and using R_f2_sp as fp.
2198   resize_frame_absolute(R_f1_sender_sp, R_f2_sp, false/*load fp*/);
2199 
2200 #ifdef ASSERT
2201   // The return_pc in the new top frame is dead... at least that&#39;s my
2202   // current understanding; to assert this I overwrite it.
2203   load_const_optimized(Z_ARG3, 0xb00b1);
2204   z_stg(Z_ARG3, _z_parent_ijava_frame_abi(return_pc), Z_SP);
2205 #endif
2206 }
2207 
2208 void InterpreterMacroAssembler::verify_FPU(int stack_depth, TosState state) {
2209   if (VerifyFPU) {
2210     unimplemented(&quot;verfiyFPU&quot;);
2211   }
2212 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>