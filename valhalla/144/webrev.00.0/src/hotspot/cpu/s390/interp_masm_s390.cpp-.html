<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/cpu/s390/interp_masm_s390.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * Copyright (c) 2016, 2019 SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 // Major contributions by AHa, AS, JL, ML.
  27 
  28 #include &quot;precompiled.hpp&quot;
  29 #include &quot;asm/macroAssembler.inline.hpp&quot;
  30 #include &quot;gc/shared/barrierSet.hpp&quot;
  31 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  32 #include &quot;interp_masm_s390.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
  34 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  35 #include &quot;oops/arrayOop.hpp&quot;
  36 #include &quot;oops/markWord.hpp&quot;
  37 #include &quot;prims/jvmtiExport.hpp&quot;
  38 #include &quot;prims/jvmtiThreadState.hpp&quot;
  39 #include &quot;runtime/basicLock.hpp&quot;
  40 #include &quot;runtime/biasedLocking.hpp&quot;
  41 #include &quot;runtime/frame.inline.hpp&quot;
  42 #include &quot;runtime/safepointMechanism.hpp&quot;
  43 #include &quot;runtime/sharedRuntime.hpp&quot;
  44 #include &quot;runtime/thread.inline.hpp&quot;
  45 #include &quot;utilities/powerOfTwo.hpp&quot;
  46 
  47 // Implementation of InterpreterMacroAssembler.
  48 // This file specializes the assembler with interpreter-specific macros.
  49 
  50 #ifdef PRODUCT
  51 #define BLOCK_COMMENT(str)
  52 #define BIND(label)        bind(label);
  53 #else
  54 #define BLOCK_COMMENT(str) block_comment(str)
  55 #define BIND(label)        bind(label); BLOCK_COMMENT(#label &quot;:&quot;)
  56 #endif
  57 
  58 void InterpreterMacroAssembler::jump_to_entry(address entry, Register Rscratch) {
  59   assert(entry != NULL, &quot;Entry must have been generated by now&quot;);
  60   assert(Rscratch != Z_R0, &quot;Can&#39;t use R0 for addressing&quot;);
  61   branch_optimized(Assembler::bcondAlways, entry);
  62 }
  63 
  64 void InterpreterMacroAssembler::empty_expression_stack(void) {
  65   get_monitors(Z_R1_scratch);
  66   add2reg(Z_esp, -Interpreter::stackElementSize, Z_R1_scratch);
  67 }
  68 
  69 // Dispatch code executed in the prolog of a bytecode which does not do it&#39;s
  70 // own dispatch.
  71 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int bcp_incr) {
  72   // On z/Architecture we are short on registers, therefore we do not preload the
  73   // dispatch address of the next bytecode.
  74 }
  75 
  76 // Dispatch code executed in the epilog of a bytecode which does not do it&#39;s
  77 // own dispatch.
  78 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int step) {
  79   dispatch_next(state, step);
  80 }
  81 
  82 void InterpreterMacroAssembler::dispatch_next(TosState state, int bcp_incr, bool generate_poll) {
  83   z_llgc(Z_bytecode, bcp_incr, Z_R0, Z_bcp);  // Load next bytecode.
  84   add2reg(Z_bcp, bcp_incr);                   // Advance bcp. Add2reg produces optimal code.
  85   dispatch_base(state, Interpreter::dispatch_table(state), generate_poll);
  86 }
  87 
  88 // Common code to dispatch and dispatch_only.
  89 // Dispatch value in Lbyte_code and increment Lbcp.
  90 
  91 void InterpreterMacroAssembler::dispatch_base(TosState state, address* table, bool generate_poll) {
  92   verify_FPU(1, state);
  93 
  94 #ifdef ASSERT
  95   address reentry = NULL;
  96   { Label OK;
  97     // Check if the frame pointer in Z_fp is correct.
  98     z_cg(Z_fp, 0, Z_SP);
  99     z_bre(OK);
 100     reentry = stop_chain_static(reentry, &quot;invalid frame pointer Z_fp: &quot; FILE_AND_LINE);
 101     bind(OK);
 102   }
 103   { Label OK;
 104     // check if the locals pointer in Z_locals is correct
 105     z_cg(Z_locals, _z_ijava_state_neg(locals), Z_fp);
 106     z_bre(OK);
 107     reentry = stop_chain_static(reentry, &quot;invalid locals pointer Z_locals: &quot; FILE_AND_LINE);
 108     bind(OK);
 109   }
 110 #endif
 111 
 112   // TODO: Maybe implement +VerifyActivationFrameSize here.
 113   // verify_thread(); // Too slow. We will just verify on method entry &amp; exit.
 114   verify_oop(Z_tos, state);
 115 
 116   // Dispatch table to use.
 117   load_absolute_address(Z_tmp_1, (address)table);  // Z_tmp_1 = table;
 118 
 119   if (generate_poll) {
 120     address *sfpt_tbl = Interpreter::safept_table(state);
 121     if (table != sfpt_tbl) {
 122       Label dispatch;
 123       const Address poll_byte_addr(Z_thread, in_bytes(Thread::polling_page_offset()) + 7 /* Big Endian */);
 124       // Armed page has poll_bit set, if poll bit is cleared just continue.
 125       z_tm(poll_byte_addr, SafepointMechanism::poll_bit());
 126       z_braz(dispatch);
 127       load_absolute_address(Z_tmp_1, (address)sfpt_tbl);  // Z_tmp_1 = table;
 128       bind(dispatch);
 129     }
 130   }
 131 
 132   // 0 &lt;= Z_bytecode &lt; 256 =&gt; Use a 32 bit shift, because it is shorter than sllg.
 133   // Z_bytecode must have been loaded zero-extended for this approach to be correct.
 134   z_sll(Z_bytecode, LogBytesPerWord, Z_R0);   // Multiply by wordSize.
 135   z_lg(Z_tmp_1, 0, Z_bytecode, Z_tmp_1);      // Get entry addr.
 136 
 137   z_br(Z_tmp_1);
 138 }
 139 
 140 void InterpreterMacroAssembler::dispatch_only(TosState state, bool generate_poll) {
 141   dispatch_base(state, Interpreter::dispatch_table(state), generate_poll);
 142 }
 143 
 144 void InterpreterMacroAssembler::dispatch_only_normal(TosState state) {
 145   dispatch_base(state, Interpreter::normal_table(state));
 146 }
 147 
 148 void InterpreterMacroAssembler::dispatch_via(TosState state, address *table) {
 149   // Load current bytecode.
 150   z_llgc(Z_bytecode, Address(Z_bcp, (intptr_t)0));
 151   dispatch_base(state, table);
 152 }
 153 
 154 // The following call_VM*_base() methods overload and mask the respective
 155 // declarations/definitions in class MacroAssembler. They are meant as a &quot;detour&quot;
 156 // to perform additional, template interpreter specific tasks before actually
 157 // calling their MacroAssembler counterparts.
 158 
 159 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point) {
 160   bool allow_relocation = true; // Fenerally valid variant. Assume code is relocated.
 161   // interpreter specific
 162   // Note: No need to save/restore bcp (Z_R13) pointer since these are callee
 163   // saved registers and no blocking/ GC can happen in leaf calls.
 164 
 165   // super call
 166   MacroAssembler::call_VM_leaf_base(entry_point, allow_relocation);
 167 }
 168 
 169 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point, bool allow_relocation) {
 170   // interpreter specific
 171   // Note: No need to save/restore bcp (Z_R13) pointer since these are callee
 172   // saved registers and no blocking/ GC can happen in leaf calls.
 173 
 174   // super call
 175   MacroAssembler::call_VM_leaf_base(entry_point, allow_relocation);
 176 }
 177 
 178 void InterpreterMacroAssembler::call_VM_base(Register oop_result, Register last_java_sp,
 179                                              address entry_point, bool check_exceptions) {
 180   bool allow_relocation = true; // Fenerally valid variant. Assume code is relocated.
 181   // interpreter specific
 182 
 183   save_bcp();
 184   save_esp();
 185   // super call
 186   MacroAssembler::call_VM_base(oop_result, last_java_sp,
 187                                entry_point, allow_relocation, check_exceptions);
 188   restore_bcp();
 189 }
 190 
 191 void InterpreterMacroAssembler::call_VM_base(Register oop_result, Register last_java_sp,
 192                                              address entry_point, bool allow_relocation,
 193                                              bool check_exceptions) {
 194   // interpreter specific
 195 
 196   save_bcp();
 197   save_esp();
 198   // super call
 199   MacroAssembler::call_VM_base(oop_result, last_java_sp,
 200                                entry_point, allow_relocation, check_exceptions);
 201   restore_bcp();
 202 }
 203 
 204 void InterpreterMacroAssembler::check_and_handle_popframe(Register scratch_reg) {
 205   if (JvmtiExport::can_pop_frame()) {
 206     BLOCK_COMMENT(&quot;check_and_handle_popframe {&quot;);
 207     Label L;
 208     // Initiate popframe handling only if it is not already being
 209     // processed. If the flag has the popframe_processing bit set, it
 210     // means that this code is called *during* popframe handling - we
 211     // don&#39;t want to reenter.
 212     // TODO: Check if all four state combinations could be visible.
 213     // If (processing and !pending) is an invisible/impossible state,
 214     // there is optimization potential by testing both bits at once.
 215     // Then, All_Zeroes and All_Ones means skip, Mixed means doit.
 216     testbit(Address(Z_thread, JavaThread::popframe_condition_offset()),
 217             exact_log2(JavaThread::popframe_pending_bit));
 218     z_bfalse(L);
 219     testbit(Address(Z_thread, JavaThread::popframe_condition_offset()),
 220             exact_log2(JavaThread::popframe_processing_bit));
 221     z_btrue(L);
 222 
 223     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 224     // address of the same-named entrypoint in the generated interpreter code.
 225     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 226     // The above call should (as its only effect) return the contents of the field
 227     // _remove_activation_preserving_args_entry in Z_RET.
 228     // We just jump there to have the work done.
 229     z_br(Z_RET);
 230     // There is no way for control to fall thru here.
 231 
 232     bind(L);
 233     BLOCK_COMMENT(&quot;} check_and_handle_popframe&quot;);
 234   }
 235 }
 236 
 237 
 238 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 239   Register RjvmtiState = Z_R1_scratch;
 240   int      tos_off     = in_bytes(JvmtiThreadState::earlyret_tos_offset());
 241   int      oop_off     = in_bytes(JvmtiThreadState::earlyret_oop_offset());
 242   int      val_off     = in_bytes(JvmtiThreadState::earlyret_value_offset());
 243   int      state_off   = in_bytes(JavaThread::jvmti_thread_state_offset());
 244 
 245   z_lg(RjvmtiState, state_off, Z_thread);
 246 
 247   switch (state) {
 248     case atos: z_lg(Z_tos, oop_off, RjvmtiState);
 249       store_const(Address(RjvmtiState, oop_off), 0L, 8, 8, Z_R0_scratch);
 250                                                     break;
 251     case ltos: z_lg(Z_tos, val_off, RjvmtiState);   break;
 252     case btos: // fall through
 253     case ztos: // fall through
 254     case ctos: // fall through
 255     case stos: // fall through
 256     case itos: z_llgf(Z_tos, val_off, RjvmtiState); break;
 257     case ftos: z_le(Z_ftos, val_off, RjvmtiState);  break;
 258     case dtos: z_ld(Z_ftos, val_off, RjvmtiState);  break;
 259     case vtos:   /* nothing to do */                break;
 260     default  : ShouldNotReachHere();
 261   }
 262 
 263   // Clean up tos value in the jvmti thread state.
 264   store_const(Address(RjvmtiState, val_off),   0L, 8, 8, Z_R0_scratch);
 265   // Set tos state field to illegal value.
 266   store_const(Address(RjvmtiState, tos_off), ilgl, 4, 1, Z_R0_scratch);
 267 }
 268 
 269 void InterpreterMacroAssembler::check_and_handle_earlyret(Register scratch_reg) {
 270   if (JvmtiExport::can_force_early_return()) {
 271     BLOCK_COMMENT(&quot;check_and_handle_earlyret {&quot;);
 272     Label L;
 273     // arg regs are save, because we are just behind the call in call_VM_base
 274     Register jvmti_thread_state = Z_ARG2;
 275     Register tmp                = Z_ARG3;
 276     load_and_test_long(jvmti_thread_state, Address(Z_thread, JavaThread::jvmti_thread_state_offset()));
 277     z_bre(L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 278 
 279     // Initiate earlyret handling only if it is not already being processed.
 280     // If the flag has the earlyret_processing bit set, it means that this code
 281     // is called *during* earlyret handling - we don&#39;t want to reenter.
 282 
 283     assert((JvmtiThreadState::earlyret_pending != 0) &amp;&amp; (JvmtiThreadState::earlyret_inactive == 0),
 284           &quot;must fix this check, when changing the values of the earlyret enum&quot;);
 285     assert(JvmtiThreadState::earlyret_pending == 1, &quot;must fix this check, when changing the values of the earlyret enum&quot;);
 286 
 287     load_and_test_int(tmp, Address(jvmti_thread_state, JvmtiThreadState::earlyret_state_offset()));
 288     z_brz(L); // if (thread-&gt;jvmti_thread_state()-&gt;_earlyret_state != JvmtiThreadState::earlyret_pending) exit;
 289 
 290     // Call Interpreter::remove_activation_early_entry() to get the address of the
 291     // same-named entrypoint in the generated interpreter code.
 292     assert(sizeof(TosState) == 4, &quot;unexpected size&quot;);
 293     z_l(Z_ARG1, Address(jvmti_thread_state, JvmtiThreadState::earlyret_tos_offset()));
 294     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), Z_ARG1);
 295     // The above call should (as its only effect) return the contents of the field
 296     // _remove_activation_preserving_args_entry in Z_RET.
 297     // We just jump there to have the work done.
 298     z_br(Z_RET);
 299     // There is no way for control to fall thru here.
 300 
 301     bind(L);
 302     BLOCK_COMMENT(&quot;} check_and_handle_earlyret&quot;);
 303   }
 304 }
 305 
 306 void InterpreterMacroAssembler::super_call_VM_leaf(address entry_point, Register arg_1, Register arg_2) {
 307   lgr_if_needed(Z_ARG1, arg_1);
 308   assert(arg_2 != Z_ARG1, &quot;smashed argument&quot;);
 309   lgr_if_needed(Z_ARG2, arg_2);
 310   MacroAssembler::call_VM_leaf_base(entry_point, true);
 311 }
 312 
 313 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register index, int bcp_offset, size_t index_size) {
 314   Address param(Z_bcp, bcp_offset);
 315 
 316   BLOCK_COMMENT(&quot;get_cache_index_at_bcp {&quot;);
 317   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 318   if (index_size == sizeof(u2)) {
 319     load_sized_value(index, param, 2, false /*signed*/);
 320   } else if (index_size == sizeof(u4)) {
 321 
 322     load_sized_value(index, param, 4, false);
 323 
 324     // Check if the secondary index definition is still ~x, otherwise
 325     // we have to change the following assembler code to calculate the
 326     // plain index.
 327     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 328     not_(index);  // Convert to plain index.
 329   } else if (index_size == sizeof(u1)) {
 330     z_llgc(index, param);
 331   } else {
 332     ShouldNotReachHere();
 333   }
 334   BLOCK_COMMENT(&quot;}&quot;);
 335 }
 336 
 337 
 338 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache, Register cpe_offset,
 339                                                            int bcp_offset, size_t index_size) {
 340   BLOCK_COMMENT(&quot;get_cache_and_index_at_bcp {&quot;);
 341   assert_different_registers(cache, cpe_offset);
 342   get_cache_index_at_bcp(cpe_offset, bcp_offset, index_size);
 343   z_lg(cache, Address(Z_fp, _z_ijava_state_neg(cpoolCache)));
 344   // Convert from field index to ConstantPoolCache offset in bytes.
 345   z_sllg(cpe_offset, cpe_offset, exact_log2(in_words(ConstantPoolCacheEntry::size()) * BytesPerWord));
 346   BLOCK_COMMENT(&quot;}&quot;);
 347 }
 348 
 349 // Kills Z_R0_scratch.
 350 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,
 351                                                                         Register cpe_offset,
 352                                                                         Register bytecode,
 353                                                                         int byte_no,
 354                                                                         int bcp_offset,
 355                                                                         size_t index_size) {
 356   BLOCK_COMMENT(&quot;get_cache_and_index_and_bytecode_at_bcp {&quot;);
 357   get_cache_and_index_at_bcp(cache, cpe_offset, bcp_offset, index_size);
 358 
 359   // We want to load (from CP cache) the bytecode that corresponds to the passed-in byte_no.
 360   // It is located at (cache + cpe_offset + base_offset + indices_offset + (8-1) (last byte in DW) - (byte_no+1).
 361   // Instead of loading, shifting and masking a DW, we just load that one byte of interest with z_llgc (unsigned).
 362   const int base_ix_off = in_bytes(ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset());
 363   const int off_in_DW   = (8-1) - (1+byte_no);
 364   assert(ConstantPoolCacheEntry::bytecode_1_mask == ConstantPoolCacheEntry::bytecode_2_mask, &quot;common mask&quot;);
 365   assert(ConstantPoolCacheEntry::bytecode_1_mask == 0xff, &quot;&quot;);
 366   load_sized_value(bytecode, Address(cache, cpe_offset, base_ix_off+off_in_DW), 1, false /*signed*/);
 367 
 368   BLOCK_COMMENT(&quot;}&quot;);
 369 }
 370 
 371 // Load object from cpool-&gt;resolved_references(index).
 372 void InterpreterMacroAssembler::load_resolved_reference_at_index(Register result, Register index) {
 373   assert_different_registers(result, index);
 374   get_constant_pool(result);
 375 
 376   // Convert
 377   //  - from field index to resolved_references() index and
 378   //  - from word index to byte offset.
 379   // Since this is a java object, it is potentially compressed.
 380   Register tmp = index;  // reuse
 381   z_sllg(index, index, LogBytesPerHeapOop); // Offset into resolved references array.
 382   // Load pointer for resolved_references[] objArray.
 383   z_lg(result, ConstantPool::cache_offset_in_bytes(), result);
 384   z_lg(result, ConstantPoolCache::resolved_references_offset_in_bytes(), result);
 385   resolve_oop_handle(result); // Load resolved references array itself.
 386 #ifdef ASSERT
 387   NearLabel index_ok;
 388   z_lgf(Z_R0, Address(result, arrayOopDesc::length_offset_in_bytes()));
 389   z_sllg(Z_R0, Z_R0, LogBytesPerHeapOop);
 390   compare64_and_branch(tmp, Z_R0, Assembler::bcondLow, index_ok);
 391   stop(&quot;resolved reference index out of bounds&quot;, 0x09256);
 392   bind(index_ok);
 393 #endif
 394   z_agr(result, index);    // Address of indexed array element.
 395   load_heap_oop(result, Address(result, arrayOopDesc::base_offset_in_bytes(T_OBJECT)), tmp, noreg);
 396 }
 397 
 398 // load cpool-&gt;resolved_klass_at(index)
 399 void InterpreterMacroAssembler::load_resolved_klass_at_offset(Register cpool, Register offset, Register iklass) {
 400   // int value = *(Rcpool-&gt;int_at_addr(which));
 401   // int resolved_klass_index = extract_low_short_from_int(value);
 402   z_llgh(offset, Address(cpool, offset, sizeof(ConstantPool) + 2)); // offset = resolved_klass_index (s390 is big-endian)
 403   z_sllg(offset, offset, LogBytesPerWord);                          // Convert &#39;index&#39; to &#39;offset&#39;
 404   z_lg(iklass, Address(cpool, ConstantPool::resolved_klasses_offset_in_bytes())); // iklass = cpool-&gt;_resolved_klasses
 405   z_lg(iklass, Address(iklass, offset, Array&lt;Klass*&gt;::base_offset_in_bytes()));
 406 }
 407 
 408 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache,
 409                                                                Register tmp,
 410                                                                int bcp_offset,
 411                                                                size_t index_size) {
 412   BLOCK_COMMENT(&quot;get_cache_entry_pointer_at_bcp {&quot;);
 413     get_cache_and_index_at_bcp(cache, tmp, bcp_offset, index_size);
 414     add2reg_with_index(cache, in_bytes(ConstantPoolCache::base_offset()), tmp, cache);
 415   BLOCK_COMMENT(&quot;}&quot;);
 416 }
 417 
 418 void InterpreterMacroAssembler::load_resolved_method_at_index(int byte_no,
 419                                                               Register cache,
 420                                                               Register cpe_offset,
 421                                                               Register method) {
 422   const int method_offset = in_bytes(
 423     ConstantPoolCache::base_offset() +
 424       ((byte_no == TemplateTable::f2_byte)
 425        ? ConstantPoolCacheEntry::f2_offset()
 426        : ConstantPoolCacheEntry::f1_offset()));
 427 
 428   z_lg(method, Address(cache, cpe_offset, method_offset)); // get f1 Method*
 429 }
 430 
 431 // Generate a subtype check: branch to ok_is_subtype if sub_klass is
 432 // a subtype of super_klass. Blows registers Rsuper_klass, Rsub_klass, tmp1, tmp2.
 433 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 434                                                   Register Rsuper_klass,
 435                                                   Register Rtmp1,
 436                                                   Register Rtmp2,
 437                                                   Label &amp;ok_is_subtype) {
 438   // Profile the not-null value&#39;s klass.
 439   profile_typecheck(Rtmp1, Rsub_klass, Rtmp2);
 440 
 441   // Do the check.
 442   check_klass_subtype(Rsub_klass, Rsuper_klass, Rtmp1, Rtmp2, ok_is_subtype);
 443 
 444   // Profile the failure of the check.
 445   profile_typecheck_failed(Rtmp1, Rtmp2);
 446 }
 447 
 448 // Pop topmost element from stack. It just disappears.
 449 // Useful if consumed previously by access via stackTop().
 450 void InterpreterMacroAssembler::popx(int len) {
 451   add2reg(Z_esp, len*Interpreter::stackElementSize);
 452   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 453 }
 454 
 455 // Get Address object of stack top. No checks. No pop.
 456 // Purpose: - Provide address of stack operand to exploit reg-mem operations.
 457 //          - Avoid RISC-like mem2reg - reg-reg-op sequence.
 458 Address InterpreterMacroAssembler::stackTop() {
 459   return Address(Z_esp, Interpreter::expr_offset_in_bytes(0));
 460 }
 461 
 462 void InterpreterMacroAssembler::pop_i(Register r) {
 463   z_l(r, Interpreter::expr_offset_in_bytes(0), Z_esp);
 464   add2reg(Z_esp, Interpreter::stackElementSize);
 465   assert_different_registers(r, Z_R1_scratch);
 466   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 467 }
 468 
 469 void InterpreterMacroAssembler::pop_ptr(Register r) {
 470   z_lg(r, Interpreter::expr_offset_in_bytes(0), Z_esp);
 471   add2reg(Z_esp, Interpreter::stackElementSize);
 472   assert_different_registers(r, Z_R1_scratch);
 473   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 474 }
 475 
 476 void InterpreterMacroAssembler::pop_l(Register r) {
 477   z_lg(r, Interpreter::expr_offset_in_bytes(0), Z_esp);
 478   add2reg(Z_esp, 2*Interpreter::stackElementSize);
 479   assert_different_registers(r, Z_R1_scratch);
 480   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 481 }
 482 
 483 void InterpreterMacroAssembler::pop_f(FloatRegister f) {
 484   mem2freg_opt(f, Address(Z_esp, Interpreter::expr_offset_in_bytes(0)), false);
 485   add2reg(Z_esp, Interpreter::stackElementSize);
 486   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 487 }
 488 
 489 void InterpreterMacroAssembler::pop_d(FloatRegister f) {
 490   mem2freg_opt(f, Address(Z_esp, Interpreter::expr_offset_in_bytes(0)), true);
 491   add2reg(Z_esp, 2*Interpreter::stackElementSize);
 492   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 493 }
 494 
 495 void InterpreterMacroAssembler::push_i(Register r) {
 496   assert_different_registers(r, Z_R1_scratch);
 497   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 498   z_st(r, Address(Z_esp));
 499   add2reg(Z_esp, -Interpreter::stackElementSize);
 500 }
 501 
 502 void InterpreterMacroAssembler::push_ptr(Register r) {
 503   z_stg(r, Address(Z_esp));
 504   add2reg(Z_esp, -Interpreter::stackElementSize);
 505 }
 506 
 507 void InterpreterMacroAssembler::push_l(Register r) {
 508   assert_different_registers(r, Z_R1_scratch);
 509   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 510   int offset = -Interpreter::stackElementSize;
 511   z_stg(r, Address(Z_esp, offset));
 512   clear_mem(Address(Z_esp), Interpreter::stackElementSize);
 513   add2reg(Z_esp, 2 * offset);
 514 }
 515 
 516 void InterpreterMacroAssembler::push_f(FloatRegister f) {
 517   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 518   freg2mem_opt(f, Address(Z_esp), false);
 519   add2reg(Z_esp, -Interpreter::stackElementSize);
 520 }
 521 
 522 void InterpreterMacroAssembler::push_d(FloatRegister d) {
 523   debug_only(verify_esp(Z_esp, Z_R1_scratch));
 524   int offset = -Interpreter::stackElementSize;
 525   freg2mem_opt(d, Address(Z_esp, offset));
 526   add2reg(Z_esp, 2 * offset);
 527 }
 528 
 529 void InterpreterMacroAssembler::push(TosState state) {
 530   verify_oop(Z_tos, state);
 531   switch (state) {
 532     case atos: push_ptr();           break;
 533     case btos: push_i();             break;
 534     case ztos:
 535     case ctos:
 536     case stos: push_i();             break;
 537     case itos: push_i();             break;
 538     case ltos: push_l();             break;
 539     case ftos: push_f();             break;
 540     case dtos: push_d();             break;
 541     case vtos: /* nothing to do */   break;
 542     default  : ShouldNotReachHere();
 543   }
 544 }
 545 
 546 void InterpreterMacroAssembler::pop(TosState state) {
 547   switch (state) {
 548     case atos: pop_ptr(Z_tos);       break;
 549     case btos: pop_i(Z_tos);         break;
 550     case ztos:
 551     case ctos:
 552     case stos: pop_i(Z_tos);         break;
 553     case itos: pop_i(Z_tos);         break;
 554     case ltos: pop_l(Z_tos);         break;
 555     case ftos: pop_f(Z_ftos);        break;
 556     case dtos: pop_d(Z_ftos);        break;
 557     case vtos: /* nothing to do */   break;
 558     default  : ShouldNotReachHere();
 559   }
 560   verify_oop(Z_tos, state);
 561 }
 562 
 563 // Helpers for swap and dup.
 564 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 565   z_lg(val, Address(Z_esp, Interpreter::expr_offset_in_bytes(n)));
 566 }
 567 
 568 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 569   z_stg(val, Address(Z_esp, Interpreter::expr_offset_in_bytes(n)));
 570 }
 571 
 572 void InterpreterMacroAssembler::prepare_to_jump_from_interpreted(Register method) {
 573   // Satisfy interpreter calling convention (see generate_normal_entry()).
 574   z_lgr(Z_R10, Z_SP); // Set sender sp (aka initial caller sp, aka unextended sp).
 575   // Record top_frame_sp, because the callee might modify it, if it&#39;s compiled.
 576   z_stg(Z_SP, _z_ijava_state_neg(top_frame_sp), Z_fp);
 577   save_bcp();
 578   save_esp();
 579   z_lgr(Z_method, method); // Set Z_method (kills Z_fp!).
 580 }
 581 
 582 // Jump to from_interpreted entry of a call unless single stepping is possible
 583 // in this thread in which case we must call the i2i entry.
 584 void InterpreterMacroAssembler::jump_from_interpreted(Register method, Register temp) {
 585   assert_different_registers(method, Z_R10 /*used for initial_caller_sp*/, temp);
 586   prepare_to_jump_from_interpreted(method);
 587 
 588   if (JvmtiExport::can_post_interpreter_events()) {
 589     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 590     // compiled code in threads for which the event is enabled. Check here for
 591     // interp_only_mode if these events CAN be enabled.
 592     z_lg(Z_R1_scratch, Address(method, Method::from_interpreted_offset()));
 593     MacroAssembler::load_and_test_int(Z_R0_scratch, Address(Z_thread, JavaThread::interp_only_mode_offset()));
 594     z_bcr(bcondEqual, Z_R1_scratch); // Run compiled code if zero.
 595     // Run interpreted.
 596     z_lg(Z_R1_scratch, Address(method, Method::interpreter_entry_offset()));
 597     z_br(Z_R1_scratch);
 598   } else {
 599     // Run compiled code.
 600     z_lg(Z_R1_scratch, Address(method, Method::from_interpreted_offset()));
 601     z_br(Z_R1_scratch);
 602   }
 603 }
 604 
 605 #ifdef ASSERT
 606 void InterpreterMacroAssembler::verify_esp(Register Resp, Register Rtemp) {
 607   // About to read or write Resp[0].
 608   // Make sure it is not in the monitors or the TOP_IJAVA_FRAME_ABI.
 609   address reentry = NULL;
 610 
 611   {
 612     // Check if the frame pointer in Z_fp is correct.
 613     NearLabel OK;
 614     z_cg(Z_fp, 0, Z_SP);
 615     z_bre(OK);
 616     reentry = stop_chain_static(reentry, &quot;invalid frame pointer Z_fp&quot;);
 617     bind(OK);
 618   }
 619   {
 620     // Resp must not point into or below the operand stack,
 621     // i.e. IJAVA_STATE.monitors &gt; Resp.
 622     NearLabel OK;
 623     Register Rmonitors = Rtemp;
 624     z_lg(Rmonitors, _z_ijava_state_neg(monitors), Z_fp);
 625     compareU64_and_branch(Rmonitors, Resp, bcondHigh, OK);
 626     reentry = stop_chain_static(reentry, &quot;too many pops: Z_esp points into monitor area&quot;);
 627     bind(OK);
 628   }
 629   {
 630     // Resp may point to the last word of TOP_IJAVA_FRAME_ABI, but not below
 631     // i.e. !(Z_SP + frame::z_top_ijava_frame_abi_size - Interpreter::stackElementSize &gt; Resp).
 632     NearLabel OK;
 633     Register Rabi_bottom = Rtemp;
 634     add2reg(Rabi_bottom, frame::z_top_ijava_frame_abi_size - Interpreter::stackElementSize, Z_SP);
 635     compareU64_and_branch(Rabi_bottom, Resp, bcondNotHigh, OK);
 636     reentry = stop_chain_static(reentry, &quot;too many pushes: Z_esp points into TOP_IJAVA_FRAME_ABI&quot;);
 637     bind(OK);
 638   }
 639 }
 640 
 641 void InterpreterMacroAssembler::asm_assert_ijava_state_magic(Register tmp) {
 642   Label magic_ok;
 643   load_const_optimized(tmp, frame::z_istate_magic_number);
 644   z_cg(tmp, Address(Z_fp, _z_ijava_state_neg(magic)));
 645   z_bre(magic_ok);
 646   stop_static(&quot;error: wrong magic number in ijava_state access&quot;);
 647   bind(magic_ok);
 648 }
 649 #endif // ASSERT
 650 
 651 void InterpreterMacroAssembler::save_bcp() {
 652   z_stg(Z_bcp, Address(Z_fp, _z_ijava_state_neg(bcp)));
 653   asm_assert_ijava_state_magic(Z_bcp);
 654   NOT_PRODUCT(z_lg(Z_bcp, Address(Z_fp, _z_ijava_state_neg(bcp))));
 655 }
 656 
 657 void InterpreterMacroAssembler::restore_bcp() {
 658   asm_assert_ijava_state_magic(Z_bcp);
 659   z_lg(Z_bcp, Address(Z_fp, _z_ijava_state_neg(bcp)));
 660 }
 661 
 662 void InterpreterMacroAssembler::save_esp() {
 663   z_stg(Z_esp, Address(Z_fp, _z_ijava_state_neg(esp)));
 664 }
 665 
 666 void InterpreterMacroAssembler::restore_esp() {
 667   asm_assert_ijava_state_magic(Z_esp);
 668   z_lg(Z_esp, Address(Z_fp, _z_ijava_state_neg(esp)));
 669 }
 670 
 671 void InterpreterMacroAssembler::get_monitors(Register reg) {
 672   asm_assert_ijava_state_magic(reg);
 673   mem2reg_opt(reg, Address(Z_fp, _z_ijava_state_neg(monitors)));
 674 }
 675 
 676 void InterpreterMacroAssembler::save_monitors(Register reg) {
 677   reg2mem_opt(reg, Address(Z_fp, _z_ijava_state_neg(monitors)));
 678 }
 679 
 680 void InterpreterMacroAssembler::get_mdp(Register mdp) {
 681   z_lg(mdp, _z_ijava_state_neg(mdx), Z_fp);
 682 }
 683 
 684 void InterpreterMacroAssembler::save_mdp(Register mdp) {
 685   z_stg(mdp, _z_ijava_state_neg(mdx), Z_fp);
 686 }
 687 
 688 // Values that are only read (besides initialization).
 689 void InterpreterMacroAssembler::restore_locals() {
 690   asm_assert_ijava_state_magic(Z_locals);
 691   z_lg(Z_locals, Address(Z_fp, _z_ijava_state_neg(locals)));
 692 }
 693 
 694 void InterpreterMacroAssembler::get_method(Register reg) {
 695   asm_assert_ijava_state_magic(reg);
 696   z_lg(reg, Address(Z_fp, _z_ijava_state_neg(method)));
 697 }
 698 
 699 void InterpreterMacroAssembler::get_2_byte_integer_at_bcp(Register Rdst, int bcp_offset,
 700                                                           signedOrNot is_signed) {
 701   // Rdst is an 8-byte return value!!!
 702 
 703   // Unaligned loads incur only a small penalty on z/Architecture. The penalty
 704   // is a few (2..3) ticks, even when the load crosses a cache line
 705   // boundary. In case of a cache miss, the stall could, of course, be
 706   // much longer.
 707 
 708   switch (is_signed) {
 709     case Signed:
 710       z_lgh(Rdst, bcp_offset, Z_R0, Z_bcp);
 711      break;
 712    case Unsigned:
 713      z_llgh(Rdst, bcp_offset, Z_R0, Z_bcp);
 714      break;
 715    default:
 716      ShouldNotReachHere();
 717   }
 718 }
 719 
 720 
 721 void InterpreterMacroAssembler::get_4_byte_integer_at_bcp(Register Rdst, int bcp_offset,
 722                                                           setCCOrNot set_cc) {
 723   // Rdst is an 8-byte return value!!!
 724 
 725   // Unaligned loads incur only a small penalty on z/Architecture. The penalty
 726   // is a few (2..3) ticks, even when the load crosses a cache line
 727   // boundary. In case of a cache miss, the stall could, of course, be
 728   // much longer.
 729 
 730   // Both variants implement a sign-extending int2long load.
 731   if (set_cc == set_CC) {
 732     load_and_test_int2long(Rdst, Address(Z_bcp, (intptr_t)bcp_offset));
 733   } else {
 734     mem2reg_signed_opt(    Rdst, Address(Z_bcp, (intptr_t)bcp_offset));
 735   }
 736 }
 737 
 738 void InterpreterMacroAssembler::get_constant_pool(Register Rdst) {
 739   get_method(Rdst);
 740   mem2reg_opt(Rdst, Address(Rdst, Method::const_offset()));
 741   mem2reg_opt(Rdst, Address(Rdst, ConstMethod::constants_offset()));
 742 }
 743 
 744 void InterpreterMacroAssembler::get_cpool_and_tags(Register Rcpool, Register Rtags) {
 745   get_constant_pool(Rcpool);
 746   mem2reg_opt(Rtags, Address(Rcpool, ConstantPool::tags_offset_in_bytes()));
 747 }
 748 
 749 // Unlock if synchronized method.
 750 //
 751 // Unlock the receiver if this is a synchronized method.
 752 // Unlock any Java monitors from syncronized blocks.
 753 //
 754 // If there are locked Java monitors
 755 //   If throw_monitor_exception
 756 //     throws IllegalMonitorStateException
 757 //   Else if install_monitor_exception
 758 //     installs IllegalMonitorStateException
 759 //   Else
 760 //     no error processing
 761 void InterpreterMacroAssembler::unlock_if_synchronized_method(TosState state,
 762                                                               bool throw_monitor_exception,
 763                                                               bool install_monitor_exception) {
 764   NearLabel unlocked, unlock, no_unlock;
 765 
 766   {
 767     Register R_method = Z_ARG2;
 768     Register R_do_not_unlock_if_synchronized = Z_ARG3;
 769 
 770     // Get the value of _do_not_unlock_if_synchronized into G1_scratch.
 771     const Address do_not_unlock_if_synchronized(Z_thread,
 772                                                 JavaThread::do_not_unlock_if_synchronized_offset());
 773     load_sized_value(R_do_not_unlock_if_synchronized, do_not_unlock_if_synchronized, 1, false /*unsigned*/);
 774     z_mvi(do_not_unlock_if_synchronized, false); // Reset the flag.
 775 
 776     // Check if synchronized method.
 777     get_method(R_method);
 778     verify_oop(Z_tos, state);
 779     push(state); // Save tos/result.
 780     testbit(method2_(R_method, access_flags), JVM_ACC_SYNCHRONIZED_BIT);
 781     z_bfalse(unlocked);
 782 
 783     // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag
 784     // is set.
 785     compareU64_and_branch(R_do_not_unlock_if_synchronized, (intptr_t)0L, bcondNotEqual, no_unlock);
 786   }
 787 
 788   // unlock monitor
 789 
 790   // BasicObjectLock will be first in list, since this is a
 791   // synchronized method. However, need to check that the object has
 792   // not been unlocked by an explicit monitorexit bytecode.
 793   const Address monitor(Z_fp, -(frame::z_ijava_state_size + (int) sizeof(BasicObjectLock)));
 794   // We use Z_ARG2 so that if we go slow path it will be the correct
 795   // register for unlock_object to pass to VM directly.
 796   load_address(Z_ARG2, monitor); // Address of first monitor.
 797   z_lg(Z_ARG3, Address(Z_ARG2, BasicObjectLock::obj_offset_in_bytes()));
 798   compareU64_and_branch(Z_ARG3, (intptr_t)0L, bcondNotEqual, unlock);
 799 
 800   if (throw_monitor_exception) {
 801     // Entry already unlocked need to throw an exception.
 802     MacroAssembler::call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_illegal_monitor_state_exception));
 803     should_not_reach_here();
 804   } else {
 805     // Monitor already unlocked during a stack unroll.
 806     // If requested, install an illegal_monitor_state_exception.
 807     // Continue with stack unrolling.
 808     if (install_monitor_exception) {
 809       MacroAssembler::call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::new_illegal_monitor_state_exception));
 810     }
 811    z_bru(unlocked);
 812   }
 813 
 814   bind(unlock);
 815 
 816   unlock_object(Z_ARG2);
 817 
 818   bind(unlocked);
 819 
 820   // I0, I1: Might contain return value
 821 
 822   // Check that all monitors are unlocked.
 823   {
 824     NearLabel loop, exception, entry, restart;
 825     const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 826     // We use Z_ARG2 so that if we go slow path it will be the correct
 827     // register for unlock_object to pass to VM directly.
 828     Register R_current_monitor = Z_ARG2;
 829     Register R_monitor_block_bot = Z_ARG1;
 830     const Address monitor_block_top(Z_fp, _z_ijava_state_neg(monitors));
 831     const Address monitor_block_bot(Z_fp, -frame::z_ijava_state_size);
 832 
 833     bind(restart);
 834     // Starting with top-most entry.
 835     z_lg(R_current_monitor, monitor_block_top);
 836     // Points to word before bottom of monitor block.
 837     load_address(R_monitor_block_bot, monitor_block_bot);
 838     z_bru(entry);
 839 
 840     // Entry already locked, need to throw exception.
 841     bind(exception);
 842 
 843     if (throw_monitor_exception) {
 844       // Throw exception.
 845       MacroAssembler::call_VM(noreg,
 846                               CAST_FROM_FN_PTR(address, InterpreterRuntime::
 847                                                throw_illegal_monitor_state_exception));
 848       should_not_reach_here();
 849     } else {
 850       // Stack unrolling. Unlock object and install illegal_monitor_exception.
 851       // Unlock does not block, so don&#39;t have to worry about the frame.
 852       // We don&#39;t have to preserve c_rarg1 since we are going to throw an exception.
 853       unlock_object(R_current_monitor);
 854       if (install_monitor_exception) {
 855         call_VM(noreg, CAST_FROM_FN_PTR(address,
 856                                         InterpreterRuntime::
 857                                         new_illegal_monitor_state_exception));
 858       }
 859       z_bru(restart);
 860     }
 861 
 862     bind(loop);
 863     // Check if current entry is used.
 864     load_and_test_long(Z_R0_scratch, Address(R_current_monitor, BasicObjectLock::obj_offset_in_bytes()));
 865     z_brne(exception);
 866 
 867     add2reg(R_current_monitor, entry_size); // Otherwise advance to next entry.
 868     bind(entry);
 869     compareU64_and_branch(R_current_monitor, R_monitor_block_bot, bcondNotEqual, loop);
 870   }
 871 
 872   bind(no_unlock);
 873   pop(state);
 874   verify_oop(Z_tos, state);
 875 }
 876 
 877 void InterpreterMacroAssembler::narrow(Register result, Register ret_type) {
 878   get_method(ret_type);
 879   z_lg(ret_type, Address(ret_type, in_bytes(Method::const_offset())));
 880   z_lb(ret_type, Address(ret_type, in_bytes(ConstMethod::result_type_offset())));
 881 
 882   Label notBool, notByte, notChar, done;
 883 
 884   // common case first
 885   compareU32_and_branch(ret_type, T_INT, bcondEqual, done);
 886 
 887   compareU32_and_branch(ret_type, T_BOOLEAN, bcondNotEqual, notBool);
 888   z_nilf(result, 0x1);
 889   z_bru(done);
 890 
 891   bind(notBool);
 892   compareU32_and_branch(ret_type, T_BYTE, bcondNotEqual, notByte);
 893   z_lbr(result, result);
 894   z_bru(done);
 895 
 896   bind(notByte);
 897   compareU32_and_branch(ret_type, T_CHAR, bcondNotEqual, notChar);
 898   z_nilf(result, 0xffff);
 899   z_bru(done);
 900 
 901   bind(notChar);
 902   // compareU32_and_branch(ret_type, T_SHORT, bcondNotEqual, notShort);
 903   z_lhr(result, result);
 904 
 905   // Nothing to do for T_INT
 906   bind(done);
 907 }
 908 
 909 // remove activation
 910 //
 911 // Unlock the receiver if this is a synchronized method.
 912 // Unlock any Java monitors from syncronized blocks.
 913 // Remove the activation from the stack.
 914 //
 915 // If there are locked Java monitors
 916 //   If throw_monitor_exception
 917 //     throws IllegalMonitorStateException
 918 //   Else if install_monitor_exception
 919 //     installs IllegalMonitorStateException
 920 //   Else
 921 //     no error processing
 922 void InterpreterMacroAssembler::remove_activation(TosState state,
 923                                                   Register return_pc,
 924                                                   bool throw_monitor_exception,
 925                                                   bool install_monitor_exception,
 926                                                   bool notify_jvmti) {
 927   BLOCK_COMMENT(&quot;remove_activation {&quot;);
 928   unlock_if_synchronized_method(state, throw_monitor_exception, install_monitor_exception);
 929 
 930   // Save result (push state before jvmti call and pop it afterwards) and notify jvmti.
 931   notify_method_exit(false, state, notify_jvmti ? NotifyJVMTI : SkipNotifyJVMTI);
 932 
 933   if (StackReservedPages &gt; 0) {
 934     BLOCK_COMMENT(&quot;reserved_stack_check:&quot;);
 935     // Test if reserved zone needs to be enabled.
 936     Label no_reserved_zone_enabling;
 937 
 938     // Compare frame pointers. There is no good stack pointer, as with stack
 939     // frame compression we can get different SPs when we do calls. A subsequent
 940     // call could have a smaller SP, so that this compare succeeds for an
 941     // inner call of the method annotated with ReservedStack.
 942     z_lg(Z_R0, Address(Z_SP, (intptr_t)_z_abi(callers_sp)));
 943     z_clg(Z_R0, Address(Z_thread, JavaThread::reserved_stack_activation_offset())); // Compare with frame pointer in memory.
 944     z_brl(no_reserved_zone_enabling);
 945 
 946     // Enable reserved zone again, throw stack overflow exception.
 947     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), Z_thread);
 948     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_delayed_StackOverflowError));
 949 
 950     should_not_reach_here();
 951 
 952     bind(no_reserved_zone_enabling);
 953   }
 954 
 955   verify_oop(Z_tos, state);
 956   verify_thread();
 957 
 958   pop_interpreter_frame(return_pc, Z_ARG2, Z_ARG3);
 959   BLOCK_COMMENT(&quot;} remove_activation&quot;);
 960 }
 961 
 962 // lock object
 963 //
 964 // Registers alive
 965 //   monitor - Address of the BasicObjectLock to be used for locking,
 966 //             which must be initialized with the object to lock.
 967 //   object  - Address of the object to be locked.
 968 void InterpreterMacroAssembler::lock_object(Register monitor, Register object) {
 969 
 970   if (UseHeavyMonitors) {
 971     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
 972             monitor, /*check_for_exceptions=*/false);
 973     return;
 974   }
 975 
 976   // template code:
 977   //
 978   // markWord displaced_header = obj-&gt;mark().set_unlocked();
 979   // monitor-&gt;lock()-&gt;set_displaced_header(displaced_header);
 980   // if (Atomic::cmpxchg(/*addr*/obj-&gt;mark_addr(), /*cmp*/displaced_header, /*ex=*/monitor) == displaced_header) {
 981   //   // We stored the monitor address into the object&#39;s mark word.
 982   // } else if (THREAD-&gt;is_lock_owned((address)displaced_header))
 983   //   // Simple recursive case.
 984   //   monitor-&gt;lock()-&gt;set_displaced_header(NULL);
 985   // } else {
 986   //   // Slow path.
 987   //   InterpreterRuntime::monitorenter(THREAD, monitor);
 988   // }
 989 
 990   const Register displaced_header = Z_ARG5;
 991   const Register object_mark_addr = Z_ARG4;
 992   const Register current_header   = Z_ARG5;
 993 
 994   NearLabel done;
 995   NearLabel slow_case;
 996 
 997   // markWord displaced_header = obj-&gt;mark().set_unlocked();
 998 
 999   // Load markWord from object into displaced_header.
1000   z_lg(displaced_header, oopDesc::mark_offset_in_bytes(), object);
1001 
1002   if (UseBiasedLocking) {
1003     biased_locking_enter(object, displaced_header, Z_R1, Z_R0, done, &amp;slow_case);
1004   }
1005 
1006   // Set displaced_header to be (markWord of object | UNLOCK_VALUE).
1007   z_oill(displaced_header, markWord::unlocked_value);
1008 
1009   // monitor-&gt;lock()-&gt;set_displaced_header(displaced_header);
1010 
1011   // Initialize the box (Must happen before we update the object mark!).
1012   z_stg(displaced_header, BasicObjectLock::lock_offset_in_bytes() +
1013                           BasicLock::displaced_header_offset_in_bytes(), monitor);
1014 
1015   // if (Atomic::cmpxchg(/*addr*/obj-&gt;mark_addr(), /*cmp*/displaced_header, /*ex=*/monitor) == displaced_header) {
1016 
1017   // Store stack address of the BasicObjectLock (this is monitor) into object.
1018   add2reg(object_mark_addr, oopDesc::mark_offset_in_bytes(), object);
1019 
1020   z_csg(displaced_header, monitor, 0, object_mark_addr);
1021   assert(current_header==displaced_header, &quot;must be same register&quot;); // Identified two registers from z/Architecture.
1022 
1023   z_bre(done);
1024 
1025   // } else if (THREAD-&gt;is_lock_owned((address)displaced_header))
1026   //   // Simple recursive case.
1027   //   monitor-&gt;lock()-&gt;set_displaced_header(NULL);
1028 
1029   // We did not see an unlocked object so try the fast recursive case.
1030 
1031   // Check if owner is self by comparing the value in the markWord of object
1032   // (current_header) with the stack pointer.
1033   z_sgr(current_header, Z_SP);
1034 
1035   assert(os::vm_page_size() &gt; 0xfff, &quot;page size too small - change the constant&quot;);
1036 
1037   // The prior sequence &quot;LGR, NGR, LTGR&quot; can be done better
1038   // (Z_R1 is temp and not used after here).
1039   load_const_optimized(Z_R0, (~(os::vm_page_size()-1) | markWord::lock_mask_in_place));
1040   z_ngr(Z_R0, current_header); // AND sets CC (result eq/ne 0)
1041 
1042   // If condition is true we are done and hence we can store 0 in the displaced
1043   // header indicating it is a recursive lock and be done.
1044   z_brne(slow_case);
1045   z_release();  // Membar unnecessary on zarch AND because the above csg does a sync before and after.
1046   z_stg(Z_R0/*==0!*/, BasicObjectLock::lock_offset_in_bytes() +
1047                       BasicLock::displaced_header_offset_in_bytes(), monitor);
1048   z_bru(done);
1049 
1050   // } else {
1051   //   // Slow path.
1052   //   InterpreterRuntime::monitorenter(THREAD, monitor);
1053 
1054   // None of the above fast optimizations worked so we have to get into the
1055   // slow case of monitor enter.
1056   bind(slow_case);
1057 
1058   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1059           monitor, /*check_for_exceptions=*/false);
1060 
1061   // }
1062 
1063   bind(done);
1064 }
1065 
1066 // Unlocks an object. Used in monitorexit bytecode and remove_activation.
1067 //
1068 // Registers alive
1069 //   monitor - address of the BasicObjectLock to be used for locking,
1070 //             which must be initialized with the object to lock.
1071 //
1072 // Throw IllegalMonitorException if object is not locked by current thread.
1073 void InterpreterMacroAssembler::unlock_object(Register monitor, Register object) {
1074 
1075   if (UseHeavyMonitors) {
1076     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit), monitor);
1077     return;
1078   }
1079 
1080 // else {
1081   // template code:
1082   //
1083   // if ((displaced_header = monitor-&gt;displaced_header()) == NULL) {
1084   //   // Recursive unlock. Mark the monitor unlocked by setting the object field to NULL.
1085   //   monitor-&gt;set_obj(NULL);
1086   // } else if (Atomic::cmpxchg(obj-&gt;mark_addr(), monitor, displaced_header) == monitor) {
1087   //   // We swapped the unlocked mark in displaced_header into the object&#39;s mark word.
1088   //   monitor-&gt;set_obj(NULL);
1089   // } else {
1090   //   // Slow path.
1091   //   InterpreterRuntime::monitorexit(THREAD, monitor);
1092   // }
1093 
1094   const Register displaced_header = Z_ARG4;
1095   const Register current_header   = Z_R1;
1096   Address obj_entry(monitor, BasicObjectLock::obj_offset_in_bytes());
1097   Label done;
1098 
1099   if (object == noreg) {
1100     // In the template interpreter, we must assure that the object
1101     // entry in the monitor is cleared on all paths. Thus we move
1102     // loading up to here, and clear the entry afterwards.
1103     object = Z_ARG3; // Use Z_ARG3 if caller didn&#39;t pass object.
1104     z_lg(object, obj_entry);
1105   }
1106 
1107   assert_different_registers(monitor, object, displaced_header, current_header);
1108 
1109   // if ((displaced_header = monitor-&gt;displaced_header()) == NULL) {
1110   //   // Recursive unlock. Mark the monitor unlocked by setting the object field to NULL.
1111   //   monitor-&gt;set_obj(NULL);
1112 
1113   clear_mem(obj_entry, sizeof(oop));
1114 
1115   if (UseBiasedLocking) {
1116     // The object address from the monitor is in object.
1117     assert(oopDesc::mark_offset_in_bytes() == 0, &quot;offset of _mark is not 0&quot;);
1118     biased_locking_exit(object, displaced_header, done);
1119   }
1120 
1121   // Test first if we are in the fast recursive case.
1122   MacroAssembler::load_and_test_long(displaced_header,
1123                                      Address(monitor, BasicObjectLock::lock_offset_in_bytes() +
1124                                                       BasicLock::displaced_header_offset_in_bytes()));
1125   z_bre(done); // displaced_header == 0 -&gt; goto done
1126 
1127   // } else if (Atomic::cmpxchg(obj-&gt;mark_addr(), monitor, displaced_header) == monitor) {
1128   //   // We swapped the unlocked mark in displaced_header into the object&#39;s mark word.
1129   //   monitor-&gt;set_obj(NULL);
1130 
1131   // If we still have a lightweight lock, unlock the object and be done.
1132 
1133   // The markword is expected to be at offset 0.
1134   assert(oopDesc::mark_offset_in_bytes() == 0, &quot;unlock_object: review code below&quot;);
1135 
1136   // We have the displaced header in displaced_header. If the lock is still
1137   // lightweight, it will contain the monitor address and we&#39;ll store the
1138   // displaced header back into the object&#39;s mark word.
1139   z_lgr(current_header, monitor);
1140   z_csg(current_header, displaced_header, 0, object);
1141   z_bre(done);
1142 
1143   // } else {
1144   //   // Slow path.
1145   //   InterpreterRuntime::monitorexit(THREAD, monitor);
1146 
1147   // The lock has been converted into a heavy lock and hence
1148   // we need to get into the slow case.
1149   z_stg(object, obj_entry);   // Restore object entry, has been cleared above.
1150   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit), monitor);
1151 
1152   // }
1153 
1154   bind(done);
1155 }
1156 
1157 void InterpreterMacroAssembler::test_method_data_pointer(Register mdp, Label&amp; zero_continue) {
1158   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1159   load_and_test_long(mdp, Address(Z_fp, _z_ijava_state_neg(mdx)));
1160   z_brz(zero_continue);
1161 }
1162 
1163 // Set the method data pointer for the current bcp.
1164 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1165   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1166   Label    set_mdp;
1167   Register mdp    = Z_ARG4;
1168   Register method = Z_ARG5;
1169 
1170   get_method(method);
1171   // Test MDO to avoid the call if it is NULL.
1172   load_and_test_long(mdp, method2_(method, method_data));
1173   z_brz(set_mdp);
1174 
1175   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), method, Z_bcp);
1176   // Z_RET: mdi
1177   // Mdo is guaranteed to be non-zero here, we checked for it before the call.
1178   assert(method-&gt;is_nonvolatile(), &quot;choose nonvolatile reg or reload from frame&quot;);
1179   z_lg(mdp, method2_(method, method_data)); // Must reload, mdp is volatile reg.
1180   add2reg_with_index(mdp, in_bytes(MethodData::data_offset()), Z_RET, mdp);
1181 
1182   bind(set_mdp);
1183   save_mdp(mdp);
1184 }
1185 
1186 void InterpreterMacroAssembler::verify_method_data_pointer() {
1187   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1188 #ifdef ASSERT
1189   NearLabel verify_continue;
1190   Register bcp_expected = Z_ARG3;
1191   Register mdp    = Z_ARG4;
1192   Register method = Z_ARG5;
1193 
1194   test_method_data_pointer(mdp, verify_continue); // If mdp is zero, continue
1195   get_method(method);
1196 
1197   // If the mdp is valid, it will point to a DataLayout header which is
1198   // consistent with the bcp. The converse is highly probable also.
1199   load_sized_value(bcp_expected, Address(mdp, DataLayout::bci_offset()), 2, false /*signed*/);
1200   z_ag(bcp_expected, Address(method, Method::const_offset()));
1201   load_address(bcp_expected, Address(bcp_expected, ConstMethod::codes_offset()));
1202   compareU64_and_branch(bcp_expected, Z_bcp, bcondEqual, verify_continue);
1203   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp), method, Z_bcp, mdp);
1204   bind(verify_continue);
1205 #endif // ASSERT
1206 }
1207 
1208 void InterpreterMacroAssembler::set_mdp_data_at(Register mdp_in, int constant, Register value) {
1209   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1210   z_stg(value, constant, mdp_in);
1211 }
1212 
1213 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1214                                                       int constant,
1215                                                       Register tmp,
1216                                                       bool decrement) {
1217   assert_different_registers(mdp_in, tmp);
1218   // counter address
1219   Address data(mdp_in, constant);
1220   const int delta = decrement ? -DataLayout::counter_increment : DataLayout::counter_increment;
1221   add2mem_64(Address(mdp_in, constant), delta, tmp);
1222 }
1223 
1224 void InterpreterMacroAssembler::set_mdp_flag_at(Register mdp_in,
1225                                                 int flag_byte_constant) {
1226   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1227   // Set the flag.
1228   z_oi(Address(mdp_in, DataLayout::flags_offset()), flag_byte_constant);
1229 }
1230 
1231 void InterpreterMacroAssembler::test_mdp_data_at(Register mdp_in,
1232                                                  int offset,
1233                                                  Register value,
1234                                                  Register test_value_out,
1235                                                  Label&amp; not_equal_continue) {
1236   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1237   if (test_value_out == noreg) {
1238     z_cg(value, Address(mdp_in, offset));
1239     z_brne(not_equal_continue);
1240   } else {
1241     // Put the test value into a register, so caller can use it:
1242     z_lg(test_value_out, Address(mdp_in, offset));
1243     compareU64_and_branch(test_value_out, value, bcondNotEqual, not_equal_continue);
1244   }
1245 }
1246 
1247 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in, int offset_of_disp) {
1248   update_mdp_by_offset(mdp_in, noreg, offset_of_disp);
1249 }
1250 
1251 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1252                                                      Register dataidx,
1253                                                      int offset_of_disp) {
1254   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1255   Address disp_address(mdp_in, dataidx, offset_of_disp);
1256   Assembler::z_ag(mdp_in, disp_address);
1257   save_mdp(mdp_in);
1258 }
1259 
1260 void InterpreterMacroAssembler::update_mdp_by_constant(Register mdp_in, int constant) {
1261   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1262   add2reg(mdp_in, constant);
1263   save_mdp(mdp_in);
1264 }
1265 
1266 void InterpreterMacroAssembler::update_mdp_for_ret(Register return_bci) {
1267   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1268   assert(return_bci-&gt;is_nonvolatile(), &quot;choose nonvolatile reg or save/restore&quot;);
1269   call_VM(noreg,
1270           CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret),
1271           return_bci);
1272 }
1273 
1274 void InterpreterMacroAssembler::profile_taken_branch(Register mdp, Register bumped_count) {
1275   if (ProfileInterpreter) {
1276     Label profile_continue;
1277 
1278     // If no method data exists, go to profile_continue.
1279     // Otherwise, assign to mdp.
1280     test_method_data_pointer(mdp, profile_continue);
1281 
1282     // We are taking a branch. Increment the taken count.
1283     // We inline increment_mdp_data_at to return bumped_count in a register
1284     //increment_mdp_data_at(mdp, in_bytes(JumpData::taken_offset()));
1285     Address data(mdp, JumpData::taken_offset());
1286     z_lg(bumped_count, data);
1287     // 64-bit overflow is very unlikely. Saturation to 32-bit values is
1288     // performed when reading the counts.
1289     add2reg(bumped_count, DataLayout::counter_increment);
1290     z_stg(bumped_count, data); // Store back out
1291 
1292     // The method data pointer needs to be updated to reflect the new target.
1293     update_mdp_by_offset(mdp, in_bytes(JumpData::displacement_offset()));
1294     bind(profile_continue);
1295   }
1296 }
1297 
1298 // Kills Z_R1_scratch.
1299 void InterpreterMacroAssembler::profile_not_taken_branch(Register mdp) {
1300   if (ProfileInterpreter) {
1301     Label profile_continue;
1302 
1303     // If no method data exists, go to profile_continue.
1304     test_method_data_pointer(mdp, profile_continue);
1305 
1306     // We are taking a branch. Increment the not taken count.
1307     increment_mdp_data_at(mdp, in_bytes(BranchData::not_taken_offset()), Z_R1_scratch);
1308 
1309     // The method data pointer needs to be updated to correspond to
1310     // the next bytecode.
1311     update_mdp_by_constant(mdp, in_bytes(BranchData::branch_data_size()));
1312     bind(profile_continue);
1313   }
1314 }
1315 
1316 // Kills: Z_R1_scratch.
1317 void InterpreterMacroAssembler::profile_call(Register mdp) {
1318   if (ProfileInterpreter) {
1319     Label profile_continue;
1320 
1321     // If no method data exists, go to profile_continue.
1322     test_method_data_pointer(mdp, profile_continue);
1323 
1324     // We are making a call. Increment the count.
1325     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1326 
1327     // The method data pointer needs to be updated to reflect the new target.
1328     update_mdp_by_constant(mdp, in_bytes(CounterData::counter_data_size()));
1329     bind(profile_continue);
1330   }
1331 }
1332 
1333 void InterpreterMacroAssembler::profile_final_call(Register mdp) {
1334   if (ProfileInterpreter) {
1335     Label profile_continue;
1336 
1337     // If no method data exists, go to profile_continue.
1338     test_method_data_pointer(mdp, profile_continue);
1339 
1340     // We are making a call. Increment the count.
1341     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1342 
1343     // The method data pointer needs to be updated to reflect the new target.
1344     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1345     bind(profile_continue);
1346   }
1347 }
1348 
1349 void InterpreterMacroAssembler::profile_virtual_call(Register receiver,
1350                                                      Register mdp,
1351                                                      Register reg2,
1352                                                      bool receiver_can_be_null) {
1353   if (ProfileInterpreter) {
1354     NearLabel profile_continue;
1355 
1356     // If no method data exists, go to profile_continue.
1357     test_method_data_pointer(mdp, profile_continue);
1358 
1359     NearLabel skip_receiver_profile;
1360     if (receiver_can_be_null) {
1361       NearLabel not_null;
1362       compareU64_and_branch(receiver, (intptr_t)0L, bcondNotEqual, not_null);
1363       // We are making a call. Increment the count for null receiver.
1364       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1365       z_bru(skip_receiver_profile);
1366       bind(not_null);
1367     }
1368 
1369     // Record the receiver type.
1370     record_klass_in_profile(receiver, mdp, reg2, true);
1371     bind(skip_receiver_profile);
1372 
1373     // The method data pointer needs to be updated to reflect the new target.
1374     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1375     bind(profile_continue);
1376   }
1377 }
1378 
1379 // This routine creates a state machine for updating the multi-row
1380 // type profile at a virtual call site (or other type-sensitive bytecode).
1381 // The machine visits each row (of receiver/count) until the receiver type
1382 // is found, or until it runs out of rows. At the same time, it remembers
1383 // the location of the first empty row. (An empty row records null for its
1384 // receiver, and can be allocated for a newly-observed receiver type.)
1385 // Because there are two degrees of freedom in the state, a simple linear
1386 // search will not work; it must be a decision tree. Hence this helper
1387 // function is recursive, to generate the required tree structured code.
1388 // It&#39;s the interpreter, so we are trading off code space for speed.
1389 // See below for example code.
1390 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1391                                         Register receiver, Register mdp,
1392                                         Register reg2, int start_row,
1393                                         Label&amp; done, bool is_virtual_call) {
1394   if (TypeProfileWidth == 0) {
1395     if (is_virtual_call) {
1396       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1397     }
1398     return;
1399   }
1400 
1401   int last_row = VirtualCallData::row_limit() - 1;
1402   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1403   // Test this row for both the receiver and for null.
1404   // Take any of three different outcomes:
1405   //   1. found receiver =&gt; increment count and goto done
1406   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1407   //   3. found something else =&gt; keep looking for cases 1 and 2
1408   // Case 3 is handled by a recursive call.
1409   for (int row = start_row; row &lt;= last_row; row++) {
1410     NearLabel next_test;
1411     bool test_for_null_also = (row == start_row);
1412 
1413     // See if the receiver is receiver[n].
1414     int recvr_offset = in_bytes(VirtualCallData::receiver_offset(row));
1415     test_mdp_data_at(mdp, recvr_offset, receiver,
1416                      (test_for_null_also ? reg2 : noreg),
1417                      next_test);
1418     // (Reg2 now contains the receiver from the CallData.)
1419 
1420     // The receiver is receiver[n]. Increment count[n].
1421     int count_offset = in_bytes(VirtualCallData::receiver_count_offset(row));
1422     increment_mdp_data_at(mdp, count_offset);
1423     z_bru(done);
1424     bind(next_test);
1425 
1426     if (test_for_null_also) {
1427       Label found_null;
1428       // Failed the equality check on receiver[n]... Test for null.
1429       z_ltgr(reg2, reg2);
1430       if (start_row == last_row) {
1431         // The only thing left to do is handle the null case.
1432         if (is_virtual_call) {
1433           z_brz(found_null);
1434           // Receiver did not match any saved receiver and there is no empty row for it.
1435           // Increment total counter to indicate polymorphic case.
1436           increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1437           z_bru(done);
1438           bind(found_null);
1439         } else {
1440           z_brnz(done);
1441         }
1442         break;
1443       }
1444       // Since null is rare, make it be the branch-taken case.
1445       z_brz(found_null);
1446 
1447       // Put all the &quot;Case 3&quot; tests here.
1448       record_klass_in_profile_helper(receiver, mdp, reg2, start_row + 1, done, is_virtual_call);
1449 
1450       // Found a null. Keep searching for a matching receiver,
1451       // but remember that this is an empty (unused) slot.
1452       bind(found_null);
1453     }
1454   }
1455 
1456   // In the fall-through case, we found no matching receiver, but we
1457   // observed the receiver[start_row] is NULL.
1458 
1459   // Fill in the receiver field and increment the count.
1460   int recvr_offset = in_bytes(VirtualCallData::receiver_offset(start_row));
1461   set_mdp_data_at(mdp, recvr_offset, receiver);
1462   int count_offset = in_bytes(VirtualCallData::receiver_count_offset(start_row));
1463   load_const_optimized(reg2, DataLayout::counter_increment);
1464   set_mdp_data_at(mdp, count_offset, reg2);
1465   if (start_row &gt; 0) {
1466     z_bru(done);
1467   }
1468 }
1469 
1470 // Example state machine code for three profile rows:
1471 //   // main copy of decision tree, rooted at row[1]
1472 //   if (row[0].rec == rec) { row[0].incr(); goto done; }
1473 //   if (row[0].rec != NULL) {
1474 //     // inner copy of decision tree, rooted at row[1]
1475 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1476 //     if (row[1].rec != NULL) {
1477 //       // degenerate decision tree, rooted at row[2]
1478 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1479 //       if (row[2].rec != NULL) { count.incr(); goto done; } // overflow
1480 //       row[2].init(rec); goto done;
1481 //     } else {
1482 //       // remember row[1] is empty
1483 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1484 //       row[1].init(rec); goto done;
1485 //     }
1486 //   } else {
1487 //     // remember row[0] is empty
1488 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1489 //     if (row[2].rec == rec) { row[2].incr(); goto done; }
1490 //     row[0].init(rec); goto done;
1491 //   }
1492 //   done:
1493 
1494 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1495                                                         Register mdp, Register reg2,
1496                                                         bool is_virtual_call) {
1497   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1498   Label done;
1499 
1500   record_klass_in_profile_helper(receiver, mdp, reg2, 0, done, is_virtual_call);
1501 
1502   bind (done);
1503 }
1504 
1505 void InterpreterMacroAssembler::profile_ret(Register return_bci, Register mdp) {
1506   if (ProfileInterpreter) {
1507     NearLabel profile_continue;
1508     uint row;
1509 
1510     // If no method data exists, go to profile_continue.
1511     test_method_data_pointer(mdp, profile_continue);
1512 
1513     // Update the total ret count.
1514     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1515 
1516     for (row = 0; row &lt; RetData::row_limit(); row++) {
1517       NearLabel next_test;
1518 
1519       // See if return_bci is equal to bci[n]:
1520       test_mdp_data_at(mdp,
1521                        in_bytes(RetData::bci_offset(row)),
1522                        return_bci, noreg,
1523                        next_test);
1524 
1525       // Return_bci is equal to bci[n]. Increment the count.
1526       increment_mdp_data_at(mdp, in_bytes(RetData::bci_count_offset(row)));
1527 
1528       // The method data pointer needs to be updated to reflect the new target.
1529       update_mdp_by_offset(mdp, in_bytes(RetData::bci_displacement_offset(row)));
1530       z_bru(profile_continue);
1531       bind(next_test);
1532     }
1533 
1534     update_mdp_for_ret(return_bci);
1535 
1536     bind(profile_continue);
1537   }
1538 }
1539 
1540 void InterpreterMacroAssembler::profile_null_seen(Register mdp) {
1541   if (ProfileInterpreter) {
1542     Label profile_continue;
1543 
1544     // If no method data exists, go to profile_continue.
1545     test_method_data_pointer(mdp, profile_continue);
1546 
1547     set_mdp_flag_at(mdp, BitData::null_seen_byte_constant());
1548 
1549     // The method data pointer needs to be updated.
1550     int mdp_delta = in_bytes(BitData::bit_data_size());
1551     if (TypeProfileCasts) {
1552       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1553     }
1554     update_mdp_by_constant(mdp, mdp_delta);
1555 
1556     bind(profile_continue);
1557   }
1558 }
1559 
1560 void InterpreterMacroAssembler::profile_typecheck_failed(Register mdp, Register tmp) {
1561   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1562     Label profile_continue;
1563 
1564     // If no method data exists, go to profile_continue.
1565     test_method_data_pointer(mdp, profile_continue);
1566 
1567     int count_offset = in_bytes(CounterData::count_offset());
1568     // Back up the address, since we have already bumped the mdp.
1569     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1570 
1571     // *Decrement* the counter. We expect to see zero or small negatives.
1572     increment_mdp_data_at(mdp, count_offset, tmp, true);
1573 
1574     bind (profile_continue);
1575   }
1576 }
1577 
1578 void InterpreterMacroAssembler::profile_typecheck(Register mdp, Register klass, Register reg2) {
1579   if (ProfileInterpreter) {
1580     Label profile_continue;
1581 
1582     // If no method data exists, go to profile_continue.
1583     test_method_data_pointer(mdp, profile_continue);
1584 
1585     // The method data pointer needs to be updated.
1586     int mdp_delta = in_bytes(BitData::bit_data_size());
1587     if (TypeProfileCasts) {
1588       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1589 
1590       // Record the object type.
1591       record_klass_in_profile(klass, mdp, reg2, false);
1592     }
1593     update_mdp_by_constant(mdp, mdp_delta);
1594 
1595     bind(profile_continue);
1596   }
1597 }
1598 
1599 void InterpreterMacroAssembler::profile_switch_default(Register mdp) {
1600   if (ProfileInterpreter) {
1601     Label profile_continue;
1602 
1603     // If no method data exists, go to profile_continue.
1604     test_method_data_pointer(mdp, profile_continue);
1605 
1606     // Update the default case count.
1607     increment_mdp_data_at(mdp, in_bytes(MultiBranchData::default_count_offset()));
1608 
1609     // The method data pointer needs to be updated.
1610     update_mdp_by_offset(mdp, in_bytes(MultiBranchData::default_displacement_offset()));
1611 
1612     bind(profile_continue);
1613   }
1614 }
1615 
1616 // Kills: index, scratch1, scratch2.
1617 void InterpreterMacroAssembler::profile_switch_case(Register index,
1618                                                     Register mdp,
1619                                                     Register scratch1,
1620                                                     Register scratch2) {
1621   if (ProfileInterpreter) {
1622     Label profile_continue;
1623     assert_different_registers(index, mdp, scratch1, scratch2);
1624 
1625     // If no method data exists, go to profile_continue.
1626     test_method_data_pointer(mdp, profile_continue);
1627 
1628     // Build the base (index * per_case_size_in_bytes()) +
1629     // case_array_offset_in_bytes().
1630     z_sllg(index, index, exact_log2(in_bytes(MultiBranchData::per_case_size())));
1631     add2reg(index, in_bytes(MultiBranchData::case_array_offset()));
1632 
1633     // Add the calculated base to the mdp -&gt; address of the case&#39; data.
1634     Address case_data_addr(mdp, index);
1635     Register case_data = scratch1;
1636     load_address(case_data, case_data_addr);
1637 
1638     // Update the case count.
1639     increment_mdp_data_at(case_data,
1640                           in_bytes(MultiBranchData::relative_count_offset()),
1641                           scratch2);
1642 
1643     // The method data pointer needs to be updated.
1644     update_mdp_by_offset(mdp,
1645                          index,
1646                          in_bytes(MultiBranchData::relative_displacement_offset()));
1647 
1648     bind(profile_continue);
1649   }
1650 }
1651 
1652 // kills: R0, R1, flags, loads klass from obj (if not null)
1653 void InterpreterMacroAssembler::profile_obj_type(Register obj, Address mdo_addr, Register klass, bool cmp_done) {
1654   NearLabel null_seen, init_klass, do_nothing, do_update;
1655 
1656   // Klass = obj is allowed.
1657   const Register tmp = Z_R1;
1658   assert_different_registers(obj, mdo_addr.base(), tmp, Z_R0);
1659   assert_different_registers(klass, mdo_addr.base(), tmp, Z_R0);
1660 
1661   z_lg(tmp, mdo_addr);
1662   if (cmp_done) {
1663     z_brz(null_seen);
1664   } else {
1665     compareU64_and_branch(obj, (intptr_t)0, Assembler::bcondEqual, null_seen);
1666   }
1667 
1668   MacroAssembler::verify_oop(obj, FILE_AND_LINE);
1669   load_klass(klass, obj);
1670 
1671   // Klass seen before, nothing to do (regardless of unknown bit).
1672   z_lgr(Z_R0, tmp);
1673   assert(Immediate::is_uimm(~TypeEntries::type_klass_mask, 16), &quot;or change following instruction&quot;);
1674   z_nill(Z_R0, TypeEntries::type_klass_mask &amp; 0xFFFF);
1675   compareU64_and_branch(Z_R0, klass, Assembler::bcondEqual, do_nothing);
1676 
1677   // Already unknown. Nothing to do anymore.
1678   z_tmll(tmp, TypeEntries::type_unknown);
1679   z_brc(Assembler::bcondAllOne, do_nothing);
1680 
1681   z_lgr(Z_R0, tmp);
1682   assert(Immediate::is_uimm(~TypeEntries::type_mask, 16), &quot;or change following instruction&quot;);
1683   z_nill(Z_R0, TypeEntries::type_mask &amp; 0xFFFF);
1684   compareU64_and_branch(Z_R0, (intptr_t)0, Assembler::bcondEqual, init_klass);
1685 
1686   // Different than before. Cannot keep accurate profile.
1687   z_oill(tmp, TypeEntries::type_unknown);
1688   z_bru(do_update);
1689 
1690   bind(init_klass);
1691   // Combine klass and null_seen bit (only used if (tmp &amp; type_mask)==0).
1692   z_ogr(tmp, klass);
1693   z_bru(do_update);
1694 
1695   bind(null_seen);
1696   // Set null_seen if obj is 0.
1697   z_oill(tmp, TypeEntries::null_seen);
1698   // fallthru: z_bru(do_update);
1699 
1700   bind(do_update);
1701   z_stg(tmp, mdo_addr);
1702 
1703   bind(do_nothing);
1704 }
1705 
1706 void InterpreterMacroAssembler::profile_arguments_type(Register mdp, Register callee, Register tmp, bool is_virtual) {
1707   if (!ProfileInterpreter) {
1708     return;
1709   }
1710 
1711   assert_different_registers(mdp, callee, tmp);
1712 
1713   if (MethodData::profile_arguments() || MethodData::profile_return()) {
1714     Label profile_continue;
1715 
1716     test_method_data_pointer(mdp, profile_continue);
1717 
1718     int off_to_start = is_virtual ? in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
1719 
1720     z_cliy(in_bytes(DataLayout::tag_offset()) - off_to_start, mdp,
1721            is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag);
1722     z_brne(profile_continue);
1723 
1724     if (MethodData::profile_arguments()) {
1725       NearLabel done;
1726       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
1727       add2reg(mdp, off_to_args);
1728 
1729       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
1730         if (i &gt; 0 || MethodData::profile_return()) {
1731           // If return value type is profiled we may have no argument to profile.
1732           z_lg(tmp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args, mdp);
1733           add2reg(tmp, -i*TypeStackSlotEntries::per_arg_count());
1734           compare64_and_branch(tmp, TypeStackSlotEntries::per_arg_count(), Assembler::bcondLow, done);
1735         }
1736         z_lg(tmp, Address(callee, Method::const_offset()));
1737         z_lgh(tmp, Address(tmp, ConstMethod::size_of_parameters_offset()));
1738         // Stack offset o (zero based) from the start of the argument
1739         // list. For n arguments translates into offset n - o - 1 from
1740         // the end of the argument list. But there is an extra slot at
1741         // the top of the stack. So the offset is n - o from Lesp.
1742         z_sg(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))-off_to_args));
1743         z_sllg(tmp, tmp, Interpreter::logStackElementSize);
1744         Address stack_slot_addr(tmp, Z_esp);
1745         z_ltg(tmp, stack_slot_addr);
1746 
1747         Address mdo_arg_addr(mdp, in_bytes(TypeEntriesAtCall::argument_type_offset(i))-off_to_args);
1748         profile_obj_type(tmp, mdo_arg_addr, tmp, /*ltg did compare to 0*/ true);
1749 
1750         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
1751         add2reg(mdp, to_add);
1752         off_to_args += to_add;
1753       }
1754 
1755       if (MethodData::profile_return()) {
1756         z_lg(tmp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args, mdp);
1757         add2reg(tmp, -TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count());
1758       }
1759 
1760       bind(done);
1761 
1762       if (MethodData::profile_return()) {
1763         // We&#39;re right after the type profile for the last
1764         // argument. Tmp is the number of cells left in the
1765         // CallTypeData/VirtualCallTypeData to reach its end. Non null
1766         // if there&#39;s a return to profile.
1767         assert(SingleTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(), &quot;can&#39;t move past ret type&quot;);
1768         z_sllg(tmp, tmp, exact_log2(DataLayout::cell_size));
1769         z_agr(mdp, tmp);
1770       }
1771       z_stg(mdp, _z_ijava_state_neg(mdx), Z_fp);
1772     } else {
1773       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
1774       update_mdp_by_constant(mdp, in_bytes(TypeEntriesAtCall::return_only_size()));
1775     }
1776 
1777     // Mdp points right after the end of the
1778     // CallTypeData/VirtualCallTypeData, right after the cells for the
1779     // return value type if there&#39;s one.
1780     bind(profile_continue);
1781   }
1782 }
1783 
1784 void InterpreterMacroAssembler::profile_return_type(Register mdp, Register ret, Register tmp) {
1785   assert_different_registers(mdp, ret, tmp);
1786   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
1787     Label profile_continue;
1788 
1789     test_method_data_pointer(mdp, profile_continue);
1790 
1791     if (MethodData::profile_return_jsr292_only()) {
1792       // If we don&#39;t profile all invoke bytecodes we must make sure
1793       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
1794       // beginning of the ProfileData we intend to update to check its
1795       // type because we&#39;re right after it and we don&#39;t known its
1796       // length.
1797       NearLabel do_profile;
1798       Address bc(Z_bcp);
1799       z_lb(tmp, bc);
1800       compare32_and_branch(tmp, Bytecodes::_invokedynamic, Assembler::bcondEqual, do_profile);
1801       compare32_and_branch(tmp, Bytecodes::_invokehandle, Assembler::bcondEqual, do_profile);
1802       get_method(tmp);
1803       // Supplement to 8139891: _intrinsic_id exceeded 1-byte size limit.
1804       if (Method::intrinsic_id_size_in_bytes() == 1) {
1805         z_cli(Method::intrinsic_id_offset_in_bytes(), tmp, vmIntrinsics::_compiledLambdaForm);
1806       } else {
1807         assert(Method::intrinsic_id_size_in_bytes() == 2, &quot;size error: check Method::_intrinsic_id&quot;);
1808         z_lh(tmp, Method::intrinsic_id_offset_in_bytes(), Z_R0, tmp);
1809         z_chi(tmp, vmIntrinsics::_compiledLambdaForm);
1810       }
1811       z_brne(profile_continue);
1812 
1813       bind(do_profile);
1814     }
1815 
1816     Address mdo_ret_addr(mdp, -in_bytes(SingleTypeEntry::size()));
1817     profile_obj_type(ret, mdo_ret_addr, tmp);
1818 
1819     bind(profile_continue);
1820   }
1821 }
1822 
1823 void InterpreterMacroAssembler::profile_parameters_type(Register mdp, Register tmp1, Register tmp2) {
1824   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
1825     Label profile_continue, done;
1826 
1827     test_method_data_pointer(mdp, profile_continue);
1828 
1829     // Load the offset of the area within the MDO used for
1830     // parameters. If it&#39;s negative we&#39;re not profiling any parameters.
1831     Address parm_di_addr(mdp, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset()));
1832     load_and_test_int2long(tmp1, parm_di_addr);
1833     z_brl(profile_continue);
1834 
1835     // Compute a pointer to the area for parameters from the offset
1836     // and move the pointer to the slot for the last
1837     // parameters. Collect profiling from last parameter down.
1838     // mdo start + parameters offset + array length - 1
1839 
1840     // Pointer to the parameter area in the MDO.
1841     z_agr(mdp, tmp1);
1842 
1843     // Offset of the current profile entry to update.
1844     const Register entry_offset = tmp1;
1845     // entry_offset = array len in number of cells.
1846     z_lg(entry_offset, Address(mdp, ArrayData::array_len_offset()));
1847     // entry_offset (number of cells) = array len - size of 1 entry
1848     add2reg(entry_offset, -TypeStackSlotEntries::per_arg_count());
1849     // entry_offset in bytes
1850     z_sllg(entry_offset, entry_offset, exact_log2(DataLayout::cell_size));
1851 
1852     Label loop;
1853     bind(loop);
1854 
1855     Address arg_off(mdp, entry_offset, ParametersTypeData::stack_slot_offset(0));
1856     Address arg_type(mdp, entry_offset, ParametersTypeData::type_offset(0));
1857 
1858     // Load offset on the stack from the slot for this parameter.
1859     z_lg(tmp2, arg_off);
1860     z_sllg(tmp2, tmp2, Interpreter::logStackElementSize);
1861     z_lcgr(tmp2); // Negate.
1862 
1863     // Profile the parameter.
1864     z_ltg(tmp2, Address(Z_locals, tmp2));
1865     profile_obj_type(tmp2, arg_type, tmp2, /*ltg did compare to 0*/ true);
1866 
1867     // Go to next parameter.
1868     z_aghi(entry_offset, -TypeStackSlotEntries::per_arg_count() * DataLayout::cell_size);
1869     z_brnl(loop);
1870 
1871     bind(profile_continue);
1872   }
1873 }
1874 
1875 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
1876 void InterpreterMacroAssembler::increment_mask_and_jump(Address          counter_addr,
1877                                                         int              increment,
1878                                                         Address          mask,
1879                                                         Register         scratch,
1880                                                         bool             preloaded,
1881                                                         branch_condition cond,
1882                                                         Label           *where) {
1883   assert_different_registers(counter_addr.base(), scratch);
1884   if (preloaded) {
1885     add2reg(scratch, increment);
1886     reg2mem_opt(scratch, counter_addr, false);
1887   } else {
1888     if (VM_Version::has_MemWithImmALUOps() &amp;&amp; Immediate::is_simm8(increment) &amp;&amp; counter_addr.is_RSYform()) {
1889       z_alsi(counter_addr.disp20(), counter_addr.base(), increment);
1890       mem2reg_signed_opt(scratch, counter_addr);
1891     } else {
1892       mem2reg_signed_opt(scratch, counter_addr);
1893       add2reg(scratch, increment);
1894       reg2mem_opt(scratch, counter_addr, false);
1895     }
1896   }
1897   z_n(scratch, mask);
1898   if (where) { z_brc(cond, *where); }
1899 }
1900 
1901 // Get MethodCounters object for given method. Lazily allocated if necessary.
1902 //   method    - Ptr to Method object.
1903 //   Rcounters - Ptr to MethodCounters object associated with Method object.
1904 //   skip      - Exit point if MethodCounters object can&#39;t be created (OOM condition).
1905 void InterpreterMacroAssembler::get_method_counters(Register Rmethod,
1906                                                     Register Rcounters,
1907                                                     Label&amp; skip) {
1908   assert_different_registers(Rmethod, Rcounters);
1909 
1910   BLOCK_COMMENT(&quot;get MethodCounters object {&quot;);
1911 
1912   Label has_counters;
1913   load_and_test_long(Rcounters, Address(Rmethod, Method::method_counters_offset()));
1914   z_brnz(has_counters);
1915 
1916   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::build_method_counters), Rmethod);
1917   z_ltgr(Rcounters, Z_RET); // Runtime call returns MethodCounters object.
1918   z_brz(skip); // No MethodCounters, out of memory.
1919 
1920   bind(has_counters);
1921 
1922   BLOCK_COMMENT(&quot;} get MethodCounters object&quot;);
1923 }
1924 
1925 // Increment invocation counter in MethodCounters object.
1926 // Return (invocation_counter+backedge_counter) as &quot;result&quot; in RctrSum.
1927 // Counter values are all unsigned.
1928 void InterpreterMacroAssembler::increment_invocation_counter(Register Rcounters, Register RctrSum) {
1929   assert(UseCompiler || LogTouchedMethods, &quot;incrementing must be useful&quot;);
1930   assert_different_registers(Rcounters, RctrSum);
1931 
1932   int increment          = InvocationCounter::count_increment;
1933   int inv_counter_offset = in_bytes(MethodCounters::invocation_counter_offset() + InvocationCounter::counter_offset());
1934   int be_counter_offset  = in_bytes(MethodCounters::backedge_counter_offset()   + InvocationCounter::counter_offset());
1935 
1936   BLOCK_COMMENT(&quot;Increment invocation counter {&quot;);
1937 
1938   if (VM_Version::has_MemWithImmALUOps() &amp;&amp; Immediate::is_simm8(increment)) {
1939     // Increment the invocation counter in place,
1940     // then add the incremented value to the backedge counter.
1941     z_l(RctrSum, be_counter_offset, Rcounters);
1942     z_alsi(inv_counter_offset, Rcounters, increment);     // Atomic increment @no extra cost!
1943     z_nilf(RctrSum, InvocationCounter::count_mask_value); // Mask off state bits.
1944     z_al(RctrSum, inv_counter_offset, Z_R0, Rcounters);
1945   } else {
1946     // This path is optimized for low register consumption
1947     // at the cost of somewhat higher operand delays.
1948     // It does not need an extra temp register.
1949 
1950     // Update the invocation counter.
1951     z_l(RctrSum, inv_counter_offset, Rcounters);
1952     if (RctrSum == Z_R0) {
1953       z_ahi(RctrSum, increment);
1954     } else {
1955       add2reg(RctrSum, increment);
1956     }
1957     z_st(RctrSum, inv_counter_offset, Rcounters);
1958 
1959     // Mask off the state bits.
1960     z_nilf(RctrSum, InvocationCounter::count_mask_value);
1961 
1962     // Add the backedge counter to the updated invocation counter to
1963     // form the result.
1964     z_al(RctrSum, be_counter_offset, Z_R0, Rcounters);
1965   }
1966 
1967   BLOCK_COMMENT(&quot;} Increment invocation counter&quot;);
1968 
1969   // Note that this macro must leave the backedge_count + invocation_count in Rtmp!
1970 }
1971 
1972 
1973 // increment backedge counter in MethodCounters object.
1974 // return (invocation_counter+backedge_counter) as &quot;result&quot; in RctrSum
1975 // counter values are all unsigned!
1976 void InterpreterMacroAssembler::increment_backedge_counter(Register Rcounters, Register RctrSum) {
1977   assert(UseCompiler, &quot;incrementing must be useful&quot;);
1978   assert_different_registers(Rcounters, RctrSum);
1979 
1980   int increment          = InvocationCounter::count_increment;
1981   int inv_counter_offset = in_bytes(MethodCounters::invocation_counter_offset() + InvocationCounter::counter_offset());
1982   int be_counter_offset  = in_bytes(MethodCounters::backedge_counter_offset()   + InvocationCounter::counter_offset());
1983 
1984   BLOCK_COMMENT(&quot;Increment backedge counter {&quot;);
1985 
1986   if (VM_Version::has_MemWithImmALUOps() &amp;&amp; Immediate::is_simm8(increment)) {
1987     // Increment the invocation counter in place,
1988     // then add the incremented value to the backedge counter.
1989     z_l(RctrSum, inv_counter_offset, Rcounters);
1990     z_alsi(be_counter_offset, Rcounters, increment);      // Atomic increment @no extra cost!
1991     z_nilf(RctrSum, InvocationCounter::count_mask_value); // Mask off state bits.
1992     z_al(RctrSum, be_counter_offset, Z_R0, Rcounters);
1993   } else {
1994     // This path is optimized for low register consumption
1995     // at the cost of somewhat higher operand delays.
1996     // It does not need an extra temp register.
1997 
1998     // Update the invocation counter.
1999     z_l(RctrSum, be_counter_offset, Rcounters);
2000     if (RctrSum == Z_R0) {
2001       z_ahi(RctrSum, increment);
2002     } else {
2003       add2reg(RctrSum, increment);
2004     }
2005     z_st(RctrSum, be_counter_offset, Rcounters);
2006 
2007     // Mask off the state bits.
2008     z_nilf(RctrSum, InvocationCounter::count_mask_value);
2009 
2010     // Add the backedge counter to the updated invocation counter to
2011     // form the result.
2012     z_al(RctrSum, inv_counter_offset, Z_R0, Rcounters);
2013   }
2014 
2015   BLOCK_COMMENT(&quot;} Increment backedge counter&quot;);
2016 
2017   // Note that this macro must leave the backedge_count + invocation_count in Rtmp!
2018 }
2019 
2020 // Add an InterpMonitorElem to stack (see frame_s390.hpp).
2021 void InterpreterMacroAssembler::add_monitor_to_stack(bool     stack_is_empty,
2022                                                      Register Rtemp1,
2023                                                      Register Rtemp2,
2024                                                      Register Rtemp3) {
2025 
2026   const Register Rcurr_slot = Rtemp1;
2027   const Register Rlimit     = Rtemp2;
2028   const jint delta = -frame::interpreter_frame_monitor_size() * wordSize;
2029 
2030   assert((delta &amp; LongAlignmentMask) == 0,
2031          &quot;sizeof BasicObjectLock must be even number of doublewords&quot;);
2032   assert(2 * wordSize == -delta, &quot;this works only as long as delta == -2*wordSize&quot;);
2033   assert(Rcurr_slot != Z_R0, &quot;Register must be usable as base register&quot;);
2034   assert_different_registers(Rlimit, Rcurr_slot, Rtemp3);
2035 
2036   get_monitors(Rlimit);
2037 
2038   // Adjust stack pointer for additional monitor entry.
2039   resize_frame(RegisterOrConstant((intptr_t) delta), Z_fp, false);
2040 
2041   if (!stack_is_empty) {
2042     // Must copy stack contents down.
2043     NearLabel next, done;
2044 
2045     // Rtemp := addr(Tos), Z_esp is pointing below it!
2046     add2reg(Rcurr_slot, wordSize, Z_esp);
2047 
2048     // Nothing to do, if already at monitor area.
2049     compareU64_and_branch(Rcurr_slot, Rlimit, bcondNotLow, done);
2050 
2051     bind(next);
2052 
2053     // Move one stack slot.
2054     mem2reg_opt(Rtemp3, Address(Rcurr_slot));
2055     reg2mem_opt(Rtemp3, Address(Rcurr_slot, delta));
2056     add2reg(Rcurr_slot, wordSize);
2057     compareU64_and_branch(Rcurr_slot, Rlimit, bcondLow, next); // Are we done?
2058 
2059     bind(done);
2060     // Done copying stack.
2061   }
2062 
2063   // Adjust expression stack and monitor pointers.
2064   add2reg(Z_esp, delta);
2065   add2reg(Rlimit, delta);
2066   save_monitors(Rlimit);
2067 }
2068 
2069 // Note: Index holds the offset in bytes afterwards.
2070 // You can use this to store a new value (with Llocals as the base).
2071 void InterpreterMacroAssembler::access_local_int(Register index, Register dst) {
2072   z_sllg(index, index, LogBytesPerWord);
2073   mem2reg_opt(dst, Address(Z_locals, index), false);
2074 }
2075 
2076 void InterpreterMacroAssembler::verify_oop(Register reg, TosState state) {
2077   if (state == atos) { MacroAssembler::verify_oop(reg, FILE_AND_LINE); }
2078 }
2079 
2080 // Inline assembly for:
2081 //
2082 // if (thread is in interp_only_mode) {
2083 //   InterpreterRuntime::post_method_entry();
2084 // }
2085 
2086 void InterpreterMacroAssembler::notify_method_entry() {
2087 
2088   // JVMTI
2089   // Whenever JVMTI puts a thread in interp_only_mode, method
2090   // entry/exit events are sent for that thread to track stack
2091   // depth. If it is possible to enter interp_only_mode we add
2092   // the code to check if the event should be sent.
2093   if (JvmtiExport::can_post_interpreter_events()) {
2094     Label jvmti_post_done;
2095     MacroAssembler::load_and_test_int(Z_R0, Address(Z_thread, JavaThread::interp_only_mode_offset()));
2096     z_bre(jvmti_post_done);
2097     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_entry));
2098     bind(jvmti_post_done);
2099   }
2100 }
2101 
2102 // Inline assembly for:
2103 //
2104 // if (thread is in interp_only_mode) {
2105 //   if (!native_method) save result
2106 //   InterpreterRuntime::post_method_exit();
2107 //   if (!native_method) restore result
2108 // }
2109 // if (DTraceMethodProbes) {
2110 //   SharedRuntime::dtrace_method_exit(thread, method);
2111 // }
2112 //
2113 // For native methods their result is stored in z_ijava_state.lresult
2114 // and z_ijava_state.fresult before coming here.
2115 // Java methods have their result stored in the expression stack.
2116 //
2117 // Notice the dependency to frame::interpreter_frame_result().
2118 void InterpreterMacroAssembler::notify_method_exit(bool native_method,
2119                                                    TosState state,
2120                                                    NotifyMethodExitMode mode) {
2121   // JVMTI
2122   // Whenever JVMTI puts a thread in interp_only_mode, method
2123   // entry/exit events are sent for that thread to track stack
2124   // depth. If it is possible to enter interp_only_mode we add
2125   // the code to check if the event should be sent.
2126   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
2127     Label jvmti_post_done;
2128     MacroAssembler::load_and_test_int(Z_R0, Address(Z_thread, JavaThread::interp_only_mode_offset()));
2129     z_bre(jvmti_post_done);
2130     if (!native_method) push(state); // see frame::interpreter_frame_result()
2131     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
2132     if (!native_method) pop(state);
2133     bind(jvmti_post_done);
2134   }
2135 
2136 #if 0
2137   // Dtrace currently not supported on z/Architecture.
2138   {
2139     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2140     push(state);
2141     get_method(c_rarg1);
2142     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit),
2143                  r15_thread, c_rarg1);
2144     pop(state);
2145   }
2146 #endif
2147 }
2148 
2149 void InterpreterMacroAssembler::skip_if_jvmti_mode(Label &amp;Lskip, Register Rscratch) {
2150   if (!JvmtiExport::can_post_interpreter_events()) {
2151     return;
2152   }
2153 
2154   load_and_test_int(Rscratch, Address(Z_thread, JavaThread::interp_only_mode_offset()));
2155   z_brnz(Lskip);
2156 
2157 }
2158 
2159 // Pop the topmost TOP_IJAVA_FRAME and set it&#39;s sender_sp as new Z_SP.
2160 // The return pc is loaded into the register return_pc.
2161 //
2162 // Registers updated:
2163 //     return_pc  - The return pc of the calling frame.
2164 //     tmp1, tmp2 - scratch
2165 void InterpreterMacroAssembler::pop_interpreter_frame(Register return_pc, Register tmp1, Register tmp2) {
2166   // F0  Z_SP -&gt; caller_sp (F1&#39;s)
2167   //             ...
2168   //             sender_sp (F1&#39;s)
2169   //             ...
2170   // F1  Z_fp -&gt; caller_sp (F2&#39;s)
2171   //             return_pc (Continuation after return from F0.)
2172   //             ...
2173   // F2          caller_sp
2174 
2175   // Remove F0&#39;s activation. Restoring Z_SP to sender_sp reverts modifications
2176   // (a) by a c2i adapter and (b) by generate_fixed_frame().
2177   // In case (a) the new top frame F1 is an unextended compiled frame.
2178   // In case (b) F1 is converted from PARENT_IJAVA_FRAME to TOP_IJAVA_FRAME.
2179 
2180   // Case (b) seems to be redundant when returning to a interpreted caller,
2181   // because then the caller&#39;s top_frame_sp is installed as sp (see
2182   // TemplateInterpreterGenerator::generate_return_entry_for ()). But
2183   // pop_interpreter_frame() is also used in exception handling and there the
2184   // frame type of the caller is unknown, therefore top_frame_sp cannot be used,
2185   // so it is important that sender_sp is the caller&#39;s sp as TOP_IJAVA_FRAME.
2186 
2187   Register R_f1_sender_sp = tmp1;
2188   Register R_f2_sp = tmp2;
2189 
2190   // First check for the interpreter frame&#39;s magic.
2191   asm_assert_ijava_state_magic(R_f2_sp/*tmp*/);
2192   z_lg(R_f2_sp, _z_parent_ijava_frame_abi(callers_sp), Z_fp);
2193   z_lg(R_f1_sender_sp, _z_ijava_state_neg(sender_sp), Z_fp);
2194   if (return_pc-&gt;is_valid())
2195     z_lg(return_pc, _z_parent_ijava_frame_abi(return_pc), Z_fp);
2196   // Pop F0 by resizing to R_f1_sender_sp and using R_f2_sp as fp.
2197   resize_frame_absolute(R_f1_sender_sp, R_f2_sp, false/*load fp*/);
2198 
2199 #ifdef ASSERT
2200   // The return_pc in the new top frame is dead... at least that&#39;s my
2201   // current understanding; to assert this I overwrite it.
2202   load_const_optimized(Z_ARG3, 0xb00b1);
2203   z_stg(Z_ARG3, _z_parent_ijava_frame_abi(return_pc), Z_SP);
2204 #endif
2205 }
2206 
2207 void InterpreterMacroAssembler::verify_FPU(int stack_depth, TosState state) {
2208   if (VerifyFPU) {
2209     unimplemented(&quot;verfiyFPU&quot;);
2210   }
2211 }
    </pre>
  </body>
</html>