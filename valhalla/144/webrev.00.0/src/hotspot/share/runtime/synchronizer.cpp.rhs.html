<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/synchronizer.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;logging/log.hpp&quot;
  28 #include &quot;logging/logStream.hpp&quot;
  29 #include &quot;jfr/jfrEvents.hpp&quot;
  30 #include &quot;memory/allocation.inline.hpp&quot;
  31 #include &quot;memory/metaspaceShared.hpp&quot;
  32 #include &quot;memory/padded.hpp&quot;
  33 #include &quot;memory/resourceArea.hpp&quot;
  34 #include &quot;memory/universe.hpp&quot;
  35 #include &quot;oops/markWord.hpp&quot;
  36 #include &quot;oops/oop.inline.hpp&quot;
  37 #include &quot;runtime/atomic.hpp&quot;
  38 #include &quot;runtime/biasedLocking.hpp&quot;
  39 #include &quot;runtime/handles.inline.hpp&quot;
  40 #include &quot;runtime/handshake.hpp&quot;
  41 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  42 #include &quot;runtime/mutexLocker.hpp&quot;
  43 #include &quot;runtime/objectMonitor.hpp&quot;
  44 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  45 #include &quot;runtime/osThread.hpp&quot;
  46 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  47 #include &quot;runtime/safepointVerifiers.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 #include &quot;runtime/stubRoutines.hpp&quot;
  50 #include &quot;runtime/synchronizer.hpp&quot;
  51 #include &quot;runtime/thread.inline.hpp&quot;
  52 #include &quot;runtime/timer.hpp&quot;
  53 #include &quot;runtime/vframe.hpp&quot;
  54 #include &quot;runtime/vmThread.hpp&quot;
  55 #include &quot;utilities/align.hpp&quot;
  56 #include &quot;utilities/dtrace.hpp&quot;
  57 #include &quot;utilities/events.hpp&quot;
  58 #include &quot;utilities/preserveException.hpp&quot;
  59 
  60 // The &quot;core&quot; versions of monitor enter and exit reside in this file.
  61 // The interpreter and compilers contain specialized transliterated
  62 // variants of the enter-exit fast-path operations.  See i486.ad fast_lock(),
  63 // for instance.  If you make changes here, make sure to modify the
  64 // interpreter, and both C1 and C2 fast-path inline locking code emission.
  65 //
  66 // -----------------------------------------------------------------------------
  67 
  68 #ifdef DTRACE_ENABLED
  69 
  70 // Only bother with this argument setup if dtrace is available
  71 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  72 
  73 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  74   char* bytes = NULL;                                                      \
  75   int len = 0;                                                             \
  76   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  77   Symbol* klassname = ((oop)(obj))-&gt;klass()-&gt;name();                       \
  78   if (klassname != NULL) {                                                 \
  79     bytes = (char*)klassname-&gt;bytes();                                     \
  80     len = klassname-&gt;utf8_length();                                        \
  81   }
  82 
  83 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  84   {                                                                        \
  85     if (DTraceMonitorProbes) {                                             \
  86       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  87       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  88                            (uintptr_t)(monitor), bytes, len, (millis));    \
  89     }                                                                      \
  90   }
  91 
  92 #define HOTSPOT_MONITOR_PROBE_notify HOTSPOT_MONITOR_NOTIFY
  93 #define HOTSPOT_MONITOR_PROBE_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  94 #define HOTSPOT_MONITOR_PROBE_waited HOTSPOT_MONITOR_WAITED
  95 
  96 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  97   {                                                                        \
  98     if (DTraceMonitorProbes) {                                             \
  99       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
 100       HOTSPOT_MONITOR_PROBE_##probe(jtid, /* probe = waited */             \
 101                                     (uintptr_t)(monitor), bytes, len);     \
 102     }                                                                      \
 103   }
 104 
 105 #else //  ndef DTRACE_ENABLED
 106 
 107 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
 108 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
 109 
 110 #endif // ndef DTRACE_ENABLED
 111 
 112 // This exists only as a workaround of dtrace bug 6254741
 113 int dtrace_waited_probe(ObjectMonitor* monitor, Handle obj, Thread* thr) {
 114   DTRACE_MONITOR_PROBE(waited, monitor, obj(), thr);
 115   return 0;
 116 }
 117 
 118 #define NINFLATIONLOCKS 256
 119 static volatile intptr_t gInflationLocks[NINFLATIONLOCKS];
 120 
 121 // global list of blocks of monitors
 122 PaddedObjectMonitor* ObjectSynchronizer::g_block_list = NULL;
 123 bool volatile ObjectSynchronizer::_is_async_deflation_requested = false;
<a name="1" id="anc1"></a>
 124 jlong ObjectSynchronizer::_last_async_deflation_time_ns = 0;
 125 
 126 struct ObjectMonitorListGlobals {
 127   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 128   // These are highly shared list related variables.
 129   // To avoid false-sharing they need to be the sole occupants of a cache line.
 130 
 131   // Global ObjectMonitor free list. Newly allocated and deflated
 132   // ObjectMonitors are prepended here.
 133   ObjectMonitor* _free_list;
 134   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 135 
 136   // Global ObjectMonitor in-use list. When a JavaThread is exiting,
 137   // ObjectMonitors on its per-thread in-use list are prepended here.
 138   ObjectMonitor* _in_use_list;
 139   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 140 
 141   // Global ObjectMonitor wait list. Deflated ObjectMonitors wait on
 142   // this list until after a handshake or a safepoint for platforms
 143   // that don&#39;t support handshakes. After the handshake or safepoint,
 144   // the deflated ObjectMonitors are prepended to free_list.
 145   ObjectMonitor* _wait_list;
 146   DEFINE_PAD_MINUS_SIZE(3, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 147 
 148   int _free_count;    // # on free_list
 149   DEFINE_PAD_MINUS_SIZE(4, OM_CACHE_LINE_SIZE, sizeof(int));
 150 
 151   int _in_use_count;  // # on in_use_list
 152   DEFINE_PAD_MINUS_SIZE(5, OM_CACHE_LINE_SIZE, sizeof(int));
 153 
 154   int _population;    // # Extant -- in circulation
 155   DEFINE_PAD_MINUS_SIZE(6, OM_CACHE_LINE_SIZE, sizeof(int));
 156 
 157   int _wait_count;    // # on wait_list
 158   DEFINE_PAD_MINUS_SIZE(7, OM_CACHE_LINE_SIZE, sizeof(int));
 159 };
 160 static ObjectMonitorListGlobals om_list_globals;
 161 
 162 #define CHECK_THROW_NOSYNC_IMSE(obj)  \
 163   if ((obj)-&gt;mark().is_always_locked()) {  \
 164     ResourceMark rm(THREAD);                \
 165     THROW_MSG(vmSymbols::java_lang_IllegalMonitorStateException(), obj-&gt;klass()-&gt;external_name()); \
 166   }
 167 
 168 #define CHECK_THROW_NOSYNC_IMSE_0(obj)  \
 169     if ((obj)-&gt;mark().is_always_locked()) {  \
 170     ResourceMark rm(THREAD);                  \
 171     THROW_MSG_0(vmSymbols::java_lang_IllegalMonitorStateException(), obj-&gt;klass()-&gt;external_name()); \
 172   }
 173 
 174 
 175 #define CHAINMARKER (cast_to_oop&lt;intptr_t&gt;(-1))
 176 
 177 
 178 // =====================&gt; Spin-lock functions
 179 
 180 // ObjectMonitors are not lockable outside of this file. We use spin-locks
 181 // implemented using a bit in the _next_om field instead of the heavier
 182 // weight locking mechanisms for faster list management.
 183 
 184 #define OM_LOCK_BIT 0x1
 185 
 186 // Return true if the ObjectMonitor is locked.
 187 // Otherwise returns false.
 188 static bool is_locked(ObjectMonitor* om) {
 189   return ((intptr_t)om-&gt;next_om() &amp; OM_LOCK_BIT) == OM_LOCK_BIT;
 190 }
 191 
 192 // Mark an ObjectMonitor* with OM_LOCK_BIT and return it.
 193 static ObjectMonitor* mark_om_ptr(ObjectMonitor* om) {
 194   return (ObjectMonitor*)((intptr_t)om | OM_LOCK_BIT);
 195 }
 196 
 197 // Return the unmarked next field in an ObjectMonitor. Note: the next
 198 // field may or may not have been marked with OM_LOCK_BIT originally.
 199 static ObjectMonitor* unmarked_next(ObjectMonitor* om) {
 200   return (ObjectMonitor*)((intptr_t)om-&gt;next_om() &amp; ~OM_LOCK_BIT);
 201 }
 202 
 203 // Try to lock an ObjectMonitor. Returns true if locking was successful.
 204 // Otherwise returns false.
 205 static bool try_om_lock(ObjectMonitor* om) {
 206   // Get current next field without any OM_LOCK_BIT value.
 207   ObjectMonitor* next = unmarked_next(om);
 208   if (om-&gt;try_set_next_om(next, mark_om_ptr(next)) != next) {
 209     return false;  // Cannot lock the ObjectMonitor.
 210   }
 211   return true;
 212 }
 213 
 214 // Lock an ObjectMonitor.
 215 static void om_lock(ObjectMonitor* om) {
 216   while (true) {
 217     if (try_om_lock(om)) {
 218       return;
 219     }
 220   }
 221 }
 222 
 223 // Unlock an ObjectMonitor.
 224 static void om_unlock(ObjectMonitor* om) {
 225   ObjectMonitor* next = om-&gt;next_om();
 226   guarantee(((intptr_t)next &amp; OM_LOCK_BIT) == OM_LOCK_BIT, &quot;next=&quot; INTPTR_FORMAT
 227             &quot; must have OM_LOCK_BIT=%x set.&quot;, p2i(next), OM_LOCK_BIT);
 228 
 229   next = (ObjectMonitor*)((intptr_t)next &amp; ~OM_LOCK_BIT);  // Clear OM_LOCK_BIT.
 230   om-&gt;set_next_om(next);
 231 }
 232 
 233 // Get the list head after locking it. Returns the list head or NULL
 234 // if the list is empty.
 235 static ObjectMonitor* get_list_head_locked(ObjectMonitor** list_p) {
 236   while (true) {
 237     ObjectMonitor* mid = Atomic::load(list_p);
 238     if (mid == NULL) {
 239       return NULL;  // The list is empty.
 240     }
 241     if (try_om_lock(mid)) {
 242       if (Atomic::load(list_p) != mid) {
 243         // The list head changed before we could lock it so we have to retry.
 244         om_unlock(mid);
 245         continue;
 246       }
 247       return mid;
 248     }
 249   }
 250 }
 251 
 252 #undef OM_LOCK_BIT
 253 
 254 
 255 // =====================&gt; List Management functions
 256 
 257 // Prepend a list of ObjectMonitors to the specified *list_p. &#39;tail&#39; is
 258 // the last ObjectMonitor in the list and there are &#39;count&#39; on the list.
 259 // Also updates the specified *count_p.
 260 static void prepend_list_to_common(ObjectMonitor* list, ObjectMonitor* tail,
 261                                    int count, ObjectMonitor** list_p,
 262                                    int* count_p) {
 263   while (true) {
 264     ObjectMonitor* cur = Atomic::load(list_p);
 265     // Prepend list to *list_p.
 266     if (!try_om_lock(tail)) {
 267       // Failed to lock tail due to a list walker so try it all again.
 268       continue;
 269     }
 270     tail-&gt;set_next_om(cur);  // tail now points to cur (and unlocks tail)
 271     if (cur == NULL) {
 272       // No potential race with takers or other prependers since
 273       // *list_p is empty.
 274       if (Atomic::cmpxchg(list_p, cur, list) == cur) {
 275         // Successfully switched *list_p to the list value.
 276         Atomic::add(count_p, count);
 277         break;
 278       }
 279       // Implied else: try it all again
 280     } else {
 281       if (!try_om_lock(cur)) {
 282         continue;  // failed to lock cur so try it all again
 283       }
 284       // We locked cur so try to switch *list_p to the list value.
 285       if (Atomic::cmpxchg(list_p, cur, list) != cur) {
 286         // The list head has changed so unlock cur and try again:
 287         om_unlock(cur);
 288         continue;
 289       }
 290       Atomic::add(count_p, count);
 291       om_unlock(cur);
 292       break;
 293     }
 294   }
 295 }
 296 
 297 // Prepend a newly allocated block of ObjectMonitors to g_block_list and
 298 // om_list_globals._free_list. Also updates om_list_globals._population
 299 // and om_list_globals._free_count.
 300 void ObjectSynchronizer::prepend_block_to_lists(PaddedObjectMonitor* new_blk) {
 301   // First we handle g_block_list:
 302   while (true) {
 303     PaddedObjectMonitor* cur = Atomic::load(&amp;g_block_list);
 304     // Prepend new_blk to g_block_list. The first ObjectMonitor in
 305     // a block is reserved for use as linkage to the next block.
 306     new_blk[0].set_next_om(cur);
 307     if (Atomic::cmpxchg(&amp;g_block_list, cur, new_blk) == cur) {
 308       // Successfully switched g_block_list to the new_blk value.
 309       Atomic::add(&amp;om_list_globals._population, _BLOCKSIZE - 1);
 310       break;
 311     }
 312     // Implied else: try it all again
 313   }
 314 
 315   // Second we handle om_list_globals._free_list:
 316   prepend_list_to_common(new_blk + 1, &amp;new_blk[_BLOCKSIZE - 1], _BLOCKSIZE - 1,
 317                          &amp;om_list_globals._free_list, &amp;om_list_globals._free_count);
 318 }
 319 
 320 // Prepend a list of ObjectMonitors to om_list_globals._free_list.
 321 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 322 // on the list. Also updates om_list_globals._free_count.
 323 static void prepend_list_to_global_free_list(ObjectMonitor* list,
 324                                              ObjectMonitor* tail, int count) {
 325   prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
 326                          &amp;om_list_globals._free_count);
 327 }
 328 
 329 // Prepend a list of ObjectMonitors to om_list_globals._wait_list.
 330 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 331 // on the list. Also updates om_list_globals._wait_count.
 332 static void prepend_list_to_global_wait_list(ObjectMonitor* list,
 333                                              ObjectMonitor* tail, int count) {
 334   prepend_list_to_common(list, tail, count, &amp;om_list_globals._wait_list,
 335                          &amp;om_list_globals._wait_count);
 336 }
 337 
 338 // Prepend a list of ObjectMonitors to om_list_globals._in_use_list.
 339 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 340 // on the list. Also updates om_list_globals._in_use_list.
 341 static void prepend_list_to_global_in_use_list(ObjectMonitor* list,
 342                                                ObjectMonitor* tail, int count) {
 343   prepend_list_to_common(list, tail, count, &amp;om_list_globals._in_use_list,
 344                          &amp;om_list_globals._in_use_count);
 345 }
 346 
 347 // Prepend an ObjectMonitor to the specified list. Also updates
 348 // the specified counter.
 349 static void prepend_to_common(ObjectMonitor* m, ObjectMonitor** list_p,
 350                               int* count_p) {
 351   while (true) {
 352     om_lock(m);  // Lock m so we can safely update its next field.
 353     ObjectMonitor* cur = NULL;
 354     // Lock the list head to guard against races with a list walker
 355     // or async deflater thread (which only races in om_in_use_list):
 356     if ((cur = get_list_head_locked(list_p)) != NULL) {
 357       // List head is now locked so we can safely switch it.
 358       m-&gt;set_next_om(cur);  // m now points to cur (and unlocks m)
 359       Atomic::store(list_p, m);  // Switch list head to unlocked m.
 360       om_unlock(cur);
 361       break;
 362     }
 363     // The list is empty so try to set the list head.
 364     assert(cur == NULL, &quot;cur must be NULL: cur=&quot; INTPTR_FORMAT, p2i(cur));
 365     m-&gt;set_next_om(cur);  // m now points to NULL (and unlocks m)
 366     if (Atomic::cmpxchg(list_p, cur, m) == cur) {
 367       // List head is now unlocked m.
 368       break;
 369     }
 370     // Implied else: try it all again
 371   }
 372   Atomic::inc(count_p);
 373 }
 374 
 375 // Prepend an ObjectMonitor to a per-thread om_free_list.
 376 // Also updates the per-thread om_free_count.
 377 static void prepend_to_om_free_list(Thread* self, ObjectMonitor* m) {
 378   prepend_to_common(m, &amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 379 }
 380 
 381 // Prepend an ObjectMonitor to a per-thread om_in_use_list.
 382 // Also updates the per-thread om_in_use_count.
 383 static void prepend_to_om_in_use_list(Thread* self, ObjectMonitor* m) {
 384   prepend_to_common(m, &amp;self-&gt;om_in_use_list, &amp;self-&gt;om_in_use_count);
 385 }
 386 
 387 // Take an ObjectMonitor from the start of the specified list. Also
 388 // decrements the specified counter. Returns NULL if none are available.
 389 static ObjectMonitor* take_from_start_of_common(ObjectMonitor** list_p,
 390                                                 int* count_p) {
 391   ObjectMonitor* take = NULL;
 392   // Lock the list head to guard against races with a list walker
 393   // or async deflater thread (which only races in om_list_globals._free_list):
 394   if ((take = get_list_head_locked(list_p)) == NULL) {
 395     return NULL;  // None are available.
 396   }
 397   ObjectMonitor* next = unmarked_next(take);
 398   // Switch locked list head to next (which unlocks the list head, but
 399   // leaves take locked):
 400   Atomic::store(list_p, next);
 401   Atomic::dec(count_p);
 402   // Unlock take, but leave the next value for any lagging list
 403   // walkers. It will get cleaned up when take is prepended to
 404   // the in-use list:
 405   om_unlock(take);
 406   return take;
 407 }
 408 
 409 // Take an ObjectMonitor from the start of the om_list_globals._free_list.
 410 // Also updates om_list_globals._free_count. Returns NULL if none are
 411 // available.
 412 static ObjectMonitor* take_from_start_of_global_free_list() {
 413   return take_from_start_of_common(&amp;om_list_globals._free_list,
 414                                    &amp;om_list_globals._free_count);
 415 }
 416 
 417 // Take an ObjectMonitor from the start of a per-thread free-list.
 418 // Also updates om_free_count. Returns NULL if none are available.
 419 static ObjectMonitor* take_from_start_of_om_free_list(Thread* self) {
 420   return take_from_start_of_common(&amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 421 }
 422 
 423 
 424 // =====================&gt; Quick functions
 425 
 426 // The quick_* forms are special fast-path variants used to improve
 427 // performance.  In the simplest case, a &quot;quick_*&quot; implementation could
 428 // simply return false, in which case the caller will perform the necessary
 429 // state transitions and call the slow-path form.
 430 // The fast-path is designed to handle frequently arising cases in an efficient
 431 // manner and is just a degenerate &quot;optimistic&quot; variant of the slow-path.
 432 // returns true  -- to indicate the call was satisfied.
 433 // returns false -- to indicate the call needs the services of the slow-path.
 434 // A no-loitering ordinance is in effect for code in the quick_* family
 435 // operators: safepoints or indefinite blocking (blocking that might span a
 436 // safepoint) are forbidden. Generally the thread_state() is _in_Java upon
 437 // entry.
 438 //
 439 // Consider: An interesting optimization is to have the JIT recognize the
 440 // following common idiom:
 441 //   synchronized (someobj) { .... ; notify(); }
 442 // That is, we find a notify() or notifyAll() call that immediately precedes
 443 // the monitorexit operation.  In that case the JIT could fuse the operations
 444 // into a single notifyAndExit() runtime primitive.
 445 
 446 bool ObjectSynchronizer::quick_notify(oopDesc* obj, Thread* self, bool all) {
 447   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 448   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 449   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 450   NoSafepointVerifier nsv;
 451   if (obj == NULL) return false;  // slow-path for invalid obj
 452   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 453   const markWord mark = obj-&gt;mark();
 454 
 455   if (mark.has_locker() &amp;&amp; self-&gt;is_lock_owned((address)mark.locker())) {
 456     // Degenerate notify
 457     // stack-locked by caller so by definition the implied waitset is empty.
 458     return true;
 459   }
 460 
 461   if (mark.has_monitor()) {
 462     ObjectMonitor* const mon = mark.monitor();
 463     assert(mon-&gt;object() == obj, &quot;invariant&quot;);
 464     if (mon-&gt;owner() != self) return false;  // slow-path for IMS exception
 465 
 466     if (mon-&gt;first_waiter() != NULL) {
 467       // We have one or more waiters. Since this is an inflated monitor
 468       // that we own, we can transfer one or more threads from the waitset
 469       // to the entrylist here and now, avoiding the slow-path.
 470       if (all) {
 471         DTRACE_MONITOR_PROBE(notifyAll, mon, obj, self);
 472       } else {
 473         DTRACE_MONITOR_PROBE(notify, mon, obj, self);
 474       }
 475       int free_count = 0;
 476       do {
 477         mon-&gt;INotify(self);
 478         ++free_count;
 479       } while (mon-&gt;first_waiter() != NULL &amp;&amp; all);
 480       OM_PERFDATA_OP(Notifications, inc(free_count));
 481     }
 482     return true;
 483   }
 484 
 485   // biased locking and any other IMS exception states take the slow-path
 486   return false;
 487 }
 488 
 489 
 490 // The LockNode emitted directly at the synchronization site would have
 491 // been too big if it were to have included support for the cases of inflated
 492 // recursive enter and exit, so they go here instead.
 493 // Note that we can&#39;t safely call AsyncPrintJavaStack() from within
 494 // quick_enter() as our thread state remains _in_Java.
 495 
 496 bool ObjectSynchronizer::quick_enter(oop obj, Thread* self,
 497                                      BasicLock * lock) {
 498   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 499   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 500   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 501   NoSafepointVerifier nsv;
 502   if (obj == NULL) return false;       // Need to throw NPE
 503   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 504   const markWord mark = obj-&gt;mark();
 505 
 506   if (mark.has_monitor()) {
 507     ObjectMonitor* const m = mark.monitor();
 508     if (AsyncDeflateIdleMonitors) {
 509       // An async deflation can race us before we manage to make the
 510       // ObjectMonitor busy by setting the owner below. If we detect
 511       // that race we just bail out to the slow-path here.
 512       if (m-&gt;object() == NULL) {
 513         return false;
 514       }
 515     } else {
 516       assert(m-&gt;object() == obj, &quot;invariant&quot;);
 517     }
 518     Thread* const owner = (Thread *) m-&gt;_owner;
 519 
 520     // Lock contention and Transactional Lock Elision (TLE) diagnostics
 521     // and observability
 522     // Case: light contention possibly amenable to TLE
 523     // Case: TLE inimical operations such as nested/recursive synchronization
 524 
 525     if (owner == self) {
 526       m-&gt;_recursions++;
 527       return true;
 528     }
 529 
 530     // This Java Monitor is inflated so obj&#39;s header will never be
 531     // displaced to this thread&#39;s BasicLock. Make the displaced header
 532     // non-NULL so this BasicLock is not seen as recursive nor as
 533     // being locked. We do this unconditionally so that this thread&#39;s
 534     // BasicLock cannot be mis-interpreted by any stack walkers. For
 535     // performance reasons, stack walkers generally first check for
 536     // Biased Locking in the object&#39;s header, the second check is for
 537     // stack-locking in the object&#39;s header, the third check is for
 538     // recursive stack-locking in the displaced header in the BasicLock,
 539     // and last are the inflated Java Monitor (ObjectMonitor) checks.
 540     lock-&gt;set_displaced_header(markWord::unused_mark());
 541 
 542     if (owner == NULL &amp;&amp; m-&gt;try_set_owner_from(NULL, self) == NULL) {
 543       assert(m-&gt;_recursions == 0, &quot;invariant&quot;);
 544       return true;
 545     }
 546   }
 547 
 548   // Note that we could inflate in quick_enter.
 549   // This is likely a useful optimization
 550   // Critically, in quick_enter() we must not:
 551   // -- perform bias revocation, or
 552   // -- block indefinitely, or
 553   // -- reach a safepoint
 554 
 555   return false;        // revert to slow-path
 556 }
 557 
 558 // -----------------------------------------------------------------------------
 559 // Monitor Enter/Exit
 560 // The interpreter and compiler assembly code tries to lock using the fast path
 561 // of this algorithm. Make sure to update that code if the following function is
 562 // changed. The implementation is extremely sensitive to race condition. Be careful.
 563 
 564 void ObjectSynchronizer::enter(Handle obj, BasicLock* lock, TRAPS) {
 565   CHECK_THROW_NOSYNC_IMSE(obj);
 566   if (UseBiasedLocking) {
 567     if (!SafepointSynchronize::is_at_safepoint()) {
 568       BiasedLocking::revoke(obj, THREAD);
 569     } else {
 570       BiasedLocking::revoke_at_safepoint(obj);
 571     }
 572   }
 573 
 574   markWord mark = obj-&gt;mark();
 575   assert(!mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 576 
 577   if (mark.is_neutral()) {
 578     // Anticipate successful CAS -- the ST of the displaced mark must
 579     // be visible &lt;= the ST performed by the CAS.
 580     lock-&gt;set_displaced_header(mark);
 581     if (mark == obj()-&gt;cas_set_mark(markWord::from_pointer(lock), mark)) {
 582       return;
 583     }
 584     // Fall through to inflate() ...
 585   } else if (mark.has_locker() &amp;&amp;
 586              THREAD-&gt;is_lock_owned((address)mark.locker())) {
 587     assert(lock != mark.locker(), &quot;must not re-lock the same lock&quot;);
 588     assert(lock != (BasicLock*)obj-&gt;mark().value(), &quot;don&#39;t relock with same BasicLock&quot;);
 589     lock-&gt;set_displaced_header(markWord::from_pointer(NULL));
 590     return;
 591   }
 592 
 593   // The object header will never be displaced to this lock,
 594   // so it does not matter what the value is, except that it
 595   // must be non-zero to avoid looking like a re-entrant lock,
 596   // and must not look locked either.
 597   lock-&gt;set_displaced_header(markWord::unused_mark());
 598   // An async deflation can race after the inflate() call and before
 599   // enter() can make the ObjectMonitor busy. enter() returns false if
 600   // we have lost the race to async deflation and we simply try again.
 601   while (true) {
 602     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_monitor_enter);
 603     if (monitor-&gt;enter(THREAD)) {
 604       return;
 605     }
 606   }
 607 }
 608 
 609 void ObjectSynchronizer::exit(oop object, BasicLock* lock, TRAPS) {
 610   markWord mark = object-&gt;mark();
 611   if (EnableValhalla &amp;&amp; mark.is_always_locked()) {
 612     return;
 613   }
 614   assert(!EnableValhalla || !object-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 615   // We cannot check for Biased Locking if we are racing an inflation.
 616   assert(mark == markWord::INFLATING() ||
 617          !mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 618 
 619   markWord dhw = lock-&gt;displaced_header();
 620   if (dhw.value() == 0) {
 621     // If the displaced header is NULL, then this exit matches up with
 622     // a recursive enter. No real work to do here except for diagnostics.
 623 #ifndef PRODUCT
 624     if (mark != markWord::INFLATING()) {
 625       // Only do diagnostics if we are not racing an inflation. Simply
 626       // exiting a recursive enter of a Java Monitor that is being
 627       // inflated is safe; see the has_monitor() comment below.
 628       assert(!mark.is_neutral(), &quot;invariant&quot;);
 629       assert(!mark.has_locker() ||
 630              THREAD-&gt;is_lock_owned((address)mark.locker()), &quot;invariant&quot;);
 631       if (mark.has_monitor()) {
 632         // The BasicLock&#39;s displaced_header is marked as a recursive
 633         // enter and we have an inflated Java Monitor (ObjectMonitor).
 634         // This is a special case where the Java Monitor was inflated
 635         // after this thread entered the stack-lock recursively. When a
 636         // Java Monitor is inflated, we cannot safely walk the Java
 637         // Monitor owner&#39;s stack and update the BasicLocks because a
 638         // Java Monitor can be asynchronously inflated by a thread that
 639         // does not own the Java Monitor.
 640         ObjectMonitor* m = mark.monitor();
 641         assert(((oop)(m-&gt;object()))-&gt;mark() == mark, &quot;invariant&quot;);
 642         assert(m-&gt;is_entered(THREAD), &quot;invariant&quot;);
 643       }
 644     }
 645 #endif
 646     return;
 647   }
 648 
 649   if (mark == markWord::from_pointer(lock)) {
 650     // If the object is stack-locked by the current thread, try to
 651     // swing the displaced header from the BasicLock back to the mark.
 652     assert(dhw.is_neutral(), &quot;invariant&quot;);
 653     if (object-&gt;cas_set_mark(dhw, mark) == mark) {
 654       return;
 655     }
 656   }
 657 
 658   // We have to take the slow-path of possible inflation and then exit.
 659   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 660   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 661   ObjectMonitor* monitor = inflate(THREAD, object, inflate_cause_vm_internal);
 662   monitor-&gt;exit(true, THREAD);
 663 }
 664 
 665 // -----------------------------------------------------------------------------
 666 // Class Loader  support to workaround deadlocks on the class loader lock objects
 667 // Also used by GC
 668 // complete_exit()/reenter() are used to wait on a nested lock
 669 // i.e. to give up an outer lock completely and then re-enter
 670 // Used when holding nested locks - lock acquisition order: lock1 then lock2
 671 //  1) complete_exit lock1 - saving recursion count
 672 //  2) wait on lock2
 673 //  3) when notified on lock2, unlock lock2
 674 //  4) reenter lock1 with original recursion count
 675 //  5) lock lock2
 676 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 677 intx ObjectSynchronizer::complete_exit(Handle obj, TRAPS) {
 678   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 679   if (UseBiasedLocking) {
 680     BiasedLocking::revoke(obj, THREAD);
 681     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 682   }
 683 
 684   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 685   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 686   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 687   intptr_t ret_code = monitor-&gt;complete_exit(THREAD);
 688   return ret_code;
 689 }
 690 
 691 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 692 void ObjectSynchronizer::reenter(Handle obj, intx recursions, TRAPS) {
 693   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 694   if (UseBiasedLocking) {
 695     BiasedLocking::revoke(obj, THREAD);
 696     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 697   }
 698 
 699   // An async deflation can race after the inflate() call and before
 700   // reenter() -&gt; enter() can make the ObjectMonitor busy. reenter() -&gt;
 701   // enter() returns false if we have lost the race to async deflation
 702   // and we simply try again.
 703   while (true) {
 704     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 705     if (monitor-&gt;reenter(recursions, THREAD)) {
 706       return;
 707     }
 708   }
 709 }
 710 
 711 // -----------------------------------------------------------------------------
 712 // JNI locks on java objects
 713 // NOTE: must use heavy weight monitor to handle jni monitor enter
 714 void ObjectSynchronizer::jni_enter(Handle obj, TRAPS) {
 715   // the current locking is from JNI instead of Java code
 716   CHECK_THROW_NOSYNC_IMSE(obj);
 717   if (UseBiasedLocking) {
 718     BiasedLocking::revoke(obj, THREAD);
 719     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 720   }
 721   THREAD-&gt;set_current_pending_monitor_is_from_java(false);
 722   // An async deflation can race after the inflate() call and before
 723   // enter() can make the ObjectMonitor busy. enter() returns false if
 724   // we have lost the race to async deflation and we simply try again.
 725   while (true) {
 726     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_jni_enter);
 727     if (monitor-&gt;enter(THREAD)) {
 728       break;
 729     }
 730   }
 731   THREAD-&gt;set_current_pending_monitor_is_from_java(true);
 732 }
 733 
 734 // NOTE: must use heavy weight monitor to handle jni monitor exit
 735 void ObjectSynchronizer::jni_exit(oop obj, Thread* THREAD) {
 736   CHECK_THROW_NOSYNC_IMSE(obj);
 737   if (UseBiasedLocking) {
 738     Handle h_obj(THREAD, obj);
 739     BiasedLocking::revoke(h_obj, THREAD);
 740     obj = h_obj();
 741   }
 742   assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 743 
 744   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 745   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 746   ObjectMonitor* monitor = inflate(THREAD, obj, inflate_cause_jni_exit);
 747   // If this thread has locked the object, exit the monitor. We
 748   // intentionally do not use CHECK here because we must exit the
 749   // monitor even if an exception is pending.
 750   if (monitor-&gt;check_owner(THREAD)) {
 751     monitor-&gt;exit(true, THREAD);
 752   }
 753 }
 754 
 755 // -----------------------------------------------------------------------------
 756 // Internal VM locks on java objects
 757 // standard constructor, allows locking failures
 758 ObjectLocker::ObjectLocker(Handle obj, Thread* thread, bool do_lock) {
 759   _dolock = do_lock;
 760   _thread = thread;
 761   _thread-&gt;check_for_valid_safepoint_state();
 762   _obj = obj;
 763 
 764   if (_dolock) {
 765     ObjectSynchronizer::enter(_obj, &amp;_lock, _thread);
 766   }
 767 }
 768 
 769 ObjectLocker::~ObjectLocker() {
 770   if (_dolock) {
 771     ObjectSynchronizer::exit(_obj(), &amp;_lock, _thread);
 772   }
 773 }
 774 
 775 
 776 // -----------------------------------------------------------------------------
 777 //  Wait/Notify/NotifyAll
 778 // NOTE: must use heavy weight monitor to handle wait()
 779 int ObjectSynchronizer::wait(Handle obj, jlong millis, TRAPS) {
 780   CHECK_THROW_NOSYNC_IMSE_0(obj);
 781   if (UseBiasedLocking) {
 782     BiasedLocking::revoke(obj, THREAD);
 783     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 784   }
 785   if (millis &lt; 0) {
 786     THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 787   }
 788   // The ObjectMonitor* can&#39;t be async deflated because the _waiters
 789   // field is incremented before ownership is dropped and decremented
 790   // after ownership is regained.
 791   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 792 
 793   DTRACE_MONITOR_WAIT_PROBE(monitor, obj(), THREAD, millis);
 794   monitor-&gt;wait(millis, true, THREAD);
 795 
 796   // This dummy call is in place to get around dtrace bug 6254741.  Once
 797   // that&#39;s fixed we can uncomment the following line, remove the call
 798   // and change this function back into a &quot;void&quot; func.
 799   // DTRACE_MONITOR_PROBE(waited, monitor, obj(), THREAD);
 800   int ret_code = dtrace_waited_probe(monitor, obj, THREAD);
 801   return ret_code;
 802 }
 803 
 804 void ObjectSynchronizer::wait_uninterruptibly(Handle obj, jlong millis, TRAPS) {
 805   CHECK_THROW_NOSYNC_IMSE(obj);
 806   if (UseBiasedLocking) {
 807     BiasedLocking::revoke(obj, THREAD);
 808     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 809   }
 810   if (millis &lt; 0) {
 811     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 812   }
 813   // The ObjectMonitor* can&#39;t be async deflated because the _waiters
 814   // field is incremented before ownership is dropped and decremented
 815   // after ownership is regained.
 816   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 817   monitor-&gt;wait(millis, false, THREAD);
 818 }
 819 
 820 void ObjectSynchronizer::notify(Handle obj, TRAPS) {
 821   CHECK_THROW_NOSYNC_IMSE(obj);
 822   if (UseBiasedLocking) {
 823     BiasedLocking::revoke(obj, THREAD);
 824     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 825   }
 826 
 827   markWord mark = obj-&gt;mark();
 828   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 829     return;
 830   }
 831   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 832   // dropped by the calling thread.
 833   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_notify);
 834   monitor-&gt;notify(THREAD);
 835 }
 836 
 837 // NOTE: see comment of notify()
 838 void ObjectSynchronizer::notifyall(Handle obj, TRAPS) {
 839   CHECK_THROW_NOSYNC_IMSE(obj);
 840   if (UseBiasedLocking) {
 841     BiasedLocking::revoke(obj, THREAD);
 842     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 843   }
 844 
 845   markWord mark = obj-&gt;mark();
 846   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 847     return;
 848   }
 849   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 850   // dropped by the calling thread.
 851   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_notify);
 852   monitor-&gt;notifyAll(THREAD);
 853 }
 854 
 855 // -----------------------------------------------------------------------------
 856 // Hash Code handling
 857 //
 858 // Performance concern:
 859 // OrderAccess::storestore() calls release() which at one time stored 0
 860 // into the global volatile OrderAccess::dummy variable. This store was
 861 // unnecessary for correctness. Many threads storing into a common location
 862 // causes considerable cache migration or &quot;sloshing&quot; on large SMP systems.
 863 // As such, I avoided using OrderAccess::storestore(). In some cases
 864 // OrderAccess::fence() -- which incurs local latency on the executing
 865 // processor -- is a better choice as it scales on SMP systems.
 866 //
 867 // See http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot for
 868 // a discussion of coherency costs. Note that all our current reference
 869 // platforms provide strong ST-ST order, so the issue is moot on IA32,
 870 // x64, and SPARC.
 871 //
 872 // As a general policy we use &quot;volatile&quot; to control compiler-based reordering
 873 // and explicit fences (barriers) to control for architectural reordering
 874 // performed by the CPU(s) or platform.
 875 
 876 struct SharedGlobals {
 877   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 878   // These are highly shared mostly-read variables.
 879   // To avoid false-sharing they need to be the sole occupants of a cache line.
 880   volatile int stw_random;
 881   volatile int stw_cycle;
 882   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(volatile int) * 2);
 883   // Hot RW variable -- Sequester to avoid false-sharing
 884   volatile int hc_sequence;
 885   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(volatile int));
 886 };
 887 
 888 static SharedGlobals GVars;
 889 
 890 static markWord read_stable_mark(oop obj) {
 891   markWord mark = obj-&gt;mark();
 892   if (!mark.is_being_inflated()) {
 893     return mark;       // normal fast-path return
 894   }
 895 
 896   int its = 0;
 897   for (;;) {
 898     markWord mark = obj-&gt;mark();
 899     if (!mark.is_being_inflated()) {
 900       return mark;    // normal fast-path return
 901     }
 902 
 903     // The object is being inflated by some other thread.
 904     // The caller of read_stable_mark() must wait for inflation to complete.
 905     // Avoid live-lock
 906     // TODO: consider calling SafepointSynchronize::do_call_back() while
 907     // spinning to see if there&#39;s a safepoint pending.  If so, immediately
 908     // yielding or blocking would be appropriate.  Avoid spinning while
 909     // there is a safepoint pending.
 910     // TODO: add inflation contention performance counters.
 911     // TODO: restrict the aggregate number of spinners.
 912 
 913     ++its;
 914     if (its &gt; 10000 || !os::is_MP()) {
 915       if (its &amp; 1) {
 916         os::naked_yield();
 917       } else {
 918         // Note that the following code attenuates the livelock problem but is not
 919         // a complete remedy.  A more complete solution would require that the inflating
 920         // thread hold the associated inflation lock.  The following code simply restricts
 921         // the number of spinners to at most one.  We&#39;ll have N-2 threads blocked
 922         // on the inflationlock, 1 thread holding the inflation lock and using
 923         // a yield/park strategy, and 1 thread in the midst of inflation.
 924         // A more refined approach would be to change the encoding of INFLATING
 925         // to allow encapsulation of a native thread pointer.  Threads waiting for
 926         // inflation to complete would use CAS to push themselves onto a singly linked
 927         // list rooted at the markword.  Once enqueued, they&#39;d loop, checking a per-thread flag
 928         // and calling park().  When inflation was complete the thread that accomplished inflation
 929         // would detach the list and set the markword to inflated with a single CAS and
 930         // then for each thread on the list, set the flag and unpark() the thread.
 931         // This is conceptually similar to muxAcquire-muxRelease, except that muxRelease
 932         // wakes at most one thread whereas we need to wake the entire list.
 933         int ix = (cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 5) &amp; (NINFLATIONLOCKS-1);
 934         int YieldThenBlock = 0;
 935         assert(ix &gt;= 0 &amp;&amp; ix &lt; NINFLATIONLOCKS, &quot;invariant&quot;);
 936         assert((NINFLATIONLOCKS &amp; (NINFLATIONLOCKS-1)) == 0, &quot;invariant&quot;);
 937         Thread::muxAcquire(gInflationLocks + ix, &quot;gInflationLock&quot;);
 938         while (obj-&gt;mark() == markWord::INFLATING()) {
 939           // Beware: NakedYield() is advisory and has almost no effect on some platforms
 940           // so we periodically call self-&gt;_ParkEvent-&gt;park(1).
 941           // We use a mixed spin/yield/block mechanism.
 942           if ((YieldThenBlock++) &gt;= 16) {
 943             Thread::current()-&gt;_ParkEvent-&gt;park(1);
 944           } else {
 945             os::naked_yield();
 946           }
 947         }
 948         Thread::muxRelease(gInflationLocks + ix);
 949       }
 950     } else {
 951       SpinPause();       // SMP-polite spinning
 952     }
 953   }
 954 }
 955 
 956 // hashCode() generation :
 957 //
 958 // Possibilities:
 959 // * MD5Digest of {obj,stw_random}
 960 // * CRC32 of {obj,stw_random} or any linear-feedback shift register function.
 961 // * A DES- or AES-style SBox[] mechanism
 962 // * One of the Phi-based schemes, such as:
 963 //   2654435761 = 2^32 * Phi (golden ratio)
 964 //   HashCodeValue = ((uintptr_t(obj) &gt;&gt; 3) * 2654435761) ^ GVars.stw_random ;
 965 // * A variation of Marsaglia&#39;s shift-xor RNG scheme.
 966 // * (obj ^ stw_random) is appealing, but can result
 967 //   in undesirable regularity in the hashCode values of adjacent objects
 968 //   (objects allocated back-to-back, in particular).  This could potentially
 969 //   result in hashtable collisions and reduced hashtable efficiency.
 970 //   There are simple ways to &quot;diffuse&quot; the middle address bits over the
 971 //   generated hashCode values:
 972 
 973 static inline intptr_t get_next_hash(Thread* self, oop obj) {
 974   intptr_t value = 0;
 975   if (hashCode == 0) {
 976     // This form uses global Park-Miller RNG.
 977     // On MP system we&#39;ll have lots of RW access to a global, so the
 978     // mechanism induces lots of coherency traffic.
 979     value = os::random();
 980   } else if (hashCode == 1) {
 981     // This variation has the property of being stable (idempotent)
 982     // between STW operations.  This can be useful in some of the 1-0
 983     // synchronization schemes.
 984     intptr_t addr_bits = cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 3;
 985     value = addr_bits ^ (addr_bits &gt;&gt; 5) ^ GVars.stw_random;
 986   } else if (hashCode == 2) {
 987     value = 1;            // for sensitivity testing
 988   } else if (hashCode == 3) {
 989     value = ++GVars.hc_sequence;
 990   } else if (hashCode == 4) {
 991     value = cast_from_oop&lt;intptr_t&gt;(obj);
 992   } else {
 993     // Marsaglia&#39;s xor-shift scheme with thread-specific state
 994     // This is probably the best overall implementation -- we&#39;ll
 995     // likely make this the default in future releases.
 996     unsigned t = self-&gt;_hashStateX;
 997     t ^= (t &lt;&lt; 11);
 998     self-&gt;_hashStateX = self-&gt;_hashStateY;
 999     self-&gt;_hashStateY = self-&gt;_hashStateZ;
1000     self-&gt;_hashStateZ = self-&gt;_hashStateW;
1001     unsigned v = self-&gt;_hashStateW;
1002     v = (v ^ (v &gt;&gt; 19)) ^ (t ^ (t &gt;&gt; 8));
1003     self-&gt;_hashStateW = v;
1004     value = v;
1005   }
1006 
1007   value &amp;= markWord::hash_mask;
1008   if (value == 0) value = 0xBAD;
1009   assert(value != markWord::no_hash, &quot;invariant&quot;);
1010   return value;
1011 }
1012 
1013 intptr_t ObjectSynchronizer::FastHashCode(Thread* self, oop obj) {
1014   if (EnableValhalla &amp;&amp; obj-&gt;klass()-&gt;is_inline_klass()) {
1015     // VM should be calling bootstrap method
1016     ShouldNotReachHere();
1017   }
1018   if (UseBiasedLocking) {
1019     // NOTE: many places throughout the JVM do not expect a safepoint
1020     // to be taken here, in particular most operations on perm gen
1021     // objects. However, we only ever bias Java instances and all of
1022     // the call sites of identity_hash that might revoke biases have
1023     // been checked to make sure they can handle a safepoint. The
1024     // added check of the bias pattern is to avoid useless calls to
1025     // thread-local storage.
1026     if (obj-&gt;mark().has_bias_pattern()) {
1027       // Handle for oop obj in case of STW safepoint
1028       Handle hobj(self, obj);
1029       // Relaxing assertion for bug 6320749.
1030       assert(Universe::verify_in_progress() ||
1031              !SafepointSynchronize::is_at_safepoint(),
1032              &quot;biases should not be seen by VM thread here&quot;);
1033       BiasedLocking::revoke(hobj, JavaThread::current());
1034       obj = hobj();
1035       assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1036     }
1037   }
1038 
1039   // hashCode() is a heap mutator ...
1040   // Relaxing assertion for bug 6320749.
1041   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1042          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1043   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1044          self-&gt;is_Java_thread() , &quot;invariant&quot;);
1045   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1046          ((JavaThread *)self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1047 
1048   while (true) {
1049     ObjectMonitor* monitor = NULL;
1050     markWord temp, test;
1051     intptr_t hash;
1052     markWord mark = read_stable_mark(obj);
1053 
1054     // object should remain ineligible for biased locking
1055     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1056 
1057     if (mark.is_neutral()) {            // if this is a normal header
1058       hash = mark.hash();
1059       if (hash != 0) {                  // if it has a hash, just return it
1060         return hash;
1061       }
1062       hash = get_next_hash(self, obj);  // get a new hash
1063       temp = mark.copy_set_hash(hash);  // merge the hash into header
1064                                         // try to install the hash
1065       test = obj-&gt;cas_set_mark(temp, mark);
1066       if (test == mark) {               // if the hash was installed, return it
1067         return hash;
1068       }
1069       // Failed to install the hash. It could be that another thread
1070       // installed the hash just before our attempt or inflation has
1071       // occurred or... so we fall thru to inflate the monitor for
1072       // stability and then install the hash.
1073     } else if (mark.has_monitor()) {
1074       monitor = mark.monitor();
1075       temp = monitor-&gt;header();
1076       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1077       hash = temp.hash();
1078       if (hash != 0) {
1079         // It has a hash.
1080 
1081         // Separate load of dmw/header above from the loads in
1082         // is_being_async_deflated().
1083         if (support_IRIW_for_not_multiple_copy_atomic_cpu) {
1084           // A non-multiple copy atomic (nMCA) machine needs a bigger
1085           // hammer to separate the load above and the loads below.
1086           OrderAccess::fence();
1087         } else {
1088           OrderAccess::loadload();
1089         }
1090         if (monitor-&gt;is_being_async_deflated()) {
1091           // But we can&#39;t safely use the hash if we detect that async
1092           // deflation has occurred. So we attempt to restore the
1093           // header/dmw to the object&#39;s header so that we only retry
1094           // once if the deflater thread happens to be slow.
1095           monitor-&gt;install_displaced_markword_in_object(obj);
1096           continue;
1097         }
1098         return hash;
1099       }
1100       // Fall thru so we only have one place that installs the hash in
1101       // the ObjectMonitor.
1102     } else if (self-&gt;is_lock_owned((address)mark.locker())) {
1103       // This is a stack lock owned by the calling thread so fetch the
1104       // displaced markWord from the BasicLock on the stack.
1105       temp = mark.displaced_mark_helper();
1106       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1107       hash = temp.hash();
1108       if (hash != 0) {                  // if it has a hash, just return it
1109         return hash;
1110       }
1111       // WARNING:
1112       // The displaced header in the BasicLock on a thread&#39;s stack
1113       // is strictly immutable. It CANNOT be changed in ANY cases.
1114       // So we have to inflate the stack lock into an ObjectMonitor
1115       // even if the current thread owns the lock. The BasicLock on
1116       // a thread&#39;s stack can be asynchronously read by other threads
1117       // during an inflate() call so any change to that stack memory
1118       // may not propagate to other threads correctly.
1119     }
1120 
1121     // Inflate the monitor to set the hash.
1122 
1123     // An async deflation can race after the inflate() call and before we
1124     // can update the ObjectMonitor&#39;s header with the hash value below.
1125     monitor = inflate(self, obj, inflate_cause_hash_code);
1126     // Load ObjectMonitor&#39;s header/dmw field and see if it has a hash.
1127     mark = monitor-&gt;header();
1128     assert(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1129     hash = mark.hash();
1130     if (hash == 0) {                    // if it does not have a hash
1131       hash = get_next_hash(self, obj);  // get a new hash
1132       temp = mark.copy_set_hash(hash);  // merge the hash into header
1133       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1134       uintptr_t v = Atomic::cmpxchg((volatile uintptr_t*)monitor-&gt;header_addr(), mark.value(), temp.value());
1135       test = markWord(v);
1136       if (test != mark) {
1137         // The attempt to update the ObjectMonitor&#39;s header/dmw field
1138         // did not work. This can happen if another thread managed to
1139         // merge in the hash just before our cmpxchg().
1140         // If we add any new usages of the header/dmw field, this code
1141         // will need to be updated.
1142         hash = test.hash();
1143         assert(test.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, test.value());
1144         assert(hash != 0, &quot;should only have lost the race to a thread that set a non-zero hash&quot;);
1145       }
1146       if (monitor-&gt;is_being_async_deflated()) {
1147         // If we detect that async deflation has occurred, then we
1148         // attempt to restore the header/dmw to the object&#39;s header
1149         // so that we only retry once if the deflater thread happens
1150         // to be slow.
1151         monitor-&gt;install_displaced_markword_in_object(obj);
1152         continue;
1153       }
1154     }
1155     // We finally get the hash.
1156     return hash;
1157   }
1158 }
1159 
1160 
1161 bool ObjectSynchronizer::current_thread_holds_lock(JavaThread* thread,
1162                                                    Handle h_obj) {
1163   if (EnableValhalla &amp;&amp; h_obj-&gt;mark().is_always_locked()) {
1164     return false;
1165   }
1166   if (UseBiasedLocking) {
1167     BiasedLocking::revoke(h_obj, thread);
1168     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1169   }
1170 
1171   assert(thread == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1172   oop obj = h_obj();
1173 
1174   markWord mark = read_stable_mark(obj);
1175 
1176   // Uncontended case, header points to stack
1177   if (mark.has_locker()) {
1178     return thread-&gt;is_lock_owned((address)mark.locker());
1179   }
1180   // Contended case, header points to ObjectMonitor (tagged pointer)
1181   if (mark.has_monitor()) {
1182     // The first stage of async deflation does not affect any field
1183     // used by this comparison so the ObjectMonitor* is usable here.
1184     ObjectMonitor* monitor = mark.monitor();
1185     return monitor-&gt;is_entered(thread) != 0;
1186   }
1187   // Unlocked case, header in place
1188   assert(mark.is_neutral(), &quot;sanity check&quot;);
1189   return false;
1190 }
1191 
1192 // Be aware of this method could revoke bias of the lock object.
1193 // This method queries the ownership of the lock handle specified by &#39;h_obj&#39;.
1194 // If the current thread owns the lock, it returns owner_self. If no
1195 // thread owns the lock, it returns owner_none. Otherwise, it will return
1196 // owner_other.
1197 ObjectSynchronizer::LockOwnership ObjectSynchronizer::query_lock_ownership
1198 (JavaThread *self, Handle h_obj) {
1199   // The caller must beware this method can revoke bias, and
1200   // revocation can result in a safepoint.
1201   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1202   assert(self-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1203 
1204   // Possible mark states: neutral, biased, stack-locked, inflated
1205 
1206   if (UseBiasedLocking &amp;&amp; h_obj()-&gt;mark().has_bias_pattern()) {
1207     // CASE: biased
1208     BiasedLocking::revoke(h_obj, self);
1209     assert(!h_obj-&gt;mark().has_bias_pattern(),
1210            &quot;biases should be revoked by now&quot;);
1211   }
1212 
1213   assert(self == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1214   oop obj = h_obj();
1215   markWord mark = read_stable_mark(obj);
1216 
1217   // CASE: stack-locked.  Mark points to a BasicLock on the owner&#39;s stack.
1218   if (mark.has_locker()) {
1219     return self-&gt;is_lock_owned((address)mark.locker()) ?
1220       owner_self : owner_other;
1221   }
1222 
1223   // CASE: inflated. Mark (tagged pointer) points to an ObjectMonitor.
1224   // The Object:ObjectMonitor relationship is stable as long as we&#39;re
1225   // not at a safepoint and AsyncDeflateIdleMonitors is false.
1226   if (mark.has_monitor()) {
1227     // The first stage of async deflation does not affect any field
1228     // used by this comparison so the ObjectMonitor* is usable here.
1229     ObjectMonitor* monitor = mark.monitor();
1230     void* owner = monitor-&gt;owner();
1231     if (owner == NULL) return owner_none;
1232     return (owner == self ||
1233             self-&gt;is_lock_owned((address)owner)) ? owner_self : owner_other;
1234   }
1235 
1236   // CASE: neutral
1237   assert(mark.is_neutral(), &quot;sanity check&quot;);
1238   return owner_none;           // it&#39;s unlocked
1239 }
1240 
1241 // FIXME: jvmti should call this
1242 JavaThread* ObjectSynchronizer::get_lock_owner(ThreadsList * t_list, Handle h_obj) {
1243   if (UseBiasedLocking) {
1244     if (SafepointSynchronize::is_at_safepoint()) {
1245       BiasedLocking::revoke_at_safepoint(h_obj);
1246     } else {
1247       BiasedLocking::revoke(h_obj, JavaThread::current());
1248     }
1249     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1250   }
1251 
1252   oop obj = h_obj();
1253   address owner = NULL;
1254 
1255   markWord mark = read_stable_mark(obj);
1256 
1257   // Uncontended case, header points to stack
1258   if (mark.has_locker()) {
1259     owner = (address) mark.locker();
1260   }
1261 
1262   // Contended case, header points to ObjectMonitor (tagged pointer)
1263   else if (mark.has_monitor()) {
1264     // The first stage of async deflation does not affect any field
1265     // used by this comparison so the ObjectMonitor* is usable here.
1266     ObjectMonitor* monitor = mark.monitor();
1267     assert(monitor != NULL, &quot;monitor should be non-null&quot;);
1268     owner = (address) monitor-&gt;owner();
1269   }
1270 
1271   if (owner != NULL) {
1272     // owning_thread_from_monitor_owner() may also return NULL here
1273     return Threads::owning_thread_from_monitor_owner(t_list, owner);
1274   }
1275 
1276   // Unlocked case, header in place
1277   // Cannot have assertion since this object may have been
1278   // locked by another thread when reaching here.
1279   // assert(mark.is_neutral(), &quot;sanity check&quot;);
1280 
1281   return NULL;
1282 }
1283 
1284 // Visitors ...
1285 
1286 void ObjectSynchronizer::monitors_iterate(MonitorClosure* closure) {
1287   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
1288   while (block != NULL) {
1289     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
1290     for (int i = _BLOCKSIZE - 1; i &gt; 0; i--) {
1291       ObjectMonitor* mid = (ObjectMonitor *)(block + i);
1292       if (mid-&gt;object() != NULL) {
1293         // Only process with closure if the object is set.
1294 
1295         // monitors_iterate() is only called at a safepoint or when the
1296         // target thread is suspended or when the target thread is
1297         // operating on itself. The current closures in use today are
1298         // only interested in an owned ObjectMonitor and ownership
1299         // cannot be dropped under the calling contexts so the
1300         // ObjectMonitor cannot be async deflated.
1301         closure-&gt;do_monitor(mid);
1302       }
1303     }
1304     // unmarked_next() is not needed with g_block_list (no locking
1305     // used with block linkage _next_om fields).
1306     block = (PaddedObjectMonitor*)block-&gt;next_om();
1307   }
1308 }
1309 
1310 static bool monitors_used_above_threshold() {
1311   int population = Atomic::load(&amp;om_list_globals._population);
1312   if (population == 0) {
1313     return false;
1314   }
1315   if (MonitorUsedDeflationThreshold &gt; 0) {
1316     int monitors_used = population - Atomic::load(&amp;om_list_globals._free_count) -
1317                         Atomic::load(&amp;om_list_globals._wait_count);
1318     int monitor_usage = (monitors_used * 100LL) / population;
1319     return monitor_usage &gt; MonitorUsedDeflationThreshold;
1320   }
1321   return false;
1322 }
1323 
1324 bool ObjectSynchronizer::is_async_deflation_needed() {
1325   if (!AsyncDeflateIdleMonitors) {
1326     return false;
1327   }
1328   if (is_async_deflation_requested()) {
1329     // Async deflation request.
1330     return true;
1331   }
1332   if (AsyncDeflationInterval &gt; 0 &amp;&amp;
1333       time_since_last_async_deflation_ms() &gt; AsyncDeflationInterval &amp;&amp;
1334       monitors_used_above_threshold()) {
1335     // It&#39;s been longer than our specified deflate interval and there
1336     // are too many monitors in use. We don&#39;t deflate more frequently
1337     // than AsyncDeflationInterval (unless is_async_deflation_requested)
1338     // in order to not swamp the ServiceThread.
<a name="2" id="anc2"></a>
1339     return true;
1340   }
1341   return false;
1342 }
1343 
1344 bool ObjectSynchronizer::is_safepoint_deflation_needed() {
<a name="3" id="anc3"></a><span class="line-modified">1345   return !AsyncDeflateIdleMonitors &amp;&amp;</span>
<span class="line-modified">1346          monitors_used_above_threshold();  // Too many monitors in use.</span>
<span class="line-modified">1347 }</span>
<span class="line-modified">1348 </span>
<span class="line-added">1349 bool ObjectSynchronizer::request_deflate_idle_monitors() {</span>
<span class="line-added">1350   bool is_JavaThread = Thread::current()-&gt;is_Java_thread();</span>
<span class="line-added">1351   bool ret_code = false;</span>
<span class="line-added">1352 </span>
<span class="line-added">1353   if (AsyncDeflateIdleMonitors) {</span>
<span class="line-added">1354     jlong last_time = last_async_deflation_time_ns();</span>
<span class="line-added">1355     set_is_async_deflation_requested(true);</span>
<span class="line-added">1356     {</span>
<span class="line-added">1357       MonitorLocker ml(Service_lock, Mutex::_no_safepoint_check_flag);</span>
<span class="line-added">1358       ml.notify_all();</span>
1359     }
<a name="4" id="anc4"></a><span class="line-modified">1360     const int N_CHECKS = 5;</span>
<span class="line-modified">1361     for (int i = 0; i &lt; N_CHECKS; i++) {  // sleep for at most 5 seconds</span>
<span class="line-modified">1362       if (last_async_deflation_time_ns() &gt; last_time) {</span>
<span class="line-modified">1363         log_info(monitorinflation)(&quot;Async Deflation happened after %d check(s).&quot;, i);</span>
<span class="line-modified">1364         ret_code = true;</span>
<span class="line-modified">1365         break;</span>
<span class="line-added">1366       }</span>
<span class="line-added">1367       if (is_JavaThread) {</span>
<span class="line-added">1368         // JavaThread has to honor the blocking protocol.</span>
<span class="line-added">1369         ThreadBlockInVM tbivm(JavaThread::current());</span>
<span class="line-added">1370         os::naked_short_sleep(999);  // sleep for almost 1 second</span>
<span class="line-added">1371       } else {</span>
<span class="line-added">1372         os::naked_short_sleep(999);  // sleep for almost 1 second</span>
<span class="line-added">1373       }</span>
<span class="line-added">1374     }</span>
<span class="line-added">1375     if (!ret_code) {</span>
<span class="line-added">1376       log_info(monitorinflation)(&quot;Async Deflation DID NOT happen after %d checks.&quot;, N_CHECKS);</span>
<span class="line-added">1377     }</span>
<span class="line-added">1378   } else {</span>
<span class="line-added">1379     // Only need to force this safepoint if we are not using async</span>
<span class="line-added">1380     // deflation. The VMThread won&#39;t call this function before the</span>
<span class="line-added">1381     // final safepoint if we are not using async deflation so we</span>
<span class="line-added">1382     // don&#39;t have to reason about the VMThread executing a VM-op here.</span>
<span class="line-added">1383     VM_ForceSafepoint force_safepoint_op;</span>
<span class="line-added">1384     VMThread::execute(&amp;force_safepoint_op);</span>
<span class="line-added">1385     ret_code = true;</span>
1386   }
<a name="5" id="anc5"></a><span class="line-modified">1387 </span>
<span class="line-added">1388   return ret_code;</span>
1389 }
1390 
1391 jlong ObjectSynchronizer::time_since_last_async_deflation_ms() {
<a name="6" id="anc6"></a><span class="line-modified">1392   return (os::javaTimeNanos() - last_async_deflation_time_ns()) / (NANOUNITS / MILLIUNITS);</span>
1393 }
1394 
1395 void ObjectSynchronizer::oops_do(OopClosure* f) {
1396   // We only scan the global used list here (for moribund threads), and
1397   // the thread-local monitors in Thread::oops_do().
1398   global_used_oops_do(f);
1399 }
1400 
1401 void ObjectSynchronizer::global_used_oops_do(OopClosure* f) {
1402   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1403   list_oops_do(Atomic::load(&amp;om_list_globals._in_use_list), f);
1404 }
1405 
1406 void ObjectSynchronizer::thread_local_used_oops_do(Thread* thread, OopClosure* f) {
1407   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1408   list_oops_do(thread-&gt;om_in_use_list, f);
1409 }
1410 
1411 void ObjectSynchronizer::list_oops_do(ObjectMonitor* list, OopClosure* f) {
1412   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1413   // The oops_do() phase does not overlap with monitor deflation
1414   // so no need to lock ObjectMonitors for the list traversal.
1415   for (ObjectMonitor* mid = list; mid != NULL; mid = unmarked_next(mid)) {
1416     if (mid-&gt;object() != NULL) {
1417       f-&gt;do_oop((oop*)mid-&gt;object_addr());
1418     }
1419   }
1420 }
1421 
1422 
1423 // -----------------------------------------------------------------------------
1424 // ObjectMonitor Lifecycle
1425 // -----------------------
1426 // Inflation unlinks monitors from om_list_globals._free_list or a per-thread
1427 // free list and associates them with objects. Deflation -- which occurs at
1428 // STW-time or asynchronously -- disassociates idle monitors from objects.
1429 // Such scavenged monitors are returned to the om_list_globals._free_list.
1430 //
1431 // ObjectMonitors reside in type-stable memory (TSM) and are immortal.
1432 //
1433 // Lifecycle:
1434 // --   unassigned and on the om_list_globals._free_list
1435 // --   unassigned and on a per-thread free list
1436 // --   assigned to an object.  The object is inflated and the mark refers
1437 //      to the ObjectMonitor.
1438 
1439 ObjectMonitor* ObjectSynchronizer::om_alloc(Thread* self) {
1440   // A large MAXPRIVATE value reduces both list lock contention
1441   // and list coherency traffic, but also tends to increase the
1442   // number of ObjectMonitors in circulation as well as the STW
1443   // scavenge costs.  As usual, we lean toward time in space-time
1444   // tradeoffs.
1445   const int MAXPRIVATE = 1024;
1446   NoSafepointVerifier nsv;
1447 
1448   for (;;) {
1449     ObjectMonitor* m;
1450 
1451     // 1: try to allocate from the thread&#39;s local om_free_list.
1452     // Threads will attempt to allocate first from their local list, then
1453     // from the global list, and only after those attempts fail will the
1454     // thread attempt to instantiate new monitors. Thread-local free lists
1455     // improve allocation latency, as well as reducing coherency traffic
1456     // on the shared global list.
1457     m = take_from_start_of_om_free_list(self);
1458     if (m != NULL) {
1459       guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1460       m-&gt;set_allocation_state(ObjectMonitor::New);
1461       prepend_to_om_in_use_list(self, m);
1462       return m;
1463     }
1464 
1465     // 2: try to allocate from the global om_list_globals._free_list
1466     // If we&#39;re using thread-local free lists then try
1467     // to reprovision the caller&#39;s free list.
1468     if (Atomic::load(&amp;om_list_globals._free_list) != NULL) {
1469       // Reprovision the thread&#39;s om_free_list.
1470       // Use bulk transfers to reduce the allocation rate and heat
1471       // on various locks.
1472       for (int i = self-&gt;om_free_provision; --i &gt;= 0;) {
1473         ObjectMonitor* take = take_from_start_of_global_free_list();
1474         if (take == NULL) {
1475           break;  // No more are available.
1476         }
1477         guarantee(take-&gt;object() == NULL, &quot;invariant&quot;);
1478         if (AsyncDeflateIdleMonitors) {
1479           // We allowed 3 field values to linger during async deflation.
1480           // Clear or restore them as appropriate.
1481           take-&gt;set_header(markWord::zero());
1482           // DEFLATER_MARKER is the only non-NULL value we should see here.
1483           take-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
1484           if (take-&gt;contentions() &lt; 0) {
1485             // Add back max_jint to restore the contentions field to its
1486             // proper value.
1487             take-&gt;add_to_contentions(max_jint);
1488 
1489 #ifdef ASSERT
1490             jint l_contentions = take-&gt;contentions();
1491 #endif
1492             assert(l_contentions &gt;= 0, &quot;must not be negative: l_contentions=%d, contentions=%d&quot;,
1493                    l_contentions, take-&gt;contentions());
1494           }
1495         }
1496         take-&gt;Recycle();
1497         // Since we&#39;re taking from the global free-list, take must be Free.
1498         // om_release() also sets the allocation state to Free because it
1499         // is called from other code paths.
1500         assert(take-&gt;is_free(), &quot;invariant&quot;);
1501         om_release(self, take, false);
1502       }
1503       self-&gt;om_free_provision += 1 + (self-&gt;om_free_provision / 2);
1504       if (self-&gt;om_free_provision &gt; MAXPRIVATE) self-&gt;om_free_provision = MAXPRIVATE;
1505       continue;
1506     }
1507 
1508     // 3: allocate a block of new ObjectMonitors
1509     // Both the local and global free lists are empty -- resort to malloc().
1510     // In the current implementation ObjectMonitors are TSM - immortal.
1511     // Ideally, we&#39;d write &quot;new ObjectMonitor[_BLOCKSIZE], but we want
1512     // each ObjectMonitor to start at the beginning of a cache line,
1513     // so we use align_up().
1514     // A better solution would be to use C++ placement-new.
1515     // BEWARE: As it stands currently, we don&#39;t run the ctors!
1516     assert(_BLOCKSIZE &gt; 1, &quot;invariant&quot;);
1517     size_t neededsize = sizeof(PaddedObjectMonitor) * _BLOCKSIZE;
1518     PaddedObjectMonitor* temp;
1519     size_t aligned_size = neededsize + (OM_CACHE_LINE_SIZE - 1);
1520     void* real_malloc_addr = NEW_C_HEAP_ARRAY(char, aligned_size, mtInternal);
1521     temp = (PaddedObjectMonitor*)align_up(real_malloc_addr, OM_CACHE_LINE_SIZE);
1522     (void)memset((void *) temp, 0, neededsize);
1523 
1524     // Format the block.
1525     // initialize the linked list, each monitor points to its next
1526     // forming the single linked free list, the very first monitor
1527     // will points to next block, which forms the block list.
1528     // The trick of using the 1st element in the block as g_block_list
1529     // linkage should be reconsidered.  A better implementation would
1530     // look like: class Block { Block * next; int N; ObjectMonitor Body [N] ; }
1531 
1532     for (int i = 1; i &lt; _BLOCKSIZE; i++) {
1533       temp[i].set_next_om((ObjectMonitor*)&amp;temp[i + 1]);
1534       assert(temp[i].is_free(), &quot;invariant&quot;);
1535     }
1536 
1537     // terminate the last monitor as the end of list
1538     temp[_BLOCKSIZE - 1].set_next_om((ObjectMonitor*)NULL);
1539 
1540     // Element [0] is reserved for global list linkage
1541     temp[0].set_object(CHAINMARKER);
1542 
1543     // Consider carving out this thread&#39;s current request from the
1544     // block in hand.  This avoids some lock traffic and redundant
1545     // list activity.
1546 
1547     prepend_block_to_lists(temp);
1548   }
1549 }
1550 
1551 // Place &quot;m&quot; on the caller&#39;s private per-thread om_free_list.
1552 // In practice there&#39;s no need to clamp or limit the number of
1553 // monitors on a thread&#39;s om_free_list as the only non-allocation time
1554 // we&#39;ll call om_release() is to return a monitor to the free list after
1555 // a CAS attempt failed. This doesn&#39;t allow unbounded #s of monitors to
1556 // accumulate on a thread&#39;s free list.
1557 //
1558 // Key constraint: all ObjectMonitors on a thread&#39;s free list and the global
1559 // free list must have their object field set to null. This prevents the
1560 // scavenger -- deflate_monitor_list() or deflate_monitor_list_using_JT()
1561 // -- from reclaiming them while we are trying to release them.
1562 
1563 void ObjectSynchronizer::om_release(Thread* self, ObjectMonitor* m,
1564                                     bool from_per_thread_alloc) {
1565   guarantee(m-&gt;header().value() == 0, &quot;invariant&quot;);
1566   guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1567   NoSafepointVerifier nsv;
1568 
1569   if ((m-&gt;is_busy() | m-&gt;_recursions) != 0) {
1570     stringStream ss;
1571     fatal(&quot;freeing in-use monitor: %s, recursions=&quot; INTX_FORMAT,
1572           m-&gt;is_busy_to_string(&amp;ss), m-&gt;_recursions);
1573   }
1574   m-&gt;set_allocation_state(ObjectMonitor::Free);
1575   // _next_om is used for both per-thread in-use and free lists so
1576   // we have to remove &#39;m&#39; from the in-use list first (as needed).
1577   if (from_per_thread_alloc) {
1578     // Need to remove &#39;m&#39; from om_in_use_list.
1579     ObjectMonitor* mid = NULL;
1580     ObjectMonitor* next = NULL;
1581 
1582     // This list walk can race with another list walker or with async
1583     // deflation so we have to worry about an ObjectMonitor being
1584     // removed from this list while we are walking it.
1585 
1586     // Lock the list head to avoid racing with another list walker
1587     // or with async deflation.
1588     if ((mid = get_list_head_locked(&amp;self-&gt;om_in_use_list)) == NULL) {
1589       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; in-use list must not be empty.&quot;, p2i(self));
1590     }
1591     next = unmarked_next(mid);
1592     if (m == mid) {
1593       // First special case:
1594       // &#39;m&#39; matches mid, is the list head and is locked. Switch the list
1595       // head to next which unlocks the list head, but leaves the extracted
1596       // mid locked:
1597       Atomic::store(&amp;self-&gt;om_in_use_list, next);
1598     } else if (m == next) {
1599       // Second special case:
1600       // &#39;m&#39; matches next after the list head and we already have the list
1601       // head locked so set mid to what we are extracting:
1602       mid = next;
1603       // Lock mid to prevent races with a list walker or an async
1604       // deflater thread that&#39;s ahead of us. The locked list head
1605       // prevents races from behind us.
1606       om_lock(mid);
1607       // Update next to what follows mid (if anything):
1608       next = unmarked_next(mid);
1609       // Switch next after the list head to new next which unlocks the
1610       // list head, but leaves the extracted mid locked:
1611       self-&gt;om_in_use_list-&gt;set_next_om(next);
1612     } else {
1613       // We have to search the list to find &#39;m&#39;.
1614       guarantee(next != NULL, &quot;thread=&quot; INTPTR_FORMAT &quot;: om_in_use_list=&quot; INTPTR_FORMAT
1615                 &quot; is too short.&quot;, p2i(self), p2i(self-&gt;om_in_use_list));
1616       // Our starting anchor is next after the list head which is the
1617       // last ObjectMonitor we checked:
1618       ObjectMonitor* anchor = next;
1619       // Lock anchor to prevent races with a list walker or an async
1620       // deflater thread that&#39;s ahead of us. The locked list head
1621       // prevents races from behind us.
1622       om_lock(anchor);
1623       om_unlock(mid);  // Unlock the list head now that anchor is locked.
1624       while ((mid = unmarked_next(anchor)) != NULL) {
1625         if (m == mid) {
1626           // We found &#39;m&#39; on the per-thread in-use list so extract it.
1627           // Update next to what follows mid (if anything):
1628           next = unmarked_next(mid);
1629           // Switch next after the anchor to new next which unlocks the
1630           // anchor, but leaves the extracted mid locked:
1631           anchor-&gt;set_next_om(next);
1632           break;
1633         } else {
1634           // Lock the next anchor to prevent races with a list walker
1635           // or an async deflater thread that&#39;s ahead of us. The locked
1636           // current anchor prevents races from behind us.
1637           om_lock(mid);
1638           // Unlock current anchor now that next anchor is locked:
1639           om_unlock(anchor);
1640           anchor = mid;  // Advance to new anchor and try again.
1641         }
1642       }
1643     }
1644 
1645     if (mid == NULL) {
1646       // Reached end of the list and didn&#39;t find &#39;m&#39; so:
1647       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; must find m=&quot; INTPTR_FORMAT &quot;on om_in_use_list=&quot;
1648             INTPTR_FORMAT, p2i(self), p2i(m), p2i(self-&gt;om_in_use_list));
1649     }
1650 
1651     // At this point mid is disconnected from the in-use list so
1652     // its lock no longer has any effects on the in-use list.
1653     Atomic::dec(&amp;self-&gt;om_in_use_count);
1654     // Unlock mid, but leave the next value for any lagging list
1655     // walkers. It will get cleaned up when mid is prepended to
1656     // the thread&#39;s free list:
1657     om_unlock(mid);
1658   }
1659 
1660   prepend_to_om_free_list(self, m);
1661   guarantee(m-&gt;is_free(), &quot;invariant&quot;);
1662 }
1663 
1664 // Return ObjectMonitors on a moribund thread&#39;s free and in-use
1665 // lists to the appropriate global lists. The ObjectMonitors on the
1666 // per-thread in-use list may still be in use by other threads.
1667 //
1668 // We currently call om_flush() from Threads::remove() before the
1669 // thread has been excised from the thread list and is no longer a
1670 // mutator. This means that om_flush() cannot run concurrently with
1671 // a safepoint and interleave with deflate_idle_monitors(). In
1672 // particular, this ensures that the thread&#39;s in-use monitors are
1673 // scanned by a GC safepoint, either via Thread::oops_do() (before
1674 // om_flush() is called) or via ObjectSynchronizer::oops_do() (after
1675 // om_flush() is called).
1676 //
1677 // With AsyncDeflateIdleMonitors, deflate_global_idle_monitors_using_JT()
1678 // and deflate_per_thread_idle_monitors_using_JT() (in another thread) can
1679 // run at the same time as om_flush() so we have to follow a careful
1680 // protocol to prevent list corruption.
1681 
1682 void ObjectSynchronizer::om_flush(Thread* self) {
1683   // Process the per-thread in-use list first to be consistent.
1684   int in_use_count = 0;
1685   ObjectMonitor* in_use_list = NULL;
1686   ObjectMonitor* in_use_tail = NULL;
1687   NoSafepointVerifier nsv;
1688 
1689   // This function can race with a list walker or with an async
1690   // deflater thread so we lock the list head to prevent confusion.
1691   // An async deflater thread checks to see if the target thread
1692   // is exiting, but if it has made it past that check before we
1693   // started exiting, then it is racing to get to the in-use list.
1694   if ((in_use_list = get_list_head_locked(&amp;self-&gt;om_in_use_list)) != NULL) {
1695     // At this point, we have locked the in-use list head so a racing
1696     // thread cannot come in after us. However, a racing thread could
1697     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1698     //
1699     // The thread is going away, however the ObjectMonitors on the
1700     // om_in_use_list may still be in-use by other threads. Link
1701     // them to in_use_tail, which will be linked into the global
1702     // in-use list (om_list_globals._in_use_list) below.
1703     //
1704     // Account for the in-use list head before the loop since it is
1705     // already locked (by this thread):
1706     in_use_tail = in_use_list;
1707     in_use_count++;
1708     for (ObjectMonitor* cur_om = unmarked_next(in_use_list); cur_om != NULL;) {
1709       if (is_locked(cur_om)) {
1710         // cur_om is locked so there must be a racing walker or async
1711         // deflater thread ahead of us so we&#39;ll give it a chance to finish.
1712         while (is_locked(cur_om)) {
1713           os::naked_short_sleep(1);
1714         }
1715         // Refetch the possibly changed next field and try again.
1716         cur_om = unmarked_next(in_use_tail);
1717         continue;
1718       }
1719       if (cur_om-&gt;object() == NULL) {
1720         // cur_om was deflated and the object ref was cleared while it
1721         // was locked. We happened to see it just after it was unlocked
1722         // (and added to the free list). Refetch the possibly changed
1723         // next field and try again.
1724         cur_om = unmarked_next(in_use_tail);
1725         continue;
1726       }
1727       in_use_tail = cur_om;
1728       in_use_count++;
1729       cur_om = unmarked_next(cur_om);
1730     }
1731     guarantee(in_use_tail != NULL, &quot;invariant&quot;);
1732     int l_om_in_use_count = Atomic::load(&amp;self-&gt;om_in_use_count);
1733     ADIM_guarantee(l_om_in_use_count == in_use_count, &quot;in-use counts don&#39;t match: &quot;
1734                    &quot;l_om_in_use_count=%d, in_use_count=%d&quot;, l_om_in_use_count, in_use_count);
1735     Atomic::store(&amp;self-&gt;om_in_use_count, 0);
1736     // Clear the in-use list head (which also unlocks it):
1737     Atomic::store(&amp;self-&gt;om_in_use_list, (ObjectMonitor*)NULL);
1738     om_unlock(in_use_list);
1739   }
1740 
1741   int free_count = 0;
1742   ObjectMonitor* free_list = NULL;
1743   ObjectMonitor* free_tail = NULL;
1744   // This function can race with a list walker thread so we lock the
1745   // list head to prevent confusion.
1746   if ((free_list = get_list_head_locked(&amp;self-&gt;om_free_list)) != NULL) {
1747     // At this point, we have locked the free list head so a racing
1748     // thread cannot come in after us. However, a racing thread could
1749     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1750     //
1751     // The thread is going away. Set &#39;free_tail&#39; to the last per-thread free
1752     // monitor which will be linked to om_list_globals._free_list below.
1753     //
1754     // Account for the free list head before the loop since it is
1755     // already locked (by this thread):
1756     free_tail = free_list;
1757     free_count++;
1758     for (ObjectMonitor* s = unmarked_next(free_list); s != NULL; s = unmarked_next(s)) {
1759       if (is_locked(s)) {
1760         // s is locked so there must be a racing walker thread ahead
1761         // of us so we&#39;ll give it a chance to finish.
1762         while (is_locked(s)) {
1763           os::naked_short_sleep(1);
1764         }
1765       }
1766       free_tail = s;
1767       free_count++;
1768       guarantee(s-&gt;object() == NULL, &quot;invariant&quot;);
1769       if (s-&gt;is_busy()) {
1770         stringStream ss;
1771         fatal(&quot;must be !is_busy: %s&quot;, s-&gt;is_busy_to_string(&amp;ss));
1772       }
1773     }
1774     guarantee(free_tail != NULL, &quot;invariant&quot;);
1775     int l_om_free_count = Atomic::load(&amp;self-&gt;om_free_count);
1776     ADIM_guarantee(l_om_free_count == free_count, &quot;free counts don&#39;t match: &quot;
1777                    &quot;l_om_free_count=%d, free_count=%d&quot;, l_om_free_count, free_count);
1778     Atomic::store(&amp;self-&gt;om_free_count, 0);
1779     Atomic::store(&amp;self-&gt;om_free_list, (ObjectMonitor*)NULL);
1780     om_unlock(free_list);
1781   }
1782 
1783   if (free_tail != NULL) {
1784     prepend_list_to_global_free_list(free_list, free_tail, free_count);
1785   }
1786 
1787   if (in_use_tail != NULL) {
1788     prepend_list_to_global_in_use_list(in_use_list, in_use_tail, in_use_count);
1789   }
1790 
1791   LogStreamHandle(Debug, monitorinflation) lsh_debug;
1792   LogStreamHandle(Info, monitorinflation) lsh_info;
1793   LogStream* ls = NULL;
1794   if (log_is_enabled(Debug, monitorinflation)) {
1795     ls = &amp;lsh_debug;
1796   } else if ((free_count != 0 || in_use_count != 0) &amp;&amp;
1797              log_is_enabled(Info, monitorinflation)) {
1798     ls = &amp;lsh_info;
1799   }
1800   if (ls != NULL) {
1801     ls-&gt;print_cr(&quot;om_flush: jt=&quot; INTPTR_FORMAT &quot;, free_count=%d&quot;
1802                  &quot;, in_use_count=%d&quot; &quot;, om_free_provision=%d&quot;,
1803                  p2i(self), free_count, in_use_count, self-&gt;om_free_provision);
1804   }
1805 }
1806 
1807 static void post_monitor_inflate_event(EventJavaMonitorInflate* event,
1808                                        const oop obj,
1809                                        ObjectSynchronizer::InflateCause cause) {
1810   assert(event != NULL, &quot;invariant&quot;);
1811   assert(event-&gt;should_commit(), &quot;invariant&quot;);
1812   event-&gt;set_monitorClass(obj-&gt;klass());
1813   event-&gt;set_address((uintptr_t)(void*)obj);
1814   event-&gt;set_cause((u1)cause);
1815   event-&gt;commit();
1816 }
1817 
1818 // Fast path code shared by multiple functions
1819 void ObjectSynchronizer::inflate_helper(oop obj) {
1820   markWord mark = obj-&gt;mark();
1821   if (mark.has_monitor()) {
1822     ObjectMonitor* monitor = mark.monitor();
1823     assert(ObjectSynchronizer::verify_objmon_isinpool(monitor), &quot;monitor=&quot; INTPTR_FORMAT &quot; is invalid&quot;, p2i(monitor));
1824     markWord dmw = monitor-&gt;header();
1825     assert(dmw.is_neutral(), &quot;sanity check: header=&quot; INTPTR_FORMAT, dmw.value());
1826     return;
1827   }
1828   (void)inflate(Thread::current(), obj, inflate_cause_vm_internal);
1829 }
1830 
1831 ObjectMonitor* ObjectSynchronizer::inflate(Thread* self, oop object,
1832                                            const InflateCause cause) {
1833   // Inflate mutates the heap ...
1834   // Relaxing assertion for bug 6320749.
1835   assert(Universe::verify_in_progress() ||
1836          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1837 
1838   if (EnableValhalla) {
1839     guarantee(!object-&gt;klass()-&gt;is_inline_klass(), &quot;Attempt to inflate inline type&quot;);
1840   }
1841 
1842   EventJavaMonitorInflate event;
1843 
1844   for (;;) {
1845     const markWord mark = object-&gt;mark();
1846     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1847 
1848     // The mark can be in one of the following states:
1849     // *  Inflated     - just return
1850     // *  Stack-locked - coerce it to inflated
1851     // *  INFLATING    - busy wait for conversion to complete
1852     // *  Neutral      - aggressively inflate the object.
1853     // *  BIASED       - Illegal.  We should never see this
1854 
1855     // CASE: inflated
1856     if (mark.has_monitor()) {
1857       ObjectMonitor* inf = mark.monitor();
1858       markWord dmw = inf-&gt;header();
1859       assert(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1860       assert(AsyncDeflateIdleMonitors || inf-&gt;object() == object, &quot;invariant&quot;);
1861       assert(ObjectSynchronizer::verify_objmon_isinpool(inf), &quot;monitor is invalid&quot;);
1862       return inf;
1863     }
1864 
1865     // CASE: inflation in progress - inflating over a stack-lock.
1866     // Some other thread is converting from stack-locked to inflated.
1867     // Only that thread can complete inflation -- other threads must wait.
1868     // The INFLATING value is transient.
1869     // Currently, we spin/yield/park and poll the markword, waiting for inflation to finish.
1870     // We could always eliminate polling by parking the thread on some auxiliary list.
1871     if (mark == markWord::INFLATING()) {
1872       read_stable_mark(object);
1873       continue;
1874     }
1875 
1876     // CASE: stack-locked
1877     // Could be stack-locked either by this thread or by some other thread.
1878     //
1879     // Note that we allocate the objectmonitor speculatively, _before_ attempting
1880     // to install INFLATING into the mark word.  We originally installed INFLATING,
1881     // allocated the objectmonitor, and then finally STed the address of the
1882     // objectmonitor into the mark.  This was correct, but artificially lengthened
1883     // the interval in which INFLATED appeared in the mark, thus increasing
1884     // the odds of inflation contention.
1885     //
1886     // We now use per-thread private objectmonitor free lists.
1887     // These list are reprovisioned from the global free list outside the
1888     // critical INFLATING...ST interval.  A thread can transfer
1889     // multiple objectmonitors en-mass from the global free list to its local free list.
1890     // This reduces coherency traffic and lock contention on the global free list.
1891     // Using such local free lists, it doesn&#39;t matter if the om_alloc() call appears
1892     // before or after the CAS(INFLATING) operation.
1893     // See the comments in om_alloc().
1894 
1895     LogStreamHandle(Trace, monitorinflation) lsh;
1896 
1897     if (mark.has_locker()) {
1898       ObjectMonitor* m = om_alloc(self);
1899       // Optimistically prepare the objectmonitor - anticipate successful CAS
1900       // We do this before the CAS in order to minimize the length of time
1901       // in which INFLATING appears in the mark.
1902       m-&gt;Recycle();
1903       m-&gt;_Responsible  = NULL;
1904       m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;   // Consider: maintain by type/class
1905 
1906       markWord cmp = object-&gt;cas_set_mark(markWord::INFLATING(), mark);
1907       if (cmp != mark) {
1908         // om_release() will reset the allocation state from New to Free.
1909         om_release(self, m, true);
1910         continue;       // Interference -- just retry
1911       }
1912 
1913       // We&#39;ve successfully installed INFLATING (0) into the mark-word.
1914       // This is the only case where 0 will appear in a mark-word.
1915       // Only the singular thread that successfully swings the mark-word
1916       // to 0 can perform (or more precisely, complete) inflation.
1917       //
1918       // Why do we CAS a 0 into the mark-word instead of just CASing the
1919       // mark-word from the stack-locked value directly to the new inflated state?
1920       // Consider what happens when a thread unlocks a stack-locked object.
1921       // It attempts to use CAS to swing the displaced header value from the
1922       // on-stack BasicLock back into the object header.  Recall also that the
1923       // header value (hash code, etc) can reside in (a) the object header, or
1924       // (b) a displaced header associated with the stack-lock, or (c) a displaced
1925       // header in an ObjectMonitor.  The inflate() routine must copy the header
1926       // value from the BasicLock on the owner&#39;s stack to the ObjectMonitor, all
1927       // the while preserving the hashCode stability invariants.  If the owner
1928       // decides to release the lock while the value is 0, the unlock will fail
1929       // and control will eventually pass from slow_exit() to inflate.  The owner
1930       // will then spin, waiting for the 0 value to disappear.   Put another way,
1931       // the 0 causes the owner to stall if the owner happens to try to
1932       // drop the lock (restoring the header from the BasicLock to the object)
1933       // while inflation is in-progress.  This protocol avoids races that might
1934       // would otherwise permit hashCode values to change or &quot;flicker&quot; for an object.
1935       // Critically, while object-&gt;mark is 0 mark.displaced_mark_helper() is stable.
1936       // 0 serves as a &quot;BUSY&quot; inflate-in-progress indicator.
1937 
1938 
1939       // fetch the displaced mark from the owner&#39;s stack.
1940       // The owner can&#39;t die or unwind past the lock while our INFLATING
1941       // object is in the mark.  Furthermore the owner can&#39;t complete
1942       // an unlock on the object, either.
1943       markWord dmw = mark.displaced_mark_helper();
1944       // Catch if the object&#39;s header is not neutral (not locked and
1945       // not marked is what we care about here).
1946       ADIM_guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1947 
1948       // Setup monitor fields to proper values -- prepare the monitor
1949       m-&gt;set_header(dmw);
1950 
1951       // Optimization: if the mark.locker stack address is associated
1952       // with this thread we could simply set m-&gt;_owner = self.
1953       // Note that a thread can inflate an object
1954       // that it has stack-locked -- as might happen in wait() -- directly
1955       // with CAS.  That is, we can avoid the xchg-NULL .... ST idiom.
1956       if (AsyncDeflateIdleMonitors) {
1957         m-&gt;set_owner_from(NULL, DEFLATER_MARKER, mark.locker());
1958       } else {
1959         m-&gt;set_owner_from(NULL, mark.locker());
1960       }
1961       m-&gt;set_object(object);
1962       // TODO-FIXME: assert BasicLock-&gt;dhw != 0.
1963 
1964       // Must preserve store ordering. The monitor state must
1965       // be stable at the time of publishing the monitor address.
1966       guarantee(object-&gt;mark() == markWord::INFLATING(), &quot;invariant&quot;);
1967       object-&gt;release_set_mark(markWord::encode(m));
1968 
1969       // Once ObjectMonitor is configured and the object is associated
1970       // with the ObjectMonitor, it is safe to allow async deflation:
1971       assert(m-&gt;is_new(), &quot;freshly allocated monitor must be new&quot;);
1972       m-&gt;set_allocation_state(ObjectMonitor::Old);
1973 
1974       // Hopefully the performance counters are allocated on distinct cache lines
1975       // to avoid false sharing on MP systems ...
1976       OM_PERFDATA_OP(Inflations, inc());
1977       if (log_is_enabled(Trace, monitorinflation)) {
1978         ResourceMark rm(self);
1979         lsh.print_cr(&quot;inflate(has_locker): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1980                      INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1981                      object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
1982       }
1983       if (event.should_commit()) {
1984         post_monitor_inflate_event(&amp;event, object, cause);
1985       }
1986       return m;
1987     }
1988 
1989     // CASE: neutral
1990     // TODO-FIXME: for entry we currently inflate and then try to CAS _owner.
1991     // If we know we&#39;re inflating for entry it&#39;s better to inflate by swinging a
1992     // pre-locked ObjectMonitor pointer into the object header.   A successful
1993     // CAS inflates the object *and* confers ownership to the inflating thread.
1994     // In the current implementation we use a 2-step mechanism where we CAS()
1995     // to inflate and then CAS() again to try to swing _owner from NULL to self.
1996     // An inflateTry() method that we could call from enter() would be useful.
1997 
1998     // Catch if the object&#39;s header is not neutral (not locked and
1999     // not marked is what we care about here).
2000     ADIM_guarantee(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
2001     ObjectMonitor* m = om_alloc(self);
2002     // prepare m for installation - set monitor to initial state
2003     m-&gt;Recycle();
2004     m-&gt;set_header(mark);
2005     if (AsyncDeflateIdleMonitors) {
2006       // DEFLATER_MARKER is the only non-NULL value we should see here.
2007       m-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
2008     }
2009     m-&gt;set_object(object);
2010     m-&gt;_Responsible  = NULL;
2011     m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;       // consider: keep metastats by type/class
2012 
2013     if (object-&gt;cas_set_mark(markWord::encode(m), mark) != mark) {
2014       m-&gt;set_header(markWord::zero());
2015       m-&gt;set_object(NULL);
2016       m-&gt;Recycle();
2017       // om_release() will reset the allocation state from New to Free.
2018       om_release(self, m, true);
2019       m = NULL;
2020       continue;
2021       // interference - the markword changed - just retry.
2022       // The state-transitions are one-way, so there&#39;s no chance of
2023       // live-lock -- &quot;Inflated&quot; is an absorbing state.
2024     }
2025 
2026     // Once the ObjectMonitor is configured and object is associated
2027     // with the ObjectMonitor, it is safe to allow async deflation:
2028     assert(m-&gt;is_new(), &quot;freshly allocated monitor must be new&quot;);
2029     m-&gt;set_allocation_state(ObjectMonitor::Old);
2030 
2031     // Hopefully the performance counters are allocated on distinct
2032     // cache lines to avoid false sharing on MP systems ...
2033     OM_PERFDATA_OP(Inflations, inc());
2034     if (log_is_enabled(Trace, monitorinflation)) {
2035       ResourceMark rm(self);
2036       lsh.print_cr(&quot;inflate(neutral): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2037                    INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
2038                    object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
2039     }
2040     if (event.should_commit()) {
2041       post_monitor_inflate_event(&amp;event, object, cause);
2042     }
2043     return m;
2044   }
2045 }
2046 
2047 
2048 // We maintain a list of in-use monitors for each thread.
2049 //
2050 // For safepoint based deflation:
2051 // deflate_thread_local_monitors() scans a single thread&#39;s in-use list, while
2052 // deflate_idle_monitors() scans only a global list of in-use monitors which
2053 // is populated only as a thread dies (see om_flush()).
2054 //
2055 // These operations are called at all safepoints, immediately after mutators
2056 // are stopped, but before any objects have moved. Collectively they traverse
2057 // the population of in-use monitors, deflating where possible. The scavenged
2058 // monitors are returned to the global monitor free list.
2059 //
2060 // Beware that we scavenge at *every* stop-the-world point. Having a large
2061 // number of monitors in-use could negatively impact performance. We also want
2062 // to minimize the total # of monitors in circulation, as they incur a small
2063 // footprint penalty.
2064 //
2065 // Perversely, the heap size -- and thus the STW safepoint rate --
2066 // typically drives the scavenge rate.  Large heaps can mean infrequent GC,
2067 // which in turn can mean large(r) numbers of ObjectMonitors in circulation.
2068 // This is an unfortunate aspect of this design.
2069 //
2070 // For async deflation:
2071 // If a special deflation request is made, then the safepoint based
2072 // deflation mechanism is used. Otherwise, an async deflation request
2073 // is registered with the ServiceThread and it is notified.
2074 
2075 void ObjectSynchronizer::do_safepoint_work(DeflateMonitorCounters* counters) {
2076   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2077 
2078   // The per-thread in-use lists are handled in
2079   // ParallelSPCleanupThreadClosure::do_thread().
2080 
<a name="7" id="anc7"></a><span class="line-modified">2081   if (!AsyncDeflateIdleMonitors) {</span>
<span class="line-modified">2082     // Use the older mechanism for the global in-use list.</span>

2083     ObjectSynchronizer::deflate_idle_monitors(counters);
2084     return;
2085   }
2086 
2087   log_debug(monitorinflation)(&quot;requesting async deflation of idle monitors.&quot;);
2088   // Request deflation of idle monitors by the ServiceThread:
2089   set_is_async_deflation_requested(true);
2090   MonitorLocker ml(Service_lock, Mutex::_no_safepoint_check_flag);
2091   ml.notify_all();
2092 
2093   if (log_is_enabled(Debug, monitorinflation)) {
2094     // exit_globals()&#39;s call to audit_and_print_stats() is done
2095     // at the Info level and not at a safepoint.
2096     // For safepoint based deflation, audit_and_print_stats() is called
2097     // in ObjectSynchronizer::finish_deflate_idle_monitors() at the
2098     // Debug level at a safepoint.
2099     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2100   }
2101 }
2102 
2103 // Deflate a single monitor if not in-use
2104 // Return true if deflated, false if in-use
2105 bool ObjectSynchronizer::deflate_monitor(ObjectMonitor* mid, oop obj,
2106                                          ObjectMonitor** free_head_p,
2107                                          ObjectMonitor** free_tail_p) {
2108   bool deflated;
2109   // Normal case ... The monitor is associated with obj.
2110   const markWord mark = obj-&gt;mark();
2111   guarantee(mark == markWord::encode(mid), &quot;should match: mark=&quot;
2112             INTPTR_FORMAT &quot;, encoded mid=&quot; INTPTR_FORMAT, mark.value(),
2113             markWord::encode(mid).value());
2114   // Make sure that mark.monitor() and markWord::encode() agree:
2115   guarantee(mark.monitor() == mid, &quot;should match: monitor()=&quot; INTPTR_FORMAT
2116             &quot;, mid=&quot; INTPTR_FORMAT, p2i(mark.monitor()), p2i(mid));
2117   const markWord dmw = mid-&gt;header();
2118   guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
2119 
2120   if (mid-&gt;is_busy()) {
2121     // Easy checks are first - the ObjectMonitor is busy so no deflation.
2122     deflated = false;
2123   } else {
2124     // Deflate the monitor if it is no longer being used
2125     // It&#39;s idle - scavenge and return to the global free list
2126     // plain old deflation ...
2127     if (log_is_enabled(Trace, monitorinflation)) {
2128       ResourceMark rm;
2129       log_trace(monitorinflation)(&quot;deflate_monitor: &quot;
2130                                   &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2131                                   INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(obj),
2132                                   mark.value(), obj-&gt;klass()-&gt;external_name());
2133     }
2134 
2135     // Restore the header back to obj
2136     obj-&gt;release_set_mark(dmw);
2137     if (AsyncDeflateIdleMonitors) {
2138       // clear() expects the owner field to be NULL.
2139       // DEFLATER_MARKER is the only non-NULL value we should see here.
2140       mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
2141     }
2142     mid-&gt;clear();
2143 
2144     assert(mid-&gt;object() == NULL, &quot;invariant: object=&quot; INTPTR_FORMAT,
2145            p2i(mid-&gt;object()));
2146     assert(mid-&gt;is_free(), &quot;invariant&quot;);
2147 
2148     // Move the deflated ObjectMonitor to the working free list
2149     // defined by free_head_p and free_tail_p.
2150     if (*free_head_p == NULL) *free_head_p = mid;
2151     if (*free_tail_p != NULL) {
2152       // We append to the list so the caller can use mid-&gt;_next_om
2153       // to fix the linkages in its context.
2154       ObjectMonitor* prevtail = *free_tail_p;
2155       // Should have been cleaned up by the caller:
2156       // Note: Should not have to lock prevtail here since we&#39;re at a
2157       // safepoint and ObjectMonitors on the local free list should
2158       // not be accessed in parallel.
2159 #ifdef ASSERT
2160       ObjectMonitor* l_next_om = prevtail-&gt;next_om();
2161 #endif
2162       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2163       prevtail-&gt;set_next_om(mid);
2164     }
2165     *free_tail_p = mid;
2166     // At this point, mid-&gt;_next_om still refers to its current
2167     // value and another ObjectMonitor&#39;s _next_om field still
2168     // refers to this ObjectMonitor. Those linkages have to be
2169     // cleaned up by the caller who has the complete context.
2170     deflated = true;
2171   }
2172   return deflated;
2173 }
2174 
2175 // Deflate the specified ObjectMonitor if not in-use using a JavaThread.
2176 // Returns true if it was deflated and false otherwise.
2177 //
2178 // The async deflation protocol sets owner to DEFLATER_MARKER and
2179 // makes contentions negative as signals to contending threads that
2180 // an async deflation is in progress. There are a number of checks
2181 // as part of the protocol to make sure that the calling thread has
2182 // not lost the race to a contending thread.
2183 //
2184 // The ObjectMonitor has been successfully async deflated when:
2185 //   (contentions &lt; 0)
2186 // Contending threads that see that condition know to retry their operation.
2187 //
2188 bool ObjectSynchronizer::deflate_monitor_using_JT(ObjectMonitor* mid,
2189                                                   ObjectMonitor** free_head_p,
2190                                                   ObjectMonitor** free_tail_p) {
2191   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2192   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2193   // A newly allocated ObjectMonitor should not be seen here so we
2194   // avoid an endless inflate/deflate cycle.
2195   assert(mid-&gt;is_old(), &quot;must be old: allocation_state=%d&quot;,
2196          (int) mid-&gt;allocation_state());
2197 
2198   if (mid-&gt;is_busy()) {
2199     // Easy checks are first - the ObjectMonitor is busy so no deflation.
2200     return false;
2201   }
2202 
2203   // Set a NULL owner to DEFLATER_MARKER to force any contending thread
2204   // through the slow path. This is just the first part of the async
2205   // deflation dance.
2206   if (mid-&gt;try_set_owner_from(NULL, DEFLATER_MARKER) != NULL) {
2207     // The owner field is no longer NULL so we lost the race since the
2208     // ObjectMonitor is now busy.
2209     return false;
2210   }
2211 
2212   if (mid-&gt;contentions() &gt; 0 || mid-&gt;_waiters != 0) {
2213     // Another thread has raced to enter the ObjectMonitor after
2214     // mid-&gt;is_busy() above or has already entered and waited on
2215     // it which makes it busy so no deflation. Restore owner to
2216     // NULL if it is still DEFLATER_MARKER.
2217     if (mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL) != DEFLATER_MARKER) {
2218       // Deferred decrement for the JT EnterI() that cancelled the async deflation.
2219       mid-&gt;add_to_contentions(-1);
2220     }
2221     return false;
2222   }
2223 
2224   // Make a zero contentions field negative to force any contending threads
2225   // to retry. This is the second part of the async deflation dance.
2226   if (Atomic::cmpxchg(&amp;mid-&gt;_contentions, (jint)0, -max_jint) != 0) {
2227     // Contentions was no longer 0 so we lost the race since the
2228     // ObjectMonitor is now busy. Restore owner to NULL if it is
2229     // still DEFLATER_MARKER:
2230     if (mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL) != DEFLATER_MARKER) {
2231       // Deferred decrement for the JT EnterI() that cancelled the async deflation.
2232       mid-&gt;add_to_contentions(-1);
2233     }
2234     return false;
2235   }
2236 
2237   // Sanity checks for the races:
2238   guarantee(mid-&gt;owner_is_DEFLATER_MARKER(), &quot;must be deflater marker&quot;);
2239   guarantee(mid-&gt;contentions() &lt; 0, &quot;must be negative: contentions=%d&quot;,
2240             mid-&gt;contentions());
2241   guarantee(mid-&gt;_waiters == 0, &quot;must be 0: waiters=%d&quot;, mid-&gt;_waiters);
2242   guarantee(mid-&gt;_cxq == NULL, &quot;must be no contending threads: cxq=&quot;
2243             INTPTR_FORMAT, p2i(mid-&gt;_cxq));
2244   guarantee(mid-&gt;_EntryList == NULL,
2245             &quot;must be no entering threads: EntryList=&quot; INTPTR_FORMAT,
2246             p2i(mid-&gt;_EntryList));
2247 
2248   const oop obj = (oop) mid-&gt;object();
2249   if (log_is_enabled(Trace, monitorinflation)) {
2250     ResourceMark rm;
2251     log_trace(monitorinflation)(&quot;deflate_monitor_using_JT: &quot;
2252                                 &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2253                                 INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;,
2254                                 p2i(obj), obj-&gt;mark().value(),
2255                                 obj-&gt;klass()-&gt;external_name());
2256   }
2257 
2258   // Install the old mark word if nobody else has already done it.
2259   mid-&gt;install_displaced_markword_in_object(obj);
2260   mid-&gt;clear_common();
2261 
2262   assert(mid-&gt;object() == NULL, &quot;must be NULL: object=&quot; INTPTR_FORMAT,
2263          p2i(mid-&gt;object()));
2264   assert(mid-&gt;is_free(), &quot;must be free: allocation_state=%d&quot;,
2265          (int)mid-&gt;allocation_state());
2266 
2267   // Move the deflated ObjectMonitor to the working free list
2268   // defined by free_head_p and free_tail_p.
2269   if (*free_head_p == NULL) {
2270     // First one on the list.
2271     *free_head_p = mid;
2272   }
2273   if (*free_tail_p != NULL) {
2274     // We append to the list so the caller can use mid-&gt;_next_om
2275     // to fix the linkages in its context.
2276     ObjectMonitor* prevtail = *free_tail_p;
2277     // prevtail should have been cleaned up by the caller:
2278 #ifdef ASSERT
2279     ObjectMonitor* l_next_om = unmarked_next(prevtail);
2280 #endif
2281     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2282     om_lock(prevtail);
2283     prevtail-&gt;set_next_om(mid);  // prevtail now points to mid (and is unlocked)
2284   }
2285   *free_tail_p = mid;
2286 
2287   // At this point, mid-&gt;_next_om still refers to its current
2288   // value and another ObjectMonitor&#39;s _next_om field still
2289   // refers to this ObjectMonitor. Those linkages have to be
2290   // cleaned up by the caller who has the complete context.
2291 
2292   // We leave owner == DEFLATER_MARKER and contentions &lt; 0
2293   // to force any racing threads to retry.
2294   return true;  // Success, ObjectMonitor has been deflated.
2295 }
2296 
2297 // Walk a given monitor list, and deflate idle monitors.
2298 // The given list could be a per-thread list or a global list.
2299 //
2300 // In the case of parallel processing of thread local monitor lists,
2301 // work is done by Threads::parallel_threads_do() which ensures that
2302 // each Java thread is processed by exactly one worker thread, and
2303 // thus avoid conflicts that would arise when worker threads would
2304 // process the same monitor lists concurrently.
2305 //
2306 // See also ParallelSPCleanupTask and
2307 // SafepointSynchronize::do_cleanup_tasks() in safepoint.cpp and
2308 // Threads::parallel_java_threads_do() in thread.cpp.
2309 int ObjectSynchronizer::deflate_monitor_list(ObjectMonitor** list_p,
2310                                              int* count_p,
2311                                              ObjectMonitor** free_head_p,
2312                                              ObjectMonitor** free_tail_p) {
2313   ObjectMonitor* cur_mid_in_use = NULL;
2314   ObjectMonitor* mid = NULL;
2315   ObjectMonitor* next = NULL;
2316   int deflated_count = 0;
2317 
2318   // This list walk executes at a safepoint and does not race with any
2319   // other list walkers.
2320 
2321   for (mid = Atomic::load(list_p); mid != NULL; mid = next) {
2322     next = unmarked_next(mid);
2323     oop obj = (oop) mid-&gt;object();
2324     if (obj != NULL &amp;&amp; deflate_monitor(mid, obj, free_head_p, free_tail_p)) {
2325       // Deflation succeeded and already updated free_head_p and
2326       // free_tail_p as needed. Finish the move to the local free list
2327       // by unlinking mid from the global or per-thread in-use list.
2328       if (cur_mid_in_use == NULL) {
2329         // mid is the list head so switch the list head to next:
2330         Atomic::store(list_p, next);
2331       } else {
2332         // Switch cur_mid_in_use&#39;s next field to next:
2333         cur_mid_in_use-&gt;set_next_om(next);
2334       }
2335       // At this point mid is disconnected from the in-use list.
2336       deflated_count++;
2337       Atomic::dec(count_p);
2338       // mid is current tail in the free_head_p list so NULL terminate it:
2339       mid-&gt;set_next_om(NULL);
2340     } else {
2341       cur_mid_in_use = mid;
2342     }
2343   }
2344   return deflated_count;
2345 }
2346 
2347 // Walk a given ObjectMonitor list and deflate idle ObjectMonitors using
2348 // a JavaThread. Returns the number of deflated ObjectMonitors. The given
2349 // list could be a per-thread in-use list or the global in-use list.
2350 // If a safepoint has started, then we save state via saved_mid_in_use_p
2351 // and return to the caller to honor the safepoint.
2352 //
2353 int ObjectSynchronizer::deflate_monitor_list_using_JT(ObjectMonitor** list_p,
2354                                                       int* count_p,
2355                                                       ObjectMonitor** free_head_p,
2356                                                       ObjectMonitor** free_tail_p,
2357                                                       ObjectMonitor** saved_mid_in_use_p) {
2358   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2359   JavaThread* self = JavaThread::current();
2360 
2361   ObjectMonitor* cur_mid_in_use = NULL;
2362   ObjectMonitor* mid = NULL;
2363   ObjectMonitor* next = NULL;
2364   ObjectMonitor* next_next = NULL;
2365   int deflated_count = 0;
2366   NoSafepointVerifier nsv;
2367 
2368   // We use the more complicated lock-cur_mid_in_use-and-mid-as-we-go
2369   // protocol because om_release() can do list deletions in parallel;
2370   // this also prevents races with a list walker thread. We also
2371   // lock-next-next-as-we-go to prevent an om_flush() that is behind
2372   // this thread from passing us.
2373   if (*saved_mid_in_use_p == NULL) {
2374     // No saved state so start at the beginning.
2375     // Lock the list head so we can possibly deflate it:
2376     if ((mid = get_list_head_locked(list_p)) == NULL) {
2377       return 0;  // The list is empty so nothing to deflate.
2378     }
2379     next = unmarked_next(mid);
2380   } else {
2381     // We&#39;re restarting after a safepoint so restore the necessary state
2382     // before we resume.
2383     cur_mid_in_use = *saved_mid_in_use_p;
2384     // Lock cur_mid_in_use so we can possibly update its
2385     // next field to extract a deflated ObjectMonitor.
2386     om_lock(cur_mid_in_use);
2387     mid = unmarked_next(cur_mid_in_use);
2388     if (mid == NULL) {
2389       om_unlock(cur_mid_in_use);
2390       *saved_mid_in_use_p = NULL;
2391       return 0;  // The remainder is empty so nothing more to deflate.
2392     }
2393     // Lock mid so we can possibly deflate it:
2394     om_lock(mid);
2395     next = unmarked_next(mid);
2396   }
2397 
2398   while (true) {
2399     // The current mid is locked at this point. If we have a
2400     // cur_mid_in_use, then it is also locked at this point.
2401 
2402     if (next != NULL) {
2403       // We lock next so that an om_flush() thread that is behind us
2404       // cannot pass us when we unlock the current mid.
2405       om_lock(next);
2406       next_next = unmarked_next(next);
2407     }
2408 
2409     // Only try to deflate if there is an associated Java object and if
2410     // mid is old (is not newly allocated and is not newly freed).
2411     if (mid-&gt;object() != NULL &amp;&amp; mid-&gt;is_old() &amp;&amp;
2412         deflate_monitor_using_JT(mid, free_head_p, free_tail_p)) {
2413       // Deflation succeeded and already updated free_head_p and
2414       // free_tail_p as needed. Finish the move to the local free list
2415       // by unlinking mid from the global or per-thread in-use list.
2416       if (cur_mid_in_use == NULL) {
2417         // mid is the list head and it is locked. Switch the list head
2418         // to next which is also locked (if not NULL) and also leave
2419         // mid locked:
2420         Atomic::store(list_p, next);
2421       } else {
2422         ObjectMonitor* locked_next = mark_om_ptr(next);
2423         // mid and cur_mid_in_use are locked. Switch cur_mid_in_use&#39;s
2424         // next field to locked_next and also leave mid locked:
2425         cur_mid_in_use-&gt;set_next_om(locked_next);
2426       }
2427       // At this point mid is disconnected from the in-use list so
2428       // its lock longer has any effects on in-use list.
2429       deflated_count++;
2430       Atomic::dec(count_p);
2431       // mid is current tail in the free_head_p list so NULL terminate it
2432       // (which also unlocks it):
2433       mid-&gt;set_next_om(NULL);
2434 
2435       // All the list management is done so move on to the next one:
2436       mid = next;  // mid keeps non-NULL next&#39;s locked state
2437       next = next_next;
2438     } else {
2439       // mid is considered in-use if it does not have an associated
2440       // Java object or mid is not old or deflation did not succeed.
2441       // A mid-&gt;is_new() node can be seen here when it is freshly
2442       // returned by om_alloc() (and skips the deflation code path).
2443       // A mid-&gt;is_old() node can be seen here when deflation failed.
2444       // A mid-&gt;is_free() node can be seen here when a fresh node from
2445       // om_alloc() is released by om_release() due to losing the race
2446       // in inflate().
2447 
2448       // All the list management is done so move on to the next one:
2449       if (cur_mid_in_use != NULL) {
2450         om_unlock(cur_mid_in_use);
2451       }
2452       // The next cur_mid_in_use keeps mid&#39;s lock state so
2453       // that it is stable for a possible next field change. It
2454       // cannot be modified by om_release() while it is locked.
2455       cur_mid_in_use = mid;
2456       mid = next;  // mid keeps non-NULL next&#39;s locked state
2457       next = next_next;
2458 
2459       if (SafepointMechanism::should_block(self) &amp;&amp;
2460           cur_mid_in_use != Atomic::load(list_p) &amp;&amp; cur_mid_in_use-&gt;is_old()) {
2461         // If a safepoint has started and cur_mid_in_use is not the list
2462         // head and is old, then it is safe to use as saved state. Return
2463         // to the caller before blocking.
2464         *saved_mid_in_use_p = cur_mid_in_use;
2465         om_unlock(cur_mid_in_use);
2466         if (mid != NULL) {
2467           om_unlock(mid);
2468         }
2469         return deflated_count;
2470       }
2471     }
2472     if (mid == NULL) {
2473       if (cur_mid_in_use != NULL) {
2474         om_unlock(cur_mid_in_use);
2475       }
2476       break;  // Reached end of the list so nothing more to deflate.
2477     }
2478 
2479     // The current mid&#39;s next field is locked at this point. If we have
2480     // a cur_mid_in_use, then it is also locked at this point.
2481   }
2482   // We finished the list without a safepoint starting so there&#39;s
2483   // no need to save state.
2484   *saved_mid_in_use_p = NULL;
2485   return deflated_count;
2486 }
2487 
2488 void ObjectSynchronizer::prepare_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2489   counters-&gt;n_in_use = 0;              // currently associated with objects
2490   counters-&gt;n_in_circulation = 0;      // extant
2491   counters-&gt;n_scavenged = 0;           // reclaimed (global and per-thread)
2492   counters-&gt;per_thread_scavenged = 0;  // per-thread scavenge total
2493   counters-&gt;per_thread_times = 0.0;    // per-thread scavenge times
2494 }
2495 
2496 void ObjectSynchronizer::deflate_idle_monitors(DeflateMonitorCounters* counters) {
2497   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2498 
2499   if (AsyncDeflateIdleMonitors) {
2500     // Nothing to do when global idle ObjectMonitors are deflated using
<a name="8" id="anc8"></a><span class="line-modified">2501     // a JavaThread.</span>
<span class="line-modified">2502     return;</span>


2503   }
2504 
2505   bool deflated = false;
2506 
2507   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2508   ObjectMonitor* free_tail_p = NULL;
2509   elapsedTimer timer;
2510 
2511   if (log_is_enabled(Info, monitorinflation)) {
2512     timer.start();
2513   }
2514 
2515   // Note: the thread-local monitors lists get deflated in
2516   // a separate pass. See deflate_thread_local_monitors().
2517 
2518   // For moribund threads, scan om_list_globals._in_use_list
2519   int deflated_count = 0;
2520   if (Atomic::load(&amp;om_list_globals._in_use_list) != NULL) {
2521     // Update n_in_circulation before om_list_globals._in_use_count is
2522     // updated by deflation.
2523     Atomic::add(&amp;counters-&gt;n_in_circulation,
2524                 Atomic::load(&amp;om_list_globals._in_use_count));
2525 
2526     deflated_count = deflate_monitor_list(&amp;om_list_globals._in_use_list,
2527                                           &amp;om_list_globals._in_use_count,
2528                                           &amp;free_head_p, &amp;free_tail_p);
2529     Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;om_list_globals._in_use_count));
2530   }
2531 
2532   if (free_head_p != NULL) {
2533     // Move the deflated ObjectMonitors back to the global free list.
2534     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2535 #ifdef ASSERT
2536     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2537 #endif
2538     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2539     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2540     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2541   }
2542   timer.stop();
2543 
2544   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2545   LogStreamHandle(Info, monitorinflation) lsh_info;
2546   LogStream* ls = NULL;
2547   if (log_is_enabled(Debug, monitorinflation)) {
2548     ls = &amp;lsh_debug;
2549   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2550     ls = &amp;lsh_info;
2551   }
2552   if (ls != NULL) {
2553     ls-&gt;print_cr(&quot;deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2554   }
2555 }
2556 
2557 class HandshakeForDeflation : public HandshakeClosure {
2558  public:
2559   HandshakeForDeflation() : HandshakeClosure(&quot;HandshakeForDeflation&quot;) {}
2560 
2561   void do_thread(Thread* thread) {
2562     log_trace(monitorinflation)(&quot;HandshakeForDeflation::do_thread: thread=&quot;
2563                                 INTPTR_FORMAT, p2i(thread));
2564   }
2565 };
2566 
2567 void ObjectSynchronizer::deflate_idle_monitors_using_JT() {
2568   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2569 
2570   // Deflate any global idle monitors.
2571   deflate_global_idle_monitors_using_JT();
2572 
2573   int count = 0;
2574   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2575     if (Atomic::load(&amp;jt-&gt;om_in_use_count) &gt; 0 &amp;&amp; !jt-&gt;is_exiting()) {
2576       // This JavaThread is using ObjectMonitors so deflate any that
2577       // are idle unless this JavaThread is exiting; do not race with
2578       // ObjectSynchronizer::om_flush().
2579       deflate_per_thread_idle_monitors_using_JT(jt);
2580       count++;
2581     }
2582   }
2583   if (count &gt; 0) {
2584     log_debug(monitorinflation)(&quot;did async deflation of idle monitors for %d thread(s).&quot;, count);
2585   }
2586 
2587   log_info(monitorinflation)(&quot;async global_population=%d, global_in_use_count=%d, &quot;
2588                              &quot;global_free_count=%d, global_wait_count=%d&quot;,
2589                              Atomic::load(&amp;om_list_globals._population),
2590                              Atomic::load(&amp;om_list_globals._in_use_count),
2591                              Atomic::load(&amp;om_list_globals._free_count),
2592                              Atomic::load(&amp;om_list_globals._wait_count));
2593 
2594   // The ServiceThread&#39;s async deflation request has been processed.
<a name="9" id="anc9"></a><span class="line-added">2595   _last_async_deflation_time_ns = os::javaTimeNanos();</span>
2596   set_is_async_deflation_requested(false);
2597 
2598   if (Atomic::load(&amp;om_list_globals._wait_count) &gt; 0) {
2599     // There are deflated ObjectMonitors waiting for a handshake
2600     // (or a safepoint) for safety.
2601 
2602     ObjectMonitor* list = Atomic::load(&amp;om_list_globals._wait_list);
2603     ADIM_guarantee(list != NULL, &quot;om_list_globals._wait_list must not be NULL&quot;);
2604     int count = Atomic::load(&amp;om_list_globals._wait_count);
2605     Atomic::store(&amp;om_list_globals._wait_count, 0);
2606     Atomic::store(&amp;om_list_globals._wait_list, (ObjectMonitor*)NULL);
2607 
2608     // Find the tail for prepend_list_to_common(). No need to mark
2609     // ObjectMonitors for this list walk since only the deflater
2610     // thread manages the wait list.
2611     int l_count = 0;
2612     ObjectMonitor* tail = NULL;
2613     for (ObjectMonitor* n = list; n != NULL; n = unmarked_next(n)) {
2614       tail = n;
2615       l_count++;
2616     }
2617     ADIM_guarantee(count == l_count, &quot;count=%d != l_count=%d&quot;, count, l_count);
2618 
2619     // Will execute a safepoint if !ThreadLocalHandshakes:
2620     HandshakeForDeflation hfd_hc;
2621     Handshake::execute(&amp;hfd_hc);
2622 
2623     prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
2624                            &amp;om_list_globals._free_count);
2625 
2626     log_info(monitorinflation)(&quot;moved %d idle monitors from global waiting list to global free list&quot;, count);
2627   }
2628 }
2629 
2630 // Deflate global idle ObjectMonitors using a JavaThread.
2631 //
2632 void ObjectSynchronizer::deflate_global_idle_monitors_using_JT() {
2633   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2634   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2635   JavaThread* self = JavaThread::current();
2636 
2637   deflate_common_idle_monitors_using_JT(true /* is_global */, self);
2638 }
2639 
2640 // Deflate the specified JavaThread&#39;s idle ObjectMonitors using a JavaThread.
2641 //
2642 void ObjectSynchronizer::deflate_per_thread_idle_monitors_using_JT(JavaThread* target) {
2643   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2644   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2645 
2646   deflate_common_idle_monitors_using_JT(false /* !is_global */, target);
2647 }
2648 
2649 // Deflate global or per-thread idle ObjectMonitors using a JavaThread.
2650 //
2651 void ObjectSynchronizer::deflate_common_idle_monitors_using_JT(bool is_global, JavaThread* target) {
2652   JavaThread* self = JavaThread::current();
2653 
2654   int deflated_count = 0;
2655   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged ObjectMonitors
2656   ObjectMonitor* free_tail_p = NULL;
2657   ObjectMonitor* saved_mid_in_use_p = NULL;
2658   elapsedTimer timer;
2659 
2660   if (log_is_enabled(Info, monitorinflation)) {
2661     timer.start();
2662   }
2663 
2664   if (is_global) {
2665     OM_PERFDATA_OP(MonExtant, set_value(Atomic::load(&amp;om_list_globals._in_use_count)));
2666   } else {
2667     OM_PERFDATA_OP(MonExtant, inc(Atomic::load(&amp;target-&gt;om_in_use_count)));
2668   }
2669 
2670   do {
<a name="10" id="anc10"></a>









2671     int local_deflated_count;
2672     if (is_global) {
2673       local_deflated_count =
2674           deflate_monitor_list_using_JT(&amp;om_list_globals._in_use_list,
2675                                         &amp;om_list_globals._in_use_count,
2676                                         &amp;free_head_p, &amp;free_tail_p,
2677                                         &amp;saved_mid_in_use_p);
2678     } else {
2679       local_deflated_count =
2680           deflate_monitor_list_using_JT(&amp;target-&gt;om_in_use_list,
2681                                         &amp;target-&gt;om_in_use_count, &amp;free_head_p,
2682                                         &amp;free_tail_p, &amp;saved_mid_in_use_p);
2683     }
2684     deflated_count += local_deflated_count;
2685 
2686     if (free_head_p != NULL) {
2687       // Move the deflated ObjectMonitors to the global free list.
2688       guarantee(free_tail_p != NULL &amp;&amp; local_deflated_count &gt; 0, &quot;free_tail_p=&quot; INTPTR_FORMAT &quot;, local_deflated_count=%d&quot;, p2i(free_tail_p), local_deflated_count);
2689       // Note: The target thread can be doing an om_alloc() that
2690       // is trying to prepend an ObjectMonitor on its in-use list
2691       // at the same time that we have deflated the current in-use
2692       // list head and put it on the local free list. prepend_to_common()
2693       // will detect the race and retry which avoids list corruption,
2694       // but the next field in free_tail_p can flicker to marked
2695       // and then unmarked while prepend_to_common() is sorting it
2696       // all out.
2697 #ifdef ASSERT
2698       ObjectMonitor* l_next_om = unmarked_next(free_tail_p);
2699 #endif
2700       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2701 
2702       prepend_list_to_global_wait_list(free_head_p, free_tail_p, local_deflated_count);
2703 
2704       OM_PERFDATA_OP(Deflations, inc(local_deflated_count));
2705     }
2706 
2707     if (saved_mid_in_use_p != NULL) {
2708       // deflate_monitor_list_using_JT() detected a safepoint starting.
2709       timer.stop();
2710       {
2711         if (is_global) {
2712           log_debug(monitorinflation)(&quot;pausing deflation of global idle monitors for a safepoint.&quot;);
2713         } else {
2714           log_debug(monitorinflation)(&quot;jt=&quot; INTPTR_FORMAT &quot;: pausing deflation of per-thread idle monitors for a safepoint.&quot;, p2i(target));
2715         }
2716         assert(SafepointMechanism::should_block(self), &quot;sanity check&quot;);
2717         ThreadBlockInVM blocker(self);
2718       }
2719       // Prepare for another loop after the safepoint.
2720       free_head_p = NULL;
2721       free_tail_p = NULL;
2722       if (log_is_enabled(Info, monitorinflation)) {
2723         timer.start();
2724       }
2725     }
2726   } while (saved_mid_in_use_p != NULL);
2727   timer.stop();
2728 
2729   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2730   LogStreamHandle(Info, monitorinflation) lsh_info;
2731   LogStream* ls = NULL;
2732   if (log_is_enabled(Debug, monitorinflation)) {
2733     ls = &amp;lsh_debug;
2734   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2735     ls = &amp;lsh_info;
2736   }
2737   if (ls != NULL) {
2738     if (is_global) {
2739       ls-&gt;print_cr(&quot;async-deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2740     } else {
2741       ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: async-deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(target), timer.seconds(), deflated_count);
2742     }
2743   }
2744 }
2745 
2746 void ObjectSynchronizer::finish_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2747   // Report the cumulative time for deflating each thread&#39;s idle
2748   // monitors. Note: if the work is split among more than one
2749   // worker thread, then the reported time will likely be more
2750   // than a beginning to end measurement of the phase.
2751   log_info(safepoint, cleanup)(&quot;deflating per-thread idle monitors, %3.7f secs, monitors=%d&quot;, counters-&gt;per_thread_times, counters-&gt;per_thread_scavenged);
2752 
<a name="11" id="anc11"></a><span class="line-modified">2753   if (AsyncDeflateIdleMonitors) {</span>

2754     // Nothing to do when idle ObjectMonitors are deflated using
<a name="12" id="anc12"></a><span class="line-modified">2755     // a JavaThread.</span>
2756     return;
2757   }
2758 
2759   if (log_is_enabled(Debug, monitorinflation)) {
2760     // exit_globals()&#39;s call to audit_and_print_stats() is done
2761     // at the Info level and not at a safepoint.
2762     // For async deflation, audit_and_print_stats() is called in
2763     // ObjectSynchronizer::do_safepoint_work() at the Debug level
2764     // at a safepoint.
2765     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2766   } else if (log_is_enabled(Info, monitorinflation)) {
2767     log_info(monitorinflation)(&quot;global_population=%d, global_in_use_count=%d, &quot;
2768                                &quot;global_free_count=%d, global_wait_count=%d&quot;,
2769                                Atomic::load(&amp;om_list_globals._population),
2770                                Atomic::load(&amp;om_list_globals._in_use_count),
2771                                Atomic::load(&amp;om_list_globals._free_count),
2772                                Atomic::load(&amp;om_list_globals._wait_count));
2773   }
2774 
2775   OM_PERFDATA_OP(Deflations, inc(counters-&gt;n_scavenged));
2776   OM_PERFDATA_OP(MonExtant, set_value(counters-&gt;n_in_circulation));
2777 
2778   GVars.stw_random = os::random();
2779   GVars.stw_cycle++;
<a name="13" id="anc13"></a>



2780 }
2781 
2782 void ObjectSynchronizer::deflate_thread_local_monitors(Thread* thread, DeflateMonitorCounters* counters) {
2783   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2784 
<a name="14" id="anc14"></a><span class="line-modified">2785   if (AsyncDeflateIdleMonitors) {</span>
<span class="line-modified">2786     // Nothing to do when per-thread idle ObjectMonitors are deflated</span>
<span class="line-added">2787     // using a JavaThread.</span>
2788     return;
2789   }
2790 
2791   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2792   ObjectMonitor* free_tail_p = NULL;
2793   elapsedTimer timer;
2794 
2795   if (log_is_enabled(Info, safepoint, cleanup) ||
2796       log_is_enabled(Info, monitorinflation)) {
2797     timer.start();
2798   }
2799 
2800   // Update n_in_circulation before om_in_use_count is updated by deflation.
2801   Atomic::add(&amp;counters-&gt;n_in_circulation, Atomic::load(&amp;thread-&gt;om_in_use_count));
2802 
2803   int deflated_count = deflate_monitor_list(&amp;thread-&gt;om_in_use_list, &amp;thread-&gt;om_in_use_count, &amp;free_head_p, &amp;free_tail_p);
2804   Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;thread-&gt;om_in_use_count));
2805 
2806   if (free_head_p != NULL) {
2807     // Move the deflated ObjectMonitors back to the global free list.
2808     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2809 #ifdef ASSERT
2810     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2811 #endif
2812     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2813     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2814     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2815     Atomic::add(&amp;counters-&gt;per_thread_scavenged, deflated_count);
2816   }
2817 
2818   timer.stop();
2819   counters-&gt;per_thread_times += timer.seconds();
2820 
2821   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2822   LogStreamHandle(Info, monitorinflation) lsh_info;
2823   LogStream* ls = NULL;
2824   if (log_is_enabled(Debug, monitorinflation)) {
2825     ls = &amp;lsh_debug;
2826   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2827     ls = &amp;lsh_info;
2828   }
2829   if (ls != NULL) {
2830     ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(thread), timer.seconds(), deflated_count);
2831   }
2832 }
2833 
2834 // Monitor cleanup on JavaThread::exit
2835 
2836 // Iterate through monitor cache and attempt to release thread&#39;s monitors
2837 // Gives up on a particular monitor if an exception occurs, but continues
2838 // the overall iteration, swallowing the exception.
2839 class ReleaseJavaMonitorsClosure: public MonitorClosure {
2840  private:
2841   TRAPS;
2842 
2843  public:
2844   ReleaseJavaMonitorsClosure(Thread* thread) : THREAD(thread) {}
2845   void do_monitor(ObjectMonitor* mid) {
2846     if (mid-&gt;owner() == THREAD) {
2847       (void)mid-&gt;complete_exit(CHECK);
2848     }
2849   }
2850 };
2851 
2852 // Release all inflated monitors owned by THREAD.  Lightweight monitors are
2853 // ignored.  This is meant to be called during JNI thread detach which assumes
2854 // all remaining monitors are heavyweight.  All exceptions are swallowed.
2855 // Scanning the extant monitor list can be time consuming.
2856 // A simple optimization is to add a per-thread flag that indicates a thread
2857 // called jni_monitorenter() during its lifetime.
2858 //
2859 // Instead of No_Savepoint_Verifier it might be cheaper to
2860 // use an idiom of the form:
2861 //   auto int tmp = SafepointSynchronize::_safepoint_counter ;
2862 //   &lt;code that must not run at safepoint&gt;
2863 //   guarantee (((tmp ^ _safepoint_counter) | (tmp &amp; 1)) == 0) ;
2864 // Since the tests are extremely cheap we could leave them enabled
2865 // for normal product builds.
2866 
2867 void ObjectSynchronizer::release_monitors_owned_by_thread(TRAPS) {
2868   assert(THREAD == JavaThread::current(), &quot;must be current Java thread&quot;);
2869   NoSafepointVerifier nsv;
2870   ReleaseJavaMonitorsClosure rjmc(THREAD);
2871   ObjectSynchronizer::monitors_iterate(&amp;rjmc);
2872   THREAD-&gt;clear_pending_exception();
2873 }
2874 
2875 const char* ObjectSynchronizer::inflate_cause_name(const InflateCause cause) {
2876   switch (cause) {
2877     case inflate_cause_vm_internal:    return &quot;VM Internal&quot;;
2878     case inflate_cause_monitor_enter:  return &quot;Monitor Enter&quot;;
2879     case inflate_cause_wait:           return &quot;Monitor Wait&quot;;
2880     case inflate_cause_notify:         return &quot;Monitor Notify&quot;;
2881     case inflate_cause_hash_code:      return &quot;Monitor Hash Code&quot;;
2882     case inflate_cause_jni_enter:      return &quot;JNI Monitor Enter&quot;;
2883     case inflate_cause_jni_exit:       return &quot;JNI Monitor Exit&quot;;
2884     default:
2885       ShouldNotReachHere();
2886   }
2887   return &quot;Unknown&quot;;
2888 }
2889 
2890 //------------------------------------------------------------------------------
2891 // Debugging code
2892 
2893 u_char* ObjectSynchronizer::get_gvars_addr() {
2894   return (u_char*)&amp;GVars;
2895 }
2896 
2897 u_char* ObjectSynchronizer::get_gvars_hc_sequence_addr() {
2898   return (u_char*)&amp;GVars.hc_sequence;
2899 }
2900 
2901 size_t ObjectSynchronizer::get_gvars_size() {
2902   return sizeof(SharedGlobals);
2903 }
2904 
2905 u_char* ObjectSynchronizer::get_gvars_stw_random_addr() {
2906   return (u_char*)&amp;GVars.stw_random;
2907 }
2908 
2909 // This function can be called at a safepoint or it can be called when
2910 // we are trying to exit the VM. When we are trying to exit the VM, the
2911 // list walker functions can run in parallel with the other list
2912 // operations so spin-locking is used for safety.
2913 //
2914 // Calls to this function can be added in various places as a debugging
2915 // aid; pass &#39;true&#39; for the &#39;on_exit&#39; parameter to have in-use monitor
2916 // details logged at the Info level and &#39;false&#39; for the &#39;on_exit&#39;
2917 // parameter to have in-use monitor details logged at the Trace level.
2918 // deflate_monitor_list() no longer uses spin-locking so be careful
2919 // when adding audit_and_print_stats() calls at a safepoint.
2920 //
2921 void ObjectSynchronizer::audit_and_print_stats(bool on_exit) {
2922   assert(on_exit || SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
2923 
2924   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2925   LogStreamHandle(Info, monitorinflation) lsh_info;
2926   LogStreamHandle(Trace, monitorinflation) lsh_trace;
2927   LogStream* ls = NULL;
2928   if (log_is_enabled(Trace, monitorinflation)) {
2929     ls = &amp;lsh_trace;
2930   } else if (log_is_enabled(Debug, monitorinflation)) {
2931     ls = &amp;lsh_debug;
2932   } else if (log_is_enabled(Info, monitorinflation)) {
2933     ls = &amp;lsh_info;
2934   }
2935   assert(ls != NULL, &quot;sanity check&quot;);
2936 
2937   // Log counts for the global and per-thread monitor lists:
2938   int chk_om_population = log_monitor_list_counts(ls);
2939   int error_cnt = 0;
2940 
2941   ls-&gt;print_cr(&quot;Checking global lists:&quot;);
2942 
2943   // Check om_list_globals._population:
2944   if (Atomic::load(&amp;om_list_globals._population) == chk_om_population) {
2945     ls-&gt;print_cr(&quot;global_population=%d equals chk_om_population=%d&quot;,
2946                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2947   } else {
2948     // With fine grained locks on the monitor lists, it is possible for
2949     // log_monitor_list_counts() to return a value that doesn&#39;t match
2950     // om_list_globals._population. So far a higher value has been
2951     // seen in testing so something is being double counted by
2952     // log_monitor_list_counts().
2953     ls-&gt;print_cr(&quot;WARNING: global_population=%d is not equal to &quot;
2954                  &quot;chk_om_population=%d&quot;,
2955                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2956   }
2957 
2958   // Check om_list_globals._in_use_list and om_list_globals._in_use_count:
2959   chk_global_in_use_list_and_count(ls, &amp;error_cnt);
2960 
2961   // Check om_list_globals._free_list and om_list_globals._free_count:
2962   chk_global_free_list_and_count(ls, &amp;error_cnt);
2963 
2964   // Check om_list_globals._wait_list and om_list_globals._wait_count:
2965   chk_global_wait_list_and_count(ls, &amp;error_cnt);
2966 
2967   ls-&gt;print_cr(&quot;Checking per-thread lists:&quot;);
2968 
2969   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2970     // Check om_in_use_list and om_in_use_count:
2971     chk_per_thread_in_use_list_and_count(jt, ls, &amp;error_cnt);
2972 
2973     // Check om_free_list and om_free_count:
2974     chk_per_thread_free_list_and_count(jt, ls, &amp;error_cnt);
2975   }
2976 
2977   if (error_cnt == 0) {
2978     ls-&gt;print_cr(&quot;No errors found in monitor list checks.&quot;);
2979   } else {
2980     log_error(monitorinflation)(&quot;found monitor list errors: error_cnt=%d&quot;, error_cnt);
2981   }
2982 
2983   if ((on_exit &amp;&amp; log_is_enabled(Info, monitorinflation)) ||
2984       (!on_exit &amp;&amp; log_is_enabled(Trace, monitorinflation))) {
2985     // When exiting this log output is at the Info level. When called
2986     // at a safepoint, this log output is at the Trace level since
2987     // there can be a lot of it.
2988     log_in_use_monitor_details(ls);
2989   }
2990 
2991   ls-&gt;flush();
2992 
2993   guarantee(error_cnt == 0, &quot;ERROR: found monitor list errors: error_cnt=%d&quot;, error_cnt);
2994 }
2995 
2996 // Check a free monitor entry; log any errors.
2997 void ObjectSynchronizer::chk_free_entry(JavaThread* jt, ObjectMonitor* n,
2998                                         outputStream * out, int *error_cnt_p) {
2999   stringStream ss;
3000   if (n-&gt;is_busy()) {
3001     if (jt != NULL) {
3002       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3003                     &quot;: free per-thread monitor must not be busy: %s&quot;, p2i(jt),
3004                     p2i(n), n-&gt;is_busy_to_string(&amp;ss));
3005     } else {
3006       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
3007                     &quot;must not be busy: %s&quot;, p2i(n), n-&gt;is_busy_to_string(&amp;ss));
3008     }
3009     *error_cnt_p = *error_cnt_p + 1;
3010   }
3011   if (n-&gt;header().value() != 0) {
3012     if (jt != NULL) {
3013       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3014                     &quot;: free per-thread monitor must have NULL _header &quot;
3015                     &quot;field: _header=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
3016                     n-&gt;header().value());
3017       *error_cnt_p = *error_cnt_p + 1;
3018     } else if (!AsyncDeflateIdleMonitors) {
3019       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
3020                     &quot;must have NULL _header field: _header=&quot; INTPTR_FORMAT,
3021                     p2i(n), n-&gt;header().value());
3022       *error_cnt_p = *error_cnt_p + 1;
3023     }
3024   }
3025   if (n-&gt;object() != NULL) {
3026     if (jt != NULL) {
3027       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3028                     &quot;: free per-thread monitor must have NULL _object &quot;
3029                     &quot;field: _object=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
3030                     p2i(n-&gt;object()));
3031     } else {
3032       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
3033                     &quot;must have NULL _object field: _object=&quot; INTPTR_FORMAT,
3034                     p2i(n), p2i(n-&gt;object()));
3035     }
3036     *error_cnt_p = *error_cnt_p + 1;
3037   }
3038 }
3039 
3040 // Lock the next ObjectMonitor for traversal and unlock the current
3041 // ObjectMonitor. Returns the next ObjectMonitor if there is one.
3042 // Otherwise returns NULL (after unlocking the current ObjectMonitor).
3043 // This function is used by the various list walker functions to
3044 // safely walk a list without allowing an ObjectMonitor to be moved
3045 // to another list in the middle of a walk.
3046 static ObjectMonitor* lock_next_for_traversal(ObjectMonitor* cur) {
3047   assert(is_locked(cur), &quot;cur=&quot; INTPTR_FORMAT &quot; must be locked&quot;, p2i(cur));
3048   ObjectMonitor* next = unmarked_next(cur);
3049   if (next == NULL) {  // Reached the end of the list.
3050     om_unlock(cur);
3051     return NULL;
3052   }
3053   om_lock(next);   // Lock next before unlocking current to keep
3054   om_unlock(cur);  // from being by-passed by another thread.
3055   return next;
3056 }
3057 
3058 // Check the global free list and count; log the results of the checks.
3059 void ObjectSynchronizer::chk_global_free_list_and_count(outputStream * out,
3060                                                         int *error_cnt_p) {
3061   int chk_om_free_count = 0;
3062   ObjectMonitor* cur = NULL;
3063   if ((cur = get_list_head_locked(&amp;om_list_globals._free_list)) != NULL) {
3064     // Marked the global free list head so process the list.
3065     while (true) {
3066       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
3067       chk_om_free_count++;
3068 
3069       cur = lock_next_for_traversal(cur);
3070       if (cur == NULL) {
3071         break;
3072       }
3073     }
3074   }
3075   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
3076   if (l_free_count == chk_om_free_count) {
3077     out-&gt;print_cr(&quot;global_free_count=%d equals chk_om_free_count=%d&quot;,
3078                   l_free_count, chk_om_free_count);
3079   } else {
3080     // With fine grained locks on om_list_globals._free_list, it
3081     // is possible for an ObjectMonitor to be prepended to
3082     // om_list_globals._free_list after we started calculating
3083     // chk_om_free_count so om_list_globals._free_count may not
3084     // match anymore.
3085     out-&gt;print_cr(&quot;WARNING: global_free_count=%d is not equal to &quot;
3086                   &quot;chk_om_free_count=%d&quot;, l_free_count, chk_om_free_count);
3087   }
3088 }
3089 
3090 // Check the global wait list and count; log the results of the checks.
3091 void ObjectSynchronizer::chk_global_wait_list_and_count(outputStream * out,
3092                                                         int *error_cnt_p) {
3093   int chk_om_wait_count = 0;
3094   ObjectMonitor* cur = NULL;
3095   if ((cur = get_list_head_locked(&amp;om_list_globals._wait_list)) != NULL) {
3096     // Marked the global wait list head so process the list.
3097     while (true) {
3098       // Rules for om_list_globals._wait_list are the same as for
3099       // om_list_globals._free_list:
3100       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
3101       chk_om_wait_count++;
3102 
3103       cur = lock_next_for_traversal(cur);
3104       if (cur == NULL) {
3105         break;
3106       }
3107     }
3108   }
3109   if (Atomic::load(&amp;om_list_globals._wait_count) == chk_om_wait_count) {
3110     out-&gt;print_cr(&quot;global_wait_count=%d equals chk_om_wait_count=%d&quot;,
3111                   Atomic::load(&amp;om_list_globals._wait_count), chk_om_wait_count);
3112   } else {
3113     out-&gt;print_cr(&quot;ERROR: global_wait_count=%d is not equal to &quot;
3114                   &quot;chk_om_wait_count=%d&quot;,
3115                   Atomic::load(&amp;om_list_globals._wait_count), chk_om_wait_count);
3116     *error_cnt_p = *error_cnt_p + 1;
3117   }
3118 }
3119 
3120 // Check the global in-use list and count; log the results of the checks.
3121 void ObjectSynchronizer::chk_global_in_use_list_and_count(outputStream * out,
3122                                                           int *error_cnt_p) {
3123   int chk_om_in_use_count = 0;
3124   ObjectMonitor* cur = NULL;
3125   if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
3126     // Marked the global in-use list head so process the list.
3127     while (true) {
3128       chk_in_use_entry(NULL /* jt */, cur, out, error_cnt_p);
3129       chk_om_in_use_count++;
3130 
3131       cur = lock_next_for_traversal(cur);
3132       if (cur == NULL) {
3133         break;
3134       }
3135     }
3136   }
3137   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
3138   if (l_in_use_count == chk_om_in_use_count) {
3139     out-&gt;print_cr(&quot;global_in_use_count=%d equals chk_om_in_use_count=%d&quot;,
3140                   l_in_use_count, chk_om_in_use_count);
3141   } else {
3142     // With fine grained locks on the monitor lists, it is possible for
3143     // an exiting JavaThread to put its in-use ObjectMonitors on the
3144     // global in-use list after chk_om_in_use_count is calculated above.
3145     out-&gt;print_cr(&quot;WARNING: global_in_use_count=%d is not equal to chk_om_in_use_count=%d&quot;,
3146                   l_in_use_count, chk_om_in_use_count);
3147   }
3148 }
3149 
3150 // Check an in-use monitor entry; log any errors.
3151 void ObjectSynchronizer::chk_in_use_entry(JavaThread* jt, ObjectMonitor* n,
3152                                           outputStream * out, int *error_cnt_p) {
3153   if (n-&gt;header().value() == 0) {
3154     if (jt != NULL) {
3155       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3156                     &quot;: in-use per-thread monitor must have non-NULL _header &quot;
3157                     &quot;field.&quot;, p2i(jt), p2i(n));
3158     } else {
3159       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
3160                     &quot;must have non-NULL _header field.&quot;, p2i(n));
3161     }
3162     *error_cnt_p = *error_cnt_p + 1;
3163   }
3164   if (n-&gt;object() == NULL) {
3165     if (jt != NULL) {
3166       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3167                     &quot;: in-use per-thread monitor must have non-NULL _object &quot;
3168                     &quot;field.&quot;, p2i(jt), p2i(n));
3169     } else {
3170       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
3171                     &quot;must have non-NULL _object field.&quot;, p2i(n));
3172     }
3173     *error_cnt_p = *error_cnt_p + 1;
3174   }
3175   const oop obj = (oop)n-&gt;object();
3176   const markWord mark = obj-&gt;mark();
3177   if (!mark.has_monitor()) {
3178     if (jt != NULL) {
3179       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3180                     &quot;: in-use per-thread monitor&#39;s object does not think &quot;
3181                     &quot;it has a monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
3182                     INTPTR_FORMAT,  p2i(jt), p2i(n), p2i(obj), mark.value());
3183     } else {
3184       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
3185                     &quot;monitor&#39;s object does not think it has a monitor: obj=&quot;
3186                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT, p2i(n),
3187                     p2i(obj), mark.value());
3188     }
3189     *error_cnt_p = *error_cnt_p + 1;
3190   }
3191   ObjectMonitor* const obj_mon = mark.monitor();
3192   if (n != obj_mon) {
3193     if (jt != NULL) {
3194       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3195                     &quot;: in-use per-thread monitor&#39;s object does not refer &quot;
3196                     &quot;to the same monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
3197                     INTPTR_FORMAT &quot;, obj_mon=&quot; INTPTR_FORMAT, p2i(jt),
3198                     p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
3199     } else {
3200       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
3201                     &quot;monitor&#39;s object does not refer to the same monitor: obj=&quot;
3202                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT &quot;, obj_mon=&quot;
3203                     INTPTR_FORMAT, p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
3204     }
3205     *error_cnt_p = *error_cnt_p + 1;
3206   }
3207 }
3208 
3209 // Check the thread&#39;s free list and count; log the results of the checks.
3210 void ObjectSynchronizer::chk_per_thread_free_list_and_count(JavaThread *jt,
3211                                                             outputStream * out,
3212                                                             int *error_cnt_p) {
3213   int chk_om_free_count = 0;
3214   ObjectMonitor* cur = NULL;
3215   if ((cur = get_list_head_locked(&amp;jt-&gt;om_free_list)) != NULL) {
3216     // Marked the per-thread free list head so process the list.
3217     while (true) {
3218       chk_free_entry(jt, cur, out, error_cnt_p);
3219       chk_om_free_count++;
3220 
3221       cur = lock_next_for_traversal(cur);
3222       if (cur == NULL) {
3223         break;
3224       }
3225     }
3226   }
3227   int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
3228   if (l_om_free_count == chk_om_free_count) {
3229     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d equals &quot;
3230                   &quot;chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count, chk_om_free_count);
3231   } else {
3232     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d is not &quot;
3233                   &quot;equal to chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count,
3234                   chk_om_free_count);
3235     *error_cnt_p = *error_cnt_p + 1;
3236   }
3237 }
3238 
3239 // Check the thread&#39;s in-use list and count; log the results of the checks.
3240 void ObjectSynchronizer::chk_per_thread_in_use_list_and_count(JavaThread *jt,
3241                                                               outputStream * out,
3242                                                               int *error_cnt_p) {
3243   int chk_om_in_use_count = 0;
3244   ObjectMonitor* cur = NULL;
3245   if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
3246     // Marked the per-thread in-use list head so process the list.
3247     while (true) {
3248       chk_in_use_entry(jt, cur, out, error_cnt_p);
3249       chk_om_in_use_count++;
3250 
3251       cur = lock_next_for_traversal(cur);
3252       if (cur == NULL) {
3253         break;
3254       }
3255     }
3256   }
3257   int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
3258   if (l_om_in_use_count == chk_om_in_use_count) {
3259     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d equals &quot;
3260                   &quot;chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
3261                   chk_om_in_use_count);
3262   } else {
3263     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d is not &quot;
3264                   &quot;equal to chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
3265                   chk_om_in_use_count);
3266     *error_cnt_p = *error_cnt_p + 1;
3267   }
3268 }
3269 
3270 // Log details about ObjectMonitors on the in-use lists. The &#39;BHL&#39;
3271 // flags indicate why the entry is in-use, &#39;object&#39; and &#39;object type&#39;
3272 // indicate the associated object and its type.
3273 void ObjectSynchronizer::log_in_use_monitor_details(outputStream * out) {
3274   stringStream ss;
3275   if (Atomic::load(&amp;om_list_globals._in_use_count) &gt; 0) {
3276     out-&gt;print_cr(&quot;In-use global monitor info:&quot;);
3277     out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
3278     out-&gt;print_cr(&quot;%18s  %s  %18s  %18s&quot;,
3279                   &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
3280     out-&gt;print_cr(&quot;==================  ===  ==================  ==================&quot;);
3281     ObjectMonitor* cur = NULL;
3282     if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
3283       // Marked the global in-use list head so process the list.
3284       while (true) {
3285         const oop obj = (oop) cur-&gt;object();
3286         const markWord mark = cur-&gt;header();
3287         ResourceMark rm;
3288         out-&gt;print(INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT &quot;  %s&quot;, p2i(cur),
3289                    cur-&gt;is_busy() != 0, mark.hash() != 0, cur-&gt;owner() != NULL,
3290                    p2i(obj), obj-&gt;klass()-&gt;external_name());
3291         if (cur-&gt;is_busy() != 0) {
3292           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
3293           ss.reset();
3294         }
3295         out-&gt;cr();
3296 
3297         cur = lock_next_for_traversal(cur);
3298         if (cur == NULL) {
3299           break;
3300         }
3301       }
3302     }
3303   }
3304 
3305   out-&gt;print_cr(&quot;In-use per-thread monitor info:&quot;);
3306   out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
3307   out-&gt;print_cr(&quot;%18s  %18s  %s  %18s  %18s&quot;,
3308                 &quot;jt&quot;, &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
3309   out-&gt;print_cr(&quot;==================  ==================  ===  ==================  ==================&quot;);
3310   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
3311     ObjectMonitor* cur = NULL;
3312     if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
3313       // Marked the global in-use list head so process the list.
3314       while (true) {
3315         const oop obj = (oop) cur-&gt;object();
3316         const markWord mark = cur-&gt;header();
3317         ResourceMark rm;
3318         out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT
3319                    &quot;  %s&quot;, p2i(jt), p2i(cur), cur-&gt;is_busy() != 0,
3320                    mark.hash() != 0, cur-&gt;owner() != NULL, p2i(obj),
3321                    obj-&gt;klass()-&gt;external_name());
3322         if (cur-&gt;is_busy() != 0) {
3323           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
3324           ss.reset();
3325         }
3326         out-&gt;cr();
3327 
3328         cur = lock_next_for_traversal(cur);
3329         if (cur == NULL) {
3330           break;
3331         }
3332       }
3333     }
3334   }
3335 
3336   out-&gt;flush();
3337 }
3338 
3339 // Log counts for the global and per-thread monitor lists and return
3340 // the population count.
3341 int ObjectSynchronizer::log_monitor_list_counts(outputStream * out) {
3342   int pop_count = 0;
3343   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s  %10s&quot;,
3344                 &quot;Global Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Wait&quot;, &quot;Total&quot;);
3345   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========  ==========&quot;);
3346   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
3347   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
3348   int l_wait_count = Atomic::load(&amp;om_list_globals._wait_count);
3349   out-&gt;print_cr(&quot;%18s  %10d  %10d  %10d  %10d&quot;, &quot;&quot;, l_in_use_count,
3350                 l_free_count, l_wait_count,
3351                 Atomic::load(&amp;om_list_globals._population));
3352   pop_count += l_in_use_count + l_free_count + l_wait_count;
3353 
3354   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s&quot;,
3355                 &quot;Per-Thread Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Provision&quot;);
3356   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========&quot;);
3357 
3358   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
3359     int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
3360     int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
3361     out-&gt;print_cr(INTPTR_FORMAT &quot;  %10d  %10d  %10d&quot;, p2i(jt),
3362                   l_om_in_use_count, l_om_free_count, jt-&gt;om_free_provision);
3363     pop_count += l_om_in_use_count + l_om_free_count;
3364   }
3365   return pop_count;
3366 }
3367 
3368 #ifndef PRODUCT
3369 
3370 // Check if monitor belongs to the monitor cache
3371 // The list is grow-only so it&#39;s *relatively* safe to traverse
3372 // the list of extant blocks without taking a lock.
3373 
3374 int ObjectSynchronizer::verify_objmon_isinpool(ObjectMonitor *monitor) {
3375   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
3376   while (block != NULL) {
3377     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
3378     if (monitor &gt; &amp;block[0] &amp;&amp; monitor &lt; &amp;block[_BLOCKSIZE]) {
3379       address mon = (address)monitor;
3380       address blk = (address)block;
3381       size_t diff = mon - blk;
3382       assert((diff % sizeof(PaddedObjectMonitor)) == 0, &quot;must be aligned&quot;);
3383       return 1;
3384     }
3385     // unmarked_next() is not needed with g_block_list (no locking
3386     // used with block linkage _next_om fields).
3387     block = (PaddedObjectMonitor*)block-&gt;next_om();
3388   }
3389   return 0;
3390 }
3391 
3392 #endif
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>