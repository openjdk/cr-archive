<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/synchronizer.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;logging/log.hpp&quot;
  28 #include &quot;logging/logStream.hpp&quot;
  29 #include &quot;jfr/jfrEvents.hpp&quot;
  30 #include &quot;memory/allocation.inline.hpp&quot;
  31 #include &quot;memory/metaspaceShared.hpp&quot;
  32 #include &quot;memory/padded.hpp&quot;
  33 #include &quot;memory/resourceArea.hpp&quot;
  34 #include &quot;memory/universe.hpp&quot;
  35 #include &quot;oops/markWord.hpp&quot;
  36 #include &quot;oops/oop.inline.hpp&quot;
  37 #include &quot;runtime/atomic.hpp&quot;
  38 #include &quot;runtime/biasedLocking.hpp&quot;
  39 #include &quot;runtime/handles.inline.hpp&quot;
  40 #include &quot;runtime/handshake.hpp&quot;
  41 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  42 #include &quot;runtime/mutexLocker.hpp&quot;
  43 #include &quot;runtime/objectMonitor.hpp&quot;
  44 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  45 #include &quot;runtime/osThread.hpp&quot;
  46 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  47 #include &quot;runtime/safepointVerifiers.hpp&quot;
  48 #include &quot;runtime/sharedRuntime.hpp&quot;
  49 #include &quot;runtime/stubRoutines.hpp&quot;
  50 #include &quot;runtime/synchronizer.hpp&quot;
  51 #include &quot;runtime/thread.inline.hpp&quot;
  52 #include &quot;runtime/timer.hpp&quot;
  53 #include &quot;runtime/vframe.hpp&quot;
  54 #include &quot;runtime/vmThread.hpp&quot;
  55 #include &quot;utilities/align.hpp&quot;
  56 #include &quot;utilities/dtrace.hpp&quot;
  57 #include &quot;utilities/events.hpp&quot;
  58 #include &quot;utilities/preserveException.hpp&quot;
  59 
  60 // The &quot;core&quot; versions of monitor enter and exit reside in this file.
  61 // The interpreter and compilers contain specialized transliterated
  62 // variants of the enter-exit fast-path operations.  See i486.ad fast_lock(),
  63 // for instance.  If you make changes here, make sure to modify the
  64 // interpreter, and both C1 and C2 fast-path inline locking code emission.
  65 //
  66 // -----------------------------------------------------------------------------
  67 
  68 #ifdef DTRACE_ENABLED
  69 
  70 // Only bother with this argument setup if dtrace is available
  71 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  72 
  73 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  74   char* bytes = NULL;                                                      \
  75   int len = 0;                                                             \
  76   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  77   Symbol* klassname = ((oop)(obj))-&gt;klass()-&gt;name();                       \
  78   if (klassname != NULL) {                                                 \
  79     bytes = (char*)klassname-&gt;bytes();                                     \
  80     len = klassname-&gt;utf8_length();                                        \
  81   }
  82 
  83 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  84   {                                                                        \
  85     if (DTraceMonitorProbes) {                                             \
  86       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  87       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  88                            (uintptr_t)(monitor), bytes, len, (millis));    \
  89     }                                                                      \
  90   }
  91 
  92 #define HOTSPOT_MONITOR_PROBE_notify HOTSPOT_MONITOR_NOTIFY
  93 #define HOTSPOT_MONITOR_PROBE_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  94 #define HOTSPOT_MONITOR_PROBE_waited HOTSPOT_MONITOR_WAITED
  95 
  96 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  97   {                                                                        \
  98     if (DTraceMonitorProbes) {                                             \
  99       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
 100       HOTSPOT_MONITOR_PROBE_##probe(jtid, /* probe = waited */             \
 101                                     (uintptr_t)(monitor), bytes, len);     \
 102     }                                                                      \
 103   }
 104 
 105 #else //  ndef DTRACE_ENABLED
 106 
 107 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
 108 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
 109 
 110 #endif // ndef DTRACE_ENABLED
 111 
 112 // This exists only as a workaround of dtrace bug 6254741
 113 int dtrace_waited_probe(ObjectMonitor* monitor, Handle obj, Thread* thr) {
 114   DTRACE_MONITOR_PROBE(waited, monitor, obj(), thr);
 115   return 0;
 116 }
 117 
 118 #define NINFLATIONLOCKS 256
 119 static volatile intptr_t gInflationLocks[NINFLATIONLOCKS];
 120 
 121 // global list of blocks of monitors
 122 PaddedObjectMonitor* ObjectSynchronizer::g_block_list = NULL;
 123 bool volatile ObjectSynchronizer::_is_async_deflation_requested = false;
<a name="1" id="anc1"></a><span class="line-removed"> 124 bool volatile ObjectSynchronizer::_is_special_deflation_requested = false;</span>
 125 jlong ObjectSynchronizer::_last_async_deflation_time_ns = 0;
 126 
 127 struct ObjectMonitorListGlobals {
 128   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 129   // These are highly shared list related variables.
 130   // To avoid false-sharing they need to be the sole occupants of a cache line.
 131 
 132   // Global ObjectMonitor free list. Newly allocated and deflated
 133   // ObjectMonitors are prepended here.
 134   ObjectMonitor* _free_list;
 135   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 136 
 137   // Global ObjectMonitor in-use list. When a JavaThread is exiting,
 138   // ObjectMonitors on its per-thread in-use list are prepended here.
 139   ObjectMonitor* _in_use_list;
 140   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 141 
 142   // Global ObjectMonitor wait list. Deflated ObjectMonitors wait on
 143   // this list until after a handshake or a safepoint for platforms
 144   // that don&#39;t support handshakes. After the handshake or safepoint,
 145   // the deflated ObjectMonitors are prepended to free_list.
 146   ObjectMonitor* _wait_list;
 147   DEFINE_PAD_MINUS_SIZE(3, OM_CACHE_LINE_SIZE, sizeof(ObjectMonitor*));
 148 
 149   int _free_count;    // # on free_list
 150   DEFINE_PAD_MINUS_SIZE(4, OM_CACHE_LINE_SIZE, sizeof(int));
 151 
 152   int _in_use_count;  // # on in_use_list
 153   DEFINE_PAD_MINUS_SIZE(5, OM_CACHE_LINE_SIZE, sizeof(int));
 154 
 155   int _population;    // # Extant -- in circulation
 156   DEFINE_PAD_MINUS_SIZE(6, OM_CACHE_LINE_SIZE, sizeof(int));
 157 
 158   int _wait_count;    // # on wait_list
 159   DEFINE_PAD_MINUS_SIZE(7, OM_CACHE_LINE_SIZE, sizeof(int));
 160 };
 161 static ObjectMonitorListGlobals om_list_globals;
 162 
 163 #define CHECK_THROW_NOSYNC_IMSE(obj)  \
 164   if ((obj)-&gt;mark().is_always_locked()) {  \
 165     ResourceMark rm(THREAD);                \
 166     THROW_MSG(vmSymbols::java_lang_IllegalMonitorStateException(), obj-&gt;klass()-&gt;external_name()); \
 167   }
 168 
 169 #define CHECK_THROW_NOSYNC_IMSE_0(obj)  \
 170     if ((obj)-&gt;mark().is_always_locked()) {  \
 171     ResourceMark rm(THREAD);                  \
 172     THROW_MSG_0(vmSymbols::java_lang_IllegalMonitorStateException(), obj-&gt;klass()-&gt;external_name()); \
 173   }
 174 
 175 
 176 #define CHAINMARKER (cast_to_oop&lt;intptr_t&gt;(-1))
 177 
 178 
 179 // =====================&gt; Spin-lock functions
 180 
 181 // ObjectMonitors are not lockable outside of this file. We use spin-locks
 182 // implemented using a bit in the _next_om field instead of the heavier
 183 // weight locking mechanisms for faster list management.
 184 
 185 #define OM_LOCK_BIT 0x1
 186 
 187 // Return true if the ObjectMonitor is locked.
 188 // Otherwise returns false.
 189 static bool is_locked(ObjectMonitor* om) {
 190   return ((intptr_t)om-&gt;next_om() &amp; OM_LOCK_BIT) == OM_LOCK_BIT;
 191 }
 192 
 193 // Mark an ObjectMonitor* with OM_LOCK_BIT and return it.
 194 static ObjectMonitor* mark_om_ptr(ObjectMonitor* om) {
 195   return (ObjectMonitor*)((intptr_t)om | OM_LOCK_BIT);
 196 }
 197 
 198 // Return the unmarked next field in an ObjectMonitor. Note: the next
 199 // field may or may not have been marked with OM_LOCK_BIT originally.
 200 static ObjectMonitor* unmarked_next(ObjectMonitor* om) {
 201   return (ObjectMonitor*)((intptr_t)om-&gt;next_om() &amp; ~OM_LOCK_BIT);
 202 }
 203 
 204 // Try to lock an ObjectMonitor. Returns true if locking was successful.
 205 // Otherwise returns false.
 206 static bool try_om_lock(ObjectMonitor* om) {
 207   // Get current next field without any OM_LOCK_BIT value.
 208   ObjectMonitor* next = unmarked_next(om);
 209   if (om-&gt;try_set_next_om(next, mark_om_ptr(next)) != next) {
 210     return false;  // Cannot lock the ObjectMonitor.
 211   }
 212   return true;
 213 }
 214 
 215 // Lock an ObjectMonitor.
 216 static void om_lock(ObjectMonitor* om) {
 217   while (true) {
 218     if (try_om_lock(om)) {
 219       return;
 220     }
 221   }
 222 }
 223 
 224 // Unlock an ObjectMonitor.
 225 static void om_unlock(ObjectMonitor* om) {
 226   ObjectMonitor* next = om-&gt;next_om();
 227   guarantee(((intptr_t)next &amp; OM_LOCK_BIT) == OM_LOCK_BIT, &quot;next=&quot; INTPTR_FORMAT
 228             &quot; must have OM_LOCK_BIT=%x set.&quot;, p2i(next), OM_LOCK_BIT);
 229 
 230   next = (ObjectMonitor*)((intptr_t)next &amp; ~OM_LOCK_BIT);  // Clear OM_LOCK_BIT.
 231   om-&gt;set_next_om(next);
 232 }
 233 
 234 // Get the list head after locking it. Returns the list head or NULL
 235 // if the list is empty.
 236 static ObjectMonitor* get_list_head_locked(ObjectMonitor** list_p) {
 237   while (true) {
 238     ObjectMonitor* mid = Atomic::load(list_p);
 239     if (mid == NULL) {
 240       return NULL;  // The list is empty.
 241     }
 242     if (try_om_lock(mid)) {
 243       if (Atomic::load(list_p) != mid) {
 244         // The list head changed before we could lock it so we have to retry.
 245         om_unlock(mid);
 246         continue;
 247       }
 248       return mid;
 249     }
 250   }
 251 }
 252 
 253 #undef OM_LOCK_BIT
 254 
 255 
 256 // =====================&gt; List Management functions
 257 
 258 // Prepend a list of ObjectMonitors to the specified *list_p. &#39;tail&#39; is
 259 // the last ObjectMonitor in the list and there are &#39;count&#39; on the list.
 260 // Also updates the specified *count_p.
 261 static void prepend_list_to_common(ObjectMonitor* list, ObjectMonitor* tail,
 262                                    int count, ObjectMonitor** list_p,
 263                                    int* count_p) {
 264   while (true) {
 265     ObjectMonitor* cur = Atomic::load(list_p);
 266     // Prepend list to *list_p.
 267     if (!try_om_lock(tail)) {
 268       // Failed to lock tail due to a list walker so try it all again.
 269       continue;
 270     }
 271     tail-&gt;set_next_om(cur);  // tail now points to cur (and unlocks tail)
 272     if (cur == NULL) {
 273       // No potential race with takers or other prependers since
 274       // *list_p is empty.
 275       if (Atomic::cmpxchg(list_p, cur, list) == cur) {
 276         // Successfully switched *list_p to the list value.
 277         Atomic::add(count_p, count);
 278         break;
 279       }
 280       // Implied else: try it all again
 281     } else {
 282       if (!try_om_lock(cur)) {
 283         continue;  // failed to lock cur so try it all again
 284       }
 285       // We locked cur so try to switch *list_p to the list value.
 286       if (Atomic::cmpxchg(list_p, cur, list) != cur) {
 287         // The list head has changed so unlock cur and try again:
 288         om_unlock(cur);
 289         continue;
 290       }
 291       Atomic::add(count_p, count);
 292       om_unlock(cur);
 293       break;
 294     }
 295   }
 296 }
 297 
 298 // Prepend a newly allocated block of ObjectMonitors to g_block_list and
 299 // om_list_globals._free_list. Also updates om_list_globals._population
 300 // and om_list_globals._free_count.
 301 void ObjectSynchronizer::prepend_block_to_lists(PaddedObjectMonitor* new_blk) {
 302   // First we handle g_block_list:
 303   while (true) {
 304     PaddedObjectMonitor* cur = Atomic::load(&amp;g_block_list);
 305     // Prepend new_blk to g_block_list. The first ObjectMonitor in
 306     // a block is reserved for use as linkage to the next block.
 307     new_blk[0].set_next_om(cur);
 308     if (Atomic::cmpxchg(&amp;g_block_list, cur, new_blk) == cur) {
 309       // Successfully switched g_block_list to the new_blk value.
 310       Atomic::add(&amp;om_list_globals._population, _BLOCKSIZE - 1);
 311       break;
 312     }
 313     // Implied else: try it all again
 314   }
 315 
 316   // Second we handle om_list_globals._free_list:
 317   prepend_list_to_common(new_blk + 1, &amp;new_blk[_BLOCKSIZE - 1], _BLOCKSIZE - 1,
 318                          &amp;om_list_globals._free_list, &amp;om_list_globals._free_count);
 319 }
 320 
 321 // Prepend a list of ObjectMonitors to om_list_globals._free_list.
 322 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 323 // on the list. Also updates om_list_globals._free_count.
 324 static void prepend_list_to_global_free_list(ObjectMonitor* list,
 325                                              ObjectMonitor* tail, int count) {
 326   prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
 327                          &amp;om_list_globals._free_count);
 328 }
 329 
 330 // Prepend a list of ObjectMonitors to om_list_globals._wait_list.
 331 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 332 // on the list. Also updates om_list_globals._wait_count.
 333 static void prepend_list_to_global_wait_list(ObjectMonitor* list,
 334                                              ObjectMonitor* tail, int count) {
 335   prepend_list_to_common(list, tail, count, &amp;om_list_globals._wait_list,
 336                          &amp;om_list_globals._wait_count);
 337 }
 338 
 339 // Prepend a list of ObjectMonitors to om_list_globals._in_use_list.
 340 // &#39;tail&#39; is the last ObjectMonitor in the list and there are &#39;count&#39;
 341 // on the list. Also updates om_list_globals._in_use_list.
 342 static void prepend_list_to_global_in_use_list(ObjectMonitor* list,
 343                                                ObjectMonitor* tail, int count) {
 344   prepend_list_to_common(list, tail, count, &amp;om_list_globals._in_use_list,
 345                          &amp;om_list_globals._in_use_count);
 346 }
 347 
 348 // Prepend an ObjectMonitor to the specified list. Also updates
 349 // the specified counter.
 350 static void prepend_to_common(ObjectMonitor* m, ObjectMonitor** list_p,
 351                               int* count_p) {
 352   while (true) {
 353     om_lock(m);  // Lock m so we can safely update its next field.
 354     ObjectMonitor* cur = NULL;
 355     // Lock the list head to guard against races with a list walker
 356     // or async deflater thread (which only races in om_in_use_list):
 357     if ((cur = get_list_head_locked(list_p)) != NULL) {
 358       // List head is now locked so we can safely switch it.
 359       m-&gt;set_next_om(cur);  // m now points to cur (and unlocks m)
 360       Atomic::store(list_p, m);  // Switch list head to unlocked m.
 361       om_unlock(cur);
 362       break;
 363     }
 364     // The list is empty so try to set the list head.
 365     assert(cur == NULL, &quot;cur must be NULL: cur=&quot; INTPTR_FORMAT, p2i(cur));
 366     m-&gt;set_next_om(cur);  // m now points to NULL (and unlocks m)
 367     if (Atomic::cmpxchg(list_p, cur, m) == cur) {
 368       // List head is now unlocked m.
 369       break;
 370     }
 371     // Implied else: try it all again
 372   }
 373   Atomic::inc(count_p);
 374 }
 375 
 376 // Prepend an ObjectMonitor to a per-thread om_free_list.
 377 // Also updates the per-thread om_free_count.
 378 static void prepend_to_om_free_list(Thread* self, ObjectMonitor* m) {
 379   prepend_to_common(m, &amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 380 }
 381 
 382 // Prepend an ObjectMonitor to a per-thread om_in_use_list.
 383 // Also updates the per-thread om_in_use_count.
 384 static void prepend_to_om_in_use_list(Thread* self, ObjectMonitor* m) {
 385   prepend_to_common(m, &amp;self-&gt;om_in_use_list, &amp;self-&gt;om_in_use_count);
 386 }
 387 
 388 // Take an ObjectMonitor from the start of the specified list. Also
 389 // decrements the specified counter. Returns NULL if none are available.
 390 static ObjectMonitor* take_from_start_of_common(ObjectMonitor** list_p,
 391                                                 int* count_p) {
 392   ObjectMonitor* take = NULL;
 393   // Lock the list head to guard against races with a list walker
 394   // or async deflater thread (which only races in om_list_globals._free_list):
 395   if ((take = get_list_head_locked(list_p)) == NULL) {
 396     return NULL;  // None are available.
 397   }
 398   ObjectMonitor* next = unmarked_next(take);
 399   // Switch locked list head to next (which unlocks the list head, but
 400   // leaves take locked):
 401   Atomic::store(list_p, next);
 402   Atomic::dec(count_p);
 403   // Unlock take, but leave the next value for any lagging list
 404   // walkers. It will get cleaned up when take is prepended to
 405   // the in-use list:
 406   om_unlock(take);
 407   return take;
 408 }
 409 
 410 // Take an ObjectMonitor from the start of the om_list_globals._free_list.
 411 // Also updates om_list_globals._free_count. Returns NULL if none are
 412 // available.
 413 static ObjectMonitor* take_from_start_of_global_free_list() {
 414   return take_from_start_of_common(&amp;om_list_globals._free_list,
 415                                    &amp;om_list_globals._free_count);
 416 }
 417 
 418 // Take an ObjectMonitor from the start of a per-thread free-list.
 419 // Also updates om_free_count. Returns NULL if none are available.
 420 static ObjectMonitor* take_from_start_of_om_free_list(Thread* self) {
 421   return take_from_start_of_common(&amp;self-&gt;om_free_list, &amp;self-&gt;om_free_count);
 422 }
 423 
 424 
 425 // =====================&gt; Quick functions
 426 
 427 // The quick_* forms are special fast-path variants used to improve
 428 // performance.  In the simplest case, a &quot;quick_*&quot; implementation could
 429 // simply return false, in which case the caller will perform the necessary
 430 // state transitions and call the slow-path form.
 431 // The fast-path is designed to handle frequently arising cases in an efficient
 432 // manner and is just a degenerate &quot;optimistic&quot; variant of the slow-path.
 433 // returns true  -- to indicate the call was satisfied.
 434 // returns false -- to indicate the call needs the services of the slow-path.
 435 // A no-loitering ordinance is in effect for code in the quick_* family
 436 // operators: safepoints or indefinite blocking (blocking that might span a
 437 // safepoint) are forbidden. Generally the thread_state() is _in_Java upon
 438 // entry.
 439 //
 440 // Consider: An interesting optimization is to have the JIT recognize the
 441 // following common idiom:
 442 //   synchronized (someobj) { .... ; notify(); }
 443 // That is, we find a notify() or notifyAll() call that immediately precedes
 444 // the monitorexit operation.  In that case the JIT could fuse the operations
 445 // into a single notifyAndExit() runtime primitive.
 446 
 447 bool ObjectSynchronizer::quick_notify(oopDesc* obj, Thread* self, bool all) {
 448   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 449   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 450   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 451   NoSafepointVerifier nsv;
 452   if (obj == NULL) return false;  // slow-path for invalid obj
 453   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 454   const markWord mark = obj-&gt;mark();
 455 
 456   if (mark.has_locker() &amp;&amp; self-&gt;is_lock_owned((address)mark.locker())) {
 457     // Degenerate notify
 458     // stack-locked by caller so by definition the implied waitset is empty.
 459     return true;
 460   }
 461 
 462   if (mark.has_monitor()) {
 463     ObjectMonitor* const mon = mark.monitor();
 464     assert(mon-&gt;object() == obj, &quot;invariant&quot;);
 465     if (mon-&gt;owner() != self) return false;  // slow-path for IMS exception
 466 
 467     if (mon-&gt;first_waiter() != NULL) {
 468       // We have one or more waiters. Since this is an inflated monitor
 469       // that we own, we can transfer one or more threads from the waitset
 470       // to the entrylist here and now, avoiding the slow-path.
 471       if (all) {
 472         DTRACE_MONITOR_PROBE(notifyAll, mon, obj, self);
 473       } else {
 474         DTRACE_MONITOR_PROBE(notify, mon, obj, self);
 475       }
 476       int free_count = 0;
 477       do {
 478         mon-&gt;INotify(self);
 479         ++free_count;
 480       } while (mon-&gt;first_waiter() != NULL &amp;&amp; all);
 481       OM_PERFDATA_OP(Notifications, inc(free_count));
 482     }
 483     return true;
 484   }
 485 
 486   // biased locking and any other IMS exception states take the slow-path
 487   return false;
 488 }
 489 
 490 
 491 // The LockNode emitted directly at the synchronization site would have
 492 // been too big if it were to have included support for the cases of inflated
 493 // recursive enter and exit, so they go here instead.
 494 // Note that we can&#39;t safely call AsyncPrintJavaStack() from within
 495 // quick_enter() as our thread state remains _in_Java.
 496 
 497 bool ObjectSynchronizer::quick_enter(oop obj, Thread* self,
 498                                      BasicLock * lock) {
 499   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 500   assert(self-&gt;is_Java_thread(), &quot;invariant&quot;);
 501   assert(((JavaThread *) self)-&gt;thread_state() == _thread_in_Java, &quot;invariant&quot;);
 502   NoSafepointVerifier nsv;
 503   if (obj == NULL) return false;       // Need to throw NPE
 504   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 505   const markWord mark = obj-&gt;mark();
 506 
 507   if (mark.has_monitor()) {
 508     ObjectMonitor* const m = mark.monitor();
 509     if (AsyncDeflateIdleMonitors) {
 510       // An async deflation can race us before we manage to make the
 511       // ObjectMonitor busy by setting the owner below. If we detect
 512       // that race we just bail out to the slow-path here.
 513       if (m-&gt;object() == NULL) {
 514         return false;
 515       }
 516     } else {
 517       assert(m-&gt;object() == obj, &quot;invariant&quot;);
 518     }
 519     Thread* const owner = (Thread *) m-&gt;_owner;
 520 
 521     // Lock contention and Transactional Lock Elision (TLE) diagnostics
 522     // and observability
 523     // Case: light contention possibly amenable to TLE
 524     // Case: TLE inimical operations such as nested/recursive synchronization
 525 
 526     if (owner == self) {
 527       m-&gt;_recursions++;
 528       return true;
 529     }
 530 
 531     // This Java Monitor is inflated so obj&#39;s header will never be
 532     // displaced to this thread&#39;s BasicLock. Make the displaced header
 533     // non-NULL so this BasicLock is not seen as recursive nor as
 534     // being locked. We do this unconditionally so that this thread&#39;s
 535     // BasicLock cannot be mis-interpreted by any stack walkers. For
 536     // performance reasons, stack walkers generally first check for
 537     // Biased Locking in the object&#39;s header, the second check is for
 538     // stack-locking in the object&#39;s header, the third check is for
 539     // recursive stack-locking in the displaced header in the BasicLock,
 540     // and last are the inflated Java Monitor (ObjectMonitor) checks.
 541     lock-&gt;set_displaced_header(markWord::unused_mark());
 542 
 543     if (owner == NULL &amp;&amp; m-&gt;try_set_owner_from(NULL, self) == NULL) {
 544       assert(m-&gt;_recursions == 0, &quot;invariant&quot;);
 545       return true;
 546     }
 547   }
 548 
 549   // Note that we could inflate in quick_enter.
 550   // This is likely a useful optimization
 551   // Critically, in quick_enter() we must not:
 552   // -- perform bias revocation, or
 553   // -- block indefinitely, or
 554   // -- reach a safepoint
 555 
 556   return false;        // revert to slow-path
 557 }
 558 
 559 // -----------------------------------------------------------------------------
 560 // Monitor Enter/Exit
 561 // The interpreter and compiler assembly code tries to lock using the fast path
 562 // of this algorithm. Make sure to update that code if the following function is
 563 // changed. The implementation is extremely sensitive to race condition. Be careful.
 564 
 565 void ObjectSynchronizer::enter(Handle obj, BasicLock* lock, TRAPS) {
 566   CHECK_THROW_NOSYNC_IMSE(obj);
 567   if (UseBiasedLocking) {
 568     if (!SafepointSynchronize::is_at_safepoint()) {
 569       BiasedLocking::revoke(obj, THREAD);
 570     } else {
 571       BiasedLocking::revoke_at_safepoint(obj);
 572     }
 573   }
 574 
 575   markWord mark = obj-&gt;mark();
 576   assert(!mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 577 
 578   if (mark.is_neutral()) {
 579     // Anticipate successful CAS -- the ST of the displaced mark must
 580     // be visible &lt;= the ST performed by the CAS.
 581     lock-&gt;set_displaced_header(mark);
 582     if (mark == obj()-&gt;cas_set_mark(markWord::from_pointer(lock), mark)) {
 583       return;
 584     }
 585     // Fall through to inflate() ...
 586   } else if (mark.has_locker() &amp;&amp;
 587              THREAD-&gt;is_lock_owned((address)mark.locker())) {
 588     assert(lock != mark.locker(), &quot;must not re-lock the same lock&quot;);
 589     assert(lock != (BasicLock*)obj-&gt;mark().value(), &quot;don&#39;t relock with same BasicLock&quot;);
 590     lock-&gt;set_displaced_header(markWord::from_pointer(NULL));
 591     return;
 592   }
 593 
 594   // The object header will never be displaced to this lock,
 595   // so it does not matter what the value is, except that it
 596   // must be non-zero to avoid looking like a re-entrant lock,
 597   // and must not look locked either.
 598   lock-&gt;set_displaced_header(markWord::unused_mark());
 599   // An async deflation can race after the inflate() call and before
 600   // enter() can make the ObjectMonitor busy. enter() returns false if
 601   // we have lost the race to async deflation and we simply try again.
 602   while (true) {
 603     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_monitor_enter);
 604     if (monitor-&gt;enter(THREAD)) {
 605       return;
 606     }
 607   }
 608 }
 609 
 610 void ObjectSynchronizer::exit(oop object, BasicLock* lock, TRAPS) {
 611   markWord mark = object-&gt;mark();
 612   if (EnableValhalla &amp;&amp; mark.is_always_locked()) {
 613     return;
 614   }
 615   assert(!EnableValhalla || !object-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 616   // We cannot check for Biased Locking if we are racing an inflation.
 617   assert(mark == markWord::INFLATING() ||
 618          !mark.has_bias_pattern(), &quot;should not see bias pattern here&quot;);
 619 
 620   markWord dhw = lock-&gt;displaced_header();
 621   if (dhw.value() == 0) {
 622     // If the displaced header is NULL, then this exit matches up with
 623     // a recursive enter. No real work to do here except for diagnostics.
 624 #ifndef PRODUCT
 625     if (mark != markWord::INFLATING()) {
 626       // Only do diagnostics if we are not racing an inflation. Simply
 627       // exiting a recursive enter of a Java Monitor that is being
 628       // inflated is safe; see the has_monitor() comment below.
 629       assert(!mark.is_neutral(), &quot;invariant&quot;);
 630       assert(!mark.has_locker() ||
 631              THREAD-&gt;is_lock_owned((address)mark.locker()), &quot;invariant&quot;);
 632       if (mark.has_monitor()) {
 633         // The BasicLock&#39;s displaced_header is marked as a recursive
 634         // enter and we have an inflated Java Monitor (ObjectMonitor).
 635         // This is a special case where the Java Monitor was inflated
 636         // after this thread entered the stack-lock recursively. When a
 637         // Java Monitor is inflated, we cannot safely walk the Java
 638         // Monitor owner&#39;s stack and update the BasicLocks because a
 639         // Java Monitor can be asynchronously inflated by a thread that
 640         // does not own the Java Monitor.
 641         ObjectMonitor* m = mark.monitor();
 642         assert(((oop)(m-&gt;object()))-&gt;mark() == mark, &quot;invariant&quot;);
 643         assert(m-&gt;is_entered(THREAD), &quot;invariant&quot;);
 644       }
 645     }
 646 #endif
 647     return;
 648   }
 649 
 650   if (mark == markWord::from_pointer(lock)) {
 651     // If the object is stack-locked by the current thread, try to
 652     // swing the displaced header from the BasicLock back to the mark.
 653     assert(dhw.is_neutral(), &quot;invariant&quot;);
 654     if (object-&gt;cas_set_mark(dhw, mark) == mark) {
 655       return;
 656     }
 657   }
 658 
 659   // We have to take the slow-path of possible inflation and then exit.
 660   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 661   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 662   ObjectMonitor* monitor = inflate(THREAD, object, inflate_cause_vm_internal);
 663   monitor-&gt;exit(true, THREAD);
 664 }
 665 
 666 // -----------------------------------------------------------------------------
 667 // Class Loader  support to workaround deadlocks on the class loader lock objects
 668 // Also used by GC
 669 // complete_exit()/reenter() are used to wait on a nested lock
 670 // i.e. to give up an outer lock completely and then re-enter
 671 // Used when holding nested locks - lock acquisition order: lock1 then lock2
 672 //  1) complete_exit lock1 - saving recursion count
 673 //  2) wait on lock2
 674 //  3) when notified on lock2, unlock lock2
 675 //  4) reenter lock1 with original recursion count
 676 //  5) lock lock2
 677 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 678 intx ObjectSynchronizer::complete_exit(Handle obj, TRAPS) {
 679   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 680   if (UseBiasedLocking) {
 681     BiasedLocking::revoke(obj, THREAD);
 682     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 683   }
 684 
 685   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 686   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 687   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 688   intptr_t ret_code = monitor-&gt;complete_exit(THREAD);
 689   return ret_code;
 690 }
 691 
 692 // NOTE: must use heavy weight monitor to handle complete_exit/reenter()
 693 void ObjectSynchronizer::reenter(Handle obj, intx recursions, TRAPS) {
 694   assert(!EnableValhalla || !obj-&gt;klass()-&gt;is_inline_klass(), &quot;monitor op on inline type&quot;);
 695   if (UseBiasedLocking) {
 696     BiasedLocking::revoke(obj, THREAD);
 697     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 698   }
 699 
 700   // An async deflation can race after the inflate() call and before
 701   // reenter() -&gt; enter() can make the ObjectMonitor busy. reenter() -&gt;
 702   // enter() returns false if we have lost the race to async deflation
 703   // and we simply try again.
 704   while (true) {
 705     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_vm_internal);
 706     if (monitor-&gt;reenter(recursions, THREAD)) {
 707       return;
 708     }
 709   }
 710 }
 711 
 712 // -----------------------------------------------------------------------------
 713 // JNI locks on java objects
 714 // NOTE: must use heavy weight monitor to handle jni monitor enter
 715 void ObjectSynchronizer::jni_enter(Handle obj, TRAPS) {
 716   // the current locking is from JNI instead of Java code
 717   CHECK_THROW_NOSYNC_IMSE(obj);
 718   if (UseBiasedLocking) {
 719     BiasedLocking::revoke(obj, THREAD);
 720     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 721   }
 722   THREAD-&gt;set_current_pending_monitor_is_from_java(false);
 723   // An async deflation can race after the inflate() call and before
 724   // enter() can make the ObjectMonitor busy. enter() returns false if
 725   // we have lost the race to async deflation and we simply try again.
 726   while (true) {
 727     ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_jni_enter);
 728     if (monitor-&gt;enter(THREAD)) {
 729       break;
 730     }
 731   }
 732   THREAD-&gt;set_current_pending_monitor_is_from_java(true);
 733 }
 734 
 735 // NOTE: must use heavy weight monitor to handle jni monitor exit
 736 void ObjectSynchronizer::jni_exit(oop obj, Thread* THREAD) {
 737   CHECK_THROW_NOSYNC_IMSE(obj);
 738   if (UseBiasedLocking) {
 739     Handle h_obj(THREAD, obj);
 740     BiasedLocking::revoke(h_obj, THREAD);
 741     obj = h_obj();
 742   }
 743   assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 744 
 745   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 746   // dropped inside exit() and the ObjectMonitor* must be !is_busy().
 747   ObjectMonitor* monitor = inflate(THREAD, obj, inflate_cause_jni_exit);
 748   // If this thread has locked the object, exit the monitor. We
 749   // intentionally do not use CHECK here because we must exit the
 750   // monitor even if an exception is pending.
 751   if (monitor-&gt;check_owner(THREAD)) {
 752     monitor-&gt;exit(true, THREAD);
 753   }
 754 }
 755 
 756 // -----------------------------------------------------------------------------
 757 // Internal VM locks on java objects
 758 // standard constructor, allows locking failures
 759 ObjectLocker::ObjectLocker(Handle obj, Thread* thread, bool do_lock) {
 760   _dolock = do_lock;
 761   _thread = thread;
 762   _thread-&gt;check_for_valid_safepoint_state();
 763   _obj = obj;
 764 
 765   if (_dolock) {
 766     ObjectSynchronizer::enter(_obj, &amp;_lock, _thread);
 767   }
 768 }
 769 
 770 ObjectLocker::~ObjectLocker() {
 771   if (_dolock) {
 772     ObjectSynchronizer::exit(_obj(), &amp;_lock, _thread);
 773   }
 774 }
 775 
 776 
 777 // -----------------------------------------------------------------------------
 778 //  Wait/Notify/NotifyAll
 779 // NOTE: must use heavy weight monitor to handle wait()
 780 int ObjectSynchronizer::wait(Handle obj, jlong millis, TRAPS) {
 781   CHECK_THROW_NOSYNC_IMSE_0(obj);
 782   if (UseBiasedLocking) {
 783     BiasedLocking::revoke(obj, THREAD);
 784     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 785   }
 786   if (millis &lt; 0) {
 787     THROW_MSG_0(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 788   }
 789   // The ObjectMonitor* can&#39;t be async deflated because the _waiters
 790   // field is incremented before ownership is dropped and decremented
 791   // after ownership is regained.
 792   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 793 
 794   DTRACE_MONITOR_WAIT_PROBE(monitor, obj(), THREAD, millis);
 795   monitor-&gt;wait(millis, true, THREAD);
 796 
 797   // This dummy call is in place to get around dtrace bug 6254741.  Once
 798   // that&#39;s fixed we can uncomment the following line, remove the call
 799   // and change this function back into a &quot;void&quot; func.
 800   // DTRACE_MONITOR_PROBE(waited, monitor, obj(), THREAD);
 801   int ret_code = dtrace_waited_probe(monitor, obj, THREAD);
 802   return ret_code;
 803 }
 804 
 805 void ObjectSynchronizer::wait_uninterruptibly(Handle obj, jlong millis, TRAPS) {
 806   CHECK_THROW_NOSYNC_IMSE(obj);
 807   if (UseBiasedLocking) {
 808     BiasedLocking::revoke(obj, THREAD);
 809     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 810   }
 811   if (millis &lt; 0) {
 812     THROW_MSG(vmSymbols::java_lang_IllegalArgumentException(), &quot;timeout value is negative&quot;);
 813   }
 814   // The ObjectMonitor* can&#39;t be async deflated because the _waiters
 815   // field is incremented before ownership is dropped and decremented
 816   // after ownership is regained.
 817   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_wait);
 818   monitor-&gt;wait(millis, false, THREAD);
 819 }
 820 
 821 void ObjectSynchronizer::notify(Handle obj, TRAPS) {
 822   CHECK_THROW_NOSYNC_IMSE(obj);
 823   if (UseBiasedLocking) {
 824     BiasedLocking::revoke(obj, THREAD);
 825     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 826   }
 827 
 828   markWord mark = obj-&gt;mark();
 829   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 830     return;
 831   }
 832   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 833   // dropped by the calling thread.
 834   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_notify);
 835   monitor-&gt;notify(THREAD);
 836 }
 837 
 838 // NOTE: see comment of notify()
 839 void ObjectSynchronizer::notifyall(Handle obj, TRAPS) {
 840   CHECK_THROW_NOSYNC_IMSE(obj);
 841   if (UseBiasedLocking) {
 842     BiasedLocking::revoke(obj, THREAD);
 843     assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
 844   }
 845 
 846   markWord mark = obj-&gt;mark();
 847   if (mark.has_locker() &amp;&amp; THREAD-&gt;is_lock_owned((address)mark.locker())) {
 848     return;
 849   }
 850   // The ObjectMonitor* can&#39;t be async deflated until ownership is
 851   // dropped by the calling thread.
 852   ObjectMonitor* monitor = inflate(THREAD, obj(), inflate_cause_notify);
 853   monitor-&gt;notifyAll(THREAD);
 854 }
 855 
 856 // -----------------------------------------------------------------------------
 857 // Hash Code handling
 858 //
 859 // Performance concern:
 860 // OrderAccess::storestore() calls release() which at one time stored 0
 861 // into the global volatile OrderAccess::dummy variable. This store was
 862 // unnecessary for correctness. Many threads storing into a common location
 863 // causes considerable cache migration or &quot;sloshing&quot; on large SMP systems.
 864 // As such, I avoided using OrderAccess::storestore(). In some cases
 865 // OrderAccess::fence() -- which incurs local latency on the executing
 866 // processor -- is a better choice as it scales on SMP systems.
 867 //
 868 // See http://blogs.oracle.com/dave/entry/biased_locking_in_hotspot for
 869 // a discussion of coherency costs. Note that all our current reference
 870 // platforms provide strong ST-ST order, so the issue is moot on IA32,
 871 // x64, and SPARC.
 872 //
 873 // As a general policy we use &quot;volatile&quot; to control compiler-based reordering
 874 // and explicit fences (barriers) to control for architectural reordering
 875 // performed by the CPU(s) or platform.
 876 
 877 struct SharedGlobals {
 878   char         _pad_prefix[OM_CACHE_LINE_SIZE];
 879   // These are highly shared mostly-read variables.
 880   // To avoid false-sharing they need to be the sole occupants of a cache line.
 881   volatile int stw_random;
 882   volatile int stw_cycle;
 883   DEFINE_PAD_MINUS_SIZE(1, OM_CACHE_LINE_SIZE, sizeof(volatile int) * 2);
 884   // Hot RW variable -- Sequester to avoid false-sharing
 885   volatile int hc_sequence;
 886   DEFINE_PAD_MINUS_SIZE(2, OM_CACHE_LINE_SIZE, sizeof(volatile int));
 887 };
 888 
 889 static SharedGlobals GVars;
 890 
 891 static markWord read_stable_mark(oop obj) {
 892   markWord mark = obj-&gt;mark();
 893   if (!mark.is_being_inflated()) {
 894     return mark;       // normal fast-path return
 895   }
 896 
 897   int its = 0;
 898   for (;;) {
 899     markWord mark = obj-&gt;mark();
 900     if (!mark.is_being_inflated()) {
 901       return mark;    // normal fast-path return
 902     }
 903 
 904     // The object is being inflated by some other thread.
 905     // The caller of read_stable_mark() must wait for inflation to complete.
 906     // Avoid live-lock
 907     // TODO: consider calling SafepointSynchronize::do_call_back() while
 908     // spinning to see if there&#39;s a safepoint pending.  If so, immediately
 909     // yielding or blocking would be appropriate.  Avoid spinning while
 910     // there is a safepoint pending.
 911     // TODO: add inflation contention performance counters.
 912     // TODO: restrict the aggregate number of spinners.
 913 
 914     ++its;
 915     if (its &gt; 10000 || !os::is_MP()) {
 916       if (its &amp; 1) {
 917         os::naked_yield();
 918       } else {
 919         // Note that the following code attenuates the livelock problem but is not
 920         // a complete remedy.  A more complete solution would require that the inflating
 921         // thread hold the associated inflation lock.  The following code simply restricts
 922         // the number of spinners to at most one.  We&#39;ll have N-2 threads blocked
 923         // on the inflationlock, 1 thread holding the inflation lock and using
 924         // a yield/park strategy, and 1 thread in the midst of inflation.
 925         // A more refined approach would be to change the encoding of INFLATING
 926         // to allow encapsulation of a native thread pointer.  Threads waiting for
 927         // inflation to complete would use CAS to push themselves onto a singly linked
 928         // list rooted at the markword.  Once enqueued, they&#39;d loop, checking a per-thread flag
 929         // and calling park().  When inflation was complete the thread that accomplished inflation
 930         // would detach the list and set the markword to inflated with a single CAS and
 931         // then for each thread on the list, set the flag and unpark() the thread.
 932         // This is conceptually similar to muxAcquire-muxRelease, except that muxRelease
 933         // wakes at most one thread whereas we need to wake the entire list.
 934         int ix = (cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 5) &amp; (NINFLATIONLOCKS-1);
 935         int YieldThenBlock = 0;
 936         assert(ix &gt;= 0 &amp;&amp; ix &lt; NINFLATIONLOCKS, &quot;invariant&quot;);
 937         assert((NINFLATIONLOCKS &amp; (NINFLATIONLOCKS-1)) == 0, &quot;invariant&quot;);
 938         Thread::muxAcquire(gInflationLocks + ix, &quot;gInflationLock&quot;);
 939         while (obj-&gt;mark() == markWord::INFLATING()) {
 940           // Beware: NakedYield() is advisory and has almost no effect on some platforms
 941           // so we periodically call self-&gt;_ParkEvent-&gt;park(1).
 942           // We use a mixed spin/yield/block mechanism.
 943           if ((YieldThenBlock++) &gt;= 16) {
 944             Thread::current()-&gt;_ParkEvent-&gt;park(1);
 945           } else {
 946             os::naked_yield();
 947           }
 948         }
 949         Thread::muxRelease(gInflationLocks + ix);
 950       }
 951     } else {
 952       SpinPause();       // SMP-polite spinning
 953     }
 954   }
 955 }
 956 
 957 // hashCode() generation :
 958 //
 959 // Possibilities:
 960 // * MD5Digest of {obj,stw_random}
 961 // * CRC32 of {obj,stw_random} or any linear-feedback shift register function.
 962 // * A DES- or AES-style SBox[] mechanism
 963 // * One of the Phi-based schemes, such as:
 964 //   2654435761 = 2^32 * Phi (golden ratio)
 965 //   HashCodeValue = ((uintptr_t(obj) &gt;&gt; 3) * 2654435761) ^ GVars.stw_random ;
 966 // * A variation of Marsaglia&#39;s shift-xor RNG scheme.
 967 // * (obj ^ stw_random) is appealing, but can result
 968 //   in undesirable regularity in the hashCode values of adjacent objects
 969 //   (objects allocated back-to-back, in particular).  This could potentially
 970 //   result in hashtable collisions and reduced hashtable efficiency.
 971 //   There are simple ways to &quot;diffuse&quot; the middle address bits over the
 972 //   generated hashCode values:
 973 
 974 static inline intptr_t get_next_hash(Thread* self, oop obj) {
 975   intptr_t value = 0;
 976   if (hashCode == 0) {
 977     // This form uses global Park-Miller RNG.
 978     // On MP system we&#39;ll have lots of RW access to a global, so the
 979     // mechanism induces lots of coherency traffic.
 980     value = os::random();
 981   } else if (hashCode == 1) {
 982     // This variation has the property of being stable (idempotent)
 983     // between STW operations.  This can be useful in some of the 1-0
 984     // synchronization schemes.
 985     intptr_t addr_bits = cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 3;
 986     value = addr_bits ^ (addr_bits &gt;&gt; 5) ^ GVars.stw_random;
 987   } else if (hashCode == 2) {
 988     value = 1;            // for sensitivity testing
 989   } else if (hashCode == 3) {
 990     value = ++GVars.hc_sequence;
 991   } else if (hashCode == 4) {
 992     value = cast_from_oop&lt;intptr_t&gt;(obj);
 993   } else {
 994     // Marsaglia&#39;s xor-shift scheme with thread-specific state
 995     // This is probably the best overall implementation -- we&#39;ll
 996     // likely make this the default in future releases.
 997     unsigned t = self-&gt;_hashStateX;
 998     t ^= (t &lt;&lt; 11);
 999     self-&gt;_hashStateX = self-&gt;_hashStateY;
1000     self-&gt;_hashStateY = self-&gt;_hashStateZ;
1001     self-&gt;_hashStateZ = self-&gt;_hashStateW;
1002     unsigned v = self-&gt;_hashStateW;
1003     v = (v ^ (v &gt;&gt; 19)) ^ (t ^ (t &gt;&gt; 8));
1004     self-&gt;_hashStateW = v;
1005     value = v;
1006   }
1007 
1008   value &amp;= markWord::hash_mask;
1009   if (value == 0) value = 0xBAD;
1010   assert(value != markWord::no_hash, &quot;invariant&quot;);
1011   return value;
1012 }
1013 
1014 intptr_t ObjectSynchronizer::FastHashCode(Thread* self, oop obj) {
1015   if (EnableValhalla &amp;&amp; obj-&gt;klass()-&gt;is_inline_klass()) {
1016     // VM should be calling bootstrap method
1017     ShouldNotReachHere();
1018   }
1019   if (UseBiasedLocking) {
1020     // NOTE: many places throughout the JVM do not expect a safepoint
1021     // to be taken here, in particular most operations on perm gen
1022     // objects. However, we only ever bias Java instances and all of
1023     // the call sites of identity_hash that might revoke biases have
1024     // been checked to make sure they can handle a safepoint. The
1025     // added check of the bias pattern is to avoid useless calls to
1026     // thread-local storage.
1027     if (obj-&gt;mark().has_bias_pattern()) {
1028       // Handle for oop obj in case of STW safepoint
1029       Handle hobj(self, obj);
1030       // Relaxing assertion for bug 6320749.
1031       assert(Universe::verify_in_progress() ||
1032              !SafepointSynchronize::is_at_safepoint(),
1033              &quot;biases should not be seen by VM thread here&quot;);
1034       BiasedLocking::revoke(hobj, JavaThread::current());
1035       obj = hobj();
1036       assert(!obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1037     }
1038   }
1039 
1040   // hashCode() is a heap mutator ...
1041   // Relaxing assertion for bug 6320749.
1042   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1043          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1044   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1045          self-&gt;is_Java_thread() , &quot;invariant&quot;);
1046   assert(Universe::verify_in_progress() || DumpSharedSpaces ||
1047          ((JavaThread *)self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1048 
1049   while (true) {
1050     ObjectMonitor* monitor = NULL;
1051     markWord temp, test;
1052     intptr_t hash;
1053     markWord mark = read_stable_mark(obj);
1054 
1055     // object should remain ineligible for biased locking
1056     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1057 
1058     if (mark.is_neutral()) {            // if this is a normal header
1059       hash = mark.hash();
1060       if (hash != 0) {                  // if it has a hash, just return it
1061         return hash;
1062       }
1063       hash = get_next_hash(self, obj);  // get a new hash
1064       temp = mark.copy_set_hash(hash);  // merge the hash into header
1065                                         // try to install the hash
1066       test = obj-&gt;cas_set_mark(temp, mark);
1067       if (test == mark) {               // if the hash was installed, return it
1068         return hash;
1069       }
1070       // Failed to install the hash. It could be that another thread
1071       // installed the hash just before our attempt or inflation has
1072       // occurred or... so we fall thru to inflate the monitor for
1073       // stability and then install the hash.
1074     } else if (mark.has_monitor()) {
1075       monitor = mark.monitor();
1076       temp = monitor-&gt;header();
1077       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1078       hash = temp.hash();
1079       if (hash != 0) {
1080         // It has a hash.
1081 
1082         // Separate load of dmw/header above from the loads in
1083         // is_being_async_deflated().
1084         if (support_IRIW_for_not_multiple_copy_atomic_cpu) {
1085           // A non-multiple copy atomic (nMCA) machine needs a bigger
1086           // hammer to separate the load above and the loads below.
1087           OrderAccess::fence();
1088         } else {
1089           OrderAccess::loadload();
1090         }
1091         if (monitor-&gt;is_being_async_deflated()) {
1092           // But we can&#39;t safely use the hash if we detect that async
1093           // deflation has occurred. So we attempt to restore the
1094           // header/dmw to the object&#39;s header so that we only retry
1095           // once if the deflater thread happens to be slow.
1096           monitor-&gt;install_displaced_markword_in_object(obj);
1097           continue;
1098         }
1099         return hash;
1100       }
1101       // Fall thru so we only have one place that installs the hash in
1102       // the ObjectMonitor.
1103     } else if (self-&gt;is_lock_owned((address)mark.locker())) {
1104       // This is a stack lock owned by the calling thread so fetch the
1105       // displaced markWord from the BasicLock on the stack.
1106       temp = mark.displaced_mark_helper();
1107       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1108       hash = temp.hash();
1109       if (hash != 0) {                  // if it has a hash, just return it
1110         return hash;
1111       }
1112       // WARNING:
1113       // The displaced header in the BasicLock on a thread&#39;s stack
1114       // is strictly immutable. It CANNOT be changed in ANY cases.
1115       // So we have to inflate the stack lock into an ObjectMonitor
1116       // even if the current thread owns the lock. The BasicLock on
1117       // a thread&#39;s stack can be asynchronously read by other threads
1118       // during an inflate() call so any change to that stack memory
1119       // may not propagate to other threads correctly.
1120     }
1121 
1122     // Inflate the monitor to set the hash.
1123 
1124     // An async deflation can race after the inflate() call and before we
1125     // can update the ObjectMonitor&#39;s header with the hash value below.
1126     monitor = inflate(self, obj, inflate_cause_hash_code);
1127     // Load ObjectMonitor&#39;s header/dmw field and see if it has a hash.
1128     mark = monitor-&gt;header();
1129     assert(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1130     hash = mark.hash();
1131     if (hash == 0) {                    // if it does not have a hash
1132       hash = get_next_hash(self, obj);  // get a new hash
1133       temp = mark.copy_set_hash(hash);  // merge the hash into header
1134       assert(temp.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, temp.value());
1135       uintptr_t v = Atomic::cmpxchg((volatile uintptr_t*)monitor-&gt;header_addr(), mark.value(), temp.value());
1136       test = markWord(v);
1137       if (test != mark) {
1138         // The attempt to update the ObjectMonitor&#39;s header/dmw field
1139         // did not work. This can happen if another thread managed to
1140         // merge in the hash just before our cmpxchg().
1141         // If we add any new usages of the header/dmw field, this code
1142         // will need to be updated.
1143         hash = test.hash();
1144         assert(test.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, test.value());
1145         assert(hash != 0, &quot;should only have lost the race to a thread that set a non-zero hash&quot;);
1146       }
1147       if (monitor-&gt;is_being_async_deflated()) {
1148         // If we detect that async deflation has occurred, then we
1149         // attempt to restore the header/dmw to the object&#39;s header
1150         // so that we only retry once if the deflater thread happens
1151         // to be slow.
1152         monitor-&gt;install_displaced_markword_in_object(obj);
1153         continue;
1154       }
1155     }
1156     // We finally get the hash.
1157     return hash;
1158   }
1159 }
1160 
1161 
1162 bool ObjectSynchronizer::current_thread_holds_lock(JavaThread* thread,
1163                                                    Handle h_obj) {
1164   if (EnableValhalla &amp;&amp; h_obj-&gt;mark().is_always_locked()) {
1165     return false;
1166   }
1167   if (UseBiasedLocking) {
1168     BiasedLocking::revoke(h_obj, thread);
1169     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1170   }
1171 
1172   assert(thread == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1173   oop obj = h_obj();
1174 
1175   markWord mark = read_stable_mark(obj);
1176 
1177   // Uncontended case, header points to stack
1178   if (mark.has_locker()) {
1179     return thread-&gt;is_lock_owned((address)mark.locker());
1180   }
1181   // Contended case, header points to ObjectMonitor (tagged pointer)
1182   if (mark.has_monitor()) {
1183     // The first stage of async deflation does not affect any field
1184     // used by this comparison so the ObjectMonitor* is usable here.
1185     ObjectMonitor* monitor = mark.monitor();
1186     return monitor-&gt;is_entered(thread) != 0;
1187   }
1188   // Unlocked case, header in place
1189   assert(mark.is_neutral(), &quot;sanity check&quot;);
1190   return false;
1191 }
1192 
1193 // Be aware of this method could revoke bias of the lock object.
1194 // This method queries the ownership of the lock handle specified by &#39;h_obj&#39;.
1195 // If the current thread owns the lock, it returns owner_self. If no
1196 // thread owns the lock, it returns owner_none. Otherwise, it will return
1197 // owner_other.
1198 ObjectSynchronizer::LockOwnership ObjectSynchronizer::query_lock_ownership
1199 (JavaThread *self, Handle h_obj) {
1200   // The caller must beware this method can revoke bias, and
1201   // revocation can result in a safepoint.
1202   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1203   assert(self-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
1204 
1205   // Possible mark states: neutral, biased, stack-locked, inflated
1206 
1207   if (UseBiasedLocking &amp;&amp; h_obj()-&gt;mark().has_bias_pattern()) {
1208     // CASE: biased
1209     BiasedLocking::revoke(h_obj, self);
1210     assert(!h_obj-&gt;mark().has_bias_pattern(),
1211            &quot;biases should be revoked by now&quot;);
1212   }
1213 
1214   assert(self == JavaThread::current(), &quot;Can only be called on current thread&quot;);
1215   oop obj = h_obj();
1216   markWord mark = read_stable_mark(obj);
1217 
1218   // CASE: stack-locked.  Mark points to a BasicLock on the owner&#39;s stack.
1219   if (mark.has_locker()) {
1220     return self-&gt;is_lock_owned((address)mark.locker()) ?
1221       owner_self : owner_other;
1222   }
1223 
1224   // CASE: inflated. Mark (tagged pointer) points to an ObjectMonitor.
1225   // The Object:ObjectMonitor relationship is stable as long as we&#39;re
1226   // not at a safepoint and AsyncDeflateIdleMonitors is false.
1227   if (mark.has_monitor()) {
1228     // The first stage of async deflation does not affect any field
1229     // used by this comparison so the ObjectMonitor* is usable here.
1230     ObjectMonitor* monitor = mark.monitor();
1231     void* owner = monitor-&gt;owner();
1232     if (owner == NULL) return owner_none;
1233     return (owner == self ||
1234             self-&gt;is_lock_owned((address)owner)) ? owner_self : owner_other;
1235   }
1236 
1237   // CASE: neutral
1238   assert(mark.is_neutral(), &quot;sanity check&quot;);
1239   return owner_none;           // it&#39;s unlocked
1240 }
1241 
1242 // FIXME: jvmti should call this
1243 JavaThread* ObjectSynchronizer::get_lock_owner(ThreadsList * t_list, Handle h_obj) {
1244   if (UseBiasedLocking) {
1245     if (SafepointSynchronize::is_at_safepoint()) {
1246       BiasedLocking::revoke_at_safepoint(h_obj);
1247     } else {
1248       BiasedLocking::revoke(h_obj, JavaThread::current());
1249     }
1250     assert(!h_obj-&gt;mark().has_bias_pattern(), &quot;biases should be revoked by now&quot;);
1251   }
1252 
1253   oop obj = h_obj();
1254   address owner = NULL;
1255 
1256   markWord mark = read_stable_mark(obj);
1257 
1258   // Uncontended case, header points to stack
1259   if (mark.has_locker()) {
1260     owner = (address) mark.locker();
1261   }
1262 
1263   // Contended case, header points to ObjectMonitor (tagged pointer)
1264   else if (mark.has_monitor()) {
1265     // The first stage of async deflation does not affect any field
1266     // used by this comparison so the ObjectMonitor* is usable here.
1267     ObjectMonitor* monitor = mark.monitor();
1268     assert(monitor != NULL, &quot;monitor should be non-null&quot;);
1269     owner = (address) monitor-&gt;owner();
1270   }
1271 
1272   if (owner != NULL) {
1273     // owning_thread_from_monitor_owner() may also return NULL here
1274     return Threads::owning_thread_from_monitor_owner(t_list, owner);
1275   }
1276 
1277   // Unlocked case, header in place
1278   // Cannot have assertion since this object may have been
1279   // locked by another thread when reaching here.
1280   // assert(mark.is_neutral(), &quot;sanity check&quot;);
1281 
1282   return NULL;
1283 }
1284 
1285 // Visitors ...
1286 
1287 void ObjectSynchronizer::monitors_iterate(MonitorClosure* closure) {
1288   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
1289   while (block != NULL) {
1290     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
1291     for (int i = _BLOCKSIZE - 1; i &gt; 0; i--) {
1292       ObjectMonitor* mid = (ObjectMonitor *)(block + i);
1293       if (mid-&gt;object() != NULL) {
1294         // Only process with closure if the object is set.
1295 
1296         // monitors_iterate() is only called at a safepoint or when the
1297         // target thread is suspended or when the target thread is
1298         // operating on itself. The current closures in use today are
1299         // only interested in an owned ObjectMonitor and ownership
1300         // cannot be dropped under the calling contexts so the
1301         // ObjectMonitor cannot be async deflated.
1302         closure-&gt;do_monitor(mid);
1303       }
1304     }
1305     // unmarked_next() is not needed with g_block_list (no locking
1306     // used with block linkage _next_om fields).
1307     block = (PaddedObjectMonitor*)block-&gt;next_om();
1308   }
1309 }
1310 
1311 static bool monitors_used_above_threshold() {
1312   int population = Atomic::load(&amp;om_list_globals._population);
1313   if (population == 0) {
1314     return false;
1315   }
1316   if (MonitorUsedDeflationThreshold &gt; 0) {
1317     int monitors_used = population - Atomic::load(&amp;om_list_globals._free_count) -
1318                         Atomic::load(&amp;om_list_globals._wait_count);
1319     int monitor_usage = (monitors_used * 100LL) / population;
1320     return monitor_usage &gt; MonitorUsedDeflationThreshold;
1321   }
1322   return false;
1323 }
1324 
1325 bool ObjectSynchronizer::is_async_deflation_needed() {
1326   if (!AsyncDeflateIdleMonitors) {
1327     return false;
1328   }
1329   if (is_async_deflation_requested()) {
1330     // Async deflation request.
1331     return true;
1332   }
1333   if (AsyncDeflationInterval &gt; 0 &amp;&amp;
1334       time_since_last_async_deflation_ms() &gt; AsyncDeflationInterval &amp;&amp;
1335       monitors_used_above_threshold()) {
1336     // It&#39;s been longer than our specified deflate interval and there
1337     // are too many monitors in use. We don&#39;t deflate more frequently
1338     // than AsyncDeflationInterval (unless is_async_deflation_requested)
1339     // in order to not swamp the ServiceThread.
<a name="2" id="anc2"></a><span class="line-removed">1340     _last_async_deflation_time_ns = os::javaTimeNanos();</span>
1341     return true;
1342   }
1343   return false;
1344 }
1345 
1346 bool ObjectSynchronizer::is_safepoint_deflation_needed() {
<a name="3" id="anc3"></a><span class="line-modified">1347   if (!AsyncDeflateIdleMonitors) {</span>
<span class="line-modified">1348     if (monitors_used_above_threshold()) {</span>
<span class="line-modified">1349       // Too many monitors in use.</span>
<span class="line-modified">1350       return true;</span>










1351     }
<a name="4" id="anc4"></a><span class="line-modified">1352     return false;</span>
<span class="line-modified">1353   }</span>
<span class="line-modified">1354   if (is_special_deflation_requested()) {</span>
<span class="line-modified">1355     // For AsyncDeflateIdleMonitors only do a safepoint deflation</span>
<span class="line-modified">1356     // if there is a special deflation request.</span>
<span class="line-modified">1357     return true;</span>




















1358   }
<a name="5" id="anc5"></a><span class="line-modified">1359   return false;</span>

1360 }
1361 
1362 jlong ObjectSynchronizer::time_since_last_async_deflation_ms() {
<a name="6" id="anc6"></a><span class="line-modified">1363   return (os::javaTimeNanos() - _last_async_deflation_time_ns) / (NANOUNITS / MILLIUNITS);</span>
1364 }
1365 
1366 void ObjectSynchronizer::oops_do(OopClosure* f) {
1367   // We only scan the global used list here (for moribund threads), and
1368   // the thread-local monitors in Thread::oops_do().
1369   global_used_oops_do(f);
1370 }
1371 
1372 void ObjectSynchronizer::global_used_oops_do(OopClosure* f) {
1373   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1374   list_oops_do(Atomic::load(&amp;om_list_globals._in_use_list), f);
1375 }
1376 
1377 void ObjectSynchronizer::thread_local_used_oops_do(Thread* thread, OopClosure* f) {
1378   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1379   list_oops_do(thread-&gt;om_in_use_list, f);
1380 }
1381 
1382 void ObjectSynchronizer::list_oops_do(ObjectMonitor* list, OopClosure* f) {
1383   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1384   // The oops_do() phase does not overlap with monitor deflation
1385   // so no need to lock ObjectMonitors for the list traversal.
1386   for (ObjectMonitor* mid = list; mid != NULL; mid = unmarked_next(mid)) {
1387     if (mid-&gt;object() != NULL) {
1388       f-&gt;do_oop((oop*)mid-&gt;object_addr());
1389     }
1390   }
1391 }
1392 
1393 
1394 // -----------------------------------------------------------------------------
1395 // ObjectMonitor Lifecycle
1396 // -----------------------
1397 // Inflation unlinks monitors from om_list_globals._free_list or a per-thread
1398 // free list and associates them with objects. Deflation -- which occurs at
1399 // STW-time or asynchronously -- disassociates idle monitors from objects.
1400 // Such scavenged monitors are returned to the om_list_globals._free_list.
1401 //
1402 // ObjectMonitors reside in type-stable memory (TSM) and are immortal.
1403 //
1404 // Lifecycle:
1405 // --   unassigned and on the om_list_globals._free_list
1406 // --   unassigned and on a per-thread free list
1407 // --   assigned to an object.  The object is inflated and the mark refers
1408 //      to the ObjectMonitor.
1409 
1410 ObjectMonitor* ObjectSynchronizer::om_alloc(Thread* self) {
1411   // A large MAXPRIVATE value reduces both list lock contention
1412   // and list coherency traffic, but also tends to increase the
1413   // number of ObjectMonitors in circulation as well as the STW
1414   // scavenge costs.  As usual, we lean toward time in space-time
1415   // tradeoffs.
1416   const int MAXPRIVATE = 1024;
1417   NoSafepointVerifier nsv;
1418 
1419   for (;;) {
1420     ObjectMonitor* m;
1421 
1422     // 1: try to allocate from the thread&#39;s local om_free_list.
1423     // Threads will attempt to allocate first from their local list, then
1424     // from the global list, and only after those attempts fail will the
1425     // thread attempt to instantiate new monitors. Thread-local free lists
1426     // improve allocation latency, as well as reducing coherency traffic
1427     // on the shared global list.
1428     m = take_from_start_of_om_free_list(self);
1429     if (m != NULL) {
1430       guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1431       m-&gt;set_allocation_state(ObjectMonitor::New);
1432       prepend_to_om_in_use_list(self, m);
1433       return m;
1434     }
1435 
1436     // 2: try to allocate from the global om_list_globals._free_list
1437     // If we&#39;re using thread-local free lists then try
1438     // to reprovision the caller&#39;s free list.
1439     if (Atomic::load(&amp;om_list_globals._free_list) != NULL) {
1440       // Reprovision the thread&#39;s om_free_list.
1441       // Use bulk transfers to reduce the allocation rate and heat
1442       // on various locks.
1443       for (int i = self-&gt;om_free_provision; --i &gt;= 0;) {
1444         ObjectMonitor* take = take_from_start_of_global_free_list();
1445         if (take == NULL) {
1446           break;  // No more are available.
1447         }
1448         guarantee(take-&gt;object() == NULL, &quot;invariant&quot;);
1449         if (AsyncDeflateIdleMonitors) {
1450           // We allowed 3 field values to linger during async deflation.
1451           // Clear or restore them as appropriate.
1452           take-&gt;set_header(markWord::zero());
1453           // DEFLATER_MARKER is the only non-NULL value we should see here.
1454           take-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
1455           if (take-&gt;contentions() &lt; 0) {
1456             // Add back max_jint to restore the contentions field to its
1457             // proper value.
1458             take-&gt;add_to_contentions(max_jint);
1459 
1460 #ifdef ASSERT
1461             jint l_contentions = take-&gt;contentions();
1462 #endif
1463             assert(l_contentions &gt;= 0, &quot;must not be negative: l_contentions=%d, contentions=%d&quot;,
1464                    l_contentions, take-&gt;contentions());
1465           }
1466         }
1467         take-&gt;Recycle();
1468         // Since we&#39;re taking from the global free-list, take must be Free.
1469         // om_release() also sets the allocation state to Free because it
1470         // is called from other code paths.
1471         assert(take-&gt;is_free(), &quot;invariant&quot;);
1472         om_release(self, take, false);
1473       }
1474       self-&gt;om_free_provision += 1 + (self-&gt;om_free_provision / 2);
1475       if (self-&gt;om_free_provision &gt; MAXPRIVATE) self-&gt;om_free_provision = MAXPRIVATE;
1476       continue;
1477     }
1478 
1479     // 3: allocate a block of new ObjectMonitors
1480     // Both the local and global free lists are empty -- resort to malloc().
1481     // In the current implementation ObjectMonitors are TSM - immortal.
1482     // Ideally, we&#39;d write &quot;new ObjectMonitor[_BLOCKSIZE], but we want
1483     // each ObjectMonitor to start at the beginning of a cache line,
1484     // so we use align_up().
1485     // A better solution would be to use C++ placement-new.
1486     // BEWARE: As it stands currently, we don&#39;t run the ctors!
1487     assert(_BLOCKSIZE &gt; 1, &quot;invariant&quot;);
1488     size_t neededsize = sizeof(PaddedObjectMonitor) * _BLOCKSIZE;
1489     PaddedObjectMonitor* temp;
1490     size_t aligned_size = neededsize + (OM_CACHE_LINE_SIZE - 1);
1491     void* real_malloc_addr = NEW_C_HEAP_ARRAY(char, aligned_size, mtInternal);
1492     temp = (PaddedObjectMonitor*)align_up(real_malloc_addr, OM_CACHE_LINE_SIZE);
1493     (void)memset((void *) temp, 0, neededsize);
1494 
1495     // Format the block.
1496     // initialize the linked list, each monitor points to its next
1497     // forming the single linked free list, the very first monitor
1498     // will points to next block, which forms the block list.
1499     // The trick of using the 1st element in the block as g_block_list
1500     // linkage should be reconsidered.  A better implementation would
1501     // look like: class Block { Block * next; int N; ObjectMonitor Body [N] ; }
1502 
1503     for (int i = 1; i &lt; _BLOCKSIZE; i++) {
1504       temp[i].set_next_om((ObjectMonitor*)&amp;temp[i + 1]);
1505       assert(temp[i].is_free(), &quot;invariant&quot;);
1506     }
1507 
1508     // terminate the last monitor as the end of list
1509     temp[_BLOCKSIZE - 1].set_next_om((ObjectMonitor*)NULL);
1510 
1511     // Element [0] is reserved for global list linkage
1512     temp[0].set_object(CHAINMARKER);
1513 
1514     // Consider carving out this thread&#39;s current request from the
1515     // block in hand.  This avoids some lock traffic and redundant
1516     // list activity.
1517 
1518     prepend_block_to_lists(temp);
1519   }
1520 }
1521 
1522 // Place &quot;m&quot; on the caller&#39;s private per-thread om_free_list.
1523 // In practice there&#39;s no need to clamp or limit the number of
1524 // monitors on a thread&#39;s om_free_list as the only non-allocation time
1525 // we&#39;ll call om_release() is to return a monitor to the free list after
1526 // a CAS attempt failed. This doesn&#39;t allow unbounded #s of monitors to
1527 // accumulate on a thread&#39;s free list.
1528 //
1529 // Key constraint: all ObjectMonitors on a thread&#39;s free list and the global
1530 // free list must have their object field set to null. This prevents the
1531 // scavenger -- deflate_monitor_list() or deflate_monitor_list_using_JT()
1532 // -- from reclaiming them while we are trying to release them.
1533 
1534 void ObjectSynchronizer::om_release(Thread* self, ObjectMonitor* m,
1535                                     bool from_per_thread_alloc) {
1536   guarantee(m-&gt;header().value() == 0, &quot;invariant&quot;);
1537   guarantee(m-&gt;object() == NULL, &quot;invariant&quot;);
1538   NoSafepointVerifier nsv;
1539 
1540   if ((m-&gt;is_busy() | m-&gt;_recursions) != 0) {
1541     stringStream ss;
1542     fatal(&quot;freeing in-use monitor: %s, recursions=&quot; INTX_FORMAT,
1543           m-&gt;is_busy_to_string(&amp;ss), m-&gt;_recursions);
1544   }
1545   m-&gt;set_allocation_state(ObjectMonitor::Free);
1546   // _next_om is used for both per-thread in-use and free lists so
1547   // we have to remove &#39;m&#39; from the in-use list first (as needed).
1548   if (from_per_thread_alloc) {
1549     // Need to remove &#39;m&#39; from om_in_use_list.
1550     ObjectMonitor* mid = NULL;
1551     ObjectMonitor* next = NULL;
1552 
1553     // This list walk can race with another list walker or with async
1554     // deflation so we have to worry about an ObjectMonitor being
1555     // removed from this list while we are walking it.
1556 
1557     // Lock the list head to avoid racing with another list walker
1558     // or with async deflation.
1559     if ((mid = get_list_head_locked(&amp;self-&gt;om_in_use_list)) == NULL) {
1560       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; in-use list must not be empty.&quot;, p2i(self));
1561     }
1562     next = unmarked_next(mid);
1563     if (m == mid) {
1564       // First special case:
1565       // &#39;m&#39; matches mid, is the list head and is locked. Switch the list
1566       // head to next which unlocks the list head, but leaves the extracted
1567       // mid locked:
1568       Atomic::store(&amp;self-&gt;om_in_use_list, next);
1569     } else if (m == next) {
1570       // Second special case:
1571       // &#39;m&#39; matches next after the list head and we already have the list
1572       // head locked so set mid to what we are extracting:
1573       mid = next;
1574       // Lock mid to prevent races with a list walker or an async
1575       // deflater thread that&#39;s ahead of us. The locked list head
1576       // prevents races from behind us.
1577       om_lock(mid);
1578       // Update next to what follows mid (if anything):
1579       next = unmarked_next(mid);
1580       // Switch next after the list head to new next which unlocks the
1581       // list head, but leaves the extracted mid locked:
1582       self-&gt;om_in_use_list-&gt;set_next_om(next);
1583     } else {
1584       // We have to search the list to find &#39;m&#39;.
1585       guarantee(next != NULL, &quot;thread=&quot; INTPTR_FORMAT &quot;: om_in_use_list=&quot; INTPTR_FORMAT
1586                 &quot; is too short.&quot;, p2i(self), p2i(self-&gt;om_in_use_list));
1587       // Our starting anchor is next after the list head which is the
1588       // last ObjectMonitor we checked:
1589       ObjectMonitor* anchor = next;
1590       // Lock anchor to prevent races with a list walker or an async
1591       // deflater thread that&#39;s ahead of us. The locked list head
1592       // prevents races from behind us.
1593       om_lock(anchor);
1594       om_unlock(mid);  // Unlock the list head now that anchor is locked.
1595       while ((mid = unmarked_next(anchor)) != NULL) {
1596         if (m == mid) {
1597           // We found &#39;m&#39; on the per-thread in-use list so extract it.
1598           // Update next to what follows mid (if anything):
1599           next = unmarked_next(mid);
1600           // Switch next after the anchor to new next which unlocks the
1601           // anchor, but leaves the extracted mid locked:
1602           anchor-&gt;set_next_om(next);
1603           break;
1604         } else {
1605           // Lock the next anchor to prevent races with a list walker
1606           // or an async deflater thread that&#39;s ahead of us. The locked
1607           // current anchor prevents races from behind us.
1608           om_lock(mid);
1609           // Unlock current anchor now that next anchor is locked:
1610           om_unlock(anchor);
1611           anchor = mid;  // Advance to new anchor and try again.
1612         }
1613       }
1614     }
1615 
1616     if (mid == NULL) {
1617       // Reached end of the list and didn&#39;t find &#39;m&#39; so:
1618       fatal(&quot;thread=&quot; INTPTR_FORMAT &quot; must find m=&quot; INTPTR_FORMAT &quot;on om_in_use_list=&quot;
1619             INTPTR_FORMAT, p2i(self), p2i(m), p2i(self-&gt;om_in_use_list));
1620     }
1621 
1622     // At this point mid is disconnected from the in-use list so
1623     // its lock no longer has any effects on the in-use list.
1624     Atomic::dec(&amp;self-&gt;om_in_use_count);
1625     // Unlock mid, but leave the next value for any lagging list
1626     // walkers. It will get cleaned up when mid is prepended to
1627     // the thread&#39;s free list:
1628     om_unlock(mid);
1629   }
1630 
1631   prepend_to_om_free_list(self, m);
1632   guarantee(m-&gt;is_free(), &quot;invariant&quot;);
1633 }
1634 
1635 // Return ObjectMonitors on a moribund thread&#39;s free and in-use
1636 // lists to the appropriate global lists. The ObjectMonitors on the
1637 // per-thread in-use list may still be in use by other threads.
1638 //
1639 // We currently call om_flush() from Threads::remove() before the
1640 // thread has been excised from the thread list and is no longer a
1641 // mutator. This means that om_flush() cannot run concurrently with
1642 // a safepoint and interleave with deflate_idle_monitors(). In
1643 // particular, this ensures that the thread&#39;s in-use monitors are
1644 // scanned by a GC safepoint, either via Thread::oops_do() (before
1645 // om_flush() is called) or via ObjectSynchronizer::oops_do() (after
1646 // om_flush() is called).
1647 //
1648 // With AsyncDeflateIdleMonitors, deflate_global_idle_monitors_using_JT()
1649 // and deflate_per_thread_idle_monitors_using_JT() (in another thread) can
1650 // run at the same time as om_flush() so we have to follow a careful
1651 // protocol to prevent list corruption.
1652 
1653 void ObjectSynchronizer::om_flush(Thread* self) {
1654   // Process the per-thread in-use list first to be consistent.
1655   int in_use_count = 0;
1656   ObjectMonitor* in_use_list = NULL;
1657   ObjectMonitor* in_use_tail = NULL;
1658   NoSafepointVerifier nsv;
1659 
1660   // This function can race with a list walker or with an async
1661   // deflater thread so we lock the list head to prevent confusion.
1662   // An async deflater thread checks to see if the target thread
1663   // is exiting, but if it has made it past that check before we
1664   // started exiting, then it is racing to get to the in-use list.
1665   if ((in_use_list = get_list_head_locked(&amp;self-&gt;om_in_use_list)) != NULL) {
1666     // At this point, we have locked the in-use list head so a racing
1667     // thread cannot come in after us. However, a racing thread could
1668     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1669     //
1670     // The thread is going away, however the ObjectMonitors on the
1671     // om_in_use_list may still be in-use by other threads. Link
1672     // them to in_use_tail, which will be linked into the global
1673     // in-use list (om_list_globals._in_use_list) below.
1674     //
1675     // Account for the in-use list head before the loop since it is
1676     // already locked (by this thread):
1677     in_use_tail = in_use_list;
1678     in_use_count++;
1679     for (ObjectMonitor* cur_om = unmarked_next(in_use_list); cur_om != NULL;) {
1680       if (is_locked(cur_om)) {
1681         // cur_om is locked so there must be a racing walker or async
1682         // deflater thread ahead of us so we&#39;ll give it a chance to finish.
1683         while (is_locked(cur_om)) {
1684           os::naked_short_sleep(1);
1685         }
1686         // Refetch the possibly changed next field and try again.
1687         cur_om = unmarked_next(in_use_tail);
1688         continue;
1689       }
1690       if (cur_om-&gt;object() == NULL) {
1691         // cur_om was deflated and the object ref was cleared while it
1692         // was locked. We happened to see it just after it was unlocked
1693         // (and added to the free list). Refetch the possibly changed
1694         // next field and try again.
1695         cur_om = unmarked_next(in_use_tail);
1696         continue;
1697       }
1698       in_use_tail = cur_om;
1699       in_use_count++;
1700       cur_om = unmarked_next(cur_om);
1701     }
1702     guarantee(in_use_tail != NULL, &quot;invariant&quot;);
1703     int l_om_in_use_count = Atomic::load(&amp;self-&gt;om_in_use_count);
1704     ADIM_guarantee(l_om_in_use_count == in_use_count, &quot;in-use counts don&#39;t match: &quot;
1705                    &quot;l_om_in_use_count=%d, in_use_count=%d&quot;, l_om_in_use_count, in_use_count);
1706     Atomic::store(&amp;self-&gt;om_in_use_count, 0);
1707     // Clear the in-use list head (which also unlocks it):
1708     Atomic::store(&amp;self-&gt;om_in_use_list, (ObjectMonitor*)NULL);
1709     om_unlock(in_use_list);
1710   }
1711 
1712   int free_count = 0;
1713   ObjectMonitor* free_list = NULL;
1714   ObjectMonitor* free_tail = NULL;
1715   // This function can race with a list walker thread so we lock the
1716   // list head to prevent confusion.
1717   if ((free_list = get_list_head_locked(&amp;self-&gt;om_free_list)) != NULL) {
1718     // At this point, we have locked the free list head so a racing
1719     // thread cannot come in after us. However, a racing thread could
1720     // be ahead of us; we&#39;ll detect that and delay to let it finish.
1721     //
1722     // The thread is going away. Set &#39;free_tail&#39; to the last per-thread free
1723     // monitor which will be linked to om_list_globals._free_list below.
1724     //
1725     // Account for the free list head before the loop since it is
1726     // already locked (by this thread):
1727     free_tail = free_list;
1728     free_count++;
1729     for (ObjectMonitor* s = unmarked_next(free_list); s != NULL; s = unmarked_next(s)) {
1730       if (is_locked(s)) {
1731         // s is locked so there must be a racing walker thread ahead
1732         // of us so we&#39;ll give it a chance to finish.
1733         while (is_locked(s)) {
1734           os::naked_short_sleep(1);
1735         }
1736       }
1737       free_tail = s;
1738       free_count++;
1739       guarantee(s-&gt;object() == NULL, &quot;invariant&quot;);
1740       if (s-&gt;is_busy()) {
1741         stringStream ss;
1742         fatal(&quot;must be !is_busy: %s&quot;, s-&gt;is_busy_to_string(&amp;ss));
1743       }
1744     }
1745     guarantee(free_tail != NULL, &quot;invariant&quot;);
1746     int l_om_free_count = Atomic::load(&amp;self-&gt;om_free_count);
1747     ADIM_guarantee(l_om_free_count == free_count, &quot;free counts don&#39;t match: &quot;
1748                    &quot;l_om_free_count=%d, free_count=%d&quot;, l_om_free_count, free_count);
1749     Atomic::store(&amp;self-&gt;om_free_count, 0);
1750     Atomic::store(&amp;self-&gt;om_free_list, (ObjectMonitor*)NULL);
1751     om_unlock(free_list);
1752   }
1753 
1754   if (free_tail != NULL) {
1755     prepend_list_to_global_free_list(free_list, free_tail, free_count);
1756   }
1757 
1758   if (in_use_tail != NULL) {
1759     prepend_list_to_global_in_use_list(in_use_list, in_use_tail, in_use_count);
1760   }
1761 
1762   LogStreamHandle(Debug, monitorinflation) lsh_debug;
1763   LogStreamHandle(Info, monitorinflation) lsh_info;
1764   LogStream* ls = NULL;
1765   if (log_is_enabled(Debug, monitorinflation)) {
1766     ls = &amp;lsh_debug;
1767   } else if ((free_count != 0 || in_use_count != 0) &amp;&amp;
1768              log_is_enabled(Info, monitorinflation)) {
1769     ls = &amp;lsh_info;
1770   }
1771   if (ls != NULL) {
1772     ls-&gt;print_cr(&quot;om_flush: jt=&quot; INTPTR_FORMAT &quot;, free_count=%d&quot;
1773                  &quot;, in_use_count=%d&quot; &quot;, om_free_provision=%d&quot;,
1774                  p2i(self), free_count, in_use_count, self-&gt;om_free_provision);
1775   }
1776 }
1777 
1778 static void post_monitor_inflate_event(EventJavaMonitorInflate* event,
1779                                        const oop obj,
1780                                        ObjectSynchronizer::InflateCause cause) {
1781   assert(event != NULL, &quot;invariant&quot;);
1782   assert(event-&gt;should_commit(), &quot;invariant&quot;);
1783   event-&gt;set_monitorClass(obj-&gt;klass());
1784   event-&gt;set_address((uintptr_t)(void*)obj);
1785   event-&gt;set_cause((u1)cause);
1786   event-&gt;commit();
1787 }
1788 
1789 // Fast path code shared by multiple functions
1790 void ObjectSynchronizer::inflate_helper(oop obj) {
1791   markWord mark = obj-&gt;mark();
1792   if (mark.has_monitor()) {
1793     ObjectMonitor* monitor = mark.monitor();
1794     assert(ObjectSynchronizer::verify_objmon_isinpool(monitor), &quot;monitor=&quot; INTPTR_FORMAT &quot; is invalid&quot;, p2i(monitor));
1795     markWord dmw = monitor-&gt;header();
1796     assert(dmw.is_neutral(), &quot;sanity check: header=&quot; INTPTR_FORMAT, dmw.value());
1797     return;
1798   }
1799   (void)inflate(Thread::current(), obj, inflate_cause_vm_internal);
1800 }
1801 
1802 ObjectMonitor* ObjectSynchronizer::inflate(Thread* self, oop object,
1803                                            const InflateCause cause) {
1804   // Inflate mutates the heap ...
1805   // Relaxing assertion for bug 6320749.
1806   assert(Universe::verify_in_progress() ||
1807          !SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
1808 
1809   if (EnableValhalla) {
1810     guarantee(!object-&gt;klass()-&gt;is_inline_klass(), &quot;Attempt to inflate inline type&quot;);
1811   }
1812 
1813   EventJavaMonitorInflate event;
1814 
1815   for (;;) {
1816     const markWord mark = object-&gt;mark();
1817     assert(!mark.has_bias_pattern(), &quot;invariant&quot;);
1818 
1819     // The mark can be in one of the following states:
1820     // *  Inflated     - just return
1821     // *  Stack-locked - coerce it to inflated
1822     // *  INFLATING    - busy wait for conversion to complete
1823     // *  Neutral      - aggressively inflate the object.
1824     // *  BIASED       - Illegal.  We should never see this
1825 
1826     // CASE: inflated
1827     if (mark.has_monitor()) {
1828       ObjectMonitor* inf = mark.monitor();
1829       markWord dmw = inf-&gt;header();
1830       assert(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1831       assert(AsyncDeflateIdleMonitors || inf-&gt;object() == object, &quot;invariant&quot;);
1832       assert(ObjectSynchronizer::verify_objmon_isinpool(inf), &quot;monitor is invalid&quot;);
1833       return inf;
1834     }
1835 
1836     // CASE: inflation in progress - inflating over a stack-lock.
1837     // Some other thread is converting from stack-locked to inflated.
1838     // Only that thread can complete inflation -- other threads must wait.
1839     // The INFLATING value is transient.
1840     // Currently, we spin/yield/park and poll the markword, waiting for inflation to finish.
1841     // We could always eliminate polling by parking the thread on some auxiliary list.
1842     if (mark == markWord::INFLATING()) {
1843       read_stable_mark(object);
1844       continue;
1845     }
1846 
1847     // CASE: stack-locked
1848     // Could be stack-locked either by this thread or by some other thread.
1849     //
1850     // Note that we allocate the objectmonitor speculatively, _before_ attempting
1851     // to install INFLATING into the mark word.  We originally installed INFLATING,
1852     // allocated the objectmonitor, and then finally STed the address of the
1853     // objectmonitor into the mark.  This was correct, but artificially lengthened
1854     // the interval in which INFLATED appeared in the mark, thus increasing
1855     // the odds of inflation contention.
1856     //
1857     // We now use per-thread private objectmonitor free lists.
1858     // These list are reprovisioned from the global free list outside the
1859     // critical INFLATING...ST interval.  A thread can transfer
1860     // multiple objectmonitors en-mass from the global free list to its local free list.
1861     // This reduces coherency traffic and lock contention on the global free list.
1862     // Using such local free lists, it doesn&#39;t matter if the om_alloc() call appears
1863     // before or after the CAS(INFLATING) operation.
1864     // See the comments in om_alloc().
1865 
1866     LogStreamHandle(Trace, monitorinflation) lsh;
1867 
1868     if (mark.has_locker()) {
1869       ObjectMonitor* m = om_alloc(self);
1870       // Optimistically prepare the objectmonitor - anticipate successful CAS
1871       // We do this before the CAS in order to minimize the length of time
1872       // in which INFLATING appears in the mark.
1873       m-&gt;Recycle();
1874       m-&gt;_Responsible  = NULL;
1875       m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;   // Consider: maintain by type/class
1876 
1877       markWord cmp = object-&gt;cas_set_mark(markWord::INFLATING(), mark);
1878       if (cmp != mark) {
1879         // om_release() will reset the allocation state from New to Free.
1880         om_release(self, m, true);
1881         continue;       // Interference -- just retry
1882       }
1883 
1884       // We&#39;ve successfully installed INFLATING (0) into the mark-word.
1885       // This is the only case where 0 will appear in a mark-word.
1886       // Only the singular thread that successfully swings the mark-word
1887       // to 0 can perform (or more precisely, complete) inflation.
1888       //
1889       // Why do we CAS a 0 into the mark-word instead of just CASing the
1890       // mark-word from the stack-locked value directly to the new inflated state?
1891       // Consider what happens when a thread unlocks a stack-locked object.
1892       // It attempts to use CAS to swing the displaced header value from the
1893       // on-stack BasicLock back into the object header.  Recall also that the
1894       // header value (hash code, etc) can reside in (a) the object header, or
1895       // (b) a displaced header associated with the stack-lock, or (c) a displaced
1896       // header in an ObjectMonitor.  The inflate() routine must copy the header
1897       // value from the BasicLock on the owner&#39;s stack to the ObjectMonitor, all
1898       // the while preserving the hashCode stability invariants.  If the owner
1899       // decides to release the lock while the value is 0, the unlock will fail
1900       // and control will eventually pass from slow_exit() to inflate.  The owner
1901       // will then spin, waiting for the 0 value to disappear.   Put another way,
1902       // the 0 causes the owner to stall if the owner happens to try to
1903       // drop the lock (restoring the header from the BasicLock to the object)
1904       // while inflation is in-progress.  This protocol avoids races that might
1905       // would otherwise permit hashCode values to change or &quot;flicker&quot; for an object.
1906       // Critically, while object-&gt;mark is 0 mark.displaced_mark_helper() is stable.
1907       // 0 serves as a &quot;BUSY&quot; inflate-in-progress indicator.
1908 
1909 
1910       // fetch the displaced mark from the owner&#39;s stack.
1911       // The owner can&#39;t die or unwind past the lock while our INFLATING
1912       // object is in the mark.  Furthermore the owner can&#39;t complete
1913       // an unlock on the object, either.
1914       markWord dmw = mark.displaced_mark_helper();
1915       // Catch if the object&#39;s header is not neutral (not locked and
1916       // not marked is what we care about here).
1917       ADIM_guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
1918 
1919       // Setup monitor fields to proper values -- prepare the monitor
1920       m-&gt;set_header(dmw);
1921 
1922       // Optimization: if the mark.locker stack address is associated
1923       // with this thread we could simply set m-&gt;_owner = self.
1924       // Note that a thread can inflate an object
1925       // that it has stack-locked -- as might happen in wait() -- directly
1926       // with CAS.  That is, we can avoid the xchg-NULL .... ST idiom.
1927       if (AsyncDeflateIdleMonitors) {
1928         m-&gt;set_owner_from(NULL, DEFLATER_MARKER, mark.locker());
1929       } else {
1930         m-&gt;set_owner_from(NULL, mark.locker());
1931       }
1932       m-&gt;set_object(object);
1933       // TODO-FIXME: assert BasicLock-&gt;dhw != 0.
1934 
1935       // Must preserve store ordering. The monitor state must
1936       // be stable at the time of publishing the monitor address.
1937       guarantee(object-&gt;mark() == markWord::INFLATING(), &quot;invariant&quot;);
1938       object-&gt;release_set_mark(markWord::encode(m));
1939 
1940       // Once ObjectMonitor is configured and the object is associated
1941       // with the ObjectMonitor, it is safe to allow async deflation:
1942       assert(m-&gt;is_new(), &quot;freshly allocated monitor must be new&quot;);
1943       m-&gt;set_allocation_state(ObjectMonitor::Old);
1944 
1945       // Hopefully the performance counters are allocated on distinct cache lines
1946       // to avoid false sharing on MP systems ...
1947       OM_PERFDATA_OP(Inflations, inc());
1948       if (log_is_enabled(Trace, monitorinflation)) {
1949         ResourceMark rm(self);
1950         lsh.print_cr(&quot;inflate(has_locker): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
1951                      INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
1952                      object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
1953       }
1954       if (event.should_commit()) {
1955         post_monitor_inflate_event(&amp;event, object, cause);
1956       }
1957       return m;
1958     }
1959 
1960     // CASE: neutral
1961     // TODO-FIXME: for entry we currently inflate and then try to CAS _owner.
1962     // If we know we&#39;re inflating for entry it&#39;s better to inflate by swinging a
1963     // pre-locked ObjectMonitor pointer into the object header.   A successful
1964     // CAS inflates the object *and* confers ownership to the inflating thread.
1965     // In the current implementation we use a 2-step mechanism where we CAS()
1966     // to inflate and then CAS() again to try to swing _owner from NULL to self.
1967     // An inflateTry() method that we could call from enter() would be useful.
1968 
1969     // Catch if the object&#39;s header is not neutral (not locked and
1970     // not marked is what we care about here).
1971     ADIM_guarantee(mark.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, mark.value());
1972     ObjectMonitor* m = om_alloc(self);
1973     // prepare m for installation - set monitor to initial state
1974     m-&gt;Recycle();
1975     m-&gt;set_header(mark);
1976     if (AsyncDeflateIdleMonitors) {
1977       // DEFLATER_MARKER is the only non-NULL value we should see here.
1978       m-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
1979     }
1980     m-&gt;set_object(object);
1981     m-&gt;_Responsible  = NULL;
1982     m-&gt;_SpinDuration = ObjectMonitor::Knob_SpinLimit;       // consider: keep metastats by type/class
1983 
1984     if (object-&gt;cas_set_mark(markWord::encode(m), mark) != mark) {
1985       m-&gt;set_header(markWord::zero());
1986       m-&gt;set_object(NULL);
1987       m-&gt;Recycle();
1988       // om_release() will reset the allocation state from New to Free.
1989       om_release(self, m, true);
1990       m = NULL;
1991       continue;
1992       // interference - the markword changed - just retry.
1993       // The state-transitions are one-way, so there&#39;s no chance of
1994       // live-lock -- &quot;Inflated&quot; is an absorbing state.
1995     }
1996 
1997     // Once the ObjectMonitor is configured and object is associated
1998     // with the ObjectMonitor, it is safe to allow async deflation:
1999     assert(m-&gt;is_new(), &quot;freshly allocated monitor must be new&quot;);
2000     m-&gt;set_allocation_state(ObjectMonitor::Old);
2001 
2002     // Hopefully the performance counters are allocated on distinct
2003     // cache lines to avoid false sharing on MP systems ...
2004     OM_PERFDATA_OP(Inflations, inc());
2005     if (log_is_enabled(Trace, monitorinflation)) {
2006       ResourceMark rm(self);
2007       lsh.print_cr(&quot;inflate(neutral): object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2008                    INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(object),
2009                    object-&gt;mark().value(), object-&gt;klass()-&gt;external_name());
2010     }
2011     if (event.should_commit()) {
2012       post_monitor_inflate_event(&amp;event, object, cause);
2013     }
2014     return m;
2015   }
2016 }
2017 
2018 
2019 // We maintain a list of in-use monitors for each thread.
2020 //
2021 // For safepoint based deflation:
2022 // deflate_thread_local_monitors() scans a single thread&#39;s in-use list, while
2023 // deflate_idle_monitors() scans only a global list of in-use monitors which
2024 // is populated only as a thread dies (see om_flush()).
2025 //
2026 // These operations are called at all safepoints, immediately after mutators
2027 // are stopped, but before any objects have moved. Collectively they traverse
2028 // the population of in-use monitors, deflating where possible. The scavenged
2029 // monitors are returned to the global monitor free list.
2030 //
2031 // Beware that we scavenge at *every* stop-the-world point. Having a large
2032 // number of monitors in-use could negatively impact performance. We also want
2033 // to minimize the total # of monitors in circulation, as they incur a small
2034 // footprint penalty.
2035 //
2036 // Perversely, the heap size -- and thus the STW safepoint rate --
2037 // typically drives the scavenge rate.  Large heaps can mean infrequent GC,
2038 // which in turn can mean large(r) numbers of ObjectMonitors in circulation.
2039 // This is an unfortunate aspect of this design.
2040 //
2041 // For async deflation:
2042 // If a special deflation request is made, then the safepoint based
2043 // deflation mechanism is used. Otherwise, an async deflation request
2044 // is registered with the ServiceThread and it is notified.
2045 
2046 void ObjectSynchronizer::do_safepoint_work(DeflateMonitorCounters* counters) {
2047   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2048 
2049   // The per-thread in-use lists are handled in
2050   // ParallelSPCleanupThreadClosure::do_thread().
2051 
<a name="7" id="anc7"></a><span class="line-modified">2052   if (!AsyncDeflateIdleMonitors || is_special_deflation_requested()) {</span>
<span class="line-modified">2053     // Use the older mechanism for the global in-use list or if a</span>
<span class="line-removed">2054     // special deflation has been requested before the safepoint.</span>
2055     ObjectSynchronizer::deflate_idle_monitors(counters);
2056     return;
2057   }
2058 
2059   log_debug(monitorinflation)(&quot;requesting async deflation of idle monitors.&quot;);
2060   // Request deflation of idle monitors by the ServiceThread:
2061   set_is_async_deflation_requested(true);
2062   MonitorLocker ml(Service_lock, Mutex::_no_safepoint_check_flag);
2063   ml.notify_all();
2064 
2065   if (log_is_enabled(Debug, monitorinflation)) {
2066     // exit_globals()&#39;s call to audit_and_print_stats() is done
2067     // at the Info level and not at a safepoint.
2068     // For safepoint based deflation, audit_and_print_stats() is called
2069     // in ObjectSynchronizer::finish_deflate_idle_monitors() at the
2070     // Debug level at a safepoint.
2071     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2072   }
2073 }
2074 
2075 // Deflate a single monitor if not in-use
2076 // Return true if deflated, false if in-use
2077 bool ObjectSynchronizer::deflate_monitor(ObjectMonitor* mid, oop obj,
2078                                          ObjectMonitor** free_head_p,
2079                                          ObjectMonitor** free_tail_p) {
2080   bool deflated;
2081   // Normal case ... The monitor is associated with obj.
2082   const markWord mark = obj-&gt;mark();
2083   guarantee(mark == markWord::encode(mid), &quot;should match: mark=&quot;
2084             INTPTR_FORMAT &quot;, encoded mid=&quot; INTPTR_FORMAT, mark.value(),
2085             markWord::encode(mid).value());
2086   // Make sure that mark.monitor() and markWord::encode() agree:
2087   guarantee(mark.monitor() == mid, &quot;should match: monitor()=&quot; INTPTR_FORMAT
2088             &quot;, mid=&quot; INTPTR_FORMAT, p2i(mark.monitor()), p2i(mid));
2089   const markWord dmw = mid-&gt;header();
2090   guarantee(dmw.is_neutral(), &quot;invariant: header=&quot; INTPTR_FORMAT, dmw.value());
2091 
2092   if (mid-&gt;is_busy()) {
2093     // Easy checks are first - the ObjectMonitor is busy so no deflation.
2094     deflated = false;
2095   } else {
2096     // Deflate the monitor if it is no longer being used
2097     // It&#39;s idle - scavenge and return to the global free list
2098     // plain old deflation ...
2099     if (log_is_enabled(Trace, monitorinflation)) {
2100       ResourceMark rm;
2101       log_trace(monitorinflation)(&quot;deflate_monitor: &quot;
2102                                   &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2103                                   INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;, p2i(obj),
2104                                   mark.value(), obj-&gt;klass()-&gt;external_name());
2105     }
2106 
2107     // Restore the header back to obj
2108     obj-&gt;release_set_mark(dmw);
2109     if (AsyncDeflateIdleMonitors) {
2110       // clear() expects the owner field to be NULL.
2111       // DEFLATER_MARKER is the only non-NULL value we should see here.
2112       mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL);
2113     }
2114     mid-&gt;clear();
2115 
2116     assert(mid-&gt;object() == NULL, &quot;invariant: object=&quot; INTPTR_FORMAT,
2117            p2i(mid-&gt;object()));
2118     assert(mid-&gt;is_free(), &quot;invariant&quot;);
2119 
2120     // Move the deflated ObjectMonitor to the working free list
2121     // defined by free_head_p and free_tail_p.
2122     if (*free_head_p == NULL) *free_head_p = mid;
2123     if (*free_tail_p != NULL) {
2124       // We append to the list so the caller can use mid-&gt;_next_om
2125       // to fix the linkages in its context.
2126       ObjectMonitor* prevtail = *free_tail_p;
2127       // Should have been cleaned up by the caller:
2128       // Note: Should not have to lock prevtail here since we&#39;re at a
2129       // safepoint and ObjectMonitors on the local free list should
2130       // not be accessed in parallel.
2131 #ifdef ASSERT
2132       ObjectMonitor* l_next_om = prevtail-&gt;next_om();
2133 #endif
2134       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2135       prevtail-&gt;set_next_om(mid);
2136     }
2137     *free_tail_p = mid;
2138     // At this point, mid-&gt;_next_om still refers to its current
2139     // value and another ObjectMonitor&#39;s _next_om field still
2140     // refers to this ObjectMonitor. Those linkages have to be
2141     // cleaned up by the caller who has the complete context.
2142     deflated = true;
2143   }
2144   return deflated;
2145 }
2146 
2147 // Deflate the specified ObjectMonitor if not in-use using a JavaThread.
2148 // Returns true if it was deflated and false otherwise.
2149 //
2150 // The async deflation protocol sets owner to DEFLATER_MARKER and
2151 // makes contentions negative as signals to contending threads that
2152 // an async deflation is in progress. There are a number of checks
2153 // as part of the protocol to make sure that the calling thread has
2154 // not lost the race to a contending thread.
2155 //
2156 // The ObjectMonitor has been successfully async deflated when:
2157 //   (contentions &lt; 0)
2158 // Contending threads that see that condition know to retry their operation.
2159 //
2160 bool ObjectSynchronizer::deflate_monitor_using_JT(ObjectMonitor* mid,
2161                                                   ObjectMonitor** free_head_p,
2162                                                   ObjectMonitor** free_tail_p) {
2163   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2164   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2165   // A newly allocated ObjectMonitor should not be seen here so we
2166   // avoid an endless inflate/deflate cycle.
2167   assert(mid-&gt;is_old(), &quot;must be old: allocation_state=%d&quot;,
2168          (int) mid-&gt;allocation_state());
2169 
2170   if (mid-&gt;is_busy()) {
2171     // Easy checks are first - the ObjectMonitor is busy so no deflation.
2172     return false;
2173   }
2174 
2175   // Set a NULL owner to DEFLATER_MARKER to force any contending thread
2176   // through the slow path. This is just the first part of the async
2177   // deflation dance.
2178   if (mid-&gt;try_set_owner_from(NULL, DEFLATER_MARKER) != NULL) {
2179     // The owner field is no longer NULL so we lost the race since the
2180     // ObjectMonitor is now busy.
2181     return false;
2182   }
2183 
2184   if (mid-&gt;contentions() &gt; 0 || mid-&gt;_waiters != 0) {
2185     // Another thread has raced to enter the ObjectMonitor after
2186     // mid-&gt;is_busy() above or has already entered and waited on
2187     // it which makes it busy so no deflation. Restore owner to
2188     // NULL if it is still DEFLATER_MARKER.
2189     if (mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL) != DEFLATER_MARKER) {
2190       // Deferred decrement for the JT EnterI() that cancelled the async deflation.
2191       mid-&gt;add_to_contentions(-1);
2192     }
2193     return false;
2194   }
2195 
2196   // Make a zero contentions field negative to force any contending threads
2197   // to retry. This is the second part of the async deflation dance.
2198   if (Atomic::cmpxchg(&amp;mid-&gt;_contentions, (jint)0, -max_jint) != 0) {
2199     // Contentions was no longer 0 so we lost the race since the
2200     // ObjectMonitor is now busy. Restore owner to NULL if it is
2201     // still DEFLATER_MARKER:
2202     if (mid-&gt;try_set_owner_from(DEFLATER_MARKER, NULL) != DEFLATER_MARKER) {
2203       // Deferred decrement for the JT EnterI() that cancelled the async deflation.
2204       mid-&gt;add_to_contentions(-1);
2205     }
2206     return false;
2207   }
2208 
2209   // Sanity checks for the races:
2210   guarantee(mid-&gt;owner_is_DEFLATER_MARKER(), &quot;must be deflater marker&quot;);
2211   guarantee(mid-&gt;contentions() &lt; 0, &quot;must be negative: contentions=%d&quot;,
2212             mid-&gt;contentions());
2213   guarantee(mid-&gt;_waiters == 0, &quot;must be 0: waiters=%d&quot;, mid-&gt;_waiters);
2214   guarantee(mid-&gt;_cxq == NULL, &quot;must be no contending threads: cxq=&quot;
2215             INTPTR_FORMAT, p2i(mid-&gt;_cxq));
2216   guarantee(mid-&gt;_EntryList == NULL,
2217             &quot;must be no entering threads: EntryList=&quot; INTPTR_FORMAT,
2218             p2i(mid-&gt;_EntryList));
2219 
2220   const oop obj = (oop) mid-&gt;object();
2221   if (log_is_enabled(Trace, monitorinflation)) {
2222     ResourceMark rm;
2223     log_trace(monitorinflation)(&quot;deflate_monitor_using_JT: &quot;
2224                                 &quot;object=&quot; INTPTR_FORMAT &quot;, mark=&quot;
2225                                 INTPTR_FORMAT &quot;, type=&#39;%s&#39;&quot;,
2226                                 p2i(obj), obj-&gt;mark().value(),
2227                                 obj-&gt;klass()-&gt;external_name());
2228   }
2229 
2230   // Install the old mark word if nobody else has already done it.
2231   mid-&gt;install_displaced_markword_in_object(obj);
2232   mid-&gt;clear_common();
2233 
2234   assert(mid-&gt;object() == NULL, &quot;must be NULL: object=&quot; INTPTR_FORMAT,
2235          p2i(mid-&gt;object()));
2236   assert(mid-&gt;is_free(), &quot;must be free: allocation_state=%d&quot;,
2237          (int)mid-&gt;allocation_state());
2238 
2239   // Move the deflated ObjectMonitor to the working free list
2240   // defined by free_head_p and free_tail_p.
2241   if (*free_head_p == NULL) {
2242     // First one on the list.
2243     *free_head_p = mid;
2244   }
2245   if (*free_tail_p != NULL) {
2246     // We append to the list so the caller can use mid-&gt;_next_om
2247     // to fix the linkages in its context.
2248     ObjectMonitor* prevtail = *free_tail_p;
2249     // prevtail should have been cleaned up by the caller:
2250 #ifdef ASSERT
2251     ObjectMonitor* l_next_om = unmarked_next(prevtail);
2252 #endif
2253     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2254     om_lock(prevtail);
2255     prevtail-&gt;set_next_om(mid);  // prevtail now points to mid (and is unlocked)
2256   }
2257   *free_tail_p = mid;
2258 
2259   // At this point, mid-&gt;_next_om still refers to its current
2260   // value and another ObjectMonitor&#39;s _next_om field still
2261   // refers to this ObjectMonitor. Those linkages have to be
2262   // cleaned up by the caller who has the complete context.
2263 
2264   // We leave owner == DEFLATER_MARKER and contentions &lt; 0
2265   // to force any racing threads to retry.
2266   return true;  // Success, ObjectMonitor has been deflated.
2267 }
2268 
2269 // Walk a given monitor list, and deflate idle monitors.
2270 // The given list could be a per-thread list or a global list.
2271 //
2272 // In the case of parallel processing of thread local monitor lists,
2273 // work is done by Threads::parallel_threads_do() which ensures that
2274 // each Java thread is processed by exactly one worker thread, and
2275 // thus avoid conflicts that would arise when worker threads would
2276 // process the same monitor lists concurrently.
2277 //
2278 // See also ParallelSPCleanupTask and
2279 // SafepointSynchronize::do_cleanup_tasks() in safepoint.cpp and
2280 // Threads::parallel_java_threads_do() in thread.cpp.
2281 int ObjectSynchronizer::deflate_monitor_list(ObjectMonitor** list_p,
2282                                              int* count_p,
2283                                              ObjectMonitor** free_head_p,
2284                                              ObjectMonitor** free_tail_p) {
2285   ObjectMonitor* cur_mid_in_use = NULL;
2286   ObjectMonitor* mid = NULL;
2287   ObjectMonitor* next = NULL;
2288   int deflated_count = 0;
2289 
2290   // This list walk executes at a safepoint and does not race with any
2291   // other list walkers.
2292 
2293   for (mid = Atomic::load(list_p); mid != NULL; mid = next) {
2294     next = unmarked_next(mid);
2295     oop obj = (oop) mid-&gt;object();
2296     if (obj != NULL &amp;&amp; deflate_monitor(mid, obj, free_head_p, free_tail_p)) {
2297       // Deflation succeeded and already updated free_head_p and
2298       // free_tail_p as needed. Finish the move to the local free list
2299       // by unlinking mid from the global or per-thread in-use list.
2300       if (cur_mid_in_use == NULL) {
2301         // mid is the list head so switch the list head to next:
2302         Atomic::store(list_p, next);
2303       } else {
2304         // Switch cur_mid_in_use&#39;s next field to next:
2305         cur_mid_in_use-&gt;set_next_om(next);
2306       }
2307       // At this point mid is disconnected from the in-use list.
2308       deflated_count++;
2309       Atomic::dec(count_p);
2310       // mid is current tail in the free_head_p list so NULL terminate it:
2311       mid-&gt;set_next_om(NULL);
2312     } else {
2313       cur_mid_in_use = mid;
2314     }
2315   }
2316   return deflated_count;
2317 }
2318 
2319 // Walk a given ObjectMonitor list and deflate idle ObjectMonitors using
2320 // a JavaThread. Returns the number of deflated ObjectMonitors. The given
2321 // list could be a per-thread in-use list or the global in-use list.
2322 // If a safepoint has started, then we save state via saved_mid_in_use_p
2323 // and return to the caller to honor the safepoint.
2324 //
2325 int ObjectSynchronizer::deflate_monitor_list_using_JT(ObjectMonitor** list_p,
2326                                                       int* count_p,
2327                                                       ObjectMonitor** free_head_p,
2328                                                       ObjectMonitor** free_tail_p,
2329                                                       ObjectMonitor** saved_mid_in_use_p) {
2330   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2331   JavaThread* self = JavaThread::current();
2332 
2333   ObjectMonitor* cur_mid_in_use = NULL;
2334   ObjectMonitor* mid = NULL;
2335   ObjectMonitor* next = NULL;
2336   ObjectMonitor* next_next = NULL;
2337   int deflated_count = 0;
2338   NoSafepointVerifier nsv;
2339 
2340   // We use the more complicated lock-cur_mid_in_use-and-mid-as-we-go
2341   // protocol because om_release() can do list deletions in parallel;
2342   // this also prevents races with a list walker thread. We also
2343   // lock-next-next-as-we-go to prevent an om_flush() that is behind
2344   // this thread from passing us.
2345   if (*saved_mid_in_use_p == NULL) {
2346     // No saved state so start at the beginning.
2347     // Lock the list head so we can possibly deflate it:
2348     if ((mid = get_list_head_locked(list_p)) == NULL) {
2349       return 0;  // The list is empty so nothing to deflate.
2350     }
2351     next = unmarked_next(mid);
2352   } else {
2353     // We&#39;re restarting after a safepoint so restore the necessary state
2354     // before we resume.
2355     cur_mid_in_use = *saved_mid_in_use_p;
2356     // Lock cur_mid_in_use so we can possibly update its
2357     // next field to extract a deflated ObjectMonitor.
2358     om_lock(cur_mid_in_use);
2359     mid = unmarked_next(cur_mid_in_use);
2360     if (mid == NULL) {
2361       om_unlock(cur_mid_in_use);
2362       *saved_mid_in_use_p = NULL;
2363       return 0;  // The remainder is empty so nothing more to deflate.
2364     }
2365     // Lock mid so we can possibly deflate it:
2366     om_lock(mid);
2367     next = unmarked_next(mid);
2368   }
2369 
2370   while (true) {
2371     // The current mid is locked at this point. If we have a
2372     // cur_mid_in_use, then it is also locked at this point.
2373 
2374     if (next != NULL) {
2375       // We lock next so that an om_flush() thread that is behind us
2376       // cannot pass us when we unlock the current mid.
2377       om_lock(next);
2378       next_next = unmarked_next(next);
2379     }
2380 
2381     // Only try to deflate if there is an associated Java object and if
2382     // mid is old (is not newly allocated and is not newly freed).
2383     if (mid-&gt;object() != NULL &amp;&amp; mid-&gt;is_old() &amp;&amp;
2384         deflate_monitor_using_JT(mid, free_head_p, free_tail_p)) {
2385       // Deflation succeeded and already updated free_head_p and
2386       // free_tail_p as needed. Finish the move to the local free list
2387       // by unlinking mid from the global or per-thread in-use list.
2388       if (cur_mid_in_use == NULL) {
2389         // mid is the list head and it is locked. Switch the list head
2390         // to next which is also locked (if not NULL) and also leave
2391         // mid locked:
2392         Atomic::store(list_p, next);
2393       } else {
2394         ObjectMonitor* locked_next = mark_om_ptr(next);
2395         // mid and cur_mid_in_use are locked. Switch cur_mid_in_use&#39;s
2396         // next field to locked_next and also leave mid locked:
2397         cur_mid_in_use-&gt;set_next_om(locked_next);
2398       }
2399       // At this point mid is disconnected from the in-use list so
2400       // its lock longer has any effects on in-use list.
2401       deflated_count++;
2402       Atomic::dec(count_p);
2403       // mid is current tail in the free_head_p list so NULL terminate it
2404       // (which also unlocks it):
2405       mid-&gt;set_next_om(NULL);
2406 
2407       // All the list management is done so move on to the next one:
2408       mid = next;  // mid keeps non-NULL next&#39;s locked state
2409       next = next_next;
2410     } else {
2411       // mid is considered in-use if it does not have an associated
2412       // Java object or mid is not old or deflation did not succeed.
2413       // A mid-&gt;is_new() node can be seen here when it is freshly
2414       // returned by om_alloc() (and skips the deflation code path).
2415       // A mid-&gt;is_old() node can be seen here when deflation failed.
2416       // A mid-&gt;is_free() node can be seen here when a fresh node from
2417       // om_alloc() is released by om_release() due to losing the race
2418       // in inflate().
2419 
2420       // All the list management is done so move on to the next one:
2421       if (cur_mid_in_use != NULL) {
2422         om_unlock(cur_mid_in_use);
2423       }
2424       // The next cur_mid_in_use keeps mid&#39;s lock state so
2425       // that it is stable for a possible next field change. It
2426       // cannot be modified by om_release() while it is locked.
2427       cur_mid_in_use = mid;
2428       mid = next;  // mid keeps non-NULL next&#39;s locked state
2429       next = next_next;
2430 
2431       if (SafepointMechanism::should_block(self) &amp;&amp;
2432           cur_mid_in_use != Atomic::load(list_p) &amp;&amp; cur_mid_in_use-&gt;is_old()) {
2433         // If a safepoint has started and cur_mid_in_use is not the list
2434         // head and is old, then it is safe to use as saved state. Return
2435         // to the caller before blocking.
2436         *saved_mid_in_use_p = cur_mid_in_use;
2437         om_unlock(cur_mid_in_use);
2438         if (mid != NULL) {
2439           om_unlock(mid);
2440         }
2441         return deflated_count;
2442       }
2443     }
2444     if (mid == NULL) {
2445       if (cur_mid_in_use != NULL) {
2446         om_unlock(cur_mid_in_use);
2447       }
2448       break;  // Reached end of the list so nothing more to deflate.
2449     }
2450 
2451     // The current mid&#39;s next field is locked at this point. If we have
2452     // a cur_mid_in_use, then it is also locked at this point.
2453   }
2454   // We finished the list without a safepoint starting so there&#39;s
2455   // no need to save state.
2456   *saved_mid_in_use_p = NULL;
2457   return deflated_count;
2458 }
2459 
2460 void ObjectSynchronizer::prepare_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2461   counters-&gt;n_in_use = 0;              // currently associated with objects
2462   counters-&gt;n_in_circulation = 0;      // extant
2463   counters-&gt;n_scavenged = 0;           // reclaimed (global and per-thread)
2464   counters-&gt;per_thread_scavenged = 0;  // per-thread scavenge total
2465   counters-&gt;per_thread_times = 0.0;    // per-thread scavenge times
2466 }
2467 
2468 void ObjectSynchronizer::deflate_idle_monitors(DeflateMonitorCounters* counters) {
2469   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2470 
2471   if (AsyncDeflateIdleMonitors) {
2472     // Nothing to do when global idle ObjectMonitors are deflated using
<a name="8" id="anc8"></a><span class="line-modified">2473     // a JavaThread unless a special deflation has been requested.</span>
<span class="line-modified">2474     if (!is_special_deflation_requested()) {</span>
<span class="line-removed">2475       return;</span>
<span class="line-removed">2476     }</span>
2477   }
2478 
2479   bool deflated = false;
2480 
2481   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2482   ObjectMonitor* free_tail_p = NULL;
2483   elapsedTimer timer;
2484 
2485   if (log_is_enabled(Info, monitorinflation)) {
2486     timer.start();
2487   }
2488 
2489   // Note: the thread-local monitors lists get deflated in
2490   // a separate pass. See deflate_thread_local_monitors().
2491 
2492   // For moribund threads, scan om_list_globals._in_use_list
2493   int deflated_count = 0;
2494   if (Atomic::load(&amp;om_list_globals._in_use_list) != NULL) {
2495     // Update n_in_circulation before om_list_globals._in_use_count is
2496     // updated by deflation.
2497     Atomic::add(&amp;counters-&gt;n_in_circulation,
2498                 Atomic::load(&amp;om_list_globals._in_use_count));
2499 
2500     deflated_count = deflate_monitor_list(&amp;om_list_globals._in_use_list,
2501                                           &amp;om_list_globals._in_use_count,
2502                                           &amp;free_head_p, &amp;free_tail_p);
2503     Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;om_list_globals._in_use_count));
2504   }
2505 
2506   if (free_head_p != NULL) {
2507     // Move the deflated ObjectMonitors back to the global free list.
2508     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2509 #ifdef ASSERT
2510     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2511 #endif
2512     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2513     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2514     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2515   }
2516   timer.stop();
2517 
2518   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2519   LogStreamHandle(Info, monitorinflation) lsh_info;
2520   LogStream* ls = NULL;
2521   if (log_is_enabled(Debug, monitorinflation)) {
2522     ls = &amp;lsh_debug;
2523   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2524     ls = &amp;lsh_info;
2525   }
2526   if (ls != NULL) {
2527     ls-&gt;print_cr(&quot;deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2528   }
2529 }
2530 
2531 class HandshakeForDeflation : public HandshakeClosure {
2532  public:
2533   HandshakeForDeflation() : HandshakeClosure(&quot;HandshakeForDeflation&quot;) {}
2534 
2535   void do_thread(Thread* thread) {
2536     log_trace(monitorinflation)(&quot;HandshakeForDeflation::do_thread: thread=&quot;
2537                                 INTPTR_FORMAT, p2i(thread));
2538   }
2539 };
2540 
2541 void ObjectSynchronizer::deflate_idle_monitors_using_JT() {
2542   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2543 
2544   // Deflate any global idle monitors.
2545   deflate_global_idle_monitors_using_JT();
2546 
2547   int count = 0;
2548   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2549     if (Atomic::load(&amp;jt-&gt;om_in_use_count) &gt; 0 &amp;&amp; !jt-&gt;is_exiting()) {
2550       // This JavaThread is using ObjectMonitors so deflate any that
2551       // are idle unless this JavaThread is exiting; do not race with
2552       // ObjectSynchronizer::om_flush().
2553       deflate_per_thread_idle_monitors_using_JT(jt);
2554       count++;
2555     }
2556   }
2557   if (count &gt; 0) {
2558     log_debug(monitorinflation)(&quot;did async deflation of idle monitors for %d thread(s).&quot;, count);
2559   }
2560 
2561   log_info(monitorinflation)(&quot;async global_population=%d, global_in_use_count=%d, &quot;
2562                              &quot;global_free_count=%d, global_wait_count=%d&quot;,
2563                              Atomic::load(&amp;om_list_globals._population),
2564                              Atomic::load(&amp;om_list_globals._in_use_count),
2565                              Atomic::load(&amp;om_list_globals._free_count),
2566                              Atomic::load(&amp;om_list_globals._wait_count));
2567 
2568   // The ServiceThread&#39;s async deflation request has been processed.
<a name="9" id="anc9"></a>
2569   set_is_async_deflation_requested(false);
2570 
2571   if (Atomic::load(&amp;om_list_globals._wait_count) &gt; 0) {
2572     // There are deflated ObjectMonitors waiting for a handshake
2573     // (or a safepoint) for safety.
2574 
2575     ObjectMonitor* list = Atomic::load(&amp;om_list_globals._wait_list);
2576     ADIM_guarantee(list != NULL, &quot;om_list_globals._wait_list must not be NULL&quot;);
2577     int count = Atomic::load(&amp;om_list_globals._wait_count);
2578     Atomic::store(&amp;om_list_globals._wait_count, 0);
2579     Atomic::store(&amp;om_list_globals._wait_list, (ObjectMonitor*)NULL);
2580 
2581     // Find the tail for prepend_list_to_common(). No need to mark
2582     // ObjectMonitors for this list walk since only the deflater
2583     // thread manages the wait list.
2584     int l_count = 0;
2585     ObjectMonitor* tail = NULL;
2586     for (ObjectMonitor* n = list; n != NULL; n = unmarked_next(n)) {
2587       tail = n;
2588       l_count++;
2589     }
2590     ADIM_guarantee(count == l_count, &quot;count=%d != l_count=%d&quot;, count, l_count);
2591 
2592     // Will execute a safepoint if !ThreadLocalHandshakes:
2593     HandshakeForDeflation hfd_hc;
2594     Handshake::execute(&amp;hfd_hc);
2595 
2596     prepend_list_to_common(list, tail, count, &amp;om_list_globals._free_list,
2597                            &amp;om_list_globals._free_count);
2598 
2599     log_info(monitorinflation)(&quot;moved %d idle monitors from global waiting list to global free list&quot;, count);
2600   }
2601 }
2602 
2603 // Deflate global idle ObjectMonitors using a JavaThread.
2604 //
2605 void ObjectSynchronizer::deflate_global_idle_monitors_using_JT() {
2606   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2607   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2608   JavaThread* self = JavaThread::current();
2609 
2610   deflate_common_idle_monitors_using_JT(true /* is_global */, self);
2611 }
2612 
2613 // Deflate the specified JavaThread&#39;s idle ObjectMonitors using a JavaThread.
2614 //
2615 void ObjectSynchronizer::deflate_per_thread_idle_monitors_using_JT(JavaThread* target) {
2616   assert(AsyncDeflateIdleMonitors, &quot;sanity check&quot;);
2617   assert(Thread::current()-&gt;is_Java_thread(), &quot;precondition&quot;);
2618 
2619   deflate_common_idle_monitors_using_JT(false /* !is_global */, target);
2620 }
2621 
2622 // Deflate global or per-thread idle ObjectMonitors using a JavaThread.
2623 //
2624 void ObjectSynchronizer::deflate_common_idle_monitors_using_JT(bool is_global, JavaThread* target) {
2625   JavaThread* self = JavaThread::current();
2626 
2627   int deflated_count = 0;
2628   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged ObjectMonitors
2629   ObjectMonitor* free_tail_p = NULL;
2630   ObjectMonitor* saved_mid_in_use_p = NULL;
2631   elapsedTimer timer;
2632 
2633   if (log_is_enabled(Info, monitorinflation)) {
2634     timer.start();
2635   }
2636 
2637   if (is_global) {
2638     OM_PERFDATA_OP(MonExtant, set_value(Atomic::load(&amp;om_list_globals._in_use_count)));
2639   } else {
2640     OM_PERFDATA_OP(MonExtant, inc(Atomic::load(&amp;target-&gt;om_in_use_count)));
2641   }
2642 
2643   do {
<a name="10" id="anc10"></a><span class="line-removed">2644     if (saved_mid_in_use_p != NULL) {</span>
<span class="line-removed">2645       // We looped around because deflate_monitor_list_using_JT()</span>
<span class="line-removed">2646       // detected a pending safepoint. Honoring the safepoint is good,</span>
<span class="line-removed">2647       // but as long as is_special_deflation_requested() is supported,</span>
<span class="line-removed">2648       // we can&#39;t safely restart using saved_mid_in_use_p. That saved</span>
<span class="line-removed">2649       // ObjectMonitor could have been deflated by safepoint based</span>
<span class="line-removed">2650       // deflation and would no longer be on the in-use list where we</span>
<span class="line-removed">2651       // originally found it.</span>
<span class="line-removed">2652       saved_mid_in_use_p = NULL;</span>
<span class="line-removed">2653     }</span>
2654     int local_deflated_count;
2655     if (is_global) {
2656       local_deflated_count =
2657           deflate_monitor_list_using_JT(&amp;om_list_globals._in_use_list,
2658                                         &amp;om_list_globals._in_use_count,
2659                                         &amp;free_head_p, &amp;free_tail_p,
2660                                         &amp;saved_mid_in_use_p);
2661     } else {
2662       local_deflated_count =
2663           deflate_monitor_list_using_JT(&amp;target-&gt;om_in_use_list,
2664                                         &amp;target-&gt;om_in_use_count, &amp;free_head_p,
2665                                         &amp;free_tail_p, &amp;saved_mid_in_use_p);
2666     }
2667     deflated_count += local_deflated_count;
2668 
2669     if (free_head_p != NULL) {
2670       // Move the deflated ObjectMonitors to the global free list.
2671       guarantee(free_tail_p != NULL &amp;&amp; local_deflated_count &gt; 0, &quot;free_tail_p=&quot; INTPTR_FORMAT &quot;, local_deflated_count=%d&quot;, p2i(free_tail_p), local_deflated_count);
2672       // Note: The target thread can be doing an om_alloc() that
2673       // is trying to prepend an ObjectMonitor on its in-use list
2674       // at the same time that we have deflated the current in-use
2675       // list head and put it on the local free list. prepend_to_common()
2676       // will detect the race and retry which avoids list corruption,
2677       // but the next field in free_tail_p can flicker to marked
2678       // and then unmarked while prepend_to_common() is sorting it
2679       // all out.
2680 #ifdef ASSERT
2681       ObjectMonitor* l_next_om = unmarked_next(free_tail_p);
2682 #endif
2683       assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2684 
2685       prepend_list_to_global_wait_list(free_head_p, free_tail_p, local_deflated_count);
2686 
2687       OM_PERFDATA_OP(Deflations, inc(local_deflated_count));
2688     }
2689 
2690     if (saved_mid_in_use_p != NULL) {
2691       // deflate_monitor_list_using_JT() detected a safepoint starting.
2692       timer.stop();
2693       {
2694         if (is_global) {
2695           log_debug(monitorinflation)(&quot;pausing deflation of global idle monitors for a safepoint.&quot;);
2696         } else {
2697           log_debug(monitorinflation)(&quot;jt=&quot; INTPTR_FORMAT &quot;: pausing deflation of per-thread idle monitors for a safepoint.&quot;, p2i(target));
2698         }
2699         assert(SafepointMechanism::should_block(self), &quot;sanity check&quot;);
2700         ThreadBlockInVM blocker(self);
2701       }
2702       // Prepare for another loop after the safepoint.
2703       free_head_p = NULL;
2704       free_tail_p = NULL;
2705       if (log_is_enabled(Info, monitorinflation)) {
2706         timer.start();
2707       }
2708     }
2709   } while (saved_mid_in_use_p != NULL);
2710   timer.stop();
2711 
2712   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2713   LogStreamHandle(Info, monitorinflation) lsh_info;
2714   LogStream* ls = NULL;
2715   if (log_is_enabled(Debug, monitorinflation)) {
2716     ls = &amp;lsh_debug;
2717   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2718     ls = &amp;lsh_info;
2719   }
2720   if (ls != NULL) {
2721     if (is_global) {
2722       ls-&gt;print_cr(&quot;async-deflating global idle monitors, %3.7f secs, %d monitors&quot;, timer.seconds(), deflated_count);
2723     } else {
2724       ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: async-deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(target), timer.seconds(), deflated_count);
2725     }
2726   }
2727 }
2728 
2729 void ObjectSynchronizer::finish_deflate_idle_monitors(DeflateMonitorCounters* counters) {
2730   // Report the cumulative time for deflating each thread&#39;s idle
2731   // monitors. Note: if the work is split among more than one
2732   // worker thread, then the reported time will likely be more
2733   // than a beginning to end measurement of the phase.
2734   log_info(safepoint, cleanup)(&quot;deflating per-thread idle monitors, %3.7f secs, monitors=%d&quot;, counters-&gt;per_thread_times, counters-&gt;per_thread_scavenged);
2735 
<a name="11" id="anc11"></a><span class="line-modified">2736   bool needs_special_deflation = is_special_deflation_requested();</span>
<span class="line-removed">2737   if (AsyncDeflateIdleMonitors &amp;&amp; !needs_special_deflation) {</span>
2738     // Nothing to do when idle ObjectMonitors are deflated using
<a name="12" id="anc12"></a><span class="line-modified">2739     // a JavaThread unless a special deflation has been requested.</span>
2740     return;
2741   }
2742 
2743   if (log_is_enabled(Debug, monitorinflation)) {
2744     // exit_globals()&#39;s call to audit_and_print_stats() is done
2745     // at the Info level and not at a safepoint.
2746     // For async deflation, audit_and_print_stats() is called in
2747     // ObjectSynchronizer::do_safepoint_work() at the Debug level
2748     // at a safepoint.
2749     ObjectSynchronizer::audit_and_print_stats(false /* on_exit */);
2750   } else if (log_is_enabled(Info, monitorinflation)) {
2751     log_info(monitorinflation)(&quot;global_population=%d, global_in_use_count=%d, &quot;
2752                                &quot;global_free_count=%d, global_wait_count=%d&quot;,
2753                                Atomic::load(&amp;om_list_globals._population),
2754                                Atomic::load(&amp;om_list_globals._in_use_count),
2755                                Atomic::load(&amp;om_list_globals._free_count),
2756                                Atomic::load(&amp;om_list_globals._wait_count));
2757   }
2758 
2759   OM_PERFDATA_OP(Deflations, inc(counters-&gt;n_scavenged));
2760   OM_PERFDATA_OP(MonExtant, set_value(counters-&gt;n_in_circulation));
2761 
2762   GVars.stw_random = os::random();
2763   GVars.stw_cycle++;
<a name="13" id="anc13"></a><span class="line-removed">2764 </span>
<span class="line-removed">2765   if (needs_special_deflation) {</span>
<span class="line-removed">2766     set_is_special_deflation_requested(false);  // special deflation is done</span>
<span class="line-removed">2767   }</span>
2768 }
2769 
2770 void ObjectSynchronizer::deflate_thread_local_monitors(Thread* thread, DeflateMonitorCounters* counters) {
2771   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
2772 
<a name="14" id="anc14"></a><span class="line-modified">2773   if (AsyncDeflateIdleMonitors &amp;&amp; !is_special_deflation_requested()) {</span>
<span class="line-modified">2774     // Nothing to do if a special deflation has NOT been requested.</span>

2775     return;
2776   }
2777 
2778   ObjectMonitor* free_head_p = NULL;  // Local SLL of scavenged monitors
2779   ObjectMonitor* free_tail_p = NULL;
2780   elapsedTimer timer;
2781 
2782   if (log_is_enabled(Info, safepoint, cleanup) ||
2783       log_is_enabled(Info, monitorinflation)) {
2784     timer.start();
2785   }
2786 
2787   // Update n_in_circulation before om_in_use_count is updated by deflation.
2788   Atomic::add(&amp;counters-&gt;n_in_circulation, Atomic::load(&amp;thread-&gt;om_in_use_count));
2789 
2790   int deflated_count = deflate_monitor_list(&amp;thread-&gt;om_in_use_list, &amp;thread-&gt;om_in_use_count, &amp;free_head_p, &amp;free_tail_p);
2791   Atomic::add(&amp;counters-&gt;n_in_use, Atomic::load(&amp;thread-&gt;om_in_use_count));
2792 
2793   if (free_head_p != NULL) {
2794     // Move the deflated ObjectMonitors back to the global free list.
2795     guarantee(free_tail_p != NULL &amp;&amp; deflated_count &gt; 0, &quot;invariant&quot;);
2796 #ifdef ASSERT
2797     ObjectMonitor* l_next_om = free_tail_p-&gt;next_om();
2798 #endif
2799     assert(l_next_om == NULL, &quot;must be NULL: _next_om=&quot; INTPTR_FORMAT, p2i(l_next_om));
2800     prepend_list_to_global_free_list(free_head_p, free_tail_p, deflated_count);
2801     Atomic::add(&amp;counters-&gt;n_scavenged, deflated_count);
2802     Atomic::add(&amp;counters-&gt;per_thread_scavenged, deflated_count);
2803   }
2804 
2805   timer.stop();
2806   counters-&gt;per_thread_times += timer.seconds();
2807 
2808   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2809   LogStreamHandle(Info, monitorinflation) lsh_info;
2810   LogStream* ls = NULL;
2811   if (log_is_enabled(Debug, monitorinflation)) {
2812     ls = &amp;lsh_debug;
2813   } else if (deflated_count != 0 &amp;&amp; log_is_enabled(Info, monitorinflation)) {
2814     ls = &amp;lsh_info;
2815   }
2816   if (ls != NULL) {
2817     ls-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: deflating per-thread idle monitors, %3.7f secs, %d monitors&quot;, p2i(thread), timer.seconds(), deflated_count);
2818   }
2819 }
2820 
2821 // Monitor cleanup on JavaThread::exit
2822 
2823 // Iterate through monitor cache and attempt to release thread&#39;s monitors
2824 // Gives up on a particular monitor if an exception occurs, but continues
2825 // the overall iteration, swallowing the exception.
2826 class ReleaseJavaMonitorsClosure: public MonitorClosure {
2827  private:
2828   TRAPS;
2829 
2830  public:
2831   ReleaseJavaMonitorsClosure(Thread* thread) : THREAD(thread) {}
2832   void do_monitor(ObjectMonitor* mid) {
2833     if (mid-&gt;owner() == THREAD) {
2834       (void)mid-&gt;complete_exit(CHECK);
2835     }
2836   }
2837 };
2838 
2839 // Release all inflated monitors owned by THREAD.  Lightweight monitors are
2840 // ignored.  This is meant to be called during JNI thread detach which assumes
2841 // all remaining monitors are heavyweight.  All exceptions are swallowed.
2842 // Scanning the extant monitor list can be time consuming.
2843 // A simple optimization is to add a per-thread flag that indicates a thread
2844 // called jni_monitorenter() during its lifetime.
2845 //
2846 // Instead of No_Savepoint_Verifier it might be cheaper to
2847 // use an idiom of the form:
2848 //   auto int tmp = SafepointSynchronize::_safepoint_counter ;
2849 //   &lt;code that must not run at safepoint&gt;
2850 //   guarantee (((tmp ^ _safepoint_counter) | (tmp &amp; 1)) == 0) ;
2851 // Since the tests are extremely cheap we could leave them enabled
2852 // for normal product builds.
2853 
2854 void ObjectSynchronizer::release_monitors_owned_by_thread(TRAPS) {
2855   assert(THREAD == JavaThread::current(), &quot;must be current Java thread&quot;);
2856   NoSafepointVerifier nsv;
2857   ReleaseJavaMonitorsClosure rjmc(THREAD);
2858   ObjectSynchronizer::monitors_iterate(&amp;rjmc);
2859   THREAD-&gt;clear_pending_exception();
2860 }
2861 
2862 const char* ObjectSynchronizer::inflate_cause_name(const InflateCause cause) {
2863   switch (cause) {
2864     case inflate_cause_vm_internal:    return &quot;VM Internal&quot;;
2865     case inflate_cause_monitor_enter:  return &quot;Monitor Enter&quot;;
2866     case inflate_cause_wait:           return &quot;Monitor Wait&quot;;
2867     case inflate_cause_notify:         return &quot;Monitor Notify&quot;;
2868     case inflate_cause_hash_code:      return &quot;Monitor Hash Code&quot;;
2869     case inflate_cause_jni_enter:      return &quot;JNI Monitor Enter&quot;;
2870     case inflate_cause_jni_exit:       return &quot;JNI Monitor Exit&quot;;
2871     default:
2872       ShouldNotReachHere();
2873   }
2874   return &quot;Unknown&quot;;
2875 }
2876 
2877 //------------------------------------------------------------------------------
2878 // Debugging code
2879 
2880 u_char* ObjectSynchronizer::get_gvars_addr() {
2881   return (u_char*)&amp;GVars;
2882 }
2883 
2884 u_char* ObjectSynchronizer::get_gvars_hc_sequence_addr() {
2885   return (u_char*)&amp;GVars.hc_sequence;
2886 }
2887 
2888 size_t ObjectSynchronizer::get_gvars_size() {
2889   return sizeof(SharedGlobals);
2890 }
2891 
2892 u_char* ObjectSynchronizer::get_gvars_stw_random_addr() {
2893   return (u_char*)&amp;GVars.stw_random;
2894 }
2895 
2896 // This function can be called at a safepoint or it can be called when
2897 // we are trying to exit the VM. When we are trying to exit the VM, the
2898 // list walker functions can run in parallel with the other list
2899 // operations so spin-locking is used for safety.
2900 //
2901 // Calls to this function can be added in various places as a debugging
2902 // aid; pass &#39;true&#39; for the &#39;on_exit&#39; parameter to have in-use monitor
2903 // details logged at the Info level and &#39;false&#39; for the &#39;on_exit&#39;
2904 // parameter to have in-use monitor details logged at the Trace level.
2905 // deflate_monitor_list() no longer uses spin-locking so be careful
2906 // when adding audit_and_print_stats() calls at a safepoint.
2907 //
2908 void ObjectSynchronizer::audit_and_print_stats(bool on_exit) {
2909   assert(on_exit || SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
2910 
2911   LogStreamHandle(Debug, monitorinflation) lsh_debug;
2912   LogStreamHandle(Info, monitorinflation) lsh_info;
2913   LogStreamHandle(Trace, monitorinflation) lsh_trace;
2914   LogStream* ls = NULL;
2915   if (log_is_enabled(Trace, monitorinflation)) {
2916     ls = &amp;lsh_trace;
2917   } else if (log_is_enabled(Debug, monitorinflation)) {
2918     ls = &amp;lsh_debug;
2919   } else if (log_is_enabled(Info, monitorinflation)) {
2920     ls = &amp;lsh_info;
2921   }
2922   assert(ls != NULL, &quot;sanity check&quot;);
2923 
2924   // Log counts for the global and per-thread monitor lists:
2925   int chk_om_population = log_monitor_list_counts(ls);
2926   int error_cnt = 0;
2927 
2928   ls-&gt;print_cr(&quot;Checking global lists:&quot;);
2929 
2930   // Check om_list_globals._population:
2931   if (Atomic::load(&amp;om_list_globals._population) == chk_om_population) {
2932     ls-&gt;print_cr(&quot;global_population=%d equals chk_om_population=%d&quot;,
2933                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2934   } else {
2935     // With fine grained locks on the monitor lists, it is possible for
2936     // log_monitor_list_counts() to return a value that doesn&#39;t match
2937     // om_list_globals._population. So far a higher value has been
2938     // seen in testing so something is being double counted by
2939     // log_monitor_list_counts().
2940     ls-&gt;print_cr(&quot;WARNING: global_population=%d is not equal to &quot;
2941                  &quot;chk_om_population=%d&quot;,
2942                  Atomic::load(&amp;om_list_globals._population), chk_om_population);
2943   }
2944 
2945   // Check om_list_globals._in_use_list and om_list_globals._in_use_count:
2946   chk_global_in_use_list_and_count(ls, &amp;error_cnt);
2947 
2948   // Check om_list_globals._free_list and om_list_globals._free_count:
2949   chk_global_free_list_and_count(ls, &amp;error_cnt);
2950 
2951   // Check om_list_globals._wait_list and om_list_globals._wait_count:
2952   chk_global_wait_list_and_count(ls, &amp;error_cnt);
2953 
2954   ls-&gt;print_cr(&quot;Checking per-thread lists:&quot;);
2955 
2956   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
2957     // Check om_in_use_list and om_in_use_count:
2958     chk_per_thread_in_use_list_and_count(jt, ls, &amp;error_cnt);
2959 
2960     // Check om_free_list and om_free_count:
2961     chk_per_thread_free_list_and_count(jt, ls, &amp;error_cnt);
2962   }
2963 
2964   if (error_cnt == 0) {
2965     ls-&gt;print_cr(&quot;No errors found in monitor list checks.&quot;);
2966   } else {
2967     log_error(monitorinflation)(&quot;found monitor list errors: error_cnt=%d&quot;, error_cnt);
2968   }
2969 
2970   if ((on_exit &amp;&amp; log_is_enabled(Info, monitorinflation)) ||
2971       (!on_exit &amp;&amp; log_is_enabled(Trace, monitorinflation))) {
2972     // When exiting this log output is at the Info level. When called
2973     // at a safepoint, this log output is at the Trace level since
2974     // there can be a lot of it.
2975     log_in_use_monitor_details(ls);
2976   }
2977 
2978   ls-&gt;flush();
2979 
2980   guarantee(error_cnt == 0, &quot;ERROR: found monitor list errors: error_cnt=%d&quot;, error_cnt);
2981 }
2982 
2983 // Check a free monitor entry; log any errors.
2984 void ObjectSynchronizer::chk_free_entry(JavaThread* jt, ObjectMonitor* n,
2985                                         outputStream * out, int *error_cnt_p) {
2986   stringStream ss;
2987   if (n-&gt;is_busy()) {
2988     if (jt != NULL) {
2989       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
2990                     &quot;: free per-thread monitor must not be busy: %s&quot;, p2i(jt),
2991                     p2i(n), n-&gt;is_busy_to_string(&amp;ss));
2992     } else {
2993       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
2994                     &quot;must not be busy: %s&quot;, p2i(n), n-&gt;is_busy_to_string(&amp;ss));
2995     }
2996     *error_cnt_p = *error_cnt_p + 1;
2997   }
2998   if (n-&gt;header().value() != 0) {
2999     if (jt != NULL) {
3000       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3001                     &quot;: free per-thread monitor must have NULL _header &quot;
3002                     &quot;field: _header=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
3003                     n-&gt;header().value());
3004       *error_cnt_p = *error_cnt_p + 1;
3005     } else if (!AsyncDeflateIdleMonitors) {
3006       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
3007                     &quot;must have NULL _header field: _header=&quot; INTPTR_FORMAT,
3008                     p2i(n), n-&gt;header().value());
3009       *error_cnt_p = *error_cnt_p + 1;
3010     }
3011   }
3012   if (n-&gt;object() != NULL) {
3013     if (jt != NULL) {
3014       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3015                     &quot;: free per-thread monitor must have NULL _object &quot;
3016                     &quot;field: _object=&quot; INTPTR_FORMAT, p2i(jt), p2i(n),
3017                     p2i(n-&gt;object()));
3018     } else {
3019       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: free global monitor &quot;
3020                     &quot;must have NULL _object field: _object=&quot; INTPTR_FORMAT,
3021                     p2i(n), p2i(n-&gt;object()));
3022     }
3023     *error_cnt_p = *error_cnt_p + 1;
3024   }
3025 }
3026 
3027 // Lock the next ObjectMonitor for traversal and unlock the current
3028 // ObjectMonitor. Returns the next ObjectMonitor if there is one.
3029 // Otherwise returns NULL (after unlocking the current ObjectMonitor).
3030 // This function is used by the various list walker functions to
3031 // safely walk a list without allowing an ObjectMonitor to be moved
3032 // to another list in the middle of a walk.
3033 static ObjectMonitor* lock_next_for_traversal(ObjectMonitor* cur) {
3034   assert(is_locked(cur), &quot;cur=&quot; INTPTR_FORMAT &quot; must be locked&quot;, p2i(cur));
3035   ObjectMonitor* next = unmarked_next(cur);
3036   if (next == NULL) {  // Reached the end of the list.
3037     om_unlock(cur);
3038     return NULL;
3039   }
3040   om_lock(next);   // Lock next before unlocking current to keep
3041   om_unlock(cur);  // from being by-passed by another thread.
3042   return next;
3043 }
3044 
3045 // Check the global free list and count; log the results of the checks.
3046 void ObjectSynchronizer::chk_global_free_list_and_count(outputStream * out,
3047                                                         int *error_cnt_p) {
3048   int chk_om_free_count = 0;
3049   ObjectMonitor* cur = NULL;
3050   if ((cur = get_list_head_locked(&amp;om_list_globals._free_list)) != NULL) {
3051     // Marked the global free list head so process the list.
3052     while (true) {
3053       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
3054       chk_om_free_count++;
3055 
3056       cur = lock_next_for_traversal(cur);
3057       if (cur == NULL) {
3058         break;
3059       }
3060     }
3061   }
3062   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
3063   if (l_free_count == chk_om_free_count) {
3064     out-&gt;print_cr(&quot;global_free_count=%d equals chk_om_free_count=%d&quot;,
3065                   l_free_count, chk_om_free_count);
3066   } else {
3067     // With fine grained locks on om_list_globals._free_list, it
3068     // is possible for an ObjectMonitor to be prepended to
3069     // om_list_globals._free_list after we started calculating
3070     // chk_om_free_count so om_list_globals._free_count may not
3071     // match anymore.
3072     out-&gt;print_cr(&quot;WARNING: global_free_count=%d is not equal to &quot;
3073                   &quot;chk_om_free_count=%d&quot;, l_free_count, chk_om_free_count);
3074   }
3075 }
3076 
3077 // Check the global wait list and count; log the results of the checks.
3078 void ObjectSynchronizer::chk_global_wait_list_and_count(outputStream * out,
3079                                                         int *error_cnt_p) {
3080   int chk_om_wait_count = 0;
3081   ObjectMonitor* cur = NULL;
3082   if ((cur = get_list_head_locked(&amp;om_list_globals._wait_list)) != NULL) {
3083     // Marked the global wait list head so process the list.
3084     while (true) {
3085       // Rules for om_list_globals._wait_list are the same as for
3086       // om_list_globals._free_list:
3087       chk_free_entry(NULL /* jt */, cur, out, error_cnt_p);
3088       chk_om_wait_count++;
3089 
3090       cur = lock_next_for_traversal(cur);
3091       if (cur == NULL) {
3092         break;
3093       }
3094     }
3095   }
3096   if (Atomic::load(&amp;om_list_globals._wait_count) == chk_om_wait_count) {
3097     out-&gt;print_cr(&quot;global_wait_count=%d equals chk_om_wait_count=%d&quot;,
3098                   Atomic::load(&amp;om_list_globals._wait_count), chk_om_wait_count);
3099   } else {
3100     out-&gt;print_cr(&quot;ERROR: global_wait_count=%d is not equal to &quot;
3101                   &quot;chk_om_wait_count=%d&quot;,
3102                   Atomic::load(&amp;om_list_globals._wait_count), chk_om_wait_count);
3103     *error_cnt_p = *error_cnt_p + 1;
3104   }
3105 }
3106 
3107 // Check the global in-use list and count; log the results of the checks.
3108 void ObjectSynchronizer::chk_global_in_use_list_and_count(outputStream * out,
3109                                                           int *error_cnt_p) {
3110   int chk_om_in_use_count = 0;
3111   ObjectMonitor* cur = NULL;
3112   if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
3113     // Marked the global in-use list head so process the list.
3114     while (true) {
3115       chk_in_use_entry(NULL /* jt */, cur, out, error_cnt_p);
3116       chk_om_in_use_count++;
3117 
3118       cur = lock_next_for_traversal(cur);
3119       if (cur == NULL) {
3120         break;
3121       }
3122     }
3123   }
3124   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
3125   if (l_in_use_count == chk_om_in_use_count) {
3126     out-&gt;print_cr(&quot;global_in_use_count=%d equals chk_om_in_use_count=%d&quot;,
3127                   l_in_use_count, chk_om_in_use_count);
3128   } else {
3129     // With fine grained locks on the monitor lists, it is possible for
3130     // an exiting JavaThread to put its in-use ObjectMonitors on the
3131     // global in-use list after chk_om_in_use_count is calculated above.
3132     out-&gt;print_cr(&quot;WARNING: global_in_use_count=%d is not equal to chk_om_in_use_count=%d&quot;,
3133                   l_in_use_count, chk_om_in_use_count);
3134   }
3135 }
3136 
3137 // Check an in-use monitor entry; log any errors.
3138 void ObjectSynchronizer::chk_in_use_entry(JavaThread* jt, ObjectMonitor* n,
3139                                           outputStream * out, int *error_cnt_p) {
3140   if (n-&gt;header().value() == 0) {
3141     if (jt != NULL) {
3142       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3143                     &quot;: in-use per-thread monitor must have non-NULL _header &quot;
3144                     &quot;field.&quot;, p2i(jt), p2i(n));
3145     } else {
3146       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
3147                     &quot;must have non-NULL _header field.&quot;, p2i(n));
3148     }
3149     *error_cnt_p = *error_cnt_p + 1;
3150   }
3151   if (n-&gt;object() == NULL) {
3152     if (jt != NULL) {
3153       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3154                     &quot;: in-use per-thread monitor must have non-NULL _object &quot;
3155                     &quot;field.&quot;, p2i(jt), p2i(n));
3156     } else {
3157       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global monitor &quot;
3158                     &quot;must have non-NULL _object field.&quot;, p2i(n));
3159     }
3160     *error_cnt_p = *error_cnt_p + 1;
3161   }
3162   const oop obj = (oop)n-&gt;object();
3163   const markWord mark = obj-&gt;mark();
3164   if (!mark.has_monitor()) {
3165     if (jt != NULL) {
3166       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3167                     &quot;: in-use per-thread monitor&#39;s object does not think &quot;
3168                     &quot;it has a monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
3169                     INTPTR_FORMAT,  p2i(jt), p2i(n), p2i(obj), mark.value());
3170     } else {
3171       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
3172                     &quot;monitor&#39;s object does not think it has a monitor: obj=&quot;
3173                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT, p2i(n),
3174                     p2i(obj), mark.value());
3175     }
3176     *error_cnt_p = *error_cnt_p + 1;
3177   }
3178   ObjectMonitor* const obj_mon = mark.monitor();
3179   if (n != obj_mon) {
3180     if (jt != NULL) {
3181       out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;, monitor=&quot; INTPTR_FORMAT
3182                     &quot;: in-use per-thread monitor&#39;s object does not refer &quot;
3183                     &quot;to the same monitor: obj=&quot; INTPTR_FORMAT &quot;, mark=&quot;
3184                     INTPTR_FORMAT &quot;, obj_mon=&quot; INTPTR_FORMAT, p2i(jt),
3185                     p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
3186     } else {
3187       out-&gt;print_cr(&quot;ERROR: monitor=&quot; INTPTR_FORMAT &quot;: in-use global &quot;
3188                     &quot;monitor&#39;s object does not refer to the same monitor: obj=&quot;
3189                     INTPTR_FORMAT &quot;, mark=&quot; INTPTR_FORMAT &quot;, obj_mon=&quot;
3190                     INTPTR_FORMAT, p2i(n), p2i(obj), mark.value(), p2i(obj_mon));
3191     }
3192     *error_cnt_p = *error_cnt_p + 1;
3193   }
3194 }
3195 
3196 // Check the thread&#39;s free list and count; log the results of the checks.
3197 void ObjectSynchronizer::chk_per_thread_free_list_and_count(JavaThread *jt,
3198                                                             outputStream * out,
3199                                                             int *error_cnt_p) {
3200   int chk_om_free_count = 0;
3201   ObjectMonitor* cur = NULL;
3202   if ((cur = get_list_head_locked(&amp;jt-&gt;om_free_list)) != NULL) {
3203     // Marked the per-thread free list head so process the list.
3204     while (true) {
3205       chk_free_entry(jt, cur, out, error_cnt_p);
3206       chk_om_free_count++;
3207 
3208       cur = lock_next_for_traversal(cur);
3209       if (cur == NULL) {
3210         break;
3211       }
3212     }
3213   }
3214   int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
3215   if (l_om_free_count == chk_om_free_count) {
3216     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d equals &quot;
3217                   &quot;chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count, chk_om_free_count);
3218   } else {
3219     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_free_count=%d is not &quot;
3220                   &quot;equal to chk_om_free_count=%d&quot;, p2i(jt), l_om_free_count,
3221                   chk_om_free_count);
3222     *error_cnt_p = *error_cnt_p + 1;
3223   }
3224 }
3225 
3226 // Check the thread&#39;s in-use list and count; log the results of the checks.
3227 void ObjectSynchronizer::chk_per_thread_in_use_list_and_count(JavaThread *jt,
3228                                                               outputStream * out,
3229                                                               int *error_cnt_p) {
3230   int chk_om_in_use_count = 0;
3231   ObjectMonitor* cur = NULL;
3232   if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
3233     // Marked the per-thread in-use list head so process the list.
3234     while (true) {
3235       chk_in_use_entry(jt, cur, out, error_cnt_p);
3236       chk_om_in_use_count++;
3237 
3238       cur = lock_next_for_traversal(cur);
3239       if (cur == NULL) {
3240         break;
3241       }
3242     }
3243   }
3244   int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
3245   if (l_om_in_use_count == chk_om_in_use_count) {
3246     out-&gt;print_cr(&quot;jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d equals &quot;
3247                   &quot;chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
3248                   chk_om_in_use_count);
3249   } else {
3250     out-&gt;print_cr(&quot;ERROR: jt=&quot; INTPTR_FORMAT &quot;: om_in_use_count=%d is not &quot;
3251                   &quot;equal to chk_om_in_use_count=%d&quot;, p2i(jt), l_om_in_use_count,
3252                   chk_om_in_use_count);
3253     *error_cnt_p = *error_cnt_p + 1;
3254   }
3255 }
3256 
3257 // Log details about ObjectMonitors on the in-use lists. The &#39;BHL&#39;
3258 // flags indicate why the entry is in-use, &#39;object&#39; and &#39;object type&#39;
3259 // indicate the associated object and its type.
3260 void ObjectSynchronizer::log_in_use_monitor_details(outputStream * out) {
3261   stringStream ss;
3262   if (Atomic::load(&amp;om_list_globals._in_use_count) &gt; 0) {
3263     out-&gt;print_cr(&quot;In-use global monitor info:&quot;);
3264     out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
3265     out-&gt;print_cr(&quot;%18s  %s  %18s  %18s&quot;,
3266                   &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
3267     out-&gt;print_cr(&quot;==================  ===  ==================  ==================&quot;);
3268     ObjectMonitor* cur = NULL;
3269     if ((cur = get_list_head_locked(&amp;om_list_globals._in_use_list)) != NULL) {
3270       // Marked the global in-use list head so process the list.
3271       while (true) {
3272         const oop obj = (oop) cur-&gt;object();
3273         const markWord mark = cur-&gt;header();
3274         ResourceMark rm;
3275         out-&gt;print(INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT &quot;  %s&quot;, p2i(cur),
3276                    cur-&gt;is_busy() != 0, mark.hash() != 0, cur-&gt;owner() != NULL,
3277                    p2i(obj), obj-&gt;klass()-&gt;external_name());
3278         if (cur-&gt;is_busy() != 0) {
3279           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
3280           ss.reset();
3281         }
3282         out-&gt;cr();
3283 
3284         cur = lock_next_for_traversal(cur);
3285         if (cur == NULL) {
3286           break;
3287         }
3288       }
3289     }
3290   }
3291 
3292   out-&gt;print_cr(&quot;In-use per-thread monitor info:&quot;);
3293   out-&gt;print_cr(&quot;(B -&gt; is_busy, H -&gt; has hash code, L -&gt; lock status)&quot;);
3294   out-&gt;print_cr(&quot;%18s  %18s  %s  %18s  %18s&quot;,
3295                 &quot;jt&quot;, &quot;monitor&quot;, &quot;BHL&quot;, &quot;object&quot;, &quot;object type&quot;);
3296   out-&gt;print_cr(&quot;==================  ==================  ===  ==================  ==================&quot;);
3297   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
3298     ObjectMonitor* cur = NULL;
3299     if ((cur = get_list_head_locked(&amp;jt-&gt;om_in_use_list)) != NULL) {
3300       // Marked the global in-use list head so process the list.
3301       while (true) {
3302         const oop obj = (oop) cur-&gt;object();
3303         const markWord mark = cur-&gt;header();
3304         ResourceMark rm;
3305         out-&gt;print(INTPTR_FORMAT &quot;  &quot; INTPTR_FORMAT &quot;  %d%d%d  &quot; INTPTR_FORMAT
3306                    &quot;  %s&quot;, p2i(jt), p2i(cur), cur-&gt;is_busy() != 0,
3307                    mark.hash() != 0, cur-&gt;owner() != NULL, p2i(obj),
3308                    obj-&gt;klass()-&gt;external_name());
3309         if (cur-&gt;is_busy() != 0) {
3310           out-&gt;print(&quot; (%s)&quot;, cur-&gt;is_busy_to_string(&amp;ss));
3311           ss.reset();
3312         }
3313         out-&gt;cr();
3314 
3315         cur = lock_next_for_traversal(cur);
3316         if (cur == NULL) {
3317           break;
3318         }
3319       }
3320     }
3321   }
3322 
3323   out-&gt;flush();
3324 }
3325 
3326 // Log counts for the global and per-thread monitor lists and return
3327 // the population count.
3328 int ObjectSynchronizer::log_monitor_list_counts(outputStream * out) {
3329   int pop_count = 0;
3330   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s  %10s&quot;,
3331                 &quot;Global Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Wait&quot;, &quot;Total&quot;);
3332   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========  ==========&quot;);
3333   int l_in_use_count = Atomic::load(&amp;om_list_globals._in_use_count);
3334   int l_free_count = Atomic::load(&amp;om_list_globals._free_count);
3335   int l_wait_count = Atomic::load(&amp;om_list_globals._wait_count);
3336   out-&gt;print_cr(&quot;%18s  %10d  %10d  %10d  %10d&quot;, &quot;&quot;, l_in_use_count,
3337                 l_free_count, l_wait_count,
3338                 Atomic::load(&amp;om_list_globals._population));
3339   pop_count += l_in_use_count + l_free_count + l_wait_count;
3340 
3341   out-&gt;print_cr(&quot;%18s  %10s  %10s  %10s&quot;,
3342                 &quot;Per-Thread Lists:&quot;, &quot;InUse&quot;, &quot;Free&quot;, &quot;Provision&quot;);
3343   out-&gt;print_cr(&quot;==================  ==========  ==========  ==========&quot;);
3344 
3345   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
3346     int l_om_in_use_count = Atomic::load(&amp;jt-&gt;om_in_use_count);
3347     int l_om_free_count = Atomic::load(&amp;jt-&gt;om_free_count);
3348     out-&gt;print_cr(INTPTR_FORMAT &quot;  %10d  %10d  %10d&quot;, p2i(jt),
3349                   l_om_in_use_count, l_om_free_count, jt-&gt;om_free_provision);
3350     pop_count += l_om_in_use_count + l_om_free_count;
3351   }
3352   return pop_count;
3353 }
3354 
3355 #ifndef PRODUCT
3356 
3357 // Check if monitor belongs to the monitor cache
3358 // The list is grow-only so it&#39;s *relatively* safe to traverse
3359 // the list of extant blocks without taking a lock.
3360 
3361 int ObjectSynchronizer::verify_objmon_isinpool(ObjectMonitor *monitor) {
3362   PaddedObjectMonitor* block = Atomic::load(&amp;g_block_list);
3363   while (block != NULL) {
3364     assert(block-&gt;object() == CHAINMARKER, &quot;must be a block header&quot;);
3365     if (monitor &gt; &amp;block[0] &amp;&amp; monitor &lt; &amp;block[_BLOCKSIZE]) {
3366       address mon = (address)monitor;
3367       address blk = (address)block;
3368       size_t diff = mon - blk;
3369       assert((diff % sizeof(PaddedObjectMonitor)) == 0, &quot;must be aligned&quot;);
3370       return 1;
3371     }
3372     // unmarked_next() is not needed with g_block_list (no locking
3373     // used with block linkage _next_om fields).
3374     block = (PaddedObjectMonitor*)block-&gt;next_om();
3375   }
3376   return 0;
3377 }
3378 
3379 #endif
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>