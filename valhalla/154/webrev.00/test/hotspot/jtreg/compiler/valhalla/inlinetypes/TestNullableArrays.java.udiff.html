<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/hotspot/jtreg/compiler/valhalla/inlinetypes/TestNullableArrays.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="TestMethodHandles.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/hotspot/jtreg/compiler/valhalla/inlinetypes/TestNullableArrays.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -103,13 +103,11 @@</span>
              Asserts.assertEQ(va[i].hash(), hash());
          }
      }
  
      // Test creation of an inline type array and element access
<span class="udiff-line-modified-removed">-     @Test</span>
<span class="udiff-line-removed">-     // TODO 8227588</span>
<span class="udiff-line-removed">-     // @Test(failOn = ALLOC + ALLOCA + LOOP + LOAD + STORE + TRAP)</span>
<span class="udiff-line-modified-added">+     @Test(failOn = ALLOC + ALLOCA + LOOP + LOAD + STORE + TRAP)</span>
      public long test2() {
          MyValue1.ref[] va = new MyValue1.ref[1];
          va[0] = MyValue1.createWithFieldsInline(rI, rL);
          return va[0].hash();
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -607,17 +605,17 @@</span>
          MyValue2.ref[] dst1 = new MyValue2.ref[len];
          MyValue2[]  dst2 = new MyValue2[len];
          MyValue2.ref[] dst3 = new MyValue2.ref[len];
          MyValue2[]  dst4 = new MyValue2[len];
          if (len &gt; 0) {
<span class="udiff-line-modified-removed">-             src2[0] = MyValue2.createWithFieldsInline(rI, true);</span>
<span class="udiff-line-modified-added">+             src2[0] = MyValue2.createWithFieldsInline(rI, rD);</span>
          }
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src1[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-removed">-             src2[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-removed">-             src3[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-removed">-             src4[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src1[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
<span class="udiff-line-modified-added">+             src2[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
<span class="udiff-line-modified-added">+             src3[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
<span class="udiff-line-modified-added">+             src4[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test21(src1, dst1);
          test21(src2, dst2);
          test21(src3, dst3);
          test21(src4, dst4);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -753,16 +751,16 @@</span>
          MyValue2[]  src4 = new MyValue2[8];
          MyValue2.ref[] dst1 = new MyValue2.ref[8];
          MyValue2[]  dst2 = new MyValue2[8];
          MyValue2.ref[] dst3 = new MyValue2.ref[8];
          MyValue2[]  dst4 = new MyValue2[8];
<span class="udiff-line-modified-removed">-         src2[0] = MyValue2.createWithFieldsInline(rI, true);</span>
<span class="udiff-line-modified-added">+         src2[0] = MyValue2.createWithFieldsInline(rI, rD);</span>
          for (int i = 1; i &lt; 8; ++i) {
<span class="udiff-line-modified-removed">-             src1[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-removed">-             src2[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-removed">-             src3[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-removed">-             src4[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src1[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
<span class="udiff-line-modified-added">+             src2[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
<span class="udiff-line-modified-added">+             src3[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
<span class="udiff-line-modified-added">+             src4[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test25(src1, dst1);
          test25(src2, dst2);
          test25(src3, dst3);
          test25(src4, dst4);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -856,11 +854,11 @@</span>
              Asserts.assertEQ(src4[i].hash(), dst4[i].hash());
          }
      }
  
      // non escaping allocations
<span class="udiff-line-modified-removed">-     // TODO ZGC does not support the clone intrinsic, remove this once JDK-8232896 is fixed</span>
<span class="udiff-line-modified-added">+     // TODO 8252027: Make sure this is optimized with ZGC</span>
      @Test(valid = ZGCOff, failOn = ALLOC + ALLOCA + LOOP + LOAD + STORE + TRAP)
      @Test(valid = ZGCOn)
      public MyValue2.ref test28() {
          MyValue2.ref[] src = new MyValue2.ref[10];
          src[0] = null;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -868,11 +866,11 @@</span>
          return dst[0];
      }
  
      @DontCompile
      public void test28_verifier(boolean warmup) {
<span class="udiff-line-modified-removed">-         MyValue2 v = MyValue2.createWithFieldsInline(rI, false);</span>
<span class="udiff-line-modified-added">+         MyValue2 v = MyValue2.createWithFieldsInline(rI, rD);</span>
          MyValue2.ref result = test28();
          Asserts.assertEQ(result, null);
      }
  
      // non escaping allocations
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -887,12 +885,12 @@</span>
      @DontCompile
      public void test29_verifier(boolean warmup) {
          MyValue2.ref[] src1 = new MyValue2.ref[10];
          MyValue2.val[] src2 = new MyValue2.val[10];
          for (int i = 0; i &lt; 10; ++i) {
<span class="udiff-line-modified-removed">-             src1[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-removed">-             src2[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src1[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
<span class="udiff-line-modified-added">+             src2[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          MyValue2.ref v = test29(src1);
          Asserts.assertEQ(src1[0].hash(), v.hash());
          if (!warmup) {
              v = test29(src2);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -914,12 +912,12 @@</span>
      @DontCompile
      public void test30_verifier(boolean warmup) {
          MyValue2.ref[] src1 = new MyValue2.ref[10];
          MyValue2.val[] src2 = new MyValue2.val[10];
          for (int i = 0; i &lt; 10; ++i) {
<span class="udiff-line-modified-removed">-             src1[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-removed">-             src2[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src1[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
<span class="udiff-line-modified-added">+             src2[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          MyValue2.ref v = test30(src1, !warmup);
          Asserts.assertEQ(src1[0].hash(), v.hash());
          if (!warmup) {
              v = test30(src2, true);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -932,27 +930,27 @@</span>
      // TODO 8227588
      // @Test(failOn = ALLOC + ALLOCA + LOOP + LOAD + STORE + TRAP)
      public long test31(boolean b, boolean deopt) {
          MyValue2.ref[] src = new MyValue2.ref[1];
          if (b) {
<span class="udiff-line-modified-removed">-             src[0] = MyValue2.createWithFieldsInline(rI, true);</span>
<span class="udiff-line-modified-added">+             src[0] = MyValue2.createWithFieldsInline(rI, rD);</span>
          } else {
<span class="udiff-line-modified-removed">-             src[0] = MyValue2.createWithFieldsInline(rI, false);</span>
<span class="udiff-line-modified-added">+             src[0] = MyValue2.createWithFieldsInline(rI+1, rD+1);</span>
          }
          if (deopt) {
              // uncommon trap
              WHITE_BOX.deoptimizeMethod(tests.get(getClass().getSimpleName() + &quot;::test31&quot;));
          }
          return src[0].hash();
      }
  
      @DontCompile
      public void test31_verifier(boolean warmup) {
<span class="udiff-line-modified-removed">-         MyValue2 v1 = MyValue2.createWithFieldsInline(rI, true);</span>
<span class="udiff-line-modified-added">+         MyValue2 v1 = MyValue2.createWithFieldsInline(rI, rD);</span>
          long result1 = test31(true, !warmup);
          Asserts.assertEQ(result1, v1.hash());
<span class="udiff-line-modified-removed">-         MyValue2 v2 = MyValue2.createWithFieldsInline(rI, false);</span>
<span class="udiff-line-modified-added">+         MyValue2 v2 = MyValue2.createWithFieldsInline(rI+1, rD+1);</span>
          long result2 = test31(false, !warmup);
          Asserts.assertEQ(result2, v2.hash());
      }
  
      // Tests with Object arrays and clone/arraycopy
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1133,11 +1131,11 @@</span>
      public void test36_verifier(boolean warmup) {
          int len = Math.abs(rI) % 10;
          MyValue2.ref[] src = new MyValue2.ref[len];
          MyValue2.ref[] dst = new MyValue2.ref[len];
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test36(src, dst);
          verify(src, dst);
          if (compile_and_run_again_if_deoptimized(warmup, &quot;TestNullableArrays::test36&quot;)) {
              test36(src, dst);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1154,11 +1152,11 @@</span>
      public void test37_verifier(boolean warmup) {
          int len = Math.abs(rI) % 10;
          MyValue2.ref[] src = new MyValue2.ref[len];
          MyValue2.ref[] dst = new MyValue2.ref[len];
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test37(src, dst);
          verify(src, dst);
          if (compile_and_run_again_if_deoptimized(warmup, &quot;TestNullableArrays::test37&quot;)) {
              test37(src, dst);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1176,11 +1174,11 @@</span>
      public void test38_verifier(boolean warmup) {
          int len = Math.abs(rI) % 10;
          Object[] src = new Object[len];
          MyValue2.ref[] dst = new MyValue2.ref[len];
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test38(src, dst);
          verify(dst, src);
          if (!warmup) {
              Method m = tests.get(&quot;TestNullableArrays::test38&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1203,11 +1201,11 @@</span>
      public void test39_verifier(boolean warmup) {
          int len = Math.abs(rI) % 10;
          MyValue2.ref[] src = new MyValue2.ref[len];
          Object[] dst = new Object[len];
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test39(src, dst);
          verify(src, dst);
          if (compile_and_run_again_if_deoptimized(warmup, &quot;TestNullableArrays::test39&quot;)) {
              test39(src, dst);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1225,11 +1223,11 @@</span>
      public void test40_verifier(boolean warmup) {
          int len = Math.abs(rI) % 10;
          Object[] src = new Object[len];
          MyValue2.ref[] dst = new MyValue2.ref[len];
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test40(src, dst);
          verify(dst, src);
          if (!warmup) {
              Method m = tests.get(&quot;TestNullableArrays::test40&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1252,11 +1250,11 @@</span>
      public void test41_verifier(boolean warmup) {
          int len = Math.abs(rI) % 10;
          MyValue2.ref[] src = new MyValue2.ref[len];
          Object[] dst = new Object[len];
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test41(src, dst);
          verify(src, dst);
          if (compile_and_run_again_if_deoptimized(warmup, &quot;TestNullableArrays::test41&quot;)) {
              test41(src, dst);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1273,11 +1271,11 @@</span>
      public void test42_verifier(boolean warmup) {
          int len = Math.abs(rI) % 10;
          Object[] src = new Object[len];
          Object[] dst = new Object[len];
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test42(src, dst);
          verify(src, dst);
          if (!warmup) {
              Method m = tests.get(&quot;TestNullableArrays::test42&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1316,11 +1314,11 @@</span>
      @DontCompile
      public void test44_verifier(boolean warmup) {
          MyValue2.ref[] src = new MyValue2.ref[8];
          MyValue2.ref[] dst = new MyValue2.ref[8];
          for (int i = 1; i &lt; 8; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test44(src, dst);
          verify(src, dst);
          if (compile_and_run_again_if_deoptimized(warmup, &quot;TestNullableArrays::test44&quot;)) {
              test44(src, dst);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1336,11 +1334,11 @@</span>
      @DontCompile
      public void test45_verifier(boolean warmup) {
          MyValue2.ref[] src = new MyValue2.ref[8];
          MyValue2.ref[] dst = new MyValue2.ref[8];
          for (int i = 1; i &lt; 8; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test45(src, dst);
          verify(src, dst);
          if (compile_and_run_again_if_deoptimized(warmup, &quot;TestNullableArrays::test45&quot;)) {
              test45(src, dst);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1357,11 +1355,11 @@</span>
      @DontCompile
      public void test46_verifier(boolean warmup) {
          Object[] src = new Object[8];
          MyValue2.ref[] dst = new MyValue2.ref[8];
          for (int i = 1; i &lt; 8; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test46(src, dst);
          verify(dst, src);
          if (!warmup) {
              Method m = tests.get(&quot;TestNullableArrays::test46&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1383,11 +1381,11 @@</span>
      @DontCompile
      public void test47_verifier(boolean warmup) {
          MyValue2.ref[] src = new MyValue2.ref[8];
          Object[] dst = new Object[8];
          for (int i = 1; i &lt; 8; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test47(src, dst);
          verify(src, dst);
          if (compile_and_run_again_if_deoptimized(warmup, &quot;TestNullableArrays::test47&quot;)) {
              test47(src, dst);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1404,11 +1402,11 @@</span>
      @DontCompile
      public void test48_verifier(boolean warmup) {
          Object[] src = new Object[8];
          MyValue2.ref[] dst = new MyValue2.ref[8];
          for (int i = 1; i &lt; 8; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test48(src, dst);
          verify(dst, src);
          if (!warmup) {
              Method m = tests.get(&quot;TestNullableArrays::test48&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1430,11 +1428,11 @@</span>
      @DontCompile
      public void test49_verifier(boolean warmup) {
          MyValue2.ref[] src = new MyValue2.ref[8];
          Object[] dst = new Object[8];
          for (int i = 1; i &lt; 8; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test49(src, dst);
          verify(src, dst);
          if (compile_and_run_again_if_deoptimized(warmup, &quot;TestNullableArrays::test49&quot;)) {
              test49(src, dst);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1450,11 +1448,11 @@</span>
      @DontCompile
      public void test50_verifier(boolean warmup) {
          Object[] src = new Object[8];
          Object[] dst = new Object[8];
          for (int i = 1; i &lt; 8; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsInline(rI+i, rD+i);</span>
          }
          test50(src, dst);
          verify(src, dst);
          if (!warmup) {
              Method m = tests.get(&quot;TestNullableArrays::test50&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1846,11 +1844,11 @@</span>
      public void test71() {
          int len = 10;
          MyValue2.ref[] src = new MyValue2.ref[len];
          MyValue2.ref[] dst = new MyValue2.ref[len];
          for (int i = 1; i &lt; len; ++i) {
<span class="udiff-line-modified-removed">-             src[i] = MyValue2.createWithFieldsDontInline(rI, (i % 2) == 0);</span>
<span class="udiff-line-modified-added">+             src[i] = MyValue2.createWithFieldsDontInline(rI+i, rD+i);</span>
          }
          System.arraycopy(src, 0, dst, 0, src.length);
          for (int i = 0; i &lt; len; ++i) {
              if (src[i] == null) {
                  Asserts.assertEQ(dst[i], null);
</pre>
<center><a href="TestMethodHandles.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>