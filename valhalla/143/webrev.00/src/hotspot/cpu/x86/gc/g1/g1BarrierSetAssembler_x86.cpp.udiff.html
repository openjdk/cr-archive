<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/cpu/x86/gc/g1/g1BarrierSetAssembler_x86.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/hotspot/cpu/x86/gc/g1/g1BarrierSetAssembler_x86.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -200,14 +200,22 @@</span>
    // Record the previous value
    __ movptr(Address(tmp, 0), pre_val);
    __ jmp(done);
  
    __ bind(runtime);
<span class="udiff-line-removed">-   // FIXME</span>
    // Barriers might be emitted when converting between (scalarized) calling conventions for inline
<span class="udiff-line-modified-removed">-   // types. Save all registers until JDK-8232094 is fixed to avoid overwriting argument registers.</span>
<span class="udiff-line-modified-added">+   // types. Save all argument registers before calling into the runtime.</span>
    __ pusha();
<span class="udiff-line-added">+   __ subptr(rsp, 64);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 0),  j_farg0);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 8),  j_farg1);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 16), j_farg2);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 24), j_farg3);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 32), j_farg4);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 40), j_farg5);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 48), j_farg6);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 56), j_farg7);</span>
  
    // Calling the runtime using the regular call_VM_leaf mechanism generates
    // code (generated by InterpreterMacroAssember::call_VM_leaf_base)
    // that checks that the *(ebp+frame::interpreter_frame_last_sp) == NULL.
    //
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -235,11 +243,22 @@</span>
      __ MacroAssembler::call_VM_leaf_base(CAST_FROM_FN_PTR(address, G1BarrierSetRuntime::write_ref_field_pre_entry), 2);
    } else {
      __ call_VM_leaf(CAST_FROM_FN_PTR(address, G1BarrierSetRuntime::write_ref_field_pre_entry), pre_val, thread);
    }
  
<span class="udiff-line-added">+   // Restore registers</span>
<span class="udiff-line-added">+   __ movdbl(j_farg0, Address(rsp, 0));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg1, Address(rsp, 8));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg2, Address(rsp, 16));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg3, Address(rsp, 24));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg4, Address(rsp, 32));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg5, Address(rsp, 40));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg6, Address(rsp, 48));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg7, Address(rsp, 56));</span>
<span class="udiff-line-added">+   __ addptr(rsp, 64);</span>
    __ popa();
<span class="udiff-line-added">+ </span>
    __ bind(done);
  }
  
  void G1BarrierSetAssembler::g1_write_barrier_post(MacroAssembler* masm,
                                                    Register store_addr,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -310,24 +329,43 @@</span>
    __ movl(Address(tmp2, 0), card_addr);
  #endif
    __ jmp(done);
  
    __ bind(runtime);
<span class="udiff-line-removed">-   // FIXME</span>
    // Barriers might be emitted when converting between (scalarized) calling conventions for inline
<span class="udiff-line-modified-removed">-   // types. Save all registers until JDK-8232094 is fixed to avoid overwriting argument registers.</span>
<span class="udiff-line-modified-added">+   // types. Save all argument registers before calling into the runtime.</span>
    __ pusha();
<span class="udiff-line-added">+   __ subptr(rsp, 64);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 0),  j_farg0);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 8),  j_farg1);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 16), j_farg2);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 24), j_farg3);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 32), j_farg4);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 40), j_farg5);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 48), j_farg6);</span>
<span class="udiff-line-added">+   __ movdbl(Address(rsp, 56), j_farg7);</span>
  
  #ifdef _LP64
    __ call_VM_leaf(CAST_FROM_FN_PTR(address, G1BarrierSetRuntime::write_ref_field_post_entry), card_addr, r15_thread);
  #else
    __ push(thread);
    __ call_VM_leaf(CAST_FROM_FN_PTR(address, G1BarrierSetRuntime::write_ref_field_post_entry), card_addr, thread);
    __ pop(thread);
  #endif
  
<span class="udiff-line-added">+   // Restore registers</span>
<span class="udiff-line-added">+   __ movdbl(j_farg0, Address(rsp, 0));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg1, Address(rsp, 8));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg2, Address(rsp, 16));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg3, Address(rsp, 24));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg4, Address(rsp, 32));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg5, Address(rsp, 40));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg6, Address(rsp, 48));</span>
<span class="udiff-line-added">+   __ movdbl(j_farg7, Address(rsp, 56));</span>
<span class="udiff-line-added">+   __ addptr(rsp, 64);</span>
    __ popa();
<span class="udiff-line-added">+ </span>
    __ bind(done);
  }
  
  void G1BarrierSetAssembler::oop_store_at(MacroAssembler* masm, DecoratorSet decorators, BasicType type,
                                           Address dst, Register val, Register tmp1, Register tmp2, Register tmp3) {
</pre>
<center>&lt; prev <a href="../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>