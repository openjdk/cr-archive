<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/prims/jvmtiEnvBase.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/moduleEntry.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  30 #include &quot;memory/iterator.hpp&quot;
  31 #include &quot;memory/resourceArea.hpp&quot;
  32 #include &quot;oops/objArrayKlass.hpp&quot;
  33 #include &quot;oops/objArrayOop.hpp&quot;
  34 #include &quot;oops/oop.inline.hpp&quot;
  35 #include &quot;oops/oopHandle.inline.hpp&quot;
  36 #include &quot;prims/jvmtiEnvBase.hpp&quot;
  37 #include &quot;prims/jvmtiEventController.inline.hpp&quot;
  38 #include &quot;prims/jvmtiExtensions.hpp&quot;
  39 #include &quot;prims/jvmtiImpl.hpp&quot;
  40 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  41 #include &quot;prims/jvmtiTagMap.hpp&quot;
  42 #include &quot;prims/jvmtiThreadState.inline.hpp&quot;
  43 #include &quot;runtime/biasedLocking.hpp&quot;
  44 #include &quot;runtime/deoptimization.hpp&quot;
  45 #include &quot;runtime/frame.inline.hpp&quot;
  46 #include &quot;runtime/handles.inline.hpp&quot;
  47 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  48 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  49 #include &quot;runtime/jniHandles.inline.hpp&quot;
  50 #include &quot;runtime/objectMonitor.hpp&quot;
  51 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  52 #include &quot;runtime/signature.hpp&quot;
  53 #include &quot;runtime/thread.inline.hpp&quot;
  54 #include &quot;runtime/threadSMR.hpp&quot;
  55 #include &quot;runtime/vframe.hpp&quot;
  56 #include &quot;runtime/vframe_hp.hpp&quot;
  57 #include &quot;runtime/vmThread.hpp&quot;
  58 #include &quot;runtime/vmOperations.hpp&quot;
  59 
  60 ///////////////////////////////////////////////////////////////
  61 //
  62 // JvmtiEnvBase
  63 //
  64 
  65 JvmtiEnvBase* JvmtiEnvBase::_head_environment = NULL;
  66 
  67 bool JvmtiEnvBase::_globally_initialized = false;
  68 volatile bool JvmtiEnvBase::_needs_clean_up = false;
  69 
  70 jvmtiPhase JvmtiEnvBase::_phase = JVMTI_PHASE_PRIMORDIAL;
  71 
  72 volatile int JvmtiEnvBase::_dying_thread_env_iteration_count = 0;
  73 
  74 extern jvmtiInterface_1_ jvmti_Interface;
  75 extern jvmtiInterface_1_ jvmtiTrace_Interface;
  76 
  77 
  78 // perform initializations that must occur before any JVMTI environments
  79 // are released but which should only be initialized once (no matter
  80 // how many environments are created).
  81 void
  82 JvmtiEnvBase::globally_initialize() {
  83   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
  84   assert(_globally_initialized == false, &quot;bad call&quot;);
  85 
  86   JvmtiManageCapabilities::initialize();
  87 
  88   // register extension functions and events
  89   JvmtiExtensions::register_extensions();
  90 
  91 #ifdef JVMTI_TRACE
  92   JvmtiTrace::initialize();
  93 #endif
  94 
  95   _globally_initialized = true;
  96 }
  97 
  98 
  99 void
 100 JvmtiEnvBase::initialize() {
 101   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 102 
 103   // Add this environment to the end of the environment list (order is important)
 104   {
 105     // This block of code must not contain any safepoints, as list deallocation
 106     // (which occurs at a safepoint) cannot occur simultaneously with this list
 107     // addition.  Note: NoSafepointVerifier cannot, currently, be used before
 108     // threads exist.
 109     JvmtiEnvIterator it;
 110     JvmtiEnvBase *previous_env = NULL;
 111     for (JvmtiEnvBase* env = it.first(); env != NULL; env = it.next(env)) {
 112       previous_env = env;
 113     }
 114     if (previous_env == NULL) {
 115       _head_environment = this;
 116     } else {
 117       previous_env-&gt;set_next_environment(this);
 118     }
 119   }
 120 
 121   if (_globally_initialized == false) {
 122     globally_initialize();
 123   }
 124 }
 125 
 126 jvmtiPhase
 127 JvmtiEnvBase::phase() {
 128   // For the JVMTI environments possessed the can_generate_early_vmstart:
 129   //   replace JVMTI_PHASE_PRIMORDIAL with JVMTI_PHASE_START
 130   if (_phase == JVMTI_PHASE_PRIMORDIAL &amp;&amp;
 131       JvmtiExport::early_vmstart_recorded() &amp;&amp;
 132       early_vmstart_env()) {
 133     return JVMTI_PHASE_START;
 134   }
 135   return _phase; // Normal case
 136 }
 137 
 138 bool
 139 JvmtiEnvBase::is_valid() {
 140   jint value = 0;
 141 
 142   // This object might not be a JvmtiEnvBase so we can&#39;t assume
 143   // the _magic field is properly aligned. Get the value in a safe
 144   // way and then check against JVMTI_MAGIC.
 145 
 146   switch (sizeof(_magic)) {
 147   case 2:
 148     value = Bytes::get_native_u2((address)&amp;_magic);
 149     break;
 150 
 151   case 4:
 152     value = Bytes::get_native_u4((address)&amp;_magic);
 153     break;
 154 
 155   case 8:
 156     value = Bytes::get_native_u8((address)&amp;_magic);
 157     break;
 158 
 159   default:
 160     guarantee(false, &quot;_magic field is an unexpected size&quot;);
 161   }
 162 
 163   return value == JVMTI_MAGIC;
 164 }
 165 
 166 
 167 bool
 168 JvmtiEnvBase::use_version_1_0_semantics() {
 169   int major, minor, micro;
 170 
 171   JvmtiExport::decode_version_values(_version, &amp;major, &amp;minor, &amp;micro);
 172   return major == 1 &amp;&amp; minor == 0;  // micro version doesn&#39;t matter here
 173 }
 174 
 175 
 176 bool
 177 JvmtiEnvBase::use_version_1_1_semantics() {
 178   int major, minor, micro;
 179 
 180   JvmtiExport::decode_version_values(_version, &amp;major, &amp;minor, &amp;micro);
 181   return major == 1 &amp;&amp; minor == 1;  // micro version doesn&#39;t matter here
 182 }
 183 
 184 bool
 185 JvmtiEnvBase::use_version_1_2_semantics() {
 186   int major, minor, micro;
 187 
 188   JvmtiExport::decode_version_values(_version, &amp;major, &amp;minor, &amp;micro);
 189   return major == 1 &amp;&amp; minor == 2;  // micro version doesn&#39;t matter here
 190 }
 191 
 192 
 193 JvmtiEnvBase::JvmtiEnvBase(jint version) : _env_event_enable() {
 194   _version = version;
 195   _env_local_storage = NULL;
 196   _tag_map = NULL;
 197   _native_method_prefix_count = 0;
 198   _native_method_prefixes = NULL;
 199   _next = NULL;
 200   _class_file_load_hook_ever_enabled = false;
 201 
 202   // Moot since ClassFileLoadHook not yet enabled.
 203   // But &quot;true&quot; will give a more predictable ClassFileLoadHook behavior
 204   // for environment creation during ClassFileLoadHook.
 205   _is_retransformable = true;
 206 
 207   // all callbacks initially NULL
 208   memset(&amp;_event_callbacks,0,sizeof(jvmtiEventCallbacks));
 209 
 210   // all capabilities initially off
 211   memset(&amp;_current_capabilities, 0, sizeof(_current_capabilities));
 212 
 213   // all prohibited capabilities initially off
 214   memset(&amp;_prohibited_capabilities, 0, sizeof(_prohibited_capabilities));
 215 
 216   _magic = JVMTI_MAGIC;
 217 
 218   JvmtiEventController::env_initialize((JvmtiEnv*)this);
 219 
 220 #ifdef JVMTI_TRACE
 221   _jvmti_external.functions = TraceJVMTI != NULL ? &amp;jvmtiTrace_Interface : &amp;jvmti_Interface;
 222 #else
 223   _jvmti_external.functions = &amp;jvmti_Interface;
 224 #endif
 225 }
 226 
 227 
 228 void
 229 JvmtiEnvBase::dispose() {
 230 
 231 #ifdef JVMTI_TRACE
 232   JvmtiTrace::shutdown();
 233 #endif
 234 
 235   // Dispose of event info and let the event controller call us back
 236   // in a locked state (env_dispose, below)
 237   JvmtiEventController::env_dispose(this);
 238 }
 239 
 240 void
 241 JvmtiEnvBase::env_dispose() {
 242   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 243 
 244   // We have been entered with all events disabled on this environment.
 245   // A race to re-enable events (by setting callbacks) is prevented by
 246   // checking for a valid environment when setting callbacks (while
 247   // holding the JvmtiThreadState_lock).
 248 
 249   // Mark as invalid.
 250   _magic = DISPOSED_MAGIC;
 251 
 252   // Relinquish all capabilities.
 253   jvmtiCapabilities *caps = get_capabilities();
 254   JvmtiManageCapabilities::relinquish_capabilities(caps, caps, caps);
 255 
 256   // Same situation as with events (see above)
 257   set_native_method_prefixes(0, NULL);
 258 
 259   JvmtiTagMap* tag_map_to_deallocate = _tag_map;
 260   set_tag_map(NULL);
 261   // A tag map can be big, deallocate it now
 262   if (tag_map_to_deallocate != NULL) {
 263     delete tag_map_to_deallocate;
 264   }
 265 
 266   _needs_clean_up = true;
 267 }
 268 
 269 
 270 JvmtiEnvBase::~JvmtiEnvBase() {
 271   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
 272 
 273   // There is a small window of time during which the tag map of a
 274   // disposed environment could have been reallocated.
 275   // Make sure it is gone.
 276   JvmtiTagMap* tag_map_to_deallocate = _tag_map;
 277   set_tag_map(NULL);
 278   // A tag map can be big, deallocate it now
 279   if (tag_map_to_deallocate != NULL) {
 280     delete tag_map_to_deallocate;
 281   }
 282 
 283   _magic = BAD_MAGIC;
 284 }
 285 
 286 
 287 void
 288 JvmtiEnvBase::periodic_clean_up() {
 289   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
 290 
 291   // JvmtiEnvBase reference is saved in JvmtiEnvThreadState. So
 292   // clean up JvmtiThreadState before deleting JvmtiEnv pointer.
 293   JvmtiThreadState::periodic_clean_up();
 294 
 295   // Unlink all invalid environments from the list of environments
 296   // and deallocate them
 297   JvmtiEnvIterator it;
 298   JvmtiEnvBase* previous_env = NULL;
 299   JvmtiEnvBase* env = it.first();
 300   while (env != NULL) {
 301     if (env-&gt;is_valid()) {
 302       previous_env = env;
 303       env = it.next(env);
 304     } else {
 305       // This one isn&#39;t valid, remove it from the list and deallocate it
 306       JvmtiEnvBase* defunct_env = env;
 307       env = it.next(env);
 308       if (previous_env == NULL) {
 309         _head_environment = env;
 310       } else {
 311         previous_env-&gt;set_next_environment(env);
 312       }
 313       delete defunct_env;
 314     }
 315   }
 316 
 317 }
 318 
 319 
 320 void
 321 JvmtiEnvBase::check_for_periodic_clean_up() {
 322   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
 323 
 324   class ThreadInsideIterationClosure: public ThreadClosure {
 325    private:
 326     bool _inside;
 327    public:
 328     ThreadInsideIterationClosure() : _inside(false) {};
 329 
 330     void do_thread(Thread* thread) {
 331       _inside |= thread-&gt;is_inside_jvmti_env_iteration();
 332     }
 333 
 334     bool is_inside_jvmti_env_iteration() {
 335       return _inside;
 336     }
 337   };
 338 
 339   if (_needs_clean_up) {
 340     // Check if we are currently iterating environment,
 341     // deallocation should not occur if we are
 342     ThreadInsideIterationClosure tiic;
 343     Threads::threads_do(&amp;tiic);
 344     if (!tiic.is_inside_jvmti_env_iteration() &amp;&amp;
 345              !is_inside_dying_thread_env_iteration()) {
 346       _needs_clean_up = false;
 347       JvmtiEnvBase::periodic_clean_up();
 348     }
 349   }
 350 }
 351 
 352 
 353 void
 354 JvmtiEnvBase::record_first_time_class_file_load_hook_enabled() {
 355   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(),
 356          &quot;sanity check&quot;);
 357 
 358   if (!_class_file_load_hook_ever_enabled) {
 359     _class_file_load_hook_ever_enabled = true;
 360 
 361     if (get_capabilities()-&gt;can_retransform_classes) {
 362       _is_retransformable = true;
 363     } else {
 364       _is_retransformable = false;
 365 
 366       // cannot add retransform capability after ClassFileLoadHook has been enabled
 367       get_prohibited_capabilities()-&gt;can_retransform_classes = 1;
 368     }
 369   }
 370 }
 371 
 372 
 373 void
 374 JvmtiEnvBase::record_class_file_load_hook_enabled() {
 375   if (!_class_file_load_hook_ever_enabled) {
 376     if (Threads::number_of_threads() == 0) {
 377       record_first_time_class_file_load_hook_enabled();
 378     } else {
 379       MutexLocker mu(JvmtiThreadState_lock);
 380       record_first_time_class_file_load_hook_enabled();
 381     }
 382   }
 383 }
 384 
 385 
 386 jvmtiError
 387 JvmtiEnvBase::set_native_method_prefixes(jint prefix_count, char** prefixes) {
 388   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(),
 389          &quot;sanity check&quot;);
 390 
 391   int old_prefix_count = get_native_method_prefix_count();
 392   char **old_prefixes = get_native_method_prefixes();
 393 
 394   // allocate and install the new prefixex
 395   if (prefix_count == 0 || !is_valid()) {
 396     _native_method_prefix_count = 0;
 397     _native_method_prefixes = NULL;
 398   } else {
 399     // there are prefixes, allocate an array to hold them, and fill it
 400     char** new_prefixes = (char**)os::malloc((prefix_count) * sizeof(char*), mtInternal);
 401     if (new_prefixes == NULL) {
 402       return JVMTI_ERROR_OUT_OF_MEMORY;
 403     }
 404     for (int i = 0; i &lt; prefix_count; i++) {
 405       char* prefix = prefixes[i];
 406       if (prefix == NULL) {
 407         for (int j = 0; j &lt; (i-1); j++) {
 408           os::free(new_prefixes[j]);
 409         }
 410         os::free(new_prefixes);
 411         return JVMTI_ERROR_NULL_POINTER;
 412       }
 413       prefix = os::strdup(prefixes[i]);
 414       if (prefix == NULL) {
 415         for (int j = 0; j &lt; (i-1); j++) {
 416           os::free(new_prefixes[j]);
 417         }
 418         os::free(new_prefixes);
 419         return JVMTI_ERROR_OUT_OF_MEMORY;
 420       }
 421       new_prefixes[i] = prefix;
 422     }
 423     _native_method_prefix_count = prefix_count;
 424     _native_method_prefixes = new_prefixes;
 425   }
 426 
 427   // now that we know the new prefixes have been successfully installed we can
 428   // safely remove the old ones
 429   if (old_prefix_count != 0) {
 430     for (int i = 0; i &lt; old_prefix_count; i++) {
 431       os::free(old_prefixes[i]);
 432     }
 433     os::free(old_prefixes);
 434   }
 435 
 436   return JVMTI_ERROR_NONE;
 437 }
 438 
 439 
 440 // Collect all the prefixes which have been set in any JVM TI environments
 441 // by the SetNativeMethodPrefix(es) functions.  Be sure to maintain the
 442 // order of environments and the order of prefixes within each environment.
 443 // Return in a resource allocated array.
 444 char**
 445 JvmtiEnvBase::get_all_native_method_prefixes(int* count_ptr) {
 446   assert(Threads::number_of_threads() == 0 ||
 447          SafepointSynchronize::is_at_safepoint() ||
 448          JvmtiThreadState_lock-&gt;is_locked(),
 449          &quot;sanity check&quot;);
 450 
 451   int total_count = 0;
 452   GrowableArray&lt;char*&gt;* prefix_array =new GrowableArray&lt;char*&gt;(5);
 453 
 454   JvmtiEnvIterator it;
 455   for (JvmtiEnvBase* env = it.first(); env != NULL; env = it.next(env)) {
 456     int prefix_count = env-&gt;get_native_method_prefix_count();
 457     char** prefixes = env-&gt;get_native_method_prefixes();
 458     for (int j = 0; j &lt; prefix_count; j++) {
 459       // retrieve a prefix and so that it is safe against asynchronous changes
 460       // copy it into the resource area
 461       char* prefix = prefixes[j];
 462       char* prefix_copy = NEW_RESOURCE_ARRAY(char, strlen(prefix)+1);
 463       strcpy(prefix_copy, prefix);
 464       prefix_array-&gt;at_put_grow(total_count++, prefix_copy);
 465     }
 466   }
 467 
 468   char** all_prefixes = NEW_RESOURCE_ARRAY(char*, total_count);
 469   char** p = all_prefixes;
 470   for (int i = 0; i &lt; total_count; ++i) {
 471     *p++ = prefix_array-&gt;at(i);
 472   }
 473   *count_ptr = total_count;
 474   return all_prefixes;
 475 }
 476 
 477 void
 478 JvmtiEnvBase::set_event_callbacks(const jvmtiEventCallbacks* callbacks,
 479                                                jint size_of_callbacks) {
 480   assert(Threads::number_of_threads() == 0 || JvmtiThreadState_lock-&gt;is_locked(), &quot;sanity check&quot;);
 481 
 482   size_t byte_cnt = sizeof(jvmtiEventCallbacks);
 483 
 484   // clear in either case to be sure we got any gap between sizes
 485   memset(&amp;_event_callbacks, 0, byte_cnt);
 486 
 487   // Now that JvmtiThreadState_lock is held, prevent a possible race condition where events
 488   // are re-enabled by a call to set event callbacks where the DisposeEnvironment
 489   // occurs after the boiler-plate environment check and before the lock is acquired.
 490   if (callbacks != NULL &amp;&amp; is_valid()) {
 491     if (size_of_callbacks &lt; (jint)byte_cnt) {
 492       byte_cnt = size_of_callbacks;
 493     }
 494     memcpy(&amp;_event_callbacks, callbacks, byte_cnt);
 495   }
 496 }
 497 
 498 
 499 // In the fullness of time, all users of the method should instead
 500 // directly use allocate, besides being cleaner and faster, this will
 501 // mean much better out of memory handling
 502 unsigned char *
 503 JvmtiEnvBase::jvmtiMalloc(jlong size) {
 504   unsigned char* mem = NULL;
 505   jvmtiError result = allocate(size, &amp;mem);
 506   assert(result == JVMTI_ERROR_NONE, &quot;Allocate failed&quot;);
 507   return mem;
 508 }
 509 
 510 
 511 // Handle management
 512 
 513 jobject JvmtiEnvBase::jni_reference(Handle hndl) {
 514   return JNIHandles::make_local(hndl());
 515 }
 516 
 517 jobject JvmtiEnvBase::jni_reference(JavaThread *thread, Handle hndl) {
 518   return JNIHandles::make_local(thread, hndl());
 519 }
 520 
 521 void JvmtiEnvBase::destroy_jni_reference(jobject jobj) {
 522   JNIHandles::destroy_local(jobj);
 523 }
 524 
 525 void JvmtiEnvBase::destroy_jni_reference(JavaThread *thread, jobject jobj) {
 526   JNIHandles::destroy_local(jobj); // thread is unused.
 527 }
 528 
 529 //
 530 // Threads
 531 //
 532 
 533 jobject *
 534 JvmtiEnvBase::new_jobjectArray(int length, Handle *handles) {
 535   if (length == 0) {
 536     return NULL;
 537   }
 538 
 539   jobject *objArray = (jobject *) jvmtiMalloc(sizeof(jobject) * length);
 540   NULL_CHECK(objArray, NULL);
 541 
 542   for (int i=0; i&lt;length; i++) {
 543     objArray[i] = jni_reference(handles[i]);
 544   }
 545   return objArray;
 546 }
 547 
 548 jthread *
 549 JvmtiEnvBase::new_jthreadArray(int length, Handle *handles) {
 550   return (jthread *) new_jobjectArray(length,handles);
 551 }
 552 
 553 jthreadGroup *
 554 JvmtiEnvBase::new_jthreadGroupArray(int length, Handle *handles) {
 555   return (jthreadGroup *) new_jobjectArray(length,handles);
 556 }
 557 
 558 // return the vframe on the specified thread and depth, NULL if no such frame
 559 vframe*
 560 JvmtiEnvBase::vframeFor(JavaThread* java_thread, jint depth) {
 561   if (!java_thread-&gt;has_last_Java_frame()) {
 562     return NULL;
 563   }
 564   RegisterMap reg_map(java_thread);
 565   vframe *vf = java_thread-&gt;last_java_vframe(&amp;reg_map);
 566   int d = 0;
 567   while ((vf != NULL) &amp;&amp; (d &lt; depth)) {
 568     vf = vf-&gt;java_sender();
 569     d++;
 570   }
 571   return vf;
 572 }
 573 
 574 
 575 //
 576 // utilities: JNI objects
 577 //
 578 
 579 
 580 jclass
 581 JvmtiEnvBase::get_jni_class_non_null(Klass* k) {
 582   assert(k != NULL, &quot;k != NULL&quot;);
 583   Thread *thread = Thread::current();
 584   return (jclass)jni_reference(Handle(thread, k-&gt;java_mirror()));
 585 }
 586 
 587 //
 588 // Field Information
 589 //
 590 
 591 bool
 592 JvmtiEnvBase::get_field_descriptor(Klass* k, jfieldID field, fieldDescriptor* fd) {
 593   if (!jfieldIDWorkaround::is_valid_jfieldID(k, field)) {
 594     return false;
 595   }
 596   bool found = false;
 597   if (jfieldIDWorkaround::is_static_jfieldID(field)) {
 598     JNIid* id = jfieldIDWorkaround::from_static_jfieldID(field);
 599     found = id-&gt;find_local_field(fd);
 600   } else {
 601     // Non-static field. The fieldID is really the offset of the field within the object.
 602     int offset = jfieldIDWorkaround::from_instance_jfieldID(k, field);
 603     found = InstanceKlass::cast(k)-&gt;find_field_from_offset(offset, false, fd);
 604   }
 605   return found;
 606 }
 607 
 608 //
 609 // Object Monitor Information
 610 //
 611 
 612 //
 613 // Count the number of objects for a lightweight monitor. The hobj
 614 // parameter is object that owns the monitor so this routine will
 615 // count the number of times the same object was locked by frames
 616 // in java_thread.
 617 //
 618 jint
 619 JvmtiEnvBase::count_locked_objects(JavaThread *java_thread, Handle hobj) {
 620   jint ret = 0;
 621   if (!java_thread-&gt;has_last_Java_frame()) {
 622     return ret;  // no Java frames so no monitors
 623   }
 624 
 625   ResourceMark rm;
 626   HandleMark   hm;
 627   RegisterMap  reg_map(java_thread);
 628 
 629   for(javaVFrame *jvf=java_thread-&gt;last_java_vframe(&amp;reg_map); jvf != NULL;
 630                                                  jvf = jvf-&gt;java_sender()) {
 631     GrowableArray&lt;MonitorInfo*&gt;* mons = jvf-&gt;monitors();
 632     if (!mons-&gt;is_empty()) {
 633       for (int i = 0; i &lt; mons-&gt;length(); i++) {
 634         MonitorInfo *mi = mons-&gt;at(i);
 635         if (mi-&gt;owner_is_scalar_replaced()) continue;
 636 
 637         // see if owner of the monitor is our object
 638         if (mi-&gt;owner() != NULL &amp;&amp; mi-&gt;owner() == hobj()) {
 639           ret++;
 640         }
 641       }
 642     }
 643   }
 644   return ret;
 645 }
 646 
 647 
 648 
 649 jvmtiError
 650 JvmtiEnvBase::get_current_contended_monitor(JavaThread *calling_thread, JavaThread *java_thread, jobject *monitor_ptr) {
 651   JavaThread *current_jt = JavaThread::current();
 652   assert(current_jt == java_thread ||
 653          current_jt == java_thread-&gt;active_handshaker(),
 654          &quot;call by myself or at direct handshake&quot;);
 655   oop obj = NULL;
 656   // The ObjectMonitor* can&#39;t be async deflated since we are either
 657   // at a safepoint or the calling thread is operating on itself so
 658   // it cannot leave the underlying wait()/enter() call.
 659   ObjectMonitor *mon = java_thread-&gt;current_waiting_monitor();
 660   if (mon == NULL) {
 661     // thread is not doing an Object.wait() call
 662     mon = java_thread-&gt;current_pending_monitor();
 663     if (mon != NULL) {
 664       // The thread is trying to enter() an ObjectMonitor.
 665       obj = (oop)mon-&gt;object();
 666       assert(obj != NULL, &quot;ObjectMonitor should have a valid object!&quot;);
 667     }
 668     // implied else: no contended ObjectMonitor
 669   } else {
 670     // thread is doing an Object.wait() call
 671     obj = (oop)mon-&gt;object();
 672     assert(obj != NULL, &quot;Object.wait() should have an object&quot;);
 673   }
 674 
 675   if (obj == NULL) {
 676     *monitor_ptr = NULL;
 677   } else {
 678     HandleMark hm;
 679     Handle     hobj(current_jt, obj);
 680     *monitor_ptr = jni_reference(calling_thread, hobj);
 681   }
 682   return JVMTI_ERROR_NONE;
 683 }
 684 
 685 
 686 jvmtiError
 687 JvmtiEnvBase::get_owned_monitors(JavaThread *calling_thread, JavaThread* java_thread,
 688                                  GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt; *owned_monitors_list) {
 689   jvmtiError err = JVMTI_ERROR_NONE;
 690   JavaThread *current_jt = JavaThread::current();
 691   assert(current_jt == java_thread ||
 692          current_jt == java_thread-&gt;active_handshaker(),
 693          &quot;call by myself or at direct handshake&quot;);
 694 
 695   if (java_thread-&gt;has_last_Java_frame()) {
 696     ResourceMark rm;
 697     HandleMark   hm;
 698     RegisterMap  reg_map(java_thread);
 699 
 700     int depth = 0;
 701     for (javaVFrame *jvf = java_thread-&gt;last_java_vframe(&amp;reg_map); jvf != NULL;
 702          jvf = jvf-&gt;java_sender()) {
 703       if (MaxJavaStackTraceDepth == 0 || depth++ &lt; MaxJavaStackTraceDepth) {  // check for stack too deep
 704         // add locked objects for this frame into list
 705         err = get_locked_objects_in_frame(calling_thread, java_thread, jvf, owned_monitors_list, depth-1);
 706         if (err != JVMTI_ERROR_NONE) {
 707           return err;
 708         }
 709       }
 710     }
 711   }
 712 
 713   // Get off stack monitors. (e.g. acquired via jni MonitorEnter).
 714   JvmtiMonitorClosure jmc(java_thread, calling_thread, owned_monitors_list, this);
 715   ObjectSynchronizer::monitors_iterate(&amp;jmc);
 716   err = jmc.error();
 717 
 718   return err;
 719 }
 720 
 721 // Save JNI local handles for any objects that this frame owns.
 722 jvmtiError
 723 JvmtiEnvBase::get_locked_objects_in_frame(JavaThread* calling_thread, JavaThread* java_thread,
 724                                  javaVFrame *jvf, GrowableArray&lt;jvmtiMonitorStackDepthInfo*&gt;* owned_monitors_list, jint stack_depth) {
 725   jvmtiError err = JVMTI_ERROR_NONE;
 726   ResourceMark rm;
 727 
 728   GrowableArray&lt;MonitorInfo*&gt;* mons = jvf-&gt;monitors();
 729   if (mons-&gt;is_empty()) {
 730     return err;  // this javaVFrame holds no monitors
 731   }
 732 
 733   HandleMark hm;
 734   oop wait_obj = NULL;
 735   {
 736     // The ObjectMonitor* can&#39;t be async deflated since we are either
 737     // at a safepoint or the calling thread is operating on itself so
 738     // it cannot leave the underlying wait() call.
 739     // Save object of current wait() call (if any) for later comparison.
 740     ObjectMonitor *mon = java_thread-&gt;current_waiting_monitor();
 741     if (mon != NULL) {
 742       wait_obj = (oop)mon-&gt;object();
 743     }
 744   }
 745   oop pending_obj = NULL;
 746   {
 747     // The ObjectMonitor* can&#39;t be async deflated since we are either
 748     // at a safepoint or the calling thread is operating on itself so
 749     // it cannot leave the underlying enter() call.
 750     // Save object of current enter() call (if any) for later comparison.
 751     ObjectMonitor *mon = java_thread-&gt;current_pending_monitor();
 752     if (mon != NULL) {
 753       pending_obj = (oop)mon-&gt;object();
 754     }
 755   }
 756 
 757   for (int i = 0; i &lt; mons-&gt;length(); i++) {
 758     MonitorInfo *mi = mons-&gt;at(i);
 759 
 760     if (mi-&gt;owner_is_scalar_replaced()) continue;
 761 
 762     oop obj = mi-&gt;owner();
 763     if (obj == NULL) {
 764       // this monitor doesn&#39;t have an owning object so skip it
 765       continue;
 766     }
 767 
 768     if (wait_obj == obj) {
 769       // the thread is waiting on this monitor so it isn&#39;t really owned
 770       continue;
 771     }
 772 
 773     if (pending_obj == obj) {
 774       // the thread is pending on this monitor so it isn&#39;t really owned
 775       continue;
 776     }
 777 
 778     if (owned_monitors_list-&gt;length() &gt; 0) {
 779       // Our list has at least one object on it so we have to check
 780       // for recursive object locking
 781       bool found = false;
 782       for (int j = 0; j &lt; owned_monitors_list-&gt;length(); j++) {
 783         jobject jobj = ((jvmtiMonitorStackDepthInfo*)owned_monitors_list-&gt;at(j))-&gt;monitor;
 784         oop check = JNIHandles::resolve(jobj);
 785         if (check == obj) {
 786           found = true;  // we found the object
 787           break;
 788         }
 789       }
 790 
 791       if (found) {
 792         // already have this object so don&#39;t include it
 793         continue;
 794       }
 795     }
 796 
 797     // add the owning object to our list
 798     jvmtiMonitorStackDepthInfo *jmsdi;
 799     err = allocate(sizeof(jvmtiMonitorStackDepthInfo), (unsigned char **)&amp;jmsdi);
 800     if (err != JVMTI_ERROR_NONE) {
 801         return err;
 802     }
 803     Handle hobj(Thread::current(), obj);
 804     jmsdi-&gt;monitor = jni_reference(calling_thread, hobj);
 805     jmsdi-&gt;stack_depth = stack_depth;
 806     owned_monitors_list-&gt;append(jmsdi);
 807   }
 808 
 809   return err;
 810 }
 811 
 812 jvmtiError
 813 JvmtiEnvBase::get_stack_trace(JavaThread *java_thread,
 814                               jint start_depth, jint max_count,
 815                               jvmtiFrameInfo* frame_buffer, jint* count_ptr) {
 816 #ifdef ASSERT
 817   uint32_t debug_bits = 0;
 818 #endif
 819   assert((SafepointSynchronize::is_at_safepoint() ||
 820           java_thread-&gt;is_thread_fully_suspended(false, &amp;debug_bits)),
 821          &quot;at safepoint or target thread is suspended&quot;);
 822   int count = 0;
 823   if (java_thread-&gt;has_last_Java_frame()) {
 824     RegisterMap reg_map(java_thread);
 825     Thread* current_thread = Thread::current();
 826     ResourceMark rm(current_thread);
 827     javaVFrame *jvf = java_thread-&gt;last_java_vframe(&amp;reg_map);
 828     HandleMark hm(current_thread);
 829     if (start_depth != 0) {
 830       if (start_depth &gt; 0) {
 831         for (int j = 0; j &lt; start_depth &amp;&amp; jvf != NULL; j++) {
 832           jvf = jvf-&gt;java_sender();
 833         }
 834         if (jvf == NULL) {
 835           // start_depth is deeper than the stack depth
 836           return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 837         }
 838       } else { // start_depth &lt; 0
 839         // we are referencing the starting depth based on the oldest
 840         // part of the stack.
 841         // optimize to limit the number of times that java_sender() is called
 842         javaVFrame *jvf_cursor = jvf;
 843         javaVFrame *jvf_prev = NULL;
 844         javaVFrame *jvf_prev_prev = NULL;
 845         int j = 0;
 846         while (jvf_cursor != NULL) {
 847           jvf_prev_prev = jvf_prev;
 848           jvf_prev = jvf_cursor;
 849           for (j = 0; j &gt; start_depth &amp;&amp; jvf_cursor != NULL; j--) {
 850             jvf_cursor = jvf_cursor-&gt;java_sender();
 851           }
 852         }
 853         if (j == start_depth) {
 854           // previous pointer is exactly where we want to start
 855           jvf = jvf_prev;
 856         } else {
 857           // we need to back up further to get to the right place
 858           if (jvf_prev_prev == NULL) {
 859             // the -start_depth is greater than the stack depth
 860             return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 861           }
 862           // j now is the number of frames on the stack starting with
 863           // jvf_prev, we start from jvf_prev_prev and move older on
 864           // the stack that many, the result is -start_depth frames
 865           // remaining.
 866           jvf = jvf_prev_prev;
 867           for (; j &lt; 0; j++) {
 868             jvf = jvf-&gt;java_sender();
 869           }
 870         }
 871       }
 872     }
 873     for (; count &lt; max_count &amp;&amp; jvf != NULL; count++) {
 874       frame_buffer[count].method = jvf-&gt;method()-&gt;jmethod_id();
 875       frame_buffer[count].location = (jvf-&gt;method()-&gt;is_native() ? -1 : jvf-&gt;bci());
 876       jvf = jvf-&gt;java_sender();
 877     }
 878   } else {
 879     if (start_depth != 0) {
 880       // no frames and there is a starting depth
 881       return JVMTI_ERROR_ILLEGAL_ARGUMENT;
 882     }
 883   }
 884   *count_ptr = count;
 885   return JVMTI_ERROR_NONE;
 886 }
 887 
 888 jvmtiError
 889 JvmtiEnvBase::get_frame_count(JvmtiThreadState *state, jint *count_ptr) {
 890   assert((state != NULL),
 891          &quot;JavaThread should create JvmtiThreadState before calling this method&quot;);
 892   *count_ptr = state-&gt;count_frames();
 893   return JVMTI_ERROR_NONE;
 894 }
 895 
 896 jvmtiError
 897 JvmtiEnvBase::get_frame_location(JavaThread *java_thread, jint depth,
 898                                  jmethodID* method_ptr, jlocation* location_ptr) {
 899 #ifdef ASSERT
 900   uint32_t debug_bits = 0;
 901 #endif
 902   assert((SafepointSynchronize::is_at_safepoint() ||
 903           java_thread-&gt;is_thread_fully_suspended(false, &amp;debug_bits)),
 904          &quot;at safepoint or target thread is suspended&quot;);
 905   Thread* current_thread = Thread::current();
 906   ResourceMark rm(current_thread);
 907 
 908   vframe *vf = vframeFor(java_thread, depth);
 909   if (vf == NULL) {
 910     return JVMTI_ERROR_NO_MORE_FRAMES;
 911   }
 912 
 913   // vframeFor should return a java frame. If it doesn&#39;t
 914   // it means we&#39;ve got an internal error and we return the
 915   // error in product mode. In debug mode we will instead
 916   // attempt to cast the vframe to a javaVFrame and will
 917   // cause an assertion/crash to allow further diagnosis.
 918 #ifdef PRODUCT
 919   if (!vf-&gt;is_java_frame()) {
 920     return JVMTI_ERROR_INTERNAL;
 921   }
 922 #endif
 923 
 924   HandleMark hm(current_thread);
 925   javaVFrame *jvf = javaVFrame::cast(vf);
 926   Method* method = jvf-&gt;method();
 927   if (method-&gt;is_native()) {
 928     *location_ptr = -1;
 929   } else {
 930     *location_ptr = jvf-&gt;bci();
 931   }
 932   *method_ptr = method-&gt;jmethod_id();
 933 
 934   return JVMTI_ERROR_NONE;
 935 }
 936 
 937 
 938 jvmtiError
 939 JvmtiEnvBase::get_object_monitor_usage(JavaThread* calling_thread, jobject object, jvmtiMonitorUsage* info_ptr) {
<a name="1" id="anc1"></a><span class="line-modified"> 940   HandleMark hm;</span>
<span class="line-modified"> 941   Handle hobj;</span>

 942 
<a name="2" id="anc2"></a><span class="line-modified"> 943   Thread* current_thread = Thread::current();</span>
<span class="line-modified"> 944   bool at_safepoint = SafepointSynchronize::is_at_safepoint();</span>
 945 
 946   // Check arguments
 947   {
 948     oop mirror = JNIHandles::resolve_external_guard(object);
 949     NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 950     NULL_CHECK(info_ptr, JVMTI_ERROR_NULL_POINTER);
 951 
 952     hobj = Handle(current_thread, mirror);
 953   }
 954 
<a name="3" id="anc3"></a>
 955   JavaThread *owning_thread = NULL;
 956   ObjectMonitor *mon = NULL;
 957   jvmtiMonitorUsage ret = {
 958       NULL, 0, 0, NULL, 0, NULL
 959   };
 960 
 961   uint32_t debug_bits = 0;
 962   // first derive the object&#39;s owner and entry_count (if any)
 963   {
 964     // Inline types instances don&#39;t support synchronization operations
 965     // they are marked as always locked and no attempt to remove a
 966     // potential bias (which cannot exist) should be made
 967     if (!hobj()-&gt;mark().is_always_locked()) {
 968       // Revoke any biases before querying the mark word
<a name="4" id="anc4"></a><span class="line-modified"> 969       if (at_safepoint) {</span>
<span class="line-removed"> 970         BiasedLocking::revoke_at_safepoint(hobj);</span>
<span class="line-removed"> 971       } else {</span>
<span class="line-removed"> 972         BiasedLocking::revoke(hobj, calling_thread);</span>
<span class="line-removed"> 973       }</span>
 974     }
 975 
 976     address owner = NULL;
 977     {
 978       markWord mark = hobj()-&gt;mark();
 979 
 980       if (!mark.has_monitor()) {
 981         // this object has a lightweight monitor
 982 
 983         if (mark.has_locker()) {
 984           owner = (address)mark.locker(); // save the address of the Lock word
 985         }
 986         // implied else: no owner
 987       } else {
 988         // this object has a heavyweight monitor
 989         mon = mark.monitor();
 990 
 991         // The owner field of a heavyweight monitor may be NULL for no
 992         // owner, a JavaThread * or it may still be the address of the
 993         // Lock word in a JavaThread&#39;s stack. A monitor can be inflated
 994         // by a non-owning JavaThread, but only the owning JavaThread
 995         // can change the owner field from the Lock word to the
 996         // JavaThread * and it may not have done that yet.
 997         owner = (address)mon-&gt;owner();
 998       }
 999     }
1000 
1001     if (owner != NULL) {
<a name="5" id="anc5"></a><span class="line-removed">1002       // Use current thread since function can be called from a</span>
<span class="line-removed">1003       // JavaThread or the VMThread.</span>
<span class="line-removed">1004       ThreadsListHandle tlh;</span>
1005       // This monitor is owned so we have to find the owning JavaThread.
1006       owning_thread = Threads::owning_thread_from_monitor_owner(tlh.list(), owner);
<a name="6" id="anc6"></a><span class="line-modified">1007       // Cannot assume (owning_thread != NULL) here because this function</span>
<span class="line-modified">1008       // may not have been called at a safepoint and the owning_thread</span>
<span class="line-modified">1009       // might not be suspended.</span>
<span class="line-modified">1010       if (owning_thread != NULL) {</span>
<span class="line-removed">1011         // The monitor&#39;s owner either has to be the current thread, at safepoint</span>
<span class="line-removed">1012         // or it has to be suspended. Any of these conditions will prevent both</span>
<span class="line-removed">1013         // contending and waiting threads from modifying the state of</span>
<span class="line-removed">1014         // the monitor.</span>
<span class="line-removed">1015         if (!at_safepoint &amp;&amp; !owning_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {</span>
<span class="line-removed">1016           // Don&#39;t worry! This return of JVMTI_ERROR_THREAD_NOT_SUSPENDED</span>
<span class="line-removed">1017           // will not make it back to the JVM/TI agent. The error code will</span>
<span class="line-removed">1018           // get intercepted in JvmtiEnv::GetObjectMonitorUsage() which</span>
<span class="line-removed">1019           // will retry the call via a VM_GetObjectMonitorUsage VM op.</span>
<span class="line-removed">1020           return JVMTI_ERROR_THREAD_NOT_SUSPENDED;</span>
<span class="line-removed">1021         }</span>
<span class="line-removed">1022         HandleMark hm;</span>
<span class="line-removed">1023         Handle     th(current_thread, owning_thread-&gt;threadObj());</span>
<span class="line-removed">1024         ret.owner = (jthread)jni_reference(calling_thread, th);</span>
<span class="line-removed">1025       }</span>
<span class="line-removed">1026       // implied else: no owner</span>
<span class="line-removed">1027     } // ThreadsListHandle is destroyed here.</span>
1028 
1029     if (owning_thread != NULL) {  // monitor is owned
1030       // The recursions field of a monitor does not reflect recursions
1031       // as lightweight locks before inflating the monitor are not included.
1032       // We have to count the number of recursive monitor entries the hard way.
1033       // We pass a handle to survive any GCs along the way.
<a name="7" id="anc7"></a><span class="line-modified">1034       ResourceMark rm;</span>
1035       ret.entry_count = count_locked_objects(owning_thread, hobj);
1036     }
1037     // implied else: entry_count == 0
1038   }
1039 
1040   jint nWant = 0, nWait = 0;
1041   if (mon != NULL) {
1042     // this object has a heavyweight monitor
1043     nWant = mon-&gt;contentions(); // # of threads contending for monitor
1044     nWait = mon-&gt;waiters();     // # of threads in Object.wait()
1045     ret.waiter_count = nWant + nWait;
1046     ret.notify_waiter_count = nWait;
1047   } else {
1048     // this object has a lightweight monitor
1049     ret.waiter_count = 0;
1050     ret.notify_waiter_count = 0;
1051   }
1052 
1053   // Allocate memory for heavyweight and lightweight monitor.
1054   jvmtiError err;
1055   err = allocate(ret.waiter_count * sizeof(jthread *), (unsigned char**)&amp;ret.waiters);
1056   if (err != JVMTI_ERROR_NONE) {
1057     return err;
1058   }
1059   err = allocate(ret.notify_waiter_count * sizeof(jthread *),
1060                  (unsigned char**)&amp;ret.notify_waiters);
1061   if (err != JVMTI_ERROR_NONE) {
1062     deallocate((unsigned char*)ret.waiters);
1063     return err;
1064   }
1065 
1066   // now derive the rest of the fields
1067   if (mon != NULL) {
1068     // this object has a heavyweight monitor
1069 
1070     // Number of waiters may actually be less than the waiter count.
1071     // So NULL out memory so that unused memory will be NULL.
1072     memset(ret.waiters, 0, ret.waiter_count * sizeof(jthread *));
1073     memset(ret.notify_waiters, 0, ret.notify_waiter_count * sizeof(jthread *));
1074 
1075     if (ret.waiter_count &gt; 0) {
1076       // we have contending and/or waiting threads
<a name="8" id="anc8"></a><span class="line-removed">1077       HandleMark hm;</span>
<span class="line-removed">1078       // Use current thread since function can be called from a</span>
<span class="line-removed">1079       // JavaThread or the VMThread.</span>
<span class="line-removed">1080       ThreadsListHandle tlh;</span>
1081       if (nWant &gt; 0) {
1082         // we have contending threads
<a name="9" id="anc9"></a><span class="line-modified">1083         ResourceMark rm;</span>
1084         // get_pending_threads returns only java thread so we do not need to
1085         // check for non java threads.
1086         GrowableArray&lt;JavaThread*&gt;* wantList = Threads::get_pending_threads(tlh.list(), nWant, (address)mon);
1087         if (wantList-&gt;length() &lt; nWant) {
1088           // robustness: the pending list has gotten smaller
1089           nWant = wantList-&gt;length();
1090         }
1091         for (int i = 0; i &lt; nWant; i++) {
1092           JavaThread *pending_thread = wantList-&gt;at(i);
<a name="10" id="anc10"></a><span class="line-removed">1093           // If the monitor has no owner, then a non-suspended contending</span>
<span class="line-removed">1094           // thread could potentially change the state of the monitor by</span>
<span class="line-removed">1095           // entering it. The JVM/TI spec doesn&#39;t allow this.</span>
<span class="line-removed">1096           if (owning_thread == NULL &amp;&amp; !at_safepoint &amp;&amp;</span>
<span class="line-removed">1097               !pending_thread-&gt;is_thread_fully_suspended(true, &amp;debug_bits)) {</span>
<span class="line-removed">1098             if (ret.owner != NULL) {</span>
<span class="line-removed">1099               destroy_jni_reference(calling_thread, ret.owner);</span>
<span class="line-removed">1100             }</span>
<span class="line-removed">1101             for (int j = 0; j &lt; i; j++) {</span>
<span class="line-removed">1102               destroy_jni_reference(calling_thread, ret.waiters[j]);</span>
<span class="line-removed">1103             }</span>
<span class="line-removed">1104             deallocate((unsigned char*)ret.waiters);</span>
<span class="line-removed">1105             deallocate((unsigned char*)ret.notify_waiters);</span>
<span class="line-removed">1106             return JVMTI_ERROR_THREAD_NOT_SUSPENDED;</span>
<span class="line-removed">1107           }</span>
1108           Handle th(current_thread, pending_thread-&gt;threadObj());
1109           ret.waiters[i] = (jthread)jni_reference(calling_thread, th);
1110         }
1111       }
1112       if (nWait &gt; 0) {
1113         // we have threads in Object.wait()
1114         int offset = nWant;  // add after any contending threads
1115         ObjectWaiter *waiter = mon-&gt;first_waiter();
1116         for (int i = 0, j = 0; i &lt; nWait; i++) {
1117           if (waiter == NULL) {
1118             // robustness: the waiting list has gotten smaller
1119             nWait = j;
1120             break;
1121           }
1122           Thread *t = mon-&gt;thread_of_waiter(waiter);
1123           if (t != NULL &amp;&amp; t-&gt;is_Java_thread()) {
1124             JavaThread *wjava_thread = (JavaThread *)t;
1125             // If the thread was found on the ObjectWaiter list, then
1126             // it has not been notified. This thread can&#39;t change the
1127             // state of the monitor so it doesn&#39;t need to be suspended.
1128             Handle th(current_thread, wjava_thread-&gt;threadObj());
1129             ret.waiters[offset + j] = (jthread)jni_reference(calling_thread, th);
1130             ret.notify_waiters[j++] = (jthread)jni_reference(calling_thread, th);
1131           }
1132           waiter = mon-&gt;next_waiter(waiter);
1133         }
1134       }
1135     } // ThreadsListHandle is destroyed here.
1136 
1137     // Adjust count. nWant and nWait count values may be less than original.
1138     ret.waiter_count = nWant + nWait;
1139     ret.notify_waiter_count = nWait;
1140   } else {
1141     // this object has a lightweight monitor and we have nothing more
1142     // to do here because the defaults are just fine.
1143   }
1144 
1145   // we don&#39;t update return parameter unless everything worked
1146   *info_ptr = ret;
1147 
1148   return JVMTI_ERROR_NONE;
1149 }
1150 
1151 ResourceTracker::ResourceTracker(JvmtiEnv* env) {
1152   _env = env;
1153   _allocations = new (ResourceObj::C_HEAP, mtServiceability) GrowableArray&lt;unsigned char*&gt;(20, mtServiceability);
1154   _failed = false;
1155 }
1156 ResourceTracker::~ResourceTracker() {
1157   if (_failed) {
1158     for (int i=0; i&lt;_allocations-&gt;length(); i++) {
1159       _env-&gt;deallocate(_allocations-&gt;at(i));
1160     }
1161   }
1162   delete _allocations;
1163 }
1164 
1165 jvmtiError ResourceTracker::allocate(jlong size, unsigned char** mem_ptr) {
1166   unsigned char *ptr;
1167   jvmtiError err = _env-&gt;allocate(size, &amp;ptr);
1168   if (err == JVMTI_ERROR_NONE) {
1169     _allocations-&gt;append(ptr);
1170     *mem_ptr = ptr;
1171   } else {
1172     *mem_ptr = NULL;
1173     _failed = true;
1174   }
1175   return err;
1176  }
1177 
1178 unsigned char* ResourceTracker::allocate(jlong size) {
1179   unsigned char* ptr;
1180   allocate(size, &amp;ptr);
1181   return ptr;
1182 }
1183 
1184 char* ResourceTracker::strdup(const char* str) {
1185   char *dup_str = (char*)allocate(strlen(str)+1);
1186   if (dup_str != NULL) {
1187     strcpy(dup_str, str);
1188   }
1189   return dup_str;
1190 }
1191 
1192 struct StackInfoNode {
1193   struct StackInfoNode *next;
1194   jvmtiStackInfo info;
1195 };
1196 
1197 // Create a jvmtiStackInfo inside a linked list node and create a
1198 // buffer for the frame information, both allocated as resource objects.
1199 // Fill in both the jvmtiStackInfo and the jvmtiFrameInfo.
1200 // Note that either or both of thr and thread_oop
1201 // may be null if the thread is new or has exited.
1202 void
1203 VM_GetMultipleStackTraces::fill_frames(jthread jt, JavaThread *thr, oop thread_oop) {
1204   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1205 
1206   jint state = 0;
1207   struct StackInfoNode *node = NEW_RESOURCE_OBJ(struct StackInfoNode);
1208   jvmtiStackInfo *infop = &amp;(node-&gt;info);
1209   node-&gt;next = head();
1210   set_head(node);
1211   infop-&gt;frame_count = 0;
1212   infop-&gt;thread = jt;
1213 
1214   if (thread_oop != NULL) {
1215     // get most state bits
1216     state = (jint)java_lang_Thread::get_thread_status(thread_oop);
1217   }
1218 
1219   if (thr != NULL) {    // add more state bits if there is a JavaThead to query
1220     // same as is_being_ext_suspended() but without locking
1221     if (thr-&gt;is_ext_suspended() || thr-&gt;is_external_suspend()) {
1222       state |= JVMTI_THREAD_STATE_SUSPENDED;
1223     }
1224     JavaThreadState jts = thr-&gt;thread_state();
1225     if (jts == _thread_in_native) {
1226       state |= JVMTI_THREAD_STATE_IN_NATIVE;
1227     }
1228     if (thr-&gt;is_interrupted(false)) {
1229       state |= JVMTI_THREAD_STATE_INTERRUPTED;
1230     }
1231   }
1232   infop-&gt;state = state;
1233 
1234   if (thr != NULL &amp;&amp; (state &amp; JVMTI_THREAD_STATE_ALIVE) != 0) {
1235     infop-&gt;frame_buffer = NEW_RESOURCE_ARRAY(jvmtiFrameInfo, max_frame_count());
1236     env()-&gt;get_stack_trace(thr, 0, max_frame_count(),
1237                            infop-&gt;frame_buffer, &amp;(infop-&gt;frame_count));
1238   } else {
1239     infop-&gt;frame_buffer = NULL;
1240     infop-&gt;frame_count = 0;
1241   }
1242   _frame_count_total += infop-&gt;frame_count;
1243 }
1244 
1245 // Based on the stack information in the linked list, allocate memory
1246 // block to return and fill it from the info in the linked list.
1247 void
1248 VM_GetMultipleStackTraces::allocate_and_fill_stacks(jint thread_count) {
1249   // do I need to worry about alignment issues?
1250   jlong alloc_size =  thread_count       * sizeof(jvmtiStackInfo)
1251                     + _frame_count_total * sizeof(jvmtiFrameInfo);
1252   env()-&gt;allocate(alloc_size, (unsigned char **)&amp;_stack_info);
1253 
1254   // pointers to move through the newly allocated space as it is filled in
1255   jvmtiStackInfo *si = _stack_info + thread_count;      // bottom of stack info
1256   jvmtiFrameInfo *fi = (jvmtiFrameInfo *)si;            // is the top of frame info
1257 
1258   // copy information in resource area into allocated buffer
1259   // insert stack info backwards since linked list is backwards
1260   // insert frame info forwards
1261   // walk the StackInfoNodes
1262   for (struct StackInfoNode *sin = head(); sin != NULL; sin = sin-&gt;next) {
1263     jint frame_count = sin-&gt;info.frame_count;
1264     size_t frames_size = frame_count * sizeof(jvmtiFrameInfo);
1265     --si;
1266     memcpy(si, &amp;(sin-&gt;info), sizeof(jvmtiStackInfo));
1267     if (frames_size == 0) {
1268       si-&gt;frame_buffer = NULL;
1269     } else {
1270       memcpy(fi, sin-&gt;info.frame_buffer, frames_size);
1271       si-&gt;frame_buffer = fi;  // point to the new allocated copy of the frames
1272       fi += frame_count;
1273     }
1274   }
1275   assert(si == _stack_info, &quot;the last copied stack info must be the first record&quot;);
1276   assert((unsigned char *)fi == ((unsigned char *)_stack_info) + alloc_size,
1277          &quot;the last copied frame info must be the last record&quot;);
1278 }
1279 
1280 
1281 void
1282 VM_GetThreadListStackTraces::doit() {
1283   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1284 
1285   ResourceMark rm;
1286   ThreadsListHandle tlh;
1287   for (int i = 0; i &lt; _thread_count; ++i) {
1288     jthread jt = _thread_list[i];
1289     JavaThread* java_thread = NULL;
1290     oop thread_oop = NULL;
1291     jvmtiError err = JvmtiExport::cv_external_thread_to_JavaThread(tlh.list(), jt, &amp;java_thread, &amp;thread_oop);
1292     if (err != JVMTI_ERROR_NONE) {
1293       // We got an error code so we don&#39;t have a JavaThread *, but
1294       // only return an error from here if we didn&#39;t get a valid
1295       // thread_oop.
1296       if (thread_oop == NULL) {
1297         set_result(err);
1298         return;
1299       }
1300       // We have a valid thread_oop.
1301     }
1302     fill_frames(jt, java_thread, thread_oop);
1303   }
1304   allocate_and_fill_stacks(_thread_count);
1305 }
1306 
1307 void
1308 VM_GetAllStackTraces::doit() {
1309   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at safepoint&quot;);
1310 
1311   ResourceMark rm;
1312   _final_thread_count = 0;
1313   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
1314     oop thread_oop = jt-&gt;threadObj();
1315     if (thread_oop != NULL &amp;&amp;
1316         !jt-&gt;is_exiting() &amp;&amp;
1317         java_lang_Thread::is_alive(thread_oop) &amp;&amp;
1318         !jt-&gt;is_hidden_from_external_view()) {
1319       ++_final_thread_count;
1320       // Handle block of the calling thread is used to create local refs.
1321       fill_frames((jthread)JNIHandles::make_local(_calling_thread, thread_oop),
1322                   jt, thread_oop);
1323     }
1324   }
1325   allocate_and_fill_stacks(_final_thread_count);
1326 }
1327 
1328 // Verifies that the top frame is a java frame in an expected state.
1329 // Deoptimizes frame if needed.
1330 // Checks that the frame method signature matches the return type (tos).
1331 // HandleMark must be defined in the caller only.
1332 // It is to keep a ret_ob_h handle alive after return to the caller.
1333 jvmtiError
1334 JvmtiEnvBase::check_top_frame(JavaThread* current_thread, JavaThread* java_thread,
1335                               jvalue value, TosState tos, Handle* ret_ob_h) {
1336   ResourceMark rm(current_thread);
1337 
1338   vframe *vf = vframeFor(java_thread, 0);
1339   NULL_CHECK(vf, JVMTI_ERROR_NO_MORE_FRAMES);
1340 
1341   javaVFrame *jvf = (javaVFrame*) vf;
1342   if (!vf-&gt;is_java_frame() || jvf-&gt;method()-&gt;is_native()) {
1343     return JVMTI_ERROR_OPAQUE_FRAME;
1344   }
1345 
1346   // If the frame is a compiled one, need to deoptimize it.
1347   if (vf-&gt;is_compiled_frame()) {
1348     if (!vf-&gt;fr().can_be_deoptimized()) {
1349       return JVMTI_ERROR_OPAQUE_FRAME;
1350     }
1351     Deoptimization::deoptimize_frame(java_thread, jvf-&gt;fr().id());
1352   }
1353 
1354   // Get information about method return type
1355   Symbol* signature = jvf-&gt;method()-&gt;signature();
1356 
1357   ResultTypeFinder rtf(signature);
1358   TosState fr_tos = as_TosState(rtf.type());
1359   if (fr_tos != tos) {
1360     if (tos != itos || (fr_tos != btos &amp;&amp; fr_tos != ztos &amp;&amp; fr_tos != ctos &amp;&amp; fr_tos != stos)) {
1361       return JVMTI_ERROR_TYPE_MISMATCH;
1362     }
1363   }
1364 
1365   // Check that the jobject class matches the return type signature.
1366   jobject jobj = value.l;
1367   if (tos == atos &amp;&amp; jobj != NULL) { // NULL reference is allowed
1368     Handle ob_h(current_thread, JNIHandles::resolve_external_guard(jobj));
1369     NULL_CHECK(ob_h, JVMTI_ERROR_INVALID_OBJECT);
1370     Klass* ob_k = ob_h()-&gt;klass();
1371     NULL_CHECK(ob_k, JVMTI_ERROR_INVALID_OBJECT);
1372 
1373     // Method return type signature.
1374     char* ty_sign = 1 + strchr(signature-&gt;as_C_string(), JVM_SIGNATURE_ENDFUNC);
1375 
1376     if (!VM_GetOrSetLocal::is_assignable(ty_sign, ob_k, current_thread)) {
1377       return JVMTI_ERROR_TYPE_MISMATCH;
1378     }
1379     *ret_ob_h = ob_h;
1380   }
1381   return JVMTI_ERROR_NONE;
1382 } /* end check_top_frame */
1383 
1384 
1385 // ForceEarlyReturn&lt;type&gt; follows the PopFrame approach in many aspects.
1386 // Main difference is on the last stage in the interpreter.
1387 // The PopFrame stops method execution to continue execution
1388 // from the same method call instruction.
1389 // The ForceEarlyReturn forces return from method so the execution
1390 // continues at the bytecode following the method call.
1391 
1392 // Threads_lock NOT held, java_thread not protected by lock
1393 // java_thread - pre-checked
1394 
1395 jvmtiError
1396 JvmtiEnvBase::force_early_return(JavaThread* java_thread, jvalue value, TosState tos) {
1397   JavaThread* current_thread = JavaThread::current();
1398   HandleMark   hm(current_thread);
1399   uint32_t debug_bits = 0;
1400 
1401   // retrieve or create the state
1402   JvmtiThreadState* state = JvmtiThreadState::state_for(java_thread);
1403   if (state == NULL) {
1404     return JVMTI_ERROR_THREAD_NOT_ALIVE;
1405   }
1406 
1407   // Check if java_thread is fully suspended
1408   if (!java_thread-&gt;is_thread_fully_suspended(true /* wait for suspend completion */, &amp;debug_bits)) {
1409     return JVMTI_ERROR_THREAD_NOT_SUSPENDED;
1410   }
1411 
1412   // Check to see if a ForceEarlyReturn was already in progress
1413   if (state-&gt;is_earlyret_pending()) {
1414     // Probably possible for JVMTI clients to trigger this, but the
1415     // JPDA backend shouldn&#39;t allow this to happen
1416     return JVMTI_ERROR_INTERNAL;
1417   }
1418   {
1419     // The same as for PopFrame. Workaround bug:
1420     //  4812902: popFrame hangs if the method is waiting at a synchronize
1421     // Catch this condition and return an error to avoid hanging.
1422     // Now JVMTI spec allows an implementation to bail out with an opaque
1423     // frame error.
1424     OSThread* osThread = java_thread-&gt;osthread();
1425     if (osThread-&gt;get_state() == MONITOR_WAIT) {
1426       return JVMTI_ERROR_OPAQUE_FRAME;
1427     }
1428   }
1429   Handle ret_ob_h;
1430   jvmtiError err = check_top_frame(current_thread, java_thread, value, tos, &amp;ret_ob_h);
1431   if (err != JVMTI_ERROR_NONE) {
1432     return err;
1433   }
1434   assert(tos != atos || value.l == NULL || ret_ob_h() != NULL,
1435          &quot;return object oop must not be NULL if jobject is not NULL&quot;);
1436 
1437   // Update the thread state to reflect that the top frame must be
1438   // forced to return.
1439   // The current frame will be returned later when the suspended
1440   // thread is resumed and right before returning from VM to Java.
1441   // (see call_VM_base() in assembler_&lt;cpu&gt;.cpp).
1442 
1443   state-&gt;set_earlyret_pending();
1444   state-&gt;set_earlyret_oop(ret_ob_h());
1445   state-&gt;set_earlyret_value(value, tos);
1446 
1447   // Set pending step flag for this early return.
1448   // It is cleared when next step event is posted.
1449   state-&gt;set_pending_step_for_earlyret();
1450 
1451   return JVMTI_ERROR_NONE;
1452 } /* end force_early_return */
1453 
1454 void
1455 JvmtiMonitorClosure::do_monitor(ObjectMonitor* mon) {
1456   if ( _error != JVMTI_ERROR_NONE) {
1457     // Error occurred in previous iteration so no need to add
1458     // to the list.
1459     return;
1460   }
1461   if (mon-&gt;owner() == _java_thread ) {
1462     // Filter out on stack monitors collected during stack walk.
1463     oop obj = (oop)mon-&gt;object();
1464     bool found = false;
1465     for (int j = 0; j &lt; _owned_monitors_list-&gt;length(); j++) {
1466       jobject jobj = ((jvmtiMonitorStackDepthInfo*)_owned_monitors_list-&gt;at(j))-&gt;monitor;
1467       oop check = JNIHandles::resolve(jobj);
1468       if (check == obj) {
1469         // On stack monitor already collected during the stack walk.
1470         found = true;
1471         break;
1472       }
1473     }
1474     if (found == false) {
1475       // This is off stack monitor (e.g. acquired via jni MonitorEnter).
1476       jvmtiError err;
1477       jvmtiMonitorStackDepthInfo *jmsdi;
1478       err = _env-&gt;allocate(sizeof(jvmtiMonitorStackDepthInfo), (unsigned char **)&amp;jmsdi);
1479       if (err != JVMTI_ERROR_NONE) {
1480         _error = err;
1481         return;
1482       }
1483       Handle hobj(Thread::current(), obj);
1484       jmsdi-&gt;monitor = _env-&gt;jni_reference(_calling_thread, hobj);
1485       // stack depth is unknown for this monitor.
1486       jmsdi-&gt;stack_depth = -1;
1487       _owned_monitors_list-&gt;append(jmsdi);
1488     }
1489   }
1490 }
1491 
1492 GrowableArray&lt;OopHandle&gt;* JvmtiModuleClosure::_tbl = NULL;
1493 
1494 void JvmtiModuleClosure::do_module(ModuleEntry* entry) {
1495   assert_locked_or_safepoint(Module_lock);
1496   OopHandle module = entry-&gt;module_handle();
1497   guarantee(module.resolve() != NULL, &quot;module object is NULL&quot;);
1498   _tbl-&gt;push(module);
1499 }
1500 
1501 jvmtiError
1502 JvmtiModuleClosure::get_all_modules(JvmtiEnv* env, jint* module_count_ptr, jobject** modules_ptr) {
1503   ResourceMark rm;
1504   MutexLocker mcld(ClassLoaderDataGraph_lock);
1505   MutexLocker ml(Module_lock);
1506 
1507   _tbl = new GrowableArray&lt;OopHandle&gt;(77);
1508   if (_tbl == NULL) {
1509     return JVMTI_ERROR_OUT_OF_MEMORY;
1510   }
1511 
1512   // Iterate over all the modules loaded to the system.
1513   ClassLoaderDataGraph::modules_do(&amp;do_module);
1514 
1515   jint len = _tbl-&gt;length();
1516   guarantee(len &gt; 0, &quot;at least one module must be present&quot;);
1517 
1518   jobject* array = (jobject*)env-&gt;jvmtiMalloc((jlong)(len * sizeof(jobject)));
1519   if (array == NULL) {
1520     return JVMTI_ERROR_OUT_OF_MEMORY;
1521   }
1522   for (jint idx = 0; idx &lt; len; idx++) {
1523     array[idx] = JNIHandles::make_local(Thread::current(), _tbl-&gt;at(idx).resolve());
1524   }
1525   _tbl = NULL;
1526   *modules_ptr = array;
1527   *module_count_ptr = len;
1528   return JVMTI_ERROR_NONE;
1529 }
1530 
1531 void
1532 VM_UpdateForPopTopFrame::doit() {
1533   JavaThread* jt = _state-&gt;get_thread();
1534   ThreadsListHandle tlh;
1535   if (jt != NULL &amp;&amp; tlh.includes(jt) &amp;&amp; !jt-&gt;is_exiting() &amp;&amp; jt-&gt;threadObj() != NULL) {
1536     _state-&gt;update_for_pop_top_frame();
1537   } else {
1538     _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1539   }
1540 }
1541 
1542 void
1543 VM_SetFramePop::doit() {
1544   JavaThread* jt = _state-&gt;get_thread();
1545   ThreadsListHandle tlh;
1546   if (jt != NULL &amp;&amp; tlh.includes(jt) &amp;&amp; !jt-&gt;is_exiting() &amp;&amp; jt-&gt;threadObj() != NULL) {
1547     int frame_number = _state-&gt;count_frames() - _depth;
1548     _state-&gt;env_thread_state((JvmtiEnvBase*)_env)-&gt;set_frame_pop(frame_number);
1549   } else {
1550     _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1551   }
1552 }
1553 
1554 void
1555 GetOwnedMonitorInfoClosure::do_thread(Thread *target) {
1556   _result = ((JvmtiEnvBase *)_env)-&gt;get_owned_monitors(_calling_thread, (JavaThread *)target, _owned_monitors_list);
1557 }
1558 
1559 void
1560 GetCurrentContendedMonitorClosure::do_thread(Thread *target) {
1561   _result = ((JvmtiEnvBase *)_env)-&gt;get_current_contended_monitor(_calling_thread, (JavaThread *)target, _owned_monitor_ptr);
1562 }
1563 
1564 void
1565 VM_GetStackTrace::doit() {
1566   _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1567   ThreadsListHandle tlh;
1568   if (_java_thread != NULL &amp;&amp; tlh.includes(_java_thread)
1569       &amp;&amp; !_java_thread-&gt;is_exiting() &amp;&amp; _java_thread-&gt;threadObj() != NULL) {
1570     _result = ((JvmtiEnvBase *)_env)-&gt;get_stack_trace(_java_thread,
1571                                                       _start_depth, _max_count,
1572                                                       _frame_buffer, _count_ptr);
1573   }
1574 }
1575 
1576 void
1577 VM_GetFrameCount::doit() {
1578   _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1579   JavaThread* jt = _state-&gt;get_thread();
1580   ThreadsListHandle tlh;
1581   if (jt != NULL &amp;&amp; tlh.includes(jt) &amp;&amp; !jt-&gt;is_exiting() &amp;&amp; jt-&gt;threadObj() != NULL) {
1582     _result = ((JvmtiEnvBase*)_env)-&gt;get_frame_count(_state, _count_ptr);
1583   }
1584 }
1585 
1586 void
1587 VM_GetFrameLocation::doit() {
1588   _result = JVMTI_ERROR_THREAD_NOT_ALIVE;
1589   ThreadsListHandle tlh;
1590   if (_java_thread != NULL &amp;&amp; tlh.includes(_java_thread)
1591       &amp;&amp; !_java_thread-&gt;is_exiting() &amp;&amp; _java_thread-&gt;threadObj() != NULL) {
1592     _result = ((JvmtiEnvBase*)_env)-&gt;get_frame_location(_java_thread, _depth,
1593                                                         _method_ptr, _location_ptr);
1594   }
1595 }
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>