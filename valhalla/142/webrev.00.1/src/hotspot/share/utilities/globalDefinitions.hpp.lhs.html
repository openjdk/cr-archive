<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/utilities/globalDefinitions.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_UTILITIES_GLOBALDEFINITIONS_HPP
  26 #define SHARE_UTILITIES_GLOBALDEFINITIONS_HPP
  27 
  28 #include &quot;utilities/compilerWarnings.hpp&quot;
  29 #include &quot;utilities/debug.hpp&quot;
  30 #include &quot;utilities/macros.hpp&quot;
  31 
  32 // Get constants like JVM_T_CHAR and JVM_SIGNATURE_INT, before pulling in &lt;jvm.h&gt;.
  33 #include &quot;classfile_constants.h&quot;
  34 
  35 #include COMPILER_HEADER(utilities/globalDefinitions)
  36 
  37 // Defaults for macros that might be defined per compiler.
  38 #ifndef NOINLINE
  39 #define NOINLINE
  40 #endif
  41 #ifndef ALWAYSINLINE
  42 #define ALWAYSINLINE inline
  43 #endif
  44 
  45 #ifndef ATTRIBUTE_ALIGNED
  46 #define ATTRIBUTE_ALIGNED(x)
  47 #endif
  48 
  49 // These are #defines to selectively turn on/off the Print(Opto)Assembly
  50 // capabilities. Choices should be led by a tradeoff between
  51 // code size and improved supportability.
  52 // if PRINT_ASSEMBLY then PRINT_ABSTRACT_ASSEMBLY must be true as well
  53 // to have a fallback in case hsdis is not available.
  54 #if defined(PRODUCT)
  55   #define SUPPORT_ABSTRACT_ASSEMBLY
  56   #define SUPPORT_ASSEMBLY
  57   #undef  SUPPORT_OPTO_ASSEMBLY      // Can&#39;t activate. In PRODUCT, many dump methods are missing.
  58   #undef  SUPPORT_DATA_STRUCTS       // Of limited use. In PRODUCT, many print methods are empty.
  59 #else
  60   #define SUPPORT_ABSTRACT_ASSEMBLY
  61   #define SUPPORT_ASSEMBLY
  62   #define SUPPORT_OPTO_ASSEMBLY
  63   #define SUPPORT_DATA_STRUCTS
  64 #endif
  65 #if defined(SUPPORT_ASSEMBLY) &amp;&amp; !defined(SUPPORT_ABSTRACT_ASSEMBLY)
  66   #define SUPPORT_ABSTRACT_ASSEMBLY
  67 #endif
  68 
  69 // This file holds all globally used constants &amp; types, class (forward)
  70 // declarations and a few frequently used utility functions.
  71 
  72 // Declare the named class to be noncopyable.  This macro must be used in
  73 // a private part of the class&#39;s definition, followed by a semi-colon.
  74 // Doing so provides private declarations for the class&#39;s copy constructor
  75 // and assignment operator.  Because these operations are private, most
  76 // potential callers will fail to compile because they are inaccessible.
  77 // The operations intentionally lack a definition, to provoke link-time
  78 // failures for calls from contexts where they are accessible, e.g. from
  79 // within the class or from a friend of the class.
  80 // Note: The lack of definitions is still not completely bullet-proof, as
  81 // an apparent call might be optimized away by copy elision.
  82 // For C++11 the declarations should be changed to deleted definitions.
  83 #define NONCOPYABLE(C) C(C const&amp;); C&amp; operator=(C const&amp;) /* next token must be ; */
  84 
  85 //----------------------------------------------------------------------------------------------------
  86 // Printf-style formatters for fixed- and variable-width types as pointers and
  87 // integers.  These are derived from the definitions in inttypes.h.  If the platform
  88 // doesn&#39;t provide appropriate definitions, they should be provided in
  89 // the compiler-specific definitions file (e.g., globalDefinitions_gcc.hpp)
  90 
  91 #define BOOL_TO_STR(_b_) ((_b_) ? &quot;true&quot; : &quot;false&quot;)
  92 
  93 // Format 32-bit quantities.
  94 #define INT32_FORMAT           &quot;%&quot; PRId32
  95 #define UINT32_FORMAT          &quot;%&quot; PRIu32
  96 #define INT32_FORMAT_W(width)  &quot;%&quot; #width PRId32
  97 #define UINT32_FORMAT_W(width) &quot;%&quot; #width PRIu32
  98 
  99 #define PTR32_FORMAT           &quot;0x%08&quot; PRIx32
 100 #define PTR32_FORMAT_W(width)  &quot;0x%&quot; #width PRIx32
 101 
 102 // Format 64-bit quantities.
 103 #define INT64_FORMAT           &quot;%&quot; PRId64
 104 #define UINT64_FORMAT          &quot;%&quot; PRIu64
 105 #define UINT64_FORMAT_X        &quot;%&quot; PRIx64
 106 #define INT64_FORMAT_W(width)  &quot;%&quot; #width PRId64
 107 #define UINT64_FORMAT_W(width) &quot;%&quot; #width PRIu64
 108 #define UINT64_FORMAT_X_W(width) &quot;%&quot; #width PRIx64
 109 
 110 #define PTR64_FORMAT           &quot;0x%016&quot; PRIx64
 111 
 112 // Format jlong, if necessary
 113 #ifndef JLONG_FORMAT
 114 #define JLONG_FORMAT           INT64_FORMAT
 115 #endif
 116 #ifndef JLONG_FORMAT_W
 117 #define JLONG_FORMAT_W(width)  INT64_FORMAT_W(width)
 118 #endif
 119 #ifndef JULONG_FORMAT
 120 #define JULONG_FORMAT          UINT64_FORMAT
 121 #endif
 122 #ifndef JULONG_FORMAT_X
 123 #define JULONG_FORMAT_X        UINT64_FORMAT_X
 124 #endif
 125 
 126 // Format pointers which change size between 32- and 64-bit.
 127 #ifdef  _LP64
 128 #define INTPTR_FORMAT &quot;0x%016&quot; PRIxPTR
 129 #define PTR_FORMAT    &quot;0x%016&quot; PRIxPTR
 130 #else   // !_LP64
 131 #define INTPTR_FORMAT &quot;0x%08&quot;  PRIxPTR
 132 #define PTR_FORMAT    &quot;0x%08&quot;  PRIxPTR
 133 #endif  // _LP64
 134 
 135 // Format pointers without leading zeros
 136 #define INTPTRNZ_FORMAT &quot;0x%&quot;  PRIxPTR
 137 
 138 #define INTPTR_FORMAT_W(width)   &quot;%&quot; #width PRIxPTR
 139 
 140 #define SSIZE_FORMAT             &quot;%&quot;   PRIdPTR
 141 #define SIZE_FORMAT              &quot;%&quot;   PRIuPTR
 142 #define SIZE_FORMAT_HEX          &quot;0x%&quot; PRIxPTR
 143 #define SSIZE_FORMAT_W(width)    &quot;%&quot;   #width PRIdPTR
 144 #define SIZE_FORMAT_W(width)     &quot;%&quot;   #width PRIuPTR
 145 #define SIZE_FORMAT_HEX_W(width) &quot;0x%&quot; #width PRIxPTR
 146 
 147 #define INTX_FORMAT           &quot;%&quot; PRIdPTR
 148 #define UINTX_FORMAT          &quot;%&quot; PRIuPTR
 149 #define INTX_FORMAT_W(width)  &quot;%&quot; #width PRIdPTR
 150 #define UINTX_FORMAT_W(width) &quot;%&quot; #width PRIuPTR
 151 
 152 //----------------------------------------------------------------------------------------------------
 153 // Constants
 154 
 155 const int LogBytesPerShort   = 1;
 156 const int LogBytesPerInt     = 2;
 157 #ifdef _LP64
 158 const int LogBytesPerWord    = 3;
 159 #else
 160 const int LogBytesPerWord    = 2;
 161 #endif
 162 const int LogBytesPerLong    = 3;
 163 
 164 const int BytesPerShort      = 1 &lt;&lt; LogBytesPerShort;
 165 const int BytesPerInt        = 1 &lt;&lt; LogBytesPerInt;
 166 const int BytesPerWord       = 1 &lt;&lt; LogBytesPerWord;
 167 const int BytesPerLong       = 1 &lt;&lt; LogBytesPerLong;
 168 
 169 const int LogBitsPerByte     = 3;
 170 const int LogBitsPerShort    = LogBitsPerByte + LogBytesPerShort;
 171 const int LogBitsPerInt      = LogBitsPerByte + LogBytesPerInt;
 172 const int LogBitsPerWord     = LogBitsPerByte + LogBytesPerWord;
 173 const int LogBitsPerLong     = LogBitsPerByte + LogBytesPerLong;
 174 
 175 const int BitsPerByte        = 1 &lt;&lt; LogBitsPerByte;
 176 const int BitsPerShort       = 1 &lt;&lt; LogBitsPerShort;
 177 const int BitsPerInt         = 1 &lt;&lt; LogBitsPerInt;
 178 const int BitsPerWord        = 1 &lt;&lt; LogBitsPerWord;
 179 const int BitsPerLong        = 1 &lt;&lt; LogBitsPerLong;
 180 
 181 const int WordAlignmentMask  = (1 &lt;&lt; LogBytesPerWord) - 1;
 182 const int LongAlignmentMask  = (1 &lt;&lt; LogBytesPerLong) - 1;
 183 
 184 const int WordsPerLong       = 2;       // Number of stack entries for longs
 185 
 186 const int oopSize            = sizeof(char*); // Full-width oop
 187 extern int heapOopSize;                       // Oop within a java object
 188 const int wordSize           = sizeof(char*);
 189 const int longSize           = sizeof(jlong);
 190 const int jintSize           = sizeof(jint);
 191 const int size_tSize         = sizeof(size_t);
 192 
 193 const int BytesPerOop        = BytesPerWord;  // Full-width oop
 194 
 195 extern int LogBytesPerHeapOop;                // Oop within a java object
 196 extern int LogBitsPerHeapOop;
 197 extern int BytesPerHeapOop;
 198 extern int BitsPerHeapOop;
 199 
 200 const int BitsPerJavaInteger = 32;
 201 const int BitsPerJavaLong    = 64;
 202 const int BitsPerSize_t      = size_tSize * BitsPerByte;
 203 
 204 // Size of a char[] needed to represent a jint as a string in decimal.
 205 const int jintAsStringSize = 12;
 206 
 207 // An opaque type, so that HeapWord* can be a generic pointer into the heap.
 208 // We require that object sizes be measured in units of heap words (e.g.
 209 // pointer-sized values), so that given HeapWord* hw,
 210 //   hw += oop(hw)-&gt;foo();
 211 // works, where foo is a method (like size or scavenge) that returns the
 212 // object size.
 213 class HeapWordImpl;             // Opaque, never defined.
 214 typedef HeapWordImpl* HeapWord;
 215 
 216 // Analogous opaque struct for metadata allocated from metaspaces.
 217 class MetaWordImpl;             // Opaque, never defined.
 218 typedef MetaWordImpl* MetaWord;
 219 
 220 // HeapWordSize must be 2^LogHeapWordSize.
 221 const int HeapWordSize        = sizeof(HeapWord);
 222 #ifdef _LP64
 223 const int LogHeapWordSize     = 3;
 224 #else
 225 const int LogHeapWordSize     = 2;
 226 #endif
 227 const int HeapWordsPerLong    = BytesPerLong / HeapWordSize;
 228 const int LogHeapWordsPerLong = LogBytesPerLong - LogHeapWordSize;
 229 
 230 // The minimum number of native machine words necessary to contain &quot;byte_size&quot;
 231 // bytes.
 232 inline size_t heap_word_size(size_t byte_size) {
 233   return (byte_size + (HeapWordSize-1)) &gt;&gt; LogHeapWordSize;
 234 }
 235 
 236 //-------------------------------------------
 237 // Constant for jlong (standardized by C++11)
 238 
 239 // Build a 64bit integer constant
 240 #define CONST64(x)  (x ## LL)
 241 #define UCONST64(x) (x ## ULL)
 242 
 243 const jlong min_jlong = CONST64(0x8000000000000000);
 244 const jlong max_jlong = CONST64(0x7fffffffffffffff);
 245 
 246 const size_t K                  = 1024;
 247 const size_t M                  = K*K;
 248 const size_t G                  = M*K;
 249 const size_t HWperKB            = K / sizeof(HeapWord);
 250 
 251 // Constants for converting from a base unit to milli-base units.  For
 252 // example from seconds to milliseconds and microseconds
 253 
 254 const int MILLIUNITS    = 1000;         // milli units per base unit
 255 const int MICROUNITS    = 1000000;      // micro units per base unit
 256 const int NANOUNITS     = 1000000000;   // nano units per base unit
 257 const int NANOUNITS_PER_MILLIUNIT = NANOUNITS / MILLIUNITS;
 258 
 259 const jlong NANOSECS_PER_SEC      = CONST64(1000000000);
 260 const jint  NANOSECS_PER_MILLISEC = 1000000;
 261 
 262 
 263 // Unit conversion functions
 264 // The caller is responsible for considering overlow.
 265 
 266 inline int64_t nanos_to_millis(int64_t nanos) {
 267   return nanos / NANOUNITS_PER_MILLIUNIT;
 268 }
 269 inline int64_t millis_to_nanos(int64_t millis) {
 270   return millis * NANOUNITS_PER_MILLIUNIT;
 271 }
 272 
 273 // Proper units routines try to maintain at least three significant digits.
 274 // In worst case, it would print five significant digits with lower prefix.
 275 // G is close to MAX_SIZE on 32-bit platforms, so its product can easily overflow,
 276 // and therefore we need to be careful.
 277 
 278 inline const char* proper_unit_for_byte_size(size_t s) {
 279 #ifdef _LP64
 280   if (s &gt;= 100*G) {
 281     return &quot;G&quot;;
 282   }
 283 #endif
 284   if (s &gt;= 100*M) {
 285     return &quot;M&quot;;
 286   } else if (s &gt;= 100*K) {
 287     return &quot;K&quot;;
 288   } else {
 289     return &quot;B&quot;;
 290   }
 291 }
 292 
 293 template &lt;class T&gt;
 294 inline T byte_size_in_proper_unit(T s) {
 295 #ifdef _LP64
 296   if (s &gt;= 100*G) {
 297     return (T)(s/G);
 298   }
 299 #endif
 300   if (s &gt;= 100*M) {
 301     return (T)(s/M);
 302   } else if (s &gt;= 100*K) {
 303     return (T)(s/K);
 304   } else {
 305     return s;
 306   }
 307 }
 308 
 309 inline const char* exact_unit_for_byte_size(size_t s) {
 310 #ifdef _LP64
 311   if (s &gt;= G &amp;&amp; (s % G) == 0) {
 312     return &quot;G&quot;;
 313   }
 314 #endif
 315   if (s &gt;= M &amp;&amp; (s % M) == 0) {
 316     return &quot;M&quot;;
 317   }
 318   if (s &gt;= K &amp;&amp; (s % K) == 0) {
 319     return &quot;K&quot;;
 320   }
 321   return &quot;B&quot;;
 322 }
 323 
 324 inline size_t byte_size_in_exact_unit(size_t s) {
 325 #ifdef _LP64
 326   if (s &gt;= G &amp;&amp; (s % G) == 0) {
 327     return s / G;
 328   }
 329 #endif
 330   if (s &gt;= M &amp;&amp; (s % M) == 0) {
 331     return s / M;
 332   }
 333   if (s &gt;= K &amp;&amp; (s % K) == 0) {
 334     return s / K;
 335   }
 336   return s;
 337 }
 338 
 339 // Memory size transition formatting.
 340 
 341 #define HEAP_CHANGE_FORMAT &quot;%s: &quot; SIZE_FORMAT &quot;K(&quot; SIZE_FORMAT &quot;K)-&gt;&quot; SIZE_FORMAT &quot;K(&quot; SIZE_FORMAT &quot;K)&quot;
 342 
 343 #define HEAP_CHANGE_FORMAT_ARGS(_name_, _prev_used_, _prev_capacity_, _used_, _capacity_) \
 344   (_name_), (_prev_used_) / K, (_prev_capacity_) / K, (_used_) / K, (_capacity_) / K
 345 
 346 //----------------------------------------------------------------------------------------------------
 347 // VM type definitions
 348 
 349 // intx and uintx are the &#39;extended&#39; int and &#39;extended&#39; unsigned int types;
 350 // they are 32bit wide on a 32-bit platform, and 64bit wide on a 64bit platform.
 351 
 352 typedef intptr_t  intx;
 353 typedef uintptr_t uintx;
 354 
 355 const intx  min_intx  = (intx)1 &lt;&lt; (sizeof(intx)*BitsPerByte-1);
 356 const intx  max_intx  = (uintx)min_intx - 1;
 357 const uintx max_uintx = (uintx)-1;
 358 
 359 // Table of values:
 360 //      sizeof intx         4               8
 361 // min_intx             0x80000000      0x8000000000000000
 362 // max_intx             0x7FFFFFFF      0x7FFFFFFFFFFFFFFF
 363 // max_uintx            0xFFFFFFFF      0xFFFFFFFFFFFFFFFF
 364 
 365 typedef unsigned int uint;   NEEDS_CLEANUP
 366 
 367 
 368 //----------------------------------------------------------------------------------------------------
 369 // Java type definitions
 370 
 371 // All kinds of &#39;plain&#39; byte addresses
 372 typedef   signed char s_char;
 373 typedef unsigned char u_char;
 374 typedef u_char*       address;
 375 typedef uintptr_t     address_word; // unsigned integer which will hold a pointer
 376                                     // except for some implementations of a C++
 377                                     // linkage pointer to function. Should never
 378                                     // need one of those to be placed in this
 379                                     // type anyway.
 380 
 381 //  Utility functions to &quot;portably&quot; (?) bit twiddle pointers
 382 //  Where portable means keep ANSI C++ compilers quiet
 383 
 384 inline address       set_address_bits(address x, int m)       { return address(intptr_t(x) | m); }
 385 inline address       clear_address_bits(address x, int m)     { return address(intptr_t(x) &amp; ~m); }
 386 
 387 //  Utility functions to &quot;portably&quot; make cast to/from function pointers.
 388 
 389 inline address_word  mask_address_bits(address x, int m)      { return address_word(x) &amp; m; }
 390 inline address_word  castable_address(address x)              { return address_word(x) ; }
 391 inline address_word  castable_address(void* x)                { return address_word(x) ; }
 392 
 393 // Pointer subtraction.
 394 // The idea here is to avoid ptrdiff_t, which is signed and so doesn&#39;t have
 395 // the range we might need to find differences from one end of the heap
 396 // to the other.
 397 // A typical use might be:
 398 //     if (pointer_delta(end(), top()) &gt;= size) {
 399 //       // enough room for an object of size
 400 //       ...
 401 // and then additions like
 402 //       ... top() + size ...
 403 // are safe because we know that top() is at least size below end().
 404 inline size_t pointer_delta(const volatile void* left,
 405                             const volatile void* right,
 406                             size_t element_size) {
 407   return (((uintptr_t) left) - ((uintptr_t) right)) / element_size;
 408 }
 409 
 410 // A version specialized for HeapWord*&#39;s.
 411 inline size_t pointer_delta(const HeapWord* left, const HeapWord* right) {
 412   return pointer_delta(left, right, sizeof(HeapWord));
 413 }
 414 // A version specialized for MetaWord*&#39;s.
 415 inline size_t pointer_delta(const MetaWord* left, const MetaWord* right) {
 416   return pointer_delta(left, right, sizeof(MetaWord));
 417 }
 418 
 419 //
 420 // ANSI C++ does not allow casting from one pointer type to a function pointer
 421 // directly without at best a warning. This macro accomplishes it silently
 422 // In every case that is present at this point the value be cast is a pointer
 423 // to a C linkage function. In some case the type used for the cast reflects
 424 // that linkage and a picky compiler would not complain. In other cases because
 425 // there is no convenient place to place a typedef with extern C linkage (i.e
 426 // a platform dependent header file) it doesn&#39;t. At this point no compiler seems
 427 // picky enough to catch these instances (which are few). It is possible that
 428 // using templates could fix these for all cases. This use of templates is likely
 429 // so far from the middle of the road that it is likely to be problematic in
 430 // many C++ compilers.
 431 //
 432 #define CAST_TO_FN_PTR(func_type, value) (reinterpret_cast&lt;func_type&gt;(value))
 433 #define CAST_FROM_FN_PTR(new_type, func_ptr) ((new_type)((address_word)(func_ptr)))
 434 
 435 // Need the correct linkage to call qsort without warnings
 436 extern &quot;C&quot; {
 437   typedef int (*_sort_Fn)(const void *, const void *);
 438 }
 439 
 440 // Unsigned byte types for os and stream.hpp
 441 
 442 // Unsigned one, two, four and eigth byte quantities used for describing
 443 // the .class file format. See JVM book chapter 4.
 444 
 445 typedef jubyte  u1;
 446 typedef jushort u2;
 447 typedef juint   u4;
 448 typedef julong  u8;
 449 
 450 const jubyte  max_jubyte  = (jubyte)-1;  // 0xFF       largest jubyte
 451 const jushort max_jushort = (jushort)-1; // 0xFFFF     largest jushort
 452 const juint   max_juint   = (juint)-1;   // 0xFFFFFFFF largest juint
 453 const julong  max_julong  = (julong)-1;  // 0xFF....FF largest julong
 454 
 455 typedef jbyte  s1;
 456 typedef jshort s2;
 457 typedef jint   s4;
 458 typedef jlong  s8;
 459 
 460 const jbyte min_jbyte = -(1 &lt;&lt; 7);       // smallest jbyte
 461 const jbyte max_jbyte = (1 &lt;&lt; 7) - 1;    // largest jbyte
 462 const jshort min_jshort = -(1 &lt;&lt; 15);    // smallest jshort
 463 const jshort max_jshort = (1 &lt;&lt; 15) - 1; // largest jshort
 464 
 465 const jint min_jint = (jint)1 &lt;&lt; (sizeof(jint)*BitsPerByte-1); // 0x80000000 == smallest jint
 466 const jint max_jint = (juint)min_jint - 1;                     // 0x7FFFFFFF == largest jint
 467 
 468 //----------------------------------------------------------------------------------------------------
 469 // JVM spec restrictions
 470 
 471 const int max_method_code_size = 64*K - 1;  // JVM spec, 2nd ed. section 4.8.1 (p.134)
 472 
 473 //----------------------------------------------------------------------------------------------------
 474 // Object alignment, in units of HeapWords.
 475 //
 476 // Minimum is max(BytesPerLong, BytesPerDouble, BytesPerOop) / HeapWordSize, so jlong, jdouble and
 477 // reference fields can be naturally aligned.
 478 
 479 extern int MinObjAlignment;
 480 extern int MinObjAlignmentInBytes;
 481 extern int MinObjAlignmentInBytesMask;
 482 
 483 extern int LogMinObjAlignment;
 484 extern int LogMinObjAlignmentInBytes;
 485 
 486 const int LogKlassAlignmentInBytes = 3;
 487 const int LogKlassAlignment        = LogKlassAlignmentInBytes - LogHeapWordSize;
 488 const int KlassAlignmentInBytes    = 1 &lt;&lt; LogKlassAlignmentInBytes;
 489 const int KlassAlignment           = KlassAlignmentInBytes / HeapWordSize;
 490 
 491 // Maximal size of heap where unscaled compression can be used. Also upper bound
 492 // for heap placement: 4GB.
 493 const  uint64_t UnscaledOopHeapMax = (uint64_t(max_juint) + 1);
 494 // Maximal size of heap where compressed oops can be used. Also upper bound for heap
 495 // placement for zero based compression algorithm: UnscaledOopHeapMax &lt;&lt; LogMinObjAlignmentInBytes.
 496 extern uint64_t OopEncodingHeapMax;
 497 
 498 // Maximal size of compressed class space. Above this limit compression is not possible.
 499 // Also upper bound for placement of zero based class space. (Class space is further limited
 500 // to be &lt; 3G, see arguments.cpp.)
 501 const  uint64_t KlassEncodingMetaspaceMax = (uint64_t(max_juint) + 1) &lt;&lt; LogKlassAlignmentInBytes;
 502 
 503 // Machine dependent stuff
 504 
 505 // The maximum size of the code cache.  Can be overridden by targets.
 506 #define CODE_CACHE_SIZE_LIMIT (2*G)
 507 // Allow targets to reduce the default size of the code cache.
 508 #define CODE_CACHE_DEFAULT_LIMIT CODE_CACHE_SIZE_LIMIT
 509 
 510 #include CPU_HEADER(globalDefinitions)
 511 
 512 // To assure the IRIW property on processors that are not multiple copy
 513 // atomic, sync instructions must be issued between volatile reads to
 514 // assure their ordering, instead of after volatile stores.
 515 // (See &quot;A Tutorial Introduction to the ARM and POWER Relaxed Memory Models&quot;
 516 // by Luc Maranget, Susmit Sarkar and Peter Sewell, INRIA/Cambridge)
 517 #ifdef CPU_MULTI_COPY_ATOMIC
 518 // Not needed.
 519 const bool support_IRIW_for_not_multiple_copy_atomic_cpu = false;
 520 #else
 521 // From all non-multi-copy-atomic architectures, only PPC64 supports IRIW at the moment.
 522 // Final decision is subject to JEP 188: Java Memory Model Update.
 523 const bool support_IRIW_for_not_multiple_copy_atomic_cpu = PPC64_ONLY(true) NOT_PPC64(false);
 524 #endif
 525 
 526 // The expected size in bytes of a cache line, used to pad data structures.
 527 #ifndef DEFAULT_CACHE_LINE_SIZE
 528   #define DEFAULT_CACHE_LINE_SIZE 64
 529 #endif
 530 
 531 
 532 //----------------------------------------------------------------------------------------------------
 533 // Utility macros for compilers
 534 // used to silence compiler warnings
 535 
 536 #define Unused_Variable(var) var
 537 
 538 
<a name="1" id="anc1"></a>








 539 //----------------------------------------------------------------------------------------------------
 540 // Miscellaneous
 541 
 542 // 6302670 Eliminate Hotspot __fabsf dependency
 543 // All fabs() callers should call this function instead, which will implicitly
 544 // convert the operand to double, avoiding a dependency on __fabsf which
 545 // doesn&#39;t exist in early versions of Solaris 8.
 546 inline double fabsd(double value) {
 547   return fabs(value);
 548 }
 549 
 550 // Returns numerator/denominator as percentage value from 0 to 100. If denominator
 551 // is zero, return 0.0.
 552 template&lt;typename T&gt;
 553 inline double percent_of(T numerator, T denominator) {
 554   return denominator != 0 ? (double)numerator / denominator * 100.0 : 0.0;
 555 }
 556 
 557 //----------------------------------------------------------------------------------------------------
 558 // Special casts
 559 // Cast floats into same-size integers and vice-versa w/o changing bit-pattern
 560 typedef union {
 561   jfloat f;
 562   jint i;
 563 } FloatIntConv;
 564 
 565 typedef union {
 566   jdouble d;
 567   jlong l;
 568   julong ul;
 569 } DoubleLongConv;
 570 
 571 inline jint    jint_cast    (jfloat  x)  { return ((FloatIntConv*)&amp;x)-&gt;i; }
 572 inline jfloat  jfloat_cast  (jint    x)  { return ((FloatIntConv*)&amp;x)-&gt;f; }
 573 
 574 inline jlong   jlong_cast   (jdouble x)  { return ((DoubleLongConv*)&amp;x)-&gt;l;  }
 575 inline julong  julong_cast  (jdouble x)  { return ((DoubleLongConv*)&amp;x)-&gt;ul; }
 576 inline jdouble jdouble_cast (jlong   x)  { return ((DoubleLongConv*)&amp;x)-&gt;d;  }
 577 
 578 inline jint low (jlong value)                    { return jint(value); }
 579 inline jint high(jlong value)                    { return jint(value &gt;&gt; 32); }
 580 
 581 // the fancy casts are a hopefully portable way
 582 // to do unsigned 32 to 64 bit type conversion
 583 inline void set_low (jlong* value, jint low )    { *value &amp;= (jlong)0xffffffff &lt;&lt; 32;
 584                                                    *value |= (jlong)(julong)(juint)low; }
 585 
 586 inline void set_high(jlong* value, jint high)    { *value &amp;= (jlong)(julong)(juint)0xffffffff;
 587                                                    *value |= (jlong)high       &lt;&lt; 32; }
 588 
 589 inline jlong jlong_from(jint h, jint l) {
 590   jlong result = 0; // initialization to avoid warning
 591   set_high(&amp;result, h);
 592   set_low(&amp;result,  l);
 593   return result;
 594 }
 595 
 596 union jlong_accessor {
 597   jint  words[2];
 598   jlong long_value;
 599 };
 600 
 601 void basic_types_init(); // cannot define here; uses assert
 602 
 603 
 604 // NOTE: replicated in SA in vm/agent/sun/jvm/hotspot/runtime/BasicType.java
 605 enum BasicType {
 606 // The values T_BOOLEAN..T_LONG (4..11) are derived from the JVMS.
 607   T_BOOLEAN     = JVM_T_BOOLEAN,
 608   T_CHAR        = JVM_T_CHAR,
 609   T_FLOAT       = JVM_T_FLOAT,
 610   T_DOUBLE      = JVM_T_DOUBLE,
 611   T_BYTE        = JVM_T_BYTE,
 612   T_SHORT       = JVM_T_SHORT,
 613   T_INT         = JVM_T_INT,
 614   T_LONG        = JVM_T_LONG,
 615   // The remaining values are not part of any standard.
 616   // T_OBJECT and T_VOID denote two more semantic choices
 617   // for method return values.
 618   // T_OBJECT and T_ARRAY describe signature syntax.
 619   // T_ADDRESS, T_METADATA, T_NARROWOOP, T_NARROWKLASS describe
 620   // internal references within the JVM as if they were Java
 621   // types in their own right.
 622   T_OBJECT      = 12,
 623   T_ARRAY       = 13,
<a name="2" id="anc2"></a><span class="line-modified"> 624   T_VOID        = 14,</span>
<span class="line-modified"> 625   T_ADDRESS     = 15,</span>
<span class="line-modified"> 626   T_NARROWOOP   = 16,</span>
<span class="line-modified"> 627   T_METADATA    = 17,</span>
<span class="line-modified"> 628   T_NARROWKLASS = 18,</span>
<span class="line-modified"> 629   T_CONFLICT    = 19, // for stack value type with conflicting contents</span>

 630   T_ILLEGAL     = 99
 631 };
 632 
 633 #define SIGNATURE_TYPES_DO(F, N)                \
 634     F(JVM_SIGNATURE_BOOLEAN, T_BOOLEAN, N)      \
 635     F(JVM_SIGNATURE_CHAR,    T_CHAR,    N)      \
 636     F(JVM_SIGNATURE_FLOAT,   T_FLOAT,   N)      \
 637     F(JVM_SIGNATURE_DOUBLE,  T_DOUBLE,  N)      \
 638     F(JVM_SIGNATURE_BYTE,    T_BYTE,    N)      \
 639     F(JVM_SIGNATURE_SHORT,   T_SHORT,   N)      \
 640     F(JVM_SIGNATURE_INT,     T_INT,     N)      \
 641     F(JVM_SIGNATURE_LONG,    T_LONG,    N)      \
 642     F(JVM_SIGNATURE_CLASS,   T_OBJECT,  N)      \
 643     F(JVM_SIGNATURE_ARRAY,   T_ARRAY,   N)      \
<a name="3" id="anc3"></a>
 644     F(JVM_SIGNATURE_VOID,    T_VOID,    N)      \
 645     /*end*/
 646 
 647 inline bool is_java_type(BasicType t) {
 648   return T_BOOLEAN &lt;= t &amp;&amp; t &lt;= T_VOID;
 649 }
 650 
 651 inline bool is_java_primitive(BasicType t) {
 652   return T_BOOLEAN &lt;= t &amp;&amp; t &lt;= T_LONG;
 653 }
 654 
 655 inline bool is_subword_type(BasicType t) {
 656   // these guys are processed exactly like T_INT in calling sequences:
 657   return (t == T_BOOLEAN || t == T_CHAR || t == T_BYTE || t == T_SHORT);
 658 }
 659 
 660 inline bool is_signed_subword_type(BasicType t) {
 661   return (t == T_BYTE || t == T_SHORT);
 662 }
 663 
 664 inline bool is_double_word_type(BasicType t) {
 665   return (t == T_DOUBLE || t == T_LONG);
 666 }
 667 
 668 inline bool is_reference_type(BasicType t) {
<a name="4" id="anc4"></a><span class="line-modified"> 669   return (t == T_OBJECT || t == T_ARRAY);</span>
 670 }
 671 
 672 extern char type2char_tab[T_CONFLICT+1];     // Map a BasicType to a jchar
 673 inline char type2char(BasicType t) { return (uint)t &lt; T_CONFLICT+1 ? type2char_tab[t] : 0; }
 674 extern int type2size[T_CONFLICT+1];         // Map BasicType to result stack elements
 675 extern const char* type2name_tab[T_CONFLICT+1];     // Map a BasicType to a jchar
 676 inline const char* type2name(BasicType t) { return (uint)t &lt; T_CONFLICT+1 ? type2name_tab[t] : NULL; }
 677 extern BasicType name2type(const char* name);
 678 
 679 // Auxiliary math routines
 680 // least common multiple
 681 extern size_t lcm(size_t a, size_t b);
 682 
 683 
 684 // NOTE: replicated in SA in vm/agent/sun/jvm/hotspot/runtime/BasicType.java
 685 enum BasicTypeSize {
 686   T_BOOLEAN_size     = 1,
 687   T_CHAR_size        = 1,
 688   T_FLOAT_size       = 1,
 689   T_DOUBLE_size      = 2,
 690   T_BYTE_size        = 1,
 691   T_SHORT_size       = 1,
 692   T_INT_size         = 1,
 693   T_LONG_size        = 2,
 694   T_OBJECT_size      = 1,
 695   T_ARRAY_size       = 1,
 696   T_NARROWOOP_size   = 1,
 697   T_NARROWKLASS_size = 1,
<a name="5" id="anc5"></a><span class="line-modified"> 698   T_VOID_size        = 0</span>

 699 };
 700 
 701 // this works on valid parameter types but not T_VOID, T_CONFLICT, etc.
 702 inline int parameter_type_word_count(BasicType t) {
 703   if (is_double_word_type(t))  return 2;
 704   assert(is_java_primitive(t) || is_reference_type(t), &quot;no goofy types here please&quot;);
 705   assert(type2size[t] == 1, &quot;must be&quot;);
 706   return 1;
 707 }
 708 
 709 // maps a BasicType to its instance field storage type:
 710 // all sub-word integral types are widened to T_INT
 711 extern BasicType type2field[T_CONFLICT+1];
 712 extern BasicType type2wfield[T_CONFLICT+1];
 713 
 714 
 715 // size in bytes
 716 enum ArrayElementSize {
 717   T_BOOLEAN_aelem_bytes     = 1,
 718   T_CHAR_aelem_bytes        = 2,
 719   T_FLOAT_aelem_bytes       = 4,
 720   T_DOUBLE_aelem_bytes      = 8,
 721   T_BYTE_aelem_bytes        = 1,
 722   T_SHORT_aelem_bytes       = 2,
 723   T_INT_aelem_bytes         = 4,
 724   T_LONG_aelem_bytes        = 8,
 725 #ifdef _LP64
 726   T_OBJECT_aelem_bytes      = 8,
 727   T_ARRAY_aelem_bytes       = 8,
<a name="6" id="anc6"></a>
 728 #else
 729   T_OBJECT_aelem_bytes      = 4,
 730   T_ARRAY_aelem_bytes       = 4,
<a name="7" id="anc7"></a>
 731 #endif
 732   T_NARROWOOP_aelem_bytes   = 4,
 733   T_NARROWKLASS_aelem_bytes = 4,
 734   T_VOID_aelem_bytes        = 0
 735 };
 736 
 737 extern int _type2aelembytes[T_CONFLICT+1]; // maps a BasicType to nof bytes used by its array element
 738 #ifdef ASSERT
 739 extern int type2aelembytes(BasicType t, bool allow_address = false); // asserts
 740 #else
 741 inline int type2aelembytes(BasicType t, bool allow_address = false) { return _type2aelembytes[t]; }
 742 #endif
 743 
 744 
 745 // JavaValue serves as a container for arbitrary Java values.
 746 
 747 class JavaValue {
 748 
 749  public:
 750   typedef union JavaCallValue {
 751     jfloat   f;
 752     jdouble  d;
 753     jint     i;
 754     jlong    l;
 755     jobject  h;
 756   } JavaCallValue;
 757 
 758  private:
 759   BasicType _type;
 760   JavaCallValue _value;
 761 
 762  public:
 763   JavaValue(BasicType t = T_ILLEGAL) { _type = t; }
 764 
 765   JavaValue(jfloat value) {
 766     _type    = T_FLOAT;
 767     _value.f = value;
 768   }
 769 
 770   JavaValue(jdouble value) {
 771     _type    = T_DOUBLE;
 772     _value.d = value;
 773   }
 774 
 775  jfloat get_jfloat() const { return _value.f; }
 776  jdouble get_jdouble() const { return _value.d; }
 777  jint get_jint() const { return _value.i; }
 778  jlong get_jlong() const { return _value.l; }
 779  jobject get_jobject() const { return _value.h; }
 780  JavaCallValue* get_value_addr() { return &amp;_value; }
 781  BasicType get_type() const { return _type; }
 782 
 783  void set_jfloat(jfloat f) { _value.f = f;}
 784  void set_jdouble(jdouble d) { _value.d = d;}
 785  void set_jint(jint i) { _value.i = i;}
 786  void set_jlong(jlong l) { _value.l = l;}
 787  void set_jobject(jobject h) { _value.h = h;}
 788  void set_type(BasicType t) { _type = t; }
 789 
 790  jboolean get_jboolean() const { return (jboolean) (_value.i);}
 791  jbyte get_jbyte() const { return (jbyte) (_value.i);}
 792  jchar get_jchar() const { return (jchar) (_value.i);}
 793  jshort get_jshort() const { return (jshort) (_value.i);}
 794 
 795 };
 796 
 797 
 798 // TosState describes the top-of-stack state before and after the execution of
 799 // a bytecode or method. The top-of-stack value may be cached in one or more CPU
 800 // registers. The TosState corresponds to the &#39;machine representation&#39; of this cached
 801 // value. There&#39;s 4 states corresponding to the JAVA types int, long, float &amp; double
 802 // as well as a 5th state in case the top-of-stack value is actually on the top
 803 // of stack (in memory) and thus not cached. The atos state corresponds to the itos
 804 // state when it comes to machine representation but is used separately for (oop)
 805 // type specific operations (e.g. verification code).
 806 
 807 enum TosState {         // describes the tos cache contents
 808   btos = 0,             // byte, bool tos cached
 809   ztos = 1,             // byte, bool tos cached
 810   ctos = 2,             // char tos cached
 811   stos = 3,             // short tos cached
 812   itos = 4,             // int tos cached
 813   ltos = 5,             // long tos cached
 814   ftos = 6,             // float tos cached
 815   dtos = 7,             // double tos cached
 816   atos = 8,             // object cached
<a name="8" id="anc8"></a><span class="line-modified"> 817   vtos = 9,             // tos not cached</span>
 818   number_of_states,
 819   ilgl                  // illegal state: should not occur
 820 };
 821 
 822 
 823 inline TosState as_TosState(BasicType type) {
 824   switch (type) {
 825     case T_BYTE   : return btos;
 826     case T_BOOLEAN: return ztos;
 827     case T_CHAR   : return ctos;
 828     case T_SHORT  : return stos;
 829     case T_INT    : return itos;
 830     case T_LONG   : return ltos;
 831     case T_FLOAT  : return ftos;
 832     case T_DOUBLE : return dtos;
 833     case T_VOID   : return vtos;
<a name="9" id="anc9"></a><span class="line-modified"> 834     case T_ARRAY  : // fall through</span>

 835     case T_OBJECT : return atos;
 836     default       : return ilgl;
 837   }
 838 }
 839 
 840 inline BasicType as_BasicType(TosState state) {
 841   switch (state) {
 842     case btos : return T_BYTE;
 843     case ztos : return T_BOOLEAN;
 844     case ctos : return T_CHAR;
 845     case stos : return T_SHORT;
 846     case itos : return T_INT;
 847     case ltos : return T_LONG;
 848     case ftos : return T_FLOAT;
 849     case dtos : return T_DOUBLE;
 850     case atos : return T_OBJECT;
 851     case vtos : return T_VOID;
 852     default   : return T_ILLEGAL;
 853   }
 854 }
 855 
 856 
 857 // Helper function to convert BasicType info into TosState
 858 // Note: Cannot define here as it uses global constant at the time being.
 859 TosState as_TosState(BasicType type);
 860 
 861 
 862 // JavaThreadState keeps track of which part of the code a thread is executing in. This
 863 // information is needed by the safepoint code.
 864 //
 865 // There are 4 essential states:
 866 //
 867 //  _thread_new         : Just started, but not executed init. code yet (most likely still in OS init code)
 868 //  _thread_in_native   : In native code. This is a safepoint region, since all oops will be in jobject handles
 869 //  _thread_in_vm       : Executing in the vm
 870 //  _thread_in_Java     : Executing either interpreted or compiled Java code (or could be in a stub)
 871 //
 872 // Each state has an associated xxxx_trans state, which is an intermediate state used when a thread is in
 873 // a transition from one state to another. These extra states makes it possible for the safepoint code to
 874 // handle certain thread_states without having to suspend the thread - making the safepoint code faster.
 875 //
 876 // Given a state, the xxxx_trans state can always be found by adding 1.
 877 //
 878 enum JavaThreadState {
 879   _thread_uninitialized     =  0, // should never happen (missing initialization)
 880   _thread_new               =  2, // just starting up, i.e., in process of being initialized
 881   _thread_new_trans         =  3, // corresponding transition state (not used, included for completness)
 882   _thread_in_native         =  4, // running in native code
 883   _thread_in_native_trans   =  5, // corresponding transition state
 884   _thread_in_vm             =  6, // running in VM
 885   _thread_in_vm_trans       =  7, // corresponding transition state
 886   _thread_in_Java           =  8, // running in Java or in stub code
 887   _thread_in_Java_trans     =  9, // corresponding transition state (not used, included for completness)
 888   _thread_blocked           = 10, // blocked in vm
 889   _thread_blocked_trans     = 11, // corresponding transition state
 890   _thread_max_state         = 12  // maximum thread state+1 - used for statistics allocation
 891 };
 892 
 893 //----------------------------------------------------------------------------------------------------
 894 // Special constants for debugging
 895 
 896 const jint     badInt           = -3;                       // generic &quot;bad int&quot; value
 897 const intptr_t badAddressVal    = -2;                       // generic &quot;bad address&quot; value
 898 const intptr_t badOopVal        = -1;                       // generic &quot;bad oop&quot; value
 899 const intptr_t badHeapOopVal    = (intptr_t) CONST64(0x2BAD4B0BBAADBABE); // value used to zap heap after GC
 900 const int      badStackSegVal   = 0xCA;                     // value used to zap stack segments
 901 const int      badHandleValue   = 0xBC;                     // value used to zap vm handle area
 902 const int      badResourceValue = 0xAB;                     // value used to zap resource area
 903 const int      freeBlockPad     = 0xBA;                     // value used to pad freed blocks.
 904 const int      uninitBlockPad   = 0xF1;                     // value used to zap newly malloc&#39;d blocks.
 905 const juint    uninitMetaWordVal= 0xf7f7f7f7;               // value used to zap newly allocated metachunk
 906 const juint    badHeapWordVal   = 0xBAADBABE;               // value used to zap heap after GC
 907 const juint    badMetaWordVal   = 0xBAADFADE;               // value used to zap metadata heap after GC
 908 const int      badCodeHeapNewVal= 0xCC;                     // value used to zap Code heap at allocation
 909 const int      badCodeHeapFreeVal = 0xDD;                   // value used to zap Code heap at deallocation
 910 
 911 
 912 // (These must be implemented as #defines because C++ compilers are
 913 // not obligated to inline non-integral constants!)
 914 #define       badAddress        ((address)::badAddressVal)
 915 #define       badOop            (cast_to_oop(::badOopVal))
 916 #define       badHeapWord       (::badHeapWordVal)
 917 
 918 // Default TaskQueue size is 16K (32-bit) or 128K (64-bit)
 919 #define TASKQUEUE_SIZE (NOT_LP64(1&lt;&lt;14) LP64_ONLY(1&lt;&lt;17))
 920 
 921 //----------------------------------------------------------------------------------------------------
 922 // Utility functions for bitfield manipulations
 923 
 924 const intptr_t AllBits    = ~0; // all bits set in a word
 925 const intptr_t NoBits     =  0; // no bits set in a word
 926 const jlong    NoLongBits =  0; // no bits set in a long
 927 const intptr_t OneBit     =  1; // only right_most bit set in a word
 928 
 929 // get a word with the n.th or the right-most or left-most n bits set
 930 // (note: #define used only so that they can be used in enum constant definitions)
 931 #define nth_bit(n)        (((n) &gt;= BitsPerWord) ? 0 : (OneBit &lt;&lt; (n)))
 932 #define right_n_bits(n)   (nth_bit(n) - 1)
 933 #define left_n_bits(n)    (right_n_bits(n) &lt;&lt; (((n) &gt;= BitsPerWord) ? 0 : (BitsPerWord - (n))))
 934 
 935 // bit-operations using a mask m
 936 inline void   set_bits    (intptr_t&amp; x, intptr_t m) { x |= m; }
 937 inline void clear_bits    (intptr_t&amp; x, intptr_t m) { x &amp;= ~m; }
 938 inline intptr_t mask_bits      (intptr_t  x, intptr_t m) { return x &amp; m; }
 939 inline jlong    mask_long_bits (jlong     x, jlong    m) { return x &amp; m; }
 940 inline bool mask_bits_are_true (intptr_t flags, intptr_t mask) { return (flags &amp; mask) == mask; }
 941 
 942 // bit-operations using the n.th bit
 943 inline void    set_nth_bit(intptr_t&amp; x, int n) { set_bits  (x, nth_bit(n)); }
 944 inline void  clear_nth_bit(intptr_t&amp; x, int n) { clear_bits(x, nth_bit(n)); }
 945 inline bool is_set_nth_bit(intptr_t  x, int n) { return mask_bits (x, nth_bit(n)) != NoBits; }
 946 
 947 // returns the bitfield of x starting at start_bit_no with length field_length (no sign-extension!)
 948 inline intptr_t bitfield(intptr_t x, int start_bit_no, int field_length) {
 949   return mask_bits(x &gt;&gt; start_bit_no, right_n_bits(field_length));
 950 }
 951 
 952 
 953 //----------------------------------------------------------------------------------------------------
 954 // Utility functions for integers
 955 
 956 // Avoid use of global min/max macros which may cause unwanted double
 957 // evaluation of arguments.
 958 #ifdef max
 959 #undef max
 960 #endif
 961 
 962 #ifdef min
 963 #undef min
 964 #endif
 965 
 966 // It is necessary to use templates here. Having normal overloaded
 967 // functions does not work because it is necessary to provide both 32-
 968 // and 64-bit overloaded functions, which does not work, and having
 969 // explicitly-typed versions of these routines (i.e., MAX2I, MAX2L)
 970 // will be even more error-prone than macros.
 971 template&lt;class T&gt; inline T MAX2(T a, T b)           { return (a &gt; b) ? a : b; }
 972 template&lt;class T&gt; inline T MIN2(T a, T b)           { return (a &lt; b) ? a : b; }
 973 template&lt;class T&gt; inline T MAX3(T a, T b, T c)      { return MAX2(MAX2(a, b), c); }
 974 template&lt;class T&gt; inline T MIN3(T a, T b, T c)      { return MIN2(MIN2(a, b), c); }
 975 template&lt;class T&gt; inline T MAX4(T a, T b, T c, T d) { return MAX2(MAX3(a, b, c), d); }
 976 template&lt;class T&gt; inline T MIN4(T a, T b, T c, T d) { return MIN2(MIN3(a, b, c), d); }
 977 
 978 template&lt;class T&gt; inline T ABS(T x)                 { return (x &gt; 0) ? x : -x; }
 979 
 980 // Return the given value clamped to the range [min ... max]
 981 template&lt;typename T&gt;
 982 inline T clamp(T value, T min, T max) {
 983   assert(min &lt;= max, &quot;must be&quot;);
 984   return MIN2(MAX2(value, min), max);
 985 }
 986 
 987 // Returns largest i such that 2^i &lt;= x.
 988 // If x == 0, the function returns -1.
 989 inline int log2_intptr(uintptr_t x) {
 990   int i = -1;
 991   uintptr_t p = 1;
 992   while (p != 0 &amp;&amp; p &lt;= x) {
 993     // p = 2^(i+1) &amp;&amp; p &lt;= x (i.e., 2^(i+1) &lt;= x)
 994     i++; p *= 2;
 995   }
 996   // p = 2^(i+1) &amp;&amp; x &lt; p (i.e., 2^i &lt;= x &lt; 2^(i+1))
 997   // If p = 0, overflow has occurred and i = 31 or i = 63 (depending on the machine word size).
 998   return i;
 999 }
1000 
1001 //* largest i such that 2^i &lt;= x
1002 inline int log2_long(julong x) {
1003   int i = -1;
1004   julong p =  1;
1005   while (p != 0 &amp;&amp; p &lt;= x) {
1006     // p = 2^(i+1) &amp;&amp; p &lt;= x (i.e., 2^(i+1) &lt;= x)
1007     i++; p *= 2;
1008   }
1009   // p = 2^(i+1) &amp;&amp; x &lt; p (i.e., 2^i &lt;= x &lt; 2^(i+1))
1010   // (if p = 0 then overflow occurred and i = 63)
1011   return i;
1012 }
1013 
1014 // If x &lt; 0, the function returns 31 on a 32-bit machine and 63 on a 64-bit machine.
1015 inline int log2_intptr(intptr_t x) {
1016   return log2_intptr((uintptr_t)x);
1017 }
1018 
1019 inline int log2_int(int x) {
1020   STATIC_ASSERT(sizeof(int) &lt;= sizeof(uintptr_t));
1021   return log2_intptr((uintptr_t)(unsigned int)x);
1022 }
1023 
1024 inline int log2_jint(jint x) {
1025   STATIC_ASSERT(sizeof(jint) &lt;= sizeof(uintptr_t));
1026   return log2_intptr((uintptr_t)(juint)x);
1027 }
1028 
1029 inline int log2_uint(uint x) {
1030   STATIC_ASSERT(sizeof(uint) &lt;= sizeof(uintptr_t));
1031   return log2_intptr((uintptr_t)x);
1032 }
1033 
1034 //  A negative value of &#39;x&#39; will return &#39;63&#39;
1035 inline int log2_jlong(jlong x) {
1036   STATIC_ASSERT(sizeof(jlong) &lt;= sizeof(julong));
1037   return log2_long((julong)x);
1038 }
1039 
1040 inline bool is_odd (intx x) { return x &amp; 1;      }
1041 inline bool is_even(intx x) { return !is_odd(x); }
1042 
1043 // abs methods which cannot overflow and so are well-defined across
1044 // the entire domain of integer types.
1045 static inline unsigned int uabs(unsigned int n) {
1046   union {
1047     unsigned int result;
1048     int value;
1049   };
1050   result = n;
1051   if (value &lt; 0) result = 0-result;
1052   return result;
1053 }
1054 static inline julong uabs(julong n) {
1055   union {
1056     julong result;
1057     jlong value;
1058   };
1059   result = n;
1060   if (value &lt; 0) result = 0-result;
1061   return result;
1062 }
1063 static inline julong uabs(jlong n) { return uabs((julong)n); }
1064 static inline unsigned int uabs(int n) { return uabs((unsigned int)n); }
1065 
1066 // &quot;to&quot; should be greater than &quot;from.&quot;
1067 inline intx byte_size(void* from, void* to) {
1068   return (address)to - (address)from;
1069 }
1070 
1071 
1072 // Pack and extract shorts to/from ints:
1073 
1074 inline int extract_low_short_from_int(jint x) {
1075   return x &amp; 0xffff;
1076 }
1077 
1078 inline int extract_high_short_from_int(jint x) {
1079   return (x &gt;&gt; 16) &amp; 0xffff;
1080 }
1081 
1082 inline int build_int_from_shorts( jushort low, jushort high ) {
1083   return ((int)((unsigned int)high &lt;&lt; 16) | (unsigned int)low);
1084 }
1085 
1086 // Convert pointer to intptr_t, for use in printing pointers.
1087 inline intptr_t p2i(const void * p) {
1088   return (intptr_t) p;
1089 }
1090 
1091 // swap a &amp; b
1092 template&lt;class T&gt; static void swap(T&amp; a, T&amp; b) {
1093   T tmp = a;
1094   a = b;
1095   b = tmp;
1096 }
1097 
1098 #define ARRAY_SIZE(array) (sizeof(array)/sizeof((array)[0]))
1099 
1100 //----------------------------------------------------------------------------------------------------
1101 // Sum and product which can never overflow: they wrap, just like the
1102 // Java operations.  Note that we don&#39;t intend these to be used for
1103 // general-purpose arithmetic: their purpose is to emulate Java
1104 // operations.
1105 
1106 // The goal of this code to avoid undefined or implementation-defined
1107 // behavior.  The use of an lvalue to reference cast is explicitly
1108 // permitted by Lvalues and rvalues [basic.lval].  [Section 3.10 Para
1109 // 15 in C++03]
1110 #define JAVA_INTEGER_OP(OP, NAME, TYPE, UNSIGNED_TYPE)  \
1111 inline TYPE NAME (TYPE in1, TYPE in2) {                 \
1112   UNSIGNED_TYPE ures = static_cast&lt;UNSIGNED_TYPE&gt;(in1); \
1113   ures OP ## = static_cast&lt;UNSIGNED_TYPE&gt;(in2);         \
1114   return reinterpret_cast&lt;TYPE&amp;&gt;(ures);                 \
1115 }
1116 
1117 JAVA_INTEGER_OP(+, java_add, jint, juint)
1118 JAVA_INTEGER_OP(-, java_subtract, jint, juint)
1119 JAVA_INTEGER_OP(*, java_multiply, jint, juint)
1120 JAVA_INTEGER_OP(+, java_add, jlong, julong)
1121 JAVA_INTEGER_OP(-, java_subtract, jlong, julong)
1122 JAVA_INTEGER_OP(*, java_multiply, jlong, julong)
1123 
1124 #undef JAVA_INTEGER_OP
1125 
1126 // Provide integer shift operations with Java semantics.  No overflow
1127 // issues - left shifts simply discard shifted out bits.  No undefined
1128 // behavior for large or negative shift quantities; instead the actual
1129 // shift distance is the argument modulo the lhs value&#39;s size in bits.
1130 // No undefined or implementation defined behavior for shifting negative
1131 // values; left shift discards bits, right shift sign extends.  We use
1132 // the same safe conversion technique as above for java_add and friends.
1133 #define JAVA_INTEGER_SHIFT_OP(OP, NAME, TYPE, XTYPE)    \
1134 inline TYPE NAME (TYPE lhs, jint rhs) {                 \
1135   const uint rhs_mask = (sizeof(TYPE) * 8) - 1;         \
1136   STATIC_ASSERT(rhs_mask == 31 || rhs_mask == 63);      \
1137   XTYPE xres = static_cast&lt;XTYPE&gt;(lhs);                 \
1138   xres OP ## = (rhs &amp; rhs_mask);                        \
1139   return reinterpret_cast&lt;TYPE&amp;&gt;(xres);                 \
1140 }
1141 
1142 JAVA_INTEGER_SHIFT_OP(&lt;&lt;, java_shift_left, jint, juint)
1143 JAVA_INTEGER_SHIFT_OP(&lt;&lt;, java_shift_left, jlong, julong)
1144 // For signed shift right, assume C++ implementation &gt;&gt; sign extends.
1145 JAVA_INTEGER_SHIFT_OP(&gt;&gt;, java_shift_right, jint, jint)
1146 JAVA_INTEGER_SHIFT_OP(&gt;&gt;, java_shift_right, jlong, jlong)
1147 // For &gt;&gt;&gt; use C++ unsigned &gt;&gt;.
1148 JAVA_INTEGER_SHIFT_OP(&gt;&gt;, java_shift_right_unsigned, jint, juint)
1149 JAVA_INTEGER_SHIFT_OP(&gt;&gt;, java_shift_right_unsigned, jlong, julong)
1150 
1151 #undef JAVA_INTEGER_SHIFT_OP
1152 
1153 //----------------------------------------------------------------------------------------------------
1154 // The goal of this code is to provide saturating operations for int/uint.
1155 // Checks overflow conditions and saturates the result to min_jint/max_jint.
1156 #define SATURATED_INTEGER_OP(OP, NAME, TYPE1, TYPE2) \
1157 inline int NAME (TYPE1 in1, TYPE2 in2) {             \
1158   jlong res = static_cast&lt;jlong&gt;(in1);               \
1159   res OP ## = static_cast&lt;jlong&gt;(in2);               \
1160   if (res &gt; max_jint) {                              \
1161     res = max_jint;                                  \
1162   } else if (res &lt; min_jint) {                       \
1163     res = min_jint;                                  \
1164   }                                                  \
1165   return static_cast&lt;int&gt;(res);                      \
1166 }
1167 
1168 SATURATED_INTEGER_OP(+, saturated_add, int, int)
1169 SATURATED_INTEGER_OP(+, saturated_add, int, uint)
1170 SATURATED_INTEGER_OP(+, saturated_add, uint, int)
1171 SATURATED_INTEGER_OP(+, saturated_add, uint, uint)
1172 
1173 #undef SATURATED_INTEGER_OP
1174 
1175 // Dereference vptr
1176 // All C++ compilers that we know of have the vtbl pointer in the first
1177 // word.  If there are exceptions, this function needs to be made compiler
1178 // specific.
1179 static inline void* dereference_vptr(const void* addr) {
1180   return *(void**)addr;
1181 }
1182 
1183 //----------------------------------------------------------------------------------------------------
1184 // String type aliases used by command line flag declarations and
1185 // processing utilities.
1186 
1187 typedef const char* ccstr;
1188 typedef const char* ccstrlist;   // represents string arguments which accumulate
1189 
1190 //----------------------------------------------------------------------------------------------------
1191 // Default hash/equals functions used by ResourceHashtable and KVHashtable
1192 
1193 template&lt;typename K&gt; unsigned primitive_hash(const K&amp; k) {
1194   unsigned hash = (unsigned)((uintptr_t)k);
1195   return hash ^ (hash &gt;&gt; 3); // just in case we&#39;re dealing with aligned ptrs
1196 }
1197 
1198 template&lt;typename K&gt; bool primitive_equals(const K&amp; k0, const K&amp; k1) {
1199   return k0 == k1;
1200 }
1201 
<a name="10" id="anc10"></a>





1202 
1203 #endif // SHARE_UTILITIES_GLOBALDEFINITIONS_HPP
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>