<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/notify/src/test/java/org/openjdk/skara/bots/notify/mailinglist/MailingListNotifierTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify.mailinglist;
  24 
  25 import org.junit.jupiter.api.*;
  26 import org.openjdk.skara.email.*;
  27 import org.openjdk.skara.bots.notify.*;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 
  31 import java.io.IOException;
  32 import java.nio.file.Files;
  33 import java.time.Duration;
  34 import java.util.*;
  35 import java.util.regex.Pattern;
  36 
  37 import static org.junit.jupiter.api.Assertions.*;
  38 import static org.openjdk.skara.bots.notify.TestUtils.*;
  39 
  40 public class MailingListNotifierTests {
  41     @Test
  42     void testMailingList(TestInfo testInfo) throws IOException {
  43         try (var listServer = new TestMailmanServer();
  44              var credentials = new HostCredentials(testInfo);
  45              var tempFolder = new TemporaryDirectory()) {
  46             var repo = credentials.getHostedRepository();
  47             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  48             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
  49             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
  50             credentials.commitLock(localRepo);
  51             localRepo.pushAll(repo.url());
  52 
  53             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
  54             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
  55             var mailmanList = mailmanServer.getList(listAddress.address());
  56             var tagStorage = createTagStorage(repo);
  57             var branchStorage = createBranchStorage(repo);
  58             var prStateStorage = createPullRequestStateStorage(repo);
  59             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  60 
  61             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
  62             var notifyBot = NotifyBot.newBuilder()
  63                                      .repository(repo)
  64                                      .storagePath(storageFolder)
  65                                      .branches(Pattern.compile(&quot;master&quot;))
  66                                      .tagStorageBuilder(tagStorage)
  67                                      .branchStorageBuilder(branchStorage)
  68                                      .prStateStorageBuilder(prStateStorage)
  69                                      .build();
  70             var updater = MailingListNotifier.newBuilder()
  71                                              .list(mailmanList)
  72                                              .recipient(listAddress)
  73                                              .sender(sender)
  74                                              .reportNewTags(false)
  75                                              .reportNewBranches(false)
  76                                              .reportNewBuilds(false)
  77                                              .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
  78                                              .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
  79                                              .build();
  80             updater.attachTo(notifyBot);
  81 
  82             // No mail should be sent on the first run as there is no history
  83             TestBotRunner.runPeriodicItems(notifyBot);
  84             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  85 
  86             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
  87             localRepo.push(editHash, repo.url(), &quot;master&quot;);
  88             TestBotRunner.runPeriodicItems(notifyBot);
  89             listServer.processIncoming();
  90 
  91             var conversations = mailmanList.conversations(Duration.ofDays(1));
  92             var email = conversations.get(0).first();
  93             assertEquals(listAddress, email.sender());
  94             assertEquals(sender, email.author());
  95             assertEquals(email.recipients(), List.of(listAddress));
  96             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
  97             assertFalse(email.subject().contains(&quot;master&quot;));
  98             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
  99             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 100             assertFalse(email.body().contains(&quot;Committer&quot;));
 101             assertFalse(email.body().contains(masterHash.abbreviate()));
 102             assertTrue(email.hasHeader(&quot;extra1&quot;));
 103             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 104             assertTrue(email.hasHeader(&quot;extra2&quot;));
 105             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 106             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 107             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 108             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 109             assertEquals(editHash.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 110         }
 111     }
 112 
 113     @Test
 114     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 115         try (var listServer = new TestMailmanServer();
 116              var credentials = new HostCredentials(testInfo);
 117              var tempFolder = new TemporaryDirectory()) {
 118             var repo = credentials.getHostedRepository();
 119             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 120             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 121             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 122             credentials.commitLock(localRepo);
 123             localRepo.pushAll(repo.url());
 124 
 125             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 126             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 127             var mailmanList = mailmanServer.getList(listAddress.address());
 128             var tagStorage = createTagStorage(repo);
 129             var branchStorage = createBranchStorage(repo);
 130             var prStateStorage = createPullRequestStateStorage(repo);
 131             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 132 
 133             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 134             var notifyBot = NotifyBot.newBuilder()
 135                                      .repository(repo)
 136                                      .storagePath(storageFolder)
 137                                      .branches(Pattern.compile(&quot;master&quot;))
 138                                      .tagStorageBuilder(tagStorage)
 139                                      .branchStorageBuilder(branchStorage)
 140                                      .prStateStorageBuilder(prStateStorage)
 141                                      .build();
 142             var updater = MailingListNotifier.newBuilder()
 143                                              .list(mailmanList)
 144                                              .recipient(listAddress)
 145                                              .sender(sender)
 146                                              .reportNewTags(false)
 147                                              .reportNewBranches(false)
 148                                              .reportNewBuilds(false)
 149                                              .build();
 150             updater.attachTo(notifyBot);
 151 
 152             // No mail should be sent on the first run as there is no history
 153             TestBotRunner.runPeriodicItems(notifyBot);
 154             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 155 
 156             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 157                     &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 158             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 159             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 160                     &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 161             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 162 
 163             TestBotRunner.runPeriodicItems(notifyBot);
 164             listServer.processIncoming();
 165 
 166             var conversations = mailmanList.conversations(Duration.ofDays(1));
 167             var email = conversations.get(0).first();
 168             assertEquals(listAddress, email.sender());
 169             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 170             assertEquals(email.recipients(), List.of(listAddress));
 171             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
 172             assertFalse(email.subject().contains(&quot;master&quot;));
 173             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 174             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 175             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 176             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 177             assertFalse(email.body().contains(masterHash.abbreviate()));
 178             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 179             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 180             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 181             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 182         }
 183     }
 184 
 185     @Test
 186     void testMailingListMerge(TestInfo testInfo) throws IOException {
 187         try (var listServer = new TestMailmanServer();
 188              var credentials = new HostCredentials(testInfo);
 189              var tempFolder = new TemporaryDirectory()) {
 190             var repo = credentials.getHostedRepository();
 191             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 192             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 193             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 194             credentials.commitLock(localRepo);
 195             localRepo.pushAll(repo.url());
 196 
 197             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 198             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 199             var mailmanList = mailmanServer.getList(listAddress.address());
 200             var tagStorage = createTagStorage(repo);
 201             var branchStorage = createBranchStorage(repo);
 202             var prStateStorage = createPullRequestStateStorage(repo);
 203             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 204 
 205             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 206             var notifyBot = NotifyBot.newBuilder()
 207                                      .repository(repo)
 208                                      .storagePath(storageFolder)
 209                                      .branches(Pattern.compile(&quot;master&quot;))
 210                                      .tagStorageBuilder(tagStorage)
 211                                      .branchStorageBuilder(branchStorage)
 212                                      .prStateStorageBuilder(prStateStorage)
 213                                      .build();
 214             var updater = MailingListNotifier.newBuilder()
 215                                              .list(mailmanList)
 216                                              .recipient(listAddress)
 217                                              .sender(sender)
 218                                              .reportNewTags(false)
 219                                              .reportNewBranches(false)
 220                                              .reportNewBuilds(false)
 221                                              .build();
 222             updater.attachTo(notifyBot);
 223 
 224             // No mail should be sent on the first run as there is no history
 225             TestBotRunner.runPeriodicItems(notifyBot);
 226             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 227 
 228             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 229                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 230             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 231             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 232                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 233             localRepo.checkout(editHash1, true);
 234             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Something else&quot;);
 235             localRepo.add(unrelated);
 236             localRepo.commit(&quot;Unrelated&quot;, &quot;unrelated_author&quot;, &quot;unrelated@author.example.com&quot;);
 237             localRepo.merge(editHash2);
 238             var mergeHash = localRepo.commit(&quot;Merge&quot;, &quot;merge_author&quot;, &quot;merge@author.example.com&quot;);
 239             localRepo.push(mergeHash, repo.url(), &quot;master&quot;);
 240 
 241             TestBotRunner.runPeriodicItems(notifyBot);
 242             listServer.processIncoming();
 243 
 244             var conversations = mailmanList.conversations(Duration.ofDays(1));
 245             var email = conversations.get(0).first();
 246             assertEquals(listAddress, email.sender());
 247             assertEquals(EmailAddress.from(&quot;merge_author&quot;, &quot;merge@author.example.com&quot;), email.author());
 248             assertEquals(email.recipients(), List.of(listAddress));
 249             assertTrue(email.subject().contains(&quot;: 4 new changesets&quot;));
 250             assertFalse(email.subject().contains(&quot;master&quot;));
 251             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 252             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 253             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 254             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 255             assertFalse(email.body().contains(masterHash.abbreviate()));
 256             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 257             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 258             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 259             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 260         }
 261     }
 262 
 263     @Test
 264     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 265         try (var listServer = new TestMailmanServer();
 266              var credentials = new HostCredentials(testInfo);
 267              var tempFolder = new TemporaryDirectory()) {
 268             var repo = credentials.getHostedRepository();
 269             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 270             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 271             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 272             credentials.commitLock(localRepo);
 273             localRepo.pushAll(repo.url());
 274 
 275             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 276             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 277             var mailmanList = mailmanServer.getList(listAddress.address());
 278             var tagStorage = createTagStorage(repo);
 279             var branchStorage = createBranchStorage(repo);
 280             var prStateStorage = createPullRequestStateStorage(repo);
 281             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 282 
 283             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 284             var notifyBot = NotifyBot.newBuilder()
 285                                      .repository(repo)
 286                                      .storagePath(storageFolder)
 287                                      .branches(Pattern.compile(&quot;master&quot;))
 288                                      .tagStorageBuilder(tagStorage)
 289                                      .branchStorageBuilder(branchStorage)
 290                                      .prStateStorageBuilder(prStateStorage)
 291                                      .build();
 292             var updater = MailingListNotifier.newBuilder()
 293                                              .list(mailmanList)
 294                                              .recipient(listAddress)
 295                                              .sender(sender)
 296                                              .reportNewTags(false)
 297                                              .reportNewBranches(false)
 298                                              .reportNewBuilds(false)
 299                                              .build();
 300             updater.attachTo(notifyBot);
 301 
 302             // No mail should be sent on the first run as there is no history
 303             TestBotRunner.runPeriodicItems(notifyBot);
 304             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 305 
 306             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 307                     &quot;author&quot;, &quot;author@test.test&quot;,
 308                     &quot;committer&quot;, &quot;committer@test.test&quot;);
 309             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 310             TestBotRunner.runPeriodicItems(notifyBot);
 311             listServer.processIncoming();
 312 
 313             var conversations = mailmanList.conversations(Duration.ofDays(1));
 314             var email = conversations.get(0).first();
 315             assertEquals(listAddress, email.sender());
 316             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 317             assertEquals(email.recipients(), List.of(listAddress));
 318             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 319             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 320             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
 321             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
 322             assertFalse(email.body().contains(masterHash.abbreviate()));
 323         }
 324     }
 325 
 326     @Test
 327     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
 328         try (var listServer = new TestMailmanServer();
 329              var credentials = new HostCredentials(testInfo);
 330              var tempFolder = new TemporaryDirectory()) {
 331             var repo = credentials.getHostedRepository();
 332             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 333             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 334             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 335             credentials.commitLock(localRepo);
 336             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 337             localRepo.pushAll(repo.url());
 338 
 339             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 340             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 341             var mailmanList = mailmanServer.getList(listAddress.address());
 342             var tagStorage = createTagStorage(repo);
 343             var branchStorage = createBranchStorage(repo);
 344             var prStateStorage = createPullRequestStateStorage(repo);
 345             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 346 
 347             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 348             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 349             var notifyBot = NotifyBot.newBuilder()
 350                                      .repository(repo)
 351                                      .storagePath(storageFolder)
 352                                      .branches(Pattern.compile(&quot;master|another&quot;))
 353                                      .tagStorageBuilder(tagStorage)
 354                                      .branchStorageBuilder(branchStorage)
 355                                      .prStateStorageBuilder(prStateStorage)
 356                                      .build();
 357             var updater = MailingListNotifier.newBuilder()
 358                                              .list(mailmanList)
 359                                              .recipient(listAddress)
 360                                              .sender(sender)
 361                                              .author(author)
 362                                              .includeBranch(true)
 363                                              .reportNewTags(false)
 364                                              .reportNewBranches(false)
 365                                              .reportNewBuilds(false)
 366                                              .build();
 367             updater.attachTo(notifyBot);
 368 
 369             // No mail should be sent on the first run as there is no history
 370             TestBotRunner.runPeriodicItems(notifyBot);
 371             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 372 
 373             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 374             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 375             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 376             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 377 
 378             TestBotRunner.runPeriodicItems(notifyBot);
 379             listServer.processIncoming();
 380 
 381             var conversations = mailmanList.conversations(Duration.ofDays(1));
 382             var email = conversations.get(0).first();
 383             assertEquals(listAddress, email.sender());
 384             assertEquals(author, email.author());
 385             assertEquals(email.recipients(), List.of(listAddress));
 386             assertFalse(email.subject().contains(&quot;another&quot;));
 387             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
 388             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 389             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 390             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 391             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 392             assertFalse(email.body().contains(masterHash.abbreviate()));
 393             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 394             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 395             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 396             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 397             assertEquals(editHash1.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 398 
 399             localRepo.checkout(branch, true);
 400             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
 401             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
 402 
 403             TestBotRunner.runPeriodicItems(notifyBot);
 404             listServer.processIncoming();
 405 
 406             conversations = mailmanList.conversations(Duration.ofDays(1));
 407             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 408             email = conversations.get(0).first();
 409             assertEquals(author, email.author());
 410             assertEquals(listAddress, email.sender());
 411             assertEquals(email.recipients(), List.of(listAddress));
 412             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 413             assertFalse(email.subject().contains(&quot;master&quot;));
 414             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 415             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 416             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 417             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 418             assertTrue(email.hasHeader(&quot;X-Git-URL&quot;));
 419             assertEquals(repo.webUrl().toString(), email.headerValue(&quot;X-Git-URL&quot;));
 420             assertTrue(email.hasHeader(&quot;X-Git-Changeset&quot;));
 421             assertEquals(editHash3.hex(), email.headerValue(&quot;X-Git-Changeset&quot;));
 422         }
 423     }
 424 
 425     @Test
 426     void testMailingListPROnlyMultipleBranches(TestInfo testInfo) throws IOException {
 427         try (var listServer = new TestMailmanServer();
 428              var credentials = new HostCredentials(testInfo);
 429              var tempFolder = new TemporaryDirectory()) {
 430             var repo = credentials.getHostedRepository();
 431             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 432             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 433             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 434             credentials.commitLock(localRepo);
 435             localRepo.pushAll(repo.url());
 436 
 437             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 438             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 439             var mailmanList = mailmanServer.getList(listAddress.address());
 440             var tagStorage = createTagStorage(repo);
 441             var branchStorage = createBranchStorage(repo);
 442             var prStateStorage = createPullRequestStateStorage(repo);
 443             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 444 
 445             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 446             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 447             var notifyBot = NotifyBot.newBuilder()
 448                                      .repository(repo)
 449                                      .storagePath(storageFolder)
 450                                      .branches(Pattern.compile(&quot;master|other&quot;))
 451                                      .tagStorageBuilder(tagStorage)
 452                                      .branchStorageBuilder(branchStorage)
 453                                      .prStateStorageBuilder(prStateStorage)
 454                                      .build();
 455             var updater = MailingListNotifier.newBuilder()
 456                                              .list(mailmanList)
 457                                              .recipient(listAddress)
 458                                              .sender(sender)
 459                                              .author(author)
 460                                              .reportNewTags(false)
 461                                              .reportNewBranches(false)
 462                                              .reportNewBuilds(false)
 463                                              .includeBranch(true)
 464                                              .mode(MailingListNotifier.Mode.PR)
 465                                              .build();
 466             updater.attachTo(notifyBot);
 467 
 468             // Populate our known branches
 469             localRepo.push(masterHash, repo.url(), &quot;master&quot;, true);
 470             localRepo.push(masterHash, repo.url(), &quot;other&quot;, true);
 471 
 472             // No mail should be sent on the first run as there is no history
 473             TestBotRunner.runPeriodicItems(notifyBot);
 474             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 475 
 476             localRepo.checkout(masterHash, true);
 477             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 478             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 479             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 480 
 481             // PR hasn&#39;t been integrated yet, so there should be no mail
 482             TestBotRunner.runPeriodicItems(notifyBot);
 483             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 484 
 485             // Simulate an RFR email
 486             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 487                            .recipient(listAddress)
 488                            .build();
 489             mailmanList.post(rfr);
 490             listServer.processIncoming();
 491 
 492             // And an integration (but it hasn&#39;t reached master just yet)
 493             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 494 
 495             // Now push the same commit to another branch
 496             localRepo.push(editHash, repo.url(), &quot;other&quot;);
 497             TestBotRunner.runPeriodicItems(notifyBot);
 498             listServer.processIncoming();
 499 
 500             // This one should generate a plain integration mail
 501             var conversations = mailmanList.conversations(Duration.ofDays(1));
 502             assertEquals(2, conversations.size());
 503             var secondEmail = conversations.get(0).first();
 504             if (secondEmail.subject().contains(&quot;RFR&quot;)) {
 505                 secondEmail = conversations.get(1).first();
 506             }
 507             assertEquals(&quot;git: test: other: 23456789: More fixes&quot;, secondEmail.subject());
 508         }
 509     }
 510 
 511     @Test
 512     void testMailingListPR(TestInfo testInfo) throws IOException {
 513         try (var listServer = new TestMailmanServer();
 514              var credentials = new HostCredentials(testInfo);
 515              var tempFolder = new TemporaryDirectory()) {
 516             var repo = credentials.getHostedRepository();
 517             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 518             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 519             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 520             credentials.commitLock(localRepo);
 521             localRepo.pushAll(repo.url());
 522 
 523             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 524             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 525             var mailmanList = mailmanServer.getList(listAddress.address());
 526             var tagStorage = createTagStorage(repo);
 527             var branchStorage = createBranchStorage(repo);
 528             var prStateStorage = createPullRequestStateStorage(repo);
 529             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 530 
 531             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 532             var notifyBot = NotifyBot.newBuilder()
 533                                      .repository(repo)
 534                                      .storagePath(storageFolder)
 535                                      .branches(Pattern.compile(&quot;master&quot;))
 536                                      .tagStorageBuilder(tagStorage)
 537                                      .branchStorageBuilder(branchStorage)
 538                                      .prStateStorageBuilder(prStateStorage)
 539                                      .build();
 540             var updater = MailingListNotifier.newBuilder()
 541                                              .list(mailmanList)
 542                                              .recipient(listAddress)
 543                                              .sender(sender)
 544                                              .reportNewTags(false)
 545                                              .reportNewBranches(false)
 546                                              .reportNewBuilds(false)
 547                                              .mode(MailingListNotifier.Mode.PR)
 548                                              .build();
 549             updater.attachTo(notifyBot);
 550 
 551             // No mail should be sent on the first run as there is no history
 552             TestBotRunner.runPeriodicItems(notifyBot);
 553             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 554 
 555             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 556             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 557             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 558 
 559             // Create a potentially conflicting one
 560             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 561             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 562             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 563 
 564             // PR hasn&#39;t been integrated yet, so there should be no mail
 565             TestBotRunner.runPeriodicItems(notifyBot);
 566             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 567 
 568             // Simulate an RFR email
 569             var rfr = Email.create(&quot;[repo/branch] RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 570                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 571                            .recipient(listAddress)
 572                            .build();
 573             mailmanList.post(rfr);
 574             listServer.processIncoming();
 575 
 576             // And an integration
 577             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 578             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 579 
 580             // Push the other one without a matching PR
 581             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 582 
 583             TestBotRunner.runPeriodicItems(notifyBot);
 584             listServer.processIncoming();
 585 
 586             var conversations = mailmanList.conversations(Duration.ofDays(1));
 587             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 588             assertEquals(2, conversations.size());
 589 
 590             var prConversation = conversations.get(0);
 591             var pushConversation = conversations.get(1);
 592             assertEquals(1, prConversation.allMessages().size());
 593 
 594             var pushEmail = pushConversation.first();
 595             assertEquals(listAddress, pushEmail.sender());
 596             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 597             assertEquals(pushEmail.recipients(), List.of(listAddress));
 598             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 599         }
 600     }
 601 
 602     @Test
 603     void testMailingListMergePR(TestInfo testInfo) throws IOException {
 604         try (var listServer = new TestMailmanServer();
 605              var credentials = new HostCredentials(testInfo);
 606              var tempFolder = new TemporaryDirectory()) {
 607             var repo = credentials.getHostedRepository();
 608             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 609             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 610             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 611             credentials.commitLock(localRepo);
 612             localRepo.pushAll(repo.url());
 613 
 614             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 615             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 616             var mailmanList = mailmanServer.getList(listAddress.address());
 617             var tagStorage = createTagStorage(repo);
 618             var branchStorage = createBranchStorage(repo);
 619             var prStateStorage = createPullRequestStateStorage(repo);
 620             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 621 
 622             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 623             var notifyBot = NotifyBot.newBuilder()
 624                                      .repository(repo)
 625                                      .storagePath(storageFolder)
 626                                      .branches(Pattern.compile(&quot;master&quot;))
 627                                      .tagStorageBuilder(tagStorage)
 628                                      .branchStorageBuilder(branchStorage)
 629                                      .prStateStorageBuilder(prStateStorage)
 630                                      .build();
 631             var updater = MailingListNotifier.newBuilder()
 632                                              .list(mailmanList)
 633                                              .recipient(listAddress)
 634                                              .sender(sender)
 635                                              .reportNewTags(false)
 636                                              .reportNewBranches(false)
 637                                              .reportNewBuilds(false)
 638                                              .mode(MailingListNotifier.Mode.PR)
 639                                              .build();
 640             updater.attachTo(notifyBot);
 641 
 642             // No mail should be sent on the first run as there is no history
 643             TestBotRunner.runPeriodicItems(notifyBot);
 644             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 645 
 646             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 647                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 648             localRepo.push(editHash1, repo.url(), &quot;edit&quot;);
 649             CheckableRepository.appendAndCommit(localRepo, &quot;And another line&quot;, &quot;12345678: And more fixes&quot;,
 650                                                 &quot;second_author&quot;, &quot;second@author.example.com&quot;);
 651             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 652                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 653             localRepo.checkout(editHash1, true);
 654             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Something else&quot;);
 655             localRepo.add(unrelated);
 656             localRepo.commit(&quot;Unrelated&quot;, &quot;unrelated_author&quot;, &quot;unrelated@author.example.com&quot;);
 657             localRepo.merge(editHash2);
 658             var mergeHash = localRepo.commit(&quot;Merge&quot;, &quot;merge_author&quot;, &quot;merge@author.example.com&quot;);
 659             localRepo.push(mergeHash, repo.url(), &quot;edit&quot;);
 660 
 661             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;Merge test&quot;);
 662 
 663             // PR hasn&#39;t been integrated yet, so there should be no mail
 664             TestBotRunner.runPeriodicItems(notifyBot);
 665             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 666 
 667             // Simulate an RFR email
 668             var rfr = Email.create(&quot;[repo/branch] RFR: Merge test&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 669                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 670                            .recipient(listAddress)
 671                            .build();
 672             mailmanList.post(rfr);
 673             listServer.processIncoming();
 674 
 675             // And an integration
 676             pr.addComment(&quot;Pushed as commit &quot; + mergeHash.hex() + &quot;.&quot;);
 677             localRepo.push(mergeHash, repo.url(), &quot;master&quot;);
 678 
 679             TestBotRunner.runPeriodicItems(notifyBot);
 680             listServer.processIncoming();
 681 
 682             var conversations = mailmanList.conversations(Duration.ofDays(1));
 683             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 684             assertEquals(2, conversations.size());
 685 
 686             var prConversation = conversations.get(0);
 687             var pushConversation = conversations.get(1);
 688             assertEquals(1, prConversation.allMessages().size());
 689 
 690             var pushEmail = pushConversation.first();
 691             assertEquals(listAddress, pushEmail.sender());
 692             assertEquals(EmailAddress.from(&quot;unrelated_author&quot;, &quot;unrelated@author.example.com&quot;), pushEmail.author());
 693             assertEquals(pushEmail.recipients(), List.of(listAddress));
 694             assertTrue(pushEmail.subject().contains(&quot;2 new changesets&quot;));
 695         }
 696     }
 697 
 698     @Test
 699     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 700         try (var listServer = new TestMailmanServer();
 701              var credentials = new HostCredentials(testInfo);
 702              var tempFolder = new TemporaryDirectory()) {
 703             var repo = credentials.getHostedRepository();
 704             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 705             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 706             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 707             localRepo.branch(masterHash, &quot;other&quot;);
 708             credentials.commitLock(localRepo);
 709             localRepo.pushAll(repo.url());
 710 
 711             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 712             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 713             var mailmanList = mailmanServer.getList(listAddress.address());
 714             var tagStorage = createTagStorage(repo);
 715             var branchStorage = createBranchStorage(repo);
 716             var prStateStorage = createPullRequestStateStorage(repo);
 717             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 718 
 719             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 720             var notifyBot = NotifyBot.newBuilder()
 721                                      .repository(repo)
 722                                      .storagePath(storageFolder)
 723                                      .branches(Pattern.compile(&quot;master|other&quot;))
 724                                      .tagStorageBuilder(tagStorage)
 725                                      .branchStorageBuilder(branchStorage)
 726                                      .prStateStorageBuilder(prStateStorage)
 727                                      .build();
 728             var updater = MailingListNotifier.newBuilder()
 729                                              .list(mailmanList)
 730                                              .recipient(listAddress)
 731                                              .sender(sender)
 732                                              .author(null)
 733                                              .reportNewTags(false)
 734                                              .reportNewBranches(false)
 735                                              .reportNewBuilds(false)
 736                                              .mode(MailingListNotifier.Mode.PR)
 737                                              .build();
 738             updater.attachTo(notifyBot);
 739 
 740             // No mail should be sent on the first run as there is no history
 741             TestBotRunner.runPeriodicItems(notifyBot);
 742             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 743 
 744             localRepo.checkout(masterHash, true);
 745             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 746             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 747             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 748 
 749             // PR hasn&#39;t been integrated yet, so there should be no mail
 750             TestBotRunner.runPeriodicItems(notifyBot);
 751             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 752 
 753             // Simulate an RFR email
 754             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 755                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 756                            .recipient(listAddress)
 757                            .build();
 758             mailmanList.post(rfr);
 759             listServer.processIncoming();
 760 
 761             // And an integration
 762             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 763             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 764 
 765             TestBotRunner.runPeriodicItems(notifyBot);
 766             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 767 
 768             var conversations = mailmanList.conversations(Duration.ofDays(1));
 769             assertEquals(1, conversations.size());
 770 
 771             var prConversation = conversations.get(0);
 772             assertEquals(1, prConversation.allMessages().size());
 773 
 774             // Now push the change to another monitored branch
 775             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 776             TestBotRunner.runPeriodicItems(notifyBot);
 777             listServer.processIncoming();
 778 
 779             // The change should now end up as a separate notification thread
 780             conversations = mailmanList.conversations(Duration.ofDays(1));
 781             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 782             assertEquals(2, conversations.size());
 783 
 784             var pushConversation = conversations.get(1);
 785             var pushEmail = pushConversation.first();
 786             assertEquals(listAddress, pushEmail.sender());
 787             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 788             assertEquals(pushEmail.recipients(), List.of(listAddress));
 789             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 790         }
 791     }
 792 
 793     @Test
 794     void testMailinglistTag(TestInfo testInfo) throws IOException {
 795         try (var credentials = new HostCredentials(testInfo);
 796              var tempFolder = new TemporaryDirectory();
 797              var listServer = new TestMailmanServer();
 798              var scratchFolder = new TemporaryDirectory()) {
 799             var repo = credentials.getHostedRepository();
 800             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 801             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 802             credentials.commitLock(localRepo);
 803             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 804             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 805             localRepo.pushAll(repo.url());
 806 
 807             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 808             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 809             var mailmanList = mailmanServer.getList(listAddress.address());
 810             var tagStorage = createTagStorage(repo);
 811             var branchStorage = createBranchStorage(repo);
 812             var prStateStorage = createPullRequestStateStorage(repo);
 813             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 814 
 815             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 816             var notifyBot = NotifyBot.newBuilder()
 817                                      .repository(repo)
 818                                      .storagePath(storageFolder)
 819                                      .branches(Pattern.compile(&quot;master&quot;))
 820                                      .tagStorageBuilder(tagStorage)
 821                                      .branchStorageBuilder(branchStorage)
 822                                      .prStateStorageBuilder(prStateStorage)
 823                                      .build();
 824             var updater = MailingListNotifier.newBuilder()
 825                                              .list(mailmanList)
 826                                              .recipient(listAddress)
 827                                              .sender(sender)
 828                                              .reportNewBranches(false)
 829                                              .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 830                                              .build();
 831             updater.attachTo(notifyBot);
 832 
 833             var noTagsUpdater = MailingListNotifier.newBuilder()
 834                                                    .list(mailmanList)
 835                                                    .recipient(listAddress)
 836                                                    .sender(sender)
 837                                                    .reportNewTags(false)
 838                                                    .reportNewBranches(false)
 839                                                    .reportNewBuilds(false)
 840                                                    .build();
 841             noTagsUpdater.attachTo(notifyBot);
 842 
 843             // No mail should be sent on the first run as there is no history
 844             TestBotRunner.runPeriodicItems(notifyBot, scratchFolder.path());
 845             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 846 
 847             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 848             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 849             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 850             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 851             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 852             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 853             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 854             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 855             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 856             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 857             localRepo.pushAll(repo.url());
 858 
 859             TestBotRunner.runPeriodicItems(notifyBot, scratchFolder.path());
 860             listServer.processIncoming();
 861             listServer.processIncoming();
 862             listServer.processIncoming();
 863             listServer.processIncoming();
 864 
 865             var conversations = mailmanList.conversations(Duration.ofDays(1));
 866             assertEquals(4, conversations.size());
 867 
 868             for (var conversation : conversations) {
 869                 var email = conversation.first();
 870                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 871                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 872                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 873                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 874                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 875                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 876                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 877                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 878                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 879                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 880                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 881                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 882                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 883                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 884                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 885                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 886                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 887                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 888                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 889                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 890                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 891                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 892                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 893                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 894                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 895                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 896                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 897                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 898                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 899                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 900                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 901                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 902                 } else {
 903                     fail(&quot;Mismatched subject: &quot; + email.subject());
 904                 }
 905                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 906                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 907                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 908                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 909             }
 910         }
 911     }
 912 
 913     @Test
 914     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
 915         try (var credentials = new HostCredentials(testInfo);
 916              var tempFolder = new TemporaryDirectory();
 917              var listServer = new TestMailmanServer()) {
 918             var repo = credentials.getHostedRepository();
 919             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 920             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 921             credentials.commitLock(localRepo);
 922             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 923             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 924             localRepo.pushAll(repo.url());
 925 
 926             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 927             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 928             var mailmanList = mailmanServer.getList(listAddress.address());
 929             var tagStorage = createTagStorage(repo);
 930             var branchStorage = createBranchStorage(repo);
 931             var prStateStorage = createPullRequestStateStorage(repo);
 932             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 933 
 934             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 935             var notifyBot = NotifyBot.newBuilder()
 936                                      .repository(repo)
 937                                      .storagePath(storageFolder)
 938                                      .branches(Pattern.compile(&quot;master&quot;))
 939                                      .tagStorageBuilder(tagStorage)
 940                                      .branchStorageBuilder(branchStorage)
 941                                      .prStateStorageBuilder(prStateStorage)
 942                                      .build();
 943             var updater = MailingListNotifier.newBuilder()
 944                                              .list(mailmanList)
 945                                              .recipient(listAddress)
 946                                              .sender(sender)
 947                                              .reportNewBranches(false)
 948                                              .reportNewBuilds(false)
 949                                              .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 950                                              .build();
 951             updater.attachTo(notifyBot);
 952             var noTagsUpdater = MailingListNotifier.newBuilder()
 953                                                    .list(mailmanList)
 954                                                    .recipient(listAddress)
 955                                                    .sender(sender)
 956                                                    .reportNewTags(false)
 957                                                    .reportNewBranches(false)
 958                                                    .reportNewBuilds(false)
 959                                                    .build();
 960             noTagsUpdater.attachTo(notifyBot);
 961 
 962             // No mail should be sent on the first run as there is no history
 963             TestBotRunner.runPeriodicItems(notifyBot);
 964             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 965 
 966             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 967             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 968             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 969             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 970             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 971             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 972             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 973             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 974             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 975             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 976             localRepo.pushAll(repo.url());
 977 
 978             TestBotRunner.runPeriodicItems(notifyBot);
 979             listServer.processIncoming();
 980             listServer.processIncoming();
 981             listServer.processIncoming();
 982             listServer.processIncoming();
 983 
 984             var conversations = mailmanList.conversations(Duration.ofDays(1));
 985             assertEquals(4, conversations.size());
 986 
 987             for (var conversation : conversations) {
 988                 var email = conversation.first();
 989                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 990                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 991                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 992                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 993                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 994                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 995                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 996                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 997                 } else {
 998                     fail(&quot;Mismatched subject: &quot; + email.subject());
 999                 }
1000                 assertTrue(email.hasHeader(&quot;extra1&quot;));
1001                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1002                 assertTrue(email.hasHeader(&quot;extra2&quot;));
1003                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1004             }
1005         }
1006     }
1007 
1008     @Test
1009     void testMailingListBranch(TestInfo testInfo) throws IOException {
1010         try (var listServer = new TestMailmanServer();
1011              var credentials = new HostCredentials(testInfo);
1012              var tempFolder = new TemporaryDirectory()) {
1013             var repo = credentials.getHostedRepository();
1014             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1015             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1016             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1017             credentials.commitLock(localRepo);
1018             localRepo.pushAll(repo.url());
1019 
1020             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1021             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1022             var mailmanList = mailmanServer.getList(listAddress.address());
1023             var tagStorage = createTagStorage(repo);
1024             var branchStorage = createBranchStorage(repo);
1025             var prStateStorage = createPullRequestStateStorage(repo);
1026             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1027 
1028             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1029             var notifyBot = NotifyBot.newBuilder()
1030                                      .repository(repo)
1031                                      .storagePath(storageFolder)
1032                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))
1033                                      .tagStorageBuilder(tagStorage)
1034                                      .branchStorageBuilder(branchStorage)
1035                                      .prStateStorageBuilder(prStateStorage)
1036                                      .build();
1037             var updater = MailingListNotifier.newBuilder()
1038                                              .list(mailmanList)
1039                                              .recipient(listAddress)
1040                                              .sender(sender)
1041                                              .reportNewTags(false)
1042                                              .reportNewBuilds(false)
1043                                              .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1044                                              .build();
1045             updater.attachTo(notifyBot);
1046 
1047             // No mail should be sent on the first run as there is no history
1048             TestBotRunner.runPeriodicItems(notifyBot);
1049             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1050 
1051             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
1052             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1053             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
1054             TestBotRunner.runPeriodicItems(notifyBot);
1055             listServer.processIncoming();
1056 
1057             var conversations = mailmanList.conversations(Duration.ofDays(1));
1058             var email = conversations.get(0).first();
1059             assertEquals(listAddress, email.sender());
1060             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1061             assertEquals(email.recipients(), List.of(listAddress));
1062             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
1063             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
1064             assertTrue(email.hasHeader(&quot;extra1&quot;));
1065             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1066             assertTrue(email.hasHeader(&quot;extra2&quot;));
1067             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1068 
1069             TestBotRunner.runPeriodicItems(notifyBot);
1070             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1071 
1072             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
1073             TestBotRunner.runPeriodicItems(notifyBot);
1074             listServer.processIncoming();
1075 
1076             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
1077                                              .filter(c -&gt; !c.equals(conversations.get(0)))
1078                                              .findFirst().orElseThrow();
1079             email = newConversation.first();
1080             assertEquals(listAddress, email.sender());
1081             assertEquals(sender, email.author());
1082             assertEquals(email.recipients(), List.of(listAddress));
1083             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
1084             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
1085         }
1086     }
1087 
1088     @Test
1089     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1090         try (var listServer = new TestMailmanServer();
1091              var credentials = new HostCredentials(testInfo);
1092              var tempFolder = new TemporaryDirectory()) {
1093             var repo = credentials.getHostedRepository();
1094             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1095             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1096             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1097             credentials.commitLock(localRepo);
1098             localRepo.pushAll(repo.url());
1099 
1100             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1101             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1102             var mailmanList = mailmanServer.getList(listAddress.address());
1103             var tagStorage = createTagStorage(repo);
1104             var branchStorage = createBranchStorage(repo);
1105             var prStateStorage = createPullRequestStateStorage(repo);
1106             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1107 
1108             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1109             var notifyBot = NotifyBot.newBuilder()
1110                                      .repository(repo)
1111                                      .storagePath(storageFolder)
1112                                      .branches(Pattern.compile(&quot;master&quot;))
1113                                      .tagStorageBuilder(tagStorage)
1114                                      .branchStorageBuilder(branchStorage)
1115                                      .prStateStorageBuilder(prStateStorage)
1116                                      .build();
1117             var updater = MailingListNotifier.newBuilder()
1118                                              .list(mailmanList)
1119                                              .recipient(listAddress)
1120                                              .sender(sender)
1121                                              .reportNewTags(false)
1122                                              .reportNewBranches(false)
1123                                              .reportNewBuilds(false)
1124                                              .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1125                                              .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
1126                                              .build();
1127             updater.attachTo(notifyBot);
1128 
1129             // No mail should be sent on the first run as there is no history
1130             TestBotRunner.runPeriodicItems(notifyBot);
1131             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1132 
1133             // Save history state
1134             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
1135 
1136             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1137             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1138             TestBotRunner.runPeriodicItems(notifyBot);
1139             listServer.processIncoming();
1140 
1141             var conversations = mailmanList.conversations(Duration.ofDays(1));
1142             assertEquals(1, conversations.size());
1143 
1144             // Reset the history
1145             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
1146             TestBotRunner.runPeriodicItems(notifyBot);
1147             listServer.processIncoming();
1148 
1149             // There should now be a duplicate mail
1150             conversations = mailmanList.conversations(Duration.ofDays(1));
1151             assertEquals(2, conversations.size());
1152         }
1153     }
1154 }
    </pre>
  </body>
</html>