<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return Optional.empty();
  54             }
  55             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  56         } catch (IOException e) {
  57             return Optional.empty();
  58         }
  59 
  60     }
  61 
  62     private boolean archiveContains(Path archive, String text) {
  63         return archiveContainsCount(archive, text) &gt; 0;
  64     }
  65 
  66     private int archiveContainsCount(Path archive, String text) {
  67         var lines = archiveContents(archive);
  68         if (lines.isEmpty()) {
  69             return 0;
  70         }
  71         var pattern = Pattern.compile(text);
  72         int count = 0;
  73         for (var line : lines.get().split(&quot;\\R&quot;)) {
  74             var matcher = pattern.matcher(line);
  75             if (matcher.find()) {
  76                 count++;
  77             }
  78         }
  79         return count;
  80     }
  81 
  82     private boolean webrevContains(Path webrev, String text) {
  83         try {
  84             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  85             if (index.isEmpty()) {
  86                 return false;
  87             }
  88             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  89             return lines.contains(text);
  90         } catch (IOException e) {
  91             return false;
  92         }
  93     }
  94 
  95     private long countSubstrings(String string, String substring) {
  96         return Pattern.compile(substring).matcher(string).results().count();
  97     }
  98 
  99     private String noreplyAddress(HostedRepository repository) {
 100         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 101                 repository.forge().currentUser().userName() +
 102                 &quot;@openjdk.java.net&quot;;
 103     }
 104 
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 151             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 152             pr.setBody(&quot;This should not be ready&quot;);
 153 
 154             // Run an archive pass
 155             TestBotRunner.runPeriodicItems(mlBot);
 156 
 157             // A PR that isn&#39;t ready for review should not be archived
 158             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 159             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 160 
 161             // Flag it as ready for review
 162             pr.setBody(&quot;This should now be ready&quot;);
 163             pr.addLabel(&quot;rfr&quot;);
 164 
 165             // Run another archive pass
 166             TestBotRunner.runPeriodicItems(mlBot);
 167 
 168             // But it should still not be archived
 169             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 170             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 171 
 172             // Now post a general comment - not a ready marker
 173             var ignoredPr = ignored.pullRequest(pr.id());
 174             ignoredPr.addComment(&quot;hello there&quot;);
 175 
 176             // Run another archive pass
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 197             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
 218             // And there should be a webrev
 219             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 220             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 221             var comments = pr.comments();
 222             var webrevComments = comments.stream()
 223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 226                                          .collect(Collectors.toList());
 227             assertEquals(1, webrevComments.size());
 228 
 229             // Add a comment
 230             pr.addComment(&quot;This is a comment :smile:&quot;);
 231 
 232             // Add a comment from an ignored user as well
 233             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 234 
 235             // Run another archive pass
 236             TestBotRunner.runPeriodicItems(mlBot);
 237 
 238             // The archive should now contain the comment, but not the ignored one
 239             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 242             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 243 
 244             listServer.processIncoming();
 245             conversations = mailmanList.conversations(Duration.ofDays(1));
 246             assertEquals(1, conversations.size());
 247             assertEquals(2, conversations.get(0).allMessages().size());
 248 
 249             // Remove the rfr flag and post another comment
 250             pr.addLabel(&quot;rfr&quot;);
 251             pr.addComment(&quot;This is another comment&quot;);
 252 
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This is now ready&quot;);
 316             pr.addLabel(&quot;rfr&quot;);
 317 
 318             // Run an archive pass
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             TestBotRunner.runPeriodicItems(mlBot);
 321 
 322             // There should be an RFR thread
 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 324             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 325 
 326             // Add a comment quickly before integration - it should not be combined with the integration message
 327             pr.addComment(&quot;I will now integrate this PR&quot;);
 328 
 329             // Now it has been integrated
 330             var ignoredPr = ignored.pullRequest(pr.id());
 331             ignoredPr.setBody(&quot;This has been integrated&quot;);
 332             ignoredPr.addLabel(&quot;integrated&quot;);
 333             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 334             ignoredPr.setState(Issue.State.CLOSED);
 335 
 336             // Run another archive pass
 337             TestBotRunner.runPeriodicItems(mlBot);
 338 
 339             // The archive should now contain another entry
 340             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 341             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: RFR: 1234: This is a pull request&quot;));
 342             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Integrated: 1234: This is a pull request&quot;));
 343             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 344         }
 345     }
 346 
 347     @Test
 348     void archiveLegacyIntegrated(TestInfo testInfo) throws IOException {
 349         try (var credentials = new HostCredentials(testInfo);
 350              var tempFolder = new TemporaryDirectory();
 351              var archiveFolder = new TemporaryDirectory();
 352              var webrevFolder = new TemporaryDirectory();
 353              var listServer = new TestMailmanServer();
 354              var webrevServer = new TestWebrevServer()) {
 355             var author = credentials.getHostedRepository();
 356             var archive = credentials.getHostedRepository();
 357             var ignored = credentials.getHostedRepository();
 358             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 359             var censusBuilder = credentials.getCensusBuilder()
 360                     .addAuthor(author.forge().currentUser().id());
 361             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 362             var mlBot = MailingListBridgeBot.newBuilder()
 363                                             .from(from)
 364                                             .repo(author)
 365                                             .archive(archive)
 366                                             .censusRepo(censusBuilder.build())
 367                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 368                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 369                                             .listArchive(listServer.getArchive())
 370                                             .smtpServer(listServer.getSMTP())
 371                                             .webrevStorageRepository(archive)
 372                                             .webrevStorageRef(&quot;webrev&quot;)
 373                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 374                                             .webrevStorageBaseUri(webrevServer.uri())
 375                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 376                                             .build();
 377 
 378             // Populate the projects repository
 379             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 380             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 381             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 382             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 383 
 384             // Make a change with a corresponding PR with a date in the past
 385             var editFile = tempFolder.path().resolve(&quot;change.txt&quot;);
 386             Files.writeString(editFile, &quot;A simple change&quot;);
 387             localRepo.add(editFile);
 388             var commitDate = ZonedDateTime.of(2020, 3, 12, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));
 389             var editHash = localRepo.commit(&quot;An old change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate,
 390                              &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate);
 391             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 392             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 393             pr.setBody(&quot;This is now ready&quot;);
 394             pr.addLabel(&quot;rfr&quot;);
 395 
 396             // Run an archive pass
 397             TestBotRunner.runPeriodicItems(mlBot);
 398             TestBotRunner.runPeriodicItems(mlBot);
 399 
 400             // There should be an RFR thread
 401             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 402             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 403 
 404             // Now it has been integrated
 405             var ignoredPr = ignored.pullRequest(pr.id());
 406             ignoredPr.setBody(&quot;This has been integrated&quot;);
 407             ignoredPr.addLabel(&quot;integrated&quot;);
 408             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 409             ignoredPr.setState(Issue.State.CLOSED);
 410 
 411             // Run another archive pass
 412             TestBotRunner.runPeriodicItems(mlBot);
 413 
 414             // The archive should not contain another entry
 415             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 416             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Integrated\\]&quot;));
 417             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 418         }
 419     }
 420 
 421     @Test
 422     void archiveDirectToIntegrated(TestInfo testInfo) throws IOException {
 423         try (var credentials = new HostCredentials(testInfo);
 424              var tempFolder = new TemporaryDirectory();
 425              var archiveFolder = new TemporaryDirectory();
 426              var webrevFolder = new TemporaryDirectory();
 427              var listServer = new TestMailmanServer();
 428              var webrevServer = new TestWebrevServer()) {
 429             var author = credentials.getHostedRepository();
 430             var archive = credentials.getHostedRepository();
 431             var ignored = credentials.getHostedRepository();
 432             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 433             var censusBuilder = credentials.getCensusBuilder()
 434                                            .addAuthor(author.forge().currentUser().id());
 435             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 436             var mlBot = MailingListBridgeBot.newBuilder()
 437                                             .from(from)
 438                                             .repo(author)
 439                                             .archive(archive)
 440                                             .censusRepo(censusBuilder.build())
 441                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 442                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 443                                             .listArchive(listServer.getArchive())
 444                                             .smtpServer(listServer.getSMTP())
 445                                             .webrevStorageRepository(archive)
 446                                             .webrevStorageRef(&quot;webrev&quot;)
 447                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 448                                             .webrevStorageBaseUri(webrevServer.uri())
 449                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 450                                             .build();
 451 
 452             // Populate the projects repository
 453             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 454             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 455             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 456             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 457 
 458             // Make a change with a corresponding PR
 459             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 460                                                                &quot;Change msg\n\nWith several lines&quot;);
 461             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 462             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 463             pr.setBody(&quot;This should not be ready&quot;);
 464             pr.setState(Issue.State.CLOSED);
 465 
 466             // Run an archive pass
 467             TestBotRunner.runPeriodicItems(mlBot);
 468             TestBotRunner.runPeriodicItems(mlBot);
 469 
 470             // A PR that isn&#39;t ready for review should not be archived
 471             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 472             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 473 
 474             // Now it has been integrated
 475             var ignoredPr = ignored.pullRequest(pr.id());
 476             ignoredPr.setBody(&quot;This has already been integrated&quot;);
 477             ignoredPr.addLabel(&quot;integrated&quot;);
 478             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 479 
 480             // Run another archive pass
 481             TestBotRunner.runPeriodicItems(mlBot);
 482 
 483             // The archive should now contain an entry
 484             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 485             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Integrated: 1234: This is a pull request&quot;));
 486 
 487             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 488             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 489 
 490             // Run another archive pass
 491             TestBotRunner.runPeriodicItems(mlBot);
 492 
 493             // The archive should now contain another entry
 494             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 495             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: Integrated: 1234: This is a pull request \\[v2\\]&quot;));
 496             assertFalse(archiveContains(archiveFolder.path(), &quot;Withdrawn&quot;));
 497         }
 498     }
 499 
 500     @Test
 501     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 502         try (var credentials = new HostCredentials(testInfo);
 503              var tempFolder = new TemporaryDirectory();
 504              var archiveFolder = new TemporaryDirectory();
 505              var webrevFolder = new TemporaryDirectory();
 506              var listServer = new TestMailmanServer();
 507              var webrevServer = new TestWebrevServer()) {
 508             var author = credentials.getHostedRepository();
 509             var archive = credentials.getHostedRepository();
 510             var ignored = credentials.getHostedRepository();
 511             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 512             var censusBuilder = credentials.getCensusBuilder()
 513                                            .addAuthor(author.forge().currentUser().id());
 514             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 515             var mlBot = MailingListBridgeBot.newBuilder()
 516                                             .from(from)
 517                                             .repo(author)
 518                                             .archive(archive)
 519                                             .censusRepo(censusBuilder.build())
 520                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 521                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 522                                             .listArchive(listServer.getArchive())
 523                                             .smtpServer(listServer.getSMTP())
 524                                             .webrevStorageRepository(archive)
 525                                             .webrevStorageRef(&quot;webrev&quot;)
 526                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 527                                             .webrevStorageBaseUri(webrevServer.uri())
 528                                             .readyLabels(Set.of(&quot;rfr&quot;))
 529                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 530                                             .build();
 531 
 532             // Populate the projects repository
 533             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 534             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 535             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 536             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 537 
 538             // Make a change with a corresponding PR
 539             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 540                                                                &quot;Change msg\n\nWith several lines&quot;);
 541             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 542             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 543             pr.setBody(&quot;This should be ready&quot;);
 544 
 545             // Run an archive pass
 546             TestBotRunner.runPeriodicItems(mlBot);
 547             TestBotRunner.runPeriodicItems(mlBot);
 548 
 549             // A PR that isn&#39;t ready for review should not be archived
 550             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 551             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 552 
 553             // Flag it as ready for review
 554             pr.addLabel(&quot;rfr&quot;);
 555 
 556             // Run another archive pass
 557             TestBotRunner.runPeriodicItems(mlBot);
 558 
 559             // The archive should now contain an entry
 560             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 561             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 562 
 563             // Close it and then push another change
 564             pr.setState(Issue.State.CLOSED);
 565             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 566             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 567 
 568             // Run another archive pass
 569             TestBotRunner.runPeriodicItems(mlBot);
 570 
 571             // The archive should now contain another entry - should retain the RFR thread prefix
 572             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 573             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: RFR: 1234: This is a pull request \\[v2\\]&quot;));
 574         }
 575     }
 576 
 577     @Test
 578     void archiveClosed(TestInfo testInfo) throws IOException {
 579         try (var credentials = new HostCredentials(testInfo);
 580              var tempFolder = new TemporaryDirectory();
 581              var archiveFolder = new TemporaryDirectory();
 582              var webrevFolder = new TemporaryDirectory();
 583              var listServer = new TestMailmanServer();
 584              var webrevServer = new TestWebrevServer()) {
 585             var author = credentials.getHostedRepository();
 586             var archive = credentials.getHostedRepository();
 587             var ignored = credentials.getHostedRepository();
 588             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 589             var censusBuilder = credentials.getCensusBuilder()
 590                                            .addAuthor(author.forge().currentUser().id());
 591             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 592             var mlBot = MailingListBridgeBot.newBuilder()
 593                                             .from(from)
 594                                             .repo(author)
 595                                             .archive(archive)
 596                                             .censusRepo(censusBuilder.build())
 597                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 598                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 599                                             .listArchive(listServer.getArchive())
 600                                             .smtpServer(listServer.getSMTP())
 601                                             .webrevStorageRepository(archive)
 602                                             .webrevStorageRef(&quot;webrev&quot;)
 603                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 604                                             .webrevStorageBaseUri(webrevServer.uri())
 605                                             .readyLabels(Set.of(&quot;rfr&quot;))
 606                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 607                                             .build();
 608 
 609             // Populate the projects repository
 610             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 611             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 612             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 613             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 614 
 615             // Make a change with a corresponding PR
 616             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 617                                                                &quot;Change msg\n\nWith several lines&quot;);
 618             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 619             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 620             pr.setBody(&quot;This should be ready&quot;);
 621 
 622             // Run an archive pass
 623             TestBotRunner.runPeriodicItems(mlBot);
 624             TestBotRunner.runPeriodicItems(mlBot);
 625 
 626             // A PR that isn&#39;t ready for review should not be archived
 627             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 628             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 629 
 630             // Flag it as ready for review
 631             pr.addLabel(&quot;rfr&quot;);
 632 
 633             // Run another archive pass
 634             TestBotRunner.runPeriodicItems(mlBot);
 635 
 636             // The archive should now contain an entry
 637             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 638             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 639 
 640             // Close it
 641             pr.setState(Issue.State.CLOSED);
 642 
 643             // Run another archive pass
 644             TestBotRunner.runPeriodicItems(mlBot);
 645 
 646             // The archive should now contain another entry - should say that it is closed
 647             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 648             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Withdrawn: 1234: This is a pull request&quot;));
 649 
 650             pr.addComment(&quot;Fair enough&quot;);
 651 
 652             // Run another archive pass - only a single close notice should have been posted
 653             TestBotRunner.runPeriodicItems(mlBot);
 654             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 655             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Withdrawn: 1234: This is a pull request&quot;));
 656             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: RFR: 1234: This is a pull request&quot;));
 657         }
 658     }
 659 
 660     @Test
 661     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 662         try (var credentials = new HostCredentials(testInfo);
 663              var tempFolder = new TemporaryDirectory();
 664              var archiveFolder = new TemporaryDirectory();
 665              var webrevFolder = new TemporaryDirectory();
 666              var listServer = new TestMailmanServer();
 667              var webrevServer = new TestWebrevServer()) {
 668             var author = credentials.getHostedRepository();
 669             var archive = credentials.getHostedRepository();
 670             var ignored = credentials.getHostedRepository();
 671             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 672             var censusBuilder = credentials.getCensusBuilder()
 673                                            .addAuthor(author.forge().currentUser().id());
 674             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 675             var mlBot = MailingListBridgeBot.newBuilder()
 676                                             .from(from)
 677                                             .repo(author)
 678                                             .archive(archive)
 679                                             .censusRepo(censusBuilder.build())
 680                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 681                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 682                                             .listArchive(listServer.getArchive())
 683                                             .smtpServer(listServer.getSMTP())
 684                                             .webrevStorageRepository(archive)
 685                                             .webrevStorageRef(&quot;webrev&quot;)
 686                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 687                                             .webrevStorageBaseUri(webrevServer.uri())
 688                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 689                                             .build();
 690 
 691             // Populate the projects repository
 692             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 693             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 694             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 695             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 696 
 697             // Make a change with a corresponding PR
 698             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 699                                                                &quot;Change msg\n\nWith several lines&quot;);
 700             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 701             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 702             pr.setBody(&quot;This is an automated merge PR&quot;);
 703             pr.addLabel(&quot;failed-auto-merge&quot;);
 704 
 705             // Run an archive pass
 706             TestBotRunner.runPeriodicItems(mlBot);
 707             TestBotRunner.runPeriodicItems(mlBot);
 708 
 709             // The archive should contain an entry
 710             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 711             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: Cannot automatically merge&quot;));
 712         }
 713     }
 714 
 715     @Test
 716     void reviewComment(TestInfo testInfo) throws IOException {
 717         try (var credentials = new HostCredentials(testInfo);
 718              var tempFolder = new TemporaryDirectory();
 719              var archiveFolder = new TemporaryDirectory();
 720              var listServer = new TestMailmanServer();
 721              var webrevServer = new TestWebrevServer()) {
 722             var author = credentials.getHostedRepository();
 723             var archive = credentials.getHostedRepository();
 724             var ignored = credentials.getHostedRepository();
 725             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 726             var censusBuilder = credentials.getCensusBuilder()
 727                                            .addAuthor(author.forge().currentUser().id());
 728             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 729             var mlBot = MailingListBridgeBot.newBuilder()
 730                                             .from(from)
 731                                             .repo(author)
 732                                             .archive(archive)
 733                                             .censusRepo(censusBuilder.build())
 734                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 735                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 736                                             .listArchive(listServer.getArchive())
 737                                             .smtpServer(listServer.getSMTP())
 738                                             .webrevStorageRepository(archive)
 739                                             .webrevStorageRef(&quot;webrev&quot;)
 740                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 741                                             .webrevStorageBaseUri(webrevServer.uri())
 742                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 743                                             .build();
 744 
 745             // Populate the projects repository
 746             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 747             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 748             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 749             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 750             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 751 
 752             // Make a change with a corresponding PR
 753             var editHash = CheckableRepository.appendAndCommit(localRepo);
 754             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 755             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 756             pr.setBody(&quot;This is now ready&quot;);
 757             TestBotRunner.runPeriodicItems(mlBot);
 758             listServer.processIncoming();
 759 
 760             // And make a file specific comment
 761             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 762             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 763 
 764             // Add one from an ignored user as well
 765             var ignoredPr = ignored.pullRequest(pr.id());
 766             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 767 
 768             // Process comments
 769             TestBotRunner.runPeriodicItems(mlBot);
 770             listServer.processIncoming();
 771 
 772             // The archive should now contain an entry
 773             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 774             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 775             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 776             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 777             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 778             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 779             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 780 
 781             // The mailing list as well
 782             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 783             var mailmanList = mailmanServer.getList(listAddress.address());
 784             var conversations = mailmanList.conversations(Duration.ofDays(1));
 785             assertEquals(1, conversations.size());
 786             var mail = conversations.get(0).first();
 787             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 788 
 789             // Comment on the comment
 790             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 791             TestBotRunner.runPeriodicItems(mlBot);
 792             listServer.processIncoming();
 793 
 794             // The archive should contain the additional comment (but no quoted footers)
 795             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 796             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 797             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 798             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 799 
 800             // As well as the mailing list
 801             conversations = mailmanList.conversations(Duration.ofDays(1));
 802             assertEquals(1, conversations.size());
 803             assertEquals(3, conversations.get(0).allMessages().size());
 804             for (var newMail : conversations.get(0).allMessages()) {
 805                 assertEquals(noreplyAddress(archive), newMail.author().address());
 806                 assertEquals(listAddress, newMail.sender());
 807             }
 808         }
 809     }
 810 
 811     @Test
 812     void combineComments(TestInfo testInfo) throws IOException {
 813         try (var credentials = new HostCredentials(testInfo);
 814              var tempFolder = new TemporaryDirectory();
 815              var archiveFolder = new TemporaryDirectory();
 816              var listServer = new TestMailmanServer();
 817              var webrevServer = new TestWebrevServer()) {
 818             var author = credentials.getHostedRepository();
 819             var archive = credentials.getHostedRepository();
 820             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 821             var censusBuilder = credentials.getCensusBuilder()
 822                                            .addAuthor(author.forge().currentUser().id());
 823             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 824             var mlBot = MailingListBridgeBot.newBuilder()
 825                                             .from(from)
 826                                             .repo(author)
 827                                             .archive(archive)
 828                                             .censusRepo(censusBuilder.build())
 829                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 830                                             .listArchive(listServer.getArchive())
 831                                             .smtpServer(listServer.getSMTP())
 832                                             .webrevStorageRepository(archive)
 833                                             .webrevStorageRef(&quot;webrev&quot;)
 834                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 835                                             .webrevStorageBaseUri(webrevServer.uri())
 836                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 837                                             .build();
 838 
 839             // Populate the projects repository
 840             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 841             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 842             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 843             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 844             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 845 
 846             // Make a change with a corresponding PR
 847             var editHash = CheckableRepository.appendAndCommit(localRepo);
 848             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 849             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 850             pr.setBody(&quot;This is now ready&quot;);
 851             pr.addComment(&quot;Avoid combining&quot;);
 852 
 853             TestBotRunner.runPeriodicItems(mlBot);
 854             listServer.processIncoming();
 855             listServer.processIncoming();
 856 
 857             // Make several file specific comments
 858             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 859             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 860             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 861             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 862             TestBotRunner.runPeriodicItems(mlBot);
 863             listServer.processIncoming();
 864 
 865             // The archive should contain a combined entry
 866             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 867             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 868 
 869             // As well as the mailing list
 870             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 871             var mailmanList = mailmanServer.getList(listAddress.address());
 872             var conversations = mailmanList.conversations(Duration.ofDays(1));
 873             assertEquals(1, conversations.size());
 874             var mail = conversations.get(0).first();
 875             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 876             assertEquals(3, conversations.get(0).allMessages().size());
 877 
 878             var commentReply = conversations.get(0).replies(mail).get(0);
 879             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 880             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 881 
 882             var reviewReply = conversations.get(0).replies(mail).get(1);
 883             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 884             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 885             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 886             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 887             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 888 
 889             // Now reply to the first and second (collapsed) comment
 890             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 891             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 892             TestBotRunner.runPeriodicItems(mlBot);
 893             listServer.processIncoming();
 894 
 895             // The archive should contain a new entry
 896             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 897             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 898 
 899             // The combined review comments should only appear unquoted once
 900             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 901         }
 902     }
 903 
 904     @Test
 905     void commentThreading(TestInfo testInfo) throws IOException {
 906         try (var credentials = new HostCredentials(testInfo);
 907              var tempFolder = new TemporaryDirectory();
 908              var archiveFolder = new TemporaryDirectory();
 909              var listServer = new TestMailmanServer();
 910              var webrevServer = new TestWebrevServer()) {
 911             var author = credentials.getHostedRepository();
 912             var reviewer = credentials.getHostedRepository();
 913             var archive = credentials.getHostedRepository();
 914             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 915             var censusBuilder = credentials.getCensusBuilder()
 916                                            .addReviewer(reviewer.forge().currentUser().id())
 917                                            .addAuthor(author.forge().currentUser().id());
 918             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 919             var mlBot = MailingListBridgeBot.newBuilder()
 920                                             .from(from)
 921                                             .repo(author)
 922                                             .archive(archive)
 923                                             .censusRepo(censusBuilder.build())
 924                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 925                                             .listArchive(listServer.getArchive())
 926                                             .smtpServer(listServer.getSMTP())
 927                                             .webrevStorageRepository(archive)
 928                                             .webrevStorageRef(&quot;webrev&quot;)
 929                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 930                                             .webrevStorageBaseUri(webrevServer.uri())
 931                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 932                                             .build();
 933 
 934             // Populate the projects repository
 935             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 936             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 937             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 938             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 939             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 940 
 941             // Make a change with a corresponding PR
 942             var editHash = CheckableRepository.appendAndCommit(localRepo);
 943             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 944             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 945             pr.setBody(&quot;This is now ready&quot;);
 946             TestBotRunner.runPeriodicItems(mlBot);
 947             listServer.processIncoming();
 948 
 949             // Make a file specific comment
 950             var reviewPr = reviewer.pullRequest(pr.id());
 951             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 952             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 953             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 954             TestBotRunner.runPeriodicItems(mlBot);
 955             listServer.processIncoming();
 956             listServer.processIncoming();
 957             listServer.processIncoming();
 958 
 959             // And a second one by ourselves
 960             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 961             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 962             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 963             TestBotRunner.runPeriodicItems(mlBot);
 964             listServer.processIncoming();
 965             listServer.processIncoming();
 966             listServer.processIncoming();
 967 
 968             // Finally some approvals and another comment
 969             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 970             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 971             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 972             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 973             TestBotRunner.runPeriodicItems(mlBot);
 974             listServer.processIncoming();
 975             listServer.processIncoming();
 976             listServer.processIncoming();
 977 
 978             // Sanity check the archive
 979             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 980             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 981 
 982             // File specific comments should appear after the approval
 983             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 984             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 985 
 986             // Check the mailing list
 987             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 988             var mailmanList = mailmanServer.getList(listAddress.address());
 989             var conversations = mailmanList.conversations(Duration.ofDays(1));
 990             assertEquals(1, conversations.size());
 991             var mail = conversations.get(0).first();
 992             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 993             assertEquals(10, conversations.get(0).allMessages().size());
 994 
 995             // There should be four separate threads
 996             var thread1 = conversations.get(0).replies(mail).get(0);
 997             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 998             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 999             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
1000             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
1001             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
1002             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
1003             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
1004             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
1005             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
1006             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
1007             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
1008             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
1009             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
1010 
1011             var thread2 = conversations.get(0).replies(mail).get(1);
1012             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
1013             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
1014             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
1015             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
1016             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
1017             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
1018             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
1019             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
1020             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
1021 
1022             var replies = conversations.get(0).replies(mail);
1023             var thread3 = replies.get(2);
1024             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
1025             var thread4 = replies.get(3);
1026             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
1027             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
1028             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
1029             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
1030         }
1031     }
1032 
1033     @Test
1034     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
1035         try (var credentials = new HostCredentials(testInfo);
1036              var tempFolder = new TemporaryDirectory();
1037              var archiveFolder = new TemporaryDirectory();
1038              var listServer = new TestMailmanServer();
1039              var webrevServer = new TestWebrevServer()) {
1040             var author = credentials.getHostedRepository();
1041             var reviewer = credentials.getHostedRepository();
1042             var archive = credentials.getHostedRepository();
1043             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1044             var censusBuilder = credentials.getCensusBuilder()
1045                                            .addReviewer(reviewer.forge().currentUser().id())
1046                                            .addAuthor(author.forge().currentUser().id());
1047             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1048             var mlBot = MailingListBridgeBot.newBuilder()
1049                                             .from(from)
1050                                             .repo(author)
1051                                             .archive(archive)
1052                                             .censusRepo(censusBuilder.build())
1053                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1054                                             .listArchive(listServer.getArchive())
1055                                             .smtpServer(listServer.getSMTP())
1056                                             .webrevStorageRepository(archive)
1057                                             .webrevStorageRef(&quot;webrev&quot;)
1058                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1059                                             .webrevStorageBaseUri(webrevServer.uri())
1060                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1061                                             .build();
1062 
1063             // Populate the projects repository
1064             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1065             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1066             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1067             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1068             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1069 
1070             // Make a change with a corresponding PR
1071             var editHash = CheckableRepository.appendAndCommit(localRepo);
1072             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1073             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1074             pr.setBody(&quot;This is now ready&quot;);
1075             TestBotRunner.runPeriodicItems(mlBot);
1076             listServer.processIncoming();
1077 
1078             // Make two file specific comments
1079             var reviewPr = reviewer.pullRequest(pr.id());
1080             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1081             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
1082             TestBotRunner.runPeriodicItems(mlBot);
1083             listServer.processIncoming();
1084 
1085             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
1086             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
1087             TestBotRunner.runPeriodicItems(mlBot);
1088             listServer.processIncoming();
1089 
1090             // Sanity check the archive
1091             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1092             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
1093         }
1094     }
1095 
1096     @Test
1097     void commentWithMention(TestInfo testInfo) throws IOException {
1098         try (var credentials = new HostCredentials(testInfo);
1099              var tempFolder = new TemporaryDirectory();
1100              var archiveFolder = new TemporaryDirectory();
1101              var listServer = new TestMailmanServer();
1102              var webrevServer = new TestWebrevServer()) {
1103             var author = credentials.getHostedRepository();
1104             var reviewer = credentials.getHostedRepository();
1105             var archive = credentials.getHostedRepository();
1106             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1107             var censusBuilder = credentials.getCensusBuilder()
1108                                            .addReviewer(reviewer.forge().currentUser().id())
1109                                            .addAuthor(author.forge().currentUser().id());
1110             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1111             var mlBot = MailingListBridgeBot.newBuilder()
1112                                             .from(from)
1113                                             .repo(author)
1114                                             .archive(archive)
1115                                             .censusRepo(censusBuilder.build())
1116                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1117                                             .listArchive(listServer.getArchive())
1118                                             .smtpServer(listServer.getSMTP())
1119                                             .webrevStorageRepository(archive)
1120                                             .webrevStorageRef(&quot;webrev&quot;)
1121                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1122                                             .webrevStorageBaseUri(webrevServer.uri())
1123                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1124                                             .build();
1125 
1126             // Populate the projects repository
1127             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1128             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1129             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1130             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1131             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1132 
1133             // Make a change with a corresponding PR
1134             var editHash = CheckableRepository.appendAndCommit(localRepo);
1135             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1136             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1137             pr.setBody(&quot;This is now ready&quot;);
1138             TestBotRunner.runPeriodicItems(mlBot);
1139             listServer.processIncoming();
1140 
1141             // Make two comments from different authors
1142             var reviewPr = reviewer.pullRequest(pr.id());
1143             reviewPr.addComment(&quot;First comment&quot;);
1144             pr.addComment(&quot;Second comment&quot;);
1145 
1146             TestBotRunner.runPeriodicItems(mlBot);
1147             listServer.processIncoming();
1148 
1149             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1150             TestBotRunner.runPeriodicItems(mlBot);
1151             listServer.processIncoming();
1152 
1153             // The first comment should be quoted more often than the second
1154             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1155             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1156             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1157         }
1158     }
1159 
1160     @Test
1161     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
1162         try (var credentials = new HostCredentials(testInfo);
1163              var tempFolder = new TemporaryDirectory();
1164              var archiveFolder = new TemporaryDirectory();
1165              var listServer = new TestMailmanServer();
1166              var webrevServer = new TestWebrevServer()) {
1167             var author = credentials.getHostedRepository();
1168             var reviewer = credentials.getHostedRepository();
1169             var archive = credentials.getHostedRepository();
1170             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1171             var censusBuilder = credentials.getCensusBuilder()
1172                                            .addReviewer(reviewer.forge().currentUser().id())
1173                                            .addAuthor(author.forge().currentUser().id());
1174             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1175             var mlBot = MailingListBridgeBot.newBuilder()
1176                                             .from(from)
1177                                             .repo(author)
1178                                             .archive(archive)
1179                                             .censusRepo(censusBuilder.build())
1180                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1181                                             .listArchive(listServer.getArchive())
1182                                             .smtpServer(listServer.getSMTP())
1183                                             .webrevStorageRepository(archive)
1184                                             .webrevStorageRef(&quot;webrev&quot;)
1185                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1186                                             .webrevStorageBaseUri(webrevServer.uri())
1187                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1188                                             .build();
1189 
1190             // Populate the projects repository
1191             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1192             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1193             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1194             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1195             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1196 
1197             // Make a change with a corresponding PR
1198             var editHash = CheckableRepository.appendAndCommit(localRepo);
1199             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1200             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1201             pr.setBody(&quot;This is now ready&quot;);
1202             TestBotRunner.runPeriodicItems(mlBot);
1203             listServer.processIncoming();
1204 
1205             // Make two review comments from different authors
1206             var reviewPr = reviewer.pullRequest(pr.id());
1207             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1208             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
1209             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
1210 
1211             TestBotRunner.runPeriodicItems(mlBot);
1212             listServer.processIncoming();
1213 
1214             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1215             TestBotRunner.runPeriodicItems(mlBot);
1216             listServer.processIncoming();
1217 
1218             // The first comment should be quoted more often than the second
1219             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1220             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
1221             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
1222         }
1223     }
1224 
1225     @Test
1226     void commentWithQuote(TestInfo testInfo) throws IOException {
1227         try (var credentials = new HostCredentials(testInfo);
1228              var tempFolder = new TemporaryDirectory();
1229              var archiveFolder = new TemporaryDirectory();
1230              var listServer = new TestMailmanServer();
1231              var webrevServer = new TestWebrevServer()) {
1232             var author = credentials.getHostedRepository();
1233             var reviewer = credentials.getHostedRepository();
1234             var archive = credentials.getHostedRepository();
1235             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1236             var censusBuilder = credentials.getCensusBuilder()
1237                                            .addReviewer(reviewer.forge().currentUser().id())
1238                                            .addAuthor(author.forge().currentUser().id());
1239             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1240             var mlBot = MailingListBridgeBot.newBuilder()
1241                                             .from(from)
1242                                             .repo(author)
1243                                             .archive(archive)
1244                                             .censusRepo(censusBuilder.build())
1245                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1246                                             .listArchive(listServer.getArchive())
1247                                             .smtpServer(listServer.getSMTP())
1248                                             .webrevStorageRepository(archive)
1249                                             .webrevStorageRef(&quot;webrev&quot;)
1250                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1251                                             .webrevStorageBaseUri(webrevServer.uri())
1252                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1253                                             .build();
1254 
1255             // Populate the projects repository
1256             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1257             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1258             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1259             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1260             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1261 
1262             // Make a change with a corresponding PR
1263             var editHash = CheckableRepository.appendAndCommit(localRepo);
1264             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1265             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1266             pr.setBody(&quot;This is now ready&quot;);
1267             TestBotRunner.runPeriodicItems(mlBot);
1268             listServer.processIncoming();
1269 
1270             // Make two comments from different authors
1271             var reviewPr = reviewer.pullRequest(pr.id());
1272             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
1273             pr.addComment(&quot;Second comment\nfourth line&quot;);
1274 
1275             TestBotRunner.runPeriodicItems(mlBot);
1276             listServer.processIncoming();
1277 
1278             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
1279             TestBotRunner.runPeriodicItems(mlBot);
1280             listServer.processIncoming();
1281 
1282             // The first comment should be quoted more often than the second
1283             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1284             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1285             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
1286             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1287         }
1288     }
1289 
1290     @Test
1291     void reviewContext(TestInfo testInfo) throws IOException {
1292         try (var credentials = new HostCredentials(testInfo);
1293              var tempFolder = new TemporaryDirectory();
1294              var archiveFolder = new TemporaryDirectory();
1295              var listServer = new TestMailmanServer();
1296              var webrevServer = new TestWebrevServer()) {
1297             var author = credentials.getHostedRepository();
1298             var archive = credentials.getHostedRepository();
1299             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1300             var censusBuilder = credentials.getCensusBuilder()
1301                                            .addAuthor(author.forge().currentUser().id());
1302             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1303             var mlBot = MailingListBridgeBot.newBuilder()
1304                                             .from(from)
1305                                             .repo(author)
1306                                             .archive(archive)
1307                                             .censusRepo(censusBuilder.build())
1308                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1309                                             .listArchive(listServer.getArchive())
1310                                             .smtpServer(listServer.getSMTP())
1311                                             .webrevStorageRepository(archive)
1312                                             .webrevStorageRef(&quot;webrev&quot;)
1313                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1314                                             .webrevStorageBaseUri(webrevServer.uri())
1315                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1316                                             .build();
1317 
1318             // Populate the projects repository
1319             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1320             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1321             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1322             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1323             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1324 
1325             // Make a change with a corresponding PR
1326             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1327             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1328             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1329             pr.setBody(&quot;This is now ready&quot;);
1330             TestBotRunner.runPeriodicItems(mlBot);
1331             listServer.processIncoming();
1332 
1333             // Make a file specific comment
1334             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1335 
1336             TestBotRunner.runPeriodicItems(mlBot);
1337             listServer.processIncoming();
1338 
1339             // The archive should only contain context around line 2
1340             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1341             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1342             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1343             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1344         }
1345     }
1346 
1347     @Test
1348     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1349         try (var credentials = new HostCredentials(testInfo);
1350              var tempFolder = new TemporaryDirectory();
1351              var archiveFolder = new TemporaryDirectory();
1352              var listServer = new TestMailmanServer();
1353              var webrevServer = new TestWebrevServer()) {
1354             var author = credentials.getHostedRepository();
1355             var archive = credentials.getHostedRepository();
1356             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1357             var censusBuilder = credentials.getCensusBuilder()
1358                                            .addAuthor(author.forge().currentUser().id());
1359             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1360             var mlBot = MailingListBridgeBot.newBuilder()
1361                                             .from(from)
1362                                             .repo(author)
1363                                             .archive(archive)
1364                                             .censusRepo(censusBuilder.build())
1365                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1366                                             .listArchive(listServer.getArchive())
1367                                             .smtpServer(listServer.getSMTP())
1368                                             .webrevStorageRepository(archive)
1369                                             .webrevStorageRef(&quot;webrev&quot;)
1370                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1371                                             .webrevStorageBaseUri(webrevServer.uri())
1372                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1373                                             .build();
1374 
1375             // Populate the projects repository
1376             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1377             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1378             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1379             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1380             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1381             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1382                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1383                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1384                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1385                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1386                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1387                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1388             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1389 
1390             // Make a change with a corresponding PR
1391             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1392             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1393             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1394             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1395             var editHash = CheckableRepository.appendAndCommit(localRepo);
1396             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1397             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1398             pr.setBody(&quot;This is now ready&quot;);
1399             TestBotRunner.runPeriodicItems(mlBot);
1400             listServer.processIncoming();
1401 
1402             // Make file specific comments
1403             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1404             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1405 
1406             TestBotRunner.runPeriodicItems(mlBot);
1407             listServer.processIncoming();
1408 
1409             // The archive should only contain context around line 2 and 20
1410             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1411             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1412             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1413             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1414             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1415 
1416             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1417             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1418             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1419             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1420         }
1421     }
1422 
1423     @Test
1424     void filterComments(TestInfo testInfo) throws IOException {
1425         try (var credentials = new HostCredentials(testInfo);
1426              var tempFolder = new TemporaryDirectory();
1427              var archiveFolder = new TemporaryDirectory();
1428              var listServer = new TestMailmanServer();
1429              var webrevServer = new TestWebrevServer()) {
1430             var author = credentials.getHostedRepository();
1431             var archive = credentials.getHostedRepository();
1432             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1433             var censusBuilder = credentials.getCensusBuilder()
1434                                            .addAuthor(author.forge().currentUser().id());
1435             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1436             var mlBot = MailingListBridgeBot.newBuilder()
1437                                             .from(from)
1438                                             .repo(author)
1439                                             .archive(archive)
1440                                             .censusRepo(censusBuilder.build())
1441                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1442                                             .listArchive(listServer.getArchive())
1443                                             .smtpServer(listServer.getSMTP())
1444                                             .webrevStorageRepository(archive)
1445                                             .webrevStorageRef(&quot;webrev&quot;)
1446                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1447                                             .webrevStorageBaseUri(webrevServer.uri())
1448                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1449                                             .build();
1450 
1451             // Populate the projects repository
1452             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1453             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1454             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1455             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1456             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1457 
1458             // Make a change with a corresponding PR
1459             var editHash = CheckableRepository.appendAndCommit(localRepo);
1460             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1461             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1462             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1463                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1464 
1465             // Make a bunch of comments
1466             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1467             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1468             pr.addComment(&quot;/integrate stuff&quot;);
1469             TestBotRunner.runPeriodicItems(mlBot);
1470 
1471             // Run an archive pass
1472             TestBotRunner.runPeriodicItems(mlBot);
1473 
1474             // The archive should not contain the comment
1475             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1476             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1477             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1478             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1479             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1480             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1481             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1482             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1483             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1484             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1485         }
1486     }
1487 
1488     @Test
1489     void incrementalChanges(TestInfo testInfo) throws IOException {
1490         try (var credentials = new HostCredentials(testInfo);
1491              var tempFolder = new TemporaryDirectory();
1492              var archiveFolder = new TemporaryDirectory();
1493              var listServer = new TestMailmanServer();
1494              var webrevServer = new TestWebrevServer()) {
1495             var author = credentials.getHostedRepository();
1496             var archive = credentials.getHostedRepository();
1497             var commenter = credentials.getHostedRepository();
1498             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1499             var censusBuilder = credentials.getCensusBuilder()
1500                                            .addAuthor(author.forge().currentUser().id());
1501             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1502             var mlBot = MailingListBridgeBot.newBuilder()
1503                                             .from(from)
1504                                             .repo(author)
1505                                             .archive(archive)
1506                                             .censusRepo(censusBuilder.build())
1507                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1508                                             .listArchive(listServer.getArchive())
1509                                             .smtpServer(listServer.getSMTP())
1510                                             .webrevStorageRepository(archive)
1511                                             .webrevStorageRef(&quot;webrev&quot;)
1512                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1513                                             .webrevStorageBaseUri(webrevServer.uri())
1514                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1515                                             .build();
1516 
1517             // Populate the projects repository
1518             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1519             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1520             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1521             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1522             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1523 
1524             // Make a change with a corresponding PR
1525             var editHash = CheckableRepository.appendAndCommit(localRepo);
1526             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1527             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1528             pr.setBody(&quot;This is now ready&quot;);
1529 
1530             // Run an archive pass
1531             TestBotRunner.runPeriodicItems(mlBot);
1532             listServer.processIncoming();
1533 
1534             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1535             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1536 
1537             // Make sure that the push registered
1538             var lastHeadHash = pr.headHash();
1539             var refreshCount = 0;
1540             do {
1541                 pr = author.pullRequest(pr.id());
1542                 if (refreshCount++ &gt; 100) {
1543                     fail(&quot;The PR did not update after the new push&quot;);
1544                 }
1545             } while (pr.headHash().equals(lastHeadHash));
1546 
1547             // Run another archive pass
1548             TestBotRunner.runPeriodicItems(mlBot);
1549             TestBotRunner.runPeriodicItems(mlBot);
1550             TestBotRunner.runPeriodicItems(mlBot);
1551             listServer.processIncoming();
1552 
1553             // The archive should reference the updated push
1554             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1555             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1556             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/01&quot;));
1557             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/00-01&quot;));
1558             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1559             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1560             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1561 
1562             // The webrev comment should be updated
1563             var comments = pr.comments();
1564             var webrevComments = comments.stream()
1565                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1566                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1567                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1568                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1569                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1570                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1571                                          .collect(Collectors.toList());
1572             assertEquals(1, webrevComments.size());
1573 
1574             // Check that sender address is set properly
1575             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1576             var mailmanList = mailmanServer.getList(listAddress.address());
1577             var conversations = mailmanList.conversations(Duration.ofDays(1));
1578             assertEquals(1, conversations.size());
1579             for (var newMail : conversations.get(0).allMessages()) {
1580                 assertEquals(noreplyAddress(archive), newMail.author().address());
1581                 assertEquals(listAddress, newMail.sender());
1582             }
1583 
1584             // Add a comment
1585             var commenterPr = commenter.pullRequest(pr.id());
1586             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1587             TestBotRunner.runPeriodicItems(mlBot);
1588             listServer.processIncoming();
1589 
1590             // Ensure that additional updates are only reported once
1591             for (int i = 0; i &lt; 3; ++i) {
1592                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1593                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1594 
1595                 // Make sure that the push registered
1596                 lastHeadHash = pr.headHash();
1597                 refreshCount = 0;
1598                 do {
1599                     pr = author.pullRequest(pr.id());
1600                     if (refreshCount++ &gt; 100) {
1601                         fail(&quot;The PR did not update after the new push&quot;);
1602                     }
1603                 } while (pr.headHash().equals(lastHeadHash));
1604 
1605                 TestBotRunner.runPeriodicItems(mlBot);
1606                 TestBotRunner.runPeriodicItems(mlBot);
1607                 listServer.processIncoming();
1608             }
1609             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1610             assertEquals(1, updatedConversations.size());
1611             var conversation = updatedConversations.get(0);
1612             assertEquals(6, conversation.allMessages().size());
1613             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversation.allMessages().get(1).subject());
1614             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1615             assertEquals(&quot;RFR: This is a pull request [v5]&quot;, conversation.allMessages().get(5).subject());
1616         }
1617     }
1618 
1619     @Test
1620     void rebased(TestInfo testInfo) throws IOException {
1621         try (var credentials = new HostCredentials(testInfo);
1622              var tempFolder = new TemporaryDirectory();
1623              var archiveFolder = new TemporaryDirectory();
1624              var listServer = new TestMailmanServer();
1625              var webrevServer = new TestWebrevServer()) {
1626             var author = credentials.getHostedRepository();
1627             var archive = credentials.getHostedRepository();
1628             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1629             var censusBuilder = credentials.getCensusBuilder()
1630                                            .addAuthor(author.forge().currentUser().id());
1631             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1632             var mlBot = MailingListBridgeBot.newBuilder()
1633                                             .from(sender)
1634                                             .repo(author)
1635                                             .archive(archive)
1636                                             .censusRepo(censusBuilder.build())
1637                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1638                                             .listArchive(listServer.getArchive())
1639                                             .smtpServer(listServer.getSMTP())
1640                                             .webrevStorageRepository(archive)
1641                                             .webrevStorageRef(&quot;webrev&quot;)
1642                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1643                                             .webrevStorageBaseUri(webrevServer.uri())
1644                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1645                                             .build();
1646 
1647             // Populate the projects repository
1648             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1649             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1650             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1651             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1652             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1653 
1654             // Make a change with a corresponding PR
1655             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1656             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1657             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1658             pr.setBody(&quot;This is now ready&quot;);
1659 
1660             // Run an archive pass
1661             TestBotRunner.runPeriodicItems(mlBot);
1662             listServer.processIncoming();
1663 
1664             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1665             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1666             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1667 
1668             // Make sure that the push registered
1669             var lastHeadHash = pr.headHash();
1670             var refreshCount = 0;
1671             do {
1672                 pr = author.pullRequest(pr.id());
1673                 if (refreshCount++ &gt; 100) {
1674                     fail(&quot;The PR did not update after the new push&quot;);
1675                 }
1676             } while (pr.headHash().equals(lastHeadHash));
1677 
1678             // Run another archive pass
1679             TestBotRunner.runPeriodicItems(mlBot);
1680             listServer.processIncoming();
1681 
1682             // The archive should reference the rebased push
1683             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1684             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1685             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));
1686             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1687             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1688             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1689             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1690             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1691 
1692             // The webrev comment should be updated
1693             var comments = pr.comments();
1694             var webrevComments = comments.stream()
1695                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1696                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1697                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1698                                          .collect(Collectors.toList());
1699             assertEquals(1, webrevComments.size());
1700 
1701             // Check that sender address is set properly
1702             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1703             var mailmanList = mailmanServer.getList(listAddress.address());
1704             var conversations = mailmanList.conversations(Duration.ofDays(1));
1705             assertEquals(1, conversations.size());
1706             for (var newMail : conversations.get(0).allMessages()) {
1707                 assertEquals(noreplyAddress(archive), newMail.author().address());
1708                 assertEquals(listAddress, newMail.sender());
1709                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1710             }
1711             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversations.get(0).allMessages().get(1).subject());
1712         }
1713     }
1714 
1715     @Test
1716     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1717         try (var credentials = new HostCredentials(testInfo);
1718              var tempFolder = new TemporaryDirectory();
1719              var archiveFolder = new TemporaryDirectory();
1720              var listServer = new TestMailmanServer();
1721              var webrevServer = new TestWebrevServer()) {
1722             var author = credentials.getHostedRepository();
1723             var archive = credentials.getHostedRepository();
1724             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1725             var censusBuilder = credentials.getCensusBuilder()
1726                                            .addAuthor(author.forge().currentUser().id());
1727             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1728             var mlBot = MailingListBridgeBot.newBuilder()
1729                                             .from(sender)
1730                                             .repo(author)
1731                                             .archive(archive)
1732                                             .archiveRef(&quot;archive&quot;)
1733                                             .censusRepo(censusBuilder.build())
1734                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1735                                             .listArchive(listServer.getArchive())
1736                                             .smtpServer(listServer.getSMTP())
1737                                             .webrevStorageRepository(archive)
1738                                             .webrevStorageRef(&quot;webrev&quot;)
1739                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1740                                             .webrevStorageBaseUri(webrevServer.uri())
1741                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1742                                             .build();
1743 
1744             // Populate the projects repository
1745             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1746             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1747             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1748             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1749             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1750             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1751 
1752             // Make a change with a corresponding PR
1753             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1754             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1755             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1756             pr.setBody(&quot;This is now ready&quot;);
1757 
1758             // Run an archive pass
1759             TestBotRunner.runPeriodicItems(mlBot);
1760             listServer.processIncoming();
1761 
1762             // Push more stuff to master
1763             localRepo.checkout(masterHash, true);
1764             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1765             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1766             localRepo.add(unrelatedFile);
1767             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1768             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1769 
1770             // And more stuff to the pr branch
1771             localRepo.checkout(editHash, true);
1772             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1773 
1774             // Merge master
1775             localRepo.merge(newMasterHash);
1776             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1777             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1778 
1779             // Make sure that the push registered
1780             var lastHeadHash = pr.headHash();
1781             var refreshCount = 0;
1782             do {
1783                 pr = author.pullRequest(pr.id());
1784                 if (refreshCount++ &gt; 100) {
1785                     fail(&quot;The PR did not update after the new push&quot;);
1786                 }
1787             } while (pr.headHash().equals(lastHeadHash));
1788 
1789             // Run another archive pass
1790             TestBotRunner.runPeriodicItems(mlBot);
1791             listServer.processIncoming();
1792 
1793             // The archive should reference the rebased push
1794             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1795             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1796             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1797             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));
1798             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00-01&quot;));
1799             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1800             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1801         }
1802     }
1803 
1804     @Test
1805     void mergeWebrev(TestInfo testInfo) throws IOException {
1806         try (var credentials = new HostCredentials(testInfo);
1807              var tempFolder = new TemporaryDirectory();
1808              var archiveFolder = new TemporaryDirectory();
1809              var listServer = new TestMailmanServer();
1810              var webrevServer = new TestWebrevServer()) {
1811             var author = credentials.getHostedRepository();
1812             var archive = credentials.getHostedRepository();
1813             var commenter = credentials.getHostedRepository();
1814             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1815             var censusBuilder = credentials.getCensusBuilder()
1816                                            .addAuthor(author.forge().currentUser().id());
1817             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1818             var mlBot = MailingListBridgeBot.newBuilder()
1819                                             .from(from)
1820                                             .repo(author)
1821                                             .archive(archive)
1822                                             .archiveRef(&quot;archive&quot;)
1823                                             .censusRepo(censusBuilder.build())
1824                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1825                                             .listArchive(listServer.getArchive())
1826                                             .smtpServer(listServer.getSMTP())
1827                                             .webrevStorageRepository(archive)
1828                                             .webrevStorageRef(&quot;webrev&quot;)
1829                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1830                                             .webrevStorageBaseUri(webrevServer.uri())
1831                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1832                                             .build();
1833 
1834             // Populate the projects repository
1835             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1836             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1837             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1838             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1839             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1840             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1841 
1842             // Create a diverging branch
1843             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1844             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1845             localRepo.add(editOnlyFile);
1846             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1847             localRepo.push(editHash, author.url(), &quot;edit&quot;);
1848 
1849             // Make conflicting changes in the target
1850             localRepo.checkout(masterHash, true);
1851             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1852             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1853             localRepo.add(masterOnlyFile);
1854             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1855             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1856 
1857             // Perform the merge - resolve conflicts in our favor
1858             localRepo.merge(editHash, &quot;ours&quot;);
1859             localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1860             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1861             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1862             localRepo.add(mergeOnlyFile);
1863             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1864             localRepo.add(reviewFile);
1865             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1866             localRepo.push(appendedCommit, author.url(), &quot;merge_of_edit&quot;, true);
1867 
1868             // Make a merge PR
1869             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;merge_of_edit&quot;, &quot;Merge edit&quot;);
1870             pr.setBody(&quot;This is now ready&quot;);
1871 
1872             // Run an archive pass
1873             TestBotRunner.runPeriodicItems(mlBot);
1874             listServer.processIncoming();
1875 
1876             // The archive should contain a merge style webrev
1877             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1878             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrevs contain the adjustments done while merging with regards to each parent branch:&quot;));
1879             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00.0&quot;));
1880             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1881 
1882             // The PR should contain a webrev comment
1883             assertEquals(1, pr.comments().size());
1884             var webrevComment = pr.comments().get(0);
1885             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1886             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1887         }
1888     }
1889 
1890     @Test
1891     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1892         try (var credentials = new HostCredentials(testInfo);
1893              var tempFolder = new TemporaryDirectory();
1894              var archiveFolder = new TemporaryDirectory();
1895              var listServer = new TestMailmanServer();
1896              var webrevServer = new TestWebrevServer()) {
1897             var author = credentials.getHostedRepository();
1898             var archive = credentials.getHostedRepository();
1899             var commenter = credentials.getHostedRepository();
1900             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1901             var censusBuilder = credentials.getCensusBuilder()
1902                                            .addAuthor(author.forge().currentUser().id());
1903             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1904             var mlBot = MailingListBridgeBot.newBuilder()
1905                                             .from(from)
1906                                             .repo(author)
1907                                             .archive(archive)
1908                                             .archiveRef(&quot;archive&quot;)
1909                                             .censusRepo(censusBuilder.build())
1910                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1911                                             .listArchive(listServer.getArchive())
1912                                             .smtpServer(listServer.getSMTP())
1913                                             .webrevStorageRepository(archive)
1914                                             .webrevStorageRef(&quot;webrev&quot;)
1915                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1916                                             .webrevStorageBaseUri(webrevServer.uri())
1917                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1918                                             .build();
1919 
1920             // Populate the projects repository
1921             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1922             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1923             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1924             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1925             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1926             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1927 
1928             // Create a merge
1929             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1930             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1931             localRepo.add(editOnlyFile);
1932             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1933             localRepo.checkout(masterHash, true);
1934             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1935             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1936             localRepo.add(masterOnlyFile);
1937             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1938             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1939             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1940 
1941             // Make a merge PR
1942             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1943             pr.setBody(&quot;This is now ready&quot;);
1944 
1945             // Run an archive pass
1946             TestBotRunner.runPeriodicItems(mlBot);
1947             listServer.processIncoming();
1948 
1949             // The archive should contain a merge style webrev
1950             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1951             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrev contains the conflicts with master:&quot;));
1952             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00.conflicts&quot;));
1953             assertTrue(archiveContains(archiveFolder.path(), &quot;2 lines in 2 files changed: 2 ins; 0 del; 0 mod&quot;));
1954 
1955             // The PR should contain a webrev comment
1956             assertEquals(1, pr.comments().size());
1957             var webrevComment = pr.comments().get(0);
1958             assertTrue(webrevComment.body().contains(&quot;Merge conflicts&quot;));
1959         }
1960     }
1961 
1962     @Test
1963     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1964         try (var credentials = new HostCredentials(testInfo);
1965              var tempFolder = new TemporaryDirectory();
1966              var archiveFolder = new TemporaryDirectory();
1967              var listServer = new TestMailmanServer();
1968              var webrevServer = new TestWebrevServer()) {
1969             var author = credentials.getHostedRepository();
1970             var archive = credentials.getHostedRepository();
1971             var commenter = credentials.getHostedRepository();
1972             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1973             var censusBuilder = credentials.getCensusBuilder()
1974                                            .addAuthor(author.forge().currentUser().id());
1975             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1976             var mlBot = MailingListBridgeBot.newBuilder()
1977                                             .from(from)
1978                                             .repo(author)
1979                                             .archive(archive)
1980                                             .archiveRef(&quot;archive&quot;)
1981                                             .censusRepo(censusBuilder.build())
1982                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1983                                             .listArchive(listServer.getArchive())
1984                                             .smtpServer(listServer.getSMTP())
1985                                             .webrevStorageRepository(archive)
1986                                             .webrevStorageRef(&quot;webrev&quot;)
1987                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1988                                             .webrevStorageBaseUri(webrevServer.uri())
1989                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1990                                             .build();
1991 
1992             // Populate the projects repository
1993             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1994             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1995             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1996             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1997             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1998             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1999 
2000             // Create a merge
2001             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
2002             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
2003             localRepo.add(editOnlyFile);
2004             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
2005             localRepo.checkout(masterHash, true);
2006             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
2007             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
2008             localRepo.add(masterOnlyFile);
2009             var updatedMasterHash = localRepo.commit(&quot;Only added in master&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2010             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
2011             localRepo.merge(editHash);
2012             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2013             localRepo.push(mergeCommit, author.url(), &quot;edit&quot;, true);
2014 
2015             // Make a merge PR
2016             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
2017             pr.setBody(&quot;This is now ready&quot;);
2018 
2019             // Run an archive pass
2020             TestBotRunner.runPeriodicItems(mlBot);
2021             listServer.processIncoming();
2022 
2023             // The archive should contain a merge style webrev
2024             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
2025             assertTrue(archiveContains(archiveFolder.path(), &quot;so no merge-specific webrevs have been generated&quot;));
2026 
2027             // The PR should not contain a webrev comment
2028             assertEquals(0, pr.comments().size());
2029         }
2030     }
2031 
2032     @Test
2033     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
2034         try (var credentials = new HostCredentials(testInfo);
2035              var tempFolder = new TemporaryDirectory();
2036              var archiveFolder = new TemporaryDirectory();
2037              var webrevFolder = new TemporaryDirectory();
2038              var listServer = new TestMailmanServer();
2039              var webrevServer = new TestWebrevServer()) {
2040             var author = credentials.getHostedRepository();
2041             var archive = credentials.getHostedRepository();
2042             var ignored = credentials.getHostedRepository();
2043             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2044             var censusBuilder = credentials.getCensusBuilder()
2045                                            .addAuthor(author.forge().currentUser().id());
2046             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2047             var mlBot = MailingListBridgeBot.newBuilder()
2048                                             .from(from)
2049                                             .repo(author)
2050                                             .archive(archive)
2051                                             .censusRepo(censusBuilder.build())
2052                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2053                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2054                                             .listArchive(listServer.getArchive())
2055                                             .smtpServer(listServer.getSMTP())
2056                                             .webrevStorageRepository(archive)
2057                                             .webrevStorageRef(&quot;webrev&quot;)
2058                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2059                                             .webrevStorageBaseUri(webrevServer.uri())
2060                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2061                                             .build();
2062 
2063             // Populate the projects repository
2064             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2065             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2066             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2067             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2068 
2069             // Make a change with a corresponding PR
2070             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2071                                                                &quot;Change msg\n\nWith several lines&quot;);
2072             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2073             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2074 
2075             // Flag it as ready for review
2076             pr.setBody(&quot;This should now be ready&quot;);
2077 
2078             // Run an archive pass
2079             TestBotRunner.runPeriodicItems(mlBot);
2080 
2081             // The archive should now contain an entry
2082             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2083             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
2084 
2085             // And there should be a webrev comment
2086             var comments = pr.comments();
2087             var webrevComments = comments.stream()
2088                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2089                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2090                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
2091                                          .collect(Collectors.toList());
2092             assertEquals(1, webrevComments.size());
2093             assertEquals(1, countSubstrings(webrevComments.get(0).body(), pr.id() + &quot;/00&quot;));
2094 
2095             // Pretend the archive didn&#39;t work out
2096             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
2097 
2098             // Run another archive pass
2099             TestBotRunner.runPeriodicItems(mlBot);
2100 
2101             // The webrev comment should not contain duplicate entries
2102             comments = pr.comments();
2103             webrevComments = comments.stream()
2104                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2105                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2106                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
2107                                      .collect(Collectors.toList());
2108             assertEquals(1, webrevComments.size());
2109             assertEquals(1, countSubstrings(webrevComments.get(0).body(), pr.id() + &quot;/00&quot;));
2110         }
2111     }
2112 
2113     @Test
2114     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2115         try (var credentials = new HostCredentials(testInfo);
2116              var tempFolder = new TemporaryDirectory();
2117              var archiveFolder = new TemporaryDirectory();
2118              var listServer = new TestMailmanServer();
2119              var webrevServer = new TestWebrevServer()) {
2120             var author = credentials.getHostedRepository();
2121             var archive = credentials.getHostedRepository();
2122             var reviewer = credentials.getHostedRepository();
2123             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2124             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2125             var censusBuilder = credentials.getCensusBuilder()
2126                                            .addReviewer(reviewer.forge().currentUser().id())
2127                                            .addAuthor(author.forge().currentUser().id());
2128             var mlBot = MailingListBridgeBot.newBuilder()
2129                                             .from(from)
2130                                             .repo(author)
2131                                             .archive(archive)
2132                                             .censusRepo(censusBuilder.build())
2133                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2134                                             .listArchive(listServer.getArchive())
2135                                             .smtpServer(listServer.getSMTP())
2136                                             .webrevStorageRepository(archive)
2137                                             .webrevStorageRef(&quot;webrev&quot;)
2138                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2139                                             .webrevStorageBaseUri(webrevServer.uri())
2140                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2141                                             .build();
2142 
2143             // Populate the projects repository
2144             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2145             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2146             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2147             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2148             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2149 
2150             // Make a change with a corresponding PR
2151             var editHash = CheckableRepository.appendAndCommit(localRepo);
2152             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2153             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2154             pr.setBody(&quot;This is now ready&quot;);
2155 
2156             // Run an archive pass
2157             TestBotRunner.runPeriodicItems(mlBot);
2158 
2159             // First unapprove it
2160             var reviewedPr = reviewer.pullRequest(pr.id());
2161             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
2162             TestBotRunner.runPeriodicItems(mlBot);
2163             TestBotRunner.runPeriodicItems(mlBot);
2164             TestBotRunner.runPeriodicItems(mlBot);
2165 
2166             // The archive should contain a note
2167             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2168             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2169             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
2170             if (author.forge().supportsReviewBody()) {
2171                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
2172             }
2173 
2174             // Then approve it
2175             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
2176             TestBotRunner.runPeriodicItems(mlBot);
2177             TestBotRunner.runPeriodicItems(mlBot);
2178             TestBotRunner.runPeriodicItems(mlBot);
2179 
2180             // The archive should contain another note
2181             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2182             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
2183             if (author.forge().supportsReviewBody()) {
2184                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
2185             }
2186             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
2187 
2188             // Yet another change
2189             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
2190             TestBotRunner.runPeriodicItems(mlBot);
2191             TestBotRunner.runPeriodicItems(mlBot);
2192             TestBotRunner.runPeriodicItems(mlBot);
2193 
2194             // The archive should contain another note
2195             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2196             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2197             if (author.forge().supportsReviewBody()) {
2198                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
2199             }
2200         }
2201     }
2202 
2203     @Test
2204     void ignoreComments(TestInfo testInfo) throws IOException {
2205         try (var credentials = new HostCredentials(testInfo);
2206              var tempFolder = new TemporaryDirectory();
2207              var archiveFolder = new TemporaryDirectory();
2208              var listServer = new TestMailmanServer();
2209              var webrevServer = new TestWebrevServer()) {
2210             var author = credentials.getHostedRepository();
2211             var ignored = credentials.getHostedRepository();
2212             var archive = credentials.getHostedRepository();
2213             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2214             var censusBuilder = credentials.getCensusBuilder()
2215                                            .addAuthor(author.forge().currentUser().id());
2216             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2217             var mlBot = MailingListBridgeBot.newBuilder()
2218                                             .from(from)
2219                                             .repo(author)
2220                                             .archive(archive)
2221                                             .censusRepo(censusBuilder.build())
2222                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2223                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2224                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2225                                             .listArchive(listServer.getArchive())
2226                                             .smtpServer(listServer.getSMTP())
2227                                             .webrevStorageRepository(archive)
2228                                             .webrevStorageRef(&quot;webrev&quot;)
2229                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2230                                             .webrevStorageBaseUri(webrevServer.uri())
2231                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2232                                             .build();
2233 
2234             // Populate the projects repository
2235             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2236             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2237             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2238             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2239             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2240 
2241             // Make a change with a corresponding PR
2242             var editHash = CheckableRepository.appendAndCommit(localRepo);
2243             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2244             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2245             pr.setBody(&quot;This is now ready&quot;);
2246 
2247             // Make a bunch of comments
2248             pr.addComment(&quot;Plain comment&quot;);
2249             pr.addComment(&quot;ignore this comment&quot;);
2250             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
2251             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
2252 
2253             var ignoredPR = ignored.pullRequest(pr.id());
2254             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
2255 
2256             TestBotRunner.runPeriodicItems(mlBot);
2257             TestBotRunner.runPeriodicItems(mlBot);
2258 
2259             // The archive should not contain the ignored comments
2260             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2261             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
2262             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
2263             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
2264             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
2265             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
2266         }
2267     }
2268 
2269     @Test
2270     void replyToEmptyReview(TestInfo testInfo) throws IOException {
2271         try (var credentials = new HostCredentials(testInfo);
2272              var tempFolder = new TemporaryDirectory();
2273              var archiveFolder = new TemporaryDirectory();
2274              var listServer = new TestMailmanServer();
2275              var webrevServer = new TestWebrevServer()) {
2276             var author = credentials.getHostedRepository();
2277             var reviewer = credentials.getHostedRepository();
2278             var archive = credentials.getHostedRepository();
2279             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2280             var censusBuilder = credentials.getCensusBuilder()
2281                                            .addReviewer(reviewer.forge().currentUser().id())
2282                                            .addAuthor(author.forge().currentUser().id());
2283             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2284             var mlBot = MailingListBridgeBot.newBuilder()
2285                                             .from(from)
2286                                             .repo(author)
2287                                             .archive(archive)
2288                                             .censusRepo(censusBuilder.build())
2289                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2290                                             .listArchive(listServer.getArchive())
2291                                             .smtpServer(listServer.getSMTP())
2292                                             .webrevStorageRepository(archive)
2293                                             .webrevStorageRef(&quot;webrev&quot;)
2294                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2295                                             .webrevStorageBaseUri(webrevServer.uri())
2296                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2297                                             .build();
2298 
2299             // Populate the projects repository
2300             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2301             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2302             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2303             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2304             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2305 
2306             // Make a change with a corresponding PR
2307             var editHash = CheckableRepository.appendAndCommit(localRepo);
2308             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2309             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2310             pr.setBody(&quot;This is now ready&quot;);
2311             TestBotRunner.runPeriodicItems(mlBot);
2312             listServer.processIncoming();
2313 
2314             // Make an empty approval
2315             var reviewPr = reviewer.pullRequest(pr.id());
2316             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
2317             TestBotRunner.runPeriodicItems(mlBot);
2318             listServer.processIncoming();
2319 
2320             pr.addComment(&quot;Thanks for the review!&quot;);
2321             TestBotRunner.runPeriodicItems(mlBot);
2322             listServer.processIncoming();
2323 
2324             // The approval text should be included in the quote
2325             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2326             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
2327         }
2328     }
2329 
2330     @Test
2331     void cooldown(TestInfo testInfo) throws IOException {
2332         try (var credentials = new HostCredentials(testInfo);
2333              var tempFolder = new TemporaryDirectory();
2334              var archiveFolder = new TemporaryDirectory();
2335              var listServer = new TestMailmanServer();
2336              var webrevServer = new TestWebrevServer()) {
2337             var bot = credentials.getHostedRepository();
2338             var author = credentials.getHostedRepository();
2339             var archive = credentials.getHostedRepository();
2340             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2341             var censusBuilder = credentials.getCensusBuilder()
2342                                            .addAuthor(author.forge().currentUser().id());
2343             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2344             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2345                                                    .from(from)
2346                                                    .repo(bot)
2347                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2348                                                    .archive(archive)
2349                                                    .censusRepo(censusBuilder.build())
2350                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2351                                                    .listArchive(listServer.getArchive())
2352                                                    .smtpServer(listServer.getSMTP())
2353                                                    .webrevStorageRepository(archive)
2354                                                    .webrevStorageRef(&quot;webrev&quot;)
2355                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2356                                                    .webrevStorageBaseUri(webrevServer.uri())
2357                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2358 
2359             // Populate the projects repository
2360             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2361             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2362             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2363             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2364             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2365 
2366             // Make a change with a corresponding PR
2367             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2368             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2369             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2370             pr.setBody(&quot;This is now ready&quot;);
2371 
2372             var mlBot = mlBotBuilder.build();
2373             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2374 
2375             TestBotRunner.runPeriodicItems(mlBot);
2376             listServer.processIncoming();
2377 
2378             // Make a comment
2379             pr.addComment(&quot;Looks good&quot;);
2380 
2381             // Bot with cooldown configured should not bridge the comment
2382             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2383             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2384 
2385             // But without, it should
2386             TestBotRunner.runPeriodicItems(mlBot);
2387             listServer.processIncoming();
2388 
2389             // Check the archive
2390             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2391             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
2392         }
2393     }
2394 
2395     @Test
2396     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2397         try (var credentials = new HostCredentials(testInfo);
2398              var tempFolder = new TemporaryDirectory();
2399              var archiveFolder = new TemporaryDirectory();
2400              var listServer = new TestMailmanServer();
2401              var webrevServer = new TestWebrevServer()) {
2402             var bot = credentials.getHostedRepository();
2403             var author = credentials.getHostedRepository();
2404             var archive = credentials.getHostedRepository();
2405             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2406             var censusBuilder = credentials.getCensusBuilder()
2407                                            .addAuthor(author.forge().currentUser().id());
2408             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2409             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2410                                                    .from(from)
2411                                                    .repo(bot)
2412                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2413                                                    .archive(archive)
2414                                                    .censusRepo(censusBuilder.build())
2415                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2416                                                    .listArchive(listServer.getArchive())
2417                                                    .smtpServer(listServer.getSMTP())
2418                                                    .webrevStorageRepository(archive)
2419                                                    .webrevStorageRef(&quot;webrev&quot;)
2420                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2421                                                    .webrevStorageBaseUri(webrevServer.uri())
2422                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2423 
2424             // Populate the projects repository
2425             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2426             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2427             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2428             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2429             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2430 
2431             // Make a change with a corresponding PR
2432             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2433             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2434             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2435             pr.setBody(&quot;This is now ready&quot;);
2436 
2437             var mlBot = mlBotBuilder.build();
2438             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2439 
2440             TestBotRunner.runPeriodicItems(mlBot);
2441             listServer.processIncoming();
2442 
2443             // Commit another revision
2444             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2445             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2446 
2447             // Bot with cooldown configured should not create a new webrev
2448             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2449             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2450 
2451             // But without, it should
2452             TestBotRunner.runPeriodicItems(mlBot);
2453             listServer.processIncoming();
2454 
2455             // Check the archive
2456             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2457             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));
2458         }
2459     }
2460 
2461     @Test
2462     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2463         try (var credentials = new HostCredentials(testInfo);
2464              var tempFolder = new TemporaryDirectory();
2465              var archiveFolder = new TemporaryDirectory();
2466              var listServer = new TestMailmanServer();
2467              var webrevServer = new TestWebrevServer()) {
2468             var bot = credentials.getHostedRepository();
2469             var author = credentials.getHostedRepository();
2470             var archive = credentials.getHostedRepository();
2471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2472             var censusBuilder = credentials.getCensusBuilder()
2473                                            .addAuthor(author.forge().currentUser().id());
2474             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2475             var cooldown = Duration.ofMillis(500);
2476             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2477                                                    .from(from)
2478                                                    .repo(bot)
2479                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2480                                                    .archive(archive)
2481                                                    .censusRepo(censusBuilder.build())
2482                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2483                                                    .listArchive(listServer.getArchive())
2484                                                    .smtpServer(listServer.getSMTP())
2485                                                    .webrevStorageRepository(archive)
2486                                                    .webrevStorageRef(&quot;webrev&quot;)
2487                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2488                                                    .webrevStorageBaseUri(webrevServer.uri())
2489                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2490 
2491             // Populate the projects repository
2492             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2493             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2494             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2495             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2496             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2497 
2498             // Make a change with a corresponding PR
2499             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2500             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2501             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2502             pr.setBody(&quot;This is now ready&quot;);
2503 
2504             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2505             Thread.sleep(cooldown.toMillis());
2506             TestBotRunner.runPeriodicItems(mlBot);
2507             listServer.processIncoming();
2508 
2509             // Make a comment and run the check within the cooldown period
2510             int counter;
2511             boolean noMailReceived = false;
2512             for (counter = 1; counter &lt; 10; ++counter) {
2513                 var start = Instant.now();
2514                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2515 
2516                 // The bot should not bridge the comment due to cooldown
2517                 TestBotRunner.runPeriodicItems(mlBot);
2518                 try {
2519                     noMailReceived = false;
2520                     listServer.processIncoming(Duration.ofMillis(1));
2521                 } catch (RuntimeException e) {
2522                     noMailReceived = true;
2523                 }
2524                 var elapsed = Duration.between(start, Instant.now());
2525                 if (elapsed.compareTo(cooldown) &lt; 0) {
2526                     break;
2527                 } else {
2528                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2529                     // Ensure that the cooldown expires
2530                     Thread.sleep(cooldown.toMillis());
2531                     // If no mail was received, we have to flush it out
2532                     if (noMailReceived) {
2533                         TestBotRunner.runPeriodicItems(mlBot);
2534                         listServer.processIncoming();
2535                     }
2536                     cooldown = cooldown.multipliedBy(2);
2537                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2538                 }
2539             }
2540             assertTrue(noMailReceived);
2541 
2542             // But after the cooldown period has passed, it should
2543             Thread.sleep(cooldown.toMillis());
2544             TestBotRunner.runPeriodicItems(mlBot);
2545             listServer.processIncoming();
2546 
2547             // Check the archive
2548             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2549             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2550         }
2551     }
2552 
2553     @Test
2554     void branchPrefix(TestInfo testInfo) throws IOException {
2555         try (var credentials = new HostCredentials(testInfo);
2556              var tempFolder = new TemporaryDirectory();
2557              var archiveFolder = new TemporaryDirectory();
2558              var listServer = new TestMailmanServer();
2559              var webrevServer = new TestWebrevServer()) {
2560             var author = credentials.getHostedRepository();
2561             var archive = credentials.getHostedRepository();
2562             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2563             var censusBuilder = credentials.getCensusBuilder()
2564                                            .addAuthor(author.forge().currentUser().id());
2565             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2566             var mlBot = MailingListBridgeBot.newBuilder()
2567                                             .from(from)
2568                                             .repo(author)
2569                                             .archive(archive)
2570                                             .censusRepo(censusBuilder.build())
2571                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2572                                             .listArchive(listServer.getArchive())
2573                                             .smtpServer(listServer.getSMTP())
2574                                             .webrevStorageRepository(archive)
2575                                             .webrevStorageRef(&quot;webrev&quot;)
2576                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2577                                             .webrevStorageBaseUri(webrevServer.uri())
2578                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2579                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2580                                             .build();
2581 
2582             // Populate the projects repository
2583             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2584             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2585             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2586             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2587 
2588             // Make a change with a corresponding PR
2589             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2590                                                                &quot;Change msg\n\nWith several lines&quot;);
2591             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2592             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2593             pr.setBody(&quot;This is a PR&quot;);
2594 
2595             // Run an archive pass
2596             TestBotRunner.runPeriodicItems(mlBot);
2597             listServer.processIncoming();
2598 
2599             pr.addComment(&quot;Looks good!&quot;);
2600             TestBotRunner.runPeriodicItems(mlBot);
2601             listServer.processIncoming();
2602 
2603             // Check the archive
2604             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2605             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2606             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2607         }
2608     }
2609 
2610     @Test
2611     void repoPrefix(TestInfo testInfo) throws IOException {
2612         try (var credentials = new HostCredentials(testInfo);
2613              var tempFolder = new TemporaryDirectory();
2614              var archiveFolder = new TemporaryDirectory();
2615              var listServer = new TestMailmanServer();
2616              var webrevServer = new TestWebrevServer()) {
2617             var author = credentials.getHostedRepository();
2618             var archive = credentials.getHostedRepository();
2619             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2620             var censusBuilder = credentials.getCensusBuilder()
2621                                            .addAuthor(author.forge().currentUser().id());
2622             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2623             var mlBot = MailingListBridgeBot.newBuilder()
2624                                             .from(from)
2625                                             .repo(author)
2626                                             .archive(archive)
2627                                             .censusRepo(censusBuilder.build())
2628                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2629                                             .listArchive(listServer.getArchive())
2630                                             .smtpServer(listServer.getSMTP())
2631                                             .webrevStorageRepository(archive)
2632                                             .webrevStorageRef(&quot;webrev&quot;)
2633                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2634                                             .webrevStorageBaseUri(webrevServer.uri())
2635                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2636                                             .repoInSubject(true)
2637                                             .build();
2638 
2639             // Populate the projects repository
2640             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2641             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2642             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2643             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2644 
2645             // Make a change with a corresponding PR
2646             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2647                                                                &quot;Change msg\n\nWith several lines&quot;);
2648             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2649             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2650             pr.setBody(&quot;This is a PR&quot;);
2651 
2652             // Run an archive pass
2653             TestBotRunner.runPeriodicItems(mlBot);
2654             listServer.processIncoming();
2655 
2656             pr.addComment(&quot;Looks good!&quot;);
2657             TestBotRunner.runPeriodicItems(mlBot);
2658             listServer.processIncoming();
2659 
2660             // Check the archive
2661             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2662             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2663             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2664         }
2665     }
2666 
2667     @Test
2668     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2669         try (var credentials = new HostCredentials(testInfo);
2670              var tempFolder = new TemporaryDirectory();
2671              var archiveFolder = new TemporaryDirectory();
2672              var listServer = new TestMailmanServer();
2673              var webrevServer = new TestWebrevServer()) {
2674             var author = credentials.getHostedRepository();
2675             var archive = credentials.getHostedRepository();
2676             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2677             var censusBuilder = credentials.getCensusBuilder()
2678                                            .addAuthor(author.forge().currentUser().id());
2679             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2680             var mlBot = MailingListBridgeBot.newBuilder()
2681                                             .from(from)
2682                                             .repo(author)
2683                                             .archive(archive)
2684                                             .censusRepo(censusBuilder.build())
2685                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2686                                             .listArchive(listServer.getArchive())
2687                                             .smtpServer(listServer.getSMTP())
2688                                             .webrevStorageRepository(archive)
2689                                             .webrevStorageRef(&quot;webrev&quot;)
2690                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2691                                             .webrevStorageBaseUri(webrevServer.uri())
2692                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2693                                             .repoInSubject(true)
2694                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2695                                             .build();
2696 
2697             // Populate the projects repository
2698             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2699             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2700             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2701             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2702 
2703             // Make a change with a corresponding PR
2704             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2705                                                                &quot;Change msg\n\nWith several lines&quot;);
2706             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2707             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2708             pr.setBody(&quot;This is a PR&quot;);
2709 
2710             // Run an archive pass
2711             TestBotRunner.runPeriodicItems(mlBot);
2712             listServer.processIncoming();
2713 
2714             pr.addComment(&quot;Looks good!&quot;);
2715             TestBotRunner.runPeriodicItems(mlBot);
2716             listServer.processIncoming();
2717 
2718             // Check the archive
2719             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2720             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2721             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2722         }
2723     }
2724 
2725     @Test
2726     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2727         try (var credentials = new HostCredentials(testInfo);
2728              var tempFolder = new TemporaryDirectory();
2729              var archiveFolder = new TemporaryDirectory();
2730              var listServer = new TestMailmanServer();
2731              var webrevServer = new TestWebrevServer()) {
2732             var bot = credentials.getHostedRepository();
2733             var author = credentials.getHostedRepository();
2734             var archive = credentials.getHostedRepository();
2735             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2736             var censusBuilder = credentials.getCensusBuilder()
2737                                            .addAuthor(author.forge().currentUser().id());
2738             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2739             var cooldown = Duration.ofMillis(500);
2740             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2741                                                    .from(from)
2742                                                    .repo(bot)
2743                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2744                                                    .archive(archive)
2745                                                    .censusRepo(censusBuilder.build())
2746                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2747                                                    .listArchive(listServer.getArchive())
2748                                                    .smtpServer(listServer.getSMTP())
2749                                                    .webrevStorageRepository(archive)
2750                                                    .webrevStorageRef(&quot;webrev&quot;)
2751                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2752                                                    .webrevStorageBaseUri(webrevServer.uri())
2753                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2754 
2755             // Populate the projects repository
2756             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2757             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2758             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2759             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2760             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2761 
2762             // Make a change with a corresponding PR
2763             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2764             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2765             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2766             pr.setBody(&quot;This is now ready&quot;);
2767 
2768             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2769             Thread.sleep(cooldown.toMillis());
2770             TestBotRunner.runPeriodicItems(mlBot);
2771             listServer.processIncoming();
2772 
2773             // Make a new revision and run the check within the cooldown period
2774             int counter;
2775             boolean noMailReceived = false;
2776             for (counter = 1; counter &lt; 10; ++counter) {
2777                 var start = Instant.now();
2778                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2779                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2780 
2781                 // The bot should not bridge the new revision due to cooldown
2782                 TestBotRunner.runPeriodicItems(mlBot);
2783                 try {
2784                     noMailReceived = false;
2785                     listServer.processIncoming(Duration.ofMillis(1));
2786                 } catch (RuntimeException e) {
2787                     noMailReceived = true;
2788                 }
2789                 var elapsed = Duration.between(start, Instant.now());
2790                 if (elapsed.compareTo(cooldown) &lt; 0) {
2791                     break;
2792                 } else {
2793                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2794                     // Ensure that the cooldown expires
2795                     Thread.sleep(cooldown.toMillis());
2796                     // If no mail was received, we have to flush it out
2797                     if (noMailReceived) {
2798                         TestBotRunner.runPeriodicItems(mlBot);
2799                         listServer.processIncoming();
2800                     }
2801                     cooldown = cooldown.multipliedBy(2);
2802                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2803                 }
2804             }
2805             assertTrue(noMailReceived);
2806 
2807             // But after the cooldown period has passed, it should
2808             Thread.sleep(cooldown.toMillis());
2809             TestBotRunner.runPeriodicItems(mlBot);
2810             listServer.processIncoming();
2811 
2812             // Check the archive
2813             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2814             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2815         }
2816     }
2817 
2818     @Test
2819     void multipleRecipients(TestInfo testInfo) throws IOException {
2820         try (var credentials = new HostCredentials(testInfo);
2821              var tempFolder = new TemporaryDirectory();
2822              var archiveFolder = new TemporaryDirectory();
2823              var listServer = new TestMailmanServer();
2824              var webrevServer = new TestWebrevServer()) {
2825             var author = credentials.getHostedRepository();
2826             var archive = credentials.getHostedRepository();
2827             var listAddress1 = EmailAddress.parse(listServer.createList(&quot;test1&quot;));
2828             var listAddress2 = EmailAddress.parse(listServer.createList(&quot;test2&quot;));
2829             var censusBuilder = credentials.getCensusBuilder()
2830                                            .addAuthor(author.forge().currentUser().id());
2831             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2832             var mlBot = MailingListBridgeBot.newBuilder()
2833                                             .from(from)
2834                                             .repo(author)
2835                                             .archive(archive)
2836                                             .censusRepo(censusBuilder.build())
2837                                             .lists(List.of(new MailingListConfiguration(listAddress1, Set.of(&quot;list1&quot;)),
2838                                                            new MailingListConfiguration(listAddress2, Set.of(&quot;list2&quot;))))
2839                                             .listArchive(listServer.getArchive())
2840                                             .smtpServer(listServer.getSMTP())
2841                                             .webrevStorageRepository(archive)
2842                                             .webrevStorageRef(&quot;webrev&quot;)
2843                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2844                                             .webrevStorageBaseUri(webrevServer.uri())
2845                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2846                                             .build();
2847 
2848             // Populate the projects repository
2849             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2850             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2851             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2852             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2853 
2854             // Make a change with a corresponding PR
2855             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2856                                                                &quot;Change msg\n\nWith several lines&quot;);
2857             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2858             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2859             pr.setBody(&quot;This is a PR&quot;);
2860             pr.addLabel(&quot;list1&quot;);
2861 
2862             // Run an archive pass
2863             TestBotRunner.runPeriodicItems(mlBot);
2864             listServer.processIncoming();
2865 
2866             // The mail should have been sent to list1
2867             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
2868             var mailmanList = mailmanServer.getList(listAddress1.address());
2869             var conversations = mailmanList.conversations(Duration.ofDays(1));
2870             assertEquals(1, conversations.size());
2871             var mail = conversations.get(0).first();
2872             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
2873             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
2874             assertEquals(noreplyAddress(archive), mail.author().address());
2875             assertEquals(listAddress1, mail.sender());
2876             assertEquals(List.of(listAddress1), mail.recipients());
2877 
2878             // Add another label and comment
2879             pr.addLabel(&quot;list2&quot;);
2880             pr.addComment(&quot;Looks good!&quot;);
2881             TestBotRunner.runPeriodicItems(mlBot);
2882             listServer.processIncoming();
2883 
2884             // This one should have been sent to list1 and list2
2885             conversations = mailmanList.conversations(Duration.ofDays(1));
2886             assertEquals(1, conversations.size());
2887             var reply = conversations.get(0).replies(conversations.get(0).first()).get(0);
2888             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, reply.subject());
2889             assertEquals(pr.author().fullName(), reply.author().fullName().orElseThrow());
2890             assertEquals(noreplyAddress(archive), reply.author().address());
2891             assertEquals(listAddress1, reply.sender());
2892             assertEquals(List.of(listAddress1, listAddress2), reply.recipients());
2893         }
2894     }
2895 }
    </pre>
  </body>
</html>