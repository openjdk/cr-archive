<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
<span class="line-modified"> 197             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));</span>
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
</pre>
<hr />
<pre>
1536 
1537             // Make sure that the push registered
1538             var lastHeadHash = pr.headHash();
1539             var refreshCount = 0;
1540             do {
1541                 pr = author.pullRequest(pr.id());
1542                 if (refreshCount++ &gt; 100) {
1543                     fail(&quot;The PR did not update after the new push&quot;);
1544                 }
1545             } while (pr.headHash().equals(lastHeadHash));
1546 
1547             // Run another archive pass
1548             TestBotRunner.runPeriodicItems(mlBot);
1549             TestBotRunner.runPeriodicItems(mlBot);
1550             TestBotRunner.runPeriodicItems(mlBot);
1551             listServer.processIncoming();
1552 
1553             // The archive should reference the updated push
1554             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1555             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
<span class="line-modified">1556             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));</span>
<span class="line-modified">1557             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));</span>
1558             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1559             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1560             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1561 
1562             // The webrev comment should be updated
1563             var comments = pr.comments();
1564             var webrevComments = comments.stream()
1565                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1566                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1567                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1568                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1569                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1570                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1571                                          .collect(Collectors.toList());
1572             assertEquals(1, webrevComments.size());
1573 
1574             // Check that sender address is set properly
1575             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1576             var mailmanList = mailmanServer.getList(listAddress.address());
1577             var conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
1665             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1666             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1667 
1668             // Make sure that the push registered
1669             var lastHeadHash = pr.headHash();
1670             var refreshCount = 0;
1671             do {
1672                 pr = author.pullRequest(pr.id());
1673                 if (refreshCount++ &gt; 100) {
1674                     fail(&quot;The PR did not update after the new push&quot;);
1675                 }
1676             } while (pr.headHash().equals(lastHeadHash));
1677 
1678             // Run another archive pass
1679             TestBotRunner.runPeriodicItems(mlBot);
1680             listServer.processIncoming();
1681 
1682             // The archive should reference the rebased push
1683             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1684             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
<span class="line-modified">1685             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));</span>
1686             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1687             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1688             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1689             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1690             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1691 
1692             // The webrev comment should be updated
1693             var comments = pr.comments();
1694             var webrevComments = comments.stream()
1695                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1696                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1697                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1698                                          .collect(Collectors.toList());
1699             assertEquals(1, webrevComments.size());
1700 
1701             // Check that sender address is set properly
1702             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1703             var mailmanList = mailmanServer.getList(listAddress.address());
1704             var conversations = mailmanList.conversations(Duration.ofDays(1));
1705             assertEquals(1, conversations.size());
</pre>
<hr />
<pre>
1777             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1778 
1779             // Make sure that the push registered
1780             var lastHeadHash = pr.headHash();
1781             var refreshCount = 0;
1782             do {
1783                 pr = author.pullRequest(pr.id());
1784                 if (refreshCount++ &gt; 100) {
1785                     fail(&quot;The PR did not update after the new push&quot;);
1786                 }
1787             } while (pr.headHash().equals(lastHeadHash));
1788 
1789             // Run another archive pass
1790             TestBotRunner.runPeriodicItems(mlBot);
1791             listServer.processIncoming();
1792 
1793             // The archive should reference the rebased push
1794             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1795             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1796             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
<span class="line-modified">1797             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));</span>
<span class="line-modified">1798             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));</span>
1799             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1800             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1801         }
1802     }
1803 
1804     @Test
1805     void mergeWebrev(TestInfo testInfo) throws IOException {
1806         try (var credentials = new HostCredentials(testInfo);
1807              var tempFolder = new TemporaryDirectory();
1808              var archiveFolder = new TemporaryDirectory();
1809              var listServer = new TestMailmanServer();
1810              var webrevServer = new TestWebrevServer()) {
1811             var author = credentials.getHostedRepository();
1812             var archive = credentials.getHostedRepository();
1813             var commenter = credentials.getHostedRepository();
1814             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1815             var censusBuilder = credentials.getCensusBuilder()
1816                                            .addAuthor(author.forge().currentUser().id());
1817             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1818             var mlBot = MailingListBridgeBot.newBuilder()
</pre>
<hr />
<pre>
1859             localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1860             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1861             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1862             localRepo.add(mergeOnlyFile);
1863             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1864             localRepo.add(reviewFile);
1865             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1866             localRepo.push(appendedCommit, author.url(), &quot;merge_of_edit&quot;, true);
1867 
1868             // Make a merge PR
1869             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;merge_of_edit&quot;, &quot;Merge edit&quot;);
1870             pr.setBody(&quot;This is now ready&quot;);
1871 
1872             // Run an archive pass
1873             TestBotRunner.runPeriodicItems(mlBot);
1874             listServer.processIncoming();
1875 
1876             // The archive should contain a merge style webrev
1877             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1878             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrevs contain the adjustments done while merging with regards to each parent branch:&quot;));
<span class="line-modified">1879             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));</span>
1880             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1881 
1882             // The PR should contain a webrev comment
1883             assertEquals(1, pr.comments().size());
1884             var webrevComment = pr.comments().get(0);
1885             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1886             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1887         }
1888     }
1889 
1890     @Test
1891     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1892         try (var credentials = new HostCredentials(testInfo);
1893              var tempFolder = new TemporaryDirectory();
1894              var archiveFolder = new TemporaryDirectory();
1895              var listServer = new TestMailmanServer();
1896              var webrevServer = new TestWebrevServer()) {
1897             var author = credentials.getHostedRepository();
1898             var archive = credentials.getHostedRepository();
1899             var commenter = credentials.getHostedRepository();
</pre>
<hr />
<pre>
1932             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1933             localRepo.checkout(masterHash, true);
1934             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1935             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1936             localRepo.add(masterOnlyFile);
1937             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1938             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1939             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1940 
1941             // Make a merge PR
1942             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1943             pr.setBody(&quot;This is now ready&quot;);
1944 
1945             // Run an archive pass
1946             TestBotRunner.runPeriodicItems(mlBot);
1947             listServer.processIncoming();
1948 
1949             // The archive should contain a merge style webrev
1950             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1951             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrev contains the conflicts with master:&quot;));
<span class="line-modified">1952             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.conflicts&quot;));</span>
1953             assertTrue(archiveContains(archiveFolder.path(), &quot;2 lines in 2 files changed: 2 ins; 0 del; 0 mod&quot;));
1954 
1955             // The PR should contain a webrev comment
1956             assertEquals(1, pr.comments().size());
1957             var webrevComment = pr.comments().get(0);
1958             assertTrue(webrevComment.body().contains(&quot;Merge conflicts&quot;));
1959         }
1960     }
1961 
1962     @Test
1963     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1964         try (var credentials = new HostCredentials(testInfo);
1965              var tempFolder = new TemporaryDirectory();
1966              var archiveFolder = new TemporaryDirectory();
1967              var listServer = new TestMailmanServer();
1968              var webrevServer = new TestWebrevServer()) {
1969             var author = credentials.getHostedRepository();
1970             var archive = credentials.getHostedRepository();
1971             var commenter = credentials.getHostedRepository();
1972             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
</pre>
<hr />
<pre>
2073             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2074 
2075             // Flag it as ready for review
2076             pr.setBody(&quot;This should now be ready&quot;);
2077 
2078             // Run an archive pass
2079             TestBotRunner.runPeriodicItems(mlBot);
2080 
2081             // The archive should now contain an entry
2082             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2083             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
2084 
2085             // And there should be a webrev comment
2086             var comments = pr.comments();
2087             var webrevComments = comments.stream()
2088                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2089                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2090                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
2091                                          .collect(Collectors.toList());
2092             assertEquals(1, webrevComments.size());
<span class="line-modified">2093             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));</span>
2094 
2095             // Pretend the archive didn&#39;t work out
2096             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
2097 
2098             // Run another archive pass
2099             TestBotRunner.runPeriodicItems(mlBot);
2100 
2101             // The webrev comment should not contain duplicate entries
2102             comments = pr.comments();
2103             webrevComments = comments.stream()
2104                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2105                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2106                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
2107                                      .collect(Collectors.toList());
2108             assertEquals(1, webrevComments.size());
<span class="line-modified">2109             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));</span>
2110         }
2111     }
2112 
2113     @Test
2114     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2115         try (var credentials = new HostCredentials(testInfo);
2116              var tempFolder = new TemporaryDirectory();
2117              var archiveFolder = new TemporaryDirectory();
2118              var listServer = new TestMailmanServer();
2119              var webrevServer = new TestWebrevServer()) {
2120             var author = credentials.getHostedRepository();
2121             var archive = credentials.getHostedRepository();
2122             var reviewer = credentials.getHostedRepository();
2123             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2124             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2125             var censusBuilder = credentials.getCensusBuilder()
2126                                            .addReviewer(reviewer.forge().currentUser().id())
2127                                            .addAuthor(author.forge().currentUser().id());
2128             var mlBot = MailingListBridgeBot.newBuilder()
2129                                             .from(from)
</pre>
<hr />
<pre>
2437             var mlBot = mlBotBuilder.build();
2438             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2439 
2440             TestBotRunner.runPeriodicItems(mlBot);
2441             listServer.processIncoming();
2442 
2443             // Commit another revision
2444             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2445             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2446 
2447             // Bot with cooldown configured should not create a new webrev
2448             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2449             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2450 
2451             // But without, it should
2452             TestBotRunner.runPeriodicItems(mlBot);
2453             listServer.processIncoming();
2454 
2455             // Check the archive
2456             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
<span class="line-modified">2457             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));</span>
2458         }
2459     }
2460 
2461     @Test
2462     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2463         try (var credentials = new HostCredentials(testInfo);
2464              var tempFolder = new TemporaryDirectory();
2465              var archiveFolder = new TemporaryDirectory();
2466              var listServer = new TestMailmanServer();
2467              var webrevServer = new TestWebrevServer()) {
2468             var bot = credentials.getHostedRepository();
2469             var author = credentials.getHostedRepository();
2470             var archive = credentials.getHostedRepository();
2471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2472             var censusBuilder = credentials.getCensusBuilder()
2473                                            .addAuthor(author.forge().currentUser().id());
2474             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2475             var cooldown = Duration.ofMillis(500);
2476             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2477                                                    .from(from)
</pre>
</td>
<td>
<hr />
<pre>
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
<span class="line-modified"> 197             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00&quot;));</span>
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
</pre>
<hr />
<pre>
1536 
1537             // Make sure that the push registered
1538             var lastHeadHash = pr.headHash();
1539             var refreshCount = 0;
1540             do {
1541                 pr = author.pullRequest(pr.id());
1542                 if (refreshCount++ &gt; 100) {
1543                     fail(&quot;The PR did not update after the new push&quot;);
1544                 }
1545             } while (pr.headHash().equals(lastHeadHash));
1546 
1547             // Run another archive pass
1548             TestBotRunner.runPeriodicItems(mlBot);
1549             TestBotRunner.runPeriodicItems(mlBot);
1550             TestBotRunner.runPeriodicItems(mlBot);
1551             listServer.processIncoming();
1552 
1553             // The archive should reference the updated push
1554             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1555             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
<span class="line-modified">1556             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/01&quot;));</span>
<span class="line-modified">1557             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/00-01&quot;));</span>
1558             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1559             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1560             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1561 
1562             // The webrev comment should be updated
1563             var comments = pr.comments();
1564             var webrevComments = comments.stream()
1565                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1566                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1567                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1568                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1569                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1570                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1571                                          .collect(Collectors.toList());
1572             assertEquals(1, webrevComments.size());
1573 
1574             // Check that sender address is set properly
1575             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1576             var mailmanList = mailmanServer.getList(listAddress.address());
1577             var conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
1665             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1666             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1667 
1668             // Make sure that the push registered
1669             var lastHeadHash = pr.headHash();
1670             var refreshCount = 0;
1671             do {
1672                 pr = author.pullRequest(pr.id());
1673                 if (refreshCount++ &gt; 100) {
1674                     fail(&quot;The PR did not update after the new push&quot;);
1675                 }
1676             } while (pr.headHash().equals(lastHeadHash));
1677 
1678             // Run another archive pass
1679             TestBotRunner.runPeriodicItems(mlBot);
1680             listServer.processIncoming();
1681 
1682             // The archive should reference the rebased push
1683             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1684             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
<span class="line-modified">1685             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));</span>
1686             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1687             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1688             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1689             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1690             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1691 
1692             // The webrev comment should be updated
1693             var comments = pr.comments();
1694             var webrevComments = comments.stream()
1695                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1696                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1697                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1698                                          .collect(Collectors.toList());
1699             assertEquals(1, webrevComments.size());
1700 
1701             // Check that sender address is set properly
1702             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1703             var mailmanList = mailmanServer.getList(listAddress.address());
1704             var conversations = mailmanList.conversations(Duration.ofDays(1));
1705             assertEquals(1, conversations.size());
</pre>
<hr />
<pre>
1777             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1778 
1779             // Make sure that the push registered
1780             var lastHeadHash = pr.headHash();
1781             var refreshCount = 0;
1782             do {
1783                 pr = author.pullRequest(pr.id());
1784                 if (refreshCount++ &gt; 100) {
1785                     fail(&quot;The PR did not update after the new push&quot;);
1786                 }
1787             } while (pr.headHash().equals(lastHeadHash));
1788 
1789             // Run another archive pass
1790             TestBotRunner.runPeriodicItems(mlBot);
1791             listServer.processIncoming();
1792 
1793             // The archive should reference the rebased push
1794             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1795             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1796             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
<span class="line-modified">1797             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));</span>
<span class="line-modified">1798             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00-01&quot;));</span>
1799             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1800             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1801         }
1802     }
1803 
1804     @Test
1805     void mergeWebrev(TestInfo testInfo) throws IOException {
1806         try (var credentials = new HostCredentials(testInfo);
1807              var tempFolder = new TemporaryDirectory();
1808              var archiveFolder = new TemporaryDirectory();
1809              var listServer = new TestMailmanServer();
1810              var webrevServer = new TestWebrevServer()) {
1811             var author = credentials.getHostedRepository();
1812             var archive = credentials.getHostedRepository();
1813             var commenter = credentials.getHostedRepository();
1814             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1815             var censusBuilder = credentials.getCensusBuilder()
1816                                            .addAuthor(author.forge().currentUser().id());
1817             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1818             var mlBot = MailingListBridgeBot.newBuilder()
</pre>
<hr />
<pre>
1859             localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1860             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1861             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1862             localRepo.add(mergeOnlyFile);
1863             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1864             localRepo.add(reviewFile);
1865             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1866             localRepo.push(appendedCommit, author.url(), &quot;merge_of_edit&quot;, true);
1867 
1868             // Make a merge PR
1869             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;merge_of_edit&quot;, &quot;Merge edit&quot;);
1870             pr.setBody(&quot;This is now ready&quot;);
1871 
1872             // Run an archive pass
1873             TestBotRunner.runPeriodicItems(mlBot);
1874             listServer.processIncoming();
1875 
1876             // The archive should contain a merge style webrev
1877             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1878             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrevs contain the adjustments done while merging with regards to each parent branch:&quot;));
<span class="line-modified">1879             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00.0&quot;));</span>
1880             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1881 
1882             // The PR should contain a webrev comment
1883             assertEquals(1, pr.comments().size());
1884             var webrevComment = pr.comments().get(0);
1885             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1886             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1887         }
1888     }
1889 
1890     @Test
1891     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1892         try (var credentials = new HostCredentials(testInfo);
1893              var tempFolder = new TemporaryDirectory();
1894              var archiveFolder = new TemporaryDirectory();
1895              var listServer = new TestMailmanServer();
1896              var webrevServer = new TestWebrevServer()) {
1897             var author = credentials.getHostedRepository();
1898             var archive = credentials.getHostedRepository();
1899             var commenter = credentials.getHostedRepository();
</pre>
<hr />
<pre>
1932             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1933             localRepo.checkout(masterHash, true);
1934             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1935             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1936             localRepo.add(masterOnlyFile);
1937             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1938             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1939             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1940 
1941             // Make a merge PR
1942             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1943             pr.setBody(&quot;This is now ready&quot;);
1944 
1945             // Run an archive pass
1946             TestBotRunner.runPeriodicItems(mlBot);
1947             listServer.processIncoming();
1948 
1949             // The archive should contain a merge style webrev
1950             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1951             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrev contains the conflicts with master:&quot;));
<span class="line-modified">1952             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00.conflicts&quot;));</span>
1953             assertTrue(archiveContains(archiveFolder.path(), &quot;2 lines in 2 files changed: 2 ins; 0 del; 0 mod&quot;));
1954 
1955             // The PR should contain a webrev comment
1956             assertEquals(1, pr.comments().size());
1957             var webrevComment = pr.comments().get(0);
1958             assertTrue(webrevComment.body().contains(&quot;Merge conflicts&quot;));
1959         }
1960     }
1961 
1962     @Test
1963     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1964         try (var credentials = new HostCredentials(testInfo);
1965              var tempFolder = new TemporaryDirectory();
1966              var archiveFolder = new TemporaryDirectory();
1967              var listServer = new TestMailmanServer();
1968              var webrevServer = new TestWebrevServer()) {
1969             var author = credentials.getHostedRepository();
1970             var archive = credentials.getHostedRepository();
1971             var commenter = credentials.getHostedRepository();
1972             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
</pre>
<hr />
<pre>
2073             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2074 
2075             // Flag it as ready for review
2076             pr.setBody(&quot;This should now be ready&quot;);
2077 
2078             // Run an archive pass
2079             TestBotRunner.runPeriodicItems(mlBot);
2080 
2081             // The archive should now contain an entry
2082             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2083             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
2084 
2085             // And there should be a webrev comment
2086             var comments = pr.comments();
2087             var webrevComments = comments.stream()
2088                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2089                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2090                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
2091                                          .collect(Collectors.toList());
2092             assertEquals(1, webrevComments.size());
<span class="line-modified">2093             assertEquals(1, countSubstrings(webrevComments.get(0).body(), pr.id() + &quot;/00&quot;));</span>
2094 
2095             // Pretend the archive didn&#39;t work out
2096             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
2097 
2098             // Run another archive pass
2099             TestBotRunner.runPeriodicItems(mlBot);
2100 
2101             // The webrev comment should not contain duplicate entries
2102             comments = pr.comments();
2103             webrevComments = comments.stream()
2104                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2105                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2106                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
2107                                      .collect(Collectors.toList());
2108             assertEquals(1, webrevComments.size());
<span class="line-modified">2109             assertEquals(1, countSubstrings(webrevComments.get(0).body(), pr.id() + &quot;/00&quot;));</span>
2110         }
2111     }
2112 
2113     @Test
2114     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2115         try (var credentials = new HostCredentials(testInfo);
2116              var tempFolder = new TemporaryDirectory();
2117              var archiveFolder = new TemporaryDirectory();
2118              var listServer = new TestMailmanServer();
2119              var webrevServer = new TestWebrevServer()) {
2120             var author = credentials.getHostedRepository();
2121             var archive = credentials.getHostedRepository();
2122             var reviewer = credentials.getHostedRepository();
2123             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2124             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2125             var censusBuilder = credentials.getCensusBuilder()
2126                                            .addReviewer(reviewer.forge().currentUser().id())
2127                                            .addAuthor(author.forge().currentUser().id());
2128             var mlBot = MailingListBridgeBot.newBuilder()
2129                                             .from(from)
</pre>
<hr />
<pre>
2437             var mlBot = mlBotBuilder.build();
2438             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2439 
2440             TestBotRunner.runPeriodicItems(mlBot);
2441             listServer.processIncoming();
2442 
2443             // Commit another revision
2444             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2445             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2446 
2447             // Bot with cooldown configured should not create a new webrev
2448             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2449             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2450 
2451             // But without, it should
2452             TestBotRunner.runPeriodicItems(mlBot);
2453             listServer.processIncoming();
2454 
2455             // Check the archive
2456             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
<span class="line-modified">2457             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));</span>
2458         }
2459     }
2460 
2461     @Test
2462     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2463         try (var credentials = new HostCredentials(testInfo);
2464              var tempFolder = new TemporaryDirectory();
2465              var archiveFolder = new TemporaryDirectory();
2466              var listServer = new TestMailmanServer();
2467              var webrevServer = new TestWebrevServer()) {
2468             var bot = credentials.getHostedRepository();
2469             var author = credentials.getHostedRepository();
2470             var archive = credentials.getHostedRepository();
2471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2472             var censusBuilder = credentials.getCensusBuilder()
2473                                            .addAuthor(author.forge().currentUser().id());
2474             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2475             var cooldown = Duration.ofMillis(500);
2476             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2477                                                    .from(from)
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>