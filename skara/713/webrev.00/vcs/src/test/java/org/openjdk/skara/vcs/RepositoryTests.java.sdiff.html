<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../main/java/org/openjdk/skara/vcs/TextualPatch.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="openjdk/converter/GitToHgConverterTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 273 
 274             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 275 
 276             assertEquals(1, commit.numParents());
 277             assertEquals(1, commit.parents().size());
 278 
 279             var parent = commit.parents().get(0);
 280             assertEquals(Hash.zero(), parent);
 281 
 282             assertTrue(commit.isInitialCommit());
 283             assertFalse(commit.isMerge());
 284             assertEquals(hash, commit.hash());
 285 
 286             var diffs = commit.parentDiffs();
 287             assertEquals(1, diffs.size());
 288 
 289             var diff = diffs.get(0);
 290             assertEquals(Hash.zero(), diff.from());
 291             assertEquals(hash, diff.to());
 292 
<span class="line-modified"> 293             assertEquals(0, diff.removed());</span>
<span class="line-modified"> 294             assertEquals(0, diff.modified());</span>
<span class="line-modified"> 295             assertEquals(1, diff.added());</span>

 296 
 297             var patches = diff.patches();
 298             assertEquals(1, patches.size());
 299 
 300             var patch = patches.get(0).asTextualPatch();
 301             assertTrue(patch.status().isAdded());
 302 
 303             assertTrue(patch.source().path().isEmpty());
 304             assertTrue(patch.source().type().isEmpty());
 305 
 306             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 307             assertTrue(patch.target().type().get().isRegularNonExecutable());
 308 
 309             var hunks = patch.hunks();
 310             assertEquals(1, hunks.size());
 311 
 312             var hunk = hunks.get(0);
 313             assertEquals(new Range(0, 0), hunk.source().range());
 314             assertEquals(new Range(1, 1), hunk.target().range());
 315 
</pre>
<hr />
<pre>
 351 
 352             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 353 
 354             assertEquals(1, commit.numParents());
 355             assertEquals(1, commit.parents().size());
 356 
 357             var parent = commit.parents().get(0);
 358             assertEquals(hash1, parent);
 359 
 360             assertFalse(commit.isInitialCommit());
 361             assertFalse(commit.isMerge());
 362             assertEquals(hash2, commit.hash());
 363 
 364             var diffs = commit.parentDiffs();
 365             assertEquals(1, diffs.size());
 366 
 367             var diff = diffs.get(0);
 368             assertEquals(hash1, diff.from());
 369             assertEquals(hash2, diff.to());
 370 
<span class="line-modified"> 371             assertEquals(0, diff.removed());</span>
<span class="line-modified"> 372             assertEquals(0, diff.modified());</span>
<span class="line-modified"> 373             assertEquals(1, diff.added());</span>

 374 
 375             var patches = diff.patches();
 376             assertEquals(1, patches.size());
 377 
 378             var patch = patches.get(0).asTextualPatch();
 379             assertTrue(patch.status().isModified());
 380             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 381             assertTrue(patch.source().type().get().isRegularNonExecutable());
 382             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 383             assertTrue(patch.target().type().get().isRegularNonExecutable());
 384 
 385             var hunks = patch.hunks();
 386             assertEquals(1, hunks.size());
 387 
 388             var hunk = hunks.get(0);
 389             assertEquals(new Range(2, 0), hunk.source().range());
 390             assertEquals(new Range(2, 1), hunk.target().range());
 391 
 392             assertLinesEquals(List.of(), hunk.source().lines());
 393             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
</pre>
<hr />
<pre>
 429             var commits = r.commits(refspec).asList();
 430             assertEquals(2, commits.size());
 431 
 432             assertEquals(hash1, commits.get(1).hash());
 433 
 434             var head = commits.get(0);
 435             assertNotEquals(hash2, head);
 436             assertNotEquals(hash3, head);
 437 
 438             assertEquals(hash1, head.parents().get(0));
 439             assertFalse(head.isInitialCommit());
 440             assertFalse(head.isMerge());
 441 
 442             var diffs = head.parentDiffs();
 443             assertEquals(1, diffs.size());
 444 
 445             var diff = diffs.get(0);
 446             assertEquals(hash1, diff.from());
 447             assertEquals(head.hash(), diff.to());
 448 
<span class="line-modified"> 449             assertEquals(2, diff.removed());</span>
<span class="line-modified"> 450             assertEquals(0, diff.modified());</span>
<span class="line-modified"> 451             assertEquals(0, diff.added());</span>

 452         }
 453     }
 454 
 455     @ParameterizedTest
 456     @EnumSource(VCS.class)
 457     void testSquash(VCS vcs) throws IOException {
 458         try (var dir = new TemporaryDirectory()) {
 459             var r = Repository.init(dir.path(), vcs);
 460 
 461             var readme = dir.path().resolve(&quot;README&quot;);
 462             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 463 
 464             r.add(readme);
 465             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 466 
 467             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 468             r.add(readme);
 469             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 470 
 471             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
</pre>
<hr />
<pre>
 483             var commits = r.commits(refspec).asList();
 484             assertEquals(2, commits.size());
 485 
 486             assertEquals(hash1, commits.get(1).hash());
 487 
 488             var head = commits.get(0);
 489             assertNotEquals(hash2, head);
 490             assertNotEquals(hash3, head);
 491 
 492             assertEquals(hash1, head.parents().get(0));
 493             assertFalse(head.isInitialCommit());
 494             assertFalse(head.isMerge());
 495 
 496             var diffs = head.parentDiffs();
 497             assertEquals(1, diffs.size());
 498 
 499             var diff = diffs.get(0);
 500             assertEquals(hash1, diff.from());
 501             assertEquals(head.hash(), diff.to());
 502 
<span class="line-modified"> 503             assertEquals(0, diff.removed());</span>
<span class="line-modified"> 504             assertEquals(0, diff.modified());</span>
<span class="line-modified"> 505             assertEquals(2, diff.added());</span>

 506 
 507             var patches = diff.patches();
 508             assertEquals(1, patches.size());
 509 
 510             var patch = patches.get(0).asTextualPatch();
 511             assertTrue(patch.status().isModified());
 512             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 513             assertTrue(patch.source().type().get().isRegularNonExecutable());
 514             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 515             assertTrue(patch.target().type().get().isRegularNonExecutable());
 516 
 517             var hunks = patch.hunks();
 518             assertEquals(1, hunks.size());
 519 
 520             var hunk = hunks.get(0);
 521             assertEquals(new Range(2, 0), hunk.source().range());
 522             assertEquals(new Range(2, 2), hunk.target().range());
 523 
 524             assertLinesEquals(List.of(), hunk.source().lines());
 525             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
</pre>
<hr />
<pre>
 590             assertEquals(committerEmail, commits.get(0).committer().email());
 591 
 592             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 593             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 594             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 595             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 596 
 597             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 598             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 599             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 600             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 601 
 602             var head = commits.get(0);
 603             assertEquals(hash2, head.parents().get(0));
 604             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 605 
 606             var diffs = head.parentDiffs();
 607             assertEquals(1, diffs.size());
 608             var diff = diffs.get(0);
 609 
<span class="line-modified"> 610             assertEquals(0, diff.removed());</span>
<span class="line-modified"> 611             assertEquals(0, diff.modified());</span>
<span class="line-modified"> 612             assertEquals(1, diff.added());</span>

 613 
 614             var patches = diff.patches();
 615             assertEquals(1, patches.size());
 616             var patch = patches.get(0).asTextualPatch();
 617             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 618 
 619             var hunks = patch.hunks();
 620             assertEquals(1, hunks.size());
 621             var hunk = hunks.get(0);
 622             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 623         }
 624     }
 625 
 626     @ParameterizedTest
 627     @EnumSource(VCS.class)
 628     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 629         try (var dir = new TemporaryDirectory()) {
 630             var r = Repository.init(dir.path(), vcs);
 631             assertTrue(r.isEmpty());
 632         }
</pre>
<hr />
<pre>
 882 
 883             var patch = patches.get(0).asTextualPatch();
 884             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 885             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 886             assertTrue(patch.source().type().get().isRegularNonExecutable());
 887             assertTrue(patch.target().type().get().isRegularNonExecutable());
 888             assertTrue(patch.status().isModified());
 889 
 890             var hunks = patch.hunks();
 891             assertEquals(1, hunks.size());
 892 
 893             var hunk = hunks.get(0);
 894             assertEquals(2, hunk.source().range().start());
 895             assertEquals(0, hunk.source().range().count());
 896             assertEquals(0, hunk.source().lines().size());
 897 
 898             assertEquals(2, hunk.target().range().start());
 899             assertEquals(1, hunk.target().range().count());
 900             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 901 
<span class="line-modified"> 902             assertEquals(1, hunk.added());</span>
<span class="line-modified"> 903             assertEquals(0, hunk.removed());</span>
<span class="line-modified"> 904             assertEquals(0, hunk.modified());</span>

 905         }
 906     }
 907 
 908     @ParameterizedTest
 909     @EnumSource(VCS.class)
 910     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 911         try (var dir = new TemporaryDirectory()) {
 912             var r = Repository.init(dir.path(), vcs);
 913 
 914             var readme = dir.path().resolve(&quot;README&quot;);
 915             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 916 
 917             var building = dir.path().resolve(&quot;BUILDING&quot;);
 918             Files.write(building, List.of(&quot;make&quot;));
 919 
 920             r.add(readme);
 921             r.add(building);
 922             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 923 
 924             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
</pre>
<hr />
<pre>
 999 
1000             var patch = patches.get(0).asTextualPatch();
1001             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1002             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1003             assertTrue(patch.source().type().get().isRegularNonExecutable());
1004             assertTrue(patch.target().type().get().isRegularNonExecutable());
1005             assertTrue(patch.status().isModified());
1006 
1007             var hunks = patch.hunks();
1008             assertEquals(2, hunks.size());
1009 
1010             var hunk1 = hunks.get(0);
1011             assertEquals(1, hunk1.source().range().start());
1012             assertEquals(1, hunk1.source().range().count());
1013             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());
1014 
1015             assertEquals(1, hunk1.target().range().start());
1016             assertEquals(2, hunk1.target().range().count());
1017             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
1018 
<span class="line-modified">1019             assertEquals(1, hunk1.added());</span>
<span class="line-modified">1020             assertEquals(0, hunk1.removed());</span>
<span class="line-modified">1021             assertEquals(1, hunk1.modified());</span>

1022 
1023             var hunk2 = hunks.get(1);
1024             assertEquals(3, hunk2.source().range().start());
1025             assertEquals(1, hunk2.source().range().count());
1026             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());
1027 
1028             assertEquals(4, hunk2.target().range().start());
1029             assertEquals(1, hunk2.target().range().count());
1030             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());
1031 
<span class="line-modified">1032             assertEquals(0, hunk2.added());</span>
<span class="line-modified">1033             assertEquals(0, hunk2.removed());</span>
<span class="line-modified">1034             assertEquals(1, hunk2.modified());</span>

1035         }
1036     }
1037 
1038     @ParameterizedTest
1039     @EnumSource(VCS.class)
1040     void testDiffWithRemoval(VCS vcs) throws IOException {
1041         try (var dir = new TemporaryDirectory()) {
1042             var r = Repository.init(dir.path(), vcs);
1043 
1044             var readme = dir.path().resolve(&quot;README&quot;);
1045             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1046 
1047             r.add(readme);
1048             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1049 
1050             Files.delete(readme);
1051             r.remove(readme);
1052             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1053 
1054             var diff = r.diff(first, second);
</pre>
<hr />
<pre>
1060 
1061             var patch = patches.get(0).asTextualPatch();
1062             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1063             assertTrue(patch.target().path().isEmpty());
1064             assertTrue(patch.source().type().get().isRegularNonExecutable());
1065             assertTrue(patch.target().type().isEmpty());
1066             assertTrue(patch.status().isDeleted());
1067 
1068             var hunks = patch.hunks();
1069             assertEquals(1, hunks.size());
1070 
1071             var hunk = hunks.get(0);
1072             assertEquals(1, hunk.source().range().start());
1073             assertEquals(1, hunk.source().range().count());
1074             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1075 
1076             assertEquals(0, hunk.target().range().start());
1077             assertEquals(0, hunk.target().range().count());
1078             assertLinesEquals(List.of(), hunk.target().lines());
1079 
<span class="line-modified">1080             assertEquals(0, hunk.added());</span>
<span class="line-modified">1081             assertEquals(1, hunk.removed());</span>
<span class="line-modified">1082             assertEquals(0, hunk.modified());</span>

1083         }
1084     }
1085 
1086     @ParameterizedTest
1087     @EnumSource(VCS.class)
1088     void testDiffWithAddition(VCS vcs) throws IOException {
1089         try (var dir = new TemporaryDirectory()) {
1090             var r = Repository.init(dir.path(), vcs);
1091 
1092             var readme = dir.path().resolve(&quot;README&quot;);
1093             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1094 
1095             r.add(readme);
1096             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1097 
1098             var building = dir.path().resolve(&quot;BUILDING&quot;);
1099             Files.write(building, List.of(&quot;make&quot;));
1100             r.add(building);
1101             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1102 
</pre>
<hr />
<pre>
1109 
1110             var patch = patches.get(0).asTextualPatch();
1111             assertTrue(patch.source().path().isEmpty());
1112             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1113             assertTrue(patch.source().type().isEmpty());
1114             assertTrue(patch.target().type().get().isRegularNonExecutable());
1115             assertTrue(patch.status().isAdded());
1116 
1117             var hunks = patch.hunks();
1118             assertEquals(1, hunks.size());
1119 
1120             var hunk = hunks.get(0);
1121             assertEquals(0, hunk.source().range().start());
1122             assertEquals(0, hunk.source().range().count());
1123             assertLinesEquals(List.of(), hunk.source().lines());
1124 
1125             assertEquals(1, hunk.target().range().start());
1126             assertEquals(1, hunk.target().range().count());
1127             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());
1128 
<span class="line-modified">1129             assertEquals(1, hunk.added());</span>
<span class="line-modified">1130             assertEquals(0, hunk.removed());</span>
<span class="line-modified">1131             assertEquals(0, hunk.modified());</span>

1132         }
1133     }
1134 
1135     @ParameterizedTest
1136     @EnumSource(VCS.class)
1137     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1138         try (var dir = new TemporaryDirectory()) {
1139             var r = Repository.init(dir.path(), vcs);
1140 
1141             var readme = dir.path().resolve(&quot;README&quot;);
1142             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1143 
1144             r.add(readme);
1145             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1146 
1147             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1148             var diff = r.diff(first);
1149 
1150             assertEquals(first, diff.from());
1151             assertNull(diff.to());
</pre>
<hr />
<pre>
1155 
1156             var patch = patches.get(0).asTextualPatch();
1157             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1158             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1159             assertTrue(patch.source().type().get().isRegularNonExecutable());
1160             assertTrue(patch.target().type().get().isRegularNonExecutable());
1161             assertTrue(patch.status().isModified());
1162 
1163             var hunks = patch.hunks();
1164             assertEquals(1, hunks.size());
1165 
1166             var hunk = hunks.get(0);
1167             assertEquals(2, hunk.source().range().start());
1168             assertEquals(0, hunk.source().range().count());
1169             assertLinesEquals(List.of(), hunk.source().lines());
1170 
1171             assertEquals(2, hunk.target().range().start());
1172             assertEquals(1, hunk.target().range().count());
1173             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1174 
<span class="line-modified">1175             assertEquals(1, hunk.added());</span>
<span class="line-modified">1176             assertEquals(0, hunk.removed());</span>
<span class="line-modified">1177             assertEquals(0, hunk.modified());</span>

1178         }
1179     }
1180 
1181     @ParameterizedTest
1182     @EnumSource(VCS.class)
1183     void testCommitMetadata(VCS vcs) throws IOException {
1184         try (var dir = new TemporaryDirectory()) {
1185             var r = Repository.init(dir.path(), vcs);
1186 
1187             var readme = dir.path().resolve(&quot;README&quot;);
1188             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1189             r.add(readme);
1190             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1191 
1192             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1193             r.add(readme);
1194             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1195 
1196             var metadata = r.commitMetadata();
1197             assertEquals(2, metadata.size());
</pre>
<hr />
<pre>
1768                         .command(&quot;git&quot;, &quot;config&quot;, &quot;--local&quot;, &quot;core.autocrlf&quot;, &quot;false&quot;)
1769                         .directory(dir.path().toFile())
1770                         .start()
1771                         .waitFor();
1772                 assertEquals(0, exitCode);
1773             }
1774 
1775             var readme = dir.path().resolve(&quot;README&quot;);
1776             Files.writeString(readme, &quot;Line with Unix line ending\n&quot;);
1777             Files.writeString(readme, &quot;Line with Windows line ending\r\n&quot;, APPEND);
1778 
1779             r.add(readme);
1780             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1781 
1782             var commits = r.commits().asList();
1783             assertEquals(1, commits.size());
1784 
1785             var commit = commits.get(0);
1786             var diffs = commit.parentDiffs();
1787             var diff = diffs.get(0);
<span class="line-modified">1788             assertEquals(2, diff.added());</span>
1789 
1790             var patches = diff.patches();
1791             assertEquals(1, patches.size());
1792 
1793             var patch = patches.get(0).asTextualPatch();
1794             var hunks = patch.hunks();
1795             assertEquals(1, hunks.size());
1796 
1797             var hunk = hunks.get(0);
1798             assertEquals(new Range(0, 0), hunk.source().range());
1799             assertEquals(new Range(1, 2), hunk.target().range());
1800 
1801             assertEquals(
1802                     List.of(&quot;Line with Unix line ending&quot;, &quot;Line with Windows line ending\r&quot;),
1803                     hunk.target().lines());
1804         }
1805     }
1806 
1807     @ParameterizedTest
1808     @EnumSource(VCS.class)
</pre>
<hr />
<pre>
2009     }
2010 
2011     @ParameterizedTest
2012     @EnumSource(VCS.class)
2013     void testDiffWithFileList(VCS vcs) throws IOException {
2014         try (var dir = new TemporaryDirectory()) {
2015             var repo = Repository.init(dir.path(), vcs);
2016             var readme = repo.root().resolve(&quot;README&quot;);
2017             Files.writeString(readme, &quot;Hello\n&quot;);
2018             repo.add(readme);
2019 
2020             var contribute = repo.root().resolve(&quot;CONTRIBUTE&quot;);
2021             Files.writeString(contribute, &quot;1. Make changes\n&quot;);
2022             repo.add(contribute);
2023 
2024             var first = repo.commit(&quot;Added README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2025             Files.writeString(readme, &quot;World\n&quot;, WRITE, APPEND);
2026             Files.writeString(contribute, &quot;2. Run git commit&quot;, WRITE, APPEND);
2027 
2028             var diff = repo.diff(first, List.of(Path.of(&quot;README&quot;)));
<span class="line-modified">2029             assertEquals(1, diff.added());</span>
<span class="line-modified">2030             assertEquals(0, diff.modified());</span>
<span class="line-modified">2031             assertEquals(0, diff.removed());</span>

2032             var patches = diff.patches();
2033             assertEquals(1, patches.size());
2034             var patch = patches.get(0);
2035             assertTrue(patch.isTextual());
2036             assertTrue(patch.status().isModified());
2037             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
2038             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
2039 
2040             repo.add(readme);
2041             repo.add(contribute);
2042             var second = repo.commit(&quot;Updates to both README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2043 
2044             diff = repo.diff(first, second, List.of(Path.of(&quot;CONTRIBUTE&quot;)));
<span class="line-modified">2045             assertEquals(1, diff.added());</span>
<span class="line-modified">2046             assertEquals(0, diff.modified());</span>
<span class="line-modified">2047             assertEquals(0, diff.removed());</span>

2048             patches = diff.patches();
2049             assertEquals(1, patches.size());
2050             patch = patches.get(0);
2051             assertTrue(patch.isTextual());
2052             assertTrue(patch.status().isModified());
2053             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.source().path().get());
2054             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.target().path().get());
2055 
2056             diff = repo.diff(first, second, List.of(Path.of(&quot;DOES_NOT_EXIST&quot;)));
2057             assertEquals(0, diff.patches().size());
2058         }
2059     }
2060 
2061     @ParameterizedTest
2062     @EnumSource(VCS.class)
2063     void testWritingConfigValue(VCS vcs) throws IOException {
2064         try (var dir = new TemporaryDirectory()) {
2065             var repo = Repository.init(dir.path(), vcs);
2066             assertEquals(List.of(), repo.config(&quot;test.key&quot;));
2067             repo.config(&quot;test&quot;, &quot;key&quot;, &quot;value&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 273 
 274             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 275 
 276             assertEquals(1, commit.numParents());
 277             assertEquals(1, commit.parents().size());
 278 
 279             var parent = commit.parents().get(0);
 280             assertEquals(Hash.zero(), parent);
 281 
 282             assertTrue(commit.isInitialCommit());
 283             assertFalse(commit.isMerge());
 284             assertEquals(hash, commit.hash());
 285 
 286             var diffs = commit.parentDiffs();
 287             assertEquals(1, diffs.size());
 288 
 289             var diff = diffs.get(0);
 290             assertEquals(Hash.zero(), diff.from());
 291             assertEquals(hash, diff.to());
 292 
<span class="line-modified"> 293             var stats = diff.totalStats();</span>
<span class="line-modified"> 294             assertEquals(0, stats.removed());</span>
<span class="line-modified"> 295             assertEquals(0, stats.modified());</span>
<span class="line-added"> 296             assertEquals(1, stats.added());</span>
 297 
 298             var patches = diff.patches();
 299             assertEquals(1, patches.size());
 300 
 301             var patch = patches.get(0).asTextualPatch();
 302             assertTrue(patch.status().isAdded());
 303 
 304             assertTrue(patch.source().path().isEmpty());
 305             assertTrue(patch.source().type().isEmpty());
 306 
 307             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 308             assertTrue(patch.target().type().get().isRegularNonExecutable());
 309 
 310             var hunks = patch.hunks();
 311             assertEquals(1, hunks.size());
 312 
 313             var hunk = hunks.get(0);
 314             assertEquals(new Range(0, 0), hunk.source().range());
 315             assertEquals(new Range(1, 1), hunk.target().range());
 316 
</pre>
<hr />
<pre>
 352 
 353             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 354 
 355             assertEquals(1, commit.numParents());
 356             assertEquals(1, commit.parents().size());
 357 
 358             var parent = commit.parents().get(0);
 359             assertEquals(hash1, parent);
 360 
 361             assertFalse(commit.isInitialCommit());
 362             assertFalse(commit.isMerge());
 363             assertEquals(hash2, commit.hash());
 364 
 365             var diffs = commit.parentDiffs();
 366             assertEquals(1, diffs.size());
 367 
 368             var diff = diffs.get(0);
 369             assertEquals(hash1, diff.from());
 370             assertEquals(hash2, diff.to());
 371 
<span class="line-modified"> 372             var stats = diff.totalStats();</span>
<span class="line-modified"> 373             assertEquals(0, stats.removed());</span>
<span class="line-modified"> 374             assertEquals(0, stats.modified());</span>
<span class="line-added"> 375             assertEquals(1, stats.added());</span>
 376 
 377             var patches = diff.patches();
 378             assertEquals(1, patches.size());
 379 
 380             var patch = patches.get(0).asTextualPatch();
 381             assertTrue(patch.status().isModified());
 382             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 383             assertTrue(patch.source().type().get().isRegularNonExecutable());
 384             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 385             assertTrue(patch.target().type().get().isRegularNonExecutable());
 386 
 387             var hunks = patch.hunks();
 388             assertEquals(1, hunks.size());
 389 
 390             var hunk = hunks.get(0);
 391             assertEquals(new Range(2, 0), hunk.source().range());
 392             assertEquals(new Range(2, 1), hunk.target().range());
 393 
 394             assertLinesEquals(List.of(), hunk.source().lines());
 395             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
</pre>
<hr />
<pre>
 431             var commits = r.commits(refspec).asList();
 432             assertEquals(2, commits.size());
 433 
 434             assertEquals(hash1, commits.get(1).hash());
 435 
 436             var head = commits.get(0);
 437             assertNotEquals(hash2, head);
 438             assertNotEquals(hash3, head);
 439 
 440             assertEquals(hash1, head.parents().get(0));
 441             assertFalse(head.isInitialCommit());
 442             assertFalse(head.isMerge());
 443 
 444             var diffs = head.parentDiffs();
 445             assertEquals(1, diffs.size());
 446 
 447             var diff = diffs.get(0);
 448             assertEquals(hash1, diff.from());
 449             assertEquals(head.hash(), diff.to());
 450 
<span class="line-modified"> 451             var stats = diff.totalStats();</span>
<span class="line-modified"> 452             assertEquals(2, stats.removed());</span>
<span class="line-modified"> 453             assertEquals(0, stats.modified());</span>
<span class="line-added"> 454             assertEquals(0, stats.added());</span>
 455         }
 456     }
 457 
 458     @ParameterizedTest
 459     @EnumSource(VCS.class)
 460     void testSquash(VCS vcs) throws IOException {
 461         try (var dir = new TemporaryDirectory()) {
 462             var r = Repository.init(dir.path(), vcs);
 463 
 464             var readme = dir.path().resolve(&quot;README&quot;);
 465             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 466 
 467             r.add(readme);
 468             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 469 
 470             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 471             r.add(readme);
 472             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 473 
 474             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
</pre>
<hr />
<pre>
 486             var commits = r.commits(refspec).asList();
 487             assertEquals(2, commits.size());
 488 
 489             assertEquals(hash1, commits.get(1).hash());
 490 
 491             var head = commits.get(0);
 492             assertNotEquals(hash2, head);
 493             assertNotEquals(hash3, head);
 494 
 495             assertEquals(hash1, head.parents().get(0));
 496             assertFalse(head.isInitialCommit());
 497             assertFalse(head.isMerge());
 498 
 499             var diffs = head.parentDiffs();
 500             assertEquals(1, diffs.size());
 501 
 502             var diff = diffs.get(0);
 503             assertEquals(hash1, diff.from());
 504             assertEquals(head.hash(), diff.to());
 505 
<span class="line-modified"> 506             var stats = diff.totalStats();</span>
<span class="line-modified"> 507             assertEquals(0, stats.removed());</span>
<span class="line-modified"> 508             assertEquals(0, stats.modified());</span>
<span class="line-added"> 509             assertEquals(2, stats.added());</span>
 510 
 511             var patches = diff.patches();
 512             assertEquals(1, patches.size());
 513 
 514             var patch = patches.get(0).asTextualPatch();
 515             assertTrue(patch.status().isModified());
 516             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 517             assertTrue(patch.source().type().get().isRegularNonExecutable());
 518             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 519             assertTrue(patch.target().type().get().isRegularNonExecutable());
 520 
 521             var hunks = patch.hunks();
 522             assertEquals(1, hunks.size());
 523 
 524             var hunk = hunks.get(0);
 525             assertEquals(new Range(2, 0), hunk.source().range());
 526             assertEquals(new Range(2, 2), hunk.target().range());
 527 
 528             assertLinesEquals(List.of(), hunk.source().lines());
 529             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
</pre>
<hr />
<pre>
 594             assertEquals(committerEmail, commits.get(0).committer().email());
 595 
 596             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 597             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 598             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 599             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 600 
 601             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 602             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 603             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 604             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 605 
 606             var head = commits.get(0);
 607             assertEquals(hash2, head.parents().get(0));
 608             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 609 
 610             var diffs = head.parentDiffs();
 611             assertEquals(1, diffs.size());
 612             var diff = diffs.get(0);
 613 
<span class="line-modified"> 614             var stats = diff.totalStats();</span>
<span class="line-modified"> 615             assertEquals(0, stats.removed());</span>
<span class="line-modified"> 616             assertEquals(0, stats.modified());</span>
<span class="line-added"> 617             assertEquals(1, stats.added());</span>
 618 
 619             var patches = diff.patches();
 620             assertEquals(1, patches.size());
 621             var patch = patches.get(0).asTextualPatch();
 622             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 623 
 624             var hunks = patch.hunks();
 625             assertEquals(1, hunks.size());
 626             var hunk = hunks.get(0);
 627             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 628         }
 629     }
 630 
 631     @ParameterizedTest
 632     @EnumSource(VCS.class)
 633     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 634         try (var dir = new TemporaryDirectory()) {
 635             var r = Repository.init(dir.path(), vcs);
 636             assertTrue(r.isEmpty());
 637         }
</pre>
<hr />
<pre>
 887 
 888             var patch = patches.get(0).asTextualPatch();
 889             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 890             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 891             assertTrue(patch.source().type().get().isRegularNonExecutable());
 892             assertTrue(patch.target().type().get().isRegularNonExecutable());
 893             assertTrue(patch.status().isModified());
 894 
 895             var hunks = patch.hunks();
 896             assertEquals(1, hunks.size());
 897 
 898             var hunk = hunks.get(0);
 899             assertEquals(2, hunk.source().range().start());
 900             assertEquals(0, hunk.source().range().count());
 901             assertEquals(0, hunk.source().lines().size());
 902 
 903             assertEquals(2, hunk.target().range().start());
 904             assertEquals(1, hunk.target().range().count());
 905             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 906 
<span class="line-modified"> 907             var stats = hunk.stats();</span>
<span class="line-modified"> 908             assertEquals(1, stats.added());</span>
<span class="line-modified"> 909             assertEquals(0, stats.removed());</span>
<span class="line-added"> 910             assertEquals(0, stats.modified());</span>
 911         }
 912     }
 913 
 914     @ParameterizedTest
 915     @EnumSource(VCS.class)
 916     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 917         try (var dir = new TemporaryDirectory()) {
 918             var r = Repository.init(dir.path(), vcs);
 919 
 920             var readme = dir.path().resolve(&quot;README&quot;);
 921             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 922 
 923             var building = dir.path().resolve(&quot;BUILDING&quot;);
 924             Files.write(building, List.of(&quot;make&quot;));
 925 
 926             r.add(readme);
 927             r.add(building);
 928             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 929 
 930             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
</pre>
<hr />
<pre>
1005 
1006             var patch = patches.get(0).asTextualPatch();
1007             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1008             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1009             assertTrue(patch.source().type().get().isRegularNonExecutable());
1010             assertTrue(patch.target().type().get().isRegularNonExecutable());
1011             assertTrue(patch.status().isModified());
1012 
1013             var hunks = patch.hunks();
1014             assertEquals(2, hunks.size());
1015 
1016             var hunk1 = hunks.get(0);
1017             assertEquals(1, hunk1.source().range().start());
1018             assertEquals(1, hunk1.source().range().count());
1019             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());
1020 
1021             assertEquals(1, hunk1.target().range().start());
1022             assertEquals(2, hunk1.target().range().count());
1023             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
1024 
<span class="line-modified">1025             var stats1 = hunk1.stats();</span>
<span class="line-modified">1026             assertEquals(1, stats1.added());</span>
<span class="line-modified">1027             assertEquals(0, stats1.removed());</span>
<span class="line-added">1028             assertEquals(1, stats1.modified());</span>
1029 
1030             var hunk2 = hunks.get(1);
1031             assertEquals(3, hunk2.source().range().start());
1032             assertEquals(1, hunk2.source().range().count());
1033             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());
1034 
1035             assertEquals(4, hunk2.target().range().start());
1036             assertEquals(1, hunk2.target().range().count());
1037             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());
1038 
<span class="line-modified">1039             var stats2 = hunk2.stats();</span>
<span class="line-modified">1040             assertEquals(0, stats2.added());</span>
<span class="line-modified">1041             assertEquals(0, stats2.removed());</span>
<span class="line-added">1042             assertEquals(1, stats2.modified());</span>
1043         }
1044     }
1045 
1046     @ParameterizedTest
1047     @EnumSource(VCS.class)
1048     void testDiffWithRemoval(VCS vcs) throws IOException {
1049         try (var dir = new TemporaryDirectory()) {
1050             var r = Repository.init(dir.path(), vcs);
1051 
1052             var readme = dir.path().resolve(&quot;README&quot;);
1053             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1054 
1055             r.add(readme);
1056             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1057 
1058             Files.delete(readme);
1059             r.remove(readme);
1060             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1061 
1062             var diff = r.diff(first, second);
</pre>
<hr />
<pre>
1068 
1069             var patch = patches.get(0).asTextualPatch();
1070             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1071             assertTrue(patch.target().path().isEmpty());
1072             assertTrue(patch.source().type().get().isRegularNonExecutable());
1073             assertTrue(patch.target().type().isEmpty());
1074             assertTrue(patch.status().isDeleted());
1075 
1076             var hunks = patch.hunks();
1077             assertEquals(1, hunks.size());
1078 
1079             var hunk = hunks.get(0);
1080             assertEquals(1, hunk.source().range().start());
1081             assertEquals(1, hunk.source().range().count());
1082             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1083 
1084             assertEquals(0, hunk.target().range().start());
1085             assertEquals(0, hunk.target().range().count());
1086             assertLinesEquals(List.of(), hunk.target().lines());
1087 
<span class="line-modified">1088             var stats = hunk.stats();</span>
<span class="line-modified">1089             assertEquals(0, stats.added());</span>
<span class="line-modified">1090             assertEquals(1, stats.removed());</span>
<span class="line-added">1091             assertEquals(0, stats.modified());</span>
1092         }
1093     }
1094 
1095     @ParameterizedTest
1096     @EnumSource(VCS.class)
1097     void testDiffWithAddition(VCS vcs) throws IOException {
1098         try (var dir = new TemporaryDirectory()) {
1099             var r = Repository.init(dir.path(), vcs);
1100 
1101             var readme = dir.path().resolve(&quot;README&quot;);
1102             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1103 
1104             r.add(readme);
1105             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1106 
1107             var building = dir.path().resolve(&quot;BUILDING&quot;);
1108             Files.write(building, List.of(&quot;make&quot;));
1109             r.add(building);
1110             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1111 
</pre>
<hr />
<pre>
1118 
1119             var patch = patches.get(0).asTextualPatch();
1120             assertTrue(patch.source().path().isEmpty());
1121             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1122             assertTrue(patch.source().type().isEmpty());
1123             assertTrue(patch.target().type().get().isRegularNonExecutable());
1124             assertTrue(patch.status().isAdded());
1125 
1126             var hunks = patch.hunks();
1127             assertEquals(1, hunks.size());
1128 
1129             var hunk = hunks.get(0);
1130             assertEquals(0, hunk.source().range().start());
1131             assertEquals(0, hunk.source().range().count());
1132             assertLinesEquals(List.of(), hunk.source().lines());
1133 
1134             assertEquals(1, hunk.target().range().start());
1135             assertEquals(1, hunk.target().range().count());
1136             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());
1137 
<span class="line-modified">1138             var stats = hunk.stats();</span>
<span class="line-modified">1139             assertEquals(1, stats.added());</span>
<span class="line-modified">1140             assertEquals(0, stats.removed());</span>
<span class="line-added">1141             assertEquals(0, stats.modified());</span>
1142         }
1143     }
1144 
1145     @ParameterizedTest
1146     @EnumSource(VCS.class)
1147     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1148         try (var dir = new TemporaryDirectory()) {
1149             var r = Repository.init(dir.path(), vcs);
1150 
1151             var readme = dir.path().resolve(&quot;README&quot;);
1152             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1153 
1154             r.add(readme);
1155             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1156 
1157             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1158             var diff = r.diff(first);
1159 
1160             assertEquals(first, diff.from());
1161             assertNull(diff.to());
</pre>
<hr />
<pre>
1165 
1166             var patch = patches.get(0).asTextualPatch();
1167             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1168             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1169             assertTrue(patch.source().type().get().isRegularNonExecutable());
1170             assertTrue(patch.target().type().get().isRegularNonExecutable());
1171             assertTrue(patch.status().isModified());
1172 
1173             var hunks = patch.hunks();
1174             assertEquals(1, hunks.size());
1175 
1176             var hunk = hunks.get(0);
1177             assertEquals(2, hunk.source().range().start());
1178             assertEquals(0, hunk.source().range().count());
1179             assertLinesEquals(List.of(), hunk.source().lines());
1180 
1181             assertEquals(2, hunk.target().range().start());
1182             assertEquals(1, hunk.target().range().count());
1183             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1184 
<span class="line-modified">1185             var stats = hunk.stats();</span>
<span class="line-modified">1186             assertEquals(1, stats.added());</span>
<span class="line-modified">1187             assertEquals(0, stats.removed());</span>
<span class="line-added">1188             assertEquals(0, stats.modified());</span>
1189         }
1190     }
1191 
1192     @ParameterizedTest
1193     @EnumSource(VCS.class)
1194     void testCommitMetadata(VCS vcs) throws IOException {
1195         try (var dir = new TemporaryDirectory()) {
1196             var r = Repository.init(dir.path(), vcs);
1197 
1198             var readme = dir.path().resolve(&quot;README&quot;);
1199             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1200             r.add(readme);
1201             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1202 
1203             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1204             r.add(readme);
1205             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1206 
1207             var metadata = r.commitMetadata();
1208             assertEquals(2, metadata.size());
</pre>
<hr />
<pre>
1779                         .command(&quot;git&quot;, &quot;config&quot;, &quot;--local&quot;, &quot;core.autocrlf&quot;, &quot;false&quot;)
1780                         .directory(dir.path().toFile())
1781                         .start()
1782                         .waitFor();
1783                 assertEquals(0, exitCode);
1784             }
1785 
1786             var readme = dir.path().resolve(&quot;README&quot;);
1787             Files.writeString(readme, &quot;Line with Unix line ending\n&quot;);
1788             Files.writeString(readme, &quot;Line with Windows line ending\r\n&quot;, APPEND);
1789 
1790             r.add(readme);
1791             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1792 
1793             var commits = r.commits().asList();
1794             assertEquals(1, commits.size());
1795 
1796             var commit = commits.get(0);
1797             var diffs = commit.parentDiffs();
1798             var diff = diffs.get(0);
<span class="line-modified">1799             assertEquals(2, diff.totalStats().added());</span>
1800 
1801             var patches = diff.patches();
1802             assertEquals(1, patches.size());
1803 
1804             var patch = patches.get(0).asTextualPatch();
1805             var hunks = patch.hunks();
1806             assertEquals(1, hunks.size());
1807 
1808             var hunk = hunks.get(0);
1809             assertEquals(new Range(0, 0), hunk.source().range());
1810             assertEquals(new Range(1, 2), hunk.target().range());
1811 
1812             assertEquals(
1813                     List.of(&quot;Line with Unix line ending&quot;, &quot;Line with Windows line ending\r&quot;),
1814                     hunk.target().lines());
1815         }
1816     }
1817 
1818     @ParameterizedTest
1819     @EnumSource(VCS.class)
</pre>
<hr />
<pre>
2020     }
2021 
2022     @ParameterizedTest
2023     @EnumSource(VCS.class)
2024     void testDiffWithFileList(VCS vcs) throws IOException {
2025         try (var dir = new TemporaryDirectory()) {
2026             var repo = Repository.init(dir.path(), vcs);
2027             var readme = repo.root().resolve(&quot;README&quot;);
2028             Files.writeString(readme, &quot;Hello\n&quot;);
2029             repo.add(readme);
2030 
2031             var contribute = repo.root().resolve(&quot;CONTRIBUTE&quot;);
2032             Files.writeString(contribute, &quot;1. Make changes\n&quot;);
2033             repo.add(contribute);
2034 
2035             var first = repo.commit(&quot;Added README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2036             Files.writeString(readme, &quot;World\n&quot;, WRITE, APPEND);
2037             Files.writeString(contribute, &quot;2. Run git commit&quot;, WRITE, APPEND);
2038 
2039             var diff = repo.diff(first, List.of(Path.of(&quot;README&quot;)));
<span class="line-modified">2040             var diffStats = diff.totalStats();</span>
<span class="line-modified">2041             assertEquals(1, diffStats.added());</span>
<span class="line-modified">2042             assertEquals(0, diffStats.modified());</span>
<span class="line-added">2043             assertEquals(0, diffStats.removed());</span>
2044             var patches = diff.patches();
2045             assertEquals(1, patches.size());
2046             var patch = patches.get(0);
2047             assertTrue(patch.isTextual());
2048             assertTrue(patch.status().isModified());
2049             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
2050             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
2051 
2052             repo.add(readme);
2053             repo.add(contribute);
2054             var second = repo.commit(&quot;Updates to both README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2055 
2056             diff = repo.diff(first, second, List.of(Path.of(&quot;CONTRIBUTE&quot;)));
<span class="line-modified">2057             diffStats = diff.totalStats();</span>
<span class="line-modified">2058             assertEquals(1, diffStats.added());</span>
<span class="line-modified">2059             assertEquals(0, diffStats.modified());</span>
<span class="line-added">2060             assertEquals(0, diffStats.removed());</span>
2061             patches = diff.patches();
2062             assertEquals(1, patches.size());
2063             patch = patches.get(0);
2064             assertTrue(patch.isTextual());
2065             assertTrue(patch.status().isModified());
2066             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.source().path().get());
2067             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.target().path().get());
2068 
2069             diff = repo.diff(first, second, List.of(Path.of(&quot;DOES_NOT_EXIST&quot;)));
2070             assertEquals(0, diff.patches().size());
2071         }
2072     }
2073 
2074     @ParameterizedTest
2075     @EnumSource(VCS.class)
2076     void testWritingConfigValue(VCS vcs) throws IOException {
2077         try (var dir = new TemporaryDirectory()) {
2078             var repo = Repository.init(dir.path(), vcs);
2079             assertEquals(List.of(), repo.config(&quot;test.key&quot;));
2080             repo.config(&quot;test&quot;, &quot;key&quot;, &quot;value&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../main/java/org/openjdk/skara/vcs/TextualPatch.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="openjdk/converter/GitToHgConverterTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>