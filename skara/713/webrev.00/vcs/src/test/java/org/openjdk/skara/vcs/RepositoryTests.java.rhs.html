<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs;
  24 
  25 import org.junit.jupiter.api.Assumptions;
  26 import org.openjdk.skara.test.TemporaryDirectory;
  27 
  28 import org.junit.jupiter.api.Test;
  29 import org.junit.jupiter.params.ParameterizedTest;
  30 import org.junit.jupiter.params.provider.EnumSource;
  31 
  32 import java.io.IOException;
  33 import java.net.URI;
  34 import java.nio.file.*;
  35 import java.nio.file.attribute.*;
  36 import java.time.ZonedDateTime;
  37 import java.util.*;
  38 import java.util.stream.Collectors;
  39 
  40 import static java.nio.file.StandardOpenOption.*;
  41 import static org.junit.jupiter.api.Assertions.*;
  42 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  43 
  44 public class RepositoryTests {
  45 
  46     @ParameterizedTest
  47     @EnumSource(VCS.class)
  48     void testExistsOnMissingDirectory(VCS vcs) throws IOException {
  49         var d = Paths.get(&quot;/&quot;, &quot;this&quot;, &quot;path&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
  50         var r = Repository.get(d);
  51         assertTrue(r.isEmpty());
  52     }
  53 
  54     @ParameterizedTest
  55     @EnumSource(VCS.class)
  56     void testExistsOnEmptyDirectory(VCS vcs) throws IOException {
  57         try (var dir = new TemporaryDirectory()) {
  58             var r = Repository.get(dir.path());
  59             assertTrue(r.isEmpty());
  60         }
  61     }
  62 
  63     @ParameterizedTest
  64     @EnumSource(VCS.class)
  65     void testExistsOnInitializedRepository(VCS vcs) throws IOException {
  66         try (var dir = new TemporaryDirectory()) {
  67             var r = Repository.init(dir.path(), vcs);
  68             assertTrue(r.exists());
  69         }
  70     }
  71 
  72     @ParameterizedTest
  73     @EnumSource(VCS.class)
  74     void testExistsOnSubdir() throws IOException {
  75         try (var dir = new TemporaryDirectory()) {
  76             var r = Repository.init(dir.path(), VCS.GIT);
  77             assertTrue(r.exists());
  78 
  79             var subdir = Paths.get(dir.toString(), &quot;test&quot;);
  80             Files.createDirectories(subdir);
  81             var r2 = Repository.get(subdir);
  82             assertTrue(r2.get().exists());
  83         }
  84     }
  85 
  86     @ParameterizedTest
  87     @EnumSource(VCS.class)
  88     void testRootOnTopLevel() throws IOException {
  89         try (var dir = new TemporaryDirectory()) {
  90             var r = Repository.init(dir.path(), VCS.GIT);
  91             assertEquals(dir.toString(), r.root().toString());
  92         }
  93     }
  94 
  95     @ParameterizedTest
  96     @EnumSource(VCS.class)
  97     void testRootOnSubdirectory(VCS vcs) throws IOException {
  98         try (var dir = new TemporaryDirectory()) {
  99             var r = Repository.init(dir.path(), vcs);
 100             assertEquals(dir.toString(), r.root().toString());
 101 
 102             var subdir = Paths.get(dir.toString(), &quot;sub&quot;);
 103             Files.createDirectories(subdir);
 104 
 105             var r2 = Repository.get(subdir);
 106             assertEquals(dir.toString(), r2.get().root().toString());
 107         }
 108     }
 109 
 110     @ParameterizedTest
 111     @EnumSource(VCS.class)
 112     void testResolveOnEmptyRepository(VCS vcs) throws IOException {
 113         try (var dir = new TemporaryDirectory()) {
 114             var r = Repository.init(dir.path(), vcs);
 115             assertTrue(r.resolve(&quot;HEAD&quot;).isEmpty());
 116         }
 117     }
 118 
 119     @ParameterizedTest
 120     @EnumSource(VCS.class)
 121     void testResolveWithHEAD(VCS vcs) throws IOException {
 122         try (var dir = new TemporaryDirectory()) {
 123             var r = Repository.init(dir.path(), vcs);
 124 
 125             var readme = dir.path().resolve(&quot;README&quot;);
 126             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 127 
 128             r.add(readme);
 129             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 130             assertEquals(head, r.head());
 131         }
 132     }
 133 
 134     @ParameterizedTest
 135     @EnumSource(VCS.class)
 136     void testConfig(VCS vcs) throws IOException {
 137         try (var dir = new TemporaryDirectory()) {
 138             var r = Repository.init(dir.path(), vcs);
 139 
 140             if (vcs == VCS.GIT) {
 141                 var config = dir.path().resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 142                 Files.write(config, List.of(&quot;[user]&quot;, &quot;name = duke&quot;), WRITE, APPEND);
 143                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;user.name&quot;));
 144             } else if (vcs == VCS.HG) {
 145                 var config = dir.path().resolve(&quot;.hg&quot;).resolve(&quot;hgrc&quot;);
 146                 Files.write(config, List.of(&quot;[ui]&quot;, &quot;username = duke&quot;), WRITE, CREATE);
 147                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;ui.username&quot;));
 148             }
 149 
 150             assertEquals(&quot;duke&quot;, r.username().get());
 151         }
 152     }
 153 
 154     @ParameterizedTest
 155     @EnumSource(VCS.class)
 156     void testCurrentBranchOnEmptyRepository(VCS vcs) throws IOException {
 157         try (var dir = new TemporaryDirectory()) {
 158             var r = Repository.init(dir.path(), vcs);
 159             assertEquals(r.defaultBranch(), r.currentBranch().get());
 160         }
 161     }
 162 
 163     @ParameterizedTest
 164     @EnumSource(VCS.class)
 165     void testCheckout(VCS vcs) throws IOException {
 166         try (var dir = new TemporaryDirectory()) {
 167             var r = Repository.init(dir.path(), vcs);
 168 
 169             var readme = dir.path().resolve(&quot;README&quot;);
 170             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 171             r.add(readme);
 172 
 173             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 174             assertEquals(head1, r.head());
 175 
 176             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 177             r.add(readme);
 178 
 179             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 180             assertEquals(head2, r.head());
 181 
 182             r.checkout(head1, false);
 183             assertEquals(head1, r.head());
 184 
 185             r.checkout(head2, false);
 186             assertEquals(head2, r.head());
 187         }
 188     }
 189 
 190     @ParameterizedTest
 191     @EnumSource(VCS.class)
 192     void testLines(VCS vcs) throws IOException {
 193         try (var dir = new TemporaryDirectory()) {
 194             var r = Repository.init(dir.path(), vcs);
 195 
 196             var readme = dir.path().resolve(&quot;README&quot;);
 197             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 198             r.add(readme);
 199 
 200             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 201             assertEquals(List.of(&quot;Hello, readme!&quot;),
 202                          r.lines(readme, head1).orElseThrow());
 203 
 204             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 205             r.add(readme);
 206 
 207             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 208             assertEquals(List.of(&quot;Hello, readme!&quot;, &quot;Another line&quot;),
 209                          r.lines(readme, head2).orElseThrow());
 210         }
 211     }
 212 
 213     @ParameterizedTest
 214     @EnumSource(VCS.class)
 215     void testLinesInSubdir(VCS vcs) throws IOException {
 216         try (var dir = new TemporaryDirectory()) {
 217             Repository.init(dir.path(), vcs);
 218 
 219             var subdir = dir.path().resolve(&quot;sub&quot;);
 220             Files.createDirectories(subdir);
 221             var r = Repository.get(subdir).get();
 222 
 223             var readme = subdir.getParent().resolve(&quot;README&quot;);
 224             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 225             r.add(readme);
 226 
 227             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 228             assertEquals(List.of(&quot;Hello, readme!&quot;),
 229                          r.lines(readme, head).orElseThrow());
 230 
 231             var example = subdir.resolve(&quot;EXAMPLE&quot;);
 232             Files.write(example, List.of(&quot;An example&quot;));
 233             r.add(example);
 234 
 235             var head2 = r.commit(&quot;Add EXAMPLE&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 236             assertEquals(List.of(&quot;An example&quot;),
 237                          r.lines(example, head2).orElseThrow());
 238         }
 239     }
 240 
 241     @ParameterizedTest
 242     @EnumSource(VCS.class)
 243     void testCommitListingOnEmptyRepo(VCS vcs) throws IOException {
 244         try (var dir = new TemporaryDirectory()) {
 245             var r = Repository.init(dir.path(), vcs);
 246             assertTrue(r.commits().asList().isEmpty());
 247         }
 248     }
 249 
 250     @ParameterizedTest
 251     @EnumSource(VCS.class)
 252     void testCommitListingWithSingleCommit(VCS vcs) throws IOException {
 253         try (var dir = new TemporaryDirectory()) {
 254             var r = Repository.init(dir.path(), vcs);
 255 
 256             var readme = dir.path().resolve(&quot;README&quot;);
 257             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 258 
 259             r.add(readme);
 260 
 261             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 262             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 263             var hash = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;, committerName, committerEmail);
 264 
 265             var commits = r.commits().asList();
 266             assertEquals(1, commits.size());
 267 
 268             var commit = commits.get(0);
 269             assertEquals(&quot;duke&quot;, commit.author().name());
 270             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 271             assertEquals(committerName, commit.committer().name());
 272             assertEquals(committerEmail, commit.committer().email());
 273 
 274             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 275 
 276             assertEquals(1, commit.numParents());
 277             assertEquals(1, commit.parents().size());
 278 
 279             var parent = commit.parents().get(0);
 280             assertEquals(Hash.zero(), parent);
 281 
 282             assertTrue(commit.isInitialCommit());
 283             assertFalse(commit.isMerge());
 284             assertEquals(hash, commit.hash());
 285 
 286             var diffs = commit.parentDiffs();
 287             assertEquals(1, diffs.size());
 288 
 289             var diff = diffs.get(0);
 290             assertEquals(Hash.zero(), diff.from());
 291             assertEquals(hash, diff.to());
 292 
<a name="1" id="anc1"></a><span class="line-modified"> 293             var stats = diff.totalStats();</span>
<span class="line-modified"> 294             assertEquals(0, stats.removed());</span>
<span class="line-modified"> 295             assertEquals(0, stats.modified());</span>
<span class="line-added"> 296             assertEquals(1, stats.added());</span>
 297 
 298             var patches = diff.patches();
 299             assertEquals(1, patches.size());
 300 
 301             var patch = patches.get(0).asTextualPatch();
 302             assertTrue(patch.status().isAdded());
 303 
 304             assertTrue(patch.source().path().isEmpty());
 305             assertTrue(patch.source().type().isEmpty());
 306 
 307             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 308             assertTrue(patch.target().type().get().isRegularNonExecutable());
 309 
 310             var hunks = patch.hunks();
 311             assertEquals(1, hunks.size());
 312 
 313             var hunk = hunks.get(0);
 314             assertEquals(new Range(0, 0), hunk.source().range());
 315             assertEquals(new Range(1, 1), hunk.target().range());
 316 
 317             assertLinesEquals(List.of(), hunk.source().lines());
 318             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 319         }
 320     }
 321 
 322     static String stripTrailingCR(String line) {
 323         return line.endsWith(&quot;\r&quot;) ? line.substring(0, line.length() - 1) : line;
 324     }
 325 
 326     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {
 327         assertEquals(expected, actual.stream().map(RepositoryTests::stripTrailingCR).collect(Collectors.toList()));
 328     }
 329 
 330     @ParameterizedTest
 331     @EnumSource(VCS.class)
 332     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 333         try (var dir = new TemporaryDirectory()) {
 334             var r = Repository.init(dir.path(), vcs);
 335 
 336             var readme = dir.path().resolve(&quot;README&quot;);
 337             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 338 
 339             r.add(readme);
 340             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 341 
 342             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 343             r.add(readme);
 344             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 345 
 346             var commits = r.commits().asList();
 347             assertEquals(2, commits.size());
 348 
 349             var commit = commits.get(0);
 350             assertEquals(&quot;duke&quot;, commit.author().name());
 351             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 352 
 353             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 354 
 355             assertEquals(1, commit.numParents());
 356             assertEquals(1, commit.parents().size());
 357 
 358             var parent = commit.parents().get(0);
 359             assertEquals(hash1, parent);
 360 
 361             assertFalse(commit.isInitialCommit());
 362             assertFalse(commit.isMerge());
 363             assertEquals(hash2, commit.hash());
 364 
 365             var diffs = commit.parentDiffs();
 366             assertEquals(1, diffs.size());
 367 
 368             var diff = diffs.get(0);
 369             assertEquals(hash1, diff.from());
 370             assertEquals(hash2, diff.to());
 371 
<a name="2" id="anc2"></a><span class="line-modified"> 372             var stats = diff.totalStats();</span>
<span class="line-modified"> 373             assertEquals(0, stats.removed());</span>
<span class="line-modified"> 374             assertEquals(0, stats.modified());</span>
<span class="line-added"> 375             assertEquals(1, stats.added());</span>
 376 
 377             var patches = diff.patches();
 378             assertEquals(1, patches.size());
 379 
 380             var patch = patches.get(0).asTextualPatch();
 381             assertTrue(patch.status().isModified());
 382             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 383             assertTrue(patch.source().type().get().isRegularNonExecutable());
 384             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 385             assertTrue(patch.target().type().get().isRegularNonExecutable());
 386 
 387             var hunks = patch.hunks();
 388             assertEquals(1, hunks.size());
 389 
 390             var hunk = hunks.get(0);
 391             assertEquals(new Range(2, 0), hunk.source().range());
 392             assertEquals(new Range(2, 1), hunk.target().range());
 393 
 394             assertLinesEquals(List.of(), hunk.source().lines());
 395             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
 396         }
 397     }
 398 
 399     @ParameterizedTest
 400     @EnumSource(VCS.class)
 401     void testSquashDeletes(VCS vcs) throws IOException {
 402         try (var dir = new TemporaryDirectory()) {
 403             var r = Repository.init(dir.path(), vcs);
 404 
 405             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 406             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 407             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 408             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 409             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 410             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 411 
 412             r.add(file1, file2, file3);
 413             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 414 
 415             Files.delete(file2);
 416             r.remove(file2);
 417             var hash2 = r.commit(&quot;Remove file 2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 418 
 419             Files.delete(file3);
 420             r.remove(file3);
 421             var hash3 = r.commit(&quot;Remove file 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 422 
 423             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 424             assertEquals(3, r.commits(refspec).asList().size());
 425 
 426             r.checkout(hash1, false);
 427             r.squash(hash3);
 428             r.commit(&quot;Squashed remove of file 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 429 
 430             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 431             var commits = r.commits(refspec).asList();
 432             assertEquals(2, commits.size());
 433 
 434             assertEquals(hash1, commits.get(1).hash());
 435 
 436             var head = commits.get(0);
 437             assertNotEquals(hash2, head);
 438             assertNotEquals(hash3, head);
 439 
 440             assertEquals(hash1, head.parents().get(0));
 441             assertFalse(head.isInitialCommit());
 442             assertFalse(head.isMerge());
 443 
 444             var diffs = head.parentDiffs();
 445             assertEquals(1, diffs.size());
 446 
 447             var diff = diffs.get(0);
 448             assertEquals(hash1, diff.from());
 449             assertEquals(head.hash(), diff.to());
 450 
<a name="3" id="anc3"></a><span class="line-modified"> 451             var stats = diff.totalStats();</span>
<span class="line-modified"> 452             assertEquals(2, stats.removed());</span>
<span class="line-modified"> 453             assertEquals(0, stats.modified());</span>
<span class="line-added"> 454             assertEquals(0, stats.added());</span>
 455         }
 456     }
 457 
 458     @ParameterizedTest
 459     @EnumSource(VCS.class)
 460     void testSquash(VCS vcs) throws IOException {
 461         try (var dir = new TemporaryDirectory()) {
 462             var r = Repository.init(dir.path(), vcs);
 463 
 464             var readme = dir.path().resolve(&quot;README&quot;);
 465             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 466 
 467             r.add(readme);
 468             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 469 
 470             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 471             r.add(readme);
 472             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 473 
 474             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
 475             r.add(readme);
 476             var hash3 = r.commit(&quot;Modify README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 477 
 478             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 479             assertEquals(3, r.commits(refspec).asList().size());
 480 
 481             r.checkout(hash1, false);
 482             r.squash(hash3);
 483             r.commit(&quot;Squashed commits 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 484 
 485             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 486             var commits = r.commits(refspec).asList();
 487             assertEquals(2, commits.size());
 488 
 489             assertEquals(hash1, commits.get(1).hash());
 490 
 491             var head = commits.get(0);
 492             assertNotEquals(hash2, head);
 493             assertNotEquals(hash3, head);
 494 
 495             assertEquals(hash1, head.parents().get(0));
 496             assertFalse(head.isInitialCommit());
 497             assertFalse(head.isMerge());
 498 
 499             var diffs = head.parentDiffs();
 500             assertEquals(1, diffs.size());
 501 
 502             var diff = diffs.get(0);
 503             assertEquals(hash1, diff.from());
 504             assertEquals(head.hash(), diff.to());
 505 
<a name="4" id="anc4"></a><span class="line-modified"> 506             var stats = diff.totalStats();</span>
<span class="line-modified"> 507             assertEquals(0, stats.removed());</span>
<span class="line-modified"> 508             assertEquals(0, stats.modified());</span>
<span class="line-added"> 509             assertEquals(2, stats.added());</span>
 510 
 511             var patches = diff.patches();
 512             assertEquals(1, patches.size());
 513 
 514             var patch = patches.get(0).asTextualPatch();
 515             assertTrue(patch.status().isModified());
 516             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 517             assertTrue(patch.source().type().get().isRegularNonExecutable());
 518             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 519             assertTrue(patch.target().type().get().isRegularNonExecutable());
 520 
 521             var hunks = patch.hunks();
 522             assertEquals(1, hunks.size());
 523 
 524             var hunk = hunks.get(0);
 525             assertEquals(new Range(2, 0), hunk.source().range());
 526             assertEquals(new Range(2, 2), hunk.target().range());
 527 
 528             assertLinesEquals(List.of(), hunk.source().lines());
 529             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
 530         }
 531     }
 532 
 533     @ParameterizedTest
 534     @EnumSource(VCS.class)
 535     void testMergeBase(VCS vcs) throws IOException {
 536         try (var dir = new TemporaryDirectory()) {
 537             var r = Repository.init(dir.path(), vcs);
 538 
 539             var readme = dir.path().resolve(&quot;README&quot;);
 540             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 541 
 542             r.add(readme);
 543             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 544 
 545             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 546             r.add(readme);
 547             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 548 
 549             r.checkout(hash1, false);
 550             Files.write(readme, List.of(&quot;A conflicting line&quot;), WRITE, APPEND);
 551             r.add(readme);
 552             var hash3 = r.commit(&quot;Branching README modification&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 553 
 554             assertEquals(hash1, r.mergeBase(hash2, hash3));
 555         }
 556     }
 557 
 558     @ParameterizedTest
 559     @EnumSource(VCS.class)
 560     void testRebase(VCS vcs) throws IOException {
 561         try (var dir = new TemporaryDirectory()) {
 562             var r = Repository.init(dir.path(), vcs);
 563 
 564             var readme = dir.path().resolve(&quot;README&quot;);
 565             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 566 
 567             r.add(readme);
 568             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 569 
 570             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 571             r.add(readme);
 572             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 573 
 574             r.checkout(hash1, false);
 575 
 576             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
 577             Files.write(contributing, List.of(&quot;Keep the patches coming&quot;));
 578             r.add(contributing);
 579             var hash3 = r.commit(&quot;Add independent change&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 580 
 581             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 582             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 583             r.rebase(hash2, committerName, committerEmail);
 584 
 585             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 586             var commits = r.commits(refspec).asList();
 587             assertEquals(3, commits.size());
 588             assertEquals(hash2, commits.get(1).hash());
 589             assertEquals(hash1, commits.get(2).hash());
 590 
 591             assertEquals(&quot;duke&quot;, commits.get(0).author().name());
 592             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(0).author().email());
 593             assertEquals(committerName, commits.get(0).committer().name());
 594             assertEquals(committerEmail, commits.get(0).committer().email());
 595 
 596             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 597             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 598             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 599             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 600 
 601             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 602             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 603             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 604             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 605 
 606             var head = commits.get(0);
 607             assertEquals(hash2, head.parents().get(0));
 608             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 609 
 610             var diffs = head.parentDiffs();
 611             assertEquals(1, diffs.size());
 612             var diff = diffs.get(0);
 613 
<a name="5" id="anc5"></a><span class="line-modified"> 614             var stats = diff.totalStats();</span>
<span class="line-modified"> 615             assertEquals(0, stats.removed());</span>
<span class="line-modified"> 616             assertEquals(0, stats.modified());</span>
<span class="line-added"> 617             assertEquals(1, stats.added());</span>
 618 
 619             var patches = diff.patches();
 620             assertEquals(1, patches.size());
 621             var patch = patches.get(0).asTextualPatch();
 622             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 623 
 624             var hunks = patch.hunks();
 625             assertEquals(1, hunks.size());
 626             var hunk = hunks.get(0);
 627             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 628         }
 629     }
 630 
 631     @ParameterizedTest
 632     @EnumSource(VCS.class)
 633     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 634         try (var dir = new TemporaryDirectory()) {
 635             var r = Repository.init(dir.path(), vcs);
 636             assertTrue(r.isEmpty());
 637         }
 638     }
 639 
 640     @ParameterizedTest
 641     @EnumSource(VCS.class)
 642     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 643         try (var dir = new TemporaryDirectory()) {
 644             var r = Repository.init(dir.path(), vcs);
 645 
 646             var readme = dir.path().resolve(&quot;README&quot;);
 647             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 648 
 649             r.add(readme);
 650             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 651 
 652             assertFalse(r.isEmpty());
 653         }
 654     }
 655 
 656     @ParameterizedTest
 657     @EnumSource(VCS.class)
 658     void testEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 659         try (var dir = new TemporaryDirectory()) {
 660             var r = Repository.init(dir.path(), vcs);
 661             assertTrue(r.isHealthy());
 662         }
 663     }
 664 
 665     @ParameterizedTest
 666     @EnumSource(VCS.class)
 667     void testNonEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 668         try (var dir = new TemporaryDirectory()) {
 669             var r = Repository.init(dir.path(), vcs);
 670 
 671             var readme = dir.path().resolve(&quot;README&quot;);
 672             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 673 
 674             r.add(readme);
 675             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 676 
 677             assertTrue(r.isHealthy());
 678         }
 679     }
 680 
 681     @ParameterizedTest
 682     @EnumSource(VCS.class)
 683     void testNonCheckedOutRepositoryIsHealthy(VCS vcs) throws IOException {
 684         try (var dir1 = new TemporaryDirectory();
 685              var dir2 = new TemporaryDirectory()) {
 686             var r1 = Repository.init(dir1.path(), vcs);
 687 
 688             var readme = dir1.path().resolve(&quot;README&quot;);
 689             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 690 
 691             r1.add(readme);
 692             var hash = r1.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 693             r1.tag(hash, &quot;tag&quot;, &quot;tagging&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 694 
 695             var r2 = Repository.init(dir2.path(), vcs);
 696             r2.fetch(r1.root().toUri(), r1.defaultBranch().name());
 697 
 698             assertTrue(r2.isHealthy());
 699         }
 700     }
 701 
 702     @ParameterizedTest
 703     @EnumSource(VCS.class)
 704     void testBranchesOnEmptyRepository(VCS vcs) throws IOException {
 705         try (var dir = new TemporaryDirectory()) {
 706             var r = Repository.init(dir.path(), vcs);
 707             var expected = vcs == VCS.GIT ? List.of() : List.of(new Branch(&quot;default&quot;));
 708             assertEquals(List.of(), r.branches());
 709         }
 710     }
 711 
 712     @ParameterizedTest
 713     @EnumSource(VCS.class)
 714     void testBranchesOnNonEmptyRepository(VCS vcs) throws IOException {
 715         try (var dir = new TemporaryDirectory()) {
 716             var r = Repository.init(dir.path(), vcs);
 717 
 718             var readme = dir.path().resolve(&quot;README&quot;);
 719             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 720 
 721             r.add(readme);
 722             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 723 
 724             assertEquals(List.of(r.defaultBranch()), r.branches());
 725         }
 726     }
 727 
 728     @ParameterizedTest
 729     @EnumSource(VCS.class)
 730     void testTagsOnEmptyRepository(VCS vcs) throws IOException {
 731         try (var dir = new TemporaryDirectory()) {
 732             var r = Repository.init(dir.path(), vcs);
 733             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 734             assertEquals(expected, r.tags());
 735         }
 736     }
 737 
 738     @ParameterizedTest
 739     @EnumSource(VCS.class)
 740     void testTagsOnNonEmptyRepository(VCS vcs) throws IOException {
 741         try (var dir = new TemporaryDirectory()) {
 742             var r = Repository.init(dir.path(), vcs);
 743 
 744             var readme = dir.path().resolve(&quot;README&quot;);
 745             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 746 
 747             r.add(readme);
 748             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 749 
 750             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 751             assertEquals(expected, r.tags());
 752         }
 753     }
 754 
 755     @ParameterizedTest
 756     @EnumSource(VCS.class)
 757     void testFetchAndPush(VCS vcs) throws IOException {
 758         try (var dir = new TemporaryDirectory()) {
 759             var upstream = Repository.init(dir.path(), vcs);
 760 
 761             if (vcs == VCS.GIT) {
 762                 Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
 763                             List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
 764                             WRITE, APPEND);
 765             }
 766 
 767             var readme = dir.path().resolve(&quot;README&quot;);
 768             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 769 
 770             upstream.add(readme);
 771             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 772 
 773             try (var dir2 = new TemporaryDirectory()) {
 774                 var downstream = Repository.init(dir2.path(), vcs);
 775 
 776                  // note: forcing unix path separators for URI
 777                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
 778 
 779                 var fetchHead = downstream.fetch(upstreamURI, downstream.defaultBranch().name());
 780                 downstream.checkout(fetchHead, false);
 781 
 782                 var downstreamReadme = dir2.path().resolve(&quot;README&quot;);
 783                 Files.write(downstreamReadme, List.of(&quot;Downstream change&quot;), WRITE, APPEND);
 784 
 785                 downstream.add(downstreamReadme);
 786                 var head = downstream.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 787 
 788                 downstream.push(head, upstreamURI, downstream.defaultBranch().name());
 789             }
 790 
 791             upstream.checkout(upstream.resolve(upstream.defaultBranch().name()).get(), false);
 792 
 793             var commits = upstream.commits().asList();
 794             assertEquals(2, commits.size());
 795         }
 796     }
 797 
 798     @ParameterizedTest
 799     @EnumSource(VCS.class)
 800     void testClean(VCS vcs) throws IOException {
 801         try (var dir = new TemporaryDirectory()) {
 802             var r = Repository.init(dir.path(), vcs);
 803             r.clean();
 804 
 805             var readme = dir.path().resolve(&quot;README&quot;);
 806             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 807 
 808             r.add(readme);
 809             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 810 
 811             r.clean();
 812 
 813             assertEquals(hash1, r.head());
 814 
 815             Files.write(readme, List.of(&quot;A random change&quot;), WRITE, APPEND);
 816 
 817             r.clean();
 818 
 819             assertEquals(List.of(&quot;Hello, readme!&quot;), Files.readAllLines(readme));
 820 
 821             var untracked = dir.path().resolve(&quot;UNTRACKED&quot;);
 822             Files.write(untracked, List.of(&quot;Random text&quot;));
 823 
 824             r.clean();
 825 
 826             assertFalse(Files.exists(untracked));
 827 
 828             // Mercurial cannot currently deal with this situation
 829             if (vcs != VCS.HG) {
 830                 var subRepo = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
 831                 var subRepoFile = subRepo.root().resolve(&quot;file.txt&quot;);
 832                 Files.write(subRepoFile, List.of(&quot;Looks like a file in a submodule&quot;));
 833 
 834                 r.clean();
 835 
 836                 assertFalse(Files.exists(subRepoFile));
 837             }
 838         }
 839     }
 840 
 841     @ParameterizedTest
 842     @EnumSource(VCS.class)
 843     void testCleanIgnored(VCS vcs) throws IOException {
 844         try (var dir = new TemporaryDirectory()) {
 845             var r = Repository.init(dir.path(), vcs);
 846             r.clean();
 847 
 848             var readme = dir.path().resolve(&quot;README&quot;);
 849             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 850             Files.write(dir.path().resolve(&quot;.gitignore&quot;), List.of(&quot;*.txt&quot;));
 851             Files.write(dir.path().resolve(&quot;.hgignore&quot;), List.of(&quot;.*txt&quot;));
 852 
 853             r.add(readme);
 854             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 855 
 856             var ignored = dir.path().resolve(&quot;ignored.txt&quot;);
 857             Files.write(ignored, List.of(&quot;Random text&quot;));
 858 
 859             r.clean();
 860 
 861             assertFalse(Files.exists(ignored));
 862         }
 863     }
 864 
 865     @ParameterizedTest
 866     @EnumSource(VCS.class)
 867     void testDiffBetweenCommits(VCS vcs) throws IOException {
 868         try (var dir = new TemporaryDirectory()) {
 869             var r = Repository.init(dir.path(), vcs);
 870 
 871             var readme = dir.path().resolve(&quot;README&quot;);
 872             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 873 
 874             r.add(readme);
 875             var first = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 876 
 877             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
 878             r.add(readme);
 879             var second = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 880 
 881             var diff = r.diff(first, second);
 882             assertEquals(first, diff.from());
 883             assertEquals(second, diff.to());
 884 
 885             var patches = diff.patches();
 886             assertEquals(1, patches.size());
 887 
 888             var patch = patches.get(0).asTextualPatch();
 889             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 890             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 891             assertTrue(patch.source().type().get().isRegularNonExecutable());
 892             assertTrue(patch.target().type().get().isRegularNonExecutable());
 893             assertTrue(patch.status().isModified());
 894 
 895             var hunks = patch.hunks();
 896             assertEquals(1, hunks.size());
 897 
 898             var hunk = hunks.get(0);
 899             assertEquals(2, hunk.source().range().start());
 900             assertEquals(0, hunk.source().range().count());
 901             assertEquals(0, hunk.source().lines().size());
 902 
 903             assertEquals(2, hunk.target().range().start());
 904             assertEquals(1, hunk.target().range().count());
 905             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 906 
<a name="6" id="anc6"></a><span class="line-modified"> 907             var stats = hunk.stats();</span>
<span class="line-modified"> 908             assertEquals(1, stats.added());</span>
<span class="line-modified"> 909             assertEquals(0, stats.removed());</span>
<span class="line-added"> 910             assertEquals(0, stats.modified());</span>
 911         }
 912     }
 913 
 914     @ParameterizedTest
 915     @EnumSource(VCS.class)
 916     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 917         try (var dir = new TemporaryDirectory()) {
 918             var r = Repository.init(dir.path(), vcs);
 919 
 920             var readme = dir.path().resolve(&quot;README&quot;);
 921             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 922 
 923             var building = dir.path().resolve(&quot;BUILDING&quot;);
 924             Files.write(building, List.of(&quot;make&quot;));
 925 
 926             r.add(readme);
 927             r.add(building);
 928             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 929 
 930             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
 931             Files.write(building, List.of(&quot;make images&quot;), WRITE, TRUNCATE_EXISTING);
 932             r.add(readme);
 933             r.add(building);
 934             var second = r.commit(&quot;Modify README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 935 
 936             var diff = r.diff(first, second);
 937             assertEquals(first, diff.from());
 938             assertEquals(second, diff.to());
 939 
 940             var patches = diff.patches();
 941             assertEquals(2, patches.size());
 942 
 943             var patch1 = patches.get(0).asTextualPatch();
 944             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 945             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 946             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 947             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 948             assertTrue(patch1.status().isModified());
 949 
 950             var hunks1 = patch1.hunks();
 951             assertEquals(1, hunks1.size());
 952 
 953             var hunk1 = hunks1.get(0);
 954             assertEquals(1, hunk1.source().range().start());
 955             assertEquals(1, hunk1.source().range().count());
 956             assertLinesEquals(List.of(&quot;make&quot;), hunk1.source().lines());
 957 
 958             assertEquals(1, hunk1.target().range().start());
 959             assertEquals(1, hunk1.target().range().count());
 960             assertLinesEquals(List.of(&quot;make images&quot;), hunk1.target().lines());
 961 
 962             var patch2 = patches.get(1).asTextualPatch();
 963             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 964             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 965             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 966             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 967             assertTrue(patch2.status().isModified());
 968 
 969             var hunks2 = patch2.hunks();
 970             assertEquals(1, hunks2.size());
 971 
 972             var hunk2 = hunks2.get(0);
 973             assertEquals(1, hunk2.source().range().start());
 974             assertEquals(1, hunk2.source().range().count());
 975             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());
 976 
 977             assertEquals(1, hunk2.target().range().start());
 978             assertEquals(1, hunk2.target().range().count());
 979             assertLinesEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());
 980         }
 981     }
 982 
 983     @ParameterizedTest
 984     @EnumSource(VCS.class)
 985     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 986         try (var dir = new TemporaryDirectory()) {
 987             var r = Repository.init(dir.path(), vcs);
 988 
 989             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 990             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 991 
 992             r.add(abc);
 993             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 994 
 995             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 996             r.add(abc);
 997             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 998 
 999             var diff = r.diff(first, second);
1000             assertEquals(first, diff.from());
1001             assertEquals(second, diff.to());
1002 
1003             var patches = diff.patches();
1004             assertEquals(1, patches.size());
1005 
1006             var patch = patches.get(0).asTextualPatch();
1007             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1008             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1009             assertTrue(patch.source().type().get().isRegularNonExecutable());
1010             assertTrue(patch.target().type().get().isRegularNonExecutable());
1011             assertTrue(patch.status().isModified());
1012 
1013             var hunks = patch.hunks();
1014             assertEquals(2, hunks.size());
1015 
1016             var hunk1 = hunks.get(0);
1017             assertEquals(1, hunk1.source().range().start());
1018             assertEquals(1, hunk1.source().range().count());
1019             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());
1020 
1021             assertEquals(1, hunk1.target().range().start());
1022             assertEquals(2, hunk1.target().range().count());
1023             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
1024 
<a name="7" id="anc7"></a><span class="line-modified">1025             var stats1 = hunk1.stats();</span>
<span class="line-modified">1026             assertEquals(1, stats1.added());</span>
<span class="line-modified">1027             assertEquals(0, stats1.removed());</span>
<span class="line-added">1028             assertEquals(1, stats1.modified());</span>
1029 
1030             var hunk2 = hunks.get(1);
1031             assertEquals(3, hunk2.source().range().start());
1032             assertEquals(1, hunk2.source().range().count());
1033             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());
1034 
1035             assertEquals(4, hunk2.target().range().start());
1036             assertEquals(1, hunk2.target().range().count());
1037             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());
1038 
<a name="8" id="anc8"></a><span class="line-modified">1039             var stats2 = hunk2.stats();</span>
<span class="line-modified">1040             assertEquals(0, stats2.added());</span>
<span class="line-modified">1041             assertEquals(0, stats2.removed());</span>
<span class="line-added">1042             assertEquals(1, stats2.modified());</span>
1043         }
1044     }
1045 
1046     @ParameterizedTest
1047     @EnumSource(VCS.class)
1048     void testDiffWithRemoval(VCS vcs) throws IOException {
1049         try (var dir = new TemporaryDirectory()) {
1050             var r = Repository.init(dir.path(), vcs);
1051 
1052             var readme = dir.path().resolve(&quot;README&quot;);
1053             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1054 
1055             r.add(readme);
1056             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1057 
1058             Files.delete(readme);
1059             r.remove(readme);
1060             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1061 
1062             var diff = r.diff(first, second);
1063             assertEquals(first, diff.from());
1064             assertEquals(second, diff.to());
1065 
1066             var patches = diff.patches();
1067             assertEquals(1, patches.size());
1068 
1069             var patch = patches.get(0).asTextualPatch();
1070             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1071             assertTrue(patch.target().path().isEmpty());
1072             assertTrue(patch.source().type().get().isRegularNonExecutable());
1073             assertTrue(patch.target().type().isEmpty());
1074             assertTrue(patch.status().isDeleted());
1075 
1076             var hunks = patch.hunks();
1077             assertEquals(1, hunks.size());
1078 
1079             var hunk = hunks.get(0);
1080             assertEquals(1, hunk.source().range().start());
1081             assertEquals(1, hunk.source().range().count());
1082             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1083 
1084             assertEquals(0, hunk.target().range().start());
1085             assertEquals(0, hunk.target().range().count());
1086             assertLinesEquals(List.of(), hunk.target().lines());
1087 
<a name="9" id="anc9"></a><span class="line-modified">1088             var stats = hunk.stats();</span>
<span class="line-modified">1089             assertEquals(0, stats.added());</span>
<span class="line-modified">1090             assertEquals(1, stats.removed());</span>
<span class="line-added">1091             assertEquals(0, stats.modified());</span>
1092         }
1093     }
1094 
1095     @ParameterizedTest
1096     @EnumSource(VCS.class)
1097     void testDiffWithAddition(VCS vcs) throws IOException {
1098         try (var dir = new TemporaryDirectory()) {
1099             var r = Repository.init(dir.path(), vcs);
1100 
1101             var readme = dir.path().resolve(&quot;README&quot;);
1102             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1103 
1104             r.add(readme);
1105             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1106 
1107             var building = dir.path().resolve(&quot;BUILDING&quot;);
1108             Files.write(building, List.of(&quot;make&quot;));
1109             r.add(building);
1110             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1111 
1112             var diff = r.diff(first, second);
1113             assertEquals(first, diff.from());
1114             assertEquals(second, diff.to());
1115 
1116             var patches = diff.patches();
1117             assertEquals(1, patches.size());
1118 
1119             var patch = patches.get(0).asTextualPatch();
1120             assertTrue(patch.source().path().isEmpty());
1121             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1122             assertTrue(patch.source().type().isEmpty());
1123             assertTrue(patch.target().type().get().isRegularNonExecutable());
1124             assertTrue(patch.status().isAdded());
1125 
1126             var hunks = patch.hunks();
1127             assertEquals(1, hunks.size());
1128 
1129             var hunk = hunks.get(0);
1130             assertEquals(0, hunk.source().range().start());
1131             assertEquals(0, hunk.source().range().count());
1132             assertLinesEquals(List.of(), hunk.source().lines());
1133 
1134             assertEquals(1, hunk.target().range().start());
1135             assertEquals(1, hunk.target().range().count());
1136             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());
1137 
<a name="10" id="anc10"></a><span class="line-modified">1138             var stats = hunk.stats();</span>
<span class="line-modified">1139             assertEquals(1, stats.added());</span>
<span class="line-modified">1140             assertEquals(0, stats.removed());</span>
<span class="line-added">1141             assertEquals(0, stats.modified());</span>
1142         }
1143     }
1144 
1145     @ParameterizedTest
1146     @EnumSource(VCS.class)
1147     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1148         try (var dir = new TemporaryDirectory()) {
1149             var r = Repository.init(dir.path(), vcs);
1150 
1151             var readme = dir.path().resolve(&quot;README&quot;);
1152             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1153 
1154             r.add(readme);
1155             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1156 
1157             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1158             var diff = r.diff(first);
1159 
1160             assertEquals(first, diff.from());
1161             assertNull(diff.to());
1162 
1163             var patches = diff.patches();
1164             assertEquals(1, patches.size());
1165 
1166             var patch = patches.get(0).asTextualPatch();
1167             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1168             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1169             assertTrue(patch.source().type().get().isRegularNonExecutable());
1170             assertTrue(patch.target().type().get().isRegularNonExecutable());
1171             assertTrue(patch.status().isModified());
1172 
1173             var hunks = patch.hunks();
1174             assertEquals(1, hunks.size());
1175 
1176             var hunk = hunks.get(0);
1177             assertEquals(2, hunk.source().range().start());
1178             assertEquals(0, hunk.source().range().count());
1179             assertLinesEquals(List.of(), hunk.source().lines());
1180 
1181             assertEquals(2, hunk.target().range().start());
1182             assertEquals(1, hunk.target().range().count());
1183             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1184 
<a name="11" id="anc11"></a><span class="line-modified">1185             var stats = hunk.stats();</span>
<span class="line-modified">1186             assertEquals(1, stats.added());</span>
<span class="line-modified">1187             assertEquals(0, stats.removed());</span>
<span class="line-added">1188             assertEquals(0, stats.modified());</span>
1189         }
1190     }
1191 
1192     @ParameterizedTest
1193     @EnumSource(VCS.class)
1194     void testCommitMetadata(VCS vcs) throws IOException {
1195         try (var dir = new TemporaryDirectory()) {
1196             var r = Repository.init(dir.path(), vcs);
1197 
1198             var readme = dir.path().resolve(&quot;README&quot;);
1199             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1200             r.add(readme);
1201             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1202 
1203             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1204             r.add(readme);
1205             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1206 
1207             var metadata = r.commitMetadata();
1208             assertEquals(2, metadata.size());
1209 
1210             assertEquals(second, metadata.get(0).hash());
1211             assertEquals(List.of(&quot;Modified README&quot;), metadata.get(0).message());
1212 
1213             assertEquals(first, metadata.get(1).hash());
1214             assertEquals(List.of(&quot;Added README&quot;), metadata.get(1).message());
1215         }
1216     }
1217 
1218     @ParameterizedTest
1219     @EnumSource(VCS.class)
1220     void testCommitMetadataWithFiles(VCS vcs) throws IOException {
1221         try (var dir = new TemporaryDirectory()) {
1222             var r = Repository.init(dir.path(), vcs);
1223 
1224             var readme1 = dir.path().resolve(&quot;README_1&quot;);
1225             Files.write(readme1, List.of(&quot;1&quot;));
1226             r.add(readme1);
1227             var first = r.commit(&quot;Added README_1&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1228 
1229             var readme2 = dir.path().resolve(&quot;README_2&quot;);
1230             Files.write(readme2, List.of(&quot;2&quot;));
1231             r.add(readme2);
1232             var second = r.commit(&quot;Added README_2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1233 
1234             Files.write(readme2, List.of(&quot;3&quot;), WRITE, APPEND);
1235             r.add(readme2);
1236             var third = r.commit(&quot;Modified README_2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1237 
1238             var metadata = r.commitMetadata(List.of(Path.of(&quot;README_1&quot;)));
1239             assertEquals(1, metadata.size());
1240             assertEquals(first, metadata.get(0).hash());
1241 
1242             metadata = r.commitMetadata(List.of(Path.of(&quot;README_2&quot;)));
1243             assertEquals(2, metadata.size());
1244             assertEquals(third, metadata.get(0).hash());
1245             assertEquals(second, metadata.get(1).hash());
1246 
1247             metadata = r.commitMetadata(List.of(Path.of(&quot;README_1&quot;), Path.of(&quot;README_2&quot;)));
1248             assertEquals(3, metadata.size());
1249             assertEquals(third, metadata.get(0).hash());
1250             assertEquals(second, metadata.get(1).hash());
1251             assertEquals(first, metadata.get(2).hash());
1252         }
1253     }
1254 
1255     @ParameterizedTest
1256     @EnumSource(VCS.class)
1257     void testCommitMetadataWithReverse(VCS vcs) throws IOException {
1258         try (var dir = new TemporaryDirectory()) {
1259             var r = Repository.init(dir.path(), vcs);
1260 
1261             var readme = dir.path().resolve(&quot;README&quot;);
1262             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1263             r.add(readme);
1264             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1265 
1266             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1267             r.add(readme);
1268             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1269 
1270             var metadata = r.commitMetadata();
1271             assertEquals(2, metadata.size());
1272             assertEquals(second, metadata.get(0).hash());
1273             assertEquals(first, metadata.get(1).hash());
1274 
1275             metadata = r.commitMetadata(true);
1276             assertEquals(2, metadata.size());
1277             assertEquals(first, metadata.get(0).hash());
1278             assertEquals(second, metadata.get(1).hash());
1279         }
1280     }
1281 
1282     @ParameterizedTest
1283     @EnumSource(VCS.class)
1284     void testTrivialMerge(VCS vcs) throws IOException {
1285         try (var dir = new TemporaryDirectory()) {
1286             var r = Repository.init(dir.path(), vcs);
1287 
1288             var readme = dir.path().resolve(&quot;README&quot;);
1289             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1290             r.add(readme);
1291             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1292 
1293             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1294             r.add(readme);
1295             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1296 
1297             r.checkout(first, false);
1298 
1299             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1300             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1301             r.add(contributing);
1302             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1303 
1304             r.merge(second);
1305             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1306 
1307             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1308             var commits = r.commits(refspec).asList();
1309 
1310             assertEquals(4, commits.size());
1311 
1312             var merge = commits.get(0);
1313             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1314 
1315             var parents = new HashSet&lt;&gt;(merge.parents());
1316             assertEquals(2, parents.size());
1317             assertTrue(parents.contains(second));
1318             assertTrue(parents.contains(third));
1319 
1320             var diffs = merge.parentDiffs();
1321             assertEquals(2, diffs.size());
1322 
1323             var diff1 = diffs.get(0);
1324             assertEquals(merge.hash(), diff1.to());
1325             assertEquals(0, diff1.patches().size());
1326             assertTrue(parents.contains(diff1.from()));
1327 
1328             var diff2 = diffs.get(1);
1329             assertEquals(merge.hash(), diff2.to());
1330             assertEquals(0, diff2.patches().size());
1331             assertTrue(parents.contains(diff2.from()));
1332         }
1333     }
1334 
1335     @ParameterizedTest
1336     @EnumSource(VCS.class)
1337     void testMergeWithEdit(VCS vcs) throws IOException {
1338         try (var dir = new TemporaryDirectory()) {
1339             var r = Repository.init(dir.path(), vcs);
1340 
1341             var readme = dir.path().resolve(&quot;README&quot;);
1342             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1343             r.add(readme);
1344             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1345 
1346             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1347             r.add(readme);
1348             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1349 
1350             r.checkout(first, false);
1351 
1352             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1353             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1354             r.add(contributing);
1355             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1356 
1357             r.merge(second);
1358 
1359             Files.write(readme, List.of(&quot;One last line&quot;), WRITE, APPEND);
1360             r.add(readme);
1361             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1362 
1363             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1364             var commits = r.commits(refspec).asList();
1365 
1366             assertEquals(4, commits.size());
1367 
1368             var merge = commits.get(0);
1369             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1370 
1371             var parents = new HashSet&lt;&gt;(merge.parents());
1372             assertEquals(2, parents.size());
1373             assertTrue(parents.contains(second));
1374             assertTrue(parents.contains(third));
1375 
1376             var diffs = merge.parentDiffs();
1377             assertEquals(2, diffs.size());
1378 
1379             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1380             assertEquals(merge.hash(), secondDiff.to());
1381             assertEquals(1, secondDiff.patches().size());
1382             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1383 
1384             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1385             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1386             assertTrue(secondPatch.status().isModified());
1387             assertEquals(1, secondPatch.hunks().size());
1388 
1389             var secondHunk = secondPatch.hunks().get(0);
1390             assertLinesEquals(List.of(), secondHunk.source().lines());
1391             assertLinesEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());
1392 
1393             assertEquals(3, secondHunk.source().range().start());
1394             assertEquals(0, secondHunk.source().range().count());
1395             assertEquals(3, secondHunk.target().range().start());
1396             assertEquals(1, secondHunk.target().range().count());
1397 
1398             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1399             assertEquals(merge.hash(), thirdDiff.to());
1400             assertEquals(1, thirdDiff.patches().size());
1401             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1402 
1403             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1404             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1405             assertTrue(thirdPatch.status().isModified());
1406             assertEquals(1, thirdPatch.hunks().size());
1407 
1408             var thirdHunk = thirdPatch.hunks().get(0);
1409             assertLinesEquals(List.of(), thirdHunk.source().lines());
1410             assertLinesEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());
1411 
1412             assertEquals(2, thirdHunk.source().range().start());
1413             assertEquals(0, thirdHunk.source().range().count());
1414             assertEquals(2, thirdHunk.target().range().start());
1415             assertEquals(2, thirdHunk.target().range().count());
1416         }
1417     }
1418 
1419     @ParameterizedTest
1420     @EnumSource(VCS.class)
1421     void testDefaultBranch(VCS vcs) throws IOException {
1422         try (var dir = new TemporaryDirectory()) {
1423             var r = Repository.init(dir.path(), vcs);
1424             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1425             assertEquals(expected, r.defaultBranch().name());
1426         }
1427     }
1428 
1429     @ParameterizedTest
1430     @EnumSource(VCS.class)
1431     void testPaths(VCS vcs) throws IOException {
1432         try (var dir = new TemporaryDirectory()) {
1433             var r = Repository.init(dir.path(), vcs);
1434             var remote = vcs == VCS.GIT ? &quot;origin&quot; : &quot;default&quot;;
1435             r.setPaths(remote, &quot;http://pull&quot;, &quot;http://push&quot;);
1436             assertEquals(&quot;http://pull&quot;, r.pullPath(remote));
1437             assertEquals(&quot;http://push&quot;, r.pushPath(remote));
1438         }
1439     }
1440 
1441     @ParameterizedTest
1442     @EnumSource(VCS.class)
1443     void testIsValidRevisionRange(VCS vcs) throws IOException {
1444         try (var dir = new TemporaryDirectory()) {
1445             var r = Repository.init(dir.path(), vcs);
1446             assertFalse(r.isValidRevisionRange(&quot;foo&quot;));
1447 
1448             var readme = dir.path().resolve(&quot;README&quot;);
1449             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1450             r.add(readme);
1451             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1452 
1453             assertTrue(r.isValidRevisionRange(r.defaultBranch().toString()));
1454         }
1455     }
1456 
1457     @ParameterizedTest
1458     @EnumSource(VCS.class)
1459     void testDefaultTag(VCS vcs) throws IOException {
1460         try (var dir = new TemporaryDirectory()) {
1461             var r = Repository.init(dir.path(), vcs);
1462             var expected = vcs == VCS.GIT ? Optional.empty() : Optional.of(new Tag(&quot;tip&quot;));
1463             assertEquals(expected, r.defaultTag());
1464         }
1465     }
1466 
1467     @ParameterizedTest
1468     @EnumSource(VCS.class)
1469     void testTag(VCS vcs) throws IOException {
1470         try (var dir = new TemporaryDirectory()) {
1471             var r = Repository.init(dir.path(), vcs);
1472 
1473             var readme = dir.path().resolve(&quot;README&quot;);
1474             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1475             r.add(readme);
1476             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1477 
1478             r.tag(first, &quot;test&quot;, &quot;Tagging test&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1479             var defaultTag = r.defaultTag().orElse(null);
1480             var nonDefaultTags = r.tags().stream()
1481                                   .filter(tag -&gt; !tag.equals(defaultTag))
1482                                   .map(Tag::toString)
1483                                   .collect(Collectors.toList());
1484             assertEquals(List.of(&quot;test&quot;), nonDefaultTags);
1485         }
1486     }
1487 
1488     @ParameterizedTest
1489     @EnumSource(VCS.class)
1490     void testIsClean(VCS vcs) throws IOException {
1491         try (var dir = new TemporaryDirectory()) {
1492             var r = Repository.init(dir.path(), vcs);
1493             assertTrue(r.isClean());
1494 
1495             var readme = dir.path().resolve(&quot;README&quot;);
1496             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1497             assertFalse(r.isClean());
1498 
1499             r.add(readme);
1500             assertFalse(r.isClean());
1501 
1502             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1503             assertTrue(r.isClean());
1504 
1505             Files.delete(readme);
1506             assertFalse(r.isClean());
1507 
1508             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1509             assertTrue(r.isClean());
1510         }
1511     }
1512 
1513     @ParameterizedTest
1514     @EnumSource(VCS.class)
1515     void testShowOnExecutableFiles(VCS vcs) throws IOException {
1516         try (var dir = new TemporaryDirectory()) {
1517             var r = Repository.init(dir.path(), vcs);
1518             assertTrue(r.isClean());
1519 
1520             var readOnlyExecutableFile = dir.path().resolve(&quot;hello.sh&quot;);
1521             Files.write(readOnlyExecutableFile, List.of(&quot;echo &#39;hello&#39;&quot;));
1522             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1523                 var permissions = PosixFilePermissions.fromString(&quot;r-xr-xr-x&quot;);
1524                 Files.setPosixFilePermissions(readOnlyExecutableFile, permissions);
1525             }
1526             r.add(readOnlyExecutableFile);
1527             var hash = r.commit(&quot;Added read only executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1528             assertEquals(Optional.of(List.of(&quot;echo &#39;hello&#39;&quot;)), r.lines(readOnlyExecutableFile, hash));
1529 
1530             var readWriteExecutableFile = dir.path().resolve(&quot;goodbye.sh&quot;);
1531             Files.write(readWriteExecutableFile, List.of(&quot;echo &#39;goodbye&#39;&quot;));
1532             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1533                 var permissions = PosixFilePermissions.fromString(&quot;rwxrwxrwx&quot;);
1534                 Files.setPosixFilePermissions(readWriteExecutableFile, permissions);
1535             }
1536             r.add(readWriteExecutableFile);
1537             var hash2 = r.commit(&quot;Added read-write executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1538             assertEquals(Optional.of(List.of(&quot;echo &#39;goodbye&#39;&quot;)), r.lines(readWriteExecutableFile, hash2));
1539         }
1540     }
1541 
1542     @Test
1543     void testGetAndExistsOnNonExistingDirectory() throws IOException {
1544         var nonExistingDirectory = Path.of(&quot;this&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
1545         assertEquals(Optional.empty(), Repository.get(nonExistingDirectory));
1546         assertEquals(false, Repository.exists(nonExistingDirectory));
1547     }
1548 
1549     @ParameterizedTest
1550     @EnumSource(VCS.class)
1551     void testDiffOnFilenamesWithSpace(VCS vcs) throws IOException {
1552         try (var dir = new TemporaryDirectory()) {
1553             var r = Repository.init(dir.path(), vcs);
1554             assertTrue(r.isClean());
1555 
1556             var fileWithSpaceInName = dir.path().resolve(&quot;hello world.txt&quot;);
1557             Files.writeString(fileWithSpaceInName, &quot;Hello world\n&quot;);
1558             r.add(fileWithSpaceInName);
1559             var hash1 = r.commit(&quot;Added file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1560             Files.writeString(fileWithSpaceInName, &quot;Goodbye world\n&quot;);
1561             r.add(fileWithSpaceInName);
1562             var hash2 = r.commit(&quot;Modified file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1563             var diff = r.diff(hash1, hash2);
1564             var patches = diff.patches();
1565             assertEquals(1, patches.size());
1566             var patch = patches.get(0);
1567             assertTrue(patch.target().path().isPresent());
1568             var path = patch.target().path().get();
1569             assertEquals(Path.of(&quot;hello world.txt&quot;), path);
1570         }
1571     }
1572 
1573     @Test
1574     void testSingleEmptyCommit() throws IOException, InterruptedException {
1575         try (var dir = new TemporaryDirectory()) {
1576             var r = Repository.init(dir.path(), VCS.GIT);
1577             assertTrue(r.isClean());
1578 
1579             // must ust git directly to be able to pass --allow-empty
1580             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1581             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1582             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1583             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1584             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1585             pb.directory(dir.path().toFile());
1586 
1587             var res = pb.start().waitFor();
1588             assertEquals(0, res);
1589 
1590             var commits = r.commits().asList();
1591             assertEquals(1, commits.size());
1592             var commit = commits.get(0);
1593             assertEquals(&quot;duke&quot;, commit.author().name());
1594             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1595             assertEquals(&quot;duke&quot;, commit.committer().name());
1596             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1597             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1598         }
1599     }
1600 
1601     @Test
1602     void testEmptyCommitWithParent() throws IOException, InterruptedException {
1603         try (var dir = new TemporaryDirectory()) {
1604             var r = Repository.init(dir.path(), VCS.GIT);
1605             assertTrue(r.isClean());
1606 
1607             var f = Files.createFile(dir.path().resolve(&quot;hello.txt&quot;));
1608             Files.writeString(f, &quot;Hello world\n&quot;);
1609             r.add(f);
1610             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1611 
1612             // must ust git directly to be able to pass --allow-empty
1613             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1614             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1615             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1616             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1617             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1618             pb.directory(dir.path().toFile());
1619 
1620             var res = pb.start().waitFor();
1621             assertEquals(0, res);
1622 
1623             var commits = r.commits().asList();
1624             assertEquals(2, commits.size());
1625             var commit = commits.get(0);
1626             assertEquals(&quot;duke&quot;, commit.author().name());
1627             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1628             assertEquals(&quot;duke&quot;, commit.committer().name());
1629             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1630             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1631         }
1632     }
1633 
1634     @ParameterizedTest
1635     @EnumSource(VCS.class)
1636     void testAmend(VCS vcs) throws IOException {
1637         try (var dir = new TemporaryDirectory()) {
1638             var r = Repository.init(dir.path(), vcs);
1639             assertTrue(r.isClean());
1640 
1641             var f = dir.path().resolve(&quot;README&quot;);
1642             Files.writeString(f, &quot;Hello\n&quot;);
1643             r.add(f);
1644             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1645 
1646             Files.writeString(f, &quot;Hello, world\n&quot;);
1647             r.add(f);
1648             r.amend(&quot;Initial commit corrected&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1649             var commits = r.commits().asList();
1650             assertEquals(1, commits.size());
1651             var commit = commits.get(0);
1652             assertEquals(List.of(&quot;Initial commit corrected&quot;), commit.message());
1653         }
1654     }
1655 
1656     @ParameterizedTest
1657     @EnumSource(VCS.class)
1658     void testRevert(VCS vcs) throws IOException {
1659         try (var dir = new TemporaryDirectory()) {
1660             var r = Repository.init(dir.path(), vcs);
1661             assertTrue(r.isClean());
1662 
1663             var f = dir.path().resolve(&quot;README&quot;);
1664             Files.writeString(f, &quot;Hello\n&quot;);
1665             r.add(f);
1666             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1667 
1668             Files.writeString(f, &quot;Hello, world\n&quot;);
1669             r.revert(initial);
1670             Files.writeString(f, &quot;Goodbye, world\n&quot;);
1671             r.add(f);
1672             var hash = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1673             var commit = r.lookup(hash).orElseThrow();
1674             var patches = commit.parentDiffs().get(0).patches();
1675             assertEquals(1, patches.size());
1676             var patch = patches.get(0).asTextualPatch();
1677             assertEquals(1, patch.hunks().size());
1678             var hunk = patch.hunks().get(0);
1679             assertEquals(List.of(&quot;Goodbye, world&quot;), hunk.target().lines());
1680         }
1681     }
1682 
1683     @ParameterizedTest
1684     @EnumSource(VCS.class)
1685     void testFiles(VCS vcs) throws IOException {
1686         try (var dir = new TemporaryDirectory()) {
1687             var r = Repository.init(dir.path(), vcs);
1688             assertTrue(r.isClean());
1689 
1690             var f = dir.path().resolve(&quot;README&quot;);
1691             Files.writeString(f, &quot;Hello\n&quot;);
1692             r.add(f);
1693             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1694 
1695             var entries = r.files(initial);
1696             assertEquals(1, entries.size());
1697             var entry = entries.get(0);
1698             assertEquals(Path.of(&quot;README&quot;), entry.path());
1699             assertTrue(entry.type().isRegularNonExecutable());
1700 
1701             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1702             Files.writeString(f2, &quot;Hello\n&quot;);
1703             r.add(f2);
1704             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1705 
1706             entries = r.files(second);
1707             assertEquals(2, entries.size());
1708             assertTrue(entries.stream().allMatch(e -&gt; e.type().isRegularNonExecutable()));
1709             var paths = entries.stream().map(FileEntry::path).collect(Collectors.toSet());
1710             assertTrue(paths.contains(Path.of(&quot;README&quot;)));
1711             assertTrue(paths.contains(Path.of(&quot;CONTRIBUTING&quot;)));
1712 
1713             entries = r.files(second, Path.of(&quot;README&quot;));
1714             assertEquals(1, entries.size());
1715             entry = entries.get(0);
1716             assertEquals(Path.of(&quot;README&quot;), entry.path());
1717             assertTrue(entry.type().isRegularNonExecutable());
1718         }
1719     }
1720 
1721     @ParameterizedTest
1722     @EnumSource(VCS.class)
1723     void testDump(VCS vcs) throws IOException {
1724         try (var dir = new TemporaryDirectory()) {
1725             var r = Repository.init(dir.path(), vcs);
1726             assertTrue(r.isClean());
1727 
1728             var f = dir.path().resolve(&quot;README&quot;);
1729             Files.writeString(f, &quot;Hello\n&quot;);
1730             r.add(f);
1731             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1732 
1733             var readme = r.files(initial).get(0);
1734 
1735             var tmp = Files.createTempFile(&quot;README&quot;, &quot;txt&quot;);
1736             r.dump(readme, tmp);
1737             assertEquals(&quot;Hello\n&quot;, Files.readString(tmp));
1738             Files.delete(tmp);
1739         }
1740     }
1741 
1742     @ParameterizedTest
1743     @EnumSource(VCS.class)
1744     void testStatus(VCS vcs) throws IOException {
1745         try (var dir = new TemporaryDirectory()) {
1746             var r = Repository.init(dir.path(), vcs);
1747             assertTrue(r.isClean());
1748 
1749             var f = dir.path().resolve(&quot;README&quot;);
1750             Files.writeString(f, &quot;Hello\n&quot;);
1751             r.add(f);
1752             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1753 
1754             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1755             Files.writeString(f2, &quot;Goodbye\n&quot;);
1756             r.add(f2);
1757             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1758 
1759             var entries = r.status(initial, second);
1760             assertEquals(1, entries.size());
1761             var entry = entries.get(0);
1762             assertTrue(entry.status().isAdded());
1763             assertTrue(entry.source().path().isEmpty());
1764             assertTrue(entry.source().type().isEmpty());
1765 
1766             assertTrue(entry.target().path().isPresent());
1767             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), entry.target().path().get());
1768             assertTrue(entry.target().type().get().isRegular());
1769         }
1770     }
1771 
1772     @ParameterizedTest
1773     @EnumSource(VCS.class)
1774     void testTrackLineEndings(VCS vcs) throws IOException, InterruptedException {
1775         try (var dir = new TemporaryDirectory()) {
1776             var r = Repository.init(dir.path(), vcs);
1777             if (vcs == VCS.GIT) { // turn of git&#39;s meddling
1778                 int exitCode = new ProcessBuilder()
1779                         .command(&quot;git&quot;, &quot;config&quot;, &quot;--local&quot;, &quot;core.autocrlf&quot;, &quot;false&quot;)
1780                         .directory(dir.path().toFile())
1781                         .start()
1782                         .waitFor();
1783                 assertEquals(0, exitCode);
1784             }
1785 
1786             var readme = dir.path().resolve(&quot;README&quot;);
1787             Files.writeString(readme, &quot;Line with Unix line ending\n&quot;);
1788             Files.writeString(readme, &quot;Line with Windows line ending\r\n&quot;, APPEND);
1789 
1790             r.add(readme);
1791             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1792 
1793             var commits = r.commits().asList();
1794             assertEquals(1, commits.size());
1795 
1796             var commit = commits.get(0);
1797             var diffs = commit.parentDiffs();
1798             var diff = diffs.get(0);
<a name="12" id="anc12"></a><span class="line-modified">1799             assertEquals(2, diff.totalStats().added());</span>
1800 
1801             var patches = diff.patches();
1802             assertEquals(1, patches.size());
1803 
1804             var patch = patches.get(0).asTextualPatch();
1805             var hunks = patch.hunks();
1806             assertEquals(1, hunks.size());
1807 
1808             var hunk = hunks.get(0);
1809             assertEquals(new Range(0, 0), hunk.source().range());
1810             assertEquals(new Range(1, 2), hunk.target().range());
1811 
1812             assertEquals(
1813                     List.of(&quot;Line with Unix line ending&quot;, &quot;Line with Windows line ending\r&quot;),
1814                     hunk.target().lines());
1815         }
1816     }
1817 
1818     @ParameterizedTest
1819     @EnumSource(VCS.class)
1820     void testContains(VCS vcs) throws IOException {
1821         try (var dir = new TemporaryDirectory()) {
1822             var r = Repository.init(dir.path(), vcs);
1823             assertTrue(r.isClean());
1824 
1825             var f = dir.path().resolve(&quot;README&quot;);
1826             Files.writeString(f, &quot;Hello\n&quot;);
1827             r.add(f);
1828             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1829 
1830             assertTrue(r.contains(r.defaultBranch(), initial));
1831 
1832             Files.writeString(f, &quot;Hello again\n&quot;);
1833             r.add(f);
1834             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1835 
1836             assertTrue(r.contains(r.defaultBranch(), initial));
1837         }
1838     }
1839 
1840     @ParameterizedTest
1841     @EnumSource(VCS.class)
1842     void testAbortMerge(VCS vcs) throws IOException {
1843         try (var dir = new TemporaryDirectory()) {
1844             var r = Repository.init(dir.path(), vcs);
1845             assertTrue(r.isClean());
1846 
1847             var f = dir.path().resolve(&quot;README&quot;);
1848             Files.writeString(f, &quot;Hello\n&quot;);
1849             r.add(f);
1850             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1851 
1852             Files.writeString(f, &quot;Hello again\n&quot;);
1853             r.add(f);
1854             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1855 
1856             r.checkout(initial);
1857             Files.writeString(f, &quot;Conflicting hello\n&quot;);
1858             r.add(f);
1859             var third = r.commit(&quot;Third commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1860 
1861             assertThrows(IOException.class, () -&gt; { r.merge(second); });
1862 
1863             r.abortMerge();
1864             assertTrue(r.isClean());
1865         }
1866     }
1867 
1868     @ParameterizedTest
1869     @EnumSource(VCS.class)
1870     void testReset(VCS vcs) throws IOException {
1871         assumeTrue(vcs == VCS.GIT); // FIXME reset is not yet implemented for HG
1872 
1873         try (var dir = new TemporaryDirectory()) {
1874             var repo = Repository.init(dir.path(), vcs);
1875             assertTrue(repo.isClean());
1876 
1877             var f = dir.path().resolve(&quot;README&quot;);
1878             Files.writeString(f, &quot;Hello\n&quot;);
1879             repo.add(f);
1880             var initial = repo.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1881 
1882             Files.writeString(f, &quot;Hello again\n&quot;);
1883             repo.add(f);
1884             var second = repo.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1885 
1886             assertEquals(second, repo.head());
1887             assertEquals(2, repo.commits().asList().size());
1888 
1889             repo.reset(initial, true);
1890 
1891             assertEquals(initial, repo.head());
1892             assertEquals(1, repo.commits().asList().size());
1893         }
1894     }
1895 
1896     @ParameterizedTest
1897     @EnumSource(VCS.class)
1898     void testRemotes(VCS vcs) throws IOException {
1899         try (var dir = new TemporaryDirectory()) {
1900             var repo = Repository.init(dir.path(), vcs);
1901             assertEquals(List.of(), repo.remotes());
1902             repo.addRemote(&quot;foobar&quot;, &quot;https://foo/bar&quot;);
1903             assertEquals(List.of(&quot;foobar&quot;), repo.remotes());
1904         }
1905     }
1906 
1907     @ParameterizedTest
1908     @EnumSource(VCS.class)
1909     void testRemoteBranches(VCS vcs) throws IOException {
1910         try (var dir = new TemporaryDirectory()) {
1911             var upstream = Repository.init(dir.path().resolve(&quot;upstream&quot;), vcs);
1912             var readme = upstream.root().resolve(&quot;README&quot;);
1913             Files.writeString(readme, &quot;Hello\n&quot;);
1914             upstream.add(readme);
1915             var head = upstream.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1916 
1917             var fork = Repository.init(dir.path().resolve(&quot;fork&quot;), vcs);
1918             fork.addRemote(&quot;upstream&quot;, upstream.root().toUri().toString());
1919             var refs = fork.remoteBranches(&quot;upstream&quot;);
1920             assertEquals(1, refs.size());
1921             var ref = refs.get(0);
1922             assertEquals(head, ref.hash());
1923             assertEquals(upstream.defaultBranch().name(), ref.name());
1924         }
1925     }
1926 
1927     @ParameterizedTest
1928     @EnumSource(VCS.class)
1929     void testSubmodulesOnEmptyRepo(VCS vcs) throws IOException {
1930         try (var dir = new TemporaryDirectory()) {
1931             var repo = Repository.init(dir.path(), vcs);
1932             assertEquals(List.of(), repo.submodules());
1933         }
1934     }
1935 
1936     @ParameterizedTest
1937     @EnumSource(VCS.class)
1938     void testSubmodulesOnRepoWithNoSubmodules(VCS vcs) throws IOException {
1939         try (var dir = new TemporaryDirectory()) {
1940             var repo = Repository.init(dir.path().resolve(&quot;repo&quot;), vcs);
1941             var readme = repo.root().resolve(&quot;README&quot;);
1942             Files.writeString(readme, &quot;Hello\n&quot;);
1943             repo.add(readme);
1944             repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1945             assertEquals(List.of(), repo.submodules());
1946         }
1947     }
1948 
1949     @ParameterizedTest
1950     @EnumSource(VCS.class)
1951     void testSubmodulesOnRepoWithSubmodule(VCS vcs) throws IOException {
1952         try (var dir = new TemporaryDirectory()) {
1953             var submodule = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
1954             var readme = submodule.root().resolve(&quot;README&quot;);
1955             Files.writeString(readme, &quot;Hello\n&quot;);
1956             submodule.add(readme);
1957             var head = submodule.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1958 
1959             var repo = Repository.init(dir.path().resolve(&quot;repo&quot;), vcs);
1960             var pullPath = submodule.root().toAbsolutePath().toString();
1961             repo.addSubmodule(pullPath, Path.of(&quot;sub&quot;));
1962             repo.commit(&quot;Added submodule&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1963 
1964             var submodules = repo.submodules();
1965             assertEquals(1, submodules.size());
1966             var module = submodules.get(0);
1967             assertEquals(Path.of(&quot;sub&quot;), module.path());
1968             assertEquals(head, module.hash());
1969             assertEquals(pullPath, module.pullPath());
1970         }
1971     }
1972 
1973     @ParameterizedTest
1974     @EnumSource(VCS.class)
1975     void testAnnotateTag(VCS vcs) throws IOException {
1976         try (var dir = new TemporaryDirectory(false)) {
1977             var repo = Repository.init(dir.path(), vcs);
1978             var readme = repo.root().resolve(&quot;README&quot;);
1979             var now = ZonedDateTime.now();
1980             Files.writeString(readme, &quot;Hello\n&quot;);
1981             repo.add(readme);
1982             var head = repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1983             var tag = repo.tag(head, &quot;1.0&quot;, &quot;Added tag 1.0 for HEAD\n&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1984             var annotated = repo.annotate(tag).get();
1985 
1986             assertEquals(&quot;1.0&quot;, annotated.name());
1987             assertEquals(head, annotated.target());
1988             assertEquals(new Author(&quot;duke&quot;, &quot;duke@openjdk.org&quot;), annotated.author());
1989             assertEquals(now.getYear(), annotated.date().getYear());
1990             assertEquals(now.getMonth(), annotated.date().getMonth());
1991             assertEquals(now.getDayOfYear(), annotated.date().getDayOfYear());
1992             assertEquals(now.getHour(), annotated.date().getHour());
1993             assertEquals(now.getOffset(), annotated.date().getOffset());
1994             assertEquals(&quot;Added tag 1.0 for HEAD\n&quot;, annotated.message());
1995         }
1996     }
1997 
1998     @ParameterizedTest
1999     @EnumSource(VCS.class)
2000     void testAnnotateTagOnMissingTag(VCS vcs) throws IOException {
2001         try (var dir = new TemporaryDirectory()) {
2002             var repo = Repository.init(dir.path(), vcs);
2003             var readme = repo.root().resolve(&quot;README&quot;);
2004             var now = ZonedDateTime.now();
2005             Files.writeString(readme, &quot;Hello\n&quot;);
2006             repo.add(readme);
2007             var head = repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2008 
2009             assertEquals(Optional.empty(), repo.annotate(new Tag(&quot;unknown&quot;)));
2010         }
2011     }
2012 
2013     @ParameterizedTest
2014     @EnumSource(VCS.class)
2015     void testAnnotateTagOnEmptyRepo(VCS vcs) throws IOException {
2016         try (var dir = new TemporaryDirectory()) {
2017             var repo = Repository.init(dir.path(), vcs);
2018             assertEquals(Optional.empty(), repo.annotate(new Tag(&quot;unknown&quot;)));
2019         }
2020     }
2021 
2022     @ParameterizedTest
2023     @EnumSource(VCS.class)
2024     void testDiffWithFileList(VCS vcs) throws IOException {
2025         try (var dir = new TemporaryDirectory()) {
2026             var repo = Repository.init(dir.path(), vcs);
2027             var readme = repo.root().resolve(&quot;README&quot;);
2028             Files.writeString(readme, &quot;Hello\n&quot;);
2029             repo.add(readme);
2030 
2031             var contribute = repo.root().resolve(&quot;CONTRIBUTE&quot;);
2032             Files.writeString(contribute, &quot;1. Make changes\n&quot;);
2033             repo.add(contribute);
2034 
2035             var first = repo.commit(&quot;Added README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2036             Files.writeString(readme, &quot;World\n&quot;, WRITE, APPEND);
2037             Files.writeString(contribute, &quot;2. Run git commit&quot;, WRITE, APPEND);
2038 
2039             var diff = repo.diff(first, List.of(Path.of(&quot;README&quot;)));
<a name="13" id="anc13"></a><span class="line-modified">2040             var diffStats = diff.totalStats();</span>
<span class="line-modified">2041             assertEquals(1, diffStats.added());</span>
<span class="line-modified">2042             assertEquals(0, diffStats.modified());</span>
<span class="line-added">2043             assertEquals(0, diffStats.removed());</span>
2044             var patches = diff.patches();
2045             assertEquals(1, patches.size());
2046             var patch = patches.get(0);
2047             assertTrue(patch.isTextual());
2048             assertTrue(patch.status().isModified());
2049             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
2050             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
2051 
2052             repo.add(readme);
2053             repo.add(contribute);
2054             var second = repo.commit(&quot;Updates to both README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2055 
2056             diff = repo.diff(first, second, List.of(Path.of(&quot;CONTRIBUTE&quot;)));
<a name="14" id="anc14"></a><span class="line-modified">2057             diffStats = diff.totalStats();</span>
<span class="line-modified">2058             assertEquals(1, diffStats.added());</span>
<span class="line-modified">2059             assertEquals(0, diffStats.modified());</span>
<span class="line-added">2060             assertEquals(0, diffStats.removed());</span>
2061             patches = diff.patches();
2062             assertEquals(1, patches.size());
2063             patch = patches.get(0);
2064             assertTrue(patch.isTextual());
2065             assertTrue(patch.status().isModified());
2066             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.source().path().get());
2067             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.target().path().get());
2068 
2069             diff = repo.diff(first, second, List.of(Path.of(&quot;DOES_NOT_EXIST&quot;)));
2070             assertEquals(0, diff.patches().size());
2071         }
2072     }
2073 
2074     @ParameterizedTest
2075     @EnumSource(VCS.class)
2076     void testWritingConfigValue(VCS vcs) throws IOException {
2077         try (var dir = new TemporaryDirectory()) {
2078             var repo = Repository.init(dir.path(), vcs);
2079             assertEquals(List.of(), repo.config(&quot;test.key&quot;));
2080             repo.config(&quot;test&quot;, &quot;key&quot;, &quot;value&quot;);
2081             assertEquals(List.of(&quot;value&quot;), repo.config(&quot;test.key&quot;));
2082         }
2083     }
2084 
2085     @ParameterizedTest
2086     @EnumSource(VCS.class)
2087     void testFetchRemote(VCS vcs) throws IOException {
2088         try (var dir = new TemporaryDirectory()) {
2089             var upstream = Repository.init(dir.path(), vcs);
2090             var readme = dir.path().resolve(&quot;README&quot;);
2091             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2092 
2093             upstream.add(readme);
2094             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2095 
2096             try (var dir2 = new TemporaryDirectory()) {
2097                 var downstream = Repository.init(dir2.path(), vcs);
2098 
2099                  // note: forcing unix path separators for URI
2100                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
2101                 downstream.addRemote(&quot;upstream&quot;, upstreamURI.toString());
2102                 downstream.addRemote(&quot;foobar&quot;, &quot;file:///this/path/does/not/exist&quot;);
2103                 downstream.fetchRemote(&quot;upstream&quot;);
2104             }
2105         }
2106     }
2107 
2108     @ParameterizedTest
2109     @EnumSource(VCS.class)
2110     void testPrune(VCS vcs) throws IOException {
2111         assumeTrue(vcs == VCS.GIT); // FIXME hard to test with hg due to bookmarks and branches
2112         try (var dir = new TemporaryDirectory(false)) {
2113             var upstreamDir = dir.path().resolve(&quot;upstream&quot; + (vcs == VCS.GIT ? &quot;.git&quot; : &quot;.hg&quot;));
2114             var upstream = Repository.init(upstreamDir, vcs);
2115 
2116             Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
2117                         List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
2118                         WRITE, APPEND);
2119 
2120             var readme = upstreamDir.resolve(&quot;README&quot;);
2121             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2122 
2123             upstream.add(readme);
2124             var head = upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2125             var branch = upstream.branch(head, &quot;foo&quot;);
2126             var upstreamBranches = upstream.branches();
2127             assertEquals(2, upstreamBranches.size());
2128             assertTrue(upstreamBranches.contains(branch));
2129 
2130             var upstreamURI = URI.create(&quot;file:///&quot; + upstreamDir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
2131             var downstreamDir = dir.path().resolve(&quot;downstream&quot;);
2132             var downstream = Repository.clone(upstreamURI, downstreamDir);
2133 
2134             // Ensure that &#39;foo&#39; branch is materialized downstream
2135             downstream.checkout(branch);
2136             downstream.checkout(downstream.defaultBranch());
2137 
2138             var remotes = downstream.remotes();
2139             assertEquals(1, remotes.size());
2140             var downstreamBranches = downstream.branches();
2141             assertEquals(2, downstreamBranches.size());
2142             assertEquals(downstreamBranches, upstreamBranches);
2143 
2144             downstream.prune(branch, remotes.get(0));
2145 
2146             downstreamBranches = downstream.branches();
2147             assertEquals(1, downstreamBranches.size());
2148             assertEquals(List.of(downstream.defaultBranch()), downstreamBranches);
2149 
2150             upstreamBranches = upstream.branches();
2151             assertEquals(1, upstreamBranches.size());
2152             assertEquals(List.of(upstream.defaultBranch()), upstreamBranches);
2153         }
2154     }
2155 
2156     @ParameterizedTest
2157     @EnumSource(VCS.class)
2158     void testUnmergedStatus(VCS vcs) throws IOException {
2159         assumeTrue(vcs == VCS.GIT);
2160         try (var dir = new TemporaryDirectory(false)) {
2161             var r = Repository.init(dir.path(), vcs);
2162 
2163             var readme = dir.path().resolve(&quot;README&quot;);
2164             Files.write(readme, List.of(&quot;Hello, world!&quot;));
2165             r.add(readme);
2166             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2167 
2168             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
2169             r.add(readme);
2170             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2171 
2172             r.checkout(first, false);
2173 
2174             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
2175             r.add(readme);
2176             var third = r.commit(&quot;Modified README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2177 
2178             assertThrows(IOException.class, () -&gt; { r.merge(second); });
2179 
2180             var status = r.status();
2181             for (var s : status) {
2182                 System.out.println(s.status() + &quot; &quot; + s.source().path().get());
2183             }
2184             assertEquals(2, status.size());
2185             var statusEntry = status.get(0);
2186             assertTrue(statusEntry.status().isUnmerged());
2187             assertEquals(Path.of(&quot;README&quot;), statusEntry.source().path().get());
2188             assertEquals(Optional.empty(), statusEntry.source().type());
2189             assertEquals(Hash.zero(), statusEntry.source().hash());
2190         }
2191     }
2192 
2193     @ParameterizedTest
2194     @EnumSource(VCS.class)
2195     void testRangeSingle(VCS vcs) throws IOException {
2196         try (var dir = new TemporaryDirectory()) {
2197             var repo = Repository.init(dir.path(), vcs);
2198             var range = repo.range(new Hash(&quot;0123456789&quot;));
2199             if (vcs == VCS.GIT) {
2200                 assertEquals(&quot;0123456789^!&quot;, range);
2201             } else if (vcs == VCS.HG) {
2202                 assertEquals(&quot;0123456789&quot;, range);
2203             } else {
2204                 fail(&quot;Unexpected vcs: &quot; + vcs);
2205             }
2206         }
2207     }
2208 
2209     @ParameterizedTest
2210     @EnumSource(VCS.class)
2211     void testRangeInclusive(VCS vcs) throws IOException {
2212         try (var dir = new TemporaryDirectory()) {
2213             var repo = Repository.init(dir.path(), vcs);
2214             var range = repo.rangeInclusive(new Hash(&quot;01234&quot;), new Hash(&quot;56789&quot;));
2215             if (vcs == VCS.GIT) {
2216                 assertEquals(&quot;01234^..56789&quot;, range);
2217             } else if (vcs == VCS.HG) {
2218                 assertEquals(&quot;01234:56789&quot;, range);
2219             } else {
2220                 fail(&quot;Unexpected vcs: &quot; + vcs);
2221             }
2222         }
2223     }
2224 
2225     @ParameterizedTest
2226     @EnumSource(VCS.class)
2227     void testRangeExclusive(VCS vcs) throws IOException {
2228         try (var dir = new TemporaryDirectory()) {
2229             var repo = Repository.init(dir.path(), vcs);
2230             var range = repo.rangeExclusive(new Hash(&quot;01234&quot;), new Hash(&quot;56789&quot;));
2231             if (vcs == VCS.GIT) {
2232                 assertEquals(&quot;01234..56789&quot;, range);
2233             } else if (vcs == VCS.HG) {
2234                 assertEquals(&quot;01234:56789-01234&quot;, range);
2235             } else {
2236                 fail(&quot;Unexpected vcs: &quot; + vcs);
2237             }
2238         }
2239     }
2240 
2241     @Test
2242     void testHgRepoNestedInGitRepo() throws IOException {
2243         try (var gitDir = new TemporaryDirectory()) {
2244             var gitRepo = Repository.init(gitDir.path(), VCS.GIT);
2245             var gitFile = gitRepo.root().resolve(&quot;git-file.txt&quot;);
2246             Files.write(gitFile, List.of(&quot;Hello, Git!&quot;));
2247             gitRepo.add(gitFile);
2248             var gitHash = gitRepo.commit(&quot;Added git-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2249 
2250             var hgDir = gitRepo.root().resolve(&quot;hg&quot;);
2251             var hgRepo = Repository.init(hgDir, VCS.HG);
2252             var hgFile = hgRepo.root().resolve(&quot;hg-file.txt&quot;);
2253             Files.write(hgFile, List.of(&quot;Hello, Mercurial!&quot;));
2254             hgRepo.add(hgFile);
2255             var hgHash = hgRepo.commit(&quot;Added hg-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2256 
2257             var resolvedHgRepo = Repository.get(hgDir).orElseThrow();
2258             var resolvedHgCommits = resolvedHgRepo.commits().asList();
2259             assertEquals(1, resolvedHgCommits.size());
2260             assertEquals(hgHash, resolvedHgCommits.get(0).hash());
2261 
2262             var resolvedGitRepo = Repository.get(gitDir.path()).orElseThrow();
2263             var resolvedGitCommits = resolvedGitRepo.commits().asList();
2264             assertEquals(1, resolvedGitCommits.size());
2265             assertEquals(gitHash, resolvedGitCommits.get(0).hash());
2266         }
2267     }
2268 
2269     @Test
2270     void testGitRepoNestedInHgRepo() throws IOException {
2271         try (var hgDir = new TemporaryDirectory()) {
2272             var hgRepo = Repository.init(hgDir.path(), VCS.HG);
2273             var hgFile = hgRepo.root().resolve(&quot;hg-file.txt&quot;);
2274             Files.write(hgFile, List.of(&quot;Hello, Mercurial!&quot;));
2275             hgRepo.add(hgFile);
2276             var hgHash = hgRepo.commit(&quot;Added hg-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2277 
2278             var gitDir = hgRepo.root().resolve(&quot;git&quot;);
2279             var gitRepo = Repository.init(gitDir, VCS.GIT);
2280             var gitFile = gitRepo.root().resolve(&quot;git-file.txt&quot;);
2281             Files.write(gitFile, List.of(&quot;Hello, Git!&quot;));
2282             gitRepo.add(gitFile);
2283             var gitHash = gitRepo.commit(&quot;Added git-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2284 
2285             var resolvedHgRepo = Repository.get(hgDir.path()).orElseThrow();
2286             var resolvedHgCommits = resolvedHgRepo.commits().asList();
2287             assertEquals(1, resolvedHgCommits.size());
2288             assertEquals(hgHash, resolvedHgCommits.get(0).hash());
2289 
2290             var resolvedGitRepo = Repository.get(gitDir).orElseThrow();
2291             var resolvedGitCommits = resolvedGitRepo.commits().asList();
2292             assertEquals(1, resolvedGitCommits.size());
2293             assertEquals(gitHash, resolvedGitCommits.get(0).hash());
2294         }
2295     }
2296 
2297     @Test
2298     void testGitAndHgRepoInSameDirectory() throws IOException {
2299         try (var dir = new TemporaryDirectory()) {
2300             var hgRepo = Repository.init(dir.path(), VCS.HG);
2301             var hgFile = hgRepo.root().resolve(&quot;hg-file.txt&quot;);
2302             Files.write(hgFile, List.of(&quot;Hello, Mercurial!&quot;));
2303             hgRepo.add(hgFile);
2304             var hgHash = hgRepo.commit(&quot;Added hg-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2305 
2306             var gitRepo = Repository.init(dir.path(), VCS.GIT);
2307             var gitFile = gitRepo.root().resolve(&quot;git-file.txt&quot;);
2308             Files.write(gitFile, List.of(&quot;Hello, Git!&quot;));
2309             gitRepo.add(gitFile);
2310             var gitHash = gitRepo.commit(&quot;Added git-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2311 
2312             assertThrows(IOException.class, () -&gt; Repository.get(dir.path()));
2313         }
2314     }
2315 
2316     @Test
2317     void testCommitterDate() throws IOException {
2318         try (var dir = new TemporaryDirectory()) {
2319             var repo = Repository.init(dir.path(), VCS.GIT);
2320             var readme = dir.path().resolve(&quot;README&quot;);
2321             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2322 
2323             repo.add(readme);
2324             var authored = ZonedDateTime.parse(&quot;2020-06-15T14:27:13+02:00&quot;);
2325             var committed = authored.plusMinutes(10);
2326             var head = repo.commit(&quot;Add README&quot;,
2327                                    &quot;author&quot;, &quot;author@openjdk.java.net&quot;, authored,
2328                                    &quot;committer&quot;, &quot;committer@openjdk.java.net&quot;, committed);
2329             var commit = repo.lookup(head).orElseThrow();
2330             assertEquals(&quot;author&quot;, commit.author().name());
2331             assertEquals(&quot;author@openjdk.java.net&quot;, commit.author().email());
2332             assertEquals(authored, commit.authored());
2333 
2334             assertEquals(&quot;committer&quot;, commit.committer().name());
2335             assertEquals(&quot;committer@openjdk.java.net&quot;, commit.committer().email());
2336             assertEquals(committed, commit.committed());
2337         }
2338     }
2339 
2340     @Test
2341     void testLightweightTags() throws IOException, InterruptedException {
2342         try (var dir = new TemporaryDirectory()) {
2343             var repo = Repository.init(dir.path(), VCS.GIT);
2344             var readme = dir.path().resolve(&quot;README&quot;);
2345             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2346 
2347             repo.add(readme);
2348             var head = repo.commit(&quot;Add README&quot;, &quot;author&quot;, &quot;author@openjdk.java.net&quot;);
2349 
2350             // We don&#39;t want to expose making lightweight tags via the Repository class,
2351             // so use a ProcessBuilder and invoke git directly here
2352             var pb = new ProcessBuilder(&quot;git&quot;, &quot;tag&quot;, &quot;test-tag&quot;, head.hex());
2353             pb.directory(repo.root().toFile());
2354             assertEquals(0, pb.start().waitFor());
2355 
2356             var tags = repo.tags();
2357             assertEquals(1, tags.size());
2358 
2359             var tag = tags.get(0);
2360             assertEquals(&quot;test-tag&quot;, tag.name());
2361 
2362             // Lightweight tags can&#39;t be annotated
2363             assertEquals(Optional.empty(), repo.annotate(tag));
2364         }
2365     }
2366 
2367     @ParameterizedTest
2368     @EnumSource(VCS.class)
2369     void testMergeCommitWithRenamedP0AndModifiedP1(VCS vcs) throws IOException {
2370         try (var dir = new TemporaryDirectory(false)) {
2371             var r = Repository.init(dir.path(), vcs);
2372 
2373             var readme = dir.path().resolve(&quot;README.old&quot;);
2374             Files.write(readme, List.of(&quot;Hello, world!&quot;));
2375             r.add(readme);
2376             var first = r.commit(&quot;Added README.old&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2377 
2378             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
2379             r.add(readme);
2380             var second = r.commit(&quot;Modified README.old&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2381 
2382             r.checkout(first, false);
2383             r.move(Path.of(&quot;README.old&quot;), Path.of(&quot;README.new&quot;));
2384             var third = r.commit(&quot;Renamed README.old to README.new&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2385 
2386             r.merge(second);
2387             var hash = r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2388             var merge = r.lookup(hash).orElseThrow();
2389 
2390             var diffs = merge.parentDiffs();
2391             assertEquals(2, diffs.size());
2392 
2393             assertEquals(1, diffs.get(0).patches().size());
2394             var p0 = diffs.get(0).patches().get(0);
2395             assertTrue(p0.status().isModified());
2396             assertEquals(Path.of(&quot;README.new&quot;), p0.source().path().get());
2397             assertEquals(Path.of(&quot;README.new&quot;), p0.target().path().get());
2398 
2399             assertEquals(1, diffs.get(1).patches().size());
2400             var p1 = diffs.get(1).patches().get(0);
2401             if (vcs == VCS.GIT) {
2402                 assertTrue(p1.status().isRenamed());
2403             } else if (vcs == VCS.HG) {
2404                 assertTrue(p1.status().isCopied());
2405             } else {
2406                 fail(&quot;Unknown VCS&quot;);
2407             }
2408             assertEquals(Path.of(&quot;README.old&quot;), p1.source().path().get());
2409             assertEquals(Path.of(&quot;README.new&quot;), p1.target().path().get());
2410         }
2411     }
2412 }
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>