<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLRenderQueue.m</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 #ifndef HEADLESS
  27 
  28 #include &lt;stdlib.h&gt;
  29 
  30 #include &quot;sun_java2d_pipe_BufferedOpCodes.h&quot;
  31 
  32 #include &quot;jlong.h&quot;
  33 #include &quot;MTLBlitLoops.h&quot;
  34 #include &quot;MTLBufImgOps.h&quot;
  35 #include &quot;MTLMaskBlit.h&quot;
  36 #include &quot;MTLMaskFill.h&quot;
  37 #include &quot;MTLPaints.h&quot;
  38 #include &quot;MTLRenderQueue.h&quot;
  39 #include &quot;MTLRenderer.h&quot;
  40 #include &quot;MTLTextRenderer.h&quot;
  41 #import &quot;ThreadUtilities.h&quot;
  42 
  43 /**
  44  * References to the &quot;current&quot; context and destination surface.
  45  */
  46 static MTLContext *mtlc = NULL;
  47 static BMTLSDOps *dstOps = NULL;
  48 jint mtlPreviousOp = MTL_OP_INIT;
  49 
  50 
  51 /**
  52  * The following methods are implemented in the windowing system (i.e. GLX
  53  * and WGL) source files.
  54  */
  55 extern void MTLGC_DestroyMTLGraphicsConfig(jlong pConfigInfo);
  56 extern void MTLSD_SwapBuffers(JNIEnv *env, jlong window);
  57 
  58 // TODO : Debug logic added for opcode verification,
  59 // should be removed later.
  60 static char *getOpcodeString(jint opcode) {
  61     static char opName[30];
  62     switch (opcode) {
  63         case sun_java2d_pipe_BufferedOpCodes_DRAW_LINE:
  64             {
  65                 strcpy(opName, &quot;DRAW_LINE&quot;);
  66             }
  67             break;
  68         case sun_java2d_pipe_BufferedOpCodes_DRAW_RECT:
  69             {
  70                 strcpy(opName, &quot;DRAW_RECT&quot;);
  71             }
  72             break;
  73         case sun_java2d_pipe_BufferedOpCodes_DRAW_POLY:
  74             {
  75                 strcpy(opName, &quot;DRAW_POLY&quot;);
  76             }
  77             break;
  78         case sun_java2d_pipe_BufferedOpCodes_DRAW_PIXEL:
  79             {
  80                 strcpy(opName, &quot;DRAW_PIXEL&quot;);
  81             }
  82             break;
  83         case sun_java2d_pipe_BufferedOpCodes_DRAW_SCANLINES:
  84             {
  85                 strcpy(opName, &quot;DRAW_SCANLINES&quot;);
  86             }
  87             break;
  88         case sun_java2d_pipe_BufferedOpCodes_DRAW_PARALLELOGRAM:
  89             {
  90                 strcpy(opName, &quot;DRAW_PARALLELOGRAM&quot;);
  91             }
  92             break;
  93         case sun_java2d_pipe_BufferedOpCodes_DRAW_AAPARALLELOGRAM:
  94             {
  95                 strcpy(opName, &quot;DRAW_AAPARALLELOGRAM&quot;);
  96             }
  97             break;
  98         case sun_java2d_pipe_BufferedOpCodes_FILL_RECT:
  99             {
 100                 strcpy(opName, &quot;FILL_RECT&quot;);
 101             }
 102             break;
 103         case sun_java2d_pipe_BufferedOpCodes_FILL_SPANS:
 104             {
 105                 strcpy(opName, &quot;FILL_SPANS&quot;);
 106             }
 107             break;
 108         case sun_java2d_pipe_BufferedOpCodes_FILL_PARALLELOGRAM:
 109             {
 110                 strcpy(opName, &quot;FILL_PARALLELOGRAM&quot;);
 111             }
 112             break;
 113         case sun_java2d_pipe_BufferedOpCodes_FILL_AAPARALLELOGRAM:
 114             {
 115                 strcpy(opName, &quot;FILL_AAPARALLELOGRAM&quot;);
 116             }
 117             break;
 118         case sun_java2d_pipe_BufferedOpCodes_DRAW_GLYPH_LIST:
 119             {
 120                 strcpy(opName, &quot;DRAW_GLYPH_LIST&quot;);
 121             }
 122             break;
 123         case sun_java2d_pipe_BufferedOpCodes_COPY_AREA:
 124             {
 125                 strcpy(opName, &quot;COPY_AREA&quot;);
 126             }
 127             break;
 128         case sun_java2d_pipe_BufferedOpCodes_BLIT:
 129             {
 130                 strcpy(opName, &quot;BLIT&quot;);
 131             }
 132             break;
 133         case sun_java2d_pipe_BufferedOpCodes_SURFACE_TO_SW_BLIT:
 134             {
 135                 strcpy(opName, &quot;SURFACE_TO_SW_BLIT&quot;);
 136             }
 137             break;
 138         case sun_java2d_pipe_BufferedOpCodes_MASK_FILL:
 139             {
 140                 strcpy(opName, &quot;MASK_FILL&quot;);
 141             }
 142             break;
 143         case sun_java2d_pipe_BufferedOpCodes_MASK_BLIT:
 144             {
 145 
 146                 strcpy(opName, &quot;MASK_BLIT&quot;);
 147             }
 148             break;
 149         case sun_java2d_pipe_BufferedOpCodes_SET_RECT_CLIP:
 150             {
 151                 strcpy(opName, &quot;SET_RECT_CLIP&quot;);
 152             }
 153             break;
 154         case sun_java2d_pipe_BufferedOpCodes_BEGIN_SHAPE_CLIP:
 155             {
 156                 strcpy(opName, &quot;BEGIN_SHAPE_CLIP&quot;);
 157             }
 158             break;
 159         case sun_java2d_pipe_BufferedOpCodes_SET_SHAPE_CLIP_SPANS:
 160             {
 161                 strcpy(opName, &quot;SET_SHAPE_CLIP_SPANS&quot;);
 162             }
 163             break;
 164         case sun_java2d_pipe_BufferedOpCodes_END_SHAPE_CLIP:
 165             {
 166                 strcpy(opName, &quot;END_SHAPE_CLIP&quot;);
 167             }
 168             break;
 169         case sun_java2d_pipe_BufferedOpCodes_RESET_CLIP:
 170             {
 171                 strcpy(opName, &quot;RESET_CLIP&quot;);
 172             }
 173             break;
 174         case sun_java2d_pipe_BufferedOpCodes_SET_ALPHA_COMPOSITE:
 175             {
 176                 strcpy(opName, &quot;SET_ALPHA_COMPOSITE&quot;);
 177             }
 178             break;
 179         case sun_java2d_pipe_BufferedOpCodes_SET_XOR_COMPOSITE:
 180             {
 181                 strcpy(opName, &quot;SET_XOR_COMPOSITE&quot;);
 182             }
 183             break;
 184         case sun_java2d_pipe_BufferedOpCodes_RESET_COMPOSITE:
 185             {
 186                 strcpy(opName, &quot;RESET_COMPOSITE&quot;);
 187             }
 188             break;
 189         case sun_java2d_pipe_BufferedOpCodes_SET_TRANSFORM:
 190             {
 191                 strcpy(opName, &quot;SET_TRANSFORM&quot;);
 192             }
 193             break;
 194         case sun_java2d_pipe_BufferedOpCodes_RESET_TRANSFORM:
 195             {
 196                 strcpy(opName, &quot;RESET_TRANSFORM&quot;);
 197             }
 198             break;
 199         case sun_java2d_pipe_BufferedOpCodes_SET_SURFACES:
 200             {
 201 
 202                 strcpy(opName, &quot;SET_SURFACES&quot;);
 203             }
 204             break;
 205         case sun_java2d_pipe_BufferedOpCodes_SET_SCRATCH_SURFACE:
 206             {
 207                 strcpy(opName, &quot;SET_SCRATCH_SURFACE&quot;);
 208             }
 209             break;
 210         case sun_java2d_pipe_BufferedOpCodes_FLUSH_SURFACE:
 211             {
 212                 strcpy(opName, &quot;FLUSH_SURFACE&quot;);
 213             }
 214             break;
 215         case sun_java2d_pipe_BufferedOpCodes_DISPOSE_SURFACE:
 216             {
 217                 strcpy(opName, &quot;DISPOSE_SURFACE&quot;);
 218             }
 219             break;
 220         case sun_java2d_pipe_BufferedOpCodes_DISPOSE_CONFIG:
 221             {
 222                 strcpy(opName, &quot;DISPOSE_CONFIG&quot;);
 223             }
 224             break;
 225         case sun_java2d_pipe_BufferedOpCodes_INVALIDATE_CONTEXT:
 226             {
 227                 strcpy(opName, &quot;INVALIDATE_CONTEXT&quot;);
 228             }
 229             break;
 230         case sun_java2d_pipe_BufferedOpCodes_SYNC:
 231             {
 232                 strcpy(opName, &quot;SYNC&quot;);
 233 
 234             }
 235             break;
 236         case sun_java2d_pipe_BufferedOpCodes_SWAP_BUFFERS:
 237             {
 238                 strcpy(opName, &quot;SWAP_BUFFERS&quot;);
 239             }
 240             break;
 241         case sun_java2d_pipe_BufferedOpCodes_NOOP:
 242             strcpy(opName, &quot;NOOP&quot;);
 243             break;
 244         case sun_java2d_pipe_BufferedOpCodes_RESET_PAINT:
 245             {
 246                 strcpy(opName, &quot;RESET_PAINT&quot;);
 247             }
 248             break;
 249         case sun_java2d_pipe_BufferedOpCodes_SET_COLOR:
 250             {
 251                 strcpy(opName, &quot;SET_COLOR&quot;);
 252             }
 253             break;
 254         case sun_java2d_pipe_BufferedOpCodes_SET_GRADIENT_PAINT:
 255             {
 256                 strcpy(opName, &quot;SET_GRADIENT_PAINT&quot;);
 257             }
 258             break;
 259         case sun_java2d_pipe_BufferedOpCodes_SET_LINEAR_GRADIENT_PAINT:
 260             {
 261                 strcpy(opName, &quot;SET_LINEAR_GRADIENT_PAINT&quot;);
 262             }
 263             break;
 264         case sun_java2d_pipe_BufferedOpCodes_SET_RADIAL_GRADIENT_PAINT:
 265             {
 266                 strcpy(opName, &quot;SET_RADIAL_GRADIENT_PAINT&quot;);
 267             }
 268             break;
 269         case sun_java2d_pipe_BufferedOpCodes_SET_TEXTURE_PAINT:
 270             {
 271                 strcpy(opName, &quot;SET_TEXTURE_PAINT&quot;);
 272             }
 273             break;
 274         case sun_java2d_pipe_BufferedOpCodes_ENABLE_CONVOLVE_OP:
 275             {
 276                 strcpy(opName, &quot;ENABLE_CONVOLVE_OP&quot;);
 277             }
 278             break;
 279         case sun_java2d_pipe_BufferedOpCodes_DISABLE_CONVOLVE_OP:
 280             {
 281                 strcpy(opName, &quot;DISABLE_CONVOLVE_OP&quot;);
 282             }
 283             break;
 284         case sun_java2d_pipe_BufferedOpCodes_ENABLE_RESCALE_OP:
 285             {
 286                 strcpy(opName, &quot;ENABLE_RESCALE_OP&quot;);
 287             }
 288             break;
 289         case sun_java2d_pipe_BufferedOpCodes_DISABLE_RESCALE_OP:
 290             {
 291                  strcpy(opName, &quot;DISABLE_RESCALE_OP&quot;);
 292             }
 293             break;
 294         case sun_java2d_pipe_BufferedOpCodes_ENABLE_LOOKUP_OP:
 295             {
 296                 strcpy(opName, &quot;ENABLE_LOOKUP_OP&quot;);
 297             }
 298             break;
 299         case sun_java2d_pipe_BufferedOpCodes_DISABLE_LOOKUP_OP:
 300             {
 301                 strcpy(opName, &quot;DISABLE_LOOKUP_OP&quot;);
 302             }
 303             break;
 304         default:
 305             strcpy(opName, &quot;UNKNOWN&quot;);
 306             break;
 307         }
 308     return opName;
 309 }
 310 
 311 void MTLRenderQueue_CheckPreviousOp(jint op) {
 312 
 313     if (mtlPreviousOp == op) {
 314         // The op is the same as last time, so we can return immediately.
 315         return;
 316     }
 317 
 318     J2dTraceLn1(J2D_TRACE_VERBOSE,
 319                 &quot;MTLRenderQueue_CheckPreviousOp: new op=%d&quot;, op);
 320 
 321     if (op == MTL_OP_SET_COLOR) {
 322         return; // SET_COLOR should not cause endEncoder
 323     }
 324 
 325     if (mtlPreviousOp == MTL_OP_INIT) {
 326         mtlPreviousOp = op;
 327         return;
 328     }
 329 
 330     if (mtlc != NULL) {
 331         [mtlc.encoderManager endEncoder];
 332 
 333         if (op == MTL_OP_RESET_PAINT || op == MTL_OP_SYNC) {
 334             MTLCommandBufferWrapper *cbwrapper = [mtlc pullCommandBufferWrapper];
 335             id &lt;MTLCommandBuffer&gt; commandbuf = [cbwrapper getCommandBuffer];
 336             [commandbuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandbuf) {
 337                 [cbwrapper release];
 338             }];
 339             [commandbuf commit];
 340             if (op == MTL_OP_SYNC) {
 341                 [commandbuf waitUntilCompleted];
 342             }
 343         }
 344     }
 345     mtlPreviousOp = op;
 346 }
 347 
 348 JNIEXPORT void JNICALL
 349 Java_sun_java2d_metal_MTLRenderQueue_flushBuffer
 350     (JNIEnv *env, jobject mtlrq,
 351      jlong buf, jint limit)
 352 {
 353     unsigned char *b, *end;
 354 
 355     J2dTraceLn1(J2D_TRACE_INFO,
 356                 &quot;MTLRenderQueue_flushBuffer: limit=%d&quot;, limit);
 357 
 358     b = (unsigned char *)jlong_to_ptr(buf);
 359     if (b == NULL) {
 360         J2dRlsTraceLn(J2D_TRACE_ERROR,
 361             &quot;MTLRenderQueue_flushBuffer: cannot get direct buffer address&quot;);
 362         return;
 363     }
 364 
 365     end = b + limit;
<a name="1" id="anc1"></a><span class="line-modified"> 366 </span>
<span class="line-modified"> 367     jboolean DEBUG_LOG = JNI_FALSE;</span>
<span class="line-modified"> 368     while (b &lt; end) {</span>
<span class="line-modified"> 369         jint opcode = NEXT_INT(b);</span>
<span class="line-modified"> 370 </span>
<span class="line-modified"> 371         if (DEBUG_LOG) {</span>
<span class="line-modified"> 372             J2dTraceLn2(J2D_TRACE_ERROR,</span>
<span class="line-modified"> 373                     &quot;MTLRenderQueue_flushBuffer: opcode_name = %s, rem=%d&quot;,</span>
<span class="line-modified"> 374                     getOpcodeString(opcode), (end-b));</span>
<span class="line-modified"> 375         } else {</span>
<span class="line-modified"> 376             J2dTraceLn2(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 377                     &quot;MTLRenderQueue_flushBuffer: opcode=%d, rem=%d&quot;,</span>
<span class="line-modified"> 378                     opcode, (end-b));</span>
<span class="line-modified"> 379         }</span>
<span class="line-modified"> 380 </span>
<span class="line-modified"> 381         switch (opcode) {</span>
<span class="line-modified"> 382 </span>
<span class="line-modified"> 383         // draw ops</span>
<span class="line-modified"> 384         case sun_java2d_pipe_BufferedOpCodes_DRAW_LINE:</span>
<span class="line-modified"> 385             {</span>
<span class="line-modified"> 386                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 387 </span>
<span class="line-modified"> 388                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 389                     commitEncodedCommands();</span>
<span class="line-modified"> 390                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_LINE in XOR mode - Force commit earlier draw calls before DRAW_LINE.&quot;);</span>








 391                 }
<a name="2" id="anc2"></a><span class="line-modified"> 392                 jint x1 = NEXT_INT(b);</span>
<span class="line-modified"> 393                 jint y1 = NEXT_INT(b);</span>
<span class="line-modified"> 394                 jint x2 = NEXT_INT(b);</span>
<span class="line-modified"> 395                 jint y2 = NEXT_INT(b);</span>
<span class="line-modified"> 396                 MTLRenderer_DrawLine(mtlc, dstOps, x1, y1, x2, y2);</span>
<span class="line-modified"> 397             }</span>
<span class="line-modified"> 398             break;</span>
<span class="line-modified"> 399         case sun_java2d_pipe_BufferedOpCodes_DRAW_RECT:</span>
<span class="line-modified"> 400             {</span>
<span class="line-modified"> 401                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 402 </span>
<span class="line-modified"> 403                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 404                     commitEncodedCommands();</span>
<span class="line-modified"> 405                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_RECT in XOR mode - Force commit earlier draw calls before DRAW_RECT.&quot;);</span>

 406                 }
<a name="3" id="anc3"></a><span class="line-modified"> 407                 jint x = NEXT_INT(b);</span>
<span class="line-modified"> 408                 jint y = NEXT_INT(b);</span>
<span class="line-modified"> 409                 jint w = NEXT_INT(b);</span>
<span class="line-modified"> 410                 jint h = NEXT_INT(b);</span>
<span class="line-modified"> 411                 MTLRenderer_DrawRect(mtlc, dstOps, x, y, w, h);</span>
<span class="line-modified"> 412             }</span>
<span class="line-modified"> 413             break;</span>
<span class="line-modified"> 414         case sun_java2d_pipe_BufferedOpCodes_DRAW_POLY:</span>
<span class="line-modified"> 415             {</span>
<span class="line-modified"> 416                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 417                 jint nPoints      = NEXT_INT(b);</span>
<span class="line-modified"> 418                 jboolean isClosed = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 419                 jint transX       = NEXT_INT(b);</span>
<span class="line-modified"> 420                 jint transY       = NEXT_INT(b);</span>
<span class="line-modified"> 421                 jint *xPoints = (jint *)b;</span>
<span class="line-modified"> 422                 jint *yPoints = ((jint *)b) + nPoints;</span>
<span class="line-modified"> 423 </span>
<span class="line-modified"> 424                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 425                     commitEncodedCommands();</span>
<span class="line-modified"> 426                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_POLY in XOR mode - Force commit earlier draw calls before DRAW_POLY.&quot;);</span>
<span class="line-modified"> 427 </span>
<span class="line-modified"> 428                     // draw separate (N-1) lines using N points</span>
<span class="line-modified"> 429                     for(int point = 0; point &lt; nPoints-1; point++) {</span>
<span class="line-modified"> 430                         jint x1 = xPoints[point] + transX;</span>
<span class="line-modified"> 431                         jint y1 = yPoints[point] + transY;</span>
<span class="line-modified"> 432                         jint x2 = xPoints[point + 1] + transX;</span>
<span class="line-modified"> 433                         jint y2 = yPoints[point + 1] + transY;</span>
<span class="line-modified"> 434                         MTLRenderer_DrawLine(mtlc, dstOps, x1, y1, x2, y2);</span>


 435                     }
 436 
<a name="4" id="anc4"></a><span class="line-modified"> 437                     if (isClosed) {</span>
<span class="line-modified"> 438                         MTLRenderer_DrawLine(mtlc, dstOps, xPoints[0] + transX, yPoints[0] + transY, xPoints[nPoints-1] + transX, yPoints[nPoints-1] + transY);</span>
<span class="line-removed"> 439                     }</span>
<span class="line-removed"> 440                 } else {</span>
<span class="line-removed"> 441                     MTLRenderer_DrawPoly(mtlc, dstOps, nPoints, isClosed, transX, transY, xPoints, yPoints);</span>
 442                 }
<a name="5" id="anc5"></a>








 443 
<a name="6" id="anc6"></a><span class="line-modified"> 444                 SKIP_BYTES(b, nPoints * BYTES_PER_POLY_POINT);</span>
<span class="line-modified"> 445             }</span>
<span class="line-modified"> 446             break;</span>
<span class="line-modified"> 447         case sun_java2d_pipe_BufferedOpCodes_DRAW_PIXEL:</span>
<span class="line-modified"> 448             {</span>
<span class="line-removed"> 449                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 450 </span>
<span class="line-removed"> 451                 if ([mtlc useXORComposite]) {</span>
<span class="line-removed"> 452                     commitEncodedCommands();</span>
<span class="line-removed"> 453                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_PIXEL in XOR mode - Force commit earlier draw calls before DRAW_PIXEL.&quot;);</span>
 454                 }
<a name="7" id="anc7"></a>









 455 
<a name="8" id="anc8"></a><span class="line-modified"> 456                 jint x = NEXT_INT(b);</span>
<span class="line-modified"> 457                 jint y = NEXT_INT(b);</span>
<span class="line-removed"> 458                 CONTINUE_IF_NULL(mtlc);</span>
<span class="line-removed"> 459                 MTLRenderer_DrawPixel(mtlc, dstOps, x, y);</span>
<span class="line-removed"> 460             }</span>
<span class="line-removed"> 461             break;</span>
<span class="line-removed"> 462         case sun_java2d_pipe_BufferedOpCodes_DRAW_SCANLINES:</span>
<span class="line-removed"> 463             {</span>
<span class="line-removed"> 464                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
 465 
<a name="9" id="anc9"></a><span class="line-modified"> 466                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 467                     commitEncodedCommands();</span>
<span class="line-removed"> 468                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_SCANLINES in XOR mode - Force commit earlier draw calls before DRAW_SCANLINES.&quot;);</span>
 469                 }
<a name="10" id="anc10"></a>









 470 
<a name="11" id="anc11"></a><span class="line-modified"> 471                 jint count = NEXT_INT(b);</span>
<span class="line-modified"> 472                 MTLRenderer_DrawScanlines(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-modified"> 473 </span>
<span class="line-modified"> 474                 SKIP_BYTES(b, count * BYTES_PER_SCANLINE);</span>
<span class="line-modified"> 475             }</span>
<span class="line-modified"> 476             break;</span>
<span class="line-modified"> 477         case sun_java2d_pipe_BufferedOpCodes_DRAW_PARALLELOGRAM:</span>
<span class="line-modified"> 478             {</span>
<span class="line-modified"> 479                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 480 </span>
<span class="line-modified"> 481                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 482                     commitEncodedCommands();</span>
<span class="line-modified"> 483                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_PARALLELOGRAM in XOR mode - Force commit earlier draw calls before DRAW_PARALLELOGRAM.&quot;);</span>





















 484                 }
 485 
<a name="12" id="anc12"></a><span class="line-modified"> 486                 jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 487                 jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 488                 jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 489                 jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 490                 jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 491                 jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 492                 jfloat lwr21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 493                 jfloat lwr12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 494 </span>
<span class="line-removed"> 495                 MTLRenderer_DrawParallelogram(mtlc, dstOps,</span>
<span class="line-removed"> 496                                               x11, y11,</span>
<span class="line-removed"> 497                                               dx21, dy21,</span>
<span class="line-removed"> 498                                               dx12, dy12,</span>
<span class="line-removed"> 499                                               lwr21, lwr12);</span>
<span class="line-removed"> 500             }</span>
<span class="line-removed"> 501             break;</span>
<span class="line-removed"> 502         case sun_java2d_pipe_BufferedOpCodes_DRAW_AAPARALLELOGRAM:</span>
<span class="line-removed"> 503             {</span>
<span class="line-removed"> 504                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 505                 jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 506                 jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 507                 jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 508                 jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 509                 jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 510                 jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 511                 jfloat lwr21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 512                 jfloat lwr12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 513 </span>
<span class="line-removed"> 514                 MTLRenderer_DrawAAParallelogram(mtlc, dstOps,</span>
<span class="line-removed"> 515                                                 x11, y11,</span>
<span class="line-removed"> 516                                                 dx21, dy21,</span>
<span class="line-removed"> 517                                                 dx12, dy12,</span>
<span class="line-removed"> 518                                                 lwr21, lwr12);</span>
<span class="line-removed"> 519             }</span>
<span class="line-removed"> 520             break;</span>
 521 
<a name="13" id="anc13"></a><span class="line-modified"> 522         // fill ops</span>
<span class="line-modified"> 523         case sun_java2d_pipe_BufferedOpCodes_FILL_RECT:</span>
<span class="line-modified"> 524             {</span>
<span class="line-modified"> 525                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>

 526 
<a name="14" id="anc14"></a><span class="line-modified"> 527                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 528                     commitEncodedCommands();</span>
<span class="line-modified"> 529                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;FILL_RECT in XOR mode - Force commit earlier draw calls before FILL_RECT.&quot;);</span>



 530                 }
<a name="15" id="anc15"></a>








 531 
<a name="16" id="anc16"></a><span class="line-modified"> 532                 jint x = NEXT_INT(b);</span>
<span class="line-modified"> 533                 jint y = NEXT_INT(b);</span>
<span class="line-modified"> 534                 jint w = NEXT_INT(b);</span>
<span class="line-modified"> 535                 jint h = NEXT_INT(b);</span>
<span class="line-removed"> 536                 MTLRenderer_FillRect(mtlc, dstOps, x, y, w, h);</span>
<span class="line-removed"> 537             }</span>
<span class="line-removed"> 538             break;</span>
<span class="line-removed"> 539         case sun_java2d_pipe_BufferedOpCodes_FILL_SPANS:</span>
<span class="line-removed"> 540             {</span>
<span class="line-removed"> 541                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 542 </span>
<span class="line-removed"> 543                 if ([mtlc useXORComposite]) {</span>
<span class="line-removed"> 544                     commitEncodedCommands();</span>
<span class="line-removed"> 545                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;FILL_SPANS in XOR mode - Force commit earlier draw calls before FILL_SPANS.&quot;);</span>
 546                 }
<a name="17" id="anc17"></a>









 547 
<a name="18" id="anc18"></a><span class="line-modified"> 548                 jint count = NEXT_INT(b);</span>
<span class="line-modified"> 549                 MTLRenderer_FillSpans(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-modified"> 550                 SKIP_BYTES(b, count * BYTES_PER_SPAN);</span>
<span class="line-modified"> 551             }</span>
<span class="line-modified"> 552             break;</span>
<span class="line-modified"> 553         case sun_java2d_pipe_BufferedOpCodes_FILL_PARALLELOGRAM:</span>
<span class="line-modified"> 554             {</span>
<span class="line-modified"> 555                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 556 </span>
<span class="line-modified"> 557                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 558                     commitEncodedCommands();</span>
<span class="line-modified"> 559                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;FILL_PARALLELOGRAM in XOR mode - Force commit earlier draw calls before FILL_PARALLELOGRAM.&quot;);</span>














 560                 }
 561 
<a name="19" id="anc19"></a><span class="line-modified"> 562                 jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 563                 jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 564                 jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 565                 jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 566                 jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 567                 jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 568                 MTLRenderer_FillParallelogram(mtlc, dstOps,</span>
<span class="line-removed"> 569                                               x11, y11,</span>
<span class="line-removed"> 570                                               dx21, dy21,</span>
<span class="line-removed"> 571                                               dx12, dy12);</span>
<span class="line-removed"> 572             }</span>
<span class="line-removed"> 573             break;</span>
<span class="line-removed"> 574         case sun_java2d_pipe_BufferedOpCodes_FILL_AAPARALLELOGRAM:</span>
<span class="line-removed"> 575             {</span>
<span class="line-removed"> 576                 CHECK_PREVIOUS_OP(MTL_OP_AA);</span>
<span class="line-removed"> 577                 jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 578                 jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 579                 jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 580                 jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 581                 jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 582                 jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 583                 MTLRenderer_FillAAParallelogram(mtlc, dstOps,</span>
<span class="line-removed"> 584                                                 x11, y11,</span>
<span class="line-removed"> 585                                                 dx21, dy21,</span>
<span class="line-removed"> 586                                                 dx12, dy12);</span>
<span class="line-removed"> 587             }</span>
<span class="line-removed"> 588             break;</span>
 589 
<a name="20" id="anc20"></a><span class="line-modified"> 590         // text-related ops</span>
<span class="line-modified"> 591         case sun_java2d_pipe_BufferedOpCodes_DRAW_GLYPH_LIST:</span>
<span class="line-modified"> 592             {</span>
<span class="line-modified"> 593                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>


 594 
<a name="21" id="anc21"></a><span class="line-modified"> 595                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 596                     commitEncodedCommands();</span>
<span class="line-modified"> 597                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_GLYPH_LIST in XOR mode - Force commit earlier draw calls before DRAW_GLYPH_LIST.&quot;);</span>


























 598                 }
 599 
<a name="22" id="anc22"></a><span class="line-modified"> 600                 jint numGlyphs        = NEXT_INT(b);</span>
<span class="line-modified"> 601                 jint packedParams     = NEXT_INT(b);</span>
<span class="line-modified"> 602                 jfloat glyphListOrigX = NEXT_FLOAT(b);</span>
<span class="line-modified"> 603                 jfloat glyphListOrigY = NEXT_FLOAT(b);</span>
<span class="line-modified"> 604                 jboolean usePositions = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 605                                                         OFFSET_POSITIONS);</span>
<span class="line-modified"> 606                 jboolean subPixPos    = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 607                                                         OFFSET_SUBPIXPOS);</span>
<span class="line-modified"> 608                 jboolean rgbOrder     = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 609                                                         OFFSET_RGBORDER);</span>
<span class="line-modified"> 610                 jint lcdContrast      = EXTRACT_BYTE(packedParams,</span>
<span class="line-modified"> 611                                                      OFFSET_CONTRAST);</span>
<span class="line-modified"> 612                 unsigned char *images = b;</span>
<span class="line-removed"> 613                 unsigned char *positions;</span>
<span class="line-removed"> 614                 jint bytesPerGlyph;</span>
<span class="line-removed"> 615                 if (usePositions) {</span>
<span class="line-removed"> 616                     positions = (b + numGlyphs * BYTES_PER_GLYPH_IMAGE);</span>
<span class="line-removed"> 617                     bytesPerGlyph = BYTES_PER_POSITIONED_GLYPH;</span>
<span class="line-removed"> 618                 } else {</span>
<span class="line-removed"> 619                     positions = NULL;</span>
<span class="line-removed"> 620                     bytesPerGlyph = BYTES_PER_GLYPH_IMAGE;</span>
 621                 }
<a name="23" id="anc23"></a><span class="line-modified"> 622                 MTLTR_DrawGlyphList(env, mtlc, dstOps,</span>
<span class="line-modified"> 623                                     numGlyphs, usePositions,</span>
<span class="line-modified"> 624                                     subPixPos, rgbOrder, lcdContrast,</span>
<span class="line-modified"> 625                                     glyphListOrigX, glyphListOrigY,</span>
<span class="line-modified"> 626                                     images, positions);</span>
<span class="line-modified"> 627                 SKIP_BYTES(b, numGlyphs * bytesPerGlyph);</span>
<span class="line-modified"> 628             }</span>
<span class="line-modified"> 629             break;</span>
<span class="line-modified"> 630 </span>
<span class="line-modified"> 631         // copy-related ops</span>
<span class="line-modified"> 632         case sun_java2d_pipe_BufferedOpCodes_COPY_AREA:</span>
<span class="line-modified"> 633             {</span>
<span class="line-modified"> 634                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 635                 jint x  = NEXT_INT(b);</span>
<span class="line-modified"> 636                 jint y  = NEXT_INT(b);</span>
<span class="line-modified"> 637                 jint w  = NEXT_INT(b);</span>
<span class="line-modified"> 638                 jint h  = NEXT_INT(b);</span>
<span class="line-modified"> 639                 jint dx = NEXT_INT(b);</span>
<span class="line-modified"> 640                 jint dy = NEXT_INT(b);</span>
<span class="line-modified"> 641                 MTLBlitLoops_CopyArea(env, mtlc, dstOps,</span>
<span class="line-modified"> 642                                       x, y, w, h, dx, dy);</span>
<span class="line-modified"> 643             }</span>
<span class="line-modified"> 644             break;</span>
<span class="line-modified"> 645         case sun_java2d_pipe_BufferedOpCodes_BLIT:</span>
<span class="line-modified"> 646             {</span>
<span class="line-modified"> 647                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 648                 jint packedParams = NEXT_INT(b);</span>
<span class="line-modified"> 649                 jint sx1          = NEXT_INT(b);</span>
<span class="line-modified"> 650                 jint sy1          = NEXT_INT(b);</span>
<span class="line-modified"> 651                 jint sx2          = NEXT_INT(b);</span>
<span class="line-modified"> 652                 jint sy2          = NEXT_INT(b);</span>
<span class="line-modified"> 653                 jdouble dx1       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 654                 jdouble dy1       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 655                 jdouble dx2       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 656                 jdouble dy2       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 657                 jlong pSrc        = NEXT_LONG(b);</span>
<span class="line-modified"> 658                 jlong pDst        = NEXT_LONG(b);</span>
<span class="line-modified"> 659                 jint hint         = EXTRACT_BYTE(packedParams, OFFSET_HINT);</span>
<span class="line-modified"> 660                 jboolean texture  = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 661                                                     OFFSET_TEXTURE);</span>
<span class="line-modified"> 662                 jboolean xform    = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 663                                                     OFFSET_XFORM);</span>
<span class="line-modified"> 664                 jboolean isoblit  = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 665                                                     OFFSET_ISOBLIT);</span>
<span class="line-modified"> 666                 if (isoblit) {</span>
<span class="line-modified"> 667                     MTLBlitLoops_IsoBlit(env, mtlc, pSrc, pDst,</span>
<span class="line-modified"> 668                                          xform, hint, texture,</span>
<span class="line-modified"> 669                                          sx1, sy1, sx2, sy2,</span>
<span class="line-modified"> 670                                          dx1, dy1, dx2, dy2);</span>
<span class="line-modified"> 671                 } else {</span>
<span class="line-modified"> 672                     jint srctype = EXTRACT_BYTE(packedParams, OFFSET_SRCTYPE);</span>
<span class="line-modified"> 673                     MTLBlitLoops_Blit(env, mtlc, pSrc, pDst,</span>
<span class="line-modified"> 674                                       xform, hint, srctype, texture,</span>
<span class="line-modified"> 675                                       sx1, sy1, sx2, sy2,</span>
<span class="line-modified"> 676                                       dx1, dy1, dx2, dy2);</span>

























 677                 }
<a name="24" id="anc24"></a><span class="line-removed"> 678             }</span>
<span class="line-removed"> 679             break;</span>
<span class="line-removed"> 680         case sun_java2d_pipe_BufferedOpCodes_SURFACE_TO_SW_BLIT:</span>
<span class="line-removed"> 681             {</span>
<span class="line-removed"> 682                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 683                 jint sx      = NEXT_INT(b);</span>
<span class="line-removed"> 684                 jint sy      = NEXT_INT(b);</span>
<span class="line-removed"> 685                 jint dx      = NEXT_INT(b);</span>
<span class="line-removed"> 686                 jint dy      = NEXT_INT(b);</span>
<span class="line-removed"> 687                 jint w       = NEXT_INT(b);</span>
<span class="line-removed"> 688                 jint h       = NEXT_INT(b);</span>
<span class="line-removed"> 689                 jint dsttype = NEXT_INT(b);</span>
<span class="line-removed"> 690                 jlong pSrc   = NEXT_LONG(b);</span>
<span class="line-removed"> 691                 jlong pDst   = NEXT_LONG(b);</span>
<span class="line-removed"> 692                 MTLBlitLoops_SurfaceToSwBlit(env, mtlc,</span>
<span class="line-removed"> 693                                              pSrc, pDst, dsttype,</span>
<span class="line-removed"> 694                                              sx, sy, dx, dy, w, h);</span>
<span class="line-removed"> 695             }</span>
<span class="line-removed"> 696             break;</span>
<span class="line-removed"> 697         case sun_java2d_pipe_BufferedOpCodes_MASK_FILL:</span>
<span class="line-removed"> 698             {</span>
<span class="line-removed"> 699                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 700                 jint x        = NEXT_INT(b);</span>
<span class="line-removed"> 701                 jint y        = NEXT_INT(b);</span>
<span class="line-removed"> 702                 jint w        = NEXT_INT(b);</span>
<span class="line-removed"> 703                 jint h        = NEXT_INT(b);</span>
<span class="line-removed"> 704                 jint maskoff  = NEXT_INT(b);</span>
<span class="line-removed"> 705                 jint maskscan = NEXT_INT(b);</span>
<span class="line-removed"> 706                 jint masklen  = NEXT_INT(b);</span>
<span class="line-removed"> 707                 unsigned char *pMask = (masklen &gt; 0) ? b : NULL;</span>
<span class="line-removed"> 708                 MTLMaskFill_MaskFill(mtlc, dstOps, x, y, w, h,</span>
<span class="line-removed"> 709                                      maskoff, maskscan, masklen, pMask);</span>
<span class="line-removed"> 710                 SKIP_BYTES(b, masklen);</span>
<span class="line-removed"> 711             }</span>
<span class="line-removed"> 712             break;</span>
<span class="line-removed"> 713         case sun_java2d_pipe_BufferedOpCodes_MASK_BLIT:</span>
<span class="line-removed"> 714             {</span>
<span class="line-removed"> 715                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 716                 jint dstx     = NEXT_INT(b);</span>
<span class="line-removed"> 717                 jint dsty     = NEXT_INT(b);</span>
<span class="line-removed"> 718                 jint width    = NEXT_INT(b);</span>
<span class="line-removed"> 719                 jint height   = NEXT_INT(b);</span>
<span class="line-removed"> 720                 jint masklen  = width * height * sizeof(jint);</span>
<span class="line-removed"> 721                 MTLMaskBlit_MaskBlit(env, mtlc, dstOps,</span>
<span class="line-removed"> 722                                      dstx, dsty, width, height, b);</span>
<span class="line-removed"> 723                 SKIP_BYTES(b, masklen);</span>
<span class="line-removed"> 724             }</span>
<span class="line-removed"> 725             break;</span>
<span class="line-removed"> 726 </span>
<span class="line-removed"> 727         // state-related ops</span>
<span class="line-removed"> 728         case sun_java2d_pipe_BufferedOpCodes_SET_RECT_CLIP:</span>
<span class="line-removed"> 729             {</span>
<span class="line-removed"> 730                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 731                 jint x1 = NEXT_INT(b);</span>
<span class="line-removed"> 732                 jint y1 = NEXT_INT(b);</span>
<span class="line-removed"> 733                 jint x2 = NEXT_INT(b);</span>
<span class="line-removed"> 734                 jint y2 = NEXT_INT(b);</span>
<span class="line-removed"> 735                 [mtlc setClipRectX1:x1 Y1:y1 X2:x2 Y2:y2];</span>
<span class="line-removed"> 736             }</span>
<span class="line-removed"> 737             break;</span>
<span class="line-removed"> 738         case sun_java2d_pipe_BufferedOpCodes_BEGIN_SHAPE_CLIP:</span>
<span class="line-removed"> 739             {</span>
<span class="line-removed"> 740                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 741                 [mtlc beginShapeClip:dstOps];</span>
<span class="line-removed"> 742             }</span>
<span class="line-removed"> 743             break;</span>
<span class="line-removed"> 744         case sun_java2d_pipe_BufferedOpCodes_SET_SHAPE_CLIP_SPANS:</span>
<span class="line-removed"> 745             {</span>
<span class="line-removed"> 746                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 747                 // This results in creation of new render encoder with</span>
<span class="line-removed"> 748                 // stencil buffer set as render target</span>
<span class="line-removed"> 749                 jint count = NEXT_INT(b);</span>
<span class="line-removed"> 750                 MTLRenderer_FillSpans(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-removed"> 751                 SKIP_BYTES(b, count * BYTES_PER_SPAN);</span>
<span class="line-removed"> 752             }</span>
<span class="line-removed"> 753             break;</span>
<span class="line-removed"> 754         case sun_java2d_pipe_BufferedOpCodes_END_SHAPE_CLIP:</span>
<span class="line-removed"> 755             {</span>
<span class="line-removed"> 756                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 757                 [mtlc endShapeClip:dstOps];</span>
<span class="line-removed"> 758             }</span>
<span class="line-removed"> 759             break;</span>
<span class="line-removed"> 760         case sun_java2d_pipe_BufferedOpCodes_RESET_CLIP:</span>
<span class="line-removed"> 761             {</span>
<span class="line-removed"> 762                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 763                 [mtlc resetClip];</span>
<span class="line-removed"> 764             }</span>
<span class="line-removed"> 765             break;</span>
<span class="line-removed"> 766         case sun_java2d_pipe_BufferedOpCodes_SET_ALPHA_COMPOSITE:</span>
<span class="line-removed"> 767             {</span>
<span class="line-removed"> 768                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 769                 jint rule         = NEXT_INT(b);</span>
<span class="line-removed"> 770                 jfloat extraAlpha = NEXT_FLOAT(b);</span>
<span class="line-removed"> 771                 jint flags        = NEXT_INT(b);</span>
<span class="line-removed"> 772                 [mtlc setAlphaCompositeRule:rule extraAlpha:extraAlpha flags:flags];</span>
<span class="line-removed"> 773             }</span>
<span class="line-removed"> 774             break;</span>
<span class="line-removed"> 775         case sun_java2d_pipe_BufferedOpCodes_SET_XOR_COMPOSITE:</span>
<span class="line-removed"> 776             {</span>
<span class="line-removed"> 777                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 778                 jint xorPixel = NEXT_INT(b);</span>
<span class="line-removed"> 779                 [mtlc setXorComposite:xorPixel];</span>
<span class="line-removed"> 780             }</span>
<span class="line-removed"> 781             break;</span>
<span class="line-removed"> 782         case sun_java2d_pipe_BufferedOpCodes_RESET_COMPOSITE:</span>
<span class="line-removed"> 783             {</span>
<span class="line-removed"> 784                 /* TODO: check whether something needs to be done here if we are moving out of XOR composite</span>
<span class="line-removed"> 785                 commitEncodedCommands();</span>
<span class="line-removed"> 786                 MTLCommandBufferWrapper * cbwrapper = [mtlc pullCommandBufferWrapper];</span>
<span class="line-removed"> 787                 [cbwrapper onComplete];</span>
 788 
<a name="25" id="anc25"></a><span class="line-modified"> 789                 J2dTraceLn(J2D_TRACE_VERBOSE, &quot;RESET_COMPOSITE - Force commit earlier draw calls before RESET_COMPOSITE.&quot;);*/</span>




























































 790 
<a name="26" id="anc26"></a><span class="line-modified"> 791                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 792                 [mtlc resetComposite];</span>
<span class="line-removed"> 793             }</span>
<span class="line-removed"> 794             break;</span>
<span class="line-removed"> 795         case sun_java2d_pipe_BufferedOpCodes_SET_TRANSFORM:</span>
<span class="line-removed"> 796             {</span>
<span class="line-removed"> 797                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 798                 jdouble m00 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 799                 jdouble m10 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 800                 jdouble m01 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 801                 jdouble m11 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 802                 jdouble m02 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 803                 jdouble m12 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 804                 [mtlc setTransformM00:m00 M10:m10 M01:m01 M11:m11 M02:m02 M12:m12];</span>
<span class="line-removed"> 805             }</span>
<span class="line-removed"> 806             break;</span>
<span class="line-removed"> 807         case sun_java2d_pipe_BufferedOpCodes_RESET_TRANSFORM:</span>
<span class="line-removed"> 808             {</span>
<span class="line-removed"> 809                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 810                 [mtlc resetTransform];</span>
<span class="line-removed"> 811             }</span>
<span class="line-removed"> 812             break;</span>
 813 
<a name="27" id="anc27"></a><span class="line-modified"> 814         // context-related ops</span>
<span class="line-modified"> 815         case sun_java2d_pipe_BufferedOpCodes_SET_SURFACES:</span>
<span class="line-modified"> 816             {</span>
<span class="line-modified"> 817                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 818                 jlong pSrc = NEXT_LONG(b);</span>
<span class="line-modified"> 819                 jlong pDst = NEXT_LONG(b);</span>
















 820 
<a name="28" id="anc28"></a><span class="line-modified"> 821                 dstOps = (BMTLSDOps *)jlong_to_ptr(pDst);</span>
<span class="line-modified"> 822                 mtlc = [MTLContext setSurfacesEnv:env src:pSrc dst:pDst];</span>
<span class="line-modified"> 823             }</span>
<span class="line-modified"> 824             break;</span>
<span class="line-modified"> 825         case sun_java2d_pipe_BufferedOpCodes_SET_SCRATCH_SURFACE:</span>
<span class="line-modified"> 826             {</span>
<span class="line-removed"> 827                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 828                 jlong pConfigInfo = NEXT_LONG(b);</span>
<span class="line-removed"> 829                 MTLGraphicsConfigInfo *mtlInfo =</span>
<span class="line-removed"> 830                         (MTLGraphicsConfigInfo *)jlong_to_ptr(pConfigInfo);</span>
 831 
<a name="29" id="anc29"></a><span class="line-modified"> 832                 if (mtlInfo == NULL) {</span>









 833 
<a name="30" id="anc30"></a><span class="line-modified"> 834                 } else {</span>
<span class="line-removed"> 835                     MTLContext *newMtlc = mtlInfo-&gt;context;</span>
<span class="line-removed"> 836                     if (newMtlc == NULL) {</span>
 837 
 838                     } else {
<a name="31" id="anc31"></a><span class="line-modified"> 839                         mtlc = newMtlc;</span>
<span class="line-modified"> 840                         dstOps = NULL;</span>





 841                     }
<a name="32" id="anc32"></a>
 842                 }
<a name="33" id="anc33"></a><span class="line-modified"> 843             }</span>
<span class="line-modified"> 844             break;</span>
<span class="line-modified"> 845         case sun_java2d_pipe_BufferedOpCodes_FLUSH_SURFACE:</span>
<span class="line-modified"> 846             {</span>
<span class="line-modified"> 847                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 848                 jlong pData = NEXT_LONG(b);</span>
<span class="line-modified"> 849                 BMTLSDOps *mtlsdo = (BMTLSDOps *)jlong_to_ptr(pData);</span>
<span class="line-modified"> 850                 if (mtlsdo != NULL) {</span>
<span class="line-modified"> 851                     CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 852                     MTLSD_Delete(env, mtlsdo);</span>
 853                 }
<a name="34" id="anc34"></a><span class="line-modified"> 854             }</span>
<span class="line-modified"> 855             break;</span>
<span class="line-modified"> 856         case sun_java2d_pipe_BufferedOpCodes_DISPOSE_SURFACE:</span>
<span class="line-modified"> 857             {</span>
<span class="line-modified"> 858                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 859                 jlong pData = NEXT_LONG(b);</span>
<span class="line-modified"> 860                 BMTLSDOps *mtlsdo = (BMTLSDOps *)jlong_to_ptr(pData);</span>
<span class="line-modified"> 861                 if (mtlsdo != NULL) {</span>
<span class="line-modified"> 862                     CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 863                     MTLSD_Delete(env, mtlsdo);</span>
<span class="line-modified"> 864                     if (mtlsdo-&gt;privOps != NULL) {</span>
<span class="line-removed"> 865                         free(mtlsdo-&gt;privOps);</span>
 866                     }
<a name="35" id="anc35"></a>




























 867                 }
<a name="36" id="anc36"></a><span class="line-removed"> 868             }</span>
<span class="line-removed"> 869             break;</span>
<span class="line-removed"> 870         case sun_java2d_pipe_BufferedOpCodes_DISPOSE_CONFIG:</span>
<span class="line-removed"> 871             {</span>
<span class="line-removed"> 872                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 873                 jlong pConfigInfo = NEXT_LONG(b);</span>
<span class="line-removed"> 874                 CONTINUE_IF_NULL(mtlc);</span>
<span class="line-removed"> 875                 MTLGC_DestroyMTLGraphicsConfig(pConfigInfo);</span>
<span class="line-removed"> 876 </span>
<span class="line-removed"> 877                 // the previous method will call glX/wglMakeCurrent(None),</span>
<span class="line-removed"> 878                 // so we should nullify the current mtlc and dstOps to avoid</span>
<span class="line-removed"> 879                 // calling glFlush() (or similar) while no context is current</span>
<span class="line-removed"> 880                 mtlc = NULL;</span>
<span class="line-removed"> 881              //   dstOps = NULL;</span>
<span class="line-removed"> 882             }</span>
<span class="line-removed"> 883             break;</span>
<span class="line-removed"> 884         case sun_java2d_pipe_BufferedOpCodes_INVALIDATE_CONTEXT:</span>
<span class="line-removed"> 885             {</span>
<span class="line-removed"> 886                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 887                 // invalidate the references to the current context and</span>
<span class="line-removed"> 888                 // destination surface that are maintained at the native level</span>
<span class="line-removed"> 889                 mtlc = NULL;</span>
<span class="line-removed"> 890             //    dstOps = NULL;</span>
<span class="line-removed"> 891             }</span>
<span class="line-removed"> 892             break;</span>
<span class="line-removed"> 893         case sun_java2d_pipe_BufferedOpCodes_SYNC:</span>
<span class="line-removed"> 894             {</span>
<span class="line-removed"> 895                 CHECK_PREVIOUS_OP(MTL_OP_SYNC);</span>
<span class="line-removed"> 896             }</span>
<span class="line-removed"> 897             break;</span>
 898 
<a name="37" id="anc37"></a><span class="line-modified"> 899         // multibuffering ops</span>
<span class="line-modified"> 900         case sun_java2d_pipe_BufferedOpCodes_SWAP_BUFFERS:</span>
<span class="line-modified"> 901             {</span>
<span class="line-modified"> 902                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 903                 jlong window = NEXT_LONG(b);</span>
<span class="line-modified"> 904                 MTLSD_SwapBuffers(env, window);</span>
<span class="line-modified"> 905             }</span>
<span class="line-modified"> 906             break;</span>
 907 
<a name="38" id="anc38"></a><span class="line-modified"> 908         // special no-op (mainly used for achieving 8-byte alignment)</span>
<span class="line-modified"> 909         case sun_java2d_pipe_BufferedOpCodes_NOOP:</span>
<span class="line-modified"> 910             break;</span>
 911 
<a name="39" id="anc39"></a><span class="line-modified"> 912         // paint-related ops</span>
<span class="line-modified"> 913         case sun_java2d_pipe_BufferedOpCodes_RESET_PAINT:</span>
<span class="line-modified"> 914             {</span>
<span class="line-modified"> 915               CHECK_PREVIOUS_OP(MTL_OP_RESET_PAINT);</span>
<span class="line-modified"> 916               [mtlc resetPaint];</span>
<span class="line-modified"> 917             }</span>
<span class="line-modified"> 918             break;</span>
<span class="line-modified"> 919         case sun_java2d_pipe_BufferedOpCodes_SET_COLOR:</span>
<span class="line-modified"> 920             {</span>
<span class="line-modified"> 921                 CHECK_PREVIOUS_OP(MTL_OP_SET_COLOR);</span>
<span class="line-modified"> 922                 jint pixel = NEXT_INT(b);</span>
<span class="line-modified"> 923                 [mtlc setColorPaint:pixel];</span>
<span class="line-modified"> 924             }</span>
<span class="line-modified"> 925             break;</span>
<span class="line-modified"> 926         case sun_java2d_pipe_BufferedOpCodes_SET_GRADIENT_PAINT:</span>
<span class="line-modified"> 927             {</span>
<span class="line-modified"> 928                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 929                 jboolean useMask= NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 930                 jboolean cyclic = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 931                 jdouble p0      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 932                 jdouble p1      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 933                 jdouble p3      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 934                 jint pixel1     = NEXT_INT(b);</span>
<span class="line-modified"> 935                 jint pixel2     = NEXT_INT(b);</span>
<span class="line-modified"> 936                 [mtlc setGradientPaintUseMask:useMask</span>
<span class="line-modified"> 937                                     cyclic:cyclic</span>
<span class="line-modified"> 938                                         p0:p0</span>
<span class="line-modified"> 939                                         p1:p1</span>
<span class="line-modified"> 940                                         p3:p3</span>
<span class="line-modified"> 941                                     pixel1:pixel1</span>
<span class="line-modified"> 942                                     pixel2:pixel2];</span>
<span class="line-modified"> 943             }</span>
<span class="line-modified"> 944             break;</span>
<span class="line-modified"> 945         case sun_java2d_pipe_BufferedOpCodes_SET_LINEAR_GRADIENT_PAINT:</span>
<span class="line-modified"> 946             {</span>
<span class="line-modified"> 947                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 948                 jboolean useMask = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 949                 jboolean linear  = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 950                 jint cycleMethod = NEXT_INT(b);</span>
<span class="line-modified"> 951                 jint numStops    = NEXT_INT(b);</span>
<span class="line-modified"> 952                 jfloat p0        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 953                 jfloat p1        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 954                 jfloat p3        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 955                 void *fractions, *pixels;</span>
<span class="line-modified"> 956                 fractions = b; SKIP_BYTES(b, numStops * sizeof(jfloat));</span>
<span class="line-modified"> 957                 pixels    = b; SKIP_BYTES(b, numStops * sizeof(jint));</span>
<span class="line-modified"> 958                 [mtlc setLinearGradientPaint:useMask</span>
<span class="line-modified"> 959                                       linear:linear</span>
<span class="line-modified"> 960                                  cycleMethod:cycleMethod</span>
<span class="line-modified"> 961                                     numStops:numStops</span>
<span class="line-modified"> 962                                           p0:p0</span>
<span class="line-modified"> 963                                           p1:p1</span>
<span class="line-modified"> 964                                           p3:p3</span>
<span class="line-modified"> 965                                    fractions:fractions</span>
<span class="line-modified"> 966                                       pixels:pixels];</span>
<span class="line-modified"> 967             }</span>
<span class="line-modified"> 968             break;</span>
<span class="line-modified"> 969         case sun_java2d_pipe_BufferedOpCodes_SET_RADIAL_GRADIENT_PAINT:</span>
<span class="line-modified"> 970             {</span>
<span class="line-modified"> 971                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 972                 jboolean useMask = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 973                 jboolean linear  = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 974                 jint numStops    = NEXT_INT(b);</span>
<span class="line-modified"> 975                 jint cycleMethod = NEXT_INT(b);</span>
<span class="line-modified"> 976                 jfloat m00       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 977                 jfloat m01       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 978                 jfloat m02       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 979                 jfloat m10       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 980                 jfloat m11       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 981                 jfloat m12       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 982                 jfloat focusX    = NEXT_FLOAT(b);</span>
<span class="line-modified"> 983                 void *fractions, *pixels;</span>
<span class="line-modified"> 984                 fractions = b; SKIP_BYTES(b, numStops * sizeof(jfloat));</span>
<span class="line-modified"> 985                 pixels    = b; SKIP_BYTES(b, numStops * sizeof(jint));</span>
<span class="line-modified"> 986                 [mtlc setRadialGradientPaint:useMask</span>
<span class="line-modified"> 987                                       linear:linear</span>
<span class="line-modified"> 988                                  cycleMethod:cycleMethod</span>
<span class="line-modified"> 989                                     numStops:numStops</span>
<span class="line-modified"> 990                                          m00:m00</span>
<span class="line-modified"> 991                                          m01:m01</span>
<span class="line-modified"> 992                                          m02:m02</span>
<span class="line-modified"> 993                                          m10:m10</span>
<span class="line-modified"> 994                                          m11:m11</span>
<span class="line-modified"> 995                                          m12:m12</span>
<span class="line-modified"> 996                                       focusX:focusX</span>
<span class="line-modified"> 997                                    fractions:fractions</span>
<span class="line-modified"> 998                                       pixels:pixels];</span>
<span class="line-modified"> 999             }</span>
<span class="line-modified">1000             break;</span>
<span class="line-modified">1001         case sun_java2d_pipe_BufferedOpCodes_SET_TEXTURE_PAINT:</span>
<span class="line-modified">1002             {</span>
<span class="line-modified">1003                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1004                 jboolean useMask= NEXT_BOOLEAN(b);</span>
<span class="line-modified">1005                 jboolean filter = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1006                 jlong pSrc      = NEXT_LONG(b);</span>
<span class="line-modified">1007                 jdouble xp0     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1008                 jdouble xp1     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1009                 jdouble xp3     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1010                 jdouble yp0     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1011                 jdouble yp1     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1012                 jdouble yp3     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1013                 [mtlc setTexturePaint:useMask</span>
<span class="line-modified">1014                               pSrcOps:pSrc</span>
<span class="line-modified">1015                                filter:filter</span>
<span class="line-modified">1016                                   xp0:xp0</span>
<span class="line-modified">1017                                   xp1:xp1</span>
<span class="line-modified">1018                                   xp3:xp3</span>
<span class="line-modified">1019                                   yp0:yp0</span>
<span class="line-modified">1020                                   yp1:yp1</span>
<span class="line-modified">1021                                   yp3:yp3];</span>
<span class="line-modified">1022             }</span>
<span class="line-modified">1023             break;</span>
1024 
<a name="40" id="anc40"></a><span class="line-modified">1025         // BufferedImageOp-related ops</span>
<span class="line-modified">1026         case sun_java2d_pipe_BufferedOpCodes_ENABLE_CONVOLVE_OP:</span>
<span class="line-modified">1027             {</span>
<span class="line-modified">1028                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1029                 jlong pSrc        = NEXT_LONG(b);</span>
<span class="line-modified">1030                 jboolean edgeZero = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1031                 jint kernelWidth  = NEXT_INT(b);</span>
<span class="line-modified">1032                 jint kernelHeight = NEXT_INT(b);</span>
<span class="line-modified">1033 </span>
<span class="line-modified">1034                 BMTLSDOps * bmtlsdOps = (BMTLSDOps *)pSrc;</span>
<span class="line-modified">1035                 MTLConvolveOp * convolveOp = [[MTLConvolveOp alloc] init:edgeZero</span>
<span class="line-modified">1036                         kernelWidth:kernelWidth</span>
<span class="line-modified">1037                        kernelHeight:kernelHeight</span>
<span class="line-modified">1038                            srcWidth:bmtlsdOps-&gt;width</span>
<span class="line-modified">1039                           srcHeight:bmtlsdOps-&gt;height</span>
<span class="line-modified">1040                              kernel:b</span>
<span class="line-modified">1041                              device:mtlc.device</span>
<span class="line-modified">1042                                               ];</span>
<span class="line-modified">1043                 [mtlc setBufImgOp:convolveOp];</span>
<span class="line-modified">1044                 SKIP_BYTES(b, kernelWidth * kernelHeight * sizeof(jfloat));</span>
<span class="line-modified">1045             }</span>
<span class="line-modified">1046             break;</span>
<span class="line-modified">1047         case sun_java2d_pipe_BufferedOpCodes_DISABLE_CONVOLVE_OP:</span>
<span class="line-modified">1048             {</span>
<span class="line-modified">1049                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1050                 [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1051             }</span>
<span class="line-modified">1052             break;</span>
<span class="line-modified">1053         case sun_java2d_pipe_BufferedOpCodes_ENABLE_RESCALE_OP:</span>
<span class="line-modified">1054             {</span>
<span class="line-modified">1055                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1056                 jlong pSrc          = NEXT_LONG(b);</span>
<span class="line-modified">1057                 jboolean nonPremult = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1058                 jint numFactors     = 4;</span>
<span class="line-modified">1059                 unsigned char *scaleFactors = b;</span>
<span class="line-modified">1060                 unsigned char *offsets = (b + numFactors * sizeof(jfloat));</span>
<span class="line-modified">1061                 MTLRescaleOp * rescaleOp = [[MTLRescaleOp alloc] init:nonPremult factors:scaleFactors offsets:offsets];</span>
<span class="line-modified">1062                 [mtlc setBufImgOp:rescaleOp];</span>
<span class="line-modified">1063                 SKIP_BYTES(b, numFactors * sizeof(jfloat) * 2);</span>
<span class="line-modified">1064             }</span>
<span class="line-modified">1065             break;</span>
<span class="line-modified">1066         case sun_java2d_pipe_BufferedOpCodes_DISABLE_RESCALE_OP:</span>
<span class="line-modified">1067             {</span>
<span class="line-modified">1068                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1069                 [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1070             }</span>
<span class="line-modified">1071             break;</span>
<span class="line-modified">1072         case sun_java2d_pipe_BufferedOpCodes_ENABLE_LOOKUP_OP:</span>
<span class="line-modified">1073             {</span>
<span class="line-modified">1074                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1075                 jlong pSrc          = NEXT_LONG(b);</span>
<span class="line-modified">1076                 jboolean nonPremult = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1077                 jboolean shortData  = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1078                 jint numBands       = NEXT_INT(b);</span>
<span class="line-modified">1079                 jint bandLength     = NEXT_INT(b);</span>
<span class="line-modified">1080                 jint offset         = NEXT_INT(b);</span>
<span class="line-modified">1081                 jint bytesPerElem = shortData ? sizeof(jshort):sizeof(jbyte);</span>
<span class="line-modified">1082                 void *tableValues = b;</span>
<span class="line-modified">1083 </span>
<span class="line-modified">1084                 MTLLookupOp * lookupOp = [[MTLLookupOp alloc] init:nonPremult</span>
<span class="line-modified">1085                                                          shortData:shortData</span>
<span class="line-modified">1086                                                           numBands:numBands</span>
<span class="line-modified">1087                                                         bandLength:bandLength</span>
<span class="line-modified">1088                                                             offset:offset</span>
<span class="line-modified">1089                                                        tableValues:tableValues</span>
<span class="line-modified">1090                                                             device:mtlc.device];</span>
<span class="line-modified">1091                 [mtlc setBufImgOp:lookupOp];</span>
<span class="line-modified">1092                 SKIP_BYTES(b, numBands * bandLength * bytesPerElem);</span>
<span class="line-modified">1093             }</span>
<span class="line-modified">1094             break;</span>
<span class="line-modified">1095         case sun_java2d_pipe_BufferedOpCodes_DISABLE_LOOKUP_OP:</span>
<span class="line-modified">1096             {</span>
<span class="line-modified">1097                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1098                 [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1099             }</span>
<span class="line-modified">1100             break;</span>

1101 
<a name="41" id="anc41"></a><span class="line-modified">1102         default:</span>
<span class="line-modified">1103             J2dRlsTraceLn1(J2D_TRACE_ERROR,</span>
<span class="line-modified">1104                 &quot;MTLRenderQueue_flushBuffer: invalid opcode=%d&quot;, opcode);</span>
<span class="line-modified">1105             return;</span>

1106         }
<a name="42" id="anc42"></a><span class="line-removed">1107     }</span>
1108 
<a name="43" id="anc43"></a><span class="line-modified">1109     if (mtlc != NULL) {</span>
<span class="line-modified">1110         [mtlc.encoderManager endEncoder];</span>
<span class="line-modified">1111         MTLCommandBufferWrapper * cbwrapper = [mtlc pullCommandBufferWrapper];</span>
<span class="line-modified">1112         id&lt;MTLCommandBuffer&gt; commandbuf = [cbwrapper getCommandBuffer];</span>
<span class="line-modified">1113         [commandbuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandbuf) {</span>
<span class="line-modified">1114             [cbwrapper release];</span>
<span class="line-modified">1115         }];</span>
<span class="line-modified">1116         [commandbuf commit];</span>
<span class="line-modified">1117         BMTLSDOps *dstOps = MTLRenderQueue_GetCurrentDestination();</span>
<span class="line-modified">1118         if (dstOps != NULL) {</span>
<span class="line-modified">1119             MTLSDOps *dstMTLOps = (MTLSDOps *)dstOps-&gt;privOps;</span>
<span class="line-modified">1120             MTLLayer *layer = (MTLLayer*)dstMTLOps-&gt;layer;</span>
<span class="line-modified">1121             if (layer != NULL) {</span>
<span class="line-modified">1122                 [JNFRunLoop performOnMainThreadWaiting:NO withBlock:^(){</span>
<span class="line-modified">1123                     AWT_ASSERT_APPKIT_THREAD;</span>
<span class="line-modified">1124                     [layer setNeedsDisplay];</span>
<span class="line-modified">1125                 }];</span>

1126             }
1127         }
<a name="44" id="anc44"></a>
1128     }
<a name="45" id="anc45"></a><span class="line-removed">1129     RESET_PREVIOUS_OP();</span>
1130 }
1131 
1132 /**
1133  * Returns a pointer to the &quot;current&quot; context, as set by the last SET_SURFACES
1134  * or SET_SCRATCH_SURFACE operation.
1135  */
1136 MTLContext *
1137 MTLRenderQueue_GetCurrentContext()
1138 {
1139     return mtlc;
1140 }
1141 
1142 /**
1143  * Returns a pointer to the &quot;current&quot; destination surface, as set by the last
1144  * SET_SURFACES operation.
1145  */
1146 BMTLSDOps *
1147 MTLRenderQueue_GetCurrentDestination()
1148 {
1149     return dstOps;
1150 }
1151 
1152 /**
1153  * commit earlier encoded commmands
1154  * these would be rendered to the back-buffer - which is read in shader while rendering in XOR mode
1155  */
1156 void commitEncodedCommands() {
1157     [mtlc.encoderManager endEncoder];
1158 
1159     MTLCommandBufferWrapper *cbwrapper = [mtlc pullCommandBufferWrapper];
1160     id &lt;MTLCommandBuffer&gt; commandbuf = [cbwrapper getCommandBuffer];
1161     [commandbuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandbuf) {
1162         [cbwrapper release];
1163     }];
1164     [commandbuf commit];
1165     [commandbuf waitUntilCompleted];
1166 }
1167 
1168 #endif /* !HEADLESS */
<a name="46" id="anc46"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="46" type="hidden" />
</body>
</html>