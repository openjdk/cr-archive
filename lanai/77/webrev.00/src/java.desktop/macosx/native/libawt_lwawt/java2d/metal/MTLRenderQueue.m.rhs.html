<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLRenderQueue.m</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 #ifndef HEADLESS
  27 
  28 #include &lt;stdlib.h&gt;
  29 
  30 #include &quot;sun_java2d_pipe_BufferedOpCodes.h&quot;
  31 
  32 #include &quot;jlong.h&quot;
  33 #include &quot;MTLBlitLoops.h&quot;
  34 #include &quot;MTLBufImgOps.h&quot;
  35 #include &quot;MTLMaskBlit.h&quot;
  36 #include &quot;MTLMaskFill.h&quot;
  37 #include &quot;MTLPaints.h&quot;
  38 #include &quot;MTLRenderQueue.h&quot;
  39 #include &quot;MTLRenderer.h&quot;
  40 #include &quot;MTLTextRenderer.h&quot;
  41 #import &quot;ThreadUtilities.h&quot;
  42 
  43 /**
  44  * References to the &quot;current&quot; context and destination surface.
  45  */
  46 static MTLContext *mtlc = NULL;
  47 static BMTLSDOps *dstOps = NULL;
  48 jint mtlPreviousOp = MTL_OP_INIT;
  49 
  50 
  51 /**
  52  * The following methods are implemented in the windowing system (i.e. GLX
  53  * and WGL) source files.
  54  */
  55 extern void MTLGC_DestroyMTLGraphicsConfig(jlong pConfigInfo);
  56 extern void MTLSD_SwapBuffers(JNIEnv *env, jlong window);
  57 
  58 // TODO : Debug logic added for opcode verification,
  59 // should be removed later.
  60 static char *getOpcodeString(jint opcode) {
  61     static char opName[30];
  62     switch (opcode) {
  63         case sun_java2d_pipe_BufferedOpCodes_DRAW_LINE:
  64             {
  65                 strcpy(opName, &quot;DRAW_LINE&quot;);
  66             }
  67             break;
  68         case sun_java2d_pipe_BufferedOpCodes_DRAW_RECT:
  69             {
  70                 strcpy(opName, &quot;DRAW_RECT&quot;);
  71             }
  72             break;
  73         case sun_java2d_pipe_BufferedOpCodes_DRAW_POLY:
  74             {
  75                 strcpy(opName, &quot;DRAW_POLY&quot;);
  76             }
  77             break;
  78         case sun_java2d_pipe_BufferedOpCodes_DRAW_PIXEL:
  79             {
  80                 strcpy(opName, &quot;DRAW_PIXEL&quot;);
  81             }
  82             break;
  83         case sun_java2d_pipe_BufferedOpCodes_DRAW_SCANLINES:
  84             {
  85                 strcpy(opName, &quot;DRAW_SCANLINES&quot;);
  86             }
  87             break;
  88         case sun_java2d_pipe_BufferedOpCodes_DRAW_PARALLELOGRAM:
  89             {
  90                 strcpy(opName, &quot;DRAW_PARALLELOGRAM&quot;);
  91             }
  92             break;
  93         case sun_java2d_pipe_BufferedOpCodes_DRAW_AAPARALLELOGRAM:
  94             {
  95                 strcpy(opName, &quot;DRAW_AAPARALLELOGRAM&quot;);
  96             }
  97             break;
  98         case sun_java2d_pipe_BufferedOpCodes_FILL_RECT:
  99             {
 100                 strcpy(opName, &quot;FILL_RECT&quot;);
 101             }
 102             break;
 103         case sun_java2d_pipe_BufferedOpCodes_FILL_SPANS:
 104             {
 105                 strcpy(opName, &quot;FILL_SPANS&quot;);
 106             }
 107             break;
 108         case sun_java2d_pipe_BufferedOpCodes_FILL_PARALLELOGRAM:
 109             {
 110                 strcpy(opName, &quot;FILL_PARALLELOGRAM&quot;);
 111             }
 112             break;
 113         case sun_java2d_pipe_BufferedOpCodes_FILL_AAPARALLELOGRAM:
 114             {
 115                 strcpy(opName, &quot;FILL_AAPARALLELOGRAM&quot;);
 116             }
 117             break;
 118         case sun_java2d_pipe_BufferedOpCodes_DRAW_GLYPH_LIST:
 119             {
 120                 strcpy(opName, &quot;DRAW_GLYPH_LIST&quot;);
 121             }
 122             break;
 123         case sun_java2d_pipe_BufferedOpCodes_COPY_AREA:
 124             {
 125                 strcpy(opName, &quot;COPY_AREA&quot;);
 126             }
 127             break;
 128         case sun_java2d_pipe_BufferedOpCodes_BLIT:
 129             {
 130                 strcpy(opName, &quot;BLIT&quot;);
 131             }
 132             break;
 133         case sun_java2d_pipe_BufferedOpCodes_SURFACE_TO_SW_BLIT:
 134             {
 135                 strcpy(opName, &quot;SURFACE_TO_SW_BLIT&quot;);
 136             }
 137             break;
 138         case sun_java2d_pipe_BufferedOpCodes_MASK_FILL:
 139             {
 140                 strcpy(opName, &quot;MASK_FILL&quot;);
 141             }
 142             break;
 143         case sun_java2d_pipe_BufferedOpCodes_MASK_BLIT:
 144             {
 145 
 146                 strcpy(opName, &quot;MASK_BLIT&quot;);
 147             }
 148             break;
 149         case sun_java2d_pipe_BufferedOpCodes_SET_RECT_CLIP:
 150             {
 151                 strcpy(opName, &quot;SET_RECT_CLIP&quot;);
 152             }
 153             break;
 154         case sun_java2d_pipe_BufferedOpCodes_BEGIN_SHAPE_CLIP:
 155             {
 156                 strcpy(opName, &quot;BEGIN_SHAPE_CLIP&quot;);
 157             }
 158             break;
 159         case sun_java2d_pipe_BufferedOpCodes_SET_SHAPE_CLIP_SPANS:
 160             {
 161                 strcpy(opName, &quot;SET_SHAPE_CLIP_SPANS&quot;);
 162             }
 163             break;
 164         case sun_java2d_pipe_BufferedOpCodes_END_SHAPE_CLIP:
 165             {
 166                 strcpy(opName, &quot;END_SHAPE_CLIP&quot;);
 167             }
 168             break;
 169         case sun_java2d_pipe_BufferedOpCodes_RESET_CLIP:
 170             {
 171                 strcpy(opName, &quot;RESET_CLIP&quot;);
 172             }
 173             break;
 174         case sun_java2d_pipe_BufferedOpCodes_SET_ALPHA_COMPOSITE:
 175             {
 176                 strcpy(opName, &quot;SET_ALPHA_COMPOSITE&quot;);
 177             }
 178             break;
 179         case sun_java2d_pipe_BufferedOpCodes_SET_XOR_COMPOSITE:
 180             {
 181                 strcpy(opName, &quot;SET_XOR_COMPOSITE&quot;);
 182             }
 183             break;
 184         case sun_java2d_pipe_BufferedOpCodes_RESET_COMPOSITE:
 185             {
 186                 strcpy(opName, &quot;RESET_COMPOSITE&quot;);
 187             }
 188             break;
 189         case sun_java2d_pipe_BufferedOpCodes_SET_TRANSFORM:
 190             {
 191                 strcpy(opName, &quot;SET_TRANSFORM&quot;);
 192             }
 193             break;
 194         case sun_java2d_pipe_BufferedOpCodes_RESET_TRANSFORM:
 195             {
 196                 strcpy(opName, &quot;RESET_TRANSFORM&quot;);
 197             }
 198             break;
 199         case sun_java2d_pipe_BufferedOpCodes_SET_SURFACES:
 200             {
 201 
 202                 strcpy(opName, &quot;SET_SURFACES&quot;);
 203             }
 204             break;
 205         case sun_java2d_pipe_BufferedOpCodes_SET_SCRATCH_SURFACE:
 206             {
 207                 strcpy(opName, &quot;SET_SCRATCH_SURFACE&quot;);
 208             }
 209             break;
 210         case sun_java2d_pipe_BufferedOpCodes_FLUSH_SURFACE:
 211             {
 212                 strcpy(opName, &quot;FLUSH_SURFACE&quot;);
 213             }
 214             break;
 215         case sun_java2d_pipe_BufferedOpCodes_DISPOSE_SURFACE:
 216             {
 217                 strcpy(opName, &quot;DISPOSE_SURFACE&quot;);
 218             }
 219             break;
 220         case sun_java2d_pipe_BufferedOpCodes_DISPOSE_CONFIG:
 221             {
 222                 strcpy(opName, &quot;DISPOSE_CONFIG&quot;);
 223             }
 224             break;
 225         case sun_java2d_pipe_BufferedOpCodes_INVALIDATE_CONTEXT:
 226             {
 227                 strcpy(opName, &quot;INVALIDATE_CONTEXT&quot;);
 228             }
 229             break;
 230         case sun_java2d_pipe_BufferedOpCodes_SYNC:
 231             {
 232                 strcpy(opName, &quot;SYNC&quot;);
 233 
 234             }
 235             break;
 236         case sun_java2d_pipe_BufferedOpCodes_SWAP_BUFFERS:
 237             {
 238                 strcpy(opName, &quot;SWAP_BUFFERS&quot;);
 239             }
 240             break;
 241         case sun_java2d_pipe_BufferedOpCodes_NOOP:
 242             strcpy(opName, &quot;NOOP&quot;);
 243             break;
 244         case sun_java2d_pipe_BufferedOpCodes_RESET_PAINT:
 245             {
 246                 strcpy(opName, &quot;RESET_PAINT&quot;);
 247             }
 248             break;
 249         case sun_java2d_pipe_BufferedOpCodes_SET_COLOR:
 250             {
 251                 strcpy(opName, &quot;SET_COLOR&quot;);
 252             }
 253             break;
 254         case sun_java2d_pipe_BufferedOpCodes_SET_GRADIENT_PAINT:
 255             {
 256                 strcpy(opName, &quot;SET_GRADIENT_PAINT&quot;);
 257             }
 258             break;
 259         case sun_java2d_pipe_BufferedOpCodes_SET_LINEAR_GRADIENT_PAINT:
 260             {
 261                 strcpy(opName, &quot;SET_LINEAR_GRADIENT_PAINT&quot;);
 262             }
 263             break;
 264         case sun_java2d_pipe_BufferedOpCodes_SET_RADIAL_GRADIENT_PAINT:
 265             {
 266                 strcpy(opName, &quot;SET_RADIAL_GRADIENT_PAINT&quot;);
 267             }
 268             break;
 269         case sun_java2d_pipe_BufferedOpCodes_SET_TEXTURE_PAINT:
 270             {
 271                 strcpy(opName, &quot;SET_TEXTURE_PAINT&quot;);
 272             }
 273             break;
 274         case sun_java2d_pipe_BufferedOpCodes_ENABLE_CONVOLVE_OP:
 275             {
 276                 strcpy(opName, &quot;ENABLE_CONVOLVE_OP&quot;);
 277             }
 278             break;
 279         case sun_java2d_pipe_BufferedOpCodes_DISABLE_CONVOLVE_OP:
 280             {
 281                 strcpy(opName, &quot;DISABLE_CONVOLVE_OP&quot;);
 282             }
 283             break;
 284         case sun_java2d_pipe_BufferedOpCodes_ENABLE_RESCALE_OP:
 285             {
 286                 strcpy(opName, &quot;ENABLE_RESCALE_OP&quot;);
 287             }
 288             break;
 289         case sun_java2d_pipe_BufferedOpCodes_DISABLE_RESCALE_OP:
 290             {
 291                  strcpy(opName, &quot;DISABLE_RESCALE_OP&quot;);
 292             }
 293             break;
 294         case sun_java2d_pipe_BufferedOpCodes_ENABLE_LOOKUP_OP:
 295             {
 296                 strcpy(opName, &quot;ENABLE_LOOKUP_OP&quot;);
 297             }
 298             break;
 299         case sun_java2d_pipe_BufferedOpCodes_DISABLE_LOOKUP_OP:
 300             {
 301                 strcpy(opName, &quot;DISABLE_LOOKUP_OP&quot;);
 302             }
 303             break;
 304         default:
 305             strcpy(opName, &quot;UNKNOWN&quot;);
 306             break;
 307         }
 308     return opName;
 309 }
 310 
 311 void MTLRenderQueue_CheckPreviousOp(jint op) {
 312 
 313     if (mtlPreviousOp == op) {
 314         // The op is the same as last time, so we can return immediately.
 315         return;
 316     }
 317 
 318     J2dTraceLn1(J2D_TRACE_VERBOSE,
 319                 &quot;MTLRenderQueue_CheckPreviousOp: new op=%d&quot;, op);
 320 
 321     if (op == MTL_OP_SET_COLOR) {
 322         return; // SET_COLOR should not cause endEncoder
 323     }
 324 
 325     if (mtlPreviousOp == MTL_OP_INIT) {
 326         mtlPreviousOp = op;
 327         return;
 328     }
 329 
 330     if (mtlc != NULL) {
 331         [mtlc.encoderManager endEncoder];
 332 
 333         if (op == MTL_OP_RESET_PAINT || op == MTL_OP_SYNC) {
 334             MTLCommandBufferWrapper *cbwrapper = [mtlc pullCommandBufferWrapper];
 335             id &lt;MTLCommandBuffer&gt; commandbuf = [cbwrapper getCommandBuffer];
 336             [commandbuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandbuf) {
 337                 [cbwrapper release];
 338             }];
 339             [commandbuf commit];
 340             if (op == MTL_OP_SYNC) {
 341                 [commandbuf waitUntilCompleted];
 342             }
 343         }
 344     }
 345     mtlPreviousOp = op;
 346 }
 347 
 348 JNIEXPORT void JNICALL
 349 Java_sun_java2d_metal_MTLRenderQueue_flushBuffer
 350     (JNIEnv *env, jobject mtlrq,
 351      jlong buf, jint limit)
 352 {
 353     unsigned char *b, *end;
 354 
 355     J2dTraceLn1(J2D_TRACE_INFO,
 356                 &quot;MTLRenderQueue_flushBuffer: limit=%d&quot;, limit);
 357 
 358     b = (unsigned char *)jlong_to_ptr(buf);
 359     if (b == NULL) {
 360         J2dRlsTraceLn(J2D_TRACE_ERROR,
 361             &quot;MTLRenderQueue_flushBuffer: cannot get direct buffer address&quot;);
 362         return;
 363     }
 364 
 365     end = b + limit;
<a name="1" id="anc1"></a><span class="line-modified"> 366     @autoreleasepool {</span>
<span class="line-modified"> 367         jboolean DEBUG_LOG = JNI_FALSE;</span>
<span class="line-modified"> 368         while (b &lt; end) {</span>
<span class="line-modified"> 369             jint opcode = NEXT_INT(b);</span>
<span class="line-modified"> 370 </span>
<span class="line-modified"> 371             if (DEBUG_LOG) {</span>
<span class="line-modified"> 372                 J2dTraceLn2(J2D_TRACE_ERROR,</span>
<span class="line-modified"> 373                         &quot;MTLRenderQueue_flushBuffer: opcode_name = %s, rem=%d&quot;,</span>
<span class="line-modified"> 374                         getOpcodeString(opcode), (end-b));</span>
<span class="line-modified"> 375             } else {</span>
<span class="line-modified"> 376                 J2dTraceLn2(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 377                         &quot;MTLRenderQueue_flushBuffer: opcode=%d, rem=%d&quot;,</span>
<span class="line-modified"> 378                         opcode, (end-b));</span>
<span class="line-modified"> 379             }</span>
<span class="line-modified"> 380 </span>
<span class="line-modified"> 381             switch (opcode) {</span>
<span class="line-modified"> 382 </span>
<span class="line-modified"> 383                 // draw ops</span>
<span class="line-modified"> 384                 case sun_java2d_pipe_BufferedOpCodes_DRAW_LINE:</span>
<span class="line-modified"> 385                 {</span>
<span class="line-modified"> 386                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 387 </span>
<span class="line-modified"> 388                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 389                         commitEncodedCommands();</span>
<span class="line-modified"> 390                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 391                                    &quot;DRAW_LINE in XOR mode - Force commit earlier draw calls before DRAW_LINE.&quot;);</span>
<span class="line-added"> 392                     }</span>
<span class="line-added"> 393                     jint x1 = NEXT_INT(b);</span>
<span class="line-added"> 394                     jint y1 = NEXT_INT(b);</span>
<span class="line-added"> 395                     jint x2 = NEXT_INT(b);</span>
<span class="line-added"> 396                     jint y2 = NEXT_INT(b);</span>
<span class="line-added"> 397                     MTLRenderer_DrawLine(mtlc, dstOps, x1, y1, x2, y2);</span>
<span class="line-added"> 398                     break;</span>
 399                 }
<a name="2" id="anc2"></a><span class="line-modified"> 400                 case sun_java2d_pipe_BufferedOpCodes_DRAW_RECT:</span>
<span class="line-modified"> 401                 {</span>
<span class="line-modified"> 402                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 403 </span>
<span class="line-modified"> 404                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 405                         commitEncodedCommands();</span>
<span class="line-modified"> 406                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 407                                    &quot;DRAW_RECT in XOR mode - Force commit earlier draw calls before DRAW_RECT.&quot;);</span>
<span class="line-modified"> 408                     }</span>
<span class="line-modified"> 409                     jint x = NEXT_INT(b);</span>
<span class="line-modified"> 410                     jint y = NEXT_INT(b);</span>
<span class="line-modified"> 411                     jint w = NEXT_INT(b);</span>
<span class="line-modified"> 412                     jint h = NEXT_INT(b);</span>
<span class="line-modified"> 413                     MTLRenderer_DrawRect(mtlc, dstOps, x, y, w, h);</span>
<span class="line-added"> 414                     break;</span>
 415                 }
<a name="3" id="anc3"></a><span class="line-modified"> 416                 case sun_java2d_pipe_BufferedOpCodes_DRAW_POLY:</span>
<span class="line-modified"> 417                 {</span>
<span class="line-modified"> 418                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 419                     jint nPoints      = NEXT_INT(b);</span>
<span class="line-modified"> 420                     jboolean isClosed = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 421                     jint transX       = NEXT_INT(b);</span>
<span class="line-modified"> 422                     jint transY       = NEXT_INT(b);</span>
<span class="line-modified"> 423                     jint *xPoints = (jint *)b;</span>
<span class="line-modified"> 424                     jint *yPoints = ((jint *)b) + nPoints;</span>
<span class="line-modified"> 425 </span>
<span class="line-modified"> 426                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 427                         commitEncodedCommands();</span>
<span class="line-modified"> 428                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 429                                    &quot;DRAW_POLY in XOR mode - Force commit earlier draw calls before DRAW_POLY.&quot;);</span>
<span class="line-modified"> 430 </span>
<span class="line-modified"> 431                         // draw separate (N-1) lines using N points</span>
<span class="line-modified"> 432                         for(int point = 0; point &lt; nPoints-1; point++) {</span>
<span class="line-modified"> 433                             jint x1 = xPoints[point] + transX;</span>
<span class="line-modified"> 434                             jint y1 = yPoints[point] + transY;</span>
<span class="line-modified"> 435                             jint x2 = xPoints[point + 1] + transX;</span>
<span class="line-modified"> 436                             jint y2 = yPoints[point + 1] + transY;</span>
<span class="line-modified"> 437                             MTLRenderer_DrawLine(mtlc, dstOps, x1, y1, x2, y2);</span>
<span class="line-modified"> 438                         }</span>
<span class="line-modified"> 439 </span>
<span class="line-modified"> 440                         if (isClosed) {</span>
<span class="line-modified"> 441                             MTLRenderer_DrawLine(mtlc, dstOps, xPoints[0] + transX, yPoints[0] + transY,</span>
<span class="line-modified"> 442                                                  xPoints[nPoints-1] + transX, yPoints[nPoints-1] + transY);</span>
<span class="line-modified"> 443                         }</span>
<span class="line-added"> 444                     } else {</span>
<span class="line-added"> 445                         MTLRenderer_DrawPoly(mtlc, dstOps, nPoints, isClosed, transX, transY, xPoints, yPoints);</span>
 446                     }
 447 
<a name="4" id="anc4"></a><span class="line-modified"> 448                     SKIP_BYTES(b, nPoints * BYTES_PER_POLY_POINT);</span>
<span class="line-modified"> 449                     break;</span>



 450                 }
<a name="5" id="anc5"></a><span class="line-added"> 451                 case sun_java2d_pipe_BufferedOpCodes_DRAW_PIXEL:</span>
<span class="line-added"> 452                 {</span>
<span class="line-added"> 453                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 454 </span>
<span class="line-added"> 455                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 456                         commitEncodedCommands();</span>
<span class="line-added"> 457                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 458                                    &quot;DRAW_PIXEL in XOR mode - Force commit earlier draw calls before DRAW_PIXEL.&quot;);</span>
<span class="line-added"> 459                     }</span>
 460 
<a name="6" id="anc6"></a><span class="line-modified"> 461                     jint x = NEXT_INT(b);</span>
<span class="line-modified"> 462                     jint y = NEXT_INT(b);</span>
<span class="line-modified"> 463                     CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 464                     MTLRenderer_DrawPixel(mtlc, dstOps, x, y);</span>
<span class="line-modified"> 465                     break;</span>





 466                 }
<a name="7" id="anc7"></a><span class="line-added"> 467                 case sun_java2d_pipe_BufferedOpCodes_DRAW_SCANLINES:</span>
<span class="line-added"> 468                 {</span>
<span class="line-added"> 469                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 470 </span>
<span class="line-added"> 471                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 472                         commitEncodedCommands();</span>
<span class="line-added"> 473                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 474                                    &quot;DRAW_SCANLINES in XOR mode - Force commit earlier draw calls before &quot;</span>
<span class="line-added"> 475                                    &quot;DRAW_SCANLINES.&quot;);</span>
<span class="line-added"> 476                     }</span>
 477 
<a name="8" id="anc8"></a><span class="line-modified"> 478                     jint count = NEXT_INT(b);</span>
<span class="line-modified"> 479                     MTLRenderer_DrawScanlines(mtlc, dstOps, count, (jint *)b);</span>







 480 
<a name="9" id="anc9"></a><span class="line-modified"> 481                     SKIP_BYTES(b, count * BYTES_PER_SCANLINE);</span>
<span class="line-modified"> 482                     break;</span>

 483                 }
<a name="10" id="anc10"></a><span class="line-added"> 484                 case sun_java2d_pipe_BufferedOpCodes_DRAW_PARALLELOGRAM:</span>
<span class="line-added"> 485                 {</span>
<span class="line-added"> 486                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 487 </span>
<span class="line-added"> 488                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 489                         commitEncodedCommands();</span>
<span class="line-added"> 490                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 491                                    &quot;DRAW_PARALLELOGRAM in XOR mode - Force commit earlier draw calls before &quot;</span>
<span class="line-added"> 492                                    &quot;DRAW_PARALLELOGRAM.&quot;);</span>
<span class="line-added"> 493                     }</span>
 494 
<a name="11" id="anc11"></a><span class="line-modified"> 495                     jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 496                     jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 497                     jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 498                     jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 499                     jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 500                     jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 501                     jfloat lwr21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 502                     jfloat lwr12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 503 </span>
<span class="line-modified"> 504                     MTLRenderer_DrawParallelogram(mtlc, dstOps,</span>
<span class="line-modified"> 505                                                   x11, y11,</span>
<span class="line-modified"> 506                                                   dx21, dy21,</span>
<span class="line-modified"> 507                                                   dx12, dy12,</span>
<span class="line-added"> 508                                                   lwr21, lwr12);</span>
<span class="line-added"> 509                     break;</span>
<span class="line-added"> 510                 }</span>
<span class="line-added"> 511                 case sun_java2d_pipe_BufferedOpCodes_DRAW_AAPARALLELOGRAM:</span>
<span class="line-added"> 512                 {</span>
<span class="line-added"> 513                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 514                     jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-added"> 515                     jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-added"> 516                     jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 517                     jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 518                     jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 519                     jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 520                     jfloat lwr21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 521                     jfloat lwr12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 522 </span>
<span class="line-added"> 523                     MTLRenderer_DrawAAParallelogram(mtlc, dstOps,</span>
<span class="line-added"> 524                                                     x11, y11,</span>
<span class="line-added"> 525                                                     dx21, dy21,</span>
<span class="line-added"> 526                                                     dx12, dy12,</span>
<span class="line-added"> 527                                                     lwr21, lwr12);</span>
<span class="line-added"> 528                     break;</span>
 529                 }
 530 
<a name="12" id="anc12"></a><span class="line-modified"> 531                 // fill ops</span>
<span class="line-modified"> 532                 case sun_java2d_pipe_BufferedOpCodes_FILL_RECT:</span>
<span class="line-modified"> 533                 {</span>
<span class="line-modified"> 534                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>































 535 
<a name="13" id="anc13"></a><span class="line-modified"> 536                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 537                         commitEncodedCommands();</span>
<span class="line-modified"> 538                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 539                                    &quot;FILL_RECT in XOR mode - Force commit earlier draw calls before FILL_RECT.&quot;);</span>
<span class="line-added"> 540                     }</span>
 541 
<a name="14" id="anc14"></a><span class="line-modified"> 542                     jint x = NEXT_INT(b);</span>
<span class="line-modified"> 543                     jint y = NEXT_INT(b);</span>
<span class="line-modified"> 544                     jint w = NEXT_INT(b);</span>
<span class="line-added"> 545                     jint h = NEXT_INT(b);</span>
<span class="line-added"> 546                     MTLRenderer_FillRect(mtlc, dstOps, x, y, w, h);</span>
<span class="line-added"> 547                     break;</span>
 548                 }
<a name="15" id="anc15"></a><span class="line-added"> 549                 case sun_java2d_pipe_BufferedOpCodes_FILL_SPANS:</span>
<span class="line-added"> 550                 {</span>
<span class="line-added"> 551                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 552 </span>
<span class="line-added"> 553                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 554                         commitEncodedCommands();</span>
<span class="line-added"> 555                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 556                                    &quot;FILL_SPANS in XOR mode - Force commit earlier draw calls before FILL_SPANS.&quot;);</span>
<span class="line-added"> 557                     }</span>
 558 
<a name="16" id="anc16"></a><span class="line-modified"> 559                     jint count = NEXT_INT(b);</span>
<span class="line-modified"> 560                     MTLRenderer_FillSpans(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-modified"> 561                     SKIP_BYTES(b, count * BYTES_PER_SPAN);</span>
<span class="line-modified"> 562                     break;</span>










 563                 }
<a name="17" id="anc17"></a><span class="line-added"> 564                 case sun_java2d_pipe_BufferedOpCodes_FILL_PARALLELOGRAM:</span>
<span class="line-added"> 565                 {</span>
<span class="line-added"> 566                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 567 </span>
<span class="line-added"> 568                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 569                         commitEncodedCommands();</span>
<span class="line-added"> 570                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 571                                    &quot;FILL_PARALLELOGRAM in XOR mode - Force commit earlier draw calls before &quot;</span>
<span class="line-added"> 572                                    &quot;FILL_PARALLELOGRAM.&quot;);</span>
<span class="line-added"> 573                     }</span>
 574 
<a name="18" id="anc18"></a><span class="line-modified"> 575                     jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 576                     jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 577                     jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 578                     jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 579                     jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 580                     jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 581                     MTLRenderer_FillParallelogram(mtlc, dstOps,</span>
<span class="line-modified"> 582                                                   x11, y11,</span>
<span class="line-modified"> 583                                                   dx21, dy21,</span>
<span class="line-modified"> 584                                                   dx12, dy12);</span>
<span class="line-modified"> 585                     break;</span>
<span class="line-modified"> 586                 }</span>
<span class="line-added"> 587                 case sun_java2d_pipe_BufferedOpCodes_FILL_AAPARALLELOGRAM:</span>
<span class="line-added"> 588                 {</span>
<span class="line-added"> 589                     CHECK_PREVIOUS_OP(MTL_OP_AA);</span>
<span class="line-added"> 590                     jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-added"> 591                     jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-added"> 592                     jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 593                     jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 594                     jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 595                     jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 596                     MTLRenderer_FillAAParallelogram(mtlc, dstOps,</span>
<span class="line-added"> 597                                                     x11, y11,</span>
<span class="line-added"> 598                                                     dx21, dy21,</span>
<span class="line-added"> 599                                                     dx12, dy12);</span>
<span class="line-added"> 600                     break;</span>
 601                 }
 602 
<a name="19" id="anc19"></a><span class="line-modified"> 603                 // text-related ops</span>
<span class="line-modified"> 604                 case sun_java2d_pipe_BufferedOpCodes_DRAW_GLYPH_LIST:</span>
<span class="line-modified"> 605                 {</span>
<span class="line-modified"> 606                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>























 607 
<a name="20" id="anc20"></a><span class="line-modified"> 608                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 609                         commitEncodedCommands();</span>
<span class="line-modified"> 610                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 611                                    &quot;DRAW_GLYPH_LIST in XOR mode - Force commit earlier draw calls before &quot;</span>
<span class="line-added"> 612                                    &quot;DRAW_GLYPH_LIST.&quot;);</span>
<span class="line-added"> 613                     }</span>
 614 
<a name="21" id="anc21"></a><span class="line-modified"> 615                     jint numGlyphs        = NEXT_INT(b);</span>
<span class="line-modified"> 616                     jint packedParams     = NEXT_INT(b);</span>
<span class="line-modified"> 617                     jfloat glyphListOrigX = NEXT_FLOAT(b);</span>
<span class="line-added"> 618                     jfloat glyphListOrigY = NEXT_FLOAT(b);</span>
<span class="line-added"> 619                     jboolean usePositions = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-added"> 620                                                             OFFSET_POSITIONS);</span>
<span class="line-added"> 621                     jboolean subPixPos    = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-added"> 622                                                             OFFSET_SUBPIXPOS);</span>
<span class="line-added"> 623                     jboolean rgbOrder     = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-added"> 624                                                             OFFSET_RGBORDER);</span>
<span class="line-added"> 625                     jint lcdContrast      = EXTRACT_BYTE(packedParams,</span>
<span class="line-added"> 626                                                          OFFSET_CONTRAST);</span>
<span class="line-added"> 627                     unsigned char *images = b;</span>
<span class="line-added"> 628                     unsigned char *positions;</span>
<span class="line-added"> 629                     jint bytesPerGlyph;</span>
<span class="line-added"> 630                     if (usePositions) {</span>
<span class="line-added"> 631                         positions = (b + numGlyphs * BYTES_PER_GLYPH_IMAGE);</span>
<span class="line-added"> 632                         bytesPerGlyph = BYTES_PER_POSITIONED_GLYPH;</span>
<span class="line-added"> 633                     } else {</span>
<span class="line-added"> 634                         positions = NULL;</span>
<span class="line-added"> 635                         bytesPerGlyph = BYTES_PER_GLYPH_IMAGE;</span>
<span class="line-added"> 636                     }</span>
<span class="line-added"> 637                     MTLTR_DrawGlyphList(env, mtlc, dstOps,</span>
<span class="line-added"> 638                                         numGlyphs, usePositions,</span>
<span class="line-added"> 639                                         subPixPos, rgbOrder, lcdContrast,</span>
<span class="line-added"> 640                                         glyphListOrigX, glyphListOrigY,</span>
<span class="line-added"> 641                                         images, positions);</span>
<span class="line-added"> 642                     SKIP_BYTES(b, numGlyphs * bytesPerGlyph);</span>
<span class="line-added"> 643                     break;</span>
 644                 }
 645 
<a name="22" id="anc22"></a><span class="line-modified"> 646                 // copy-related ops</span>
<span class="line-modified"> 647                 case sun_java2d_pipe_BufferedOpCodes_COPY_AREA:</span>
<span class="line-modified"> 648                 {</span>
<span class="line-modified"> 649                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 650                     jint x  = NEXT_INT(b);</span>
<span class="line-modified"> 651                     jint y  = NEXT_INT(b);</span>
<span class="line-modified"> 652                     jint w  = NEXT_INT(b);</span>
<span class="line-modified"> 653                     jint h  = NEXT_INT(b);</span>
<span class="line-modified"> 654                     jint dx = NEXT_INT(b);</span>
<span class="line-modified"> 655                     jint dy = NEXT_INT(b);</span>
<span class="line-modified"> 656                     MTLBlitLoops_CopyArea(env, mtlc, dstOps,</span>
<span class="line-modified"> 657                                           x, y, w, h, dx, dy);</span>
<span class="line-modified"> 658                     break;</span>








 659                 }
<a name="23" id="anc23"></a><span class="line-modified"> 660                 case sun_java2d_pipe_BufferedOpCodes_BLIT:</span>
<span class="line-modified"> 661                 {</span>
<span class="line-modified"> 662                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 663                     jint packedParams = NEXT_INT(b);</span>
<span class="line-modified"> 664                     jint sx1          = NEXT_INT(b);</span>
<span class="line-modified"> 665                     jint sy1          = NEXT_INT(b);</span>
<span class="line-modified"> 666                     jint sx2          = NEXT_INT(b);</span>
<span class="line-modified"> 667                     jint sy2          = NEXT_INT(b);</span>
<span class="line-modified"> 668                     jdouble dx1       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 669                     jdouble dy1       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 670                     jdouble dx2       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 671                     jdouble dy2       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 672                     jlong pSrc        = NEXT_LONG(b);</span>
<span class="line-modified"> 673                     jlong pDst        = NEXT_LONG(b);</span>
<span class="line-modified"> 674                     jint hint         = EXTRACT_BYTE(packedParams, OFFSET_HINT);</span>
<span class="line-modified"> 675                     jboolean texture  = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 676                                                         OFFSET_TEXTURE);</span>
<span class="line-modified"> 677                     jboolean xform    = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 678                                                         OFFSET_XFORM);</span>
<span class="line-modified"> 679                     jboolean isoblit  = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 680                                                         OFFSET_ISOBLIT);</span>
<span class="line-modified"> 681                     if (isoblit) {</span>
<span class="line-modified"> 682                         MTLBlitLoops_IsoBlit(env, mtlc, pSrc, pDst,</span>
<span class="line-modified"> 683                                              xform, hint, texture,</span>
<span class="line-modified"> 684                                              sx1, sy1, sx2, sy2,</span>
<span class="line-modified"> 685                                              dx1, dy1, dx2, dy2);</span>
<span class="line-modified"> 686                     } else {</span>
<span class="line-modified"> 687                         jint srctype = EXTRACT_BYTE(packedParams, OFFSET_SRCTYPE);</span>
<span class="line-modified"> 688                         MTLBlitLoops_Blit(env, mtlc, pSrc, pDst,</span>
<span class="line-modified"> 689                                           xform, hint, srctype, texture,</span>
<span class="line-modified"> 690                                           sx1, sy1, sx2, sy2,</span>
<span class="line-modified"> 691                                           dx1, dy1, dx2, dy2);</span>
<span class="line-modified"> 692                     }</span>
<span class="line-modified"> 693                     break;</span>
<span class="line-modified"> 694                 }</span>
<span class="line-modified"> 695                 case sun_java2d_pipe_BufferedOpCodes_SURFACE_TO_SW_BLIT:</span>
<span class="line-modified"> 696                 {</span>
<span class="line-modified"> 697                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 698                     jint sx      = NEXT_INT(b);</span>
<span class="line-modified"> 699                     jint sy      = NEXT_INT(b);</span>
<span class="line-modified"> 700                     jint dx      = NEXT_INT(b);</span>
<span class="line-modified"> 701                     jint dy      = NEXT_INT(b);</span>
<span class="line-modified"> 702                     jint w       = NEXT_INT(b);</span>
<span class="line-modified"> 703                     jint h       = NEXT_INT(b);</span>
<span class="line-modified"> 704                     jint dsttype = NEXT_INT(b);</span>
<span class="line-modified"> 705                     jlong pSrc   = NEXT_LONG(b);</span>
<span class="line-modified"> 706                     jlong pDst   = NEXT_LONG(b);</span>
<span class="line-modified"> 707                     MTLBlitLoops_SurfaceToSwBlit(env, mtlc,</span>
<span class="line-modified"> 708                                                  pSrc, pDst, dsttype,</span>
<span class="line-modified"> 709                                                  sx, sy, dx, dy, w, h);</span>
<span class="line-modified"> 710                     break;</span>
<span class="line-modified"> 711                 }</span>
<span class="line-modified"> 712                 case sun_java2d_pipe_BufferedOpCodes_MASK_FILL:</span>
<span class="line-modified"> 713                 {</span>
<span class="line-modified"> 714                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 715                     jint x        = NEXT_INT(b);</span>
<span class="line-added"> 716                     jint y        = NEXT_INT(b);</span>
<span class="line-added"> 717                     jint w        = NEXT_INT(b);</span>
<span class="line-added"> 718                     jint h        = NEXT_INT(b);</span>
<span class="line-added"> 719                     jint maskoff  = NEXT_INT(b);</span>
<span class="line-added"> 720                     jint maskscan = NEXT_INT(b);</span>
<span class="line-added"> 721                     jint masklen  = NEXT_INT(b);</span>
<span class="line-added"> 722                     unsigned char *pMask = (masklen &gt; 0) ? b : NULL;</span>
<span class="line-added"> 723                     MTLMaskFill_MaskFill(mtlc, dstOps, x, y, w, h,</span>
<span class="line-added"> 724                                          maskoff, maskscan, masklen, pMask);</span>
<span class="line-added"> 725                     SKIP_BYTES(b, masklen);</span>
<span class="line-added"> 726                     break;</span>
<span class="line-added"> 727                 }</span>
<span class="line-added"> 728                 case sun_java2d_pipe_BufferedOpCodes_MASK_BLIT:</span>
<span class="line-added"> 729                 {</span>
<span class="line-added"> 730                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 731                     jint dstx     = NEXT_INT(b);</span>
<span class="line-added"> 732                     jint dsty     = NEXT_INT(b);</span>
<span class="line-added"> 733                     jint width    = NEXT_INT(b);</span>
<span class="line-added"> 734                     jint height   = NEXT_INT(b);</span>
<span class="line-added"> 735                     jint masklen  = width * height * sizeof(jint);</span>
<span class="line-added"> 736                     MTLMaskBlit_MaskBlit(env, mtlc, dstOps,</span>
<span class="line-added"> 737                                          dstx, dsty, width, height, b);</span>
<span class="line-added"> 738                     SKIP_BYTES(b, masklen);</span>
<span class="line-added"> 739                     break;</span>
 740                 }
<a name="24" id="anc24"></a>













































































































 741 
<a name="25" id="anc25"></a><span class="line-modified"> 742                 // state-related ops</span>
<span class="line-added"> 743                 case sun_java2d_pipe_BufferedOpCodes_SET_RECT_CLIP:</span>
<span class="line-added"> 744                 {</span>
<span class="line-added"> 745                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 746                     jint x1 = NEXT_INT(b);</span>
<span class="line-added"> 747                     jint y1 = NEXT_INT(b);</span>
<span class="line-added"> 748                     jint x2 = NEXT_INT(b);</span>
<span class="line-added"> 749                     jint y2 = NEXT_INT(b);</span>
<span class="line-added"> 750                     [mtlc setClipRectX1:x1 Y1:y1 X2:x2 Y2:y2];</span>
<span class="line-added"> 751                     break;</span>
<span class="line-added"> 752                 }</span>
<span class="line-added"> 753                 case sun_java2d_pipe_BufferedOpCodes_BEGIN_SHAPE_CLIP:</span>
<span class="line-added"> 754                 {</span>
<span class="line-added"> 755                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 756                     [mtlc beginShapeClip:dstOps];</span>
<span class="line-added"> 757                     break;</span>
<span class="line-added"> 758                 }</span>
<span class="line-added"> 759                 case sun_java2d_pipe_BufferedOpCodes_SET_SHAPE_CLIP_SPANS:</span>
<span class="line-added"> 760                 {</span>
<span class="line-added"> 761                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 762                     // This results in creation of new render encoder with</span>
<span class="line-added"> 763                     // stencil buffer set as render target</span>
<span class="line-added"> 764                     jint count = NEXT_INT(b);</span>
<span class="line-added"> 765                     MTLRenderer_FillSpans(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-added"> 766                     SKIP_BYTES(b, count * BYTES_PER_SPAN);</span>
<span class="line-added"> 767                     break;</span>
<span class="line-added"> 768                 }</span>
<span class="line-added"> 769                 case sun_java2d_pipe_BufferedOpCodes_END_SHAPE_CLIP:</span>
<span class="line-added"> 770                 {</span>
<span class="line-added"> 771                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 772                     [mtlc endShapeClip:dstOps];</span>
<span class="line-added"> 773                     break;</span>
<span class="line-added"> 774                 }</span>
<span class="line-added"> 775                 case sun_java2d_pipe_BufferedOpCodes_RESET_CLIP:</span>
<span class="line-added"> 776                 {</span>
<span class="line-added"> 777                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 778                     [mtlc resetClip];</span>
<span class="line-added"> 779                     break;</span>
<span class="line-added"> 780                 }</span>
<span class="line-added"> 781                 case sun_java2d_pipe_BufferedOpCodes_SET_ALPHA_COMPOSITE:</span>
<span class="line-added"> 782                 {</span>
<span class="line-added"> 783                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 784                     jint rule         = NEXT_INT(b);</span>
<span class="line-added"> 785                     jfloat extraAlpha = NEXT_FLOAT(b);</span>
<span class="line-added"> 786                     jint flags        = NEXT_INT(b);</span>
<span class="line-added"> 787                     [mtlc setAlphaCompositeRule:rule extraAlpha:extraAlpha flags:flags];</span>
<span class="line-added"> 788                     break;</span>
<span class="line-added"> 789                 }</span>
<span class="line-added"> 790                 case sun_java2d_pipe_BufferedOpCodes_SET_XOR_COMPOSITE:</span>
<span class="line-added"> 791                 {</span>
<span class="line-added"> 792                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 793                     jint xorPixel = NEXT_INT(b);</span>
<span class="line-added"> 794                     [mtlc setXorComposite:xorPixel];</span>
<span class="line-added"> 795                     break;</span>
<span class="line-added"> 796                 }</span>
<span class="line-added"> 797                 case sun_java2d_pipe_BufferedOpCodes_RESET_COMPOSITE:</span>
<span class="line-added"> 798                 {</span>
<span class="line-added"> 799                     /* TODO: check whether something needs to be done here if we are moving out of XOR composite</span>
<span class="line-added"> 800                     commitEncodedCommands();</span>
<span class="line-added"> 801                     MTLCommandBufferWrapper * cbwrapper = [mtlc pullCommandBufferWrapper];</span>
<span class="line-added"> 802                     [cbwrapper onComplete];</span>
 803 
<a name="26" id="anc26"></a><span class="line-modified"> 804                     J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 805                      &quot;RESET_COMPOSITE - Force commit earlier draw calls before RESET_COMPOSITE.&quot;);*/</span>




















 806 
<a name="27" id="anc27"></a><span class="line-modified"> 807                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 808                     [mtlc resetComposite];</span>
<span class="line-modified"> 809                     break;</span>
<span class="line-modified"> 810                 }</span>
<span class="line-modified"> 811                 case sun_java2d_pipe_BufferedOpCodes_SET_TRANSFORM:</span>
<span class="line-modified"> 812                 {</span>
<span class="line-added"> 813                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 814                     jdouble m00 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 815                     jdouble m10 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 816                     jdouble m01 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 817                     jdouble m11 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 818                     jdouble m02 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 819                     jdouble m12 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 820                     [mtlc setTransformM00:m00 M10:m10 M01:m01 M11:m11 M02:m02 M12:m12];</span>
<span class="line-added"> 821                     break;</span>
<span class="line-added"> 822                 }</span>
<span class="line-added"> 823                 case sun_java2d_pipe_BufferedOpCodes_RESET_TRANSFORM:</span>
<span class="line-added"> 824                 {</span>
<span class="line-added"> 825                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 826                     [mtlc resetTransform];</span>
<span class="line-added"> 827                     break;</span>
<span class="line-added"> 828                 }</span>
 829 
<a name="28" id="anc28"></a><span class="line-modified"> 830                 // context-related ops</span>
<span class="line-modified"> 831                 case sun_java2d_pipe_BufferedOpCodes_SET_SURFACES:</span>
<span class="line-modified"> 832                 {</span>
<span class="line-modified"> 833                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 834                     jlong pSrc = NEXT_LONG(b);</span>
<span class="line-modified"> 835                     jlong pDst = NEXT_LONG(b);</span>




 836 
<a name="29" id="anc29"></a><span class="line-modified"> 837                     dstOps = (BMTLSDOps *)jlong_to_ptr(pDst);</span>
<span class="line-added"> 838                     mtlc = [MTLContext setSurfacesEnv:env src:pSrc dst:pDst];</span>
<span class="line-added"> 839                     break;</span>
<span class="line-added"> 840                 }</span>
<span class="line-added"> 841                 case sun_java2d_pipe_BufferedOpCodes_SET_SCRATCH_SURFACE:</span>
<span class="line-added"> 842                 {</span>
<span class="line-added"> 843                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 844                     jlong pConfigInfo = NEXT_LONG(b);</span>
<span class="line-added"> 845                     MTLGraphicsConfigInfo *mtlInfo =</span>
<span class="line-added"> 846                             (MTLGraphicsConfigInfo *)jlong_to_ptr(pConfigInfo);</span>
 847 
<a name="30" id="anc30"></a><span class="line-modified"> 848                     if (mtlInfo == NULL) {</span>


 849 
 850                     } else {
<a name="31" id="anc31"></a><span class="line-modified"> 851                         MTLContext *newMtlc = mtlInfo-&gt;context;</span>
<span class="line-modified"> 852                         if (newMtlc == NULL) {</span>
<span class="line-added"> 853 </span>
<span class="line-added"> 854                         } else {</span>
<span class="line-added"> 855                             mtlc = newMtlc;</span>
<span class="line-added"> 856                             dstOps = NULL;</span>
<span class="line-added"> 857                         }</span>
 858                     }
<a name="32" id="anc32"></a><span class="line-added"> 859                     break;</span>
 860                 }
<a name="33" id="anc33"></a><span class="line-modified"> 861                 case sun_java2d_pipe_BufferedOpCodes_FLUSH_SURFACE:</span>
<span class="line-modified"> 862                 {</span>
<span class="line-modified"> 863                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 864                     jlong pData = NEXT_LONG(b);</span>
<span class="line-modified"> 865                     BMTLSDOps *mtlsdo = (BMTLSDOps *)jlong_to_ptr(pData);</span>
<span class="line-modified"> 866                     if (mtlsdo != NULL) {</span>
<span class="line-modified"> 867                         CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 868                         MTLSD_Delete(env, mtlsdo);</span>
<span class="line-modified"> 869                     }</span>
<span class="line-modified"> 870                     break;</span>
 871                 }
<a name="34" id="anc34"></a><span class="line-modified"> 872                 case sun_java2d_pipe_BufferedOpCodes_DISPOSE_SURFACE:</span>
<span class="line-modified"> 873                 {</span>
<span class="line-modified"> 874                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 875                     jlong pData = NEXT_LONG(b);</span>
<span class="line-modified"> 876                     BMTLSDOps *mtlsdo = (BMTLSDOps *)jlong_to_ptr(pData);</span>
<span class="line-modified"> 877                     if (mtlsdo != NULL) {</span>
<span class="line-modified"> 878                         CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 879                         MTLSD_Delete(env, mtlsdo);</span>
<span class="line-modified"> 880                         if (mtlsdo-&gt;privOps != NULL) {</span>
<span class="line-modified"> 881                             free(mtlsdo-&gt;privOps);</span>
<span class="line-modified"> 882                         }</span>

 883                     }
<a name="35" id="anc35"></a><span class="line-added"> 884                     break;</span>
<span class="line-added"> 885                 }</span>
<span class="line-added"> 886                 case sun_java2d_pipe_BufferedOpCodes_DISPOSE_CONFIG:</span>
<span class="line-added"> 887                 {</span>
<span class="line-added"> 888                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 889                     jlong pConfigInfo = NEXT_LONG(b);</span>
<span class="line-added"> 890                     CONTINUE_IF_NULL(mtlc);</span>
<span class="line-added"> 891                     MTLGC_DestroyMTLGraphicsConfig(pConfigInfo);</span>
<span class="line-added"> 892 </span>
<span class="line-added"> 893                     // the previous method will call glX/wglMakeCurrent(None),</span>
<span class="line-added"> 894                     // so we should nullify the current mtlc and dstOps to avoid</span>
<span class="line-added"> 895                     // calling glFlush() (or similar) while no context is current</span>
<span class="line-added"> 896                     mtlc = NULL;</span>
<span class="line-added"> 897                  //   dstOps = NULL;</span>
<span class="line-added"> 898                     break;</span>
<span class="line-added"> 899                 }</span>
<span class="line-added"> 900                 case sun_java2d_pipe_BufferedOpCodes_INVALIDATE_CONTEXT:</span>
<span class="line-added"> 901                 {</span>
<span class="line-added"> 902                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 903                     // invalidate the references to the current context and</span>
<span class="line-added"> 904                     // destination surface that are maintained at the native level</span>
<span class="line-added"> 905                     mtlc = NULL;</span>
<span class="line-added"> 906                 //    dstOps = NULL;</span>
<span class="line-added"> 907                     break;</span>
<span class="line-added"> 908                 }</span>
<span class="line-added"> 909                 case sun_java2d_pipe_BufferedOpCodes_SYNC:</span>
<span class="line-added"> 910                 {</span>
<span class="line-added"> 911                     CHECK_PREVIOUS_OP(MTL_OP_SYNC);</span>
<span class="line-added"> 912                     break;</span>
 913                 }
<a name="36" id="anc36"></a>





























 914 
<a name="37" id="anc37"></a><span class="line-modified"> 915                 // multibuffering ops</span>
<span class="line-modified"> 916                 case sun_java2d_pipe_BufferedOpCodes_SWAP_BUFFERS:</span>
<span class="line-modified"> 917                 {</span>
<span class="line-modified"> 918                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 919                     jlong window = NEXT_LONG(b);</span>
<span class="line-modified"> 920                     MTLSD_SwapBuffers(env, window);</span>
<span class="line-modified"> 921                     break;</span>
<span class="line-modified"> 922                 }</span>
 923 
<a name="38" id="anc38"></a><span class="line-modified"> 924                 // special no-op (mainly used for achieving 8-byte alignment)</span>
<span class="line-modified"> 925                 case sun_java2d_pipe_BufferedOpCodes_NOOP:</span>
<span class="line-modified"> 926                     break;</span>
 927 
<a name="39" id="anc39"></a><span class="line-modified"> 928                 // paint-related ops</span>
<span class="line-modified"> 929                 case sun_java2d_pipe_BufferedOpCodes_RESET_PAINT:</span>
<span class="line-modified"> 930                 {</span>
<span class="line-modified"> 931                   CHECK_PREVIOUS_OP(MTL_OP_RESET_PAINT);</span>
<span class="line-modified"> 932                   [mtlc resetPaint];</span>
<span class="line-modified"> 933                     break;</span>
<span class="line-modified"> 934                 }</span>
<span class="line-modified"> 935                 case sun_java2d_pipe_BufferedOpCodes_SET_COLOR:</span>
<span class="line-modified"> 936                 {</span>
<span class="line-modified"> 937                     CHECK_PREVIOUS_OP(MTL_OP_SET_COLOR);</span>
<span class="line-modified"> 938                     jint pixel = NEXT_INT(b);</span>
<span class="line-modified"> 939                     [mtlc setColorPaint:pixel];</span>
<span class="line-modified"> 940                     break;</span>
<span class="line-modified"> 941                 }</span>
<span class="line-modified"> 942                 case sun_java2d_pipe_BufferedOpCodes_SET_GRADIENT_PAINT:</span>
<span class="line-modified"> 943                 {</span>
<span class="line-modified"> 944                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 945                     jboolean useMask= NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 946                     jboolean cyclic = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 947                     jdouble p0      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 948                     jdouble p1      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 949                     jdouble p3      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 950                     jint pixel1     = NEXT_INT(b);</span>
<span class="line-modified"> 951                     jint pixel2     = NEXT_INT(b);</span>
<span class="line-modified"> 952                     [mtlc setGradientPaintUseMask:useMask</span>
<span class="line-modified"> 953                                         cyclic:cyclic</span>
<span class="line-modified"> 954                                             p0:p0</span>
<span class="line-modified"> 955                                             p1:p1</span>
<span class="line-modified"> 956                                             p3:p3</span>
<span class="line-modified"> 957                                         pixel1:pixel1</span>
<span class="line-modified"> 958                                         pixel2:pixel2];</span>
<span class="line-modified"> 959                     break;</span>
<span class="line-modified"> 960                 }</span>
<span class="line-modified"> 961                 case sun_java2d_pipe_BufferedOpCodes_SET_LINEAR_GRADIENT_PAINT:</span>
<span class="line-modified"> 962                 {</span>
<span class="line-modified"> 963                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 964                     jboolean useMask = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 965                     jboolean linear  = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 966                     jint cycleMethod = NEXT_INT(b);</span>
<span class="line-modified"> 967                     jint numStops    = NEXT_INT(b);</span>
<span class="line-modified"> 968                     jfloat p0        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 969                     jfloat p1        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 970                     jfloat p3        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 971                     void *fractions, *pixels;</span>
<span class="line-modified"> 972                     fractions = b; SKIP_BYTES(b, numStops * sizeof(jfloat));</span>
<span class="line-modified"> 973                     pixels    = b; SKIP_BYTES(b, numStops * sizeof(jint));</span>
<span class="line-modified"> 974                     [mtlc setLinearGradientPaint:useMask</span>
<span class="line-modified"> 975                                           linear:linear</span>
<span class="line-modified"> 976                                      cycleMethod:cycleMethod</span>
<span class="line-modified"> 977                                         numStops:numStops</span>
<span class="line-modified"> 978                                               p0:p0</span>
<span class="line-modified"> 979                                               p1:p1</span>
<span class="line-modified"> 980                                               p3:p3</span>
<span class="line-modified"> 981                                        fractions:fractions</span>
<span class="line-modified"> 982                                           pixels:pixels];</span>
<span class="line-modified"> 983                     break;</span>
<span class="line-modified"> 984                 }</span>
<span class="line-modified"> 985                 case sun_java2d_pipe_BufferedOpCodes_SET_RADIAL_GRADIENT_PAINT:</span>
<span class="line-modified"> 986                 {</span>
<span class="line-modified"> 987                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 988                     jboolean useMask = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 989                     jboolean linear  = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 990                     jint numStops    = NEXT_INT(b);</span>
<span class="line-modified"> 991                     jint cycleMethod = NEXT_INT(b);</span>
<span class="line-modified"> 992                     jfloat m00       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 993                     jfloat m01       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 994                     jfloat m02       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 995                     jfloat m10       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 996                     jfloat m11       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 997                     jfloat m12       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 998                     jfloat focusX    = NEXT_FLOAT(b);</span>
<span class="line-modified"> 999                     void *fractions, *pixels;</span>
<span class="line-modified">1000                     fractions = b; SKIP_BYTES(b, numStops * sizeof(jfloat));</span>
<span class="line-modified">1001                     pixels    = b; SKIP_BYTES(b, numStops * sizeof(jint));</span>
<span class="line-modified">1002                     [mtlc setRadialGradientPaint:useMask</span>
<span class="line-modified">1003                                           linear:linear</span>
<span class="line-modified">1004                                      cycleMethod:cycleMethod</span>
<span class="line-modified">1005                                         numStops:numStops</span>
<span class="line-modified">1006                                              m00:m00</span>
<span class="line-modified">1007                                              m01:m01</span>
<span class="line-modified">1008                                              m02:m02</span>
<span class="line-modified">1009                                              m10:m10</span>
<span class="line-modified">1010                                              m11:m11</span>
<span class="line-modified">1011                                              m12:m12</span>
<span class="line-modified">1012                                           focusX:focusX</span>
<span class="line-modified">1013                                        fractions:fractions</span>
<span class="line-modified">1014                                           pixels:pixels];</span>
<span class="line-modified">1015                     break;</span>
<span class="line-modified">1016                 }</span>
<span class="line-modified">1017                 case sun_java2d_pipe_BufferedOpCodes_SET_TEXTURE_PAINT:</span>
<span class="line-modified">1018                 {</span>
<span class="line-modified">1019                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1020                     jboolean useMask= NEXT_BOOLEAN(b);</span>
<span class="line-modified">1021                     jboolean filter = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1022                     jlong pSrc      = NEXT_LONG(b);</span>
<span class="line-modified">1023                     jdouble xp0     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1024                     jdouble xp1     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1025                     jdouble xp3     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1026                     jdouble yp0     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1027                     jdouble yp1     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1028                     jdouble yp3     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1029                     [mtlc setTexturePaint:useMask</span>
<span class="line-modified">1030                                   pSrcOps:pSrc</span>
<span class="line-modified">1031                                    filter:filter</span>
<span class="line-modified">1032                                       xp0:xp0</span>
<span class="line-modified">1033                                       xp1:xp1</span>
<span class="line-modified">1034                                       xp3:xp3</span>
<span class="line-modified">1035                                       yp0:yp0</span>
<span class="line-modified">1036                                       yp1:yp1</span>
<span class="line-modified">1037                                       yp3:yp3];</span>
<span class="line-modified">1038                     break;</span>
<span class="line-modified">1039                 }</span>
1040 
<a name="40" id="anc40"></a><span class="line-modified">1041                 // BufferedImageOp-related ops</span>
<span class="line-modified">1042                 case sun_java2d_pipe_BufferedOpCodes_ENABLE_CONVOLVE_OP:</span>
<span class="line-modified">1043                 {</span>
<span class="line-modified">1044                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1045                     jlong pSrc        = NEXT_LONG(b);</span>
<span class="line-modified">1046                     jboolean edgeZero = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1047                     jint kernelWidth  = NEXT_INT(b);</span>
<span class="line-modified">1048                     jint kernelHeight = NEXT_INT(b);</span>
<span class="line-modified">1049 </span>
<span class="line-modified">1050                     BMTLSDOps * bmtlsdOps = (BMTLSDOps *)pSrc;</span>
<span class="line-modified">1051                     MTLConvolveOp * convolveOp = [[MTLConvolveOp alloc] init:edgeZero</span>
<span class="line-modified">1052                             kernelWidth:kernelWidth</span>
<span class="line-modified">1053                            kernelHeight:kernelHeight</span>
<span class="line-modified">1054                                srcWidth:bmtlsdOps-&gt;width</span>
<span class="line-modified">1055                               srcHeight:bmtlsdOps-&gt;height</span>
<span class="line-modified">1056                                  kernel:b</span>
<span class="line-modified">1057                                  device:mtlc.device</span>
<span class="line-modified">1058                                                   ];</span>
<span class="line-modified">1059                     [mtlc setBufImgOp:convolveOp];</span>
<span class="line-modified">1060                     SKIP_BYTES(b, kernelWidth * kernelHeight * sizeof(jfloat));</span>
<span class="line-modified">1061                     break;</span>
<span class="line-modified">1062                 }</span>
<span class="line-modified">1063                 case sun_java2d_pipe_BufferedOpCodes_DISABLE_CONVOLVE_OP:</span>
<span class="line-modified">1064                 {</span>
<span class="line-modified">1065                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1066                     [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1067                     break;</span>
<span class="line-modified">1068                 }</span>
<span class="line-modified">1069                 case sun_java2d_pipe_BufferedOpCodes_ENABLE_RESCALE_OP:</span>
<span class="line-modified">1070                 {</span>
<span class="line-modified">1071                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1072                     jlong pSrc          = NEXT_LONG(b);</span>
<span class="line-modified">1073                     jboolean nonPremult = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1074                     jint numFactors     = 4;</span>
<span class="line-modified">1075                     unsigned char *scaleFactors = b;</span>
<span class="line-modified">1076                     unsigned char *offsets = (b + numFactors * sizeof(jfloat));</span>
<span class="line-modified">1077                     MTLRescaleOp * rescaleOp =</span>
<span class="line-modified">1078                             [[MTLRescaleOp alloc] init:nonPremult factors:scaleFactors offsets:offsets];</span>
<span class="line-modified">1079                     [mtlc setBufImgOp:rescaleOp];</span>
<span class="line-modified">1080                     SKIP_BYTES(b, numFactors * sizeof(jfloat) * 2);</span>
<span class="line-modified">1081                     break;</span>
<span class="line-modified">1082                 }</span>
<span class="line-modified">1083                 case sun_java2d_pipe_BufferedOpCodes_DISABLE_RESCALE_OP:</span>
<span class="line-modified">1084                 {</span>
<span class="line-modified">1085                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1086                     [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1087                     break;</span>
<span class="line-modified">1088                 }</span>
<span class="line-modified">1089                 case sun_java2d_pipe_BufferedOpCodes_ENABLE_LOOKUP_OP:</span>
<span class="line-modified">1090                 {</span>
<span class="line-modified">1091                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1092                     jlong pSrc          = NEXT_LONG(b);</span>
<span class="line-modified">1093                     jboolean nonPremult = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1094                     jboolean shortData  = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1095                     jint numBands       = NEXT_INT(b);</span>
<span class="line-modified">1096                     jint bandLength     = NEXT_INT(b);</span>
<span class="line-modified">1097                     jint offset         = NEXT_INT(b);</span>
<span class="line-modified">1098                     jint bytesPerElem = shortData ? sizeof(jshort):sizeof(jbyte);</span>
<span class="line-modified">1099                     void *tableValues = b;</span>
<span class="line-modified">1100 </span>
<span class="line-modified">1101                     MTLLookupOp * lookupOp = [[MTLLookupOp alloc] init:nonPremult</span>
<span class="line-modified">1102                                                              shortData:shortData</span>
<span class="line-modified">1103                                                               numBands:numBands</span>
<span class="line-modified">1104                                                             bandLength:bandLength</span>
<span class="line-modified">1105                                                                 offset:offset</span>
<span class="line-modified">1106                                                            tableValues:tableValues</span>
<span class="line-modified">1107                                                                 device:mtlc.device];</span>
<span class="line-modified">1108                     [mtlc setBufImgOp:lookupOp];</span>
<span class="line-modified">1109                     SKIP_BYTES(b, numBands * bandLength * bytesPerElem);</span>
<span class="line-modified">1110                     break;</span>
<span class="line-modified">1111                 }</span>
<span class="line-modified">1112                 case sun_java2d_pipe_BufferedOpCodes_DISABLE_LOOKUP_OP:</span>
<span class="line-modified">1113                 {</span>
<span class="line-modified">1114                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1115                     [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1116                     break;</span>
<span class="line-added">1117                 }</span>
1118 
<a name="41" id="anc41"></a><span class="line-modified">1119                 default:</span>
<span class="line-modified">1120                     J2dRlsTraceLn1(J2D_TRACE_ERROR,</span>
<span class="line-modified">1121                         &quot;MTLRenderQueue_flushBuffer: invalid opcode=%d&quot;, opcode);</span>
<span class="line-modified">1122                     return;</span>
<span class="line-added">1123             }</span>
1124         }
<a name="42" id="anc42"></a>
1125 
<a name="43" id="anc43"></a><span class="line-modified">1126         if (mtlc != NULL) {</span>
<span class="line-modified">1127             [mtlc.encoderManager endEncoder];</span>
<span class="line-modified">1128             MTLCommandBufferWrapper * cbwrapper = [mtlc pullCommandBufferWrapper];</span>
<span class="line-modified">1129             id&lt;MTLCommandBuffer&gt; commandbuf = [cbwrapper getCommandBuffer];</span>
<span class="line-modified">1130             [commandbuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandbuf) {</span>
<span class="line-modified">1131                 [cbwrapper release];</span>
<span class="line-modified">1132             }];</span>
<span class="line-modified">1133             [commandbuf commit];</span>
<span class="line-modified">1134             BMTLSDOps *dstOps = MTLRenderQueue_GetCurrentDestination();</span>
<span class="line-modified">1135             if (dstOps != NULL) {</span>
<span class="line-modified">1136                 MTLSDOps *dstMTLOps = (MTLSDOps *)dstOps-&gt;privOps;</span>
<span class="line-modified">1137                 MTLLayer *layer = (MTLLayer*)dstMTLOps-&gt;layer;</span>
<span class="line-modified">1138                 if (layer != NULL) {</span>
<span class="line-modified">1139                     [JNFRunLoop performOnMainThreadWaiting:NO withBlock:^(){</span>
<span class="line-modified">1140                         AWT_ASSERT_APPKIT_THREAD;</span>
<span class="line-modified">1141                         [layer setNeedsDisplay];</span>
<span class="line-modified">1142                     }];</span>
<span class="line-added">1143                 }</span>
1144             }
1145         }
<a name="44" id="anc44"></a><span class="line-added">1146         RESET_PREVIOUS_OP();</span>
1147     }
<a name="45" id="anc45"></a>
1148 }
1149 
1150 /**
1151  * Returns a pointer to the &quot;current&quot; context, as set by the last SET_SURFACES
1152  * or SET_SCRATCH_SURFACE operation.
1153  */
1154 MTLContext *
1155 MTLRenderQueue_GetCurrentContext()
1156 {
1157     return mtlc;
1158 }
1159 
1160 /**
1161  * Returns a pointer to the &quot;current&quot; destination surface, as set by the last
1162  * SET_SURFACES operation.
1163  */
1164 BMTLSDOps *
1165 MTLRenderQueue_GetCurrentDestination()
1166 {
1167     return dstOps;
1168 }
1169 
1170 /**
1171  * commit earlier encoded commmands
1172  * these would be rendered to the back-buffer - which is read in shader while rendering in XOR mode
1173  */
1174 void commitEncodedCommands() {
1175     [mtlc.encoderManager endEncoder];
1176 
1177     MTLCommandBufferWrapper *cbwrapper = [mtlc pullCommandBufferWrapper];
1178     id &lt;MTLCommandBuffer&gt; commandbuf = [cbwrapper getCommandBuffer];
1179     [commandbuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandbuf) {
1180         [cbwrapper release];
1181     }];
1182     [commandbuf commit];
1183     [commandbuf waitUntilCompleted];
1184 }
1185 
1186 #endif /* !HEADLESS */
<a name="46" id="anc46"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="46" type="hidden" />
</body>
</html>