<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLRenderQueue.m</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="MTLPaints.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="MTLTextRenderer.m.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLRenderQueue.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 346 }
 347 
 348 JNIEXPORT void JNICALL
 349 Java_sun_java2d_metal_MTLRenderQueue_flushBuffer
 350     (JNIEnv *env, jobject mtlrq,
 351      jlong buf, jint limit)
 352 {
 353     unsigned char *b, *end;
 354 
 355     J2dTraceLn1(J2D_TRACE_INFO,
 356                 &quot;MTLRenderQueue_flushBuffer: limit=%d&quot;, limit);
 357 
 358     b = (unsigned char *)jlong_to_ptr(buf);
 359     if (b == NULL) {
 360         J2dRlsTraceLn(J2D_TRACE_ERROR,
 361             &quot;MTLRenderQueue_flushBuffer: cannot get direct buffer address&quot;);
 362         return;
 363     }
 364 
 365     end = b + limit;
<span class="line-modified"> 366 </span>
<span class="line-modified"> 367     jboolean DEBUG_LOG = JNI_FALSE;</span>
<span class="line-modified"> 368     while (b &lt; end) {</span>
<span class="line-modified"> 369         jint opcode = NEXT_INT(b);</span>
<span class="line-modified"> 370 </span>
<span class="line-modified"> 371         if (DEBUG_LOG) {</span>
<span class="line-modified"> 372             J2dTraceLn2(J2D_TRACE_ERROR,</span>
<span class="line-modified"> 373                     &quot;MTLRenderQueue_flushBuffer: opcode_name = %s, rem=%d&quot;,</span>
<span class="line-modified"> 374                     getOpcodeString(opcode), (end-b));</span>
<span class="line-modified"> 375         } else {</span>
<span class="line-modified"> 376             J2dTraceLn2(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 377                     &quot;MTLRenderQueue_flushBuffer: opcode=%d, rem=%d&quot;,</span>
<span class="line-modified"> 378                     opcode, (end-b));</span>
<span class="line-modified"> 379         }</span>
<span class="line-modified"> 380 </span>
<span class="line-modified"> 381         switch (opcode) {</span>
<span class="line-modified"> 382 </span>
<span class="line-modified"> 383         // draw ops</span>
<span class="line-modified"> 384         case sun_java2d_pipe_BufferedOpCodes_DRAW_LINE:</span>
<span class="line-modified"> 385             {</span>
<span class="line-modified"> 386                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 387 </span>
<span class="line-modified"> 388                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 389                     commitEncodedCommands();</span>
<span class="line-modified"> 390                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_LINE in XOR mode - Force commit earlier draw calls before DRAW_LINE.&quot;);</span>








 391                 }
<span class="line-modified"> 392                 jint x1 = NEXT_INT(b);</span>
<span class="line-modified"> 393                 jint y1 = NEXT_INT(b);</span>
<span class="line-modified"> 394                 jint x2 = NEXT_INT(b);</span>
<span class="line-modified"> 395                 jint y2 = NEXT_INT(b);</span>
<span class="line-modified"> 396                 MTLRenderer_DrawLine(mtlc, dstOps, x1, y1, x2, y2);</span>
<span class="line-modified"> 397             }</span>
<span class="line-modified"> 398             break;</span>
<span class="line-modified"> 399         case sun_java2d_pipe_BufferedOpCodes_DRAW_RECT:</span>
<span class="line-modified"> 400             {</span>
<span class="line-modified"> 401                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 402 </span>
<span class="line-modified"> 403                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 404                     commitEncodedCommands();</span>
<span class="line-modified"> 405                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_RECT in XOR mode - Force commit earlier draw calls before DRAW_RECT.&quot;);</span>

 406                 }
<span class="line-modified"> 407                 jint x = NEXT_INT(b);</span>
<span class="line-modified"> 408                 jint y = NEXT_INT(b);</span>
<span class="line-modified"> 409                 jint w = NEXT_INT(b);</span>
<span class="line-modified"> 410                 jint h = NEXT_INT(b);</span>
<span class="line-modified"> 411                 MTLRenderer_DrawRect(mtlc, dstOps, x, y, w, h);</span>
<span class="line-modified"> 412             }</span>
<span class="line-modified"> 413             break;</span>
<span class="line-modified"> 414         case sun_java2d_pipe_BufferedOpCodes_DRAW_POLY:</span>
<span class="line-modified"> 415             {</span>
<span class="line-modified"> 416                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 417                 jint nPoints      = NEXT_INT(b);</span>
<span class="line-modified"> 418                 jboolean isClosed = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 419                 jint transX       = NEXT_INT(b);</span>
<span class="line-modified"> 420                 jint transY       = NEXT_INT(b);</span>
<span class="line-modified"> 421                 jint *xPoints = (jint *)b;</span>
<span class="line-modified"> 422                 jint *yPoints = ((jint *)b) + nPoints;</span>
<span class="line-modified"> 423 </span>
<span class="line-modified"> 424                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 425                     commitEncodedCommands();</span>
<span class="line-modified"> 426                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_POLY in XOR mode - Force commit earlier draw calls before DRAW_POLY.&quot;);</span>
<span class="line-modified"> 427 </span>
<span class="line-modified"> 428                     // draw separate (N-1) lines using N points</span>
<span class="line-modified"> 429                     for(int point = 0; point &lt; nPoints-1; point++) {</span>
<span class="line-modified"> 430                         jint x1 = xPoints[point] + transX;</span>
<span class="line-modified"> 431                         jint y1 = yPoints[point] + transY;</span>
<span class="line-modified"> 432                         jint x2 = xPoints[point + 1] + transX;</span>
<span class="line-modified"> 433                         jint y2 = yPoints[point + 1] + transY;</span>
<span class="line-modified"> 434                         MTLRenderer_DrawLine(mtlc, dstOps, x1, y1, x2, y2);</span>


 435                     }
 436 
<span class="line-modified"> 437                     if (isClosed) {</span>
<span class="line-modified"> 438                         MTLRenderer_DrawLine(mtlc, dstOps, xPoints[0] + transX, yPoints[0] + transY, xPoints[nPoints-1] + transX, yPoints[nPoints-1] + transY);</span>
<span class="line-removed"> 439                     }</span>
<span class="line-removed"> 440                 } else {</span>
<span class="line-removed"> 441                     MTLRenderer_DrawPoly(mtlc, dstOps, nPoints, isClosed, transX, transY, xPoints, yPoints);</span>
 442                 }









 443 
<span class="line-modified"> 444                 SKIP_BYTES(b, nPoints * BYTES_PER_POLY_POINT);</span>
<span class="line-modified"> 445             }</span>
<span class="line-modified"> 446             break;</span>
<span class="line-modified"> 447         case sun_java2d_pipe_BufferedOpCodes_DRAW_PIXEL:</span>
<span class="line-modified"> 448             {</span>
<span class="line-removed"> 449                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 450 </span>
<span class="line-removed"> 451                 if ([mtlc useXORComposite]) {</span>
<span class="line-removed"> 452                     commitEncodedCommands();</span>
<span class="line-removed"> 453                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_PIXEL in XOR mode - Force commit earlier draw calls before DRAW_PIXEL.&quot;);</span>
 454                 }










 455 
<span class="line-modified"> 456                 jint x = NEXT_INT(b);</span>
<span class="line-modified"> 457                 jint y = NEXT_INT(b);</span>
<span class="line-removed"> 458                 CONTINUE_IF_NULL(mtlc);</span>
<span class="line-removed"> 459                 MTLRenderer_DrawPixel(mtlc, dstOps, x, y);</span>
<span class="line-removed"> 460             }</span>
<span class="line-removed"> 461             break;</span>
<span class="line-removed"> 462         case sun_java2d_pipe_BufferedOpCodes_DRAW_SCANLINES:</span>
<span class="line-removed"> 463             {</span>
<span class="line-removed"> 464                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
 465 
<span class="line-modified"> 466                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 467                     commitEncodedCommands();</span>
<span class="line-removed"> 468                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_SCANLINES in XOR mode - Force commit earlier draw calls before DRAW_SCANLINES.&quot;);</span>
 469                 }










 470 
<span class="line-modified"> 471                 jint count = NEXT_INT(b);</span>
<span class="line-modified"> 472                 MTLRenderer_DrawScanlines(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-modified"> 473 </span>
<span class="line-modified"> 474                 SKIP_BYTES(b, count * BYTES_PER_SCANLINE);</span>
<span class="line-modified"> 475             }</span>
<span class="line-modified"> 476             break;</span>
<span class="line-modified"> 477         case sun_java2d_pipe_BufferedOpCodes_DRAW_PARALLELOGRAM:</span>
<span class="line-modified"> 478             {</span>
<span class="line-modified"> 479                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 480 </span>
<span class="line-modified"> 481                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 482                     commitEncodedCommands();</span>
<span class="line-modified"> 483                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_PARALLELOGRAM in XOR mode - Force commit earlier draw calls before DRAW_PARALLELOGRAM.&quot;);</span>





















 484                 }
 485 
<span class="line-modified"> 486                 jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 487                 jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 488                 jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 489                 jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 490                 jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 491                 jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 492                 jfloat lwr21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 493                 jfloat lwr12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 494 </span>
<span class="line-removed"> 495                 MTLRenderer_DrawParallelogram(mtlc, dstOps,</span>
<span class="line-removed"> 496                                               x11, y11,</span>
<span class="line-removed"> 497                                               dx21, dy21,</span>
<span class="line-removed"> 498                                               dx12, dy12,</span>
<span class="line-removed"> 499                                               lwr21, lwr12);</span>
<span class="line-removed"> 500             }</span>
<span class="line-removed"> 501             break;</span>
<span class="line-removed"> 502         case sun_java2d_pipe_BufferedOpCodes_DRAW_AAPARALLELOGRAM:</span>
<span class="line-removed"> 503             {</span>
<span class="line-removed"> 504                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 505                 jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 506                 jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 507                 jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 508                 jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 509                 jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 510                 jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 511                 jfloat lwr21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 512                 jfloat lwr12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 513 </span>
<span class="line-removed"> 514                 MTLRenderer_DrawAAParallelogram(mtlc, dstOps,</span>
<span class="line-removed"> 515                                                 x11, y11,</span>
<span class="line-removed"> 516                                                 dx21, dy21,</span>
<span class="line-removed"> 517                                                 dx12, dy12,</span>
<span class="line-removed"> 518                                                 lwr21, lwr12);</span>
<span class="line-removed"> 519             }</span>
<span class="line-removed"> 520             break;</span>
 521 
<span class="line-modified"> 522         // fill ops</span>
<span class="line-modified"> 523         case sun_java2d_pipe_BufferedOpCodes_FILL_RECT:</span>
<span class="line-modified"> 524             {</span>
<span class="line-modified"> 525                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>

 526 
<span class="line-modified"> 527                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 528                     commitEncodedCommands();</span>
<span class="line-modified"> 529                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;FILL_RECT in XOR mode - Force commit earlier draw calls before FILL_RECT.&quot;);</span>



 530                 }









 531 
<span class="line-modified"> 532                 jint x = NEXT_INT(b);</span>
<span class="line-modified"> 533                 jint y = NEXT_INT(b);</span>
<span class="line-modified"> 534                 jint w = NEXT_INT(b);</span>
<span class="line-modified"> 535                 jint h = NEXT_INT(b);</span>
<span class="line-removed"> 536                 MTLRenderer_FillRect(mtlc, dstOps, x, y, w, h);</span>
<span class="line-removed"> 537             }</span>
<span class="line-removed"> 538             break;</span>
<span class="line-removed"> 539         case sun_java2d_pipe_BufferedOpCodes_FILL_SPANS:</span>
<span class="line-removed"> 540             {</span>
<span class="line-removed"> 541                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 542 </span>
<span class="line-removed"> 543                 if ([mtlc useXORComposite]) {</span>
<span class="line-removed"> 544                     commitEncodedCommands();</span>
<span class="line-removed"> 545                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;FILL_SPANS in XOR mode - Force commit earlier draw calls before FILL_SPANS.&quot;);</span>
 546                 }










 547 
<span class="line-modified"> 548                 jint count = NEXT_INT(b);</span>
<span class="line-modified"> 549                 MTLRenderer_FillSpans(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-modified"> 550                 SKIP_BYTES(b, count * BYTES_PER_SPAN);</span>
<span class="line-modified"> 551             }</span>
<span class="line-modified"> 552             break;</span>
<span class="line-modified"> 553         case sun_java2d_pipe_BufferedOpCodes_FILL_PARALLELOGRAM:</span>
<span class="line-modified"> 554             {</span>
<span class="line-modified"> 555                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 556 </span>
<span class="line-modified"> 557                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 558                     commitEncodedCommands();</span>
<span class="line-modified"> 559                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;FILL_PARALLELOGRAM in XOR mode - Force commit earlier draw calls before FILL_PARALLELOGRAM.&quot;);</span>














 560                 }
 561 
<span class="line-modified"> 562                 jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 563                 jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 564                 jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 565                 jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 566                 jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 567                 jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 568                 MTLRenderer_FillParallelogram(mtlc, dstOps,</span>
<span class="line-removed"> 569                                               x11, y11,</span>
<span class="line-removed"> 570                                               dx21, dy21,</span>
<span class="line-removed"> 571                                               dx12, dy12);</span>
<span class="line-removed"> 572             }</span>
<span class="line-removed"> 573             break;</span>
<span class="line-removed"> 574         case sun_java2d_pipe_BufferedOpCodes_FILL_AAPARALLELOGRAM:</span>
<span class="line-removed"> 575             {</span>
<span class="line-removed"> 576                 CHECK_PREVIOUS_OP(MTL_OP_AA);</span>
<span class="line-removed"> 577                 jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 578                 jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 579                 jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 580                 jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 581                 jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 582                 jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-removed"> 583                 MTLRenderer_FillAAParallelogram(mtlc, dstOps,</span>
<span class="line-removed"> 584                                                 x11, y11,</span>
<span class="line-removed"> 585                                                 dx21, dy21,</span>
<span class="line-removed"> 586                                                 dx12, dy12);</span>
<span class="line-removed"> 587             }</span>
<span class="line-removed"> 588             break;</span>
 589 
<span class="line-modified"> 590         // text-related ops</span>
<span class="line-modified"> 591         case sun_java2d_pipe_BufferedOpCodes_DRAW_GLYPH_LIST:</span>
<span class="line-modified"> 592             {</span>
<span class="line-modified"> 593                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>


 594 
<span class="line-modified"> 595                 if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 596                     commitEncodedCommands();</span>
<span class="line-modified"> 597                     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;DRAW_GLYPH_LIST in XOR mode - Force commit earlier draw calls before DRAW_GLYPH_LIST.&quot;);</span>


























 598                 }
 599 
<span class="line-modified"> 600                 jint numGlyphs        = NEXT_INT(b);</span>
<span class="line-modified"> 601                 jint packedParams     = NEXT_INT(b);</span>
<span class="line-modified"> 602                 jfloat glyphListOrigX = NEXT_FLOAT(b);</span>
<span class="line-modified"> 603                 jfloat glyphListOrigY = NEXT_FLOAT(b);</span>
<span class="line-modified"> 604                 jboolean usePositions = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 605                                                         OFFSET_POSITIONS);</span>
<span class="line-modified"> 606                 jboolean subPixPos    = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 607                                                         OFFSET_SUBPIXPOS);</span>
<span class="line-modified"> 608                 jboolean rgbOrder     = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 609                                                         OFFSET_RGBORDER);</span>
<span class="line-modified"> 610                 jint lcdContrast      = EXTRACT_BYTE(packedParams,</span>
<span class="line-modified"> 611                                                      OFFSET_CONTRAST);</span>
<span class="line-modified"> 612                 unsigned char *images = b;</span>
<span class="line-removed"> 613                 unsigned char *positions;</span>
<span class="line-removed"> 614                 jint bytesPerGlyph;</span>
<span class="line-removed"> 615                 if (usePositions) {</span>
<span class="line-removed"> 616                     positions = (b + numGlyphs * BYTES_PER_GLYPH_IMAGE);</span>
<span class="line-removed"> 617                     bytesPerGlyph = BYTES_PER_POSITIONED_GLYPH;</span>
<span class="line-removed"> 618                 } else {</span>
<span class="line-removed"> 619                     positions = NULL;</span>
<span class="line-removed"> 620                     bytesPerGlyph = BYTES_PER_GLYPH_IMAGE;</span>
 621                 }
<span class="line-modified"> 622                 MTLTR_DrawGlyphList(env, mtlc, dstOps,</span>
<span class="line-modified"> 623                                     numGlyphs, usePositions,</span>
<span class="line-modified"> 624                                     subPixPos, rgbOrder, lcdContrast,</span>
<span class="line-modified"> 625                                     glyphListOrigX, glyphListOrigY,</span>
<span class="line-modified"> 626                                     images, positions);</span>
<span class="line-modified"> 627                 SKIP_BYTES(b, numGlyphs * bytesPerGlyph);</span>
<span class="line-modified"> 628             }</span>
<span class="line-modified"> 629             break;</span>
<span class="line-modified"> 630 </span>
<span class="line-modified"> 631         // copy-related ops</span>
<span class="line-modified"> 632         case sun_java2d_pipe_BufferedOpCodes_COPY_AREA:</span>
<span class="line-modified"> 633             {</span>
<span class="line-modified"> 634                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 635                 jint x  = NEXT_INT(b);</span>
<span class="line-modified"> 636                 jint y  = NEXT_INT(b);</span>
<span class="line-modified"> 637                 jint w  = NEXT_INT(b);</span>
<span class="line-modified"> 638                 jint h  = NEXT_INT(b);</span>
<span class="line-modified"> 639                 jint dx = NEXT_INT(b);</span>
<span class="line-modified"> 640                 jint dy = NEXT_INT(b);</span>
<span class="line-modified"> 641                 MTLBlitLoops_CopyArea(env, mtlc, dstOps,</span>
<span class="line-modified"> 642                                       x, y, w, h, dx, dy);</span>
<span class="line-modified"> 643             }</span>
<span class="line-modified"> 644             break;</span>
<span class="line-modified"> 645         case sun_java2d_pipe_BufferedOpCodes_BLIT:</span>
<span class="line-modified"> 646             {</span>
<span class="line-modified"> 647                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 648                 jint packedParams = NEXT_INT(b);</span>
<span class="line-modified"> 649                 jint sx1          = NEXT_INT(b);</span>
<span class="line-modified"> 650                 jint sy1          = NEXT_INT(b);</span>
<span class="line-modified"> 651                 jint sx2          = NEXT_INT(b);</span>
<span class="line-modified"> 652                 jint sy2          = NEXT_INT(b);</span>
<span class="line-modified"> 653                 jdouble dx1       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 654                 jdouble dy1       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 655                 jdouble dx2       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 656                 jdouble dy2       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 657                 jlong pSrc        = NEXT_LONG(b);</span>
<span class="line-modified"> 658                 jlong pDst        = NEXT_LONG(b);</span>
<span class="line-modified"> 659                 jint hint         = EXTRACT_BYTE(packedParams, OFFSET_HINT);</span>
<span class="line-modified"> 660                 jboolean texture  = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 661                                                     OFFSET_TEXTURE);</span>
<span class="line-modified"> 662                 jboolean xform    = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 663                                                     OFFSET_XFORM);</span>
<span class="line-modified"> 664                 jboolean isoblit  = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 665                                                     OFFSET_ISOBLIT);</span>
<span class="line-modified"> 666                 if (isoblit) {</span>
<span class="line-modified"> 667                     MTLBlitLoops_IsoBlit(env, mtlc, pSrc, pDst,</span>
<span class="line-modified"> 668                                          xform, hint, texture,</span>
<span class="line-modified"> 669                                          sx1, sy1, sx2, sy2,</span>
<span class="line-modified"> 670                                          dx1, dy1, dx2, dy2);</span>
<span class="line-modified"> 671                 } else {</span>
<span class="line-modified"> 672                     jint srctype = EXTRACT_BYTE(packedParams, OFFSET_SRCTYPE);</span>
<span class="line-modified"> 673                     MTLBlitLoops_Blit(env, mtlc, pSrc, pDst,</span>
<span class="line-modified"> 674                                       xform, hint, srctype, texture,</span>
<span class="line-modified"> 675                                       sx1, sy1, sx2, sy2,</span>
<span class="line-modified"> 676                                       dx1, dy1, dx2, dy2);</span>

























 677                 }
<span class="line-removed"> 678             }</span>
<span class="line-removed"> 679             break;</span>
<span class="line-removed"> 680         case sun_java2d_pipe_BufferedOpCodes_SURFACE_TO_SW_BLIT:</span>
<span class="line-removed"> 681             {</span>
<span class="line-removed"> 682                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 683                 jint sx      = NEXT_INT(b);</span>
<span class="line-removed"> 684                 jint sy      = NEXT_INT(b);</span>
<span class="line-removed"> 685                 jint dx      = NEXT_INT(b);</span>
<span class="line-removed"> 686                 jint dy      = NEXT_INT(b);</span>
<span class="line-removed"> 687                 jint w       = NEXT_INT(b);</span>
<span class="line-removed"> 688                 jint h       = NEXT_INT(b);</span>
<span class="line-removed"> 689                 jint dsttype = NEXT_INT(b);</span>
<span class="line-removed"> 690                 jlong pSrc   = NEXT_LONG(b);</span>
<span class="line-removed"> 691                 jlong pDst   = NEXT_LONG(b);</span>
<span class="line-removed"> 692                 MTLBlitLoops_SurfaceToSwBlit(env, mtlc,</span>
<span class="line-removed"> 693                                              pSrc, pDst, dsttype,</span>
<span class="line-removed"> 694                                              sx, sy, dx, dy, w, h);</span>
<span class="line-removed"> 695             }</span>
<span class="line-removed"> 696             break;</span>
<span class="line-removed"> 697         case sun_java2d_pipe_BufferedOpCodes_MASK_FILL:</span>
<span class="line-removed"> 698             {</span>
<span class="line-removed"> 699                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 700                 jint x        = NEXT_INT(b);</span>
<span class="line-removed"> 701                 jint y        = NEXT_INT(b);</span>
<span class="line-removed"> 702                 jint w        = NEXT_INT(b);</span>
<span class="line-removed"> 703                 jint h        = NEXT_INT(b);</span>
<span class="line-removed"> 704                 jint maskoff  = NEXT_INT(b);</span>
<span class="line-removed"> 705                 jint maskscan = NEXT_INT(b);</span>
<span class="line-removed"> 706                 jint masklen  = NEXT_INT(b);</span>
<span class="line-removed"> 707                 unsigned char *pMask = (masklen &gt; 0) ? b : NULL;</span>
<span class="line-removed"> 708                 MTLMaskFill_MaskFill(mtlc, dstOps, x, y, w, h,</span>
<span class="line-removed"> 709                                      maskoff, maskscan, masklen, pMask);</span>
<span class="line-removed"> 710                 SKIP_BYTES(b, masklen);</span>
<span class="line-removed"> 711             }</span>
<span class="line-removed"> 712             break;</span>
<span class="line-removed"> 713         case sun_java2d_pipe_BufferedOpCodes_MASK_BLIT:</span>
<span class="line-removed"> 714             {</span>
<span class="line-removed"> 715                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 716                 jint dstx     = NEXT_INT(b);</span>
<span class="line-removed"> 717                 jint dsty     = NEXT_INT(b);</span>
<span class="line-removed"> 718                 jint width    = NEXT_INT(b);</span>
<span class="line-removed"> 719                 jint height   = NEXT_INT(b);</span>
<span class="line-removed"> 720                 jint masklen  = width * height * sizeof(jint);</span>
<span class="line-removed"> 721                 MTLMaskBlit_MaskBlit(env, mtlc, dstOps,</span>
<span class="line-removed"> 722                                      dstx, dsty, width, height, b);</span>
<span class="line-removed"> 723                 SKIP_BYTES(b, masklen);</span>
<span class="line-removed"> 724             }</span>
<span class="line-removed"> 725             break;</span>
<span class="line-removed"> 726 </span>
<span class="line-removed"> 727         // state-related ops</span>
<span class="line-removed"> 728         case sun_java2d_pipe_BufferedOpCodes_SET_RECT_CLIP:</span>
<span class="line-removed"> 729             {</span>
<span class="line-removed"> 730                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 731                 jint x1 = NEXT_INT(b);</span>
<span class="line-removed"> 732                 jint y1 = NEXT_INT(b);</span>
<span class="line-removed"> 733                 jint x2 = NEXT_INT(b);</span>
<span class="line-removed"> 734                 jint y2 = NEXT_INT(b);</span>
<span class="line-removed"> 735                 [mtlc setClipRectX1:x1 Y1:y1 X2:x2 Y2:y2];</span>
<span class="line-removed"> 736             }</span>
<span class="line-removed"> 737             break;</span>
<span class="line-removed"> 738         case sun_java2d_pipe_BufferedOpCodes_BEGIN_SHAPE_CLIP:</span>
<span class="line-removed"> 739             {</span>
<span class="line-removed"> 740                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 741                 [mtlc beginShapeClip:dstOps];</span>
<span class="line-removed"> 742             }</span>
<span class="line-removed"> 743             break;</span>
<span class="line-removed"> 744         case sun_java2d_pipe_BufferedOpCodes_SET_SHAPE_CLIP_SPANS:</span>
<span class="line-removed"> 745             {</span>
<span class="line-removed"> 746                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 747                 // This results in creation of new render encoder with</span>
<span class="line-removed"> 748                 // stencil buffer set as render target</span>
<span class="line-removed"> 749                 jint count = NEXT_INT(b);</span>
<span class="line-removed"> 750                 MTLRenderer_FillSpans(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-removed"> 751                 SKIP_BYTES(b, count * BYTES_PER_SPAN);</span>
<span class="line-removed"> 752             }</span>
<span class="line-removed"> 753             break;</span>
<span class="line-removed"> 754         case sun_java2d_pipe_BufferedOpCodes_END_SHAPE_CLIP:</span>
<span class="line-removed"> 755             {</span>
<span class="line-removed"> 756                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 757                 [mtlc endShapeClip:dstOps];</span>
<span class="line-removed"> 758             }</span>
<span class="line-removed"> 759             break;</span>
<span class="line-removed"> 760         case sun_java2d_pipe_BufferedOpCodes_RESET_CLIP:</span>
<span class="line-removed"> 761             {</span>
<span class="line-removed"> 762                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 763                 [mtlc resetClip];</span>
<span class="line-removed"> 764             }</span>
<span class="line-removed"> 765             break;</span>
<span class="line-removed"> 766         case sun_java2d_pipe_BufferedOpCodes_SET_ALPHA_COMPOSITE:</span>
<span class="line-removed"> 767             {</span>
<span class="line-removed"> 768                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 769                 jint rule         = NEXT_INT(b);</span>
<span class="line-removed"> 770                 jfloat extraAlpha = NEXT_FLOAT(b);</span>
<span class="line-removed"> 771                 jint flags        = NEXT_INT(b);</span>
<span class="line-removed"> 772                 [mtlc setAlphaCompositeRule:rule extraAlpha:extraAlpha flags:flags];</span>
<span class="line-removed"> 773             }</span>
<span class="line-removed"> 774             break;</span>
<span class="line-removed"> 775         case sun_java2d_pipe_BufferedOpCodes_SET_XOR_COMPOSITE:</span>
<span class="line-removed"> 776             {</span>
<span class="line-removed"> 777                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 778                 jint xorPixel = NEXT_INT(b);</span>
<span class="line-removed"> 779                 [mtlc setXorComposite:xorPixel];</span>
<span class="line-removed"> 780             }</span>
<span class="line-removed"> 781             break;</span>
<span class="line-removed"> 782         case sun_java2d_pipe_BufferedOpCodes_RESET_COMPOSITE:</span>
<span class="line-removed"> 783             {</span>
<span class="line-removed"> 784                 /* TODO: check whether something needs to be done here if we are moving out of XOR composite</span>
<span class="line-removed"> 785                 commitEncodedCommands();</span>
<span class="line-removed"> 786                 MTLCommandBufferWrapper * cbwrapper = [mtlc pullCommandBufferWrapper];</span>
<span class="line-removed"> 787                 [cbwrapper onComplete];</span>
 788 
<span class="line-modified"> 789                 J2dTraceLn(J2D_TRACE_VERBOSE, &quot;RESET_COMPOSITE - Force commit earlier draw calls before RESET_COMPOSITE.&quot;);*/</span>




























































 790 
<span class="line-modified"> 791                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 792                 [mtlc resetComposite];</span>
<span class="line-removed"> 793             }</span>
<span class="line-removed"> 794             break;</span>
<span class="line-removed"> 795         case sun_java2d_pipe_BufferedOpCodes_SET_TRANSFORM:</span>
<span class="line-removed"> 796             {</span>
<span class="line-removed"> 797                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 798                 jdouble m00 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 799                 jdouble m10 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 800                 jdouble m01 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 801                 jdouble m11 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 802                 jdouble m02 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 803                 jdouble m12 = NEXT_DOUBLE(b);</span>
<span class="line-removed"> 804                 [mtlc setTransformM00:m00 M10:m10 M01:m01 M11:m11 M02:m02 M12:m12];</span>
<span class="line-removed"> 805             }</span>
<span class="line-removed"> 806             break;</span>
<span class="line-removed"> 807         case sun_java2d_pipe_BufferedOpCodes_RESET_TRANSFORM:</span>
<span class="line-removed"> 808             {</span>
<span class="line-removed"> 809                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 810                 [mtlc resetTransform];</span>
<span class="line-removed"> 811             }</span>
<span class="line-removed"> 812             break;</span>
 813 
<span class="line-modified"> 814         // context-related ops</span>
<span class="line-modified"> 815         case sun_java2d_pipe_BufferedOpCodes_SET_SURFACES:</span>
<span class="line-modified"> 816             {</span>
<span class="line-modified"> 817                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 818                 jlong pSrc = NEXT_LONG(b);</span>
<span class="line-modified"> 819                 jlong pDst = NEXT_LONG(b);</span>
















 820 
<span class="line-modified"> 821                 dstOps = (BMTLSDOps *)jlong_to_ptr(pDst);</span>
<span class="line-modified"> 822                 mtlc = [MTLContext setSurfacesEnv:env src:pSrc dst:pDst];</span>
<span class="line-modified"> 823             }</span>
<span class="line-modified"> 824             break;</span>
<span class="line-modified"> 825         case sun_java2d_pipe_BufferedOpCodes_SET_SCRATCH_SURFACE:</span>
<span class="line-modified"> 826             {</span>
<span class="line-removed"> 827                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 828                 jlong pConfigInfo = NEXT_LONG(b);</span>
<span class="line-removed"> 829                 MTLGraphicsConfigInfo *mtlInfo =</span>
<span class="line-removed"> 830                         (MTLGraphicsConfigInfo *)jlong_to_ptr(pConfigInfo);</span>
 831 
<span class="line-modified"> 832                 if (mtlInfo == NULL) {</span>









 833 
<span class="line-modified"> 834                 } else {</span>
<span class="line-removed"> 835                     MTLContext *newMtlc = mtlInfo-&gt;context;</span>
<span class="line-removed"> 836                     if (newMtlc == NULL) {</span>
 837 
 838                     } else {
<span class="line-modified"> 839                         mtlc = newMtlc;</span>
<span class="line-modified"> 840                         dstOps = NULL;</span>





 841                     }

 842                 }
<span class="line-modified"> 843             }</span>
<span class="line-modified"> 844             break;</span>
<span class="line-modified"> 845         case sun_java2d_pipe_BufferedOpCodes_FLUSH_SURFACE:</span>
<span class="line-modified"> 846             {</span>
<span class="line-modified"> 847                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 848                 jlong pData = NEXT_LONG(b);</span>
<span class="line-modified"> 849                 BMTLSDOps *mtlsdo = (BMTLSDOps *)jlong_to_ptr(pData);</span>
<span class="line-modified"> 850                 if (mtlsdo != NULL) {</span>
<span class="line-modified"> 851                     CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 852                     MTLSD_Delete(env, mtlsdo);</span>
 853                 }
<span class="line-modified"> 854             }</span>
<span class="line-modified"> 855             break;</span>
<span class="line-modified"> 856         case sun_java2d_pipe_BufferedOpCodes_DISPOSE_SURFACE:</span>
<span class="line-modified"> 857             {</span>
<span class="line-modified"> 858                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 859                 jlong pData = NEXT_LONG(b);</span>
<span class="line-modified"> 860                 BMTLSDOps *mtlsdo = (BMTLSDOps *)jlong_to_ptr(pData);</span>
<span class="line-modified"> 861                 if (mtlsdo != NULL) {</span>
<span class="line-modified"> 862                     CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 863                     MTLSD_Delete(env, mtlsdo);</span>
<span class="line-modified"> 864                     if (mtlsdo-&gt;privOps != NULL) {</span>
<span class="line-removed"> 865                         free(mtlsdo-&gt;privOps);</span>
 866                     }





























 867                 }
<span class="line-removed"> 868             }</span>
<span class="line-removed"> 869             break;</span>
<span class="line-removed"> 870         case sun_java2d_pipe_BufferedOpCodes_DISPOSE_CONFIG:</span>
<span class="line-removed"> 871             {</span>
<span class="line-removed"> 872                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 873                 jlong pConfigInfo = NEXT_LONG(b);</span>
<span class="line-removed"> 874                 CONTINUE_IF_NULL(mtlc);</span>
<span class="line-removed"> 875                 MTLGC_DestroyMTLGraphicsConfig(pConfigInfo);</span>
<span class="line-removed"> 876 </span>
<span class="line-removed"> 877                 // the previous method will call glX/wglMakeCurrent(None),</span>
<span class="line-removed"> 878                 // so we should nullify the current mtlc and dstOps to avoid</span>
<span class="line-removed"> 879                 // calling glFlush() (or similar) while no context is current</span>
<span class="line-removed"> 880                 mtlc = NULL;</span>
<span class="line-removed"> 881              //   dstOps = NULL;</span>
<span class="line-removed"> 882             }</span>
<span class="line-removed"> 883             break;</span>
<span class="line-removed"> 884         case sun_java2d_pipe_BufferedOpCodes_INVALIDATE_CONTEXT:</span>
<span class="line-removed"> 885             {</span>
<span class="line-removed"> 886                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-removed"> 887                 // invalidate the references to the current context and</span>
<span class="line-removed"> 888                 // destination surface that are maintained at the native level</span>
<span class="line-removed"> 889                 mtlc = NULL;</span>
<span class="line-removed"> 890             //    dstOps = NULL;</span>
<span class="line-removed"> 891             }</span>
<span class="line-removed"> 892             break;</span>
<span class="line-removed"> 893         case sun_java2d_pipe_BufferedOpCodes_SYNC:</span>
<span class="line-removed"> 894             {</span>
<span class="line-removed"> 895                 CHECK_PREVIOUS_OP(MTL_OP_SYNC);</span>
<span class="line-removed"> 896             }</span>
<span class="line-removed"> 897             break;</span>
 898 
<span class="line-modified"> 899         // multibuffering ops</span>
<span class="line-modified"> 900         case sun_java2d_pipe_BufferedOpCodes_SWAP_BUFFERS:</span>
<span class="line-modified"> 901             {</span>
<span class="line-modified"> 902                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 903                 jlong window = NEXT_LONG(b);</span>
<span class="line-modified"> 904                 MTLSD_SwapBuffers(env, window);</span>
<span class="line-modified"> 905             }</span>
<span class="line-modified"> 906             break;</span>
 907 
<span class="line-modified"> 908         // special no-op (mainly used for achieving 8-byte alignment)</span>
<span class="line-modified"> 909         case sun_java2d_pipe_BufferedOpCodes_NOOP:</span>
<span class="line-modified"> 910             break;</span>
 911 
<span class="line-modified"> 912         // paint-related ops</span>
<span class="line-modified"> 913         case sun_java2d_pipe_BufferedOpCodes_RESET_PAINT:</span>
<span class="line-modified"> 914             {</span>
<span class="line-modified"> 915               CHECK_PREVIOUS_OP(MTL_OP_RESET_PAINT);</span>
<span class="line-modified"> 916               [mtlc resetPaint];</span>
<span class="line-modified"> 917             }</span>
<span class="line-modified"> 918             break;</span>
<span class="line-modified"> 919         case sun_java2d_pipe_BufferedOpCodes_SET_COLOR:</span>
<span class="line-modified"> 920             {</span>
<span class="line-modified"> 921                 CHECK_PREVIOUS_OP(MTL_OP_SET_COLOR);</span>
<span class="line-modified"> 922                 jint pixel = NEXT_INT(b);</span>
<span class="line-modified"> 923                 [mtlc setColorPaint:pixel];</span>
<span class="line-modified"> 924             }</span>
<span class="line-modified"> 925             break;</span>
<span class="line-modified"> 926         case sun_java2d_pipe_BufferedOpCodes_SET_GRADIENT_PAINT:</span>
<span class="line-modified"> 927             {</span>
<span class="line-modified"> 928                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 929                 jboolean useMask= NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 930                 jboolean cyclic = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 931                 jdouble p0      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 932                 jdouble p1      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 933                 jdouble p3      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 934                 jint pixel1     = NEXT_INT(b);</span>
<span class="line-modified"> 935                 jint pixel2     = NEXT_INT(b);</span>
<span class="line-modified"> 936                 [mtlc setGradientPaintUseMask:useMask</span>
<span class="line-modified"> 937                                     cyclic:cyclic</span>
<span class="line-modified"> 938                                         p0:p0</span>
<span class="line-modified"> 939                                         p1:p1</span>
<span class="line-modified"> 940                                         p3:p3</span>
<span class="line-modified"> 941                                     pixel1:pixel1</span>
<span class="line-modified"> 942                                     pixel2:pixel2];</span>
<span class="line-modified"> 943             }</span>
<span class="line-modified"> 944             break;</span>
<span class="line-modified"> 945         case sun_java2d_pipe_BufferedOpCodes_SET_LINEAR_GRADIENT_PAINT:</span>
<span class="line-modified"> 946             {</span>
<span class="line-modified"> 947                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 948                 jboolean useMask = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 949                 jboolean linear  = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 950                 jint cycleMethod = NEXT_INT(b);</span>
<span class="line-modified"> 951                 jint numStops    = NEXT_INT(b);</span>
<span class="line-modified"> 952                 jfloat p0        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 953                 jfloat p1        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 954                 jfloat p3        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 955                 void *fractions, *pixels;</span>
<span class="line-modified"> 956                 fractions = b; SKIP_BYTES(b, numStops * sizeof(jfloat));</span>
<span class="line-modified"> 957                 pixels    = b; SKIP_BYTES(b, numStops * sizeof(jint));</span>
<span class="line-modified"> 958                 [mtlc setLinearGradientPaint:useMask</span>
<span class="line-modified"> 959                                       linear:linear</span>
<span class="line-modified"> 960                                  cycleMethod:cycleMethod</span>
<span class="line-modified"> 961                                     numStops:numStops</span>
<span class="line-modified"> 962                                           p0:p0</span>
<span class="line-modified"> 963                                           p1:p1</span>
<span class="line-modified"> 964                                           p3:p3</span>
<span class="line-modified"> 965                                    fractions:fractions</span>
<span class="line-modified"> 966                                       pixels:pixels];</span>
<span class="line-modified"> 967             }</span>
<span class="line-modified"> 968             break;</span>
<span class="line-modified"> 969         case sun_java2d_pipe_BufferedOpCodes_SET_RADIAL_GRADIENT_PAINT:</span>
<span class="line-modified"> 970             {</span>
<span class="line-modified"> 971                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 972                 jboolean useMask = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 973                 jboolean linear  = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 974                 jint numStops    = NEXT_INT(b);</span>
<span class="line-modified"> 975                 jint cycleMethod = NEXT_INT(b);</span>
<span class="line-modified"> 976                 jfloat m00       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 977                 jfloat m01       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 978                 jfloat m02       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 979                 jfloat m10       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 980                 jfloat m11       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 981                 jfloat m12       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 982                 jfloat focusX    = NEXT_FLOAT(b);</span>
<span class="line-modified"> 983                 void *fractions, *pixels;</span>
<span class="line-modified"> 984                 fractions = b; SKIP_BYTES(b, numStops * sizeof(jfloat));</span>
<span class="line-modified"> 985                 pixels    = b; SKIP_BYTES(b, numStops * sizeof(jint));</span>
<span class="line-modified"> 986                 [mtlc setRadialGradientPaint:useMask</span>
<span class="line-modified"> 987                                       linear:linear</span>
<span class="line-modified"> 988                                  cycleMethod:cycleMethod</span>
<span class="line-modified"> 989                                     numStops:numStops</span>
<span class="line-modified"> 990                                          m00:m00</span>
<span class="line-modified"> 991                                          m01:m01</span>
<span class="line-modified"> 992                                          m02:m02</span>
<span class="line-modified"> 993                                          m10:m10</span>
<span class="line-modified"> 994                                          m11:m11</span>
<span class="line-modified"> 995                                          m12:m12</span>
<span class="line-modified"> 996                                       focusX:focusX</span>
<span class="line-modified"> 997                                    fractions:fractions</span>
<span class="line-modified"> 998                                       pixels:pixels];</span>
<span class="line-modified"> 999             }</span>
<span class="line-modified">1000             break;</span>
<span class="line-modified">1001         case sun_java2d_pipe_BufferedOpCodes_SET_TEXTURE_PAINT:</span>
<span class="line-modified">1002             {</span>
<span class="line-modified">1003                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1004                 jboolean useMask= NEXT_BOOLEAN(b);</span>
<span class="line-modified">1005                 jboolean filter = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1006                 jlong pSrc      = NEXT_LONG(b);</span>
<span class="line-modified">1007                 jdouble xp0     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1008                 jdouble xp1     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1009                 jdouble xp3     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1010                 jdouble yp0     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1011                 jdouble yp1     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1012                 jdouble yp3     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1013                 [mtlc setTexturePaint:useMask</span>
<span class="line-modified">1014                               pSrcOps:pSrc</span>
<span class="line-modified">1015                                filter:filter</span>
<span class="line-modified">1016                                   xp0:xp0</span>
<span class="line-modified">1017                                   xp1:xp1</span>
<span class="line-modified">1018                                   xp3:xp3</span>
<span class="line-modified">1019                                   yp0:yp0</span>
<span class="line-modified">1020                                   yp1:yp1</span>
<span class="line-modified">1021                                   yp3:yp3];</span>
<span class="line-modified">1022             }</span>
<span class="line-modified">1023             break;</span>
1024 
<span class="line-modified">1025         // BufferedImageOp-related ops</span>
<span class="line-modified">1026         case sun_java2d_pipe_BufferedOpCodes_ENABLE_CONVOLVE_OP:</span>
<span class="line-modified">1027             {</span>
<span class="line-modified">1028                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1029                 jlong pSrc        = NEXT_LONG(b);</span>
<span class="line-modified">1030                 jboolean edgeZero = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1031                 jint kernelWidth  = NEXT_INT(b);</span>
<span class="line-modified">1032                 jint kernelHeight = NEXT_INT(b);</span>
<span class="line-modified">1033 </span>
<span class="line-modified">1034                 BMTLSDOps * bmtlsdOps = (BMTLSDOps *)pSrc;</span>
<span class="line-modified">1035                 MTLConvolveOp * convolveOp = [[MTLConvolveOp alloc] init:edgeZero</span>
<span class="line-modified">1036                         kernelWidth:kernelWidth</span>
<span class="line-modified">1037                        kernelHeight:kernelHeight</span>
<span class="line-modified">1038                            srcWidth:bmtlsdOps-&gt;width</span>
<span class="line-modified">1039                           srcHeight:bmtlsdOps-&gt;height</span>
<span class="line-modified">1040                              kernel:b</span>
<span class="line-modified">1041                              device:mtlc.device</span>
<span class="line-modified">1042                                               ];</span>
<span class="line-modified">1043                 [mtlc setBufImgOp:convolveOp];</span>
<span class="line-modified">1044                 SKIP_BYTES(b, kernelWidth * kernelHeight * sizeof(jfloat));</span>
<span class="line-modified">1045             }</span>
<span class="line-modified">1046             break;</span>
<span class="line-modified">1047         case sun_java2d_pipe_BufferedOpCodes_DISABLE_CONVOLVE_OP:</span>
<span class="line-modified">1048             {</span>
<span class="line-modified">1049                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1050                 [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1051             }</span>
<span class="line-modified">1052             break;</span>
<span class="line-modified">1053         case sun_java2d_pipe_BufferedOpCodes_ENABLE_RESCALE_OP:</span>
<span class="line-modified">1054             {</span>
<span class="line-modified">1055                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1056                 jlong pSrc          = NEXT_LONG(b);</span>
<span class="line-modified">1057                 jboolean nonPremult = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1058                 jint numFactors     = 4;</span>
<span class="line-modified">1059                 unsigned char *scaleFactors = b;</span>
<span class="line-modified">1060                 unsigned char *offsets = (b + numFactors * sizeof(jfloat));</span>
<span class="line-modified">1061                 MTLRescaleOp * rescaleOp = [[MTLRescaleOp alloc] init:nonPremult factors:scaleFactors offsets:offsets];</span>
<span class="line-modified">1062                 [mtlc setBufImgOp:rescaleOp];</span>
<span class="line-modified">1063                 SKIP_BYTES(b, numFactors * sizeof(jfloat) * 2);</span>
<span class="line-modified">1064             }</span>
<span class="line-modified">1065             break;</span>
<span class="line-modified">1066         case sun_java2d_pipe_BufferedOpCodes_DISABLE_RESCALE_OP:</span>
<span class="line-modified">1067             {</span>
<span class="line-modified">1068                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1069                 [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1070             }</span>
<span class="line-modified">1071             break;</span>
<span class="line-modified">1072         case sun_java2d_pipe_BufferedOpCodes_ENABLE_LOOKUP_OP:</span>
<span class="line-modified">1073             {</span>
<span class="line-modified">1074                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1075                 jlong pSrc          = NEXT_LONG(b);</span>
<span class="line-modified">1076                 jboolean nonPremult = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1077                 jboolean shortData  = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1078                 jint numBands       = NEXT_INT(b);</span>
<span class="line-modified">1079                 jint bandLength     = NEXT_INT(b);</span>
<span class="line-modified">1080                 jint offset         = NEXT_INT(b);</span>
<span class="line-modified">1081                 jint bytesPerElem = shortData ? sizeof(jshort):sizeof(jbyte);</span>
<span class="line-modified">1082                 void *tableValues = b;</span>
<span class="line-modified">1083 </span>
<span class="line-modified">1084                 MTLLookupOp * lookupOp = [[MTLLookupOp alloc] init:nonPremult</span>
<span class="line-modified">1085                                                          shortData:shortData</span>
<span class="line-modified">1086                                                           numBands:numBands</span>
<span class="line-modified">1087                                                         bandLength:bandLength</span>
<span class="line-modified">1088                                                             offset:offset</span>
<span class="line-modified">1089                                                        tableValues:tableValues</span>
<span class="line-modified">1090                                                             device:mtlc.device];</span>
<span class="line-modified">1091                 [mtlc setBufImgOp:lookupOp];</span>
<span class="line-modified">1092                 SKIP_BYTES(b, numBands * bandLength * bytesPerElem);</span>
<span class="line-modified">1093             }</span>
<span class="line-modified">1094             break;</span>
<span class="line-modified">1095         case sun_java2d_pipe_BufferedOpCodes_DISABLE_LOOKUP_OP:</span>
<span class="line-modified">1096             {</span>
<span class="line-modified">1097                 CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1098                 [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1099             }</span>
<span class="line-modified">1100             break;</span>

1101 
<span class="line-modified">1102         default:</span>
<span class="line-modified">1103             J2dRlsTraceLn1(J2D_TRACE_ERROR,</span>
<span class="line-modified">1104                 &quot;MTLRenderQueue_flushBuffer: invalid opcode=%d&quot;, opcode);</span>
<span class="line-modified">1105             return;</span>

1106         }
<span class="line-removed">1107     }</span>
1108 
<span class="line-modified">1109     if (mtlc != NULL) {</span>
<span class="line-modified">1110         [mtlc.encoderManager endEncoder];</span>
<span class="line-modified">1111         MTLCommandBufferWrapper * cbwrapper = [mtlc pullCommandBufferWrapper];</span>
<span class="line-modified">1112         id&lt;MTLCommandBuffer&gt; commandbuf = [cbwrapper getCommandBuffer];</span>
<span class="line-modified">1113         [commandbuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandbuf) {</span>
<span class="line-modified">1114             [cbwrapper release];</span>
<span class="line-modified">1115         }];</span>
<span class="line-modified">1116         [commandbuf commit];</span>
<span class="line-modified">1117         BMTLSDOps *dstOps = MTLRenderQueue_GetCurrentDestination();</span>
<span class="line-modified">1118         if (dstOps != NULL) {</span>
<span class="line-modified">1119             MTLSDOps *dstMTLOps = (MTLSDOps *)dstOps-&gt;privOps;</span>
<span class="line-modified">1120             MTLLayer *layer = (MTLLayer*)dstMTLOps-&gt;layer;</span>
<span class="line-modified">1121             if (layer != NULL) {</span>
<span class="line-modified">1122                 [JNFRunLoop performOnMainThreadWaiting:NO withBlock:^(){</span>
<span class="line-modified">1123                     AWT_ASSERT_APPKIT_THREAD;</span>
<span class="line-modified">1124                     [layer setNeedsDisplay];</span>
<span class="line-modified">1125                 }];</span>

1126             }
1127         }

1128     }
<span class="line-removed">1129     RESET_PREVIOUS_OP();</span>
1130 }
1131 
1132 /**
1133  * Returns a pointer to the &quot;current&quot; context, as set by the last SET_SURFACES
1134  * or SET_SCRATCH_SURFACE operation.
1135  */
1136 MTLContext *
1137 MTLRenderQueue_GetCurrentContext()
1138 {
1139     return mtlc;
1140 }
1141 
1142 /**
1143  * Returns a pointer to the &quot;current&quot; destination surface, as set by the last
1144  * SET_SURFACES operation.
1145  */
1146 BMTLSDOps *
1147 MTLRenderQueue_GetCurrentDestination()
1148 {
1149     return dstOps;
</pre>
</td>
<td>
<hr />
<pre>
 346 }
 347 
 348 JNIEXPORT void JNICALL
 349 Java_sun_java2d_metal_MTLRenderQueue_flushBuffer
 350     (JNIEnv *env, jobject mtlrq,
 351      jlong buf, jint limit)
 352 {
 353     unsigned char *b, *end;
 354 
 355     J2dTraceLn1(J2D_TRACE_INFO,
 356                 &quot;MTLRenderQueue_flushBuffer: limit=%d&quot;, limit);
 357 
 358     b = (unsigned char *)jlong_to_ptr(buf);
 359     if (b == NULL) {
 360         J2dRlsTraceLn(J2D_TRACE_ERROR,
 361             &quot;MTLRenderQueue_flushBuffer: cannot get direct buffer address&quot;);
 362         return;
 363     }
 364 
 365     end = b + limit;
<span class="line-modified"> 366     @autoreleasepool {</span>
<span class="line-modified"> 367         jboolean DEBUG_LOG = JNI_FALSE;</span>
<span class="line-modified"> 368         while (b &lt; end) {</span>
<span class="line-modified"> 369             jint opcode = NEXT_INT(b);</span>
<span class="line-modified"> 370 </span>
<span class="line-modified"> 371             if (DEBUG_LOG) {</span>
<span class="line-modified"> 372                 J2dTraceLn2(J2D_TRACE_ERROR,</span>
<span class="line-modified"> 373                         &quot;MTLRenderQueue_flushBuffer: opcode_name = %s, rem=%d&quot;,</span>
<span class="line-modified"> 374                         getOpcodeString(opcode), (end-b));</span>
<span class="line-modified"> 375             } else {</span>
<span class="line-modified"> 376                 J2dTraceLn2(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 377                         &quot;MTLRenderQueue_flushBuffer: opcode=%d, rem=%d&quot;,</span>
<span class="line-modified"> 378                         opcode, (end-b));</span>
<span class="line-modified"> 379             }</span>
<span class="line-modified"> 380 </span>
<span class="line-modified"> 381             switch (opcode) {</span>
<span class="line-modified"> 382 </span>
<span class="line-modified"> 383                 // draw ops</span>
<span class="line-modified"> 384                 case sun_java2d_pipe_BufferedOpCodes_DRAW_LINE:</span>
<span class="line-modified"> 385                 {</span>
<span class="line-modified"> 386                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 387 </span>
<span class="line-modified"> 388                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 389                         commitEncodedCommands();</span>
<span class="line-modified"> 390                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 391                                    &quot;DRAW_LINE in XOR mode - Force commit earlier draw calls before DRAW_LINE.&quot;);</span>
<span class="line-added"> 392                     }</span>
<span class="line-added"> 393                     jint x1 = NEXT_INT(b);</span>
<span class="line-added"> 394                     jint y1 = NEXT_INT(b);</span>
<span class="line-added"> 395                     jint x2 = NEXT_INT(b);</span>
<span class="line-added"> 396                     jint y2 = NEXT_INT(b);</span>
<span class="line-added"> 397                     MTLRenderer_DrawLine(mtlc, dstOps, x1, y1, x2, y2);</span>
<span class="line-added"> 398                     break;</span>
 399                 }
<span class="line-modified"> 400                 case sun_java2d_pipe_BufferedOpCodes_DRAW_RECT:</span>
<span class="line-modified"> 401                 {</span>
<span class="line-modified"> 402                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 403 </span>
<span class="line-modified"> 404                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 405                         commitEncodedCommands();</span>
<span class="line-modified"> 406                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 407                                    &quot;DRAW_RECT in XOR mode - Force commit earlier draw calls before DRAW_RECT.&quot;);</span>
<span class="line-modified"> 408                     }</span>
<span class="line-modified"> 409                     jint x = NEXT_INT(b);</span>
<span class="line-modified"> 410                     jint y = NEXT_INT(b);</span>
<span class="line-modified"> 411                     jint w = NEXT_INT(b);</span>
<span class="line-modified"> 412                     jint h = NEXT_INT(b);</span>
<span class="line-modified"> 413                     MTLRenderer_DrawRect(mtlc, dstOps, x, y, w, h);</span>
<span class="line-added"> 414                     break;</span>
 415                 }
<span class="line-modified"> 416                 case sun_java2d_pipe_BufferedOpCodes_DRAW_POLY:</span>
<span class="line-modified"> 417                 {</span>
<span class="line-modified"> 418                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 419                     jint nPoints      = NEXT_INT(b);</span>
<span class="line-modified"> 420                     jboolean isClosed = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 421                     jint transX       = NEXT_INT(b);</span>
<span class="line-modified"> 422                     jint transY       = NEXT_INT(b);</span>
<span class="line-modified"> 423                     jint *xPoints = (jint *)b;</span>
<span class="line-modified"> 424                     jint *yPoints = ((jint *)b) + nPoints;</span>
<span class="line-modified"> 425 </span>
<span class="line-modified"> 426                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 427                         commitEncodedCommands();</span>
<span class="line-modified"> 428                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 429                                    &quot;DRAW_POLY in XOR mode - Force commit earlier draw calls before DRAW_POLY.&quot;);</span>
<span class="line-modified"> 430 </span>
<span class="line-modified"> 431                         // draw separate (N-1) lines using N points</span>
<span class="line-modified"> 432                         for(int point = 0; point &lt; nPoints-1; point++) {</span>
<span class="line-modified"> 433                             jint x1 = xPoints[point] + transX;</span>
<span class="line-modified"> 434                             jint y1 = yPoints[point] + transY;</span>
<span class="line-modified"> 435                             jint x2 = xPoints[point + 1] + transX;</span>
<span class="line-modified"> 436                             jint y2 = yPoints[point + 1] + transY;</span>
<span class="line-modified"> 437                             MTLRenderer_DrawLine(mtlc, dstOps, x1, y1, x2, y2);</span>
<span class="line-modified"> 438                         }</span>
<span class="line-modified"> 439 </span>
<span class="line-modified"> 440                         if (isClosed) {</span>
<span class="line-modified"> 441                             MTLRenderer_DrawLine(mtlc, dstOps, xPoints[0] + transX, yPoints[0] + transY,</span>
<span class="line-modified"> 442                                                  xPoints[nPoints-1] + transX, yPoints[nPoints-1] + transY);</span>
<span class="line-modified"> 443                         }</span>
<span class="line-added"> 444                     } else {</span>
<span class="line-added"> 445                         MTLRenderer_DrawPoly(mtlc, dstOps, nPoints, isClosed, transX, transY, xPoints, yPoints);</span>
 446                     }
 447 
<span class="line-modified"> 448                     SKIP_BYTES(b, nPoints * BYTES_PER_POLY_POINT);</span>
<span class="line-modified"> 449                     break;</span>



 450                 }
<span class="line-added"> 451                 case sun_java2d_pipe_BufferedOpCodes_DRAW_PIXEL:</span>
<span class="line-added"> 452                 {</span>
<span class="line-added"> 453                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 454 </span>
<span class="line-added"> 455                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 456                         commitEncodedCommands();</span>
<span class="line-added"> 457                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 458                                    &quot;DRAW_PIXEL in XOR mode - Force commit earlier draw calls before DRAW_PIXEL.&quot;);</span>
<span class="line-added"> 459                     }</span>
 460 
<span class="line-modified"> 461                     jint x = NEXT_INT(b);</span>
<span class="line-modified"> 462                     jint y = NEXT_INT(b);</span>
<span class="line-modified"> 463                     CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 464                     MTLRenderer_DrawPixel(mtlc, dstOps, x, y);</span>
<span class="line-modified"> 465                     break;</span>





 466                 }
<span class="line-added"> 467                 case sun_java2d_pipe_BufferedOpCodes_DRAW_SCANLINES:</span>
<span class="line-added"> 468                 {</span>
<span class="line-added"> 469                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 470 </span>
<span class="line-added"> 471                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 472                         commitEncodedCommands();</span>
<span class="line-added"> 473                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 474                                    &quot;DRAW_SCANLINES in XOR mode - Force commit earlier draw calls before &quot;</span>
<span class="line-added"> 475                                    &quot;DRAW_SCANLINES.&quot;);</span>
<span class="line-added"> 476                     }</span>
 477 
<span class="line-modified"> 478                     jint count = NEXT_INT(b);</span>
<span class="line-modified"> 479                     MTLRenderer_DrawScanlines(mtlc, dstOps, count, (jint *)b);</span>







 480 
<span class="line-modified"> 481                     SKIP_BYTES(b, count * BYTES_PER_SCANLINE);</span>
<span class="line-modified"> 482                     break;</span>

 483                 }
<span class="line-added"> 484                 case sun_java2d_pipe_BufferedOpCodes_DRAW_PARALLELOGRAM:</span>
<span class="line-added"> 485                 {</span>
<span class="line-added"> 486                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 487 </span>
<span class="line-added"> 488                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 489                         commitEncodedCommands();</span>
<span class="line-added"> 490                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 491                                    &quot;DRAW_PARALLELOGRAM in XOR mode - Force commit earlier draw calls before &quot;</span>
<span class="line-added"> 492                                    &quot;DRAW_PARALLELOGRAM.&quot;);</span>
<span class="line-added"> 493                     }</span>
 494 
<span class="line-modified"> 495                     jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 496                     jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 497                     jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 498                     jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 499                     jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 500                     jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 501                     jfloat lwr21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 502                     jfloat lwr12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 503 </span>
<span class="line-modified"> 504                     MTLRenderer_DrawParallelogram(mtlc, dstOps,</span>
<span class="line-modified"> 505                                                   x11, y11,</span>
<span class="line-modified"> 506                                                   dx21, dy21,</span>
<span class="line-modified"> 507                                                   dx12, dy12,</span>
<span class="line-added"> 508                                                   lwr21, lwr12);</span>
<span class="line-added"> 509                     break;</span>
<span class="line-added"> 510                 }</span>
<span class="line-added"> 511                 case sun_java2d_pipe_BufferedOpCodes_DRAW_AAPARALLELOGRAM:</span>
<span class="line-added"> 512                 {</span>
<span class="line-added"> 513                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 514                     jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-added"> 515                     jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-added"> 516                     jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 517                     jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 518                     jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 519                     jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 520                     jfloat lwr21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 521                     jfloat lwr12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 522 </span>
<span class="line-added"> 523                     MTLRenderer_DrawAAParallelogram(mtlc, dstOps,</span>
<span class="line-added"> 524                                                     x11, y11,</span>
<span class="line-added"> 525                                                     dx21, dy21,</span>
<span class="line-added"> 526                                                     dx12, dy12,</span>
<span class="line-added"> 527                                                     lwr21, lwr12);</span>
<span class="line-added"> 528                     break;</span>
 529                 }
 530 
<span class="line-modified"> 531                 // fill ops</span>
<span class="line-modified"> 532                 case sun_java2d_pipe_BufferedOpCodes_FILL_RECT:</span>
<span class="line-modified"> 533                 {</span>
<span class="line-modified"> 534                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>































 535 
<span class="line-modified"> 536                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 537                         commitEncodedCommands();</span>
<span class="line-modified"> 538                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 539                                    &quot;FILL_RECT in XOR mode - Force commit earlier draw calls before FILL_RECT.&quot;);</span>
<span class="line-added"> 540                     }</span>
 541 
<span class="line-modified"> 542                     jint x = NEXT_INT(b);</span>
<span class="line-modified"> 543                     jint y = NEXT_INT(b);</span>
<span class="line-modified"> 544                     jint w = NEXT_INT(b);</span>
<span class="line-added"> 545                     jint h = NEXT_INT(b);</span>
<span class="line-added"> 546                     MTLRenderer_FillRect(mtlc, dstOps, x, y, w, h);</span>
<span class="line-added"> 547                     break;</span>
 548                 }
<span class="line-added"> 549                 case sun_java2d_pipe_BufferedOpCodes_FILL_SPANS:</span>
<span class="line-added"> 550                 {</span>
<span class="line-added"> 551                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 552 </span>
<span class="line-added"> 553                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 554                         commitEncodedCommands();</span>
<span class="line-added"> 555                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 556                                    &quot;FILL_SPANS in XOR mode - Force commit earlier draw calls before FILL_SPANS.&quot;);</span>
<span class="line-added"> 557                     }</span>
 558 
<span class="line-modified"> 559                     jint count = NEXT_INT(b);</span>
<span class="line-modified"> 560                     MTLRenderer_FillSpans(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-modified"> 561                     SKIP_BYTES(b, count * BYTES_PER_SPAN);</span>
<span class="line-modified"> 562                     break;</span>










 563                 }
<span class="line-added"> 564                 case sun_java2d_pipe_BufferedOpCodes_FILL_PARALLELOGRAM:</span>
<span class="line-added"> 565                 {</span>
<span class="line-added"> 566                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 567 </span>
<span class="line-added"> 568                     if ([mtlc useXORComposite]) {</span>
<span class="line-added"> 569                         commitEncodedCommands();</span>
<span class="line-added"> 570                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-added"> 571                                    &quot;FILL_PARALLELOGRAM in XOR mode - Force commit earlier draw calls before &quot;</span>
<span class="line-added"> 572                                    &quot;FILL_PARALLELOGRAM.&quot;);</span>
<span class="line-added"> 573                     }</span>
 574 
<span class="line-modified"> 575                     jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 576                     jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 577                     jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 578                     jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 579                     jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 580                     jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-modified"> 581                     MTLRenderer_FillParallelogram(mtlc, dstOps,</span>
<span class="line-modified"> 582                                                   x11, y11,</span>
<span class="line-modified"> 583                                                   dx21, dy21,</span>
<span class="line-modified"> 584                                                   dx12, dy12);</span>
<span class="line-modified"> 585                     break;</span>
<span class="line-modified"> 586                 }</span>
<span class="line-added"> 587                 case sun_java2d_pipe_BufferedOpCodes_FILL_AAPARALLELOGRAM:</span>
<span class="line-added"> 588                 {</span>
<span class="line-added"> 589                     CHECK_PREVIOUS_OP(MTL_OP_AA);</span>
<span class="line-added"> 590                     jfloat x11 = NEXT_FLOAT(b);</span>
<span class="line-added"> 591                     jfloat y11 = NEXT_FLOAT(b);</span>
<span class="line-added"> 592                     jfloat dx21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 593                     jfloat dy21 = NEXT_FLOAT(b);</span>
<span class="line-added"> 594                     jfloat dx12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 595                     jfloat dy12 = NEXT_FLOAT(b);</span>
<span class="line-added"> 596                     MTLRenderer_FillAAParallelogram(mtlc, dstOps,</span>
<span class="line-added"> 597                                                     x11, y11,</span>
<span class="line-added"> 598                                                     dx21, dy21,</span>
<span class="line-added"> 599                                                     dx12, dy12);</span>
<span class="line-added"> 600                     break;</span>
 601                 }
 602 
<span class="line-modified"> 603                 // text-related ops</span>
<span class="line-modified"> 604                 case sun_java2d_pipe_BufferedOpCodes_DRAW_GLYPH_LIST:</span>
<span class="line-modified"> 605                 {</span>
<span class="line-modified"> 606                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>























 607 
<span class="line-modified"> 608                     if ([mtlc useXORComposite]) {</span>
<span class="line-modified"> 609                         commitEncodedCommands();</span>
<span class="line-modified"> 610                         J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 611                                    &quot;DRAW_GLYPH_LIST in XOR mode - Force commit earlier draw calls before &quot;</span>
<span class="line-added"> 612                                    &quot;DRAW_GLYPH_LIST.&quot;);</span>
<span class="line-added"> 613                     }</span>
 614 
<span class="line-modified"> 615                     jint numGlyphs        = NEXT_INT(b);</span>
<span class="line-modified"> 616                     jint packedParams     = NEXT_INT(b);</span>
<span class="line-modified"> 617                     jfloat glyphListOrigX = NEXT_FLOAT(b);</span>
<span class="line-added"> 618                     jfloat glyphListOrigY = NEXT_FLOAT(b);</span>
<span class="line-added"> 619                     jboolean usePositions = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-added"> 620                                                             OFFSET_POSITIONS);</span>
<span class="line-added"> 621                     jboolean subPixPos    = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-added"> 622                                                             OFFSET_SUBPIXPOS);</span>
<span class="line-added"> 623                     jboolean rgbOrder     = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-added"> 624                                                             OFFSET_RGBORDER);</span>
<span class="line-added"> 625                     jint lcdContrast      = EXTRACT_BYTE(packedParams,</span>
<span class="line-added"> 626                                                          OFFSET_CONTRAST);</span>
<span class="line-added"> 627                     unsigned char *images = b;</span>
<span class="line-added"> 628                     unsigned char *positions;</span>
<span class="line-added"> 629                     jint bytesPerGlyph;</span>
<span class="line-added"> 630                     if (usePositions) {</span>
<span class="line-added"> 631                         positions = (b + numGlyphs * BYTES_PER_GLYPH_IMAGE);</span>
<span class="line-added"> 632                         bytesPerGlyph = BYTES_PER_POSITIONED_GLYPH;</span>
<span class="line-added"> 633                     } else {</span>
<span class="line-added"> 634                         positions = NULL;</span>
<span class="line-added"> 635                         bytesPerGlyph = BYTES_PER_GLYPH_IMAGE;</span>
<span class="line-added"> 636                     }</span>
<span class="line-added"> 637                     MTLTR_DrawGlyphList(env, mtlc, dstOps,</span>
<span class="line-added"> 638                                         numGlyphs, usePositions,</span>
<span class="line-added"> 639                                         subPixPos, rgbOrder, lcdContrast,</span>
<span class="line-added"> 640                                         glyphListOrigX, glyphListOrigY,</span>
<span class="line-added"> 641                                         images, positions);</span>
<span class="line-added"> 642                     SKIP_BYTES(b, numGlyphs * bytesPerGlyph);</span>
<span class="line-added"> 643                     break;</span>
 644                 }
 645 
<span class="line-modified"> 646                 // copy-related ops</span>
<span class="line-modified"> 647                 case sun_java2d_pipe_BufferedOpCodes_COPY_AREA:</span>
<span class="line-modified"> 648                 {</span>
<span class="line-modified"> 649                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 650                     jint x  = NEXT_INT(b);</span>
<span class="line-modified"> 651                     jint y  = NEXT_INT(b);</span>
<span class="line-modified"> 652                     jint w  = NEXT_INT(b);</span>
<span class="line-modified"> 653                     jint h  = NEXT_INT(b);</span>
<span class="line-modified"> 654                     jint dx = NEXT_INT(b);</span>
<span class="line-modified"> 655                     jint dy = NEXT_INT(b);</span>
<span class="line-modified"> 656                     MTLBlitLoops_CopyArea(env, mtlc, dstOps,</span>
<span class="line-modified"> 657                                           x, y, w, h, dx, dy);</span>
<span class="line-modified"> 658                     break;</span>








 659                 }
<span class="line-modified"> 660                 case sun_java2d_pipe_BufferedOpCodes_BLIT:</span>
<span class="line-modified"> 661                 {</span>
<span class="line-modified"> 662                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 663                     jint packedParams = NEXT_INT(b);</span>
<span class="line-modified"> 664                     jint sx1          = NEXT_INT(b);</span>
<span class="line-modified"> 665                     jint sy1          = NEXT_INT(b);</span>
<span class="line-modified"> 666                     jint sx2          = NEXT_INT(b);</span>
<span class="line-modified"> 667                     jint sy2          = NEXT_INT(b);</span>
<span class="line-modified"> 668                     jdouble dx1       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 669                     jdouble dy1       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 670                     jdouble dx2       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 671                     jdouble dy2       = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 672                     jlong pSrc        = NEXT_LONG(b);</span>
<span class="line-modified"> 673                     jlong pDst        = NEXT_LONG(b);</span>
<span class="line-modified"> 674                     jint hint         = EXTRACT_BYTE(packedParams, OFFSET_HINT);</span>
<span class="line-modified"> 675                     jboolean texture  = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 676                                                         OFFSET_TEXTURE);</span>
<span class="line-modified"> 677                     jboolean xform    = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 678                                                         OFFSET_XFORM);</span>
<span class="line-modified"> 679                     jboolean isoblit  = EXTRACT_BOOLEAN(packedParams,</span>
<span class="line-modified"> 680                                                         OFFSET_ISOBLIT);</span>
<span class="line-modified"> 681                     if (isoblit) {</span>
<span class="line-modified"> 682                         MTLBlitLoops_IsoBlit(env, mtlc, pSrc, pDst,</span>
<span class="line-modified"> 683                                              xform, hint, texture,</span>
<span class="line-modified"> 684                                              sx1, sy1, sx2, sy2,</span>
<span class="line-modified"> 685                                              dx1, dy1, dx2, dy2);</span>
<span class="line-modified"> 686                     } else {</span>
<span class="line-modified"> 687                         jint srctype = EXTRACT_BYTE(packedParams, OFFSET_SRCTYPE);</span>
<span class="line-modified"> 688                         MTLBlitLoops_Blit(env, mtlc, pSrc, pDst,</span>
<span class="line-modified"> 689                                           xform, hint, srctype, texture,</span>
<span class="line-modified"> 690                                           sx1, sy1, sx2, sy2,</span>
<span class="line-modified"> 691                                           dx1, dy1, dx2, dy2);</span>
<span class="line-modified"> 692                     }</span>
<span class="line-modified"> 693                     break;</span>
<span class="line-modified"> 694                 }</span>
<span class="line-modified"> 695                 case sun_java2d_pipe_BufferedOpCodes_SURFACE_TO_SW_BLIT:</span>
<span class="line-modified"> 696                 {</span>
<span class="line-modified"> 697                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 698                     jint sx      = NEXT_INT(b);</span>
<span class="line-modified"> 699                     jint sy      = NEXT_INT(b);</span>
<span class="line-modified"> 700                     jint dx      = NEXT_INT(b);</span>
<span class="line-modified"> 701                     jint dy      = NEXT_INT(b);</span>
<span class="line-modified"> 702                     jint w       = NEXT_INT(b);</span>
<span class="line-modified"> 703                     jint h       = NEXT_INT(b);</span>
<span class="line-modified"> 704                     jint dsttype = NEXT_INT(b);</span>
<span class="line-modified"> 705                     jlong pSrc   = NEXT_LONG(b);</span>
<span class="line-modified"> 706                     jlong pDst   = NEXT_LONG(b);</span>
<span class="line-modified"> 707                     MTLBlitLoops_SurfaceToSwBlit(env, mtlc,</span>
<span class="line-modified"> 708                                                  pSrc, pDst, dsttype,</span>
<span class="line-modified"> 709                                                  sx, sy, dx, dy, w, h);</span>
<span class="line-modified"> 710                     break;</span>
<span class="line-modified"> 711                 }</span>
<span class="line-modified"> 712                 case sun_java2d_pipe_BufferedOpCodes_MASK_FILL:</span>
<span class="line-modified"> 713                 {</span>
<span class="line-modified"> 714                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 715                     jint x        = NEXT_INT(b);</span>
<span class="line-added"> 716                     jint y        = NEXT_INT(b);</span>
<span class="line-added"> 717                     jint w        = NEXT_INT(b);</span>
<span class="line-added"> 718                     jint h        = NEXT_INT(b);</span>
<span class="line-added"> 719                     jint maskoff  = NEXT_INT(b);</span>
<span class="line-added"> 720                     jint maskscan = NEXT_INT(b);</span>
<span class="line-added"> 721                     jint masklen  = NEXT_INT(b);</span>
<span class="line-added"> 722                     unsigned char *pMask = (masklen &gt; 0) ? b : NULL;</span>
<span class="line-added"> 723                     MTLMaskFill_MaskFill(mtlc, dstOps, x, y, w, h,</span>
<span class="line-added"> 724                                          maskoff, maskscan, masklen, pMask);</span>
<span class="line-added"> 725                     SKIP_BYTES(b, masklen);</span>
<span class="line-added"> 726                     break;</span>
<span class="line-added"> 727                 }</span>
<span class="line-added"> 728                 case sun_java2d_pipe_BufferedOpCodes_MASK_BLIT:</span>
<span class="line-added"> 729                 {</span>
<span class="line-added"> 730                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 731                     jint dstx     = NEXT_INT(b);</span>
<span class="line-added"> 732                     jint dsty     = NEXT_INT(b);</span>
<span class="line-added"> 733                     jint width    = NEXT_INT(b);</span>
<span class="line-added"> 734                     jint height   = NEXT_INT(b);</span>
<span class="line-added"> 735                     jint masklen  = width * height * sizeof(jint);</span>
<span class="line-added"> 736                     MTLMaskBlit_MaskBlit(env, mtlc, dstOps,</span>
<span class="line-added"> 737                                          dstx, dsty, width, height, b);</span>
<span class="line-added"> 738                     SKIP_BYTES(b, masklen);</span>
<span class="line-added"> 739                     break;</span>
 740                 }














































































































 741 
<span class="line-modified"> 742                 // state-related ops</span>
<span class="line-added"> 743                 case sun_java2d_pipe_BufferedOpCodes_SET_RECT_CLIP:</span>
<span class="line-added"> 744                 {</span>
<span class="line-added"> 745                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 746                     jint x1 = NEXT_INT(b);</span>
<span class="line-added"> 747                     jint y1 = NEXT_INT(b);</span>
<span class="line-added"> 748                     jint x2 = NEXT_INT(b);</span>
<span class="line-added"> 749                     jint y2 = NEXT_INT(b);</span>
<span class="line-added"> 750                     [mtlc setClipRectX1:x1 Y1:y1 X2:x2 Y2:y2];</span>
<span class="line-added"> 751                     break;</span>
<span class="line-added"> 752                 }</span>
<span class="line-added"> 753                 case sun_java2d_pipe_BufferedOpCodes_BEGIN_SHAPE_CLIP:</span>
<span class="line-added"> 754                 {</span>
<span class="line-added"> 755                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 756                     [mtlc beginShapeClip:dstOps];</span>
<span class="line-added"> 757                     break;</span>
<span class="line-added"> 758                 }</span>
<span class="line-added"> 759                 case sun_java2d_pipe_BufferedOpCodes_SET_SHAPE_CLIP_SPANS:</span>
<span class="line-added"> 760                 {</span>
<span class="line-added"> 761                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 762                     // This results in creation of new render encoder with</span>
<span class="line-added"> 763                     // stencil buffer set as render target</span>
<span class="line-added"> 764                     jint count = NEXT_INT(b);</span>
<span class="line-added"> 765                     MTLRenderer_FillSpans(mtlc, dstOps, count, (jint *)b);</span>
<span class="line-added"> 766                     SKIP_BYTES(b, count * BYTES_PER_SPAN);</span>
<span class="line-added"> 767                     break;</span>
<span class="line-added"> 768                 }</span>
<span class="line-added"> 769                 case sun_java2d_pipe_BufferedOpCodes_END_SHAPE_CLIP:</span>
<span class="line-added"> 770                 {</span>
<span class="line-added"> 771                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 772                     [mtlc endShapeClip:dstOps];</span>
<span class="line-added"> 773                     break;</span>
<span class="line-added"> 774                 }</span>
<span class="line-added"> 775                 case sun_java2d_pipe_BufferedOpCodes_RESET_CLIP:</span>
<span class="line-added"> 776                 {</span>
<span class="line-added"> 777                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 778                     [mtlc resetClip];</span>
<span class="line-added"> 779                     break;</span>
<span class="line-added"> 780                 }</span>
<span class="line-added"> 781                 case sun_java2d_pipe_BufferedOpCodes_SET_ALPHA_COMPOSITE:</span>
<span class="line-added"> 782                 {</span>
<span class="line-added"> 783                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 784                     jint rule         = NEXT_INT(b);</span>
<span class="line-added"> 785                     jfloat extraAlpha = NEXT_FLOAT(b);</span>
<span class="line-added"> 786                     jint flags        = NEXT_INT(b);</span>
<span class="line-added"> 787                     [mtlc setAlphaCompositeRule:rule extraAlpha:extraAlpha flags:flags];</span>
<span class="line-added"> 788                     break;</span>
<span class="line-added"> 789                 }</span>
<span class="line-added"> 790                 case sun_java2d_pipe_BufferedOpCodes_SET_XOR_COMPOSITE:</span>
<span class="line-added"> 791                 {</span>
<span class="line-added"> 792                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 793                     jint xorPixel = NEXT_INT(b);</span>
<span class="line-added"> 794                     [mtlc setXorComposite:xorPixel];</span>
<span class="line-added"> 795                     break;</span>
<span class="line-added"> 796                 }</span>
<span class="line-added"> 797                 case sun_java2d_pipe_BufferedOpCodes_RESET_COMPOSITE:</span>
<span class="line-added"> 798                 {</span>
<span class="line-added"> 799                     /* TODO: check whether something needs to be done here if we are moving out of XOR composite</span>
<span class="line-added"> 800                     commitEncodedCommands();</span>
<span class="line-added"> 801                     MTLCommandBufferWrapper * cbwrapper = [mtlc pullCommandBufferWrapper];</span>
<span class="line-added"> 802                     [cbwrapper onComplete];</span>
 803 
<span class="line-modified"> 804                     J2dTraceLn(J2D_TRACE_VERBOSE,</span>
<span class="line-modified"> 805                      &quot;RESET_COMPOSITE - Force commit earlier draw calls before RESET_COMPOSITE.&quot;);*/</span>




















 806 
<span class="line-modified"> 807                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 808                     [mtlc resetComposite];</span>
<span class="line-modified"> 809                     break;</span>
<span class="line-modified"> 810                 }</span>
<span class="line-modified"> 811                 case sun_java2d_pipe_BufferedOpCodes_SET_TRANSFORM:</span>
<span class="line-modified"> 812                 {</span>
<span class="line-added"> 813                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 814                     jdouble m00 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 815                     jdouble m10 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 816                     jdouble m01 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 817                     jdouble m11 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 818                     jdouble m02 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 819                     jdouble m12 = NEXT_DOUBLE(b);</span>
<span class="line-added"> 820                     [mtlc setTransformM00:m00 M10:m10 M01:m01 M11:m11 M02:m02 M12:m12];</span>
<span class="line-added"> 821                     break;</span>
<span class="line-added"> 822                 }</span>
<span class="line-added"> 823                 case sun_java2d_pipe_BufferedOpCodes_RESET_TRANSFORM:</span>
<span class="line-added"> 824                 {</span>
<span class="line-added"> 825                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 826                     [mtlc resetTransform];</span>
<span class="line-added"> 827                     break;</span>
<span class="line-added"> 828                 }</span>
 829 
<span class="line-modified"> 830                 // context-related ops</span>
<span class="line-modified"> 831                 case sun_java2d_pipe_BufferedOpCodes_SET_SURFACES:</span>
<span class="line-modified"> 832                 {</span>
<span class="line-modified"> 833                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 834                     jlong pSrc = NEXT_LONG(b);</span>
<span class="line-modified"> 835                     jlong pDst = NEXT_LONG(b);</span>




 836 
<span class="line-modified"> 837                     dstOps = (BMTLSDOps *)jlong_to_ptr(pDst);</span>
<span class="line-added"> 838                     mtlc = [MTLContext setSurfacesEnv:env src:pSrc dst:pDst];</span>
<span class="line-added"> 839                     break;</span>
<span class="line-added"> 840                 }</span>
<span class="line-added"> 841                 case sun_java2d_pipe_BufferedOpCodes_SET_SCRATCH_SURFACE:</span>
<span class="line-added"> 842                 {</span>
<span class="line-added"> 843                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 844                     jlong pConfigInfo = NEXT_LONG(b);</span>
<span class="line-added"> 845                     MTLGraphicsConfigInfo *mtlInfo =</span>
<span class="line-added"> 846                             (MTLGraphicsConfigInfo *)jlong_to_ptr(pConfigInfo);</span>
 847 
<span class="line-modified"> 848                     if (mtlInfo == NULL) {</span>


 849 
 850                     } else {
<span class="line-modified"> 851                         MTLContext *newMtlc = mtlInfo-&gt;context;</span>
<span class="line-modified"> 852                         if (newMtlc == NULL) {</span>
<span class="line-added"> 853 </span>
<span class="line-added"> 854                         } else {</span>
<span class="line-added"> 855                             mtlc = newMtlc;</span>
<span class="line-added"> 856                             dstOps = NULL;</span>
<span class="line-added"> 857                         }</span>
 858                     }
<span class="line-added"> 859                     break;</span>
 860                 }
<span class="line-modified"> 861                 case sun_java2d_pipe_BufferedOpCodes_FLUSH_SURFACE:</span>
<span class="line-modified"> 862                 {</span>
<span class="line-modified"> 863                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 864                     jlong pData = NEXT_LONG(b);</span>
<span class="line-modified"> 865                     BMTLSDOps *mtlsdo = (BMTLSDOps *)jlong_to_ptr(pData);</span>
<span class="line-modified"> 866                     if (mtlsdo != NULL) {</span>
<span class="line-modified"> 867                         CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 868                         MTLSD_Delete(env, mtlsdo);</span>
<span class="line-modified"> 869                     }</span>
<span class="line-modified"> 870                     break;</span>
 871                 }
<span class="line-modified"> 872                 case sun_java2d_pipe_BufferedOpCodes_DISPOSE_SURFACE:</span>
<span class="line-modified"> 873                 {</span>
<span class="line-modified"> 874                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 875                     jlong pData = NEXT_LONG(b);</span>
<span class="line-modified"> 876                     BMTLSDOps *mtlsdo = (BMTLSDOps *)jlong_to_ptr(pData);</span>
<span class="line-modified"> 877                     if (mtlsdo != NULL) {</span>
<span class="line-modified"> 878                         CONTINUE_IF_NULL(mtlc);</span>
<span class="line-modified"> 879                         MTLSD_Delete(env, mtlsdo);</span>
<span class="line-modified"> 880                         if (mtlsdo-&gt;privOps != NULL) {</span>
<span class="line-modified"> 881                             free(mtlsdo-&gt;privOps);</span>
<span class="line-modified"> 882                         }</span>

 883                     }
<span class="line-added"> 884                     break;</span>
<span class="line-added"> 885                 }</span>
<span class="line-added"> 886                 case sun_java2d_pipe_BufferedOpCodes_DISPOSE_CONFIG:</span>
<span class="line-added"> 887                 {</span>
<span class="line-added"> 888                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 889                     jlong pConfigInfo = NEXT_LONG(b);</span>
<span class="line-added"> 890                     CONTINUE_IF_NULL(mtlc);</span>
<span class="line-added"> 891                     MTLGC_DestroyMTLGraphicsConfig(pConfigInfo);</span>
<span class="line-added"> 892 </span>
<span class="line-added"> 893                     // the previous method will call glX/wglMakeCurrent(None),</span>
<span class="line-added"> 894                     // so we should nullify the current mtlc and dstOps to avoid</span>
<span class="line-added"> 895                     // calling glFlush() (or similar) while no context is current</span>
<span class="line-added"> 896                     mtlc = NULL;</span>
<span class="line-added"> 897                  //   dstOps = NULL;</span>
<span class="line-added"> 898                     break;</span>
<span class="line-added"> 899                 }</span>
<span class="line-added"> 900                 case sun_java2d_pipe_BufferedOpCodes_INVALIDATE_CONTEXT:</span>
<span class="line-added"> 901                 {</span>
<span class="line-added"> 902                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-added"> 903                     // invalidate the references to the current context and</span>
<span class="line-added"> 904                     // destination surface that are maintained at the native level</span>
<span class="line-added"> 905                     mtlc = NULL;</span>
<span class="line-added"> 906                 //    dstOps = NULL;</span>
<span class="line-added"> 907                     break;</span>
<span class="line-added"> 908                 }</span>
<span class="line-added"> 909                 case sun_java2d_pipe_BufferedOpCodes_SYNC:</span>
<span class="line-added"> 910                 {</span>
<span class="line-added"> 911                     CHECK_PREVIOUS_OP(MTL_OP_SYNC);</span>
<span class="line-added"> 912                     break;</span>
 913                 }






























 914 
<span class="line-modified"> 915                 // multibuffering ops</span>
<span class="line-modified"> 916                 case sun_java2d_pipe_BufferedOpCodes_SWAP_BUFFERS:</span>
<span class="line-modified"> 917                 {</span>
<span class="line-modified"> 918                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 919                     jlong window = NEXT_LONG(b);</span>
<span class="line-modified"> 920                     MTLSD_SwapBuffers(env, window);</span>
<span class="line-modified"> 921                     break;</span>
<span class="line-modified"> 922                 }</span>
 923 
<span class="line-modified"> 924                 // special no-op (mainly used for achieving 8-byte alignment)</span>
<span class="line-modified"> 925                 case sun_java2d_pipe_BufferedOpCodes_NOOP:</span>
<span class="line-modified"> 926                     break;</span>
 927 
<span class="line-modified"> 928                 // paint-related ops</span>
<span class="line-modified"> 929                 case sun_java2d_pipe_BufferedOpCodes_RESET_PAINT:</span>
<span class="line-modified"> 930                 {</span>
<span class="line-modified"> 931                   CHECK_PREVIOUS_OP(MTL_OP_RESET_PAINT);</span>
<span class="line-modified"> 932                   [mtlc resetPaint];</span>
<span class="line-modified"> 933                     break;</span>
<span class="line-modified"> 934                 }</span>
<span class="line-modified"> 935                 case sun_java2d_pipe_BufferedOpCodes_SET_COLOR:</span>
<span class="line-modified"> 936                 {</span>
<span class="line-modified"> 937                     CHECK_PREVIOUS_OP(MTL_OP_SET_COLOR);</span>
<span class="line-modified"> 938                     jint pixel = NEXT_INT(b);</span>
<span class="line-modified"> 939                     [mtlc setColorPaint:pixel];</span>
<span class="line-modified"> 940                     break;</span>
<span class="line-modified"> 941                 }</span>
<span class="line-modified"> 942                 case sun_java2d_pipe_BufferedOpCodes_SET_GRADIENT_PAINT:</span>
<span class="line-modified"> 943                 {</span>
<span class="line-modified"> 944                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 945                     jboolean useMask= NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 946                     jboolean cyclic = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 947                     jdouble p0      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 948                     jdouble p1      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 949                     jdouble p3      = NEXT_DOUBLE(b);</span>
<span class="line-modified"> 950                     jint pixel1     = NEXT_INT(b);</span>
<span class="line-modified"> 951                     jint pixel2     = NEXT_INT(b);</span>
<span class="line-modified"> 952                     [mtlc setGradientPaintUseMask:useMask</span>
<span class="line-modified"> 953                                         cyclic:cyclic</span>
<span class="line-modified"> 954                                             p0:p0</span>
<span class="line-modified"> 955                                             p1:p1</span>
<span class="line-modified"> 956                                             p3:p3</span>
<span class="line-modified"> 957                                         pixel1:pixel1</span>
<span class="line-modified"> 958                                         pixel2:pixel2];</span>
<span class="line-modified"> 959                     break;</span>
<span class="line-modified"> 960                 }</span>
<span class="line-modified"> 961                 case sun_java2d_pipe_BufferedOpCodes_SET_LINEAR_GRADIENT_PAINT:</span>
<span class="line-modified"> 962                 {</span>
<span class="line-modified"> 963                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 964                     jboolean useMask = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 965                     jboolean linear  = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 966                     jint cycleMethod = NEXT_INT(b);</span>
<span class="line-modified"> 967                     jint numStops    = NEXT_INT(b);</span>
<span class="line-modified"> 968                     jfloat p0        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 969                     jfloat p1        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 970                     jfloat p3        = NEXT_FLOAT(b);</span>
<span class="line-modified"> 971                     void *fractions, *pixels;</span>
<span class="line-modified"> 972                     fractions = b; SKIP_BYTES(b, numStops * sizeof(jfloat));</span>
<span class="line-modified"> 973                     pixels    = b; SKIP_BYTES(b, numStops * sizeof(jint));</span>
<span class="line-modified"> 974                     [mtlc setLinearGradientPaint:useMask</span>
<span class="line-modified"> 975                                           linear:linear</span>
<span class="line-modified"> 976                                      cycleMethod:cycleMethod</span>
<span class="line-modified"> 977                                         numStops:numStops</span>
<span class="line-modified"> 978                                               p0:p0</span>
<span class="line-modified"> 979                                               p1:p1</span>
<span class="line-modified"> 980                                               p3:p3</span>
<span class="line-modified"> 981                                        fractions:fractions</span>
<span class="line-modified"> 982                                           pixels:pixels];</span>
<span class="line-modified"> 983                     break;</span>
<span class="line-modified"> 984                 }</span>
<span class="line-modified"> 985                 case sun_java2d_pipe_BufferedOpCodes_SET_RADIAL_GRADIENT_PAINT:</span>
<span class="line-modified"> 986                 {</span>
<span class="line-modified"> 987                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified"> 988                     jboolean useMask = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 989                     jboolean linear  = NEXT_BOOLEAN(b);</span>
<span class="line-modified"> 990                     jint numStops    = NEXT_INT(b);</span>
<span class="line-modified"> 991                     jint cycleMethod = NEXT_INT(b);</span>
<span class="line-modified"> 992                     jfloat m00       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 993                     jfloat m01       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 994                     jfloat m02       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 995                     jfloat m10       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 996                     jfloat m11       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 997                     jfloat m12       = NEXT_FLOAT(b);</span>
<span class="line-modified"> 998                     jfloat focusX    = NEXT_FLOAT(b);</span>
<span class="line-modified"> 999                     void *fractions, *pixels;</span>
<span class="line-modified">1000                     fractions = b; SKIP_BYTES(b, numStops * sizeof(jfloat));</span>
<span class="line-modified">1001                     pixels    = b; SKIP_BYTES(b, numStops * sizeof(jint));</span>
<span class="line-modified">1002                     [mtlc setRadialGradientPaint:useMask</span>
<span class="line-modified">1003                                           linear:linear</span>
<span class="line-modified">1004                                      cycleMethod:cycleMethod</span>
<span class="line-modified">1005                                         numStops:numStops</span>
<span class="line-modified">1006                                              m00:m00</span>
<span class="line-modified">1007                                              m01:m01</span>
<span class="line-modified">1008                                              m02:m02</span>
<span class="line-modified">1009                                              m10:m10</span>
<span class="line-modified">1010                                              m11:m11</span>
<span class="line-modified">1011                                              m12:m12</span>
<span class="line-modified">1012                                           focusX:focusX</span>
<span class="line-modified">1013                                        fractions:fractions</span>
<span class="line-modified">1014                                           pixels:pixels];</span>
<span class="line-modified">1015                     break;</span>
<span class="line-modified">1016                 }</span>
<span class="line-modified">1017                 case sun_java2d_pipe_BufferedOpCodes_SET_TEXTURE_PAINT:</span>
<span class="line-modified">1018                 {</span>
<span class="line-modified">1019                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1020                     jboolean useMask= NEXT_BOOLEAN(b);</span>
<span class="line-modified">1021                     jboolean filter = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1022                     jlong pSrc      = NEXT_LONG(b);</span>
<span class="line-modified">1023                     jdouble xp0     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1024                     jdouble xp1     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1025                     jdouble xp3     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1026                     jdouble yp0     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1027                     jdouble yp1     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1028                     jdouble yp3     = NEXT_DOUBLE(b);</span>
<span class="line-modified">1029                     [mtlc setTexturePaint:useMask</span>
<span class="line-modified">1030                                   pSrcOps:pSrc</span>
<span class="line-modified">1031                                    filter:filter</span>
<span class="line-modified">1032                                       xp0:xp0</span>
<span class="line-modified">1033                                       xp1:xp1</span>
<span class="line-modified">1034                                       xp3:xp3</span>
<span class="line-modified">1035                                       yp0:yp0</span>
<span class="line-modified">1036                                       yp1:yp1</span>
<span class="line-modified">1037                                       yp3:yp3];</span>
<span class="line-modified">1038                     break;</span>
<span class="line-modified">1039                 }</span>
1040 
<span class="line-modified">1041                 // BufferedImageOp-related ops</span>
<span class="line-modified">1042                 case sun_java2d_pipe_BufferedOpCodes_ENABLE_CONVOLVE_OP:</span>
<span class="line-modified">1043                 {</span>
<span class="line-modified">1044                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1045                     jlong pSrc        = NEXT_LONG(b);</span>
<span class="line-modified">1046                     jboolean edgeZero = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1047                     jint kernelWidth  = NEXT_INT(b);</span>
<span class="line-modified">1048                     jint kernelHeight = NEXT_INT(b);</span>
<span class="line-modified">1049 </span>
<span class="line-modified">1050                     BMTLSDOps * bmtlsdOps = (BMTLSDOps *)pSrc;</span>
<span class="line-modified">1051                     MTLConvolveOp * convolveOp = [[MTLConvolveOp alloc] init:edgeZero</span>
<span class="line-modified">1052                             kernelWidth:kernelWidth</span>
<span class="line-modified">1053                            kernelHeight:kernelHeight</span>
<span class="line-modified">1054                                srcWidth:bmtlsdOps-&gt;width</span>
<span class="line-modified">1055                               srcHeight:bmtlsdOps-&gt;height</span>
<span class="line-modified">1056                                  kernel:b</span>
<span class="line-modified">1057                                  device:mtlc.device</span>
<span class="line-modified">1058                                                   ];</span>
<span class="line-modified">1059                     [mtlc setBufImgOp:convolveOp];</span>
<span class="line-modified">1060                     SKIP_BYTES(b, kernelWidth * kernelHeight * sizeof(jfloat));</span>
<span class="line-modified">1061                     break;</span>
<span class="line-modified">1062                 }</span>
<span class="line-modified">1063                 case sun_java2d_pipe_BufferedOpCodes_DISABLE_CONVOLVE_OP:</span>
<span class="line-modified">1064                 {</span>
<span class="line-modified">1065                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1066                     [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1067                     break;</span>
<span class="line-modified">1068                 }</span>
<span class="line-modified">1069                 case sun_java2d_pipe_BufferedOpCodes_ENABLE_RESCALE_OP:</span>
<span class="line-modified">1070                 {</span>
<span class="line-modified">1071                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1072                     jlong pSrc          = NEXT_LONG(b);</span>
<span class="line-modified">1073                     jboolean nonPremult = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1074                     jint numFactors     = 4;</span>
<span class="line-modified">1075                     unsigned char *scaleFactors = b;</span>
<span class="line-modified">1076                     unsigned char *offsets = (b + numFactors * sizeof(jfloat));</span>
<span class="line-modified">1077                     MTLRescaleOp * rescaleOp =</span>
<span class="line-modified">1078                             [[MTLRescaleOp alloc] init:nonPremult factors:scaleFactors offsets:offsets];</span>
<span class="line-modified">1079                     [mtlc setBufImgOp:rescaleOp];</span>
<span class="line-modified">1080                     SKIP_BYTES(b, numFactors * sizeof(jfloat) * 2);</span>
<span class="line-modified">1081                     break;</span>
<span class="line-modified">1082                 }</span>
<span class="line-modified">1083                 case sun_java2d_pipe_BufferedOpCodes_DISABLE_RESCALE_OP:</span>
<span class="line-modified">1084                 {</span>
<span class="line-modified">1085                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1086                     [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1087                     break;</span>
<span class="line-modified">1088                 }</span>
<span class="line-modified">1089                 case sun_java2d_pipe_BufferedOpCodes_ENABLE_LOOKUP_OP:</span>
<span class="line-modified">1090                 {</span>
<span class="line-modified">1091                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1092                     jlong pSrc          = NEXT_LONG(b);</span>
<span class="line-modified">1093                     jboolean nonPremult = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1094                     jboolean shortData  = NEXT_BOOLEAN(b);</span>
<span class="line-modified">1095                     jint numBands       = NEXT_INT(b);</span>
<span class="line-modified">1096                     jint bandLength     = NEXT_INT(b);</span>
<span class="line-modified">1097                     jint offset         = NEXT_INT(b);</span>
<span class="line-modified">1098                     jint bytesPerElem = shortData ? sizeof(jshort):sizeof(jbyte);</span>
<span class="line-modified">1099                     void *tableValues = b;</span>
<span class="line-modified">1100 </span>
<span class="line-modified">1101                     MTLLookupOp * lookupOp = [[MTLLookupOp alloc] init:nonPremult</span>
<span class="line-modified">1102                                                              shortData:shortData</span>
<span class="line-modified">1103                                                               numBands:numBands</span>
<span class="line-modified">1104                                                             bandLength:bandLength</span>
<span class="line-modified">1105                                                                 offset:offset</span>
<span class="line-modified">1106                                                            tableValues:tableValues</span>
<span class="line-modified">1107                                                                 device:mtlc.device];</span>
<span class="line-modified">1108                     [mtlc setBufImgOp:lookupOp];</span>
<span class="line-modified">1109                     SKIP_BYTES(b, numBands * bandLength * bytesPerElem);</span>
<span class="line-modified">1110                     break;</span>
<span class="line-modified">1111                 }</span>
<span class="line-modified">1112                 case sun_java2d_pipe_BufferedOpCodes_DISABLE_LOOKUP_OP:</span>
<span class="line-modified">1113                 {</span>
<span class="line-modified">1114                     CHECK_PREVIOUS_OP(MTL_OP_OTHER);</span>
<span class="line-modified">1115                     [mtlc setBufImgOp:NULL];</span>
<span class="line-modified">1116                     break;</span>
<span class="line-added">1117                 }</span>
1118 
<span class="line-modified">1119                 default:</span>
<span class="line-modified">1120                     J2dRlsTraceLn1(J2D_TRACE_ERROR,</span>
<span class="line-modified">1121                         &quot;MTLRenderQueue_flushBuffer: invalid opcode=%d&quot;, opcode);</span>
<span class="line-modified">1122                     return;</span>
<span class="line-added">1123             }</span>
1124         }

1125 
<span class="line-modified">1126         if (mtlc != NULL) {</span>
<span class="line-modified">1127             [mtlc.encoderManager endEncoder];</span>
<span class="line-modified">1128             MTLCommandBufferWrapper * cbwrapper = [mtlc pullCommandBufferWrapper];</span>
<span class="line-modified">1129             id&lt;MTLCommandBuffer&gt; commandbuf = [cbwrapper getCommandBuffer];</span>
<span class="line-modified">1130             [commandbuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandbuf) {</span>
<span class="line-modified">1131                 [cbwrapper release];</span>
<span class="line-modified">1132             }];</span>
<span class="line-modified">1133             [commandbuf commit];</span>
<span class="line-modified">1134             BMTLSDOps *dstOps = MTLRenderQueue_GetCurrentDestination();</span>
<span class="line-modified">1135             if (dstOps != NULL) {</span>
<span class="line-modified">1136                 MTLSDOps *dstMTLOps = (MTLSDOps *)dstOps-&gt;privOps;</span>
<span class="line-modified">1137                 MTLLayer *layer = (MTLLayer*)dstMTLOps-&gt;layer;</span>
<span class="line-modified">1138                 if (layer != NULL) {</span>
<span class="line-modified">1139                     [JNFRunLoop performOnMainThreadWaiting:NO withBlock:^(){</span>
<span class="line-modified">1140                         AWT_ASSERT_APPKIT_THREAD;</span>
<span class="line-modified">1141                         [layer setNeedsDisplay];</span>
<span class="line-modified">1142                     }];</span>
<span class="line-added">1143                 }</span>
1144             }
1145         }
<span class="line-added">1146         RESET_PREVIOUS_OP();</span>
1147     }

1148 }
1149 
1150 /**
1151  * Returns a pointer to the &quot;current&quot; context, as set by the last SET_SURFACES
1152  * or SET_SCRATCH_SURFACE operation.
1153  */
1154 MTLContext *
1155 MTLRenderQueue_GetCurrentContext()
1156 {
1157     return mtlc;
1158 }
1159 
1160 /**
1161  * Returns a pointer to the &quot;current&quot; destination surface, as set by the last
1162  * SET_SURFACES operation.
1163  */
1164 BMTLSDOps *
1165 MTLRenderQueue_GetCurrentDestination()
1166 {
1167     return dstOps;
</pre>
</td>
</tr>
</table>
<center><a href="MTLPaints.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="MTLTextRenderer.m.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>